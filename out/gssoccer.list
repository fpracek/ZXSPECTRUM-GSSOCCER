# file opened: ./src/GSSOCCER.asm
   1  0000              ; ===================================================================
   2  0000              ; GS11-Soccer - 2025 Fausto Pracek
   3  0000              ; ===================================================================
   4  0000
   5  0000              ; *** GSSOCCER.ASM ***
   6  0000
   7  0000                  DEVICE ZXSPECTRUM48
   8  0000                  SLDOPT COMMENT WPMEM, LOGPOINT, ASSERTION
   9  0000
  10  0000                  ORG 0x8000               ; Loader address (0x8000)
  11  8000
  12  8000                  INCLUDE "constants.asm"
# file opened: ./inc/constants.asm
   1+ 8000              ; ===================================================================
   2+ 8000              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8000              ; ===================================================================
   4+ 8000
   5+ 8000              ; *** CONSTANTS.ASM ***
   6+ 8000
   7+ 8000
   8+ 8000
   9+ 8000
  10+ 8000
  11+ 8000              PSG_SEL:                                        EQU 0A0h
  12+ 8000              PSG_WR:                                         EQU 0A1h
  13+ 8000              PSG_RD:                                         EQU 0A2h
  14+ 8000              SCR_BASE:                                       EQU 0x4000      ; Base address of the Spectrum screen
  15+ 8000              ATTR_BASE:                                      EQU 0x5800      ; Start of the attribute area
  16+ 8000              ROM_CHAR_SET_ADDRESS:                           EQU 0x3D00      ; Start of the ROM character set
  17+ 8000              RAM_CHAR_SET_ADDRESS:                           EQU 0xB500      ; Start of the RAM character set
  18+ 8000
  19+ 8000              MATCH_TIME:                                     EQU 60
  20+ 8000              TICK_SPEED:                                     EQU 5
  21+ 8000
  22+ 8000              TILE_CORNER:                                    EQU 0
  23+ 8000              TILE_WHITE_PLAYER_WITH_BALL:                    EQU 1
  24+ 8000              TILE_BLACK_PLAYER_WITH_BACK_BALL:               EQU 2
  25+ 8000              TILE_CORNER_BALL:                               EQU 3
  26+ 8000              TILE_CORNER_BALL_EMPTY:                         EQU 4
  27+ 8000              TILE_REMOVE_WHITE_PLAYER_AND_BALL:              EQU 5
  28+ 8000              TILE_BALL_TOP:                                  EQU 6
  29+ 8000              TILE_BALL_TOP_FRONT:                            EQU 7
  30+ 8000              TILE_BALL_BOTTOM:                               EQU 64
  31+ 8000              TILE_WHITE_PLAYER_NEAR_HALF_FIELD:              EQU 80
  32+ 8000              TILE_WHITE_GOALKEEPER:                          EQU 96
  33+ 8000              TILE_WHITE_GOALKEEPER_WITH_BALL:                EQU 112
  34+ 8000              TILE_BLACK_GOALKEEPER:                          EQU 128
  35+ 8000              TILE_BLACK_GOALKEEPER_WITH_BALL:                EQU 144
  36+ 8000              TILE_WHITE_PLAYER:                              EQU 160
  37+ 8000              TILE_BLACK_PLAYER:                              EQU 176
  38+ 8000              TILE_BLACK_PLAYER_WITH_BALL:                    EQU 192
  39+ 8000              TILE_FIELD_LINE_TOP_LEFT:                       EQU 208
  40+ 8000              TILE_FIELD_LINE_VERTICAL:                       EQU 209
  41+ 8000              TILE_FIELD_LINE_HORIZONTAL:                     EQU 210
  42+ 8000              TILE_FIELD_LINE_TOP_RIGHT:                      EQU 211
  43+ 8000              TILE_FIELD_LINE_BOTTOM_LEFT:                    EQU 212
  44+ 8000              TILE_FIELD_LINE_BOTTOM_RIGHT:                   EQU 213
  45+ 8000              TILE_FIELD:                                     EQU 214
  46+ 8000              TILE_FIELD_LINE_LEFT_CROSS:                     EQU 215
  47+ 8000              TILE_FIELD_LINE_RIGHT_CROSS:                    EQU 216
  48+ 8000              TILE_FIELD_LINE_WHITE_PLAYER_1:                 EQU 217
  49+ 8000              TILE_FIELD_LINE_WHITE_PLAYER_2:                 EQU 218
  50+ 8000              TILE_BALL_BOTTOM_LEFT:                          EQU TILE_BALL_BOTTOM + 14   ; 78
  51+ 8000              TILE_BALL_BOTTOM_RIGHT:                         EQU TILE_BALL_BOTTOM + 15   ; 79
  52+ 8000              TILE_BALL_TOP_LEFT:                             EQU 221
  53+ 8000              TILE_BALL_TOP_RIGHT:                            EQU 222
  54+ 8000              TILE_BALL_FEET_OVERLAY_L:                       EQU 219   ; già esistente (top-left)
  55+ 8000              TILE_BALL_FEET_OVERLAY_R:                       EQU 220   ; già esistente (top-right)
  56+ 8000              TILE_BALL_BACK_OVERLAY_L:                       EQU 221   ; nuovo: spalla, parte sinistra
  57+ 8000              TILE_BALL_BACK_OVERLAY_R:                       EQU 222   ; nuovo: spalla, parte destra
  58+ 8000              TILE_WHITE_PLAYER_AND_BALL:                     EQU 223
  59+ 8000
  60+ 8000
  61+ 8000
  62+ 8000              TILE_PLAYERS_COLOR:                             EQU 0x13
  63+ 8000              TILE_FIELDS_LINES_COLOR:                        EQU 0x13
  64+ 8000              TILE_BALL_BOTTOM_L:                             EQU TILE_BALL_BOTTOM + 13
  65+ 8000              TILE_BALL_BOTTOM_R:                             EQU TILE_BALL_BOTTOM + 14
  66+ 8000
  67+ 8000              GREEN_CHAR_ATTRIBUTE:                           EQU 0x20  ; Green on black
  68+ 8000
  69+ 8000              FIELD_NORTH_SIDE:                               EQU 1
  70+ 8000              FIELD_SOUTH_SIDE:                               EQU 0
  71+ 8000              YES:                                            EQU 1
  72+ 8000              NO:                                             EQU 0
  73+ 8000              GAME_MODE_2_PLAYERS:                            EQU 2
  74+ 8000              GAME_MODE_1_PLAYER:                             EQU 1
  75+ 8000              NO_VALUE:                                       EQU 255
  76+ 8000              TEAM_WHITE:                                     EQU 1
  77+ 8000              TEAM_BLACK:                                     EQU 0
  78+ 8000              ROLE_GOALKEEPER:                                EQU 0
  79+ 8000              ROLE_DEFENDER:                                  EQU 1
  80+ 8000              ROLE_MIDFIELDER:                                EQU 2
  81+ 8000              ROLE_STRIKER:                                   EQU 3
  82+ 8000
  83+ 8000              PLAYER_ENTRY_SIZE:                              EQU 7  ; bytes per player entry in Var_Game_PlayersInfo
  84+ 8000
  85+ 8000              BALL_DIRECTION_NONE:                            EQU 0
  86+ 8000              BALL_DIRECTION_NORTH:                           EQU 1
  87+ 8000              BALL_DIRECTION_NORTH_EAST:                      EQU 2
  88+ 8000              BALL_DIRECTION_NORTH_WEST:                      EQU 3
  89+ 8000              BALL_DIRECTION_SOUTH:                           EQU 4
  90+ 8000              BALL_DIRECTION_SOUTH_EAST:                      EQU 5
  91+ 8000              BALL_DIRECTION_SOUTH_WEST:                      EQU 6
  92+ 8000
  93+ 8000              PLAYER_ASKED_DIRECTION_EAST:                    EQU 1
  94+ 8000              PLAYER_ASKED_DIRECTION_WEST:                    EQU 2
  95+ 8000              PLAYER_ASKED_DIRECTION_NORTH:                   EQU 3
  96+ 8000              PLAYER_ASKED_DIRECTION_SOUTH:                   EQU 4
  97+ 8000
  98+ 8000              DEMO_MODE_LEVEL:                                EQU 4
  99+ 8000
 100+ 8000              BALL_STATUS_MOVING:                             EQU 100
 101+ 8000              BALL_STATUS_CONTENDED:                          EQU 101
 102+ 8000              BALL_STATUS_FREE:                               EQU 102
 103+ 8000
 104+ 8000              SUCCESS:                                        EQU 1
 105+ 8000              FAILURE:                                        EQU 0
 106+ 8000
 107+ 8000              VDP_DATA:                                       EQU 098h
 108+ 8000              VDP_ADDR:                                       EQU 099h
 109+ 8000
 110+ 8000              BLINK_TYPE_GOAL:                                EQU 1
 111+ 8000              BLINK_TYPE_CORNER:                              EQU 2
 112+ 8000              BLINK_TYPE_GOALKEEPER:                          EQU 3
 113+ 8000              BLINK_FRAMES_DURATION:                          EQU 30
 114+ 8000
 115+ 8000              FIRST_KICK_TYPE_WHITE_HALF_FIELD:               EQU 1
 116+ 8000              FIRST_KICK_TYPE_BLACK_HALF_FIELD:               EQU 2
 117+ 8000              FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD:             EQU 3
 118+ 8000              FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD:             EQU 4
 119+ 8000
 120+ 8000
 121+ 8000              CERIMONY_MOVEMENT_SPEED:                        EQU 20
 122+ 8000
 123+ 8000              KBD_KEY_NONE:                                   EQU 0
 124+ 8000              KBD_KEY_SPACE:                                  EQU 32
 125+ 8000
 126+ 8000              KBD_KEY_UP:                                     EQU 55
 127+ 8000              KBD_KEY_DOWN:                                   EQU 54
 128+ 8000              KBD_KEY_LEFT:                                   EQU 53
 129+ 8000              KBD_KEY_RIGHT:                                  EQU 56
 130+ 8000
 131+ 8000
 132+ 8000              KBD_KEY_W:                                      EQU 87
 133+ 8000              KBD_KEY_A:                                      EQU 65
 134+ 8000              KBD_KEY_S:                                      EQU 83
 135+ 8000
 136+ 8000
 137+ 8000              KBD_KEY_K:                                      EQU 75
 138+ 8000              KBD_KEY_L:                                      EQU 76
 139+ 8000              KBD_KEY_O:                                      EQU 79
 140+ 8000
 141+ 8000 FE 23 5A 58  KEYBOARD_MAP:                                   DEFB #FE,"#","Z","X","C","V"
 141+ 8004 43 56
 142+ 8006 FD 41 53 44                                                  DEFB #FD,"A","S","D","F","G"
 142+ 800A 46 47
 143+ 800C FB 51 57 45                                                  DEFB #FB,"Q","W","E","R","T"
 143+ 8010 52 54
 144+ 8012 F7 31 32 33                                                  DEFB #F7,"1","2","3","4","5"
 144+ 8016 34 35
 145+ 8018 EF 30 39 38                                                  DEFB #EF,"0","9","8","7","6"
 145+ 801C 37 36
 146+ 801E DF 50 4F 49                                                  DEFB #DF,"P","O","I","U","Y"
 146+ 8022 55 59
 147+ 8024 BF 23 4C 4B                                                  DEFB #BF,"#","L","K","J","H"
 147+ 8028 4A 48
 148+ 802A 7F 20 23 4D                                                  DEFB #7F," ","#","M","N","B"
 148+ 802E 4E 42
 149+ 8030
 150+ 8030 3C 32 50 4C  TXT_GAME_MODE_2_PLAYERS:                        DEFB "<2PLYS>",0
 150+ 8034 59 53 3E 00
 151+ 8038 3C 20 43 50  TXT_CPU:                                        DEFB "< CPU >",0
 151+ 803C 55 20 3E 00
 152+ 8040 5E 4C 45 56  TXT_LEVEL_1:                                    DEFB "^LEV.1",0
 152+ 8044 2E 31 00
 153+ 8047 5E 4C 45 56  TXT_LEVEL_2:                                    DEFB "^LEV.2",0
 153+ 804B 2E 32 00
 154+ 804E 5E 4C 45 56  TXT_LEVEL_3:                                    DEFB "^LEV.3",0
 154+ 8052 2E 33 00
 155+ 8055 5E 4C 45 56  TXT_LEVEL_4:                                    DEFB "^LEV.4",0
 155+ 8059 2E 34 00
 156+ 805C 5E 4C 45 56  TXT_LEVEL_5:                                    DEFB "^LEV.5",0
 156+ 8060 2E 35 00
 157+ 8063 20 20 20 20  TXT_LEVEL_NO:                                   DEFB "       ",0
 157+ 8067 20 20 20 00
 158+ 806B 50 4C 41 59  TXT_BTN_PLY1_1:                                 DEFB "PLAYER 1",0
 158+ 806F 45 52 20 31
 158+ 8073 00
 159+ 8074 4F 20 53 48  TXT_BTN_PLY1_2:                                 DEFB "O SHOT",0
 159+ 8078 4F 54 00
 160+ 807B 4B 20 4C 45  TXT_BTN_PLY1_3:                                 DEFB "K LEFT",0
 160+ 807F 46 54 00
 161+ 8082 4C 20 52 49  TXT_BTN_PLY1_4:                                 DEFB "L RIGHT",0
 161+ 8086 47 48 54 00
 162+ 808A 20 20 20 20  TXT_BTN_PLY1_5:                                 DEFB "       ",0 ; OR JOY1
 162+ 808E 20 20 20 00
 163+ 8092 50 4C 41 59  TXT_BTN_PLY2_1:                                 DEFB "PLAYER 2",0
 163+ 8096 45 52 20 32
 163+ 809A 00
 164+ 809B 57 20 53 48  TXT_BTN_PLY2_2:                                 DEFB "W SHOT",0
 164+ 809F 4F 54 00
 165+ 80A2 41 20 4C 45  TXT_BTN_PLY2_3:                                 DEFB "A LEFT",0
 165+ 80A6 46 54 00
 166+ 80A9 53 20 52 49  TXT_BTN_PLY2_4:                                 DEFB "S RIGHT",0
 166+ 80AD 47 48 54 00
 167+ 80B1 20 20 20 20  TXT_BTN_PLY2_5:                                 DEFB "       ",0 ; OR JOY2
 167+ 80B5 20 20 20 00
 168+ 80B9 20 53 50 41  TXT_SPACE:                                      DEFB " SPACE ",0 ; SPC/FIRE
 168+ 80BD 43 45 20 00
 169+ 80C1 54 4F 20 53  TXT_START:                                      DEFB "TO START",0
 169+ 80C5 54 41 52 54
 169+ 80C9 00
 170+ 80CA 47 53 53 4F  TXT_GSSOCCER:                                   DEFB "GSSOCCER",0
 170+ 80CE 43 43 45 52
 170+ 80D2 00
 171+ 80D3 32 30 32 35  TXT_2025:                                       DEFB "2025",0
 171+ 80D7 00
 172+ 80D8 46 2E 50 52  TXT_PRACEK:                                     DEFB "F.PRACEK",0
 172+ 80DC 41 43 45 4B
 172+ 80E0 00
 173+ 80E1 20 20 20 20  TXT_EMPTY:                                      DEFB "        ",0
 173+ 80E5 20 20 20 20
 173+ 80E9 00
 174+ 80EA 54 49 4D 45  TXT_TIME:                                       DEFB "TIME",0
 174+ 80EE 00
 175+ 80EF 56 49 53 49  TXT_BLACK_TEAM:                                 DEFB "VISITORS",0
 175+ 80F3 54 4F 52 53
 175+ 80F7 00
 176+ 80F8 48 4F 4D 45  TXT_WHITE_TEAM:                                 DEFB "HOME",0
 176+ 80FC 00
 177+ 80FD 47 41 4D 45  TXT_GAME_OVER:                                  DEFB "GAME OVER",0
 177+ 8101 20 4F 56 45
 177+ 8105 52 00
# file closed: ./inc/constants.asm
  13  8107                  INCLUDE "string.asm"					; Include hooks library
# file opened: ./inc/string.asm
   1+ 8107              ; ===================================================================
   2+ 8107              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8107              ; ===================================================================
   4+ 8107
   5+ 8107              ; *** STRING.ASM ***
   6+ 8107
   7+ 8107              ; ------ ROUTINES ------
   8+ 8107
   9+ 8107              ;--------------------------------------------------------------------------
  10+ 8107              ; Convert a 16-bit unsigned number to a string of ASCII digits.
  11+ 8107              ; INPUT:
  12+ 8107              ;   HL = the 16-bit unsigned number to convert.
  13+ 8107              ; OUTPUT: -
  14+ 8107              ; MODIFY: HL, DE, BC, AF
  15+ 8107              ;--------------------------------------------------------------------------
  16+ 8107              String_NumberToASCII:
  17+ 8107 01 F0 D8        LD       BC,-10000
  18+ 810A CD 20 81        CALL     .Num1
  19+ 810D 01 18 FC        LD       BC,-1000
  20+ 8110 CD 20 81        CALL     .Num1
  21+ 8113 01 9C FF        LD       BC,-100
  22+ 8116 CD 20 81        CALL     .Num1
  23+ 8119 0E F6           LD       C,-10
  24+ 811B CD 20 81        CALL     .Num1
  25+ 811E 0E FF           LD       C,-1
  26+ 8120              .Num1:
  27+ 8120 3E 2F           LD       A,'0'-1
  28+ 8122              .Num2:
  29+ 8122 3C              INC      A
  30+ 8123 09              ADD      HL, BC
  31+ 8124 DA 22 81        JP       C, .Num2
  32+ 8127 ED 42           SBC      HL, BC
  33+ 8129 12              LD       (DE), A
  34+ 812A 13              INC      DE
  35+ 812B C9              RET
  36+ 812C
  37+ 812C              ;---------------------------------------------------------------------
  38+ 812C              ; Remove leading zeros from the string
  39+ 812C              ; INPUT:
  40+ 812C              ;   HL: Pointer to the string
  41+ 812C              ; OUTPUT: -
  42+ 812C              ; MODIFY: HL, AF, BC
  43+ 812C              ;---------------------------------------------------------------------
  44+ 812C              String_RemoveLeadingZeros:
  45+ 812C CD 40 81         CALL    String_GetLength  ; Get the length of the string
  46+ 812F 47               LD      B, A            ; Set B to the number of digits
  47+ 8130              .Loop:
  48+ 8130                  ; Check if we are at the last digit; if so, exit.
  49+ 8130 78               LD      A, B
  50+ 8131 FE 01            CP      1
  51+ 8133 C8               RET     Z
  52+ 8134                  ; Load the current character.
  53+ 8134 7E               LD      A, (HL)
  54+ 8135 FE 30            CP      '0'
  55+ 8137 C0               RET     NZ  ; If the character is not '0', we've reached the first
  56+ 8138                                        ; nonzero digit; stop replacing.
  57+ 8138                  ; Replace the '0' with a space.
  58+ 8138 3E 20            LD       A, ' '
  59+ 813A 77               LD      (HL), A
  60+ 813B 23               INC     HL              ; Advance to the next character.
  61+ 813C 05               DEC     B               ; Decrement the digit counter.
  62+ 813D C3 30 81         JP      .Loop
  63+ 8140
  64+ 8140
  65+ 8140
  66+ 8140              ;---------------------------------------------------------------------
  67+ 8140              ; Get the length of a string in bytes
  68+ 8140              ; INPUT:
  69+ 8140              ;   HL: Pointer to the string
  70+ 8140              ; OUTPUT: -
  71+ 8140              ; MODIFY: HL, AF, BC
  72+ 8140              ;---------------------------------------------------------------------
  73+ 8140              String_GetLength:
  74+ 8140 E5               PUSH    HL          ; save HL
  75+ 8141 AF               XOR     A           ; A = 0
  76+ 8142 47               LD      B, A        ; B = 0 (length counter)
  77+ 8143
  78+ 8143              .Loop:
  79+ 8143 7E               LD      A, (HL)     ; load byte
  80+ 8144 B7               OR      A           ; set Z if it’s zero
  81+ 8145 CA 4D 81         JP      Z, .Done
  82+ 8148 04               INC     B           ; increment length
  83+ 8149 23               INC     HL
  84+ 814A C3 43 81         JP      .Loop
  85+ 814D
  86+ 814D              .Done:
  87+ 814D E1               POP     HL          ; restore HL
  88+ 814E 78               LD      A, B        ; return length in A
  89+ 814F C9               RET
  90+ 8150
# file closed: ./inc/string.asm
  14  8150              	INCLUDE "hooks.asm"						; Include hooks library
# file opened: ./inc/hooks.asm
   1+ 8150              ; ===================================================================
   2+ 8150              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8150              ; ===================================================================
   4+ 8150
   5+ 8150              ; *** HOOKS.ASM ***
   6+ 8150
   7+ 8150
   8+ 8150
   9+ 8150              ; Hooks_TickStart
  10+ 8150              ;----------------------------------------------------------------------
  11+ 8150              Hooks_TickStart:
  12+ 8150 F5               PUSH    AF
  13+ 8151 3E 00            LD      A, NO
  14+ 8153 32 86 B2         LD      (Var_Hooks_TickSuspended), A
  15+ 8156 F1               POP     AF
  16+ 8157 C9               RET
  17+ 8158              ;----------------------------------------------------------------------
  18+ 8158              ; Hooks_TickStop
  19+ 8158              ;----------------------------------------------------------------------
  20+ 8158              Hooks_TickStop:
  21+ 8158 F5               PUSH    AF
  22+ 8159 3E 01            LD      A, YES
  23+ 815B 32 86 B2         LD      (Var_Hooks_TickSuspended), A
  24+ 815E F1               POP     AF
  25+ 815F C9               RET
  26+ 8160
  27+ 8160              ;----------------------------------------------------------------------
  28+ 8160              ; VBlank ISR
  29+ 8160              ; INPUT: -
  30+ 8160              ; OUTPUT: -
  31+ 8160              ; MODIFIES: A, DE, HL, BC
  32+ 8160              ;----------------------------------------------------------------------
  33+ 8160              VBlankISR:
  34+ 8160 F5               PUSH    AF
  35+ 8161 C5               PUSH    BC
  36+ 8162 D5               PUSH    DE
  37+ 8163 E5               PUSH    HL
  38+ 8164
  39+ 8164
  40+ 8164
  41+ 8164 3A 75 B2         LD      A, (Var_Hooks_FrameCounter)
  42+ 8167 3C               INC     A
  43+ 8168 FE 33            CP      51
  44+ 816A 20 22            JR      NZ, .Continue
  45+ 816C
  46+ 816C 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
  47+ 816F FE 00            CP      NO
  48+ 8171 28 07            JR      Z, .Time
  49+ 8173 3A 24 B2         LD      A, (Var_Game_TimeToPlay)
  50+ 8176 3D               DEC     A
  51+ 8177 32 24 B2         LD      (Var_Game_TimeToPlay), A
  52+ 817A              .Time:
  53+ 817A 3A 8D B2         LD      A, (Var_Hooks_SecondsCounter)
  54+ 817D 3C               INC     A
  55+ 817E FE 3D            CP      61
  56+ 8180 20 08            JR      NZ, .NewMinute
  57+ 8182 3A 8E B2         LD      A, (Var_Hooks_MinutesCounter)
  58+ 8185 3C               INC     A
  59+ 8186 32 8E B2         LD      (Var_Hooks_MinutesCounter), A
  60+ 8189 AF               XOR     A           ; Reset the seconds counter
  61+ 818A              .NewMinute:
  62+ 818A 32 8D B2         LD      (Var_Hooks_SecondsCounter), A
  63+ 818D AF               XOR     A       ; Reset the frame counter
  64+ 818E              .Continue:
  65+ 818E 32 75 B2         LD      (Var_Hooks_FrameCounter), A
  66+ 8191              .Done:
  67+ 8191 3A 84 B2         LD      A, (Var_Hooks_GoalCerimonyCounter)
  68+ 8194 FE 00            CP      0
  69+ 8196 28 08            JR      Z, .AfterGoalCerimony
  70+ 8198 FE FF            CP      NO_VALUE
  71+ 819A CA 36 85         JP      Z, .CheckBlinkingRestartAfterGoal
  72+ 819D C3 36 84         JP      .ShowGoalCerimony
  73+ 81A0              .AfterGoalCerimony:
  74+ 81A0 CD 8A 93         CALL    Utils_PlayBeepHighLong
  75+ 81A3 3A 7C B2         LD      A, (Var_Hooks_GameResumingWaiting)
  76+ 81A6 FE 01            CP      YES
  77+ 81A8 CA 20 84         JP      Z, .CheckGameResumeWaiting
  78+ 81AB 3A 86 B2         LD      A, (Var_Hooks_TickSuspended)
  79+ 81AE FE 01            CP      YES
  80+ 81B0 28 03            JR      Z, .AfterTick
  81+ 81B2 CD 96 85         CALL    AiTick
  82+ 81B5              .AfterTick:
  83+ 81B5 3A 82 B2         LD     A, (Var_Hooks_ForceVdpRedraw)
  84+ 81B8 FE 01            CP     YES
  85+ 81BA 20 0B            JR     NZ, .AfterRedraw
  86+ 81BC 3E 00            LD     A, NO
  87+ 81BE 32 82 B2         LD     (Var_Hooks_ForceVdpRedraw), A
  88+ 81C1 CD 6C A2         CALL   Game_SetVisibileFieldSide
  89+ 81C4 CD 01 8F         CALL   VDP_PlayerMatrixRedraw
  90+ 81C7              .AfterRedraw:
  91+ 81C7 3A 31 B2         LD      A, (Var_Game_FirstKickType)
  92+ 81CA FE FF            CP      NO_VALUE
  93+ 81CC 28 03            JR      Z, .AfterFirtsKickCheck
  94+ 81CE C3 80 83         JP      .CheckFirstKick
  95+ 81D1              .AfterFirtsKickCheck:
  96+ 81D1 3A 7E B2         LD      A, (Var_Hooks_BlinkingIsActive)
  97+ 81D4 FE 01            CP      YES
  98+ 81D6 CA B4 84         JP      Z, .CheckBlinkingState
  99+ 81D9              .AfterBlinkingCheck:
 100+ 81D9 CD 6B A1         CALL   Game_CheckStoppedBallOnGoalOrCorner
 101+ 81DC
 102+ 81DC
 103+ 81DC CD 68 85         CALL    UpdateMatchTime
 104+ 81DF              .ReadKeyBoard:
 105+ 81DF CD 14 93         CALL    Utils_ReadKeyboard
 106+ 81E2 FE 20            CP      KBD_KEY_SPACE
 107+ 81E4 CA 48 82         JP      Z, .SpaceButtonPressed
 108+ 81E7 FE 35            CP      KBD_KEY_LEFT
 109+ 81E9 CA 84 82         JP      Z, .LeftArrowPressed
 110+ 81EC FE 38            CP      KBD_KEY_RIGHT
 111+ 81EE CA B3 82         JP      Z, .RightArrowPressed
 112+ 81F1 FE 36            CP      KBD_KEY_DOWN
 113+ 81F3 CA 9D 82         JP      Z, .DownArrowPressed
 114+ 81F6 FE 37            CP      KBD_KEY_UP
 115+ 81F8 CA 32 82         JP      Z, .UpArrowPressed
 116+ 81FB FE 57            CP      KBD_KEY_W
 117+ 81FD CA 1F 82         JP      Z, .WKeyPressed
 118+ 8200 FE 41            CP      KBD_KEY_A
 119+ 8202 CA 5B 82         JP      Z, .AKeyPressed
 120+ 8205 FE 53            CP      KBD_KEY_S
 121+ 8207 CA 71 82         JP      Z, .SKeyPressed
 122+ 820A FE 4B            CP      KBD_KEY_K
 123+ 820C CA 92 82         JP      Z, .KKeyPressed
 124+ 820F FE 4C            CP      KBD_KEY_L
 125+ 8211 CA C1 82         JP      Z, .LKeyPressed
 126+ 8214 FE 4F            CP      KBD_KEY_O
 127+ 8216 CA 53 82         JP      Z, .OKeyPressed
 128+ 8219              .Exit
 129+ 8219 E1               POP    HL
 130+ 821A D1               POP    DE
 131+ 821B C1               POP    BC
 132+ 821C F1               POP    AF
 133+ 821D ED 4D            RETI ;JP     Var_Hooks_Old_HTIMI    ; return to the original code (inside the BIOS)
 134+ 821F              .WKeyPressed:
 135+ 821F 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 136+ 8222 FE 00            CP      NO
 137+ 8224 CA 70 84         JP      Z, .StartGame
 138+ 8227 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 139+ 822A FE 01            CP      GAME_MODE_1_PLAYER
 140+ 822C CA 19 82         JP      Z, .Exit
 141+ 822F C3 0C 83         JP      .BlackTeamTryShotOrRestart
 142+ 8232              .UpArrowPressed:
 143+ 8232 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 144+ 8235 FE 01            CP      YES
 145+ 8237 CA 46 83         JP      Z, .WhiteTeamTryShotOrRestart
 146+ 823A 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 147+ 823D FE 01            CP      GAME_MODE_1_PLAYER
 148+ 823F C2 19 82         JP      NZ, .Exit
 149+ 8242 C3 03 84         JP     .LevelUp
 150+ 8245 C3 19 82         JP      .Exit
 151+ 8248              .SpaceButtonPressed:
 152+ 8248 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 153+ 824B FE 00            CP      NO
 154+ 824D CA 70 84         JP      Z, .StartGame
 155+ 8250 C3 19 82         JP      .Exit
 156+ 8253              .OKeyPressed:
 157+ 8253 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 158+ 8256 FE 00            CP      NO
 159+ 8258 CA 19 82         JP      Z, .Exit
 160+ 825B              .AKeyPressed:
 161+ 825B C3 46 83         JP      .WhiteTeamTryShotOrRestart
 162+ 825E 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 163+ 8261 FE 00            CP      NO
 164+ 8263 CA 19 82         JP      Z, .Exit
 165+ 8266 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 166+ 8269 FE 01            CP      GAME_MODE_1_PLAYER
 167+ 826B CA 19 82         JP      Z, .Exit
 168+ 826E C3 CC 82         JP     .BlackTeamMoveLeft
 169+ 8271              .SKeyPressed:
 170+ 8271 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 171+ 8274 FE 00            CP      NO
 172+ 8276 CA 19 82         JP      Z, .Exit
 173+ 8279 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 174+ 827C FE 01            CP      GAME_MODE_1_PLAYER
 175+ 827E CA 19 82         JP      Z, .Exit
 176+ 8281 C3 DC 82         JP     .BlackTeamMoveRight
 177+ 8284              .LeftArrowPressed:
 178+ 8284 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 179+ 8287 FE 01            CP      YES
 180+ 8289 CA 19 82         JP      Z, .Exit
 181+ 828C C3 C3 83         JP     .ChangeGameSelectedMode
 182+ 828F C3 19 82         JP      .Exit
 183+ 8292              .KKeyPressed:
 184+ 8292 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 185+ 8295 FE 01            CP      YES
 186+ 8297 CA EC 82         JP      Z, .WhiteTeamMoveLeft
 187+ 829A C3 19 82         JP      .Exit
 188+ 829D              .DownArrowPressed:
 189+ 829D 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 190+ 82A0 FE 01            CP      YES
 191+ 82A2 CA 19 82         JP      Z, .Exit
 192+ 82A5 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 193+ 82A8 FE 01            CP      GAME_MODE_1_PLAYER
 194+ 82AA C2 19 82         JP      NZ, .Exit
 195+ 82AD C3 E6 83         JP     .LevelDown
 196+ 82B0 C3 19 82         JP      .Exit
 197+ 82B3              .RightArrowPressed:
 198+ 82B3 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 199+ 82B6 FE 01            CP      YES
 200+ 82B8 CA 19 82         JP      Z, .Exit
 201+ 82BB C3 C3 83         JP     .ChangeGameSelectedMode
 202+ 82BE C3 19 82         JP     .Exit
 203+ 82C1              .LKeyPressed:
 204+ 82C1 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 205+ 82C4 FE 01            CP      YES
 206+ 82C6 CA FC 82         JP      Z, .WhiteTeamMoveRight
 207+ 82C9 C3 19 82         JP     .Exit
 208+ 82CC              .BlackTeamMoveLeft:
 209+ 82CC 3A 31 B2         LD      A, (Var_Game_FirstKickType)
 210+ 82CF FE FF            CP      NO_VALUE
 211+ 82D1 C2 19 82         JP      NZ, .Exit
 212+ 82D4 3E 02            LD      A, PLAYER_ASKED_DIRECTION_WEST
 213+ 82D6 CD F7 9F         CALL    Game_BlackTeamHorizMoveAsked
 214+ 82D9 C3 19 82         JP      .Exit
 215+ 82DC              .BlackTeamMoveRight:
 216+ 82DC 3A 31 B2         LD      A, (Var_Game_FirstKickType)
 217+ 82DF FE FF            CP      NO_VALUE
 218+ 82E1 C2 19 82         JP      NZ, .Exit
 219+ 82E4 3E 01            LD      A, PLAYER_ASKED_DIRECTION_EAST
 220+ 82E6 CD F7 9F         CALL    Game_BlackTeamHorizMoveAsked
 221+ 82E9 C3 19 82         JP      .Exit
 222+ 82EC              .WhiteTeamMoveLeft:
 223+ 82EC 3A 31 B2         LD      A, (Var_Game_FirstKickType)
 224+ 82EF FE FF            CP      NO_VALUE
 225+ 82F1 C2 19 82         JP      NZ, .Exit
 226+ 82F4 3E 02            LD      A, PLAYER_ASKED_DIRECTION_WEST
 227+ 82F6 CD 93 A0         CALL    Game_WhiteTeamHorizMoveAsked
 228+ 82F9 C3 19 82         JP      .Exit
 229+ 82FC              .WhiteTeamMoveRight:
 230+ 82FC 3A 31 B2         LD      A, (Var_Game_FirstKickType)
 231+ 82FF FE FF            CP      NO_VALUE
 232+ 8301 C2 19 82         JP      NZ, .Exit
 233+ 8304 3E 01            LD      A, PLAYER_ASKED_DIRECTION_EAST
 234+ 8306 CD 93 A0         CALL    Game_WhiteTeamHorizMoveAsked
 235+ 8309 C3 19 82         JP      .Exit
 236+ 830C              .BlackTeamTryShotOrRestart:
 237+ 830C 3A 31 B2         LD      A, (Var_Game_FirstKickType)
 238+ 830F FE FF            CP      NO_VALUE
 239+ 8311 28 21            JR      Z, .BlackTeamTryShot
 240+ 8313 FE 02            CP      FIRST_KICK_TYPE_BLACK_HALF_FIELD
 241+ 8315 28 11            JR      Z,.BlackTeamRestartFromHalfField
 242+ 8317 FE 04            CP      FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
 243+ 8319 C2 19 82         JP      NZ, .Exit
 244+ 831C 3A 08 B2         LD      A, (Var_Game_SecondsToPlay)
 245+ 831F 32 24 B2         LD      (Var_Game_TimeToPlay),A
 246+ 8322 C3 AF 99         JP      Resume_BlackGoalKick.exec
 247+ 8325 C3 19 82         JP      .Exit
 248+ 8328              .BlackTeamRestartFromHalfField:
 249+ 8328 3A 08 B2         LD      A, (Var_Game_SecondsToPlay)
 250+ 832B 32 24 B2         LD      (Var_Game_TimeToPlay),A
 251+ 832E C3 F5 99         JP      Resume_BlackKickoff.exec
 252+ 8331 C3 19 82         JP      .Exit
 253+ 8334              .BlackTeamTryShot:
 254+ 8334 CD 9F 9A         CALL    Game_GetPlayerIdWithBall
 255+ 8337 FE 00            CP      TEAM_BLACK
 256+ 8339 C2 19 82         JP      NZ, .Exit
 257+ 833C 3E 00            LD      A, TEAM_BLACK
 258+ 833E 47               LD      B, A
 259+ 833F 4C               LD      C, H
 260+ 8340 CD 0F 9D         CALL    Game_TryShot
 261+ 8343 C3 19 82         JP      .Exit
 262+ 8346              .WhiteTeamTryShotOrRestart:
 263+ 8346 3A 31 B2         LD      A, (Var_Game_FirstKickType)
 264+ 8349 FE FF            CP      NO_VALUE
 265+ 834B 28 21            JR      Z, .WhiteTeamTryShot
 266+ 834D FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 267+ 834F 28 11            JR      Z,.WhiteTeamRestartFromHalfField
 268+ 8351 FE 03            CP      FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
 269+ 8353 C2 19 82         JP      NZ, .Exit
 270+ 8356 3A 08 B2         LD      A, (Var_Game_SecondsToPlay)
 271+ 8359 32 24 B2         LD      (Var_Game_TimeToPlay),A
 272+ 835C C3 5F 99         JP      Resume_WhiteGoalKick.exec
 273+ 835F C3 19 82         JP      .Exit
 274+ 8362              .WhiteTeamRestartFromHalfField:
 275+ 8362 3A 08 B2         LD      A, (Var_Game_SecondsToPlay)
 276+ 8365 32 24 B2         LD      (Var_Game_TimeToPlay),A
 277+ 8368 C3 3B 9A         JP      Resume_WhiteKickoff.exec
 278+ 836B C3 19 82         JP      .Exit
 279+ 836E              .WhiteTeamTryShot:
 280+ 836E CD 9F 9A         CALL    Game_GetPlayerIdWithBall
 281+ 8371 FE 01            CP      TEAM_WHITE
 282+ 8373 C2 19 82         JP      NZ, .Exit
 283+ 8376 3E 01            LD      A, TEAM_WHITE
 284+ 8378 47               LD      B, A
 285+ 8379 4C               LD      C, H
 286+ 837A CD 0F 9D         CALL    Game_TryShot
 287+ 837D C3 19 82         JP      .Exit
 288+ 8380              .CheckFirstKick:
 289+ 8380 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 290+ 8383 FE 00            CP      NO
 291+ 8385 28 10            JR      Z, .CheckFirstKickCpuTeam
 292+ 8387 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 293+ 838A FE 02            CP      GAME_MODE_2_PLAYERS
 294+ 838C CA DF 81         JP      Z, .ReadKeyBoard
 295+ 838F 3A 31 B2         LD      A,(Var_Game_FirstKickType)
 296+ 8392 FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 297+ 8394 CA DF 81         JP      Z, .ReadKeyBoard
 298+ 8397              .CheckFirstKickCpuTeam:
 299+ 8397 3A 32 B2         LD      A, (Var_Game_FirstKickFrameCounter)
 300+ 839A 3C               INC     A
 301+ 839B 32 32 B2         LD      (Var_Game_FirstKickFrameCounter), A
 302+ 839E FE 1E            CP      BLINK_FRAMES_DURATION
 303+ 83A0 C2 19 82         JP      NZ, .Exit
 304+ 83A3 3A 08 B2         LD      A, (Var_Game_SecondsToPlay)
 305+ 83A6 32 24 B2         LD      (Var_Game_TimeToPlay),A
 306+ 83A9 3A 31 B2         LD      A, (Var_Game_FirstKickType)
 307+ 83AC FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 308+ 83AE CA 3B 9A         JP      Z, Resume_WhiteKickoff.exec
 309+ 83B1 FE 02            CP      FIRST_KICK_TYPE_BLACK_HALF_FIELD
 310+ 83B3 CA F5 99         JP      Z, Resume_BlackKickoff.exec
 311+ 83B6 FE 03            CP      FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
 312+ 83B8 CA 5F 99         JP      Z, Resume_WhiteGoalKick.exec
 313+ 83BB FE 04            CP      FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
 314+ 83BD CA AF 99         JP      Z, Resume_BlackGoalKick.exec
 315+ 83C0 C3 19 82         JP       .Exit
 316+ 83C3              .ChangeGameSelectedMode:
 317+ 83C3 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 318+ 83C6 FE 01            CP      GAME_MODE_1_PLAYER
 319+ 83C8 28 0E            JR      Z, .ChangeGameSelectedModeToGAME_MODE_2_PLAYERS
 320+ 83CA              .ChangeGameSelectedModeToCPU:
 321+ 83CA 3E 01            LD      A, GAME_MODE_1_PLAYER
 322+ 83CC 32 2F B2         LD      (Var_Game_SelectedPlayers), A
 323+ 83CF CD A6 91         CALL    Menu_ShowOptions
 324+ 83D2 CD 7A 93         CALL    Utils_PlayBeep
 325+ 83D5 C3 19 82         JP      .Exit
 326+ 83D8              .ChangeGameSelectedModeToGAME_MODE_2_PLAYERS:
 327+ 83D8 3E 02            LD      A, GAME_MODE_2_PLAYERS
 328+ 83DA 32 2F B2         LD      (Var_Game_SelectedPlayers), A
 329+ 83DD CD A6 91         CALL    Menu_ShowOptions
 330+ 83E0 CD 7A 93         CALL    Utils_PlayBeep
 331+ 83E3 C3 19 82         JP      .Exit
 332+ 83E6              .LevelDown:
 333+ 83E6 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 334+ 83E9 FE 02            CP      GAME_MODE_2_PLAYERS
 335+ 83EB CA 68 92         JP      Z, Menu_ShowOptions.Level1
 336+ 83EE 3A 09 B2         LD      A, (Var_Game_SelectedLevel)
 337+ 83F1 FE 01            CP      1
 338+ 83F3 CA 19 82         JP      Z, .Exit
 339+ 83F6 3D               DEC     A
 340+ 83F7 32 09 B2         LD      (Var_Game_SelectedLevel), A
 341+ 83FA CD 68 92         CALL    Menu_ShowOptions.Level1
 342+ 83FD CD 7A 93         CALL    Utils_PlayBeep
 343+ 8400 C3 19 82         JP      .Exit
 344+ 8403              .LevelUp:
 345+ 8403 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 346+ 8406 FE 02            CP      GAME_MODE_2_PLAYERS
 347+ 8408 CA 68 92         JP      Z, Menu_ShowOptions.Level1
 348+ 840B 3A 09 B2         LD      A, (Var_Game_SelectedLevel)
 349+ 840E FE 05            CP      5
 350+ 8410 CA 19 82         JP      Z, .Exit
 351+ 8413 3C               INC     A
 352+ 8414 32 09 B2         LD      (Var_Game_SelectedLevel), A
 353+ 8417 CD 68 92         CALL    Menu_ShowOptions.Level1
 354+ 841A CD 7A 93         CALL    Utils_PlayBeep
 355+ 841D C3 19 82         JP      .Exit
 356+ 8420              .CheckGameResumeWaiting:
 357+ 8420 3A 75 B2         LD      A, (Var_Hooks_FrameCounter)
 358+ 8423 FE 1E            CP      BLINK_FRAMES_DURATION
 359+ 8425 C2 19 82         JP      NZ, .Exit
 360+ 8428 3E 00            LD      A, NO
 361+ 842A 32 7C B2         LD      (Var_Hooks_GameResumingWaiting), A
 362+ 842D CD 02 99         CALL    Game_Resume
 363+ 8430 CD 01 8F         CALL    VDP_PlayerMatrixRedraw
 364+ 8433 C3 19 82         JP      .Exit
 365+ 8436              .ShowGoalCerimony:
 366+ 8436 3A 7D B2         LD      A, (Var_Hooks_CerimonySpeedCounter)
 367+ 8439 3C               INC     A
 368+ 843A 32 7D B2         LD      (Var_Hooks_CerimonySpeedCounter), A
 369+ 843D FE 14            CP      CERIMONY_MOVEMENT_SPEED
 370+ 843F C2 19 82         JP      NZ, .Exit
 371+ 8442 AF               XOR     A
 372+ 8443 32 7D B2         LD      (Var_Hooks_CerimonySpeedCounter), A
 373+ 8446 3A 84 B2         LD      A,(Var_Hooks_GoalCerimonyCounter)
 374+ 8449 3D               DEC     A
 375+ 844A 32 84 B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 376+ 844D 3E 01            LD      A, TEAM_WHITE
 377+ 844F 47               LD      B, A
 378+ 8450 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
 379+ 8453 FE 01            CP      FIELD_NORTH_SIDE
 380+ 8455 28 03            JR      Z, .ShowGoalCerimonyTeamSelected
 381+ 8457 3E 00            LD      A, TEAM_BLACK
 382+ 8459 47               LD      B, A
 383+ 845A              .ShowGoalCerimonyTeamSelected:
 384+ 845A 3A 84 B2         LD      A,(Var_Hooks_GoalCerimonyCounter)
 385+ 845D CD 37 AA         CALL    Game_GoalCelebration_DrawFrame
 386+ 8460
 387+ 8460 3A 84 B2         LD      A,(Var_Hooks_GoalCerimonyCounter)
 388+ 8463 FE 00            CP      0
 389+ 8465 C2 DF 81         JP      NZ,.ReadKeyBoard
 390+ 8468 3E FF            LD      A, NO_VALUE
 391+ 846A 32 84 B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 392+ 846D C3 DF 81         JP      .ReadKeyBoard
 393+ 8470              .StartGame:
 394+ 8470 3E FF            LD      A,NO_VALUE
 395+ 8472 32 31 B2         LD      (Var_Game_FirstKickType), A
 396+ 8475 3E 00            LD      A, NO
 397+ 8477 32 7E B2         LD      (Var_Hooks_BlinkingIsActive), A
 398+ 847A 32 7C B2         LD      (Var_Hooks_GameResumingWaiting), A
 399+ 847D CD 59 9E         CALL    Game_StopShot
 400+ 8480 3E 00            LD      A, NO
 401+ 8482 32 82 B2         LD      (Var_Hooks_ForceVdpRedraw), A
 402+ 8485 3A 09 B2         LD      A, (Var_Game_SelectedLevel)
 403+ 8488 32 2D B2         LD      (Var_Game_PlayersSpeed), A
 404+ 848B 3E 3C            LD      A, MATCH_TIME
 405+ 848D 32 24 B2         LD      (Var_Game_TimeToPlay), A
 406+ 8490 CD 8C 88         CALL    Hooks_UpdateTimeToPlay
 407+ 8493 AF               XOR     A
 408+ 8494 32 84 B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 409+ 8497 32 0E B2         LD      (Var_Game_BallUpdateTimer), A
 410+ 849A 32 23 B2         LD      (Var_Game_ScoreWhite), A
 411+ 849D 32 16 B2         LD      (Var_Game_ScoreBlack), A
 412+ 84A0 CD 1F 91         CALL    VDP_ClearMenuSideArea
 413+ 84A3 3E 01            LD      A, YES
 414+ 84A5 32 2C B2         LD      (Var_Game_MatchInProgress), A
 415+ 84A8 CD 32 91         CALL    VDP_ShowScores
 416+ 84AB CD 15 A4         CALL    Game_Start
 417+ 84AE CD 68 85         CALL    UpdateMatchTime
 418+ 84B1 C3 19 82         JP      .Exit
 419+ 84B4              .CheckBlinkingState:
 420+ 84B4 CD 58 81         CALL    Hooks_TickStop
 421+ 84B7 3A 7F B2         LD      A, (Var_Hooks_BlinkingMustResetFrameCounter)
 422+ 84BA FE 00            CP      NO
 423+ 84BC CA C3 84         JP      Z,.CheckBlinkingStateAfterReset
 424+ 84BF AF               XOR     A
 425+ 84C0 32 75 B2         LD      (Var_Hooks_FrameCounter), A
 426+ 84C3              .CheckBlinkingStateAfterReset:
 427+ 84C3 3A 75 B2         LD      A, (Var_Hooks_FrameCounter)
 428+ 84C6 FE 1E            CP      BLINK_FRAMES_DURATION
 429+ 84C8 CA D3 84         JP      Z,.CheckBlinkingStateContinue
 430+ 84CB 3E 00            LD      A, NO
 431+ 84CD 32 7F B2         LD      (Var_Hooks_BlinkingMustResetFrameCounter), A
 432+ 84D0 C3 19 82         JP      .Exit
 433+ 84D3              .CheckBlinkingStateContinue:
 434+ 84D3 3E 01            LD      A, YES
 435+ 84D5 32 7F B2         LD      (Var_Hooks_BlinkingMustResetFrameCounter), A
 436+ 84D8 3A 7B B2         LD      A, (Var_Hooks_BlinkingCounter)
 437+ 84DB 3C               INC     A
 438+ 84DC 32 7B B2         LD      (Var_Hooks_BlinkingCounter), A
 439+ 84DF FE 07            CP      7
 440+ 84E1 28 1E            JR      Z,.CheckBlinkingStateStop
 441+ 84E3 3A 78 B2         LD      A, (Var_Hooks_BlinkingTileToShow)
 442+ 84E6 47               LD      B, A
 443+ 84E7 3A 7A B2         LD      A, (Var_Hooks_BlinkingActiveTile)
 444+ 84EA B8               CP      B
 445+ 84EB 20 04            JR      NZ, .CheckBlinkingStateShowTile
 446+ 84ED 3A 79 B2         LD      A, (Var_Hooks_BlinkingTileToHide)
 447+ 84F0 47               LD      B, A
 448+ 84F1              .CheckBlinkingStateShowTile:
 449+ 84F1 78               LD      A, B
 450+ 84F2 32 7A B2         LD      (Var_Hooks_BlinkingActiveTile), A
 451+ 84F5 CD 92 95         CALL    Game_GetBallPosition
 452+ 84F8 3A 7A B2         LD      A, (Var_Hooks_BlinkingActiveTile)
 453+ 84FB CD 35 89         CALL    VDP_DrawSprite
 454+ 84FE C3 DF 81         JP      .ReadKeyBoard
 455+ 8501              .CheckBlinkingStateStop:
 456+ 8501 3E 00            LD      A, NO
 457+ 8503 32 7E B2         LD      (Var_Hooks_BlinkingIsActive), A
 458+ 8506 3A 77 B2         LD      A, (Var_Hooks_BlinkingType)
 459+ 8509 FE 01            CP      BLINK_TYPE_GOAL
 460+ 850B 28 0F            JR      Z, .GoalCerimony
 461+ 850D 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
 462+ 8510 FE 01            CP      FIELD_NORTH_SIDE
 463+ 8512 20 1A            JR      NZ,.CheckBlinkingRestartAfterNoGoalFromSouth
 464+ 8514 CD A3 8B         CALL    VDP_DrawField
 465+ 8517 CD ED 97         CALL    SetBlackRestartSchema
 466+ 851A 18 3D            JR     .CheckBlinkingRestartResume
 467+ 851C              .GoalCerimony:
 468+ 851C AF               XOR   A
 469+ 851D 32 7D B2         LD    (Var_Hooks_CerimonySpeedCounter), A
 470+ 8520 CD 48 A4         CALL  Game_ClearGameFieldForGoalCerimony
 471+ 8523 3E 09            LD    A, 9
 472+ 8525 32 84 B2         LD    (Var_Hooks_GoalCerimonyCounter), A
 473+ 8528 CD 16 AA         CALL    CerimonyRedrawHalfFieldLine
 474+ 852B C3 19 82         JP    .Exit
 475+ 852E              .CheckBlinkingRestartAfterNoGoalFromSouth:
 476+ 852E CD A3 8B         CALL    VDP_DrawField
 477+ 8531 CD 78 98         CALL    SetWhiteRestartSchema
 478+ 8534 18 23            JR     .CheckBlinkingRestartResume
 479+ 8536              .CheckBlinkingRestartAfterGoal:
 480+ 8536 AF               XOR     A
 481+ 8537 32 84 B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 482+ 853A 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
 483+ 853D FE 01            CP      FIELD_NORTH_SIDE
 484+ 853F 28 0D            JR      Z, .CheckBlinkingRestartAfterGoalFromSouth
 485+ 8541 3E 01            LD      A, FIELD_NORTH_SIDE
 486+ 8543 32 07 B2         LD      (Var_Game_ActiveFieldSide), A
 487+ 8546 CD A3 8B         CALL    VDP_DrawField
 488+ 8549 CD E2 96         CALL    Game_SetWhiteKickoffSchema
 489+ 854C 18 0B            JR      .CheckBlinkingRestartResume
 490+ 854E              .CheckBlinkingRestartAfterGoalFromSouth:
 491+ 854E 3E 00            LD      A, FIELD_SOUTH_SIDE
 492+ 8550 32 07 B2         LD      (Var_Game_ActiveFieldSide), A
 493+ 8553 CD A3 8B         CALL    VDP_DrawField
 494+ 8556 CD 67 97         CALL    Game_SetBlackKickoffSchema
 495+ 8559              .CheckBlinkingRestartResume:
 496+ 8559 CD 01 8F         CALL   VDP_PlayerMatrixRedraw
 497+ 855C AF               XOR    A
 498+ 855D 32 75 B2         LD     (Var_Hooks_FrameCounter), A
 499+ 8560 3E 01            LD     A, YES
 500+ 8562 32 7C B2         LD     (Var_Hooks_GameResumingWaiting), A
 501+ 8565 C3 19 82         JP     .Exit
 502+ 8568
 503+ 8568              UpdateMatchTime:
 504+ 8568 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
 505+ 856B FE 00            CP      NO
 506+ 856D C8               RET     Z
 507+ 856E E5               PUSH    HL
 508+ 856F D5               PUSH    DE
 509+ 8570 C5               PUSH    BC
 510+ 8571 3A 24 B2         LD      A, (Var_Game_TimeToPlay)
 511+ 8574
 512+ 8574 FE FF            CP      255
 513+ 8576 CA 31 A1         JP      Z,  Game_GameOver
 514+ 8579 11 FE B1         LD      DE, Var_Utils_NumberToPrint
 515+ 857C 26 00            LD      H, 0
 516+ 857E 6F               LD      L, A
 517+ 857F CD 07 81         CALL    String_NumberToASCII
 518+ 8582 21 FE B1         LD      HL, Var_Utils_NumberToPrint
 519+ 8585 CD 2C 81         CALL    String_RemoveLeadingZeros
 520+ 8588 21 FE B1         LD      HL, Var_Utils_NumberToPrint
 521+ 858B 16 01            LD      D, 1
 522+ 858D 1E 1A            LD      E, 26
 523+ 858F CD 93 88         CALL    VDP_PrintString
 524+ 8592 C1               POP     BC
 525+ 8593 D1               POP     DE
 526+ 8594 E1               POP     HL
 527+ 8595 C9               RET
 528+ 8596
 529+ 8596
 530+ 8596              ;----------------------------------------------------------------------------
 531+ 8596              ; AiTick
 532+ 8596              ;----------------------------------------------------------------------------
 533+ 8596              AiTick:
 534+ 8596 F5               push af
 535+ 8597 C5               push bc
 536+ 8598 D5               push de
 537+ 8599 E5               push hl
 538+ 859A
 539+ 859A 3A 82 B2         ld  a,(Var_Hooks_ForceVdpRedraw)
 540+ 859D FE 01            cp  YES
 541+ 859F 28 7C            jr  z, .done
 542+ 85A1
 543+ 85A1 CD 25 94         call Game_UpdateBallMovement
 544+ 85A4
 545+ 85A4 3A 83 B2         ld  a,(Var_Hooks_TickSpeed)
 546+ 85A7 47               ld  b, a
 547+ 85A8 3A 85 B2         ld  a, (Var_Hooks_TickCounter)
 548+ 85AB 3C               inc a
 549+ 85AC 32 85 B2         ld  (Var_Hooks_TickCounter), a
 550+ 85AF B8               cp  b
 551+ 85B0 20 6B            jr  nz, .done
 552+ 85B2
 553+ 85B2 AF               xor a
 554+ 85B3 32 85 B2         ld  (Var_Hooks_TickCounter), a
 555+ 85B6
 556+ 85B6 3A 2D B2         ld   a,(Var_Game_PlayersSpeed)
 557+ 85B9 FE 01            cp   1
 558+ 85BB 30 02            jr   nc,.speed_ok
 559+ 85BD 3E 01            ld   a,1
 560+ 85BF              .speed_ok:
 561+ 85BF FE 05            cp   5
 562+ 85C1 38 02            jr   c,.speed_ok2
 563+ 85C3 3E 05            ld   a,5
 564+ 85C5              .speed_ok2:
 565+ 85C5 47               ld   b,a
 566+ 85C6 3E 06            ld   a,6
 567+ 85C8 90               sub  b
 568+ 85C9 47               ld   b,a                 ; B = delay (1..5)
 569+ 85CA
 570+ 85CA                  ; --- controlla se siamo in demo (match non in corso) ---
 571+ 85CA 3A 2C B2         ld   a,(Var_Game_MatchInProgress)
 572+ 85CD FE 00            cp   NO
 573+ 85CF 28 0D            jr   z,.demo_mode
 574+ 85D1
 575+ 85D1                  ; --- partita normale ---
 576+ 85D1 3A 2F B2         ld   a,(Var_Game_SelectedPlayers)
 577+ 85D4 FE 01            cp   GAME_MODE_1_PLAYER
 578+ 85D6 28 2E            jr   z,.one_player_mode
 579+ 85D8 FE 02            cp   GAME_MODE_2_PLAYERS
 580+ 85DA 28 3F            jr   z,.two_players_mode
 581+ 85DC 18 3F            jr   .done               ; modalità sconosciuta? non fare nulla
 582+ 85DE
 583+ 85DE              ; ---- DEMO: entrambe le squadre CPU --------------------------------
 584+ 85DE              .demo_mode:
 585+ 85DE                  ; TEAM_BLACK
 586+ 85DE 3A 76 B2         ld   a,(Var_Hooks_AiCounterBlack)
 587+ 85E1 3C               inc  a
 588+ 85E2 32 76 B2         ld   (Var_Hooks_AiCounterBlack),a   ; <-- SALVA SEMPRE DOPO INC
 589+ 85E5 B8               cp   b
 590+ 85E6 38 09            jr   c,.skip_black_demo
 591+ 85E8 AF               xor  a
 592+ 85E9 32 76 B2         ld   (Var_Hooks_AiCounterBlack),a   ; reset contatore
 593+ 85EC 06 00            ld   b,TEAM_BLACK
 594+ 85EE CD 22 86         call AiUpdateTeam
 595+ 85F1              .skip_black_demo:
 596+ 85F1
 597+ 85F1                  ; TEAM_WHITE
 598+ 85F1 3A 8C B2         ld   a,(Var_Hooks_AiCounterWhite)
 599+ 85F4 3C               inc  a
 600+ 85F5 32 8C B2         ld   (Var_Hooks_AiCounterWhite),a   ; <-- SALVA SEMPRE DOPO INC
 601+ 85F8 B8               cp   b
 602+ 85F9 38 09            jr   c,.skip_white_demo
 603+ 85FB AF               xor  a
 604+ 85FC 32 8C B2         ld   (Var_Hooks_AiCounterWhite),a   ; reset contatore
 605+ 85FF 06 01            ld   b,TEAM_WHITE
 606+ 8601 CD 22 86         call AiUpdateTeam
 607+ 8604              .skip_white_demo:
 608+ 8604 18 17            jr   .done
 609+ 8606
 610+ 8606              ; ---- 1 PLAYER: CPU controlla solo i NERI --------------------------
 611+ 8606              .one_player_mode:
 612+ 8606                  ; TEAM_BLACK CPU
 613+ 8606 3A 76 B2         ld   a,(Var_Hooks_AiCounterBlack)
 614+ 8609 3C               inc  a
 615+ 860A 32 76 B2         ld   (Var_Hooks_AiCounterBlack),a   ; <-- SALVA SEMPRE DOPO INC
 616+ 860D B8               cp   b
 617+ 860E 38 09            jr   c,.skip_black_1p
 618+ 8610 AF               xor  a
 619+ 8611 32 76 B2         ld   (Var_Hooks_AiCounterBlack),a   ; reset contatore
 620+ 8614 06 00            ld   b,TEAM_BLACK
 621+ 8616 CD 22 86         call AiUpdateTeam
 622+ 8619              .skip_black_1p:
 623+ 8619 18 02            jr   .done
 624+ 861B
 625+ 861B              ; ---- 2 PLAYERS: nessuna CPU --------------------------------------
 626+ 861B              .two_players_mode:
 627+ 861B                  ; niente
 628+ 861B 18 00            jr   .done
 629+ 861D
 630+ 861D              .done:
 631+ 861D E1               pop  hl
 632+ 861E D1               pop  de
 633+ 861F C1               pop  bc
 634+ 8620 F1               pop  af
 635+ 8621 C9               ret
 636+ 8622
 637+ 8622
 638+ 8622              ; ---------------------------------------------------------------------------
 639+ 8622              ; AiUpdateTeam
 640+ 8622              ;
 641+ 8622              ; INPUT:
 642+ 8622              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 643+ 8622              ;
 644+ 8622              ; Usa:
 645+ 8622              ;   Game_GetPlayerIdWithBall
 646+ 8622              ;   AiUpdateGoalkeeper
 647+ 8622              ;   AiMoveChaserTowardBall
 648+ 8622              ;   AiBallCarrierDecision
 649+ 8622              ;   AiVerticalAdjustments
 650+ 8622              ;
 651+ 8622              ; Convenzioni Game_GetPlayerIdWithBall:
 652+ 8622              ;   A = stato/team:
 653+ 8622              ;       BALL_STATUS_MOVING
 654+ 8622              ;       BALL_STATUS_FREE
 655+ 8622              ;       BALL_STATUS_CONTENDED
 656+ 8622              ;       TEAM_BLACK / TEAM_WHITE (se una squadra ha il possesso)
 657+ 8622              ;   H = ID giocatore in possesso (o 255 se nessuno)
 658+ 8622              ;   L = ID contendente (o 255 se nessuno)
 659+ 8622              ; ---------------------------------------------------------------------------
 660+ 8622              AiUpdateTeam:
 661+ 8622 F5               push af
 662+ 8623 C5               push bc
 663+ 8624 D5               push de
 664+ 8625 E5               push hl
 665+ 8626
 666+ 8626                  ; Salva TEAM di input
 667+ 8626 48               ld   c,b                 ; C = TEAM_ORIG
 668+ 8627 C5               PUSH  BC
 669+ 8628                  ; Chi ha la palla?
 670+ 8628 CD 9F 9A         call Game_GetPlayerIdWithBall
 671+ 862B                  ; A = stato/team, H = ownerID (o 255), L = contenderID (o 255)
 672+ 862B C1               POP   BC
 673+ 862C
 674+ 862C
 675+ 862C 5C               ld   e,h                 ; E = ownerID (se esiste)
 676+ 862D 57               ld   d,a                 ; D = stato/team
 677+ 862E                  ; --- caso: palla in movimento ---------------------------------
 678+ 862E
 679+ 862E FE 64            cp   BALL_STATUS_MOVING
 680+ 8630 20 02            jr   nz, .chk_contended
 681+ 8632
 682+ 8632                  ; palla che viaggia: portiere si aggiusta un po', niente altro
 683+ 8632                  ;;call AiUpdateGoalkeeper
 684+ 8632 18 2D            jr   .done
 685+ 8634
 686+ 8634              .chk_contended:
 687+ 8634
 688+ 8634 FE 65            cp   BALL_STATUS_CONTENDED
 689+ 8636 20 08            jr   nz, .chk_free
 690+ 8638
 691+ 8638                  ; palla contesa: per ora ci comportiamo come se fosse “palla libera”
 692+ 8638
 693+ 8638                  ;;call AiUpdateGoalkeeper
 694+ 8638 CD B5 86         call AiMoveChaserTowardBall
 695+ 863B CD F5 87         call AiVerticalAdjustments
 696+ 863E 18 21            jr   .done
 697+ 8640
 698+ 8640              .chk_free:
 699+ 8640
 700+ 8640 FE 66            cp   BALL_STATUS_FREE
 701+ 8642 20 08            jr   nz, .chk_team_possession
 702+ 8644
 703+ 8644                  ;; palla libera
 704+ 8644                  ;;call AiUpdateGoalkeeper
 705+ 8644 CD B5 86         call AiMoveChaserTowardBall
 706+ 8647 CD F5 87         call AiVerticalAdjustments
 707+ 864A 18 15            jr   .done
 708+ 864C
 709+ 864C              ; -------------------------------------------------------------------
 710+ 864C              ; Qui A (=D) è o TEAM_BLACK o TEAM_WHITE: una squadra ha il possesso
 711+ 864C              ; -------------------------------------------------------------------
 712+ 864C              .chk_team_possession:
 713+ 864C                  ; Se D == TEAM_ORIG -> la nostra squadra ha la palla
 714+ 864C 7A               ld   a,d                 ; team che ha la palla
 715+ 864D B8               cp   b                   ; confronta con TEAM_ORIG
 716+ 864E 20 09            jr   nz, .enemy_has_ball
 717+ 8650
 718+ 8650                  ; === noi abbiamo la palla ===
 719+ 8650                  ; E = ownerID
 720+ 8650                  ;ld   b,c                 ; B = TEAM_ORIG
 721+ 8650 4B               ld   c,e                 ; C = ID portatore
 722+ 8651
 723+ 8651                  ; portiere
 724+ 8651                  ;;call AiUpdateGoalkeeper
 725+ 8651                  ; decisione portatore (muoversi / tirare / ecc.)
 726+ 8651 CD B4 87         call AiBallCarrierDecision
 727+ 8654                  ; opzionale: piccoli aggiustamenti verticali anche dei non portatori
 728+ 8654 CD F5 87         call AiVerticalAdjustments
 729+ 8657 18 08            jr   .done
 730+ 8659
 731+ 8659              .enemy_has_ball:
 732+ 8659                  ; === l'altra squadra ha la palla ===
 733+ 8659                  ;ld   b,c                 ; B = TEAM_ORIG
 734+ 8659                  ;;call AiUpdateGoalkeeper
 735+ 8659 CD B5 86         call AiMoveChaserTowardBall
 736+ 865C CD F5 87         call AiVerticalAdjustments
 737+ 865F 18 00            jr   .done
 738+ 8661
 739+ 8661              .done:
 740+ 8661 E1               pop  hl
 741+ 8662 D1               pop  de
 742+ 8663 C1               pop  bc
 743+ 8664 F1               pop  af
 744+ 8665 C9               ret
 745+ 8666
 746+ 8666
 747+ 8666              ; ---------------------------------------------------------------------------
 748+ 8666              ; AiUpdateGoalkeeper
 749+ 8666              ;
 750+ 8666              ; INPUT:
 751+ 8666              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 752+ 8666              ;
 753+ 8666              ; Logica:
 754+ 8666              ;   - legge posizione palla
 755+ 8666              ;   - targetX:
 756+ 8666              ;       if 1..3 -> ballX
 757+ 8666              ;       else    -> 2
 758+ 8666              ;   - trova portiere (ID=0) con Game_GetPlayerInfoById
 759+ 8666              ;   - con una certa probabilità (dipendente da Var_Game_PlayersSpeed)
 760+ 8666              ;     prova a muovere il portiere orizzontalmente verso targetX.
 761+ 8666              ; ---------------------------------------------------------------------------
 762+ 8666              AiUpdateGoalkeeper:
 763+ 8666 F5               push af
 764+ 8667 C5               push bc
 765+ 8668 D5               push de
 766+ 8669 E5               push hl
 767+ 866A
 768+ 866A                  ; salvati il team
 769+ 866A 48               ld   c,b                 ; C = TEAM
 770+ 866B
 771+ 866B                  ; posizione palla
 772+ 866B CD 92 95         call Game_GetBallPosition ; HL = X,Y  (H=Y, L=X)
 773+ 866E D5               PUSH DE
 774+ 866F E1               POP  HL
 775+ 8670
 776+ 8670                  ; targetX = (1..3 ? ballX : 2)
 777+ 8670 FE 01            cp   1
 778+ 8672 38 07            jr   c,.use_center
 779+ 8674 FE 04            cp   4
 780+ 8676 30 03            jr   nc,.use_center
 781+ 8678 53               ld   d,e                 ; D = targetX = ballX
 782+ 8679 18 02            jr   .got_target
 783+ 867B
 784+ 867B              .use_center:
 785+ 867B 16 02            ld   d,2                 ; targetX = 2
 786+ 867D
 787+ 867D              .got_target:
 788+ 867D                  ; prendi posizione portiere (ID=0)
 789+ 867D 41               ld   b,c                 ; B = TEAM
 790+ 867E 0E 00            ld   c,0                 ; ID = 0
 791+ 8680 CD 59 96         call Game_GetPlayerInfoById
 792+ 8683                  ; HL = curr (H=Y, L=X)
 793+ 8683 7D               ld   a,l                 ; goalieX
 794+ 8684 5F               ld   e,a                 ; E = goalieX
 795+ 8685
 796+ 8685                  ; se già in colonna giusta → niente
 797+ 8685 7B               ld   a,e
 798+ 8686 BA               cp   d
 799+ 8687 28 1F            jr   z,.done
 800+ 8689
 801+ 8689                  ; probabilità di muoversi dipendente da Var_Game_PlayersSpeed
 802+ 8689 C5               push bc
 803+ 868A CD 77 9A         call Game_GetRandomByte
 804+ 868D C1               pop  bc
 805+ 868E E6 0F            and  00001111b           ; 0..15
 806+ 8690 67               ld   h,a
 807+ 8691 3A 2D B2         ld   a,(Var_Game_PlayersSpeed) ; 1..5
 808+ 8694                  ; più alto => più facile che H < soglia
 809+ 8694 C6 03            add  a,3                 ; speed 1..5 -> soglia 4..8
 810+ 8696 BC               cp   h
 811+ 8697 38 0F            jr   c,.done             ; random >= soglia -> non si muove
 812+ 8699
 813+ 8699                  ; decide direzione verso targetX
 814+ 8699 7B               ld   a,e                 ; goalieX
 815+ 869A BA               cp   d                   ; targetX
 816+ 869B 38 02            jr   c,.move_east
 817+ 869D 18 04            jr   .move_west
 818+ 869F
 819+ 869F              .move_east:
 820+ 869F 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
 821+ 86A1 18 02            jr   .do_move
 822+ 86A3
 823+ 86A3              .move_west:
 824+ 86A3 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
 825+ 86A5
 826+ 86A5              .do_move:
 827+ 86A5                  ; A = dir, B = TEAM, C = 0 (portiere)
 828+ 86A5 CD BE 9E         call Game_TryMovePlayerHorizontally
 829+ 86A8                  ; ignoriamo SUCCESS/FAILURE
 830+ 86A8              .done:
 831+ 86A8 E1               pop  hl
 832+ 86A9 D1               pop  de
 833+ 86AA C1               pop  bc
 834+ 86AB F1               pop  af
 835+ 86AC C9               ret
 836+ 86AD              ;---------------------------------------------------------------------------
 837+ 86AD              ; Hooks_InitAICounters
 838+ 86AD              ;---------------------------------------------------------------------------
 839+ 86AD              Hooks_InitAICounters:
 840+ 86AD AF               xor  a
 841+ 86AE 32 76 B2         ld   (Var_Hooks_AiCounterBlack),a
 842+ 86B1 32 8C B2         ld   (Var_Hooks_AiCounterWhite),a
 843+ 86B4 C9               ret
 844+ 86B5              ; ---------------------------------------------------------------------------
 845+ 86B5              ; AiMoveChaserTowardBall
 846+ 86B5              ;
 847+ 86B5              ; INPUT:
 848+ 86B5              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 849+ 86B5              ;
 850+ 86B5              ; Logica:
 851+ 86B5              ;   - calcola ballY/ballX
 852+ 86B5              ;   - riga target per cercare un "chaser":
 853+ 86B5              ;       * TEAM_BLACK:   stessa riga della palla
 854+ 86B5              ;       * TEAM_WHITE:   riga della palla + 1 (se <=4), altrimenti riga palla
 855+ 86B5              ;   - Scorre ID=0..3 e memorizza il giocatore di quella riga più vicino
 856+ 86B5              ;     in X alla palla.
 857+ 86B5              ;   - Con certa probabilità (dipendente da PlayersSpeed) lo muove di
 858+ 86B5              ;     una cella a sinistra/destra verso la palla, usando
 859+ 86B5              ;     Game_TryMovePlayerHorizontally.
 860+ 86B5              ;   - Possibilità di restare fermo: più bassa a velocità alte.
 861+ 86B5              ; ---------------------------------------------------------------------------
 862+ 86B5              AiMoveChaserTowardBall:
 863+ 86B5
 864+ 86B5 F5               push af
 865+ 86B6 C5               push bc
 866+ 86B7 D5               push de
 867+ 86B8 E5               push hl
 868+ 86B9
 869+ 86B9 C5               push bc
 870+ 86BA CD 9F 9A         CALL Game_GetPlayerIdWithBall
 871+ 86BD C1               pop  bc
 872+ 86BE FE 65            CP   BALL_STATUS_CONTENDED
 873+ 86C0 20 12            JR   NZ,.no_contended_ball
 874+ 86C2
 875+ 86C2 C5               push    bc
 876+ 86C3
 877+ 86C3 CD 92 95         CALL    Game_GetBallPosition
 878+ 86C6 C1               pop     bc
 879+ 86C7 62               ld      h, d
 880+ 86C8 78               ld      a, b
 881+ 86C9 FE 01            cp      TEAM_WHITE
 882+ 86CB 20 01            jr      NZ,.contended_team_found
 883+ 86CD 24               inc     h
 884+ 86CE              .contended_team_found:
 885+ 86CE 54               ld     d, h
 886+ 86CF CD 74 96         CALL   Game_GetPlayerInfoByPos
 887+ 86D2 18 4A            JR     .after_player_to_move_found
 888+ 86D4
 889+ 86D4
 890+ 86D4
 891+ 86D4              .no_contended_ball:
 892+ 86D4 48               ld   c,b                 ; C = TEAM
 893+ 86D5
 894+ 86D5                  ; ball pos
 895+ 86D5 CD 92 95         call Game_GetBallPosition    ; HL = X,Y
 896+ 86D8 D5               PUSH DE
 897+ 86D9 E1               POP  HL
 898+ 86DA
 899+ 86DA                  ; riga su cui cercare chaser
 900+ 86DA 79               ld   a,c                 ; TEAM
 901+ 86DB FE 01            cp   TEAM_WHITE
 902+ 86DD 20 0A            jr   nz,.use_same_row
 903+ 86DF
 904+ 86DF                  ; TEAM_WHITE: riga ballY+1 se <=4, altrimenti ballY
 905+ 86DF 7A               ld   a,d
 906+ 86E0 3C               inc  a
 907+ 86E1 FE 05            cp   5
 908+ 86E3 38 01            jr   c,.set_target_row
 909+ 86E5 7A               ld   a,d
 910+ 86E6              .set_target_row:
 911+ 86E6 57               ld   d,a                 ; D = targetRow
 912+ 86E7 18 00            jr   .got_target_row
 913+ 86E9
 914+ 86E9              .use_same_row:
 915+ 86E9                  ; TEAM_BLACK: stessa riga palla
 916+ 86E9                  ; D è già ballY
 917+ 86E9              .got_target_row:
 918+ 86E9
 919+ 86E9
 920+ 86E9
 921+ 86E9
 922+ 86E9                  ; cerca il giocatore più vicino in X a ballX sulla riga D
 923+ 86E9 41               ld   b,c                 ; B = TEAM
 924+ 86EA 0E 00            ld   c,0                 ; ID = 0
 925+ 86EC 3E FF            ld   a,255               ; bestID = 255 (none)
 926+ 86EE 32 81 B2         ld   (Var_Hooks_BestDistanceX),a
 927+ 86F1 32 80 B2         ld   (Var_Hooks_BestDistanceId),a
 928+ 86F4
 929+ 86F4
 930+ 86F4              .chaser_loop:
 931+ 86F4
 932+ 86F4 C5               push bc
 933+ 86F5 D5               push de
 934+ 86F6 CD 59 96         call Game_GetPlayerInfoById   ; HL = pos (H=Y, L=X)
 935+ 86F9 D1               pop  de
 936+ 86FA C1               pop  bc
 937+ 86FB
 938+ 86FB 7C               ld   a,h                 ; currY
 939+ 86FC BA               cp   d
 940+ 86FD 20 11            jr   nz,.next_id         ; non su riga target
 941+ 86FF
 942+ 86FF                  ; su riga target, calcola |X - ballX|
 943+ 86FF 7D               ld   a,l                 ; currX
 944+ 8700 93               sub  e                   ; X - ballX
 945+ 8701 F2 06 87         jp   p,.dist_ok
 946+ 8704 ED 44            neg
 947+ 8706              .dist_ok:
 948+ 8706                  ; A = distanza
 949+ 8706 BD               cp   l                   ; confronta con bestDist (L)
 950+ 8707 30 07            jr   nc,.next_id         ; se >= bestDist, tieni quello vecchio
 951+ 8709
 952+ 8709                  ; nuovo migliore
 953+ 8709 32 81 B2         ld   (Var_Hooks_BestDistanceX),a                 ; bestDist = A
 954+ 870C 79               ld   a,c
 955+ 870D 32 80 B2         ld   (Var_Hooks_BestDistanceId),a                 ; bestID = C
 956+ 8710
 957+ 8710              .next_id:
 958+ 8710 0C               inc  c
 959+ 8711 79               ld   a,c
 960+ 8712 FE 04            cp   4
 961+ 8714 20 DE            jr   nz,.chaser_loop
 962+ 8716
 963+ 8716                  ; se bestID=255 -> nessun giocatore su quella riga
 964+ 8716 3A 80 B2         ld   a,(Var_Hooks_BestDistanceId)
 965+ 8719 FE FF            cp   255
 966+ 871B C2 50 87         jp   nz,.good_player_found
 967+ 871E
 968+ 871E              .after_player_to_move_found:
 969+ 871E 3E 01            ld    a, 1
 970+ 8720 32 80 B2         ld    (Var_Hooks_BestDistanceId), a
 971+ 8723 0E 01            ld    c, 1
 972+ 8725 D5               push  de
 973+ 8726 C5               push  bc
 974+ 8727 CD 59 96         CALL  Game_GetPlayerInfoById
 975+ 872A C1               pop   bc
 976+ 872B D1               pop   de
 977+ 872C 7C               ld    a, h
 978+ 872D BA               cp    d
 979+ 872E 28 20            JR    z, .good_player_found
 980+ 8730
 981+ 8730 3E 02            ld    a, 2
 982+ 8732 32 80 B2         ld    (Var_Hooks_BestDistanceId), a
 983+ 8735 0E 02            ld    c, 2
 984+ 8737 D5               push  de
 985+ 8738 C5               push  bc
 986+ 8739 CD 59 96         CALL  Game_GetPlayerInfoById
 987+ 873C C1               pop   bc
 988+ 873D D1               pop   de
 989+ 873E 7C               ld    a, h
 990+ 873F BA               cp    d
 991+ 8740 28 0E            JR    z, .good_player_found
 992+ 8742
 993+ 8742 3E 03            ld    a, 3
 994+ 8744 32 80 B2         ld    (Var_Hooks_BestDistanceId), a
 995+ 8747 0E 03            ld    c, 3
 996+ 8749 D5               push  de
 997+ 874A C5               push  bc
 998+ 874B CD 59 96         CALL  Game_GetPlayerInfoById
 999+ 874E C1               pop   bc
1000+ 874F D1               pop   de
1001+ 8750
1002+ 8750
1003+ 8750              .good_player_found:
1004+ 8750                  ; --- decidi se muoverlo o lasciarlo fermo ---
1005+ 8750                  ; probabilità di muoversi ~ PlayersSpeed / 5
1006+ 8750 CD 77 9A         call Game_GetRandomByte
1007+ 8753 E6 07            and  00000111b           ; 0..7
1008+ 8755 57               ld   d,a                 ; rand
1009+ 8756
1010+ 8756 3A 2D B2         ld   a,(Var_Game_PlayersSpeed)
1011+ 8759                  ; speed 1..5 -> soglia 1..5
1012+ 8759 BA               cp   d
1013+ 875A 38 53            jr   c,.done             ; rand > speed -> non si muove (resta fermo)
1014+ 875C
1015+ 875C E5               push    hl
1016+ 875D C5               push    bc
1017+ 875E CD 9F 9A         CALL    Game_GetPlayerIdWithBall
1018+ 8761 C1               pop     bc
1019+ 8762 E1               pop     hl
1020+ 8763 FE 65            CP      BALL_STATUS_CONTENDED
1021+ 8765 20 0E            JR      NZ,.after_ball_contended_check
1022+ 8767
1023+ 8767 CD 92 95         CALL    Game_GetBallPosition
1024+ 876A 78               LD      A, B
1025+ 876B FE 01            CP      TEAM_WHITE
1026+ 876D 20 01            JR      NZ, .contended_get_player
1027+ 876F
1028+ 876F 14               INC     D
1029+ 8770
1030+ 8770                  ;JR      .done
1031+ 8770              .contended_get_player:
1032+ 8770                  ;push    bc
1033+ 8770 CD 74 96         call    Game_GetPlayerInfoByPos
1034+ 8773                  ;pop     bc
1035+ 8773 18 09            jr      .move_chaser
1036+ 8775
1037+ 8775
1038+ 8775              .after_ball_contended_check:
1039+ 8775                  ; --- NUCLEO PULITO PER LA PARTE FINALE ---
1040+ 8775                  ; B = TEAM (non toccato), H = bestID, E = ballX
1041+ 8775 3A 80 B2         ld   a, (Var_Hooks_BestDistanceId)
1042+ 8778 4F               ld   c,a                 ; C = bestID
1043+ 8779 C5               push bc
1044+ 877A CD 59 96         call Game_GetPlayerInfoById   ; HL = curr pos
1045+ 877D C1               pop  bc                  ; B=TEAM, C=bestID
1046+ 877E              .move_chaser:
1047+ 877E E5               push hl
1048+ 877F CD 92 95         CALL Game_GetBallPosition
1049+ 8782 E1               pop hl
1050+ 8783 7D               ld   a,l                 ; currX
1051+ 8784 BB               cp   e
1052+ 8785 28 0C            jr   z,.chaser_same_col
1053+ 8787 38 02            jr   c,.chaser_go_east   ; currX < ballX
1054+ 8789 18 04            jr   .chaser_go_west     ; currX > ballX
1055+ 878B
1056+ 878B              .chaser_go_east:
1057+ 878B 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1058+ 878D 18 17            jr   .chaser_do_move
1059+ 878F
1060+ 878F              .chaser_go_west:
1061+ 878F 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1062+ 8791 18 13            jr   .chaser_do_move
1063+ 8793
1064+ 8793              .chaser_same_col:
1065+ 8793                  ; stessa colonna → 50% move left/right, 50% restare fermo
1066+ 8793 C5               push bc
1067+ 8794 CD 7D 9A         call Game_GetRandom0_4
1068+ 8797 C1               pop  bc
1069+ 8798 FE 00            cp  0
1070+ 879A 28 13            jr  z,.done              ; 1/4 → fermo
1071+ 879C
1072+ 879C                  ;ld   a,l
1073+ 879C                  ;cp   0
1074+ 879C                  ;jr   z,.chaser_go_east
1075+ 879C                  ;cp   4
1076+ 879C                  ;jr   z,.chaser_go_west
1077+ 879C              ;
1078+ 879C                  ;push bc
1079+ 879C                  ;call Game_GetRandom0_4
1080+ 879C                  ;pop  bc
1081+ 879C                  ;cp  0
1082+ 879C                  ;jr  z,.chaser_go_west
1083+ 879C FE 01            cp  1
1084+ 879E 28 EF            jr  z,.chaser_go_west
1085+ 87A0 FE 03            cp  3
1086+ 87A2 28 EB            jr  z,.chaser_go_west
1087+ 87A4 18 E5            jr  .chaser_go_east
1088+ 87A6
1089+ 87A6              .chaser_do_move:
1090+ 87A6 CD 58 81         CALL Hooks_TickStop
1091+ 87A9 CD BE 9E         call Game_TryMovePlayerHorizontally
1092+ 87AC CD 50 81         CALL Hooks_TickStart
1093+ 87AF                  ; ignoriamo SUCCESS/FAILURE
1094+ 87AF
1095+ 87AF              .done:
1096+ 87AF E1               pop  hl
1097+ 87B0 D1               pop  de
1098+ 87B1 C1               pop  bc
1099+ 87B2 F1               pop  af
1100+ 87B3 C9               ret
1101+ 87B4
1102+ 87B4              ; ---------------------------------------------------------------------------
1103+ 87B4              ; AiBallCarrierDecision
1104+ 87B4              ;
1105+ 87B4              ; INPUT:
1106+ 87B4              ;   B = TEAM
1107+ 87B4              ;   C = ID del portatore
1108+ 87B4              ; ---------------------------------------------------------------------------
1109+ 87B4              AiBallCarrierDecision:
1110+ 87B4 F5               push af
1111+ 87B5 C5               push bc
1112+ 87B6 D5               push de
1113+ 87B7 E5               push hl
1114+ 87B8
1115+ 87B8                  ; BC in ingresso: B = TEAM, C = ID del portatore
1116+ 87B8 50               ld   d,b                 ; salva TEAM
1117+ 87B9 59               ld   e,c                 ; salva ID
1118+ 87BA
1119+ 87BA                  ; random 0..7
1120+ 87BA CD 8F 9A         CALL  Game_GetRandom0_20
1121+ 87BD 67               ld    h,a                 ; H = rand 0..7
1122+ 87BE
1123+ 87BE 3A 2D B2         ld   a,(Var_Game_PlayersSpeed)
1124+ 87C1 CB 27            SLA A
1125+ 87C3 CB 27            SLA A
1126+ 87C5                  ; speed alta -> più probabilità di agire
1127+ 87C5 BC               cp   h
1128+ 87C6 38 28            jr   c,.do_nothing       ; rand > speed -> sta fermo
1129+ 87C8
1130+ 87C8                  ; altrimenti sceglie azione:
1131+ 87C8                  ;   0..2  -> tiro
1132+ 87C8                  ;   3..4  -> move east
1133+ 87C8                  ;   5..6  -> move west
1134+ 87C8                  ;   7     -> tentativo verticale
1135+ 87C8 7C               ld   a,h
1136+ 87C9 FE 02            cp   2
1137+ 87CB 38 0A            jr   c,.try_shot
1138+ 87CD FE 05            cp   5
1139+ 87CF 38 0D            jr   c,.move_east
1140+ 87D1 FE 08            cp   8
1141+ 87D3 38 12            jr   c,.move_west
1142+ 87D5 18 19            jr   .done
1143+ 87D7
1144+ 87D7              .try_shot:
1145+ 87D7 42               ld   b,d                 ; ripristina TEAM
1146+ 87D8 4B               ld   c,e                 ; ripristina ID
1147+ 87D9 CD 0F 9D         call Game_TryShot
1148+ 87DC 18 12            jr   .done
1149+ 87DE
1150+ 87DE              .move_east:
1151+ 87DE 42               ld   b,d
1152+ 87DF 4B               ld   c,e
1153+ 87E0 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1154+ 87E2 CD BE 9E         call Game_TryMovePlayerHorizontally
1155+ 87E5 18 09            jr   .done
1156+ 87E7
1157+ 87E7              .move_west:
1158+ 87E7 42               ld   b,d
1159+ 87E8 4B               ld   c,e
1160+ 87E9 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1161+ 87EB CD BE 9E         call Game_TryMovePlayerHorizontally
1162+ 87EE 18 00            jr   .done
1163+ 87F0
1164+ 87F0
1165+ 87F0              .do_nothing:
1166+ 87F0                  ; resta fermo
1167+ 87F0
1168+ 87F0              .done:
1169+ 87F0 E1               pop  hl
1170+ 87F1 D1               pop  de
1171+ 87F2 C1               pop  bc
1172+ 87F3 F1               pop  af
1173+ 87F4 C9               ret
1174+ 87F5
1175+ 87F5
1176+ 87F5              ; ---------------------------------------------------------------------------
1177+ 87F5              ; AiVerticalAdjustments
1178+ 87F5              ;
1179+ 87F5              ; INPUT:
1180+ 87F5              ;   B = TEAM
1181+ 87F5              ; NOTE:
1182+ 87F5              ;   - muove solo giocatori ID 1..3 (mai il portiere)
1183+ 87F5              ;   - non muove il giocatore che ha la palla
1184+ 87F5              ; ---------------------------------------------------------------------------
1185+ 87F5              AiVerticalAdjustments:
1186+ 87F5 F5               push af
1187+ 87F6 C5               push bc
1188+ 87F7 D5               push de
1189+ 87F8 E5               push hl
1190+ 87F9
1191+ 87F9
1192+ 87F9
1193+ 87F9
1194+ 87F9 50               ld   d,b                 ; D = TEAM (salvato)
1195+ 87FA
1196+ 87FA                  ; probabilità di attivare il blocco verticale
1197+ 87FA CD 8F 9A         call Game_GetRandom0_20
1198+ 87FD
1199+ 87FD FE 0F            cp   15
1200+ 87FF 30 33            jr   nc,.done            ; ~12.5% dei tick
1201+ 8801
1202+ 8801              ; --- scegli un ID 1..3 ------------------------------------------------
1203+ 8801              .gen_id:
1204+ 8801 CD 7D 9A         call Game_GetRandom0_4   ; 0..4
1205+ 8804 FE 01            cp   1
1206+ 8806 38 2C            jr   c,.done           ; 0 -> scarta
1207+ 8808 FE 04            cp   4
1208+ 880A 30 28            jr   nc,.done          ; 4 -> scarta (vogliamo 1..3)
1209+ 880C 4F               ld   c,a                 ; C = ID (1..3)
1210+ 880D 59               ld   e,c                 ; E = ID salvato
1211+ 880E
1212+ 880E                  ; --- verifica che NON sia il possessore della palla ---------------
1213+ 880E                  ; (Game_GetPlayerIdWithBall distrugge BC, quindi lo salviamo)
1214+ 880E C5               push bc                  ; salva TEAM (B) e ID (C)
1215+ 880F CD 9F 9A         call Game_GetPlayerIdWithBall
1216+ 8812                  ; A = stato/team, H = ownerID (o 255), L = contendenteID (o 255)
1217+ 8812 C1               pop  bc                  ; ripristina B=TEAM, C=ID scelto (1..3)
1218+ 8813
1219+ 8813                  ; Se A è TEAM_BLACK / TEAM_WHITE e coincide con B,
1220+ 8813                  ; e H == C -> questo giocatore ha la palla => NON muoverlo
1221+ 8813 FE 00            cp   TEAM_BLACK
1222+ 8815 28 06            jr   z,.check_owner
1223+ 8817 FE 01            cp   TEAM_WHITE
1224+ 8819 28 02            jr   z,.check_owner
1225+ 881B 18 07            jr   .no_owner           ; palla libera / contesa / in movimento
1226+ 881D
1227+ 881D              .check_owner:
1228+ 881D B8               cp   b                   ; team col possesso == nostro team?
1229+ 881E 20 04            jr   nz,.no_owner
1230+ 8820 7C               ld   a,h                 ; ownerID
1231+ 8821 B9               cp   c                   ; è proprio il nostro giocatore?
1232+ 8822 28 10            jr   z,.done             ; sì -> non muovere verticalmente
1233+ 8824
1234+ 8824              .no_owner:
1235+ 8824                  ; --- scegli direzione N/S (random) ------------------------------
1236+ 8824
1237+ 8824
1238+ 8824 CD 7D 9A         call Game_GetRandom0_4
1239+ 8827
1240+ 8827
1241+ 8827
1242+ 8827 FE 01            CP   1
1243+ 8829 28 0E            JR   z,.move_down
1244+ 882B FE 03            CP   3
1245+ 882D 30 0A            JR   nc,.move_down
1246+ 882F 3E 03            ld   a,PLAYER_ASKED_DIRECTION_NORTH
1247+ 8831
1248+ 8831              .do_move:
1249+ 8831 CD 25 9B         call Game_TryMovePlayerVertically
1250+ 8834
1251+ 8834              .done:
1252+ 8834 E1               pop  hl
1253+ 8835 D1               pop  de
1254+ 8836 C1               pop  bc
1255+ 8837 F1               pop  af
1256+ 8838 C9               ret
1257+ 8839              .move_down:
1258+ 8839 3E 04            ld   a,PLAYER_ASKED_DIRECTION_SOUTH
1259+ 883B 18 F4            jr   .do_move
1260+ 883D
1261+ 883D
1262+ 883D              ; ---------------------------------------------------------------------------
1263+ 883D              ; Game_Ai_MoveHoriz_AwayOrRandom
1264+ 883D              ;
1265+ 883D              ; INPUT:
1266+ 883D              ;   B = TEAM
1267+ 883D              ;   C = ID del giocatore coinvolto nella contesa
1268+ 883D              ;
1269+ 883D              ; Effetto:
1270+ 883D              ;   - Legge posizione di questo giocatore e quella dell'altro (se vuoi
1271+ 883D              ;     puoi passare anche l'altro X in un registro).
1272+ 883D              ;   - Per semplicità:
1273+ 883D              ;       * se X=0 -> prova solo EAST
1274+ 883D              ;       * se X=4 -> prova solo WEST
1275+ 883D              ;       * se X=1 e a sinistra c'è compagno -> forza EAST
1276+ 883D              ;       * se X=3 e a destra   c'è compagno -> forza WEST
1277+ 883D              ;       * altrimenti dir random LEFT/RIGHT.
1278+ 883D              ;   - Chiama Game_TryMovePlayerHorizontally
1279+ 883D              ; ---------------------------------------------------------------------------
1280+ 883D              Game_Ai_MoveHoriz_AwayOrRandom:
1281+ 883D F5               push af
1282+ 883E C5               push bc
1283+ 883F D5               push de
1284+ 8840 E5               push hl
1285+ 8841
1286+ 8841                  ; prendi posizione corrente
1287+ 8841 CD 59 96         call Game_GetPlayerInfoById      ; HL = pos (H=Y, L=X)
1288+ 8844 54               ld   d,h                         ; D = Y
1289+ 8845 5D               ld   e,l                         ; E = X
1290+ 8846
1291+ 8846                  ; bordi assoluti
1292+ 8846 7B               ld   a,e
1293+ 8847 FE 00            cp   0
1294+ 8849 28 33            jr   z,.force_east
1295+ 884B FE 04            cp   4
1296+ 884D 28 33            jr   z,.force_west
1297+ 884F
1298+ 884F                  ; colonne 1 o 3 con compagno accanto?
1299+ 884F                  ;  - se X=1 e a sinistra (0) c'è un compagno → forza east
1300+ 884F                  ;  - se X=3 e a destra  (4) c'è un compagno → forza west
1301+ 884F
1302+ 884F FE 01            cp   1
1303+ 8851 20 0E            jr   nz,.check_x3
1304+ 8853                  ; X=1: controlla (Y,0)
1305+ 8853 C5               push bc
1306+ 8854 54               ld   d,h          ; Y
1307+ 8855 1E 00            ld   e,0
1308+ 8857 CD 74 96         call Game_GetPlayerInfoByPos
1309+ 885A C1               pop  bc
1310+ 885B FE FF            cp   NO_VALUE
1311+ 885D 20 1F            jr   nz,.force_east   ; qualcuno lì → forza east
1312+ 885F 18 10            jr   .rand_dir
1313+ 8861
1314+ 8861              .check_x3:
1315+ 8861 FE 03            cp   3
1316+ 8863 20 0C            jr   nz,.rand_dir
1317+ 8865                  ; X=3: controlla (Y,4)
1318+ 8865 C5               push bc
1319+ 8866 54               ld   d,h
1320+ 8867 1E 04            ld   e,4
1321+ 8869 CD 74 96         call Game_GetPlayerInfoByPos
1322+ 886C C1               pop  bc
1323+ 886D FE FF            cp   NO_VALUE
1324+ 886F 20 11            jr   nz,.force_west
1325+ 8871
1326+ 8871              .rand_dir:
1327+ 8871                  ; direzione random
1328+ 8871 CD 77 9A         call Game_GetRandomByte
1329+ 8874 E6 01            and 00000001b
1330+ 8876 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1331+ 8878 28 0A            jr   z,.do_move
1332+ 887A 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1333+ 887C 18 06            jr   .do_move
1334+ 887E
1335+ 887E              .force_east:
1336+ 887E 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1337+ 8880 18 02            jr   .do_move
1338+ 8882
1339+ 8882              .force_west:
1340+ 8882 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1341+ 8884
1342+ 8884              .do_move:
1343+ 8884 CD BE 9E         call Game_TryMovePlayerHorizontally
1344+ 8887
1345+ 8887 E1               pop  hl
1346+ 8888 D1               pop  de
1347+ 8889 C1               pop  bc
1348+ 888A F1               pop  af
1349+ 888B C9               ret
1350+ 888C              ;---------------------------------------------------------------------------
1351+ 888C              ; Hooks_UpdateTimeToPlay
1352+ 888C              ;---------------------------------------------------------------------------
1353+ 888C              Hooks_UpdateTimeToPlay:
1354+ 888C 3A 24 B2         LD      A, (Var_Game_TimeToPlay)
1355+ 888F 32 08 B2         LD      (Var_Game_SecondsToPlay), A
1356+ 8892 C9               RET
1357+ 8893
# file closed: ./inc/hooks.asm
  15  8893                  INCLUDE "vdp.asm"                       ; Include screen library
# file opened: ./inc/vdp.asm
   1+ 8893              ; ===================================================================
   2+ 8893              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8893              ; ===================================================================
   4+ 8893
   5+ 8893              ; *** SCREEN.ASM (sjasm-normalized, buffered & fast VRAM I/O) ***
   6+ 8893
   7+ 8893
   8+ 8893              ;------------------------------------------------------------------------
   9+ 8893              ; Print string
  10+ 8893              ; INPUT:  HL = pointer to null-terminated string
  11+ 8893              ;         D,E = character position (Y,X)
  12+ 8893              ;------------------------------------------------------------------------
  13+ 8893              VDP_PrintString:
  14+ 8893 7E               ld      a,(hl)
  15+ 8894 B7               or      a
  16+ 8895 C8               ret     z
  17+ 8896 F5               push    af
  18+ 8897 CD D2 88         call    VDP_PrintRomChar
  19+ 889A F1               pop     af
  20+ 889B 1C               inc     e
  21+ 889C 23               inc     hl
  22+ 889D 18 F4            jr      VDP_PrintString
  23+ 889F
  24+ 889F
  25+ 889F              ;------------------------------------------------------------------------
  26+ 889F              ; Print a single RAM character out to a screen address
  27+ 889F              ; INPUT:
  28+ 889F              ;   A: Character to print
  29+ 889F              ;   D: Character Y position
  30+ 889F              ;   E: Character X position
  31+ 889F              ; OUTPUT: -
  32+ 889F              ; MODIFIES: -
  33+ 889F              ;------------------------------------------------------------------------
  34+ 889F              VDP_PrintRamChar:
  35+ 889F D5                   PUSH    DE
  36+ 88A0 F5                   PUSH    AF
  37+ 88A1 FE 40                CP      TILE_BALL_BOTTOM
  38+ 88A3 DA AB 88             JP      C, .AfterColorCheck
  39+ 88A6 3E 20                LD      A, GREEN_CHAR_ATTRIBUTE
  40+ 88A8 CD 83 8B             CALL    VDP_SetCharAttribute
  41+ 88AB              .AfterColorCheck:
  42+ 88AB F1                   POP     AF
  43+ 88AC D1                   POP     DE
  44+ 88AD
  45+ 88AD
  46+ 88AD
  47+ 88AD
  48+ 88AD
  49+ 88AD D5                   PUSH    DE
  50+ 88AE D9                   EXX                                 ; Backup registers BC, DE, HL
  51+ 88AF D1                   POP     DE
  52+ 88B0 F5                   PUSH    AF
  53+ 88B1 21 00 B5             LD      HL, RAM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
  54+ 88B4 06 00                LD      B,0                         ; BC = character code
  55+ 88B6 4F                   LD      C, A
  56+ 88B7 CB 21                SLA     C                           ; Multiply by 8 by shifting
  57+ 88B9 CB 10                RL      B
  58+ 88BB CB 21                SLA     C
  59+ 88BD CB 10                RL      B
  60+ 88BF CB 21                SLA     C
  61+ 88C1 CB 10                RL      B
  62+ 88C3 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
  63+ 88C4 CD F9 88             CALL    GetCharAddress              ; Get screen position in DE
  64+ 88C7 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
  65+ 88C9              .PrintRamCharL1:
  66+ 88C9 7E                   LD      A,(HL)                      ; Get the byte from the ROM into A
  67+ 88CA 12                   LD      (DE),A                      ; Stick A onto the screen
  68+ 88CB 23                   INC     HL                          ; Goto next byte of character
  69+ 88CC 14                   INC     D                           ; Goto next line on screen
  70+ 88CD 10 FA                DJNZ    .PrintRamCharL1              ; Loop around whilst it is Not Zero (NZ)
  71+ 88CF D9                   EXX                                 ; Restore registers BC, DE, HL
  72+ 88D0 F1                   POP     AF
  73+ 88D1 C9                   RET
  74+ 88D2              ;------------------------------------------------------------------------
  75+ 88D2              ; Print a single ROM character out to a screen address
  76+ 88D2              ; INPUT:
  77+ 88D2              ;   A: Character to print
  78+ 88D2              ;   D: Character Y position
  79+ 88D2              ;   E: Character X position
  80+ 88D2              ; OUTPUT: -
  81+ 88D2              ; MODIFIES: -
  82+ 88D2              ;------------------------------------------------------------------------
  83+ 88D2              VDP_PrintRomChar:
  84+ 88D2 D5                   PUSH    DE
  85+ 88D3 D9                   EXX                                 ; Backup registers BC, DE, HL
  86+ 88D4 D1                   POP     DE
  87+ 88D5 F5                   PUSH    AF
  88+ 88D6 21 00 3D             LD      HL, ROM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
  89+ 88D9 06 00                LD      B,0                         ; BC = character code
  90+ 88DB D6 20                SUB     32                          ; Adjust for the character set
  91+ 88DD 4F                   LD      C, A
  92+ 88DE CB 21                SLA     C                           ; Multiply by 8 by shifting
  93+ 88E0 CB 10                RL      B
  94+ 88E2 CB 21                SLA     C
  95+ 88E4 CB 10                RL      B
  96+ 88E6 CB 21                SLA     C
  97+ 88E8 CB 10                RL      B
  98+ 88EA 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
  99+ 88EB CD F9 88             CALL    GetCharAddress              ; Get screen position in DE
 100+ 88EE 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
 101+ 88F0              .PrintRomCharL1:
 102+ 88F0 7E                   LD      A,(HL)                      ; Get the byte from the ROM into A
 103+ 88F1 12                   LD      (DE),A                      ; Stick A onto the screen
 104+ 88F2 23                   INC     HL                          ; Goto next byte of character
 105+ 88F3 14                   INC     D                           ; Goto next line on screen
 106+ 88F4 10 FA                DJNZ    .PrintRomCharL1              ; Loop around whilst it is Not Zero (NZ)
 107+ 88F6 D9                   EXX                                 ; Restore registers BC, DE, HL
 108+ 88F7 F1                   POP     AF
 109+ 88F8 C9                   RET
 110+ 88F9
 111+ 88F9              ;------------------------------------------------------------------------
 112+ 88F9              ; Get screen address from a character (X,Y) coordinate
 113+ 88F9              ; INPUT:
 114+ 88F9              ;   D: Y character position (0-23)
 115+ 88F9              ;   E: X character position (0-31)
 116+ 88F9              ; OUTPUT:
 117+ 88F9              ;   DE: screen address
 118+ 88F9              ; MODIFIES: A
 119+ 88F9              ;------------------------------------------------------------------------
 120+ 88F9              GetCharAddress:
 121+ 88F9 7A                   LD      A,D
 122+ 88FA E6 07                AND     %00000111
 123+ 88FC 1F                   RRA
 124+ 88FD 1F                   RRA
 125+ 88FE 1F                   RRA
 126+ 88FF 1F                   RRA
 127+ 8900 B3                   OR      E
 128+ 8901 5F                   LD      E,A
 129+ 8902 7A                   LD      A,D
 130+ 8903 E6 18                AND     %00011000
 131+ 8905 F6 40                OR      %01000000
 132+ 8907 57                   LD      D,A
 133+ 8908 C9                   RET
 134+ 8909
 135+ 8909              ;------------------------------------------------------------------------
 136+ 8909              ; Load tiles from ROM to VRAM
 137+ 8909              ;------------------------------------------------------------------------
 138+ 8909              VDP_LoadTiles:
 139+ 8909 F3               DI                      ; Interrupts disabled
 140+ 890A 11 00 B5         LD      DE, RAM_CHAR_SET_ADDRESS
 141+ 890D 21 F7 AA         LD      HL, TILES
 142+ 8910 01 00 07         LD      BC, 1792
 143+ 8913 ED B0            LDIR
 144+ 8915                  ;EI                      ; Interrupts enabled
 145+ 8915 C9               RET
 146+ 8916              ;------------------------------------------------------------------------
 147+ 8916              ; Clear screen (INVARIATA)
 148+ 8916              ;------------------------------------------------------------------------
 149+ 8916              VDP_ClearScreen:
 150+ 8916 3E 00            LD   A, 0           ; 0 in the lower 3 bits = black
 151+ 8918 D3 FE            OUT  (254), A       ; Send A to port 0xFE
 152+ 891A
 153+ 891A                  ;----------------------------------------------------------
 154+ 891A                  ; Clear 6144 bytes of screen pixel area (0x4000..0x57FF)
 155+ 891A                  ;----------------------------------------------------------
 156+ 891A
 157+ 891A 21 00 40         LD   HL, 0x4000      ; Start address of pixel area
 158+ 891D 11 01 40         LD   DE, 0x4001      ; DE = HL + 1 for LDIR
 159+ 8920 01 00 18         LD   BC, 6144        ; Number of bytes to clear
 160+ 8923 36 00            LD   (HL), 0         ; Store 0 in the first byte
 161+ 8925 ED B0            LDIR                 ; Repeats until BC = 0 (fills with 0)
 162+ 8927
 163+ 8927                  ;----------------------------------------------------------
 164+ 8927                  ; Fill 768 bytes of attributes area (0x5800..0x5AFF)
 165+ 8927                  ; with 0x07 (white on black)
 166+ 8927                  ;----------------------------------------------------------
 167+ 8927
 168+ 8927 21 00 58         LD   HL, 0x5800      ; Start address of attributes area
 169+ 892A 11 01 58         LD   DE, 0x5801      ; DE = HL + 1 for LDIR
 170+ 892D 01 00 03         LD   BC, 768         ; Number of attribute bytes
 171+ 8930 36 07            LD   (HL), 0x07      ; Attribute = 0x07 (white on black)
 172+ 8932 ED B0            LDIR                 ; Fill the attribute area with 0x07
 173+ 8934
 174+ 8934 C9               RET
 175+ 8935
 176+ 8935
 177+ 8935
 178+ 8935
 179+ 8935
 180+ 8935
 181+ 8935              ; -----------------------------------------------------------
 182+ 8935              ; Draw sprite (32x32 tile)
 183+ 8935              ; INPUT: D = row (Y), E = col (X), A = tile index
 184+ 8935              ; -----------------------------------------------------------
 185+ 8935              VDP_DrawSprite:
 186+ 8935 F5               PUSH    AF
 187+ 8936 7A               ld      a,d
 188+ 8937 87               add     a,a          ; *2
 189+ 8938 87               add     a,a          ; *4
 190+ 8939 57               ld      d,a
 191+ 893A
 192+ 893A 7B               ld      a,e
 193+ 893B 87               add     a,a          ; *2
 194+ 893C 87               add     a,a          ; *4
 195+ 893D 5F               ld      e,a
 196+ 893E 1C               inc     e
 197+ 893F 14               inc     d
 198+ 8940 3A 07 B2         ld      a, (Var_Game_ActiveFieldSide)
 199+ 8943 FE 01            CP      FIELD_NORTH_SIDE
 200+ 8945 CA 4A 89         JP      Z, .NorthSideAdjust
 201+ 8948 14               inc     d
 202+ 8949 14               inc     d
 203+ 894A              .NorthSideAdjust:
 204+ 894A F1               POP     AF
 205+ 894B 4F               ld      c,a
 206+ 894C FE 04            cp      TILE_CORNER_BALL_EMPTY
 207+ 894E 28 10            jr      z,.CornerBallArea
 208+ 8950 FE 00            cp      TILE_CORNER
 209+ 8952 28 0C            jr      z,.CornerBallArea
 210+ 8954 FE 06            cp      TILE_BALL_TOP
 211+ 8956 28 6D            jr      z,.TopBall
 212+ 8958 FE 07            cp      TILE_BALL_TOP_FRONT
 213+ 895A 28 79            jr      z,.TopBallFront
 214+ 895C FE 03            cp      TILE_CORNER_BALL
 215+ 895E 20 23            jr      nz,.TileField
 216+ 8960
 217+ 8960              .CornerBallArea:
 218+ 8960 7A               ld      a,d
 219+ 8961 FE 01            cp      1
 220+ 8963 20 04            jr      nz,.CornerBallEmptyBottom
 221+ 8965 16 02            ld      d,2
 222+ 8967 18 02            jr      .CornerBallEmptySide
 223+ 8969              .CornerBallEmptyBottom:
 224+ 8969 16 15            ld      d,21
 225+ 896B              .CornerBallEmptySide:
 226+ 896B 1C               inc     e
 227+ 896C 79               ld      a,c
 228+ 896D FE 04            cp      TILE_CORNER_BALL_EMPTY
 229+ 896F 28 06            jr      z,.CornerBallEmptyTile
 230+ 8971 FE 00            cp      TILE_CORNER
 231+ 8973 28 02            jr      z,.CornerBallEmptyTile
 232+ 8975 18 0C            jr      .TileField
 233+ 8977              .CornerBallEmptyTile:
 234+ 8977 3E 6F            ld      a,111
 235+ 8979 CD 9F 88         call    VDP_PrintRamChar
 236+ 897C 1C               inc     e
 237+ 897D 3E 6F            ld      a,111
 238+ 897F CD 9F 88         call    VDP_PrintRamChar
 239+ 8982 C9               ret
 240+ 8983              .TileField:
 241+ 8983 FE D6            cp      TILE_FIELD
 242+ 8985 C2 B5 89         jp      nz,.CornerBall
 243+ 8988
 244+ 8988 D5               push    de
 245+ 8989 F5               push    af
 246+ 898A C5               push    bc
 247+ 898B E5               push    hl
 248+ 898C
 249+ 898C 62               ld      h,d
 250+ 898D 6B               ld      l,e
 251+ 898E 42               ld      b,d
 252+ 898F 04               inc     b
 253+ 8990 04               inc     b
 254+ 8991 04               inc     b
 255+ 8992 04               inc     b
 256+ 8993 4B               ld      c,e
 257+ 8994 0C               inc     c
 258+ 8995 0C               inc     c
 259+ 8996 0C               inc     c
 260+ 8997 0C               inc     c
 261+ 8998
 262+ 8998              .EmptyRowLoop:
 263+ 8998 7A               ld      a,d
 264+ 8999 B8               cp      b
 265+ 899A CA B0 89         jp      z,.EmptyExit
 266+ 899D
 267+ 899D 5D               ld      e,l
 268+ 899E              .EmptyColLoop:
 269+ 899E 7B               ld      a,e
 270+ 899F B9               cp      c
 271+ 89A0 CA AC 89         jp      z,.EmptyNextRow
 272+ 89A3
 273+ 89A3 3E D6            ld      a,TILE_FIELD
 274+ 89A5 CD 9F 88         call    VDP_PrintRamChar
 275+ 89A8 1C               inc     e
 276+ 89A9 C3 9E 89         jp      .EmptyColLoop
 277+ 89AC
 278+ 89AC              .EmptyNextRow:
 279+ 89AC 14               inc     d
 280+ 89AD C3 98 89         jp      .EmptyRowLoop
 281+ 89B0
 282+ 89B0              .EmptyExit:
 283+ 89B0 E1               pop     hl
 284+ 89B1 C1               pop     bc
 285+ 89B2 F1               pop     af
 286+ 89B3 D1               pop     de
 287+ 89B4 C9               ret
 288+ 89B5
 289+ 89B5              .CornerBall:
 290+ 89B5 FE 03            cp      TILE_CORNER_BALL
 291+ 89B7 20 2D            jr      nz,.Dispatch
 292+ 89B9 3E 4D            ld      a,77
 293+ 89BB CD 9F 88         call    VDP_PrintRamChar
 294+ 89BE 1C               inc     e
 295+ 89BF 3E 4E            ld      a,78
 296+ 89C1 CD 9F 88         call    VDP_PrintRamChar
 297+ 89C4 C9               ret
 298+ 89C5
 299+ 89C5              .TopBall:
 300+ 89C5 FE 06            cp      TILE_BALL_TOP
 301+ 89C7 20 1D            jr      nz,.Dispatch
 302+ 89C9 3E 4D            ld      a,77
 303+ 89CB CD 9F 88         call    VDP_PrintRamChar
 304+ 89CE 1C               inc     e
 305+ 89CF 3E 4E            ld      a,78
 306+ 89D1 CD 9F 88         call    VDP_PrintRamChar
 307+ 89D4 C9               ret
 308+ 89D5
 309+ 89D5              .TopBallFront:
 310+ 89D5 FE 07            cp      TILE_BALL_TOP_FRONT
 311+ 89D7 20 0D            jr      nz,.Dispatch
 312+ 89D9 1C               inc     e
 313+ 89DA 3E 4D            ld      a,77
 314+ 89DC CD 9F 88         call    VDP_PrintRamChar
 315+ 89DF 1C               inc     e
 316+ 89E0 3E 4E            ld      a,78
 317+ 89E2 CD 9F 88         call    VDP_PrintRamChar
 318+ 89E5 C9               ret
 319+ 89E6
 320+ 89E6              ; ---------- dispatcher ----------
 321+ 89E6              .Dispatch:
 322+ 89E6 FE A0            cp      TILE_WHITE_PLAYER
 323+ 89E8 CA FD 89         jp      z,.MaybeWhiteHalfLine
 324+ 89EB FE 50            cp      TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 325+ 89ED CA FD 89         jp      z,.MaybeWhiteHalfLine
 326+ 89F0 FE 01            cp      TILE_WHITE_PLAYER_WITH_BALL
 327+ 89F2 CA 34 8A         jp      z,.DrawWhiteWithFeetBall
 328+ 89F5 FE 02            cp      TILE_BLACK_PLAYER_WITH_BACK_BALL
 329+ 89F7 CA 87 8A         jp      z,.DrawBlackWithBackBall
 330+ 89FA C3 A0 8A         jp      .BaseDraw
 331+ 89FD
 332+ 89FD              ; ---------- white: “testa nella metà campo” ----------
 333+ 89FD              .MaybeWhiteHalfLine:
 334+ 89FD FE 50            cp      TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 335+ 89FF 28 17            jr      z, .MaybeWhiteHalfLineContinue
 336+ 8A01 3A 07 B2         ld      a, (Var_Game_ActiveFieldSide)
 337+ 8A04 FE 00            CP      FIELD_SOUTH_SIDE
 338+ 8A06 C2 12 8A         JP      NZ, .MaybeWhiteHalfLineNorth
 339+ 8A09 7A               LD      A,D
 340+ 8A0A FE 07            CP      7
 341+ 8A0C C2 2F 8A         JP      NZ, .DrawWhiteBaseNormal
 342+ 8A0F C3 18 8A         JP      .MaybeWhiteHalfLineContinue
 343+ 8A12              .MaybeWhiteHalfLineNorth:
 344+ 8A12 7A               LD      A,D
 345+ 8A13 FE 11            CP      17
 346+ 8A15 C2 2F 8A         JP      NZ, .DrawWhiteBaseNormal
 347+ 8A18              .MaybeWhiteHalfLineContinue:
 348+ 8A18 D5               push    de
 349+ 8A19                  ;ld      d,b
 350+ 8A19 7B               ld      a,e
 351+ 8A1A 3C               inc     a
 352+ 8A1B 5F               ld      e,a
 353+ 8A1C 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
 354+ 8A1E CD 9F 88         call    VDP_PrintRamChar
 355+ 8A21 1C               inc     e
 356+ 8A22 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
 357+ 8A24 CD 9F 88         call    VDP_PrintRamChar
 358+ 8A27 D1               pop     de
 359+ 8A28 14               inc     d
 360+ 8A29 3E 50            ld      a,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 361+ 8A2B C3 A0 8A         jp      .BaseDraw
 362+ 8A2E 15               dec     d
 363+ 8A2F              .DrawWhiteBaseNormal:
 364+ 8A2F 3E A0            ld      a,TILE_WHITE_PLAYER
 365+ 8A31 C3 A0 8A         jp      .BaseDraw
 366+ 8A34
 367+ 8A34              ; ---------- white con palla ai piedi ----------
 368+ 8A34              .DrawWhiteWithFeetBall:
 369+ 8A34 3A 6F B2         ld      a,(Var_Vdp_HalfFieldHorzLinePos)
 370+ 8A37 47               ld      b,a
 371+ 8A38 7A               ld      a,d
 372+ 8A39 3D               dec     a
 373+ 8A3A B8               cp      b
 374+ 8A3B 20 11            jr      nz,.NoHalf
 375+ 8A3D
 376+ 8A3D D5               push    de
 377+ 8A3E 50               ld      d,b
 378+ 8A3F 7B               ld      a,e
 379+ 8A40 3C               inc     a
 380+ 8A41 5F               ld      e,a
 381+ 8A42 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
 382+ 8A44 CD 9F 88         call    VDP_PrintRamChar
 383+ 8A47 1C               inc     e
 384+ 8A48 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
 385+ 8A4A CD 9F 88         call    VDP_PrintRamChar
 386+ 8A4D D1               pop     de
 387+ 8A4E
 388+ 8A4E              .NoHalf:
 389+ 8A4E 79               ld      a,c
 390+ 8A4F FE 01            cp      TILE_WHITE_PLAYER_WITH_BALL
 391+ 8A51 28 1C            jr      z,.Half
 392+ 8A53
 393+ 8A53 3E A0            ld      a,TILE_WHITE_PLAYER
 394+ 8A55 CD A0 8A         call    .BaseDraw
 395+ 8A58
 396+ 8A58 D5               push    de
 397+ 8A59 7A               ld      a,d
 398+ 8A5A C6 03            add     a,3
 399+ 8A5C 57               ld      d,a
 400+ 8A5D 7B               ld      a,e
 401+ 8A5E C6 02            add     a,2
 402+ 8A60 5F               ld      e,a
 403+ 8A61 1D               dec     e
 404+ 8A62 3E DF            ld      a,TILE_WHITE_PLAYER_AND_BALL
 405+ 8A64 CD 9F 88         call    VDP_PrintRamChar
 406+ 8A67 1C               inc     e
 407+ 8A68 3E DC            ld      a,TILE_BALL_FEET_OVERLAY_R
 408+ 8A6A CD 9F 88         call    VDP_PrintRamChar
 409+ 8A6D D1               pop     de
 410+ 8A6E C9               ret
 411+ 8A6F
 412+ 8A6F              .Half:
 413+ 8A6F D5               push    de
 414+ 8A70 7A               ld      a,d
 415+ 8A71 C6 03            add     a,3
 416+ 8A73 57               ld      d,a
 417+ 8A74 7B               ld      a,e
 418+ 8A75 C6 02            add     a,2
 419+ 8A77 5F               ld      e,a
 420+ 8A78 1D               dec     e
 421+ 8A79 3E DF            ld      a,TILE_WHITE_PLAYER_AND_BALL
 422+ 8A7B 15               dec     d
 423+ 8A7C CD 9F 88         call    VDP_PrintRamChar
 424+ 8A7F 1C               inc     e
 425+ 8A80 3E DC            ld      a,TILE_BALL_FEET_OVERLAY_R
 426+ 8A82 CD 9F 88         call    VDP_PrintRamChar
 427+ 8A85 D1               pop     de
 428+ 8A86 C9               ret
 429+ 8A87
 430+ 8A87              ; ---------- nero con palla alle spalle ----------
 431+ 8A87              .DrawBlackWithBackBall:
 432+ 8A87 3E B0            ld      a,TILE_BLACK_PLAYER
 433+ 8A89 CD A0 8A         call    .BaseDraw
 434+ 8A8C
 435+ 8A8C D5               push    de
 436+ 8A8D 7B               ld      a,e
 437+ 8A8E FE 1F            cp      31
 438+ 8A90 CA 9E 8A         jp      z,.WBack_Done
 439+ 8A93 3E DD            ld      a,TILE_BALL_BACK_OVERLAY_L
 440+ 8A95 CD 9F 88         call    VDP_PrintRamChar
 441+ 8A98 1C               inc     e
 442+ 8A99 3E DE            ld      a,TILE_BALL_BACK_OVERLAY_R
 443+ 8A9B CD 9F 88         call    VDP_PrintRamChar
 444+ 8A9E              .WBack_Done:
 445+ 8A9E D1               pop     de
 446+ 8A9F C9               ret
 447+ 8AA0
 448+ 8AA0              ; ---------- routine di base: disegna 4x4 a partire da A ----------
 449+ 8AA0              .BaseDraw:
 450+ 8AA0 D5               push    de
 451+ 8AA1 F5               push    af
 452+ 8AA2
 453+ 8AA2 CD 9F 88         call    VDP_PrintRamChar
 454+ 8AA5 1C               inc     e
 455+ 8AA6 3C               inc     a
 456+ 8AA7 CD 9F 88         call    VDP_PrintRamChar
 457+ 8AAA 1C               inc     e
 458+ 8AAB 3C               inc     a
 459+ 8AAC CD 9F 88         call    VDP_PrintRamChar
 460+ 8AAF 1C               inc     e
 461+ 8AB0 3C               inc     a
 462+ 8AB1 CD 9F 88         call    VDP_PrintRamChar
 463+ 8AB4
 464+ 8AB4 14               inc     d
 465+ 8AB5 1D               dec     e
 466+ 8AB6 1D               dec     e
 467+ 8AB7 1D               dec     e
 468+ 8AB8 3C               inc     a
 469+ 8AB9 CD 9F 88         call    VDP_PrintRamChar
 470+ 8ABC 1C               inc     e
 471+ 8ABD 3C               inc     a
 472+ 8ABE CD 9F 88         call    VDP_PrintRamChar
 473+ 8AC1 1C               inc     e
 474+ 8AC2 3C               inc     a
 475+ 8AC3 CD 9F 88         call    VDP_PrintRamChar
 476+ 8AC6 1C               inc     e
 477+ 8AC7 3C               inc     a
 478+ 8AC8 CD 9F 88         call    VDP_PrintRamChar
 479+ 8ACB
 480+ 8ACB 14               inc     d
 481+ 8ACC 1D               dec     e
 482+ 8ACD 1D               dec     e
 483+ 8ACE 1D               dec     e
 484+ 8ACF 3C               inc     a
 485+ 8AD0 CD 9F 88         call    VDP_PrintRamChar
 486+ 8AD3 1C               inc     e
 487+ 8AD4 3C               inc     a
 488+ 8AD5 CD 9F 88         call    VDP_PrintRamChar
 489+ 8AD8 1C               inc     e
 490+ 8AD9 3C               inc     a
 491+ 8ADA CD 9F 88         call    VDP_PrintRamChar
 492+ 8ADD 1C               inc     e
 493+ 8ADE 3C               inc     a
 494+ 8ADF CD 9F 88         call    VDP_PrintRamChar
 495+ 8AE2 32 70 B2         ld      (Var_VdpTemp), a
 496+ 8AE5 F1               pop     af
 497+ 8AE6 F5               push    af
 498+ 8AE7 FE 50            cp      TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 499+ 8AE9 28 1A            JR      Z, .HalfLineRedraw
 500+ 8AEB 3A 70 B2         ld      a, (Var_VdpTemp)
 501+ 8AEE 14               inc     d
 502+ 8AEF 1D               dec     e
 503+ 8AF0 1D               dec     e
 504+ 8AF1 1D               dec     e
 505+ 8AF2 3C               inc     a
 506+ 8AF3 CD 9F 88         call    VDP_PrintRamChar
 507+ 8AF6 1C               inc     e
 508+ 8AF7 3C               inc     a
 509+ 8AF8 CD 9F 88         call    VDP_PrintRamChar
 510+ 8AFB 1C               inc     e
 511+ 8AFC 3C               inc     a
 512+ 8AFD CD 9F 88         call    VDP_PrintRamChar
 513+ 8B00 1C               inc     e
 514+ 8B01 3C               inc     a
 515+ 8B02 CD 9F 88         call    VDP_PrintRamChar
 516+ 8B05              .HalfLineRedraw:
 517+ 8B05 E5               PUSH    HL
 518+ 8B06 C5               PUSH    BC
 519+ 8B07 CD 0F 8B         call    .HalfFieldRowRedraw
 520+ 8B0A C1               POP     BC
 521+ 8B0B E1               POP     HL
 522+ 8B0C F1               pop     af
 523+ 8B0D D1               pop     de
 524+ 8B0E
 525+ 8B0E C9               ret
 526+ 8B0F              .HalfFieldRowRedraw:
 527+ 8B0F 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
 528+ 8B12 FE 01            CP      FIELD_NORTH_SIDE
 529+ 8B14 20 3C            JR      NZ, .HalfFieldRowRedrawSouth
 530+ 8B16 16 04            LD      D, 4
 531+ 8B18 7A               LD      A, D
 532+ 8B19 87               ADD     A, A
 533+ 8B1A 87               ADD     A, A
 534+ 8B1B 47               LD      B, A
 535+ 8B1C              .HalfFieldRowRedrawDone:
 536+ 8B1C 1E 00            LD      E, 0
 537+ 8B1E              .HalfFieldRowRedrawDoneColsLoop:
 538+ 8B1E D5               PUSH    DE
 539+ 8B1F D5               PUSH    DE
 540+ 8B20 C5               PUSH    BC
 541+ 8B21 CD 74 96         CALL    Game_GetPlayerInfoByPos
 542+ 8B24 C1               POP     BC
 543+ 8B25 D1               POP     DE
 544+ 8B26 FE FF            CP      NO_VALUE
 545+ 8B28 20 20            JR      NZ, .HalfFieldRowRedrawDoneColsLoopContinue
 546+ 8B2A 50               LD      D, B
 547+ 8B2B 7B               LD      A, E
 548+ 8B2C 87               ADD     A, A
 549+ 8B2D 87               ADD     A, A
 550+ 8B2E 5F               LD      E, A
 551+ 8B2F 14               INC     D
 552+ 8B30 1C               INC     E
 553+ 8B31 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
 554+ 8B33 C5               PUSH    BC
 555+ 8B34 CD 9F 88         CALL    VDP_PrintRamChar
 556+ 8B37 C1               POP     BC
 557+ 8B38 1C               INC     E
 558+ 8B39 C5               PUSH    BC
 559+ 8B3A CD 9F 88         CALL    VDP_PrintRamChar
 560+ 8B3D C1               POP     BC
 561+ 8B3E 1C               INC     E
 562+ 8B3F C5               PUSH    BC
 563+ 8B40 CD 9F 88         CALL    VDP_PrintRamChar
 564+ 8B43 C1               POP     BC
 565+ 8B44 1C               INC     E
 566+ 8B45 C5               PUSH    BC
 567+ 8B46 CD 9F 88         CALL    VDP_PrintRamChar
 568+ 8B49 C1               POP     BC
 569+ 8B4A              .HalfFieldRowRedrawDoneColsLoopContinue:
 570+ 8B4A D1               POP     DE
 571+ 8B4B 1C               INC     E
 572+ 8B4C 7B               LD      A, E
 573+ 8B4D FE 04            CP      4
 574+ 8B4F C8               RET     Z
 575+ 8B50 18 CC            JR      .HalfFieldRowRedrawDoneColsLoop
 576+ 8B52              .HalfFieldRowRedrawSouth:
 577+ 8B52 16 01            LD      D, 1
 578+ 8B54 7A               LD      A, D
 579+ 8B55 87               ADD     A, A
 580+ 8B56 87               ADD     A, A
 581+ 8B57 47               LD      B, A
 582+ 8B58 04               INC     B
 583+ 8B59 04               INC     B
 584+ 8B5A C3 1C 8B         JP      .HalfFieldRowRedrawDone
 585+ 8B5D
 586+ 8B5D
 587+ 8B5D              ; -----------------------------------------------------------
 588+ 8B5D              ; Fill game field area to green
 589+ 8B5D              ; -----------------------------------------------------------
 590+ 8B5D              FillGameFieldAreaToGreen:
 591+ 8B5D F5               push    af
 592+ 8B5E C5               push    bc
 593+ 8B5F D5               push    de
 594+ 8B60 E5               push    hl
 595+ 8B61
 596+ 8B61 16 00            ld      d, 0
 597+ 8B63
 598+ 8B63              .Row:
 599+ 8B63 D5               push    de
 600+ 8B64 1E 01            ld      e, 1
 601+ 8B66              .Col:
 602+ 8B66 D5               push    de
 603+ 8B67 3E D6            ld      a, TILE_FIELD
 604+ 8B69 CD 9F 88         call    VDP_PrintRamChar
 605+ 8B6C D1               pop     de
 606+ 8B6D 1C               inc     e
 607+ 8B6E 7B               ld      a, e
 608+ 8B6F FE 15            cp      21
 609+ 8B71 28 02            jr      z, .NextRow
 610+ 8B73 18 F1            jr      .Col
 611+ 8B75              .NextRow:
 612+ 8B75 D1               pop     de
 613+ 8B76 14               inc     d
 614+ 8B77 7A               ld      a, d
 615+ 8B78 FE 18            cp      24
 616+ 8B7A 28 02            jr      z, .Done
 617+ 8B7C 18 E5            jr     .Row
 618+ 8B7E              .Done:
 619+ 8B7E E1               pop     hl
 620+ 8B7F D1               pop     de
 621+ 8B80 C1               pop     bc
 622+ 8B81 F1               pop     af
 623+ 8B82 C9               ret
 624+ 8B83
 625+ 8B83
 626+ 8B83
 627+ 8B83              ;------------------------------------------------------------------------
 628+ 8B83              ; Set screen charater attribute
 629+ 8B83              ; INPUT:
 630+ 8B83              ;   A: Value
 631+ 8B83              ;   D: Character Y position
 632+ 8B83              ;   E: Character X position
 633+ 8B83              ; OUTPUT: -
 634+ 8B83              ; MODIFIES: HL
 635+ 8B83              ;------------------------------------------------------------------------
 636+ 8B83              VDP_SetCharAttribute:
 637+ 8B83 D5                   PUSH    DE
 638+ 8B84 E5                   PUSH    HL
 639+ 8B85 C5                   PUSH    BC
 640+ 8B86 F5                   PUSH    AF
 641+ 8B87 7A                   LD      A, D    ; Load row in A
 642+ 8B88                      ; Before keeping the bits of the third, we carry out the rotations
 643+ 8B88 0F                   RRCA
 644+ 8B89 0F                   RRCA         ; Passes the bits of the third to bits 0 and 1
 645+ 8B8A 0F                   RRCA         ; and those of the row to bits 5, 6 and 7
 646+ 8B8B 6F                   LD      L, A    ; Load the result in L
 647+ 8B8C E6 03                AND     0x03     ; A = bits of the third
 648+ 8B8E F6 58                OR      0x58     ; Adds the fixed bits of the high part of the address
 649+ 8B90 67                   LD      H, A    ; H = 0101 10TT
 650+ 8B91 7D                   LD      A, L   ; A = row in bits 5, 6 and 7 and third in bits 0 and 1
 651+ 8B92 E6 E0                AND     0xE0     ; Keeps the bits of the line
 652+ 8B94 B3                   OR      E       ; Adds the bits of the column
 653+ 8B95 6F                   LD      L, A    ; L = RRRC CCCC
 654+ 8B96 F1                   POP     AF
 655+ 8B97 77                   LD      (HL),A          ; Scrivi l'attributo
 656+ 8B98 FE FF                CP      0xFF
 657+ 8B9A C2 9F 8B             JP      NZ, SetAttributeAtDE_1
 658+ 8B9D
 659+ 8B9D 36 14                LD      (HL),20
 660+ 8B9F              SetAttributeAtDE_1:
 661+ 8B9F
 662+ 8B9F
 663+ 8B9F
 664+ 8B9F C1                   POP     BC
 665+ 8BA0 E1                   POP     HL
 666+ 8BA1 D1                   POP     DE
 667+ 8BA2 C9                   RET
 668+ 8BA3
 669+ 8BA3              ; -----------------------------------------------------------
 670+ 8BA3              ; Draw field
 671+ 8BA3              ; -----------------------------------------------------------
 672+ 8BA3              VDP_DrawField:
 673+ 8BA3
 674+ 8BA3 CD 5D 8B         call    FillGameFieldAreaToGreen
 675+ 8BA6 3E 00            ld      a,0
 676+ 8BA8              .VLinesLoop:
 677+ 8BA8 F5               push    af
 678+ 8BA9 57               ld      d,a
 679+ 8BAA 1E 00            ld      e,0
 680+ 8BAC 3E D1            ld      a,TILE_FIELD_LINE_VERTICAL
 681+ 8BAE 0E 01            ld      c,1
 682+ 8BB0 CD 9F 88         call    VDP_PrintRamChar
 683+ 8BB3
 684+ 8BB3 1E 15            ld      e,21
 685+ 8BB5 3E D1            ld      a,TILE_FIELD_LINE_VERTICAL
 686+ 8BB7 0E 01            ld      c,1
 687+ 8BB9 CD 9F 88         call    VDP_PrintRamChar
 688+ 8BBC
 689+ 8BBC F1               pop     af
 690+ 8BBD 3C               inc     a
 691+ 8BBE FE 18            cp      24
 692+ 8BC0 20 E6            jr      nz,.VLinesLoop
 693+ 8BC2
 694+ 8BC2
 695+ 8BC2
 696+ 8BC2
 697+ 8BC2 3A 07 B2         ld      a,(Var_Game_ActiveFieldSide)
 698+ 8BC5 FE 01            cp      FIELD_NORTH_SIDE
 699+ 8BC7 CA 2E 8D         jp      z,.North
 700+ 8BCA
 701+ 8BCA              ; ---------- SOUTH ----------
 702+ 8BCA              .South:
 703+ 8BCA                  ; pulizia angoli interni
 704+ 8BCA 16 17            ld   d,23
 705+ 8BCC 1E 00            ld   e,0
 706+ 8BCE 3E D6            ld   a,TILE_FIELD
 707+ 8BD0 CD 9F 88         call VDP_PrintRamChar
 708+ 8BD3 16 16            ld   d,22
 709+ 8BD5 1E 00            ld   e,0
 710+ 8BD7 3E D6            ld   a,TILE_FIELD
 711+ 8BD9 CD 9F 88         call VDP_PrintRamChar
 712+ 8BDC 16 15            ld   d,21
 713+ 8BDE 1E 00            ld   e,0
 714+ 8BE0 3E D6            ld   a,TILE_FIELD
 715+ 8BE2 CD 9F 88         call VDP_PrintRamChar
 716+ 8BE5 16 14            ld   d,20
 717+ 8BE7 1E 00            ld   e,0
 718+ 8BE9 3E D6            ld   a,TILE_FIELD
 719+ 8BEB CD 9F 88         call VDP_PrintRamChar
 720+ 8BEE 16 17            ld   d,23
 721+ 8BF0 1E 15            ld   e,21
 722+ 8BF2 3E D6            ld   a,TILE_FIELD
 723+ 8BF4 CD 9F 88         call VDP_PrintRamChar
 724+ 8BF7 16 16            ld   d,22
 725+ 8BF9 1E 15            ld   e,21
 726+ 8BFB 3E D6            ld   a,TILE_FIELD
 727+ 8BFD CD 9F 88         call VDP_PrintRamChar
 728+ 8C00 16 15            ld   d,21
 729+ 8C02 1E 15            ld   e,21
 730+ 8C04 3E D6            ld   a,TILE_FIELD
 731+ 8C06 CD 9F 88         call VDP_PrintRamChar
 732+ 8C09 16 14            ld   d,20
 733+ 8C0B 1E 15            ld   e,21
 734+ 8C0D 3E D6            ld   a,TILE_FIELD
 735+ 8C0F CD 9F 88         call VDP_PrintRamChar
 736+ 8C12
 737+ 8C12                  ; angoli e montanti
 738+ 8C12 16 13            ld   d,19
 739+ 8C14 1E 00            ld   e,0
 740+ 8C16 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 741+ 8C18 CD 9F 88         call VDP_PrintRamChar
 742+ 8C1B 16 13            ld   d,19
 743+ 8C1D 1E 15            ld   e,21
 744+ 8C1F 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 745+ 8C21 CD 9F 88         call VDP_PrintRamChar
 746+ 8C24 16 17            ld   d,23
 747+ 8C26 1E 04            ld   e,4
 748+ 8C28 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 749+ 8C2A CD 9F 88         call VDP_PrintRamChar
 750+ 8C2D 16 17            ld   d,23
 751+ 8C2F 1E 11            ld   e,17
 752+ 8C31 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 753+ 8C33 CD 9F 88         call VDP_PrintRamChar
 754+ 8C36 16 13            ld   d,19
 755+ 8C38 1E 04            ld   e,4
 756+ 8C3A 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 757+ 8C3C CD 9F 88         call VDP_PrintRamChar
 758+ 8C3F 16 13            ld   d,19
 759+ 8C41 1E 11            ld   e,17
 760+ 8C43 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 761+ 8C45 CD 9F 88         call VDP_PrintRamChar
 762+ 8C48
 763+ 8C48                  ; montanti verticali
 764+ 8C48 16 14            ld   d,20
 765+ 8C4A 1E 11            ld   e,17
 766+ 8C4C 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 767+ 8C4E 0E 01            ld   c,1
 768+ 8C50 CD 9F 88         call VDP_PrintRamChar
 769+ 8C53 16 15            ld   d,21
 770+ 8C55 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 771+ 8C57 0E 01            ld   c,1
 772+ 8C59 CD 9F 88         call VDP_PrintRamChar
 773+ 8C5C 16 16            ld   d,22
 774+ 8C5E 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 775+ 8C60 0E 01            ld   c,1
 776+ 8C62 CD 9F 88         call VDP_PrintRamChar
 777+ 8C65 16 14            ld   d,20
 778+ 8C67 1E 04            ld   e,4
 779+ 8C69 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 780+ 8C6B 0E 01            ld   c,1
 781+ 8C6D CD 9F 88         call VDP_PrintRamChar
 782+ 8C70 16 15            ld   d,21
 783+ 8C72 1E 04            ld   e,4
 784+ 8C74 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 785+ 8C76 0E 01            ld   c,1
 786+ 8C78 CD 9F 88         call VDP_PrintRamChar
 787+ 8C7B 16 16            ld   d,22
 788+ 8C7D 1E 04            ld   e,4
 789+ 8C7F 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 790+ 8C81 0E 01            ld   c,1
 791+ 8C83 CD 9F 88         call VDP_PrintRamChar
 792+ 8C86
 793+ 8C86                  ; segmenti orizzontali
 794+ 8C86 16 13            ld   d,19
 795+ 8C88 1E 01            ld   e,1
 796+ 8C8A 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 797+ 8C8C CD 9F 88         call VDP_PrintRamChar
 798+ 8C8F 1E 02            ld   e,2
 799+ 8C91 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 800+ 8C93 CD 9F 88         call VDP_PrintRamChar
 801+ 8C96 1E 03            ld   e,3
 802+ 8C98 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 803+ 8C9A CD 9F 88         call VDP_PrintRamChar
 804+ 8C9D 1E 12            ld   e,18
 805+ 8C9F 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 806+ 8CA1 CD 9F 88         call VDP_PrintRamChar
 807+ 8CA4 1E 13            ld   e,19
 808+ 8CA6 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 809+ 8CA8 CD 9F 88         call VDP_PrintRamChar
 810+ 8CAB 1E 14            ld   e,20
 811+ 8CAD 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 812+ 8CAF CD 9F 88         call VDP_PrintRamChar
 813+ 8CB2 16 17            ld   d,23
 814+ 8CB4 1E 05            ld   e,5
 815+ 8CB6 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 816+ 8CB8 CD 9F 88         call VDP_PrintRamChar
 817+ 8CBB 1E 06            ld   e,6
 818+ 8CBD 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 819+ 8CBF CD 9F 88         call VDP_PrintRamChar
 820+ 8CC2 1E 07            ld   e,7
 821+ 8CC4 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 822+ 8CC6 CD 9F 88         call VDP_PrintRamChar
 823+ 8CC9 1E 08            ld   e,8
 824+ 8CCB 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 825+ 8CCD CD 9F 88         call VDP_PrintRamChar
 826+ 8CD0 1E 09            ld   e,9
 827+ 8CD2 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 828+ 8CD4 CD 9F 88         call VDP_PrintRamChar
 829+ 8CD7 1E 0A            ld   e,10
 830+ 8CD9 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 831+ 8CDB CD 9F 88         call VDP_PrintRamChar
 832+ 8CDE 1E 0B            ld   e,11
 833+ 8CE0 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 834+ 8CE2 CD 9F 88         call VDP_PrintRamChar
 835+ 8CE5 1E 0C            ld   e,12
 836+ 8CE7 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 837+ 8CE9 CD 9F 88         call VDP_PrintRamChar
 838+ 8CEC 1E 0D            ld   e,13
 839+ 8CEE 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 840+ 8CF0 CD 9F 88         call VDP_PrintRamChar
 841+ 8CF3 1E 0E            ld   e,14
 842+ 8CF5 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 843+ 8CF7 CD 9F 88         call VDP_PrintRamChar
 844+ 8CFA 1E 0F            ld   e,15
 845+ 8CFC 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 846+ 8CFE CD 9F 88         call VDP_PrintRamChar
 847+ 8D01 1E 10            ld   e,16
 848+ 8D03 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 849+ 8D05 CD 9F 88         call VDP_PrintRamChar
 850+ 8D08
 851+ 8D08                  ; croci
 852+ 8D08 16 07            ld   d,7
 853+ 8D0A 1E 00            ld   e,0
 854+ 8D0C 3E D7            ld   a,TILE_FIELD_LINE_LEFT_CROSS
 855+ 8D0E CD 9F 88         call VDP_PrintRamChar
 856+ 8D11 1E 15            ld   e,21
 857+ 8D13 3E D8            ld   a,TILE_FIELD_LINE_RIGHT_CROSS
 858+ 8D15 CD 9F 88         call VDP_PrintRamChar
 859+ 8D18
 860+ 8D18                  ; metà campo (riga 6): da col 1 a 20
 861+ 8D18 3E 01            ld   a,1
 862+ 8D1A              .SouthLoop:
 863+ 8D1A 16 07            ld   d,7
 864+ 8D1C F5               push af
 865+ 8D1D 5F               ld   e,a
 866+ 8D1E 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 867+ 8D20 0E 01            ld   c,1
 868+ 8D22 CD 9F 88         call VDP_PrintRamChar
 869+ 8D25 F1               pop  af
 870+ 8D26 3C               inc  a
 871+ 8D27 FE 15            cp   21
 872+ 8D29 20 EF            jr   nz,.SouthLoop
 873+ 8D2B C3 8B 8E         jp   .Done
 874+ 8D2E              .North:
 875+ 8D2E 16 00            ld   d,0
 876+ 8D30 1E 00            ld   e,0
 877+ 8D32 3E D6            ld   a,TILE_FIELD
 878+ 8D34 CD 9F 88         call VDP_PrintRamChar
 879+ 8D37 16 01            ld   d,1
 880+ 8D39 1E 00            ld   e,0
 881+ 8D3B 3E D6            ld   a,TILE_FIELD
 882+ 8D3D CD 9F 88         call VDP_PrintRamChar
 883+ 8D40 16 02            ld   d,2
 884+ 8D42 1E 00            ld   e,0
 885+ 8D44 3E D6            ld   a,TILE_FIELD
 886+ 8D46 CD 9F 88         call VDP_PrintRamChar
 887+ 8D49 16 03            ld   d,3
 888+ 8D4B 1E 00            ld   e,0
 889+ 8D4D 3E D6            ld   a,TILE_FIELD
 890+ 8D4F CD 9F 88         call VDP_PrintRamChar
 891+ 8D52 16 00            ld   d,0
 892+ 8D54 1E 15            ld   e,21
 893+ 8D56 3E D6            ld   a,TILE_FIELD
 894+ 8D58 CD 9F 88         call VDP_PrintRamChar
 895+ 8D5B 16 01            ld   d,1
 896+ 8D5D 1E 15            ld   e,21
 897+ 8D5F 3E D6            ld   a,TILE_FIELD
 898+ 8D61 CD 9F 88         call VDP_PrintRamChar
 899+ 8D64 16 02            ld   d,2
 900+ 8D66 1E 15            ld   e,21
 901+ 8D68 3E D6            ld   a,TILE_FIELD
 902+ 8D6A CD 9F 88         call VDP_PrintRamChar
 903+ 8D6D 16 03            ld   d,3
 904+ 8D6F 1E 15            ld   e,21
 905+ 8D71 3E D6            ld   a,TILE_FIELD
 906+ 8D73 CD 9F 88         call VDP_PrintRamChar
 907+ 8D76
 908+ 8D76                  ; angoli e montanti
 909+ 8D76 16 04            ld   d,4
 910+ 8D78 1E 00            ld   e,0
 911+ 8D7A 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 912+ 8D7C CD 9F 88         call VDP_PrintRamChar
 913+ 8D7F 16 04            ld   d,4
 914+ 8D81 1E 15            ld   e,21
 915+ 8D83 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 916+ 8D85 CD 9F 88         call VDP_PrintRamChar
 917+ 8D88 16 00            ld   d,0
 918+ 8D8A 1E 04            ld   e,4
 919+ 8D8C 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 920+ 8D8E CD 9F 88         call VDP_PrintRamChar
 921+ 8D91 16 00            ld   d,0
 922+ 8D93 1E 11            ld   e,17
 923+ 8D95 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 924+ 8D97 CD 9F 88         call VDP_PrintRamChar
 925+ 8D9A 16 04            ld   d,4
 926+ 8D9C 1E 04            ld   e,4
 927+ 8D9E 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 928+ 8DA0 CD 9F 88         call VDP_PrintRamChar
 929+ 8DA3 16 04            ld   d,4
 930+ 8DA5 1E 11            ld   e,17
 931+ 8DA7 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 932+ 8DA9 CD 9F 88         call VDP_PrintRamChar
 933+ 8DAC
 934+ 8DAC                  ; montanti verticali
 935+ 8DAC 16 01            ld   d,1
 936+ 8DAE 1E 11            ld   e,17
 937+ 8DB0 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 938+ 8DB2 CD 9F 88         call VDP_PrintRamChar
 939+ 8DB5 16 02            ld   d,2
 940+ 8DB7 1E 11            ld   e,17
 941+ 8DB9 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 942+ 8DBB CD 9F 88         call VDP_PrintRamChar
 943+ 8DBE 16 03            ld   d,3
 944+ 8DC0 1E 11            ld   e,17
 945+ 8DC2 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 946+ 8DC4 CD 9F 88         call VDP_PrintRamChar
 947+ 8DC7 16 01            ld   d,1
 948+ 8DC9 1E 04            ld   e,4
 949+ 8DCB 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 950+ 8DCD CD 9F 88         call VDP_PrintRamChar
 951+ 8DD0 16 02            ld   d,2
 952+ 8DD2 1E 04            ld   e,4
 953+ 8DD4 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 954+ 8DD6 CD 9F 88         call VDP_PrintRamChar
 955+ 8DD9 16 03            ld   d,3
 956+ 8DDB 1E 04            ld   e,4
 957+ 8DDD 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 958+ 8DDF CD 9F 88         call VDP_PrintRamChar
 959+ 8DE2
 960+ 8DE2                  ; segmenti orizzontali
 961+ 8DE2 16 04            ld   d,4
 962+ 8DE4 1E 01            ld   e,1
 963+ 8DE6 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 964+ 8DE8 CD 9F 88         call VDP_PrintRamChar
 965+ 8DEB 1E 02            ld   e,2
 966+ 8DED 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 967+ 8DEF CD 9F 88         call VDP_PrintRamChar
 968+ 8DF2 1E 03            ld   e,3
 969+ 8DF4 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 970+ 8DF6 CD 9F 88         call VDP_PrintRamChar
 971+ 8DF9 1E 12            ld   e,18
 972+ 8DFB 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 973+ 8DFD CD 9F 88         call VDP_PrintRamChar
 974+ 8E00 1E 13            ld   e,19
 975+ 8E02 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 976+ 8E04 CD 9F 88         call VDP_PrintRamChar
 977+ 8E07 1E 14            ld   e,20
 978+ 8E09 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 979+ 8E0B CD 9F 88         call VDP_PrintRamChar
 980+ 8E0E 16 00            ld   d,0
 981+ 8E10 1E 05            ld   e,5
 982+ 8E12 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 983+ 8E14 CD 9F 88         call VDP_PrintRamChar
 984+ 8E17 16 00            ld   d,0
 985+ 8E19 1E 06            ld   e,6
 986+ 8E1B 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 987+ 8E1D CD 9F 88         call VDP_PrintRamChar
 988+ 8E20 16 00            ld   d,0
 989+ 8E22 1E 07            ld   e,7
 990+ 8E24 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 991+ 8E26 CD 9F 88         call VDP_PrintRamChar
 992+ 8E29 1E 08            ld   e,8
 993+ 8E2B 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 994+ 8E2D CD 9F 88         call VDP_PrintRamChar
 995+ 8E30 1E 09            ld   e,9
 996+ 8E32 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 997+ 8E34 CD 9F 88         call VDP_PrintRamChar
 998+ 8E37 1E 0A            ld   e,10
 999+ 8E39 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1000+ 8E3B CD 9F 88         call VDP_PrintRamChar
1001+ 8E3E 1E 0B            ld   e,11
1002+ 8E40 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1003+ 8E42 CD 9F 88         call VDP_PrintRamChar
1004+ 8E45 1E 0C            ld   e,12
1005+ 8E47 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1006+ 8E49 CD 9F 88         call VDP_PrintRamChar
1007+ 8E4C 1E 0D            ld   e,13
1008+ 8E4E 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1009+ 8E50 CD 9F 88         call VDP_PrintRamChar
1010+ 8E53 1E 0E            ld   e,14
1011+ 8E55 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1012+ 8E57 CD 9F 88         call VDP_PrintRamChar
1013+ 8E5A 1E 0F            ld   e,15
1014+ 8E5C 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1015+ 8E5E CD 9F 88         call VDP_PrintRamChar
1016+ 8E61 1E 10            ld   e,16
1017+ 8E63 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1018+ 8E65 CD 9F 88         call VDP_PrintRamChar
1019+ 8E68                  ; croci
1020+ 8E68 16 11            ld   d,17
1021+ 8E6A 1E 00            ld   e,0
1022+ 8E6C 3E D7            ld   a,TILE_FIELD_LINE_LEFT_CROSS
1023+ 8E6E CD 9F 88         call VDP_PrintRamChar
1024+ 8E71 1E 15            ld   e,21
1025+ 8E73 3E D8            ld   a,TILE_FIELD_LINE_RIGHT_CROSS
1026+ 8E75 CD 9F 88         call VDP_PrintRamChar
1027+ 8E78
1028+ 8E78                  ; metà campo (riga 17): da col 1 a 20
1029+ 8E78 3E 01            ld   a,1
1030+ 8E7A              .NorthLoop:
1031+ 8E7A 16 11            ld   d,17
1032+ 8E7C F5               push af
1033+ 8E7D 5F               ld   e,a
1034+ 8E7E 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1035+ 8E80 0E 01            ld   c,1
1036+ 8E82 CD 9F 88         call VDP_PrintRamChar
1037+ 8E85 F1               pop  af
1038+ 8E86 3C               inc  a
1039+ 8E87 FE 15            cp   21
1040+ 8E89 20 EF            jr   nz, .NorthLoop
1041+ 8E8B              .Done:
1042+ 8E8B                  ;POP  AF
1043+ 8E8B                  ;OR   01000000b      ; forza display ON (bit 6 = 1) indipendentemente dal valore letto
1044+ 8E8B                  ;LD   C, 1
1045+ 8E8B                  ;CALL VDP_SetReg
1046+ 8E8B                  ;POP  BC
1047+ 8E8B                  ;POP  AF
1048+ 8E8B C9               RET
1049+ 8E8C
1050+ 8E8C              ; ---------------------------------------------------------
1051+ 8E8C              ; Rimuove il giocatore virtuale dallo schermo (se visibile)
1052+ 8E8C              ; ---------------------------------------------------------
1053+ 8E8C              VDP_RemoveVirtualPlayer:
1054+ 8E8C 3A 29 B2         LD      A,(Var_Game_VirtualPlayerYPos)
1055+ 8E8F FE FF            CP      255
1056+ 8E91 C8               RET     Z
1057+ 8E92 57               LD      D, A
1058+ 8E93 3A 2A B2         LD      A,(Var_Game_VirtualPlayerXPos)
1059+ 8E96 5F               LD      E, A
1060+ 8E97 3E D6            LD      A, TILE_FIELD
1061+ 8E99 CD 35 89         CALL    VDP_DrawSprite
1062+ 8E9C 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
1063+ 8E9F FE 00            CP      FIELD_SOUTH_SIDE
1064+ 8EA1 20 25            JR      NZ, .Done
1065+ 8EA3 3A 2A B2         LD      A, (Var_Game_VirtualPlayerXPos)
1066+ 8EA6 FE 04            CP      4
1067+ 8EA8 20 1E            JR      NZ, .Done
1068+ 8EAA 16 07            LD      D, 7
1069+ 8EAC 1E 11            LD      E, 17
1070+ 8EAE 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1071+ 8EB0 CD 9F 88         CALL    VDP_PrintRamChar
1072+ 8EB3 1E 12            LD      E, 18
1073+ 8EB5 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1074+ 8EB7 CD 9F 88         CALL    VDP_PrintRamChar
1075+ 8EBA 1E 13            LD      E, 19
1076+ 8EBC 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1077+ 8EBE CD 9F 88         CALL    VDP_PrintRamChar
1078+ 8EC1 1E 14            LD      E, 20
1079+ 8EC3 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1080+ 8EC5 CD 9F 88         CALL    VDP_PrintRamChar
1081+ 8EC8              .Done:
1082+ 8EC8 3E FF            LD  A, 255
1083+ 8ECA 32 29 B2         LD  (Var_Game_VirtualPlayerYPos), A
1084+ 8ECD C9               RET
1085+ 8ECE              ; ---------------------------------------------------------
1086+ 8ECE              ; Disegno del giocatore virtuale (se visibile)
1087+ 8ECE              ; ---------------------------------------------------------
1088+ 8ECE              VDP_PlayerMatrixRedraw_DrawVirtual:
1089+ 8ECE                  ; se Y = 255 → non disegnare
1090+ 8ECE 3A 29 B2         ld   a,(Var_Game_VirtualPlayerYPos)
1091+ 8ED1 FE FF            cp   255
1092+ 8ED3 28 1F            jr   z,VDP_PlayerMatrixRedraw_Done   ; salta se invisibile
1093+ 8ED5
1094+ 8ED5                  ; D = Y, E = X (coordinate di matrice 0..4)
1095+ 8ED5 57               ld   d,a                             ; D = Y
1096+ 8ED6 3A 2A B2         ld   a,(Var_Game_VirtualPlayerXPos)
1097+ 8ED9 5F               ld   e,a                             ; E = X
1098+ 8EDA
1099+ 8EDA                  ; salviamo i registri che useremo
1100+ 8EDA F5               push af
1101+ 8EDB C5               push bc
1102+ 8EDC D5               push de
1103+ 8EDD E5               push hl
1104+ 8EDE
1105+ 8EDE                  ; scegli il tile in base alla squadra virtuale
1106+ 8EDE 3A 2B B2         ld   a,(Var_Game_VirtualPlayerTeam)
1107+ 8EE1 FE 00            cp   TEAM_BLACK
1108+ 8EE3 20 04            jr   nz,.VirtWhite
1109+ 8EE5
1110+ 8EE5                  ; squadra nera → usa giocatore nero
1111+ 8EE5 3E B0            ld   a,TILE_BLACK_PLAYER
1112+ 8EE7 18 02            jr   .VirtHaveTile
1113+ 8EE9
1114+ 8EE9              .VirtWhite:
1115+ 8EE9                  ; squadra bianca → usa giocatore bianco
1116+ 8EE9 3E A0            ld   a,TILE_WHITE_PLAYER
1117+ 8EEB
1118+ 8EEB              .VirtHaveTile:
1119+ 8EEB                  ; mappa (D,E) -> coordinate schermo in (D,E)
1120+ 8EEB F5               PUSH  AF
1121+ 8EEC F1               POP   AF
1122+ 8EED                  ; A = tile di base, D,E = row/col → disegna lo sprite
1123+ 8EED CD 35 89         call VDP_DrawSprite
1124+ 8EF0
1125+ 8EF0                  ; ripristina registri
1126+ 8EF0 E1               pop  hl
1127+ 8EF1 D1               pop  de
1128+ 8EF2 C1               pop  bc
1129+ 8EF3 F1               pop  af
1130+ 8EF4
1131+ 8EF4              VDP_PlayerMatrixRedraw_Done:
1132+ 8EF4                  ; qui metti i tuoi:
1133+ 8EF4                  ; POP HL
1134+ 8EF4                  ; POP DE
1135+ 8EF4                  ; POP BC
1136+ 8EF4                  ; POP AF
1137+ 8EF4 C9                RET
1138+ 8EF5
1139+ 8EF5              ;----------------------------------------------------------------------------
1140+ 8EF5              ;  Sets VDP register
1141+ 8EF5              ;----------------------------------------------------------------------------
1142+ 8EF5              VDP_SetReg:
1143+ 8EF5                  ; In: A = value, C = reg#
1144+ 8EF5                  ; Usa la porta VDP control: 99h
1145+ 8EF5
1146+ 8EF5 F5               push af
1147+ 8EF6 DB 99            in   a,(099h)        ; reset latch (riallinea first/second write)
1148+ 8EF8 F1               pop  af
1149+ 8EF9
1150+ 8EF9 D3 99            out  (099h),a        ; value
1151+ 8EFB 79               ld   a,c
1152+ 8EFC F6 80            or   080h
1153+ 8EFE D3 99            out  (099h),a        ; select register write
1154+ 8F00 C9               ret
1155+ 8F01
1156+ 8F01              ; ---------------------------------------------------------------------------
1157+ 8F01              ; Redraws all players on screen using Var_Game_PlayersInfo, tramite
1158+ 8F01              ; GetPlayerInfoById.
1159+ 8F01              ;
1160+ 8F01              ; Per ogni giocatore:
1161+ 8F01              ;   - prende PREV_X/PREV_Y e CUR_X/CUR_Y da GetPlayerInfoById;
1162+ 8F01              ;   - se PREV_Y != 255 disegna TILE_FIELD alla vecchia posizione;
1163+ 8F01              ;   - se CUR_Y  != 255 disegna la tile corretta alla posizione attuale:
1164+ 8F01              ;       * ID = 0 (portiere):
1165+ 8F01              ;           - se Var_Game_GoalkeeperHasBall = YES:
1166+ 8F01              ;               TEAM_BLACK -> TILE_BLACK_GOALKEEPER_WITH_BALL
1167+ 8F01              ;               TEAM_WHITE -> TILE_WHITE_GOALKEEPER_WITH_BALL
1168+ 8F01              ;           - altrimenti:
1169+ 8F01              ;               TEAM_BLACK -> TILE_BLACK_GOALKEEPER
1170+ 8F01              ;               TEAM_WHITE -> TILE_WHITE_GOALKEEPER
1171+ 8F01              ;       * ID != 0:
1172+ 8F01              ;               TEAM_BLACK -> TILE_BLACK_PLAYER
1173+ 8F01              ;               TEAM_WHITE -> TILE_WHITE_PLAYER
1174+ 8F01              ;
1175+ 8F01              ; INPUT:  -
1176+ 8F01              ; OUTPUT: giocatori ridisegnati
1177+ 8F01              ; PRESERVA: AF, BC, DE, HL
1178+ 8F01              ; ---------------------------------------------------------------------------
1179+ 8F01              VDP_PlayerMatrixRedraw:
1180+ 8F01 F5               PUSH AF
1181+ 8F02 C5               PUSH BC
1182+ 8F03 D5               PUSH DE
1183+ 8F04 E5               PUSH HL
1184+ 8F05
1185+ 8F05 3A 35 B2         ld  a,(Var_Game_BallYOldPosition)
1186+ 8F08 FE FF            cp  NO_VALUE
1187+ 8F0A 28 0A            jr  z,.no_old_ball
1188+ 8F0C
1189+ 8F0C 57               ld  d,a                          ; Y old
1190+ 8F0D 3A 36 B2         ld  a,(Var_Game_BallXOldPosition)
1191+ 8F10 5F               ld  e,a                          ; X old
1192+ 8F11 3E D6            ld  a,TILE_FIELD
1193+ 8F13 CD 35 89         call VDP_DrawSprite
1194+ 8F16
1195+ 8F16
1196+ 8F16
1197+ 8F16
1198+ 8F16              .no_old_ball:
1199+ 8F16
1200+ 8F16                  ; ---- disegna prima TEAM_BLACK, poi TEAM_WHITE ----
1201+ 8F16 06 00            LD   B,TEAM_BLACK
1202+ 8F18 CD 1C 90         CALL VPMR_DrawTeam
1203+ 8F1B
1204+ 8F1B 06 01            LD   B,TEAM_WHITE
1205+ 8F1D CD 1C 90         CALL VPMR_DrawTeam
1206+ 8F20 CD CE 8E         CALL VDP_PlayerMatrixRedraw_DrawVirtual
1207+ 8F23 CD 2E 8F         CALL VDP_DrawBallOnMatrix
1208+ 8F26 CD B1 96         CALL Game_ClearSinglePlayerPrevPositions
1209+ 8F29 E1               POP  HL
1210+ 8F2A D1               POP  DE
1211+ 8F2B C1               POP  BC
1212+ 8F2C F1               POP  AF
1213+ 8F2D C9               RET
1214+ 8F2E
1215+ 8F2E              ;---------------------------------------------------------------
1216+ 8F2E              ; Disegna la palla sulla matrice (o portiere/giocatore con palla)
1217+ 8F2E              ; Usa:
1218+ 8F2E              ;   Var_Game_BallXPosition / Var_Game_BallYPosition
1219+ 8F2E              ;   Var_Game_BallDirection, Var_Game_BallDiagonalMovCounter
1220+ 8F2E              ;   Var_Game_ActiveFieldSide
1221+ 8F2E              ;---------------------------------------------------------------
1222+ 8F2E              VDP_DrawBallOnMatrix:
1223+ 8F2E F5               push af
1224+ 8F2F C5               push bc
1225+ 8F30 D5               push de
1226+ 8F31 E5               push hl
1227+ 8F32
1228+ 8F32                  ; di default nessun portiere con palla
1229+ 8F32 3E 00            ld   a,NO
1230+ 8F34 32 26 B2         ld   (Var_Game_GoalkeeperHasBall),a
1231+ 8F37
1232+ 8F37                  ; HL = X,Y della palla
1233+ 8F37 CD 92 95         call Game_GetBallPosition
1234+ 8F3A
1235+ 8F3A                  ; cerca eventuale giocatore in D/E
1236+ 8F3A CD 74 96         call Game_GetPlayerInfoByPos
1237+ 8F3D FE FF            cp   NO_VALUE
1238+ 8F3F CA BA 8F         jp   z,.no_player      ; casella vuota → gestisce solo la palla
1239+ 8F42
1240+ 8F42                  ;-----------------------------------------------------------
1241+ 8F42                  ; QUI C’E’ UN GIOCATORE
1242+ 8F42                  ;  B = TEAM   (0 nero, 1 bianco)
1243+ 8F42                  ;  C = ID     (0 portiere)
1244+ 8F42                  ;  A = ROLE
1245+ 8F42                  ;  HL = pos corrente, DE = pos precedente
1246+ 8F42                  ;-----------------------------------------------------------
1247+ 8F42
1248+ 8F42 79               ld   a,c
1249+ 8F43 B7               or   a
1250+ 8F44 20 1A            jr   nz,.field_player      ; ID!=0 → giocatore di movimento
1251+ 8F46
1252+ 8F46                  ;--------- PORTIERE ----------------------------------------
1253+ 8F46 3E 01            ld   a,YES
1254+ 8F48 32 26 B2         ld   (Var_Game_GoalkeeperHasBall),a
1255+ 8F4B
1256+ 8F4B 78               ld   a,b
1257+ 8F4C FE 00            cp   TEAM_BLACK
1258+ 8F4E 20 08            jr   nz,.white_gk
1259+ 8F50 CD 59 9E         call Game_StopShot
1260+ 8F53 3E 90            ld   a,TILE_BLACK_GOALKEEPER_WITH_BALL
1261+ 8F55 C3 E4 8F         jp   .draw_sprite_with_ball_pos
1262+ 8F58
1263+ 8F58              .white_gk:
1264+ 8F58 CD 59 9E         call Game_StopShot
1265+ 8F5B 3E 70            ld   a,TILE_WHITE_GOALKEEPER_WITH_BALL
1266+ 8F5D C3 E4 8F         jp   .draw_sprite_with_ball_pos
1267+ 8F60
1268+ 8F60
1269+ 8F60              ;--------- GIOCATORE DI MOVIMENTO -------------------------------
1270+ 8F60              .field_player:
1271+ 8F60                  ; logica in base a Var_Game_BallDirection
1272+ 8F60 3A 27 B2         ld   a,(Var_Game_BallDirection)
1273+ 8F63 FE 00            cp   BALL_DIRECTION_NONE
1274+ 8F65 28 1A            jr   z,.bp_none
1275+ 8F67 FE 01            cp   BALL_DIRECTION_NORTH
1276+ 8F69 28 1F            jr   z,.bp_north
1277+ 8F6B FE 02            cp   BALL_DIRECTION_NORTH_EAST
1278+ 8F6D 28 2D            jr   z,.bp_ne_nw
1279+ 8F6F FE 03            cp   BALL_DIRECTION_NORTH_WEST
1280+ 8F71 28 29            jr   z,.bp_ne_nw
1281+ 8F73 FE 04            cp   BALL_DIRECTION_SOUTH
1282+ 8F75 28 30            jr   z,.bp_south
1283+ 8F77 FE 05            cp   BALL_DIRECTION_SOUTH_EAST
1284+ 8F79 28 30            jr   z,.bp_se_sw
1285+ 8F7B FE 06            cp   BALL_DIRECTION_SOUTH_WEST
1286+ 8F7D 28 2C            jr   z,.bp_se_sw
1287+ 8F7F                  ; default → trattiamo come palla ferma
1288+ 8F7F 18 00            jr   .bp_none
1289+ 8F81
1290+ 8F81              ; palla statica sul giocatore → semplicemente “contatto”,
1291+ 8F81              ; giocatore nero con palla e direzione azzerata (adatta se vuoi
1292+ 8F81              ; gestire anche il bianco come nel tuo codice originale)
1293+ 8F81              .bp_none:
1294+ 8F81 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1295+ 8F83 4F               ld   c,a
1296+ 8F84 CD 59 9E         call Game_StopShot
1297+ 8F87 79               ld   a,c
1298+ 8F88 18 5A            jr   .draw_sprite_with_ball_pos
1299+ 8F8A
1300+ 8F8A              ; palla che arriva da N → se nero: tiene la palla e si ferma,
1301+ 8F8A              ; se bianco: solo disegno del bianco con palla (come da specifiche).
1302+ 8F8A              .bp_north:
1303+ 8F8A 78               ld   a,b
1304+ 8F8B FE 00            cp   TEAM_BLACK
1305+ 8F8D 20 09            jr   nz,.bp_north_white
1306+ 8F8F 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1307+ 8F91 4F               ld   c,a
1308+ 8F92 CD 59 9E         call Game_StopShot
1309+ 8F95 79               ld   a,c
1310+ 8F96 18 4C            jr   .draw_sprite_with_ball_pos
1311+ 8F98
1312+ 8F98              .bp_north_white:
1313+ 8F98 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1314+ 8F9A 18 48            jr   .draw_sprite_with_ball_pos
1315+ 8F9C
1316+ 8F9C              ; diagonale NORD (NE/NW) con contatore=1 → palla dietro al giocatore
1317+ 8F9C              .bp_ne_nw:
1318+ 8F9C 3A 28 B2         ld   a,(Var_Game_BallDiagonalMovCounter)
1319+ 8F9F FE 00            cp   0
1320+ 8FA1 20 74            jr   nz,.exit            ; niente di speciale
1321+ 8FA3 3E 02            ld   a,TILE_BLACK_PLAYER_WITH_BACK_BALL
1322+ 8FA5 18 3D            jr   .draw_sprite_with_ball_pos
1323+ 8FA7
1324+ 8FA7              ; palla da S → nero la controlla e si ferma
1325+ 8FA7              .bp_south:
1326+ 8FA7 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1327+ 8FA9                  ;ld   c,a
1328+ 8FA9                  ;call Game_StopShot
1329+ 8FA9                  ;ld   a,c
1330+ 8FA9 18 39            jr   .draw_sprite_with_ball_pos
1331+ 8FAB
1332+ 8FAB              ; diagonale SUD (SE/SW)
1333+ 8FAB              .bp_se_sw:
1334+ 8FAB 3A 28 B2         ld   a,(Var_Game_BallDiagonalMovCounter)
1335+ 8FAE FE 00            cp   0
1336+ 8FB0 28 04            jr   z,.bp_se_sw_counter1
1337+ 8FB2
1338+ 8FB2                  ; contatore !=1 → nero riceve palla davanti e si ferma
1339+ 8FB2 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1340+ 8FB4                  ;ld   c,a
1341+ 8FB4                  ;call Game_StopShot
1342+ 8FB4                  ;ld   a,c
1343+ 8FB4 18 2E            jr   .draw_sprite_with_ball_pos
1344+ 8FB6
1345+ 8FB6              .bp_se_sw_counter1:
1346+ 8FB6                  ; contatore=1 → bianco con palla
1347+ 8FB6 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1348+ 8FB8 18 2A            jr   .draw_sprite_with_ball_pos
1349+ 8FBA
1350+ 8FBA
1351+ 8FBA              ;================ CASO NESSUN GIOCATORE NELLA CASELLA ==============
1352+ 8FBA              .no_player:
1353+ 8FBA                  ; Qui dobbiamo decidere se BALL_BOTTOM o BALL_TOP.
1354+ 8FBA                  ; *** IMPORTANTE ***:
1355+ 8FBA                  ;  - teniamo la tile in C
1356+ 8FBA                  ;  - usiamo A solo per confronti
1357+ 8FBA 0E 40            ld   c,TILE_BALL_BOTTOM       ; default
1358+ 8FBC
1359+ 8FBC                  ; --- caso 1: diagonale NORD (NE/NW) con contatore = 1 → BALL_TOP
1360+ 8FBC 3A 27 B2         ld   a,(Var_Game_BallDirection)
1361+ 8FBF FE 02            cp   BALL_DIRECTION_NORTH_EAST
1362+ 8FC1 28 04            jr   z,.np_diag_north
1363+ 8FC3 FE 03            cp   BALL_DIRECTION_NORTH_WEST
1364+ 8FC5 20 09            jr   nz,.np_after_diag
1365+ 8FC7
1366+ 8FC7              .np_diag_north:
1367+ 8FC7 3A 28 B2         ld   a,(Var_Game_BallDiagonalMovCounter)
1368+ 8FCA FE 00            cp   0
1369+ 8FCC 20 02            jr   nz,.np_after_diag
1370+ 8FCE 0E 06            ld   c,TILE_BALL_TOP          ; override
1371+ 8FD0
1372+ 8FD0              .np_after_diag:
1373+ 8FD0 79               ld   a,c                       ; rimetti la tile scelta in A
1374+ 8FD1 18 00            jr   .chk_fieldside_top
1375+ 8FD3
1376+ 8FD3
1377+ 8FD3              ;----------------- TUO BLOCCO OTTIMIZZATO --------------------------
1378+ 8FD3              ; --- caso 2: FIELD_NORTH_SIDE e Y=0 -> BALL_TOP --------------
1379+ 8FD3              .chk_fieldside_top:
1380+ 8FD3 4F               ld   c,a                       ; salva la tile in C
1381+ 8FD4
1382+ 8FD4 3A 07 B2         ld   a,(Var_Game_ActiveFieldSide)
1383+ 8FD7 FE 01            cp   FIELD_NORTH_SIDE
1384+ 8FD9 20 08            jr   nz,.draw_sprite_prep
1385+ 8FDB
1386+ 8FDB 3A 34 B2         ld   a,(Var_Game_BallYPosition)
1387+ 8FDE B7               or   a
1388+ 8FDF 20 02            jr   nz,.draw_sprite_prep
1389+ 8FE1 0E 03            ld   c,TILE_CORNER_BALL           ; Y=0 in direzione NORTH -> BALL_TOP
1390+ 8FE3
1391+ 8FE3              .draw_sprite_prep:
1392+ 8FE3 79               ld   a,c                       ; A = tile definitiva (TOP/BOTTOM/altro)
1393+ 8FE4
1394+ 8FE4
1395+ 8FE4              ; ====== DISEGNO DELLO SPRITE (palla o giocatore con palla) ========
1396+ 8FE4
1397+ 8FE4              ; Se arriviamo dai casi giocatore, ricarichiamo sempre le coordinate
1398+ 8FE4              ; della palla prima di disegnare.
1399+ 8FE4              .draw_sprite_with_ball_pos:
1400+ 8FE4 47               ld   b,a                       ; salva tile in B
1401+ 8FE5
1402+ 8FE5 CD 92 95         call Game_GetBallPosition           ; HL = X,Y
1403+ 8FE8
1404+ 8FE8
1405+ 8FE8 78               ld   a,b                       ; ripristina tile
1406+ 8FE9                  ; cade in .draw_sprite
1407+ 8FE9
1408+ 8FE9              .draw_sprite:
1409+ 8FE9                  ; A = tile, D = Y, E = X (coord matrice)
1410+ 8FE9 FE 40            CP   TILE_BALL_BOTTOM
1411+ 8FEB C2 12 90         JP   NZ, .draw_sprite_continue
1412+ 8FEE 3A 07 B2         LD   A, (Var_Game_ActiveFieldSide)
1413+ 8FF1 FE 01            CP   FIELD_NORTH_SIDE
1414+ 8FF3 CA 03 90         JP   Z, .darw_ball_north_field
1415+ 8FF6 3A 34 B2         LD   A, (Var_Game_BallYPosition)
1416+ 8FF9 FE 04            CP   4
1417+ 8FFB CA 10 90         JP   Z, .draw_ball_top
1418+ 8FFE 3E 40            LD   A, TILE_BALL_BOTTOM
1419+ 9000 C3 12 90         JP   .draw_sprite_continue
1420+ 9003              .darw_ball_north_field:
1421+ 9003 3A 34 B2         LD   A, (Var_Game_BallYPosition)
1422+ 9006 FE 00            CP   0
1423+ 9008 CA 10 90         JP   Z, .draw_ball_top
1424+ 900B 3E 40            LD   A, TILE_BALL_BOTTOM
1425+ 900D C3 12 90         JP   .draw_sprite_continue
1426+ 9010              .draw_ball_top:
1427+ 9010 3E 03            LD   A, TILE_CORNER_BALL
1428+ 9012              .draw_sprite_continue:
1429+ 9012 CD 35 89         call VDP_DrawSprite
1430+ 9015 18 00            jr   .exit
1431+ 9017
1432+ 9017
1433+ 9017              .exit:
1434+ 9017 E1               pop  hl
1435+ 9018 D1               pop  de
1436+ 9019 C1               pop  bc
1437+ 901A F1               pop  af
1438+ 901B C9               ret
1439+ 901C
1440+ 901C              ; ---------------------------------------------------------------------------
1441+ 901C              ; Disegna tutti i 4 giocatori di una squadra
1442+ 901C              ; INPUT:
1443+ 901C              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
1444+ 901C              ; MODIFICA:
1445+ 901C              ;   AF, BC, DE, HL
1446+ 901C              ; ---------------------------------------------------------------------------
1447+ 901C              VPMR_DrawTeam:
1448+ 901C 0E 00            LD   C,0                    ; ID = 0..3
1449+ 901E              VPMR_PlayerLoop:
1450+ 901E C5               PUSH BC                     ; salva TEAM/ID per dopo
1451+ 901F
1452+ 901F CD 59 96         CALL Game_GetPlayerInfoById
1453+ 9022                  ; dopo la call:
1454+ 9022                  ;   DE = prev (D=prevY, E=prevX)
1455+ 9022                  ;   HL = cur  (H=curY,  L=curX)
1456+ 9022                  ;   A  = ROLE
1457+ 9022                  ;   B  = TEAM
1458+ 9022                  ;   C  = ID
1459+ 9022
1460+ 9022                  ; ----- CLEAR PREVIOUS POSITION (se valida) --------------------
1461+ 9022 7A               LD   A,D                    ; prevY
1462+ 9023 FE FF            CP   255
1463+ 9025 CA B1 90         JP   Z,VPMR_SkipClear
1464+ 9028
1465+ 9028
1466+ 9028                  ; mappa coord logiche prev -> schermo
1467+ 9028 E5               PUSH HL                     ; salvo current
1468+ 9029 F5               PUSH AF                     ; non mi interessa il contenuto, ma proteggo A
1469+ 902A C5               PUSH BC
1470+ 902B 3E D6            LD   A,TILE_FIELD
1471+ 902D CD 35 89         CALL VDP_DrawSprite             ; D=row, E=col, A=tile
1472+ 9030 C1               POP  BC
1473+ 9031 C5               PUSH BC
1474+ 9032 78               LD   A, B
1475+ 9033 FE 01            CP   TEAM_WHITE
1476+ 9035 C2 AB 90         JP   NZ, VPMR_AfterCheckHalfLineToClear
1477+ 9038 3A 07 B2         LD   A, (Var_Game_ActiveFieldSide)
1478+ 903B FE 00            CP   FIELD_SOUTH_SIDE
1479+ 903D CA 73 90         JP   Z, VPMR_WhiteOnSouthHalfToRemove
1480+ 9040
1481+ 9040              VPMR_WhiteOnNorthHalfToRemove:
1482+ 9040 7A               LD   A, D
1483+ 9041 FE 11            CP   17
1484+ 9043 C2 AB 90         JP   NZ, VPMR_AfterCheckHalfLineToClear
1485+ 9046 D5               PUSH  DE
1486+ 9047 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1487+ 9049 CD 9F 88         CALL  VDP_PrintRamChar
1488+ 904C 1C               INC   E
1489+ 904D 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1490+ 904F CD 9F 88         CALL  VDP_PrintRamChar
1491+ 9052 1C               INC   E
1492+ 9053 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1493+ 9055 CD 9F 88         CALL  VDP_PrintRamChar
1494+ 9058 1C               INC   E
1495+ 9059 14               INC   D
1496+ 905A 3E D6            LD    A, TILE_FIELD
1497+ 905C CD 9F 88         CALL  VDP_PrintRamChar
1498+ 905F 1D               DEC   E
1499+ 9060 1D               DEC   E
1500+ 9061 1D               DEC   E
1501+ 9062
1502+ 9062 14               INC   D
1503+ 9063 14               INC   D
1504+ 9064 3E D6            LD    A, TILE_FIELD
1505+ 9066 CD 9F 88         CALL  VDP_PrintRamChar
1506+ 9069 1C               INC   E
1507+ 906A 3E D6            LD    A, TILE_FIELD
1508+ 906C CD 9F 88         CALL  VDP_PrintRamChar
1509+ 906F
1510+ 906F D1               POP   DE
1511+ 9070 C3 AB 90         JP    VPMR_AfterCheckHalfLineToClear
1512+ 9073              VPMR_WhiteOnSouthHalfToRemove:
1513+ 9073 7A               LD   A, D
1514+ 9074 FE 07            CP   7
1515+ 9076 C2 AB 90         JP   NZ, VPMR_AfterCheckHalfLineToClear
1516+ 9079 D5               PUSH  DE
1517+ 907A 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1518+ 907C CD 9F 88         CALL  VDP_PrintRamChar
1519+ 907F 1C               INC   E
1520+ 9080 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1521+ 9082 CD 9F 88         CALL  VDP_PrintRamChar
1522+ 9085 1C               INC   E
1523+ 9086 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1524+ 9088 CD 9F 88         CALL  VDP_PrintRamChar
1525+ 908B 1C               INC   E
1526+ 908C 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1527+ 908E CD 9F 88         CALL  VDP_PrintRamChar
1528+ 9091 14               INC   D
1529+ 9092 3E D6            LD    A, TILE_FIELD
1530+ 9094 CD 9F 88         CALL  VDP_PrintRamChar
1531+ 9097 1D               DEC   E
1532+ 9098 1D               DEC   E
1533+ 9099 1D               DEC   E
1534+ 909A
1535+ 909A 14               INC   D
1536+ 909B 14               INC   D
1537+ 909C 3E D6            LD    A, TILE_FIELD
1538+ 909E CD 9F 88         CALL  VDP_PrintRamChar
1539+ 90A1 1C               INC   E
1540+ 90A2 3E D6            LD    A, TILE_FIELD
1541+ 90A4 CD 9F 88         CALL  VDP_PrintRamChar
1542+ 90A7
1543+ 90A7 D1               POP   DE
1544+ 90A8 C3 AB 90         JP    VPMR_AfterCheckHalfLineToClear
1545+ 90AB
1546+ 90AB              VPMR_AfterCheckHalfLineToClear:
1547+ 90AB C1               POP  BC
1548+ 90AC F1               POP  AF
1549+ 90AD E1               POP  HL
1550+ 90AE CD B1 96         CALL Game_ClearSinglePlayerPrevPositions
1551+ 90B1              VPMR_SkipClear:
1552+ 90B1                  ; ----- DRAW CURRENT POSITION (se visibile) -------------------
1553+ 90B1 7C               LD   A,H                    ; curY
1554+ 90B2 FE FF            CP   255
1555+ 90B4 CA 16 91         JP   Z,VPMR_AfterDraw       ; giocatore invisibile (es. portiere nascosto)
1556+ 90B7
1557+ 90B7                  ; D,E = coord logiche correnti
1558+ 90B7 54               LD   D,H
1559+ 90B8 5D               LD   E,L
1560+ 90B9
1561+ 90B9
1562+ 90B9                  ; ora D,E = coord schermo
1563+ 90B9
1564+ 90B9                  ; ----- determina la tile in A -----------------------
1565+ 90B9 79               LD   A,C                    ; A = ID
1566+ 90BA B7               OR   A
1567+ 90BB C2 E6 90         JP   NZ,VPMR_FieldPlayer    ; ID != 0 → giocatore di movimento
1568+ 90BE
1569+ 90BE                  ; ===== PORTIERE =====
1570+ 90BE 3A 26 B2         LD   A,(Var_Game_GoalkeeperHasBall)
1571+ 90C1 FE 01            CP   YES
1572+ 90C3 C2 D6 90         JP   NZ,VPMR_GK_NoBall
1573+ 90C6
1574+ 90C6                  ; portiere CON palla
1575+ 90C6 78               LD   A,B                    ; TEAM
1576+ 90C7 FE 00            CP   TEAM_BLACK
1577+ 90C9 C2 D1 90         JP   NZ,VPMR_WhiteGKWithBall
1578+ 90CC 3E 90            LD   A,TILE_BLACK_GOALKEEPER_WITH_BALL
1579+ 90CE C3 13 91         JP   VPMR_DoDraw
1580+ 90D1
1581+ 90D1              VPMR_WhiteGKWithBall:
1582+ 90D1 3E 70            LD   A,TILE_WHITE_GOALKEEPER_WITH_BALL
1583+ 90D3 C3 13 91         JP   VPMR_DoDraw
1584+ 90D6
1585+ 90D6              VPMR_GK_NoBall:
1586+ 90D6                  ; portiere SENZA palla
1587+ 90D6 78               LD   A,B
1588+ 90D7 FE 00            CP   TEAM_BLACK
1589+ 90D9 C2 E1 90         JP   NZ,VPMR_WhiteGKNoBall
1590+ 90DC 3E 80            LD   A,TILE_BLACK_GOALKEEPER
1591+ 90DE C3 13 91         JP   VPMR_DoDraw
1592+ 90E1
1593+ 90E1              VPMR_WhiteGKNoBall:
1594+ 90E1 3E 60            LD   A,TILE_WHITE_GOALKEEPER
1595+ 90E3 C3 13 91         JP   VPMR_DoDraw
1596+ 90E6
1597+ 90E6                  ; ===== GIOCATORE DI MOVIMENTO =====
1598+ 90E6              VPMR_FieldPlayer:
1599+ 90E6 78               LD   A,B
1600+ 90E7 FE 00            CP   TEAM_BLACK
1601+ 90E9 C2 F1 90         JP   NZ,VPMR_WhitePlayer
1602+ 90EC 3E B0            LD   A,TILE_BLACK_PLAYER
1603+ 90EE C3 13 91         JP   VPMR_DoDraw
1604+ 90F1
1605+ 90F1              VPMR_WhitePlayer:
1606+ 90F1 E5               PUSH  HL
1607+ 90F2 D1               POP   DE
1608+ 90F3 3A 07 B2         LD   A, (Var_Game_ActiveFieldSide)
1609+ 90F6 FE 00            CP   FIELD_SOUTH_SIDE
1610+ 90F8 CA 06 91         JP   Z, VPMR_WhitPlayerSouth
1611+ 90FB 7C               LD   A, H
1612+ 90FC FE 04            CP   4
1613+ 90FE C2 11 91         JP   NZ, VPMR_WhiteStandardPlayer
1614+ 9101 3E 50            LD   A,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
1615+ 9103 C3 13 91         JP   VPMR_DoDraw
1616+ 9106              VPMR_WhitPlayerSouth:
1617+ 9106 7C               LD   A, H
1618+ 9107 FE 01            CP   1
1619+ 9109 C2 11 91         JP   NZ, VPMR_WhiteStandardPlayer
1620+ 910C 3E 50            LD   A,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
1621+ 910E C3 13 91         JP   VPMR_DoDraw
1622+ 9111              VPMR_WhiteStandardPlayer:
1623+ 9111 3E A0            LD   A,TILE_WHITE_PLAYER
1624+ 9113              VPMR_DoDraw:
1625+ 9113 CD 35 89         CALL VDP_DrawSprite          ; usa D,E già mappate
1626+ 9116
1627+ 9116              VPMR_AfterDraw:
1628+ 9116 C1               POP  BC                      ; ripristina TEAM/ID salvati a inizio ciclo
1629+ 9117
1630+ 9117 0C               INC  C
1631+ 9118 79               LD   A,C
1632+ 9119 FE 04            CP   4
1633+ 911B C2 1E 90         JP   NZ,VPMR_PlayerLoop
1634+ 911E C9               RET
1635+ 911F
1636+ 911F
1637+ 911F
1638+ 911F
1639+ 911F
1640+ 911F
1641+ 911F
1642+ 911F
1643+ 911F              ; ---------------------------------------------------------------------------
1644+ 911F              ; Pulisce l'area laterale del menu (colonne 23)
1645+ 911F              ; ---------------------------------------------------------------------------
1646+ 911F              VDP_ClearMenuSideArea:
1647+ 911F AF               XOR     A
1648+ 9120              .Loop:
1649+ 9120 F5               PUSH    AF
1650+ 9121 57               LD      D, A
1651+ 9122 1E 17            LD      E, 23
1652+ 9124 21 E1 80         LD      HL, TXT_EMPTY
1653+ 9127 CD 93 88         CALL    VDP_PrintString
1654+ 912A
1655+ 912A F1               POP     AF
1656+ 912B 3C               INC     A
1657+ 912C FE 15            CP      21
1658+ 912E C8               RET     Z
1659+ 912F C3 20 91         JP      .Loop
1660+ 9132
1661+ 9132
1662+ 9132
1663+ 9132              VDP_ShowScores:
1664+ 9132 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
1665+ 9135 FE 01            CP      YES
1666+ 9137 C0               RET     NZ
1667+ 9138 16 00            LD      D, 0
1668+ 913A 1E 17            LD      E, 23
1669+ 913C 21 EA 80         LD      HL, TXT_TIME
1670+ 913F CD 93 88         CALL    VDP_PrintString
1671+ 9142
1672+ 9142 16 05            LD      D, 5
1673+ 9144 1E 17            LD      E, 23
1674+ 9146 21 EF 80         LD      HL, TXT_BLACK_TEAM
1675+ 9149 CD 93 88         CALL    VDP_PrintString
1676+ 914C
1677+ 914C 16 0A            LD      D, 10
1678+ 914E 1E 17            LD      E, 23
1679+ 9150 21 F8 80         LD      HL, TXT_WHITE_TEAM
1680+ 9153 CD 93 88         CALL    VDP_PrintString
1681+ 9156 D5               PUSH    DE
1682+ 9157 E5               PUSH    HL
1683+ 9158 3A 23 B2         LD      A, (Var_Game_ScoreWhite)
1684+ 915B 26 00            LD      H, 0
1685+ 915D 6F               LD      L, A
1686+ 915E 11 FE B1         LD      DE, Var_Utils_NumberToPrint
1687+ 9161 CD 07 81         CALL    String_NumberToASCII
1688+ 9164 21 FE B1         LD      HL, Var_Utils_NumberToPrint
1689+ 9167 CD 2C 81         CALL    String_RemoveLeadingZeros
1690+ 916A 21 FE B1         LD      HL, Var_Utils_NumberToPrint
1691+ 916D 16 0B            LD      D, 11
1692+ 916F 1E 1A            LD      E, 26
1693+ 9171 CD 93 88         CALL    VDP_PrintString
1694+ 9174
1695+ 9174 3A 16 B2         LD      A, (Var_Game_ScoreBlack)
1696+ 9177 26 00            LD      H, 0
1697+ 9179 6F               LD      L, A
1698+ 917A 11 FE B1         LD      DE, Var_Utils_NumberToPrint
1699+ 917D CD 07 81         CALL    String_NumberToASCII
1700+ 9180 21 FE B1         LD      HL, Var_Utils_NumberToPrint
1701+ 9183 CD 2C 81         CALL    String_RemoveLeadingZeros
1702+ 9186 21 FE B1         LD      HL, Var_Utils_NumberToPrint
1703+ 9189 16 06            LD      D, 6
1704+ 918B 1E 1A            LD      E, 26
1705+ 918D CD 93 88         CALL    VDP_PrintString
1706+ 9190
1707+ 9190 E1               POP     HL
1708+ 9191 D1               POP     DE
1709+ 9192 C9               RET
1710+ 9193
1711+ 9193
# file closed: ./inc/vdp.asm
  16  9193                  INCLUDE "menu.asm"                      ; Include menu library
# file opened: ./inc/menu.asm
   1+ 9193              ; ===================================================================
   2+ 9193              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 9193              ; ===================================================================
   4+ 9193
   5+ 9193              ; *** MENU.ASM ***
   6+ 9193
   7+ 9193              ; ------ ROUTINES ------
   8+ 9193
   9+ 9193              ;------------------------------------------------------------------------
  10+ 9193              ; Show menu
  11+ 9193              ; INPUT: -
  12+ 9193              ; OUTPUT: -
  13+ 9193              ; MODIFY: A, DE, HL, BC
  14+ 9193              ;-------------------------------------------------------------------------
  15+ 9193              Menu_Show:
  16+ 9193 CD 50 81         CALL    Hooks_TickStart
  17+ 9196 CD AD 86         CALL    Hooks_InitAICounters
  18+ 9199 3E 02            LD      A, 2
  19+ 919B 32 2D B2         LD      (Var_Game_PlayersSpeed), A ; set default players speed to 2
  20+ 919E CD 15 A4         CALL    Game_Start
  21+ 91A1 CD A6 91         CALL    Menu_ShowOptions
  22+ 91A4 FB               EI
  23+ 91A5 C9               RET
  24+ 91A6
  25+ 91A6              ;------------------------------------------------------------------------
  26+ 91A6              ; Show options menu
  27+ 91A6              ; -------------------------------------------------------------------------
  28+ 91A6              Menu_ShowOptions:
  29+ 91A6 CD 1F 91         CALL    VDP_ClearMenuSideArea
  30+ 91A9
  31+ 91A9 21 6B 80         LD      HL, TXT_BTN_PLY1_1
  32+ 91AC 16 00            LD      D, 0
  33+ 91AE 1E 17            LD      E, 23
  34+ 91B0 CD 93 88         CALL    VDP_PrintString
  35+ 91B3 21 74 80         LD      HL, TXT_BTN_PLY1_2
  36+ 91B6 16 01            LD      D, 1
  37+ 91B8 1E 18            LD      E, 24
  38+ 91BA CD 93 88         CALL    VDP_PrintString
  39+ 91BD 21 7B 80         LD      HL, TXT_BTN_PLY1_3
  40+ 91C0 16 02            LD      D, 2
  41+ 91C2 1E 18            LD      E, 24
  42+ 91C4 CD 93 88         CALL    VDP_PrintString
  43+ 91C7 21 82 80         LD      HL, TXT_BTN_PLY1_4
  44+ 91CA 16 03            LD      D, 3
  45+ 91CC 1E 18            LD      E, 24
  46+ 91CE CD 93 88         CALL    VDP_PrintString
  47+ 91D1 21 8A 80         LD      HL, TXT_BTN_PLY1_5
  48+ 91D4 16 04            LD      D, 4
  49+ 91D6 1E 18            LD      E, 24
  50+ 91D8 CD 93 88         CALL    VDP_PrintString
  51+ 91DB
  52+ 91DB
  53+ 91DB 21 E1 80         LD      HL, TXT_EMPTY
  54+ 91DE 16 0E            LD      D, 14
  55+ 91E0 1E 17            LD      E, 23
  56+ 91E2 CD 93 88         CALL    VDP_PrintString
  57+ 91E5
  58+ 91E5
  59+ 91E5 21 E1 80         LD      HL, TXT_EMPTY
  60+ 91E8 16 06            LD      D, 6
  61+ 91EA 1E 17            LD      E, 23
  62+ 91EC CD 93 88         CALL    VDP_PrintString
  63+ 91EF 21 E1 80         LD      HL, TXT_EMPTY
  64+ 91F2 16 07            LD      D, 7
  65+ 91F4 1E 18            LD      E, 24
  66+ 91F6 CD 93 88         CALL    VDP_PrintString
  67+ 91F9 21 E1 80         LD      HL, TXT_EMPTY
  68+ 91FC 16 08            LD      D, 8
  69+ 91FE 1E 18            LD      E, 24
  70+ 9200 CD 93 88         CALL    VDP_PrintString
  71+ 9203 21 E1 80         LD      HL, TXT_EMPTY
  72+ 9206 16 09            LD      D, 9
  73+ 9208 1E 18            LD      E, 24
  74+ 920A CD 93 88         CALL    VDP_PrintString
  75+ 920D 21 E1 80         LD      HL, TXT_EMPTY
  76+ 9210 16 0A            LD      D, 10
  77+ 9212 1E 18            LD      E, 24
  78+ 9214 CD 93 88         CALL    VDP_PrintString
  79+ 9217
  80+ 9217
  81+ 9217 21 38 80         LD      HL, TXT_CPU
  82+ 921A 16 0D            LD      D, 13
  83+ 921C 1E 17            LD      E, 23
  84+ 921E CD 93 88         CALL    VDP_PrintString
  85+ 9221
  86+ 9221 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
  87+ 9224 FE 01            CP      GAME_MODE_1_PLAYER
  88+ 9226 CA 68 92         JP      Z, .Level1
  89+ 9229 21 30 80         LD      HL, TXT_GAME_MODE_2_PLAYERS
  90+ 922C 16 0D            LD      D, 13
  91+ 922E 1E 17            LD      E, 23
  92+ 9230 CD 93 88         CALL    VDP_PrintString
  93+ 9233 21 92 80         LD      HL, TXT_BTN_PLY2_1
  94+ 9236 16 06            LD      D, 6
  95+ 9238 1E 17            LD      E, 23
  96+ 923A CD 93 88         CALL    VDP_PrintString
  97+ 923D 21 9B 80         LD      HL, TXT_BTN_PLY2_2
  98+ 9240 16 07            LD      D, 7
  99+ 9242 1E 18            LD      E, 24
 100+ 9244 CD 93 88         CALL    VDP_PrintString
 101+ 9247 21 A2 80         LD      HL, TXT_BTN_PLY2_3
 102+ 924A 16 08            LD      D, 8
 103+ 924C 1E 18            LD      E, 24
 104+ 924E CD 93 88         CALL    VDP_PrintString
 105+ 9251 21 A9 80         LD      HL, TXT_BTN_PLY2_4
 106+ 9254 16 09            LD      D, 9
 107+ 9256 1E 18            LD      E, 24
 108+ 9258 CD 93 88         CALL    VDP_PrintString
 109+ 925B 21 B1 80         LD      HL, TXT_BTN_PLY2_5
 110+ 925E 16 0A            LD      D, 10
 111+ 9260 1E 18            LD      E, 24
 112+ 9262 CD 93 88         CALL    VDP_PrintString
 113+ 9265 CD E1 92         CALL    .Start
 114+ 9268
 115+ 9268
 116+ 9268              .Level1
 117+ 9268 21 63 80         LD      HL, TXT_LEVEL_NO
 118+ 926B 16 0E            LD      D, 14
 119+ 926D 1E 17            LD      E, 23
 120+ 926F CD 93 88         CALL    VDP_PrintString
 121+ 9272 3A 2F B2         LD      A, (Var_Game_SelectedPlayers)
 122+ 9275 FE 02            CP      GAME_MODE_2_PLAYERS
 123+ 9277 CA E1 92         JP      Z, .Start
 124+ 927A
 125+ 927A 3E 3F            LD      A, 63
 126+ 927C 16 0E            LD      D, 14
 127+ 927E 1E 1D            LD      E, 29
 128+ 9280 CD 9F 88         CALL    VDP_PrintRamChar
 129+ 9283
 130+ 9283 3A 09 B2         LD      A, (Var_Game_SelectedLevel)
 131+ 9286 FE 01            CP      1
 132+ 9288 C2 98 92         JP      NZ, .Level2
 133+ 928B 21 40 80         LD      HL, TXT_LEVEL_1
 134+ 928E 16 0E            LD      D, 14
 135+ 9290 1E 17            LD      E, 23
 136+ 9292 CD 93 88         CALL    VDP_PrintString
 137+ 9295 C3 E1 92         JP      .Start
 138+ 9298              .Level2:
 139+ 9298 3A 09 B2         LD      A, (Var_Game_SelectedLevel)
 140+ 929B FE 02            CP      2
 141+ 929D C2 AD 92         JP      NZ, .Level3
 142+ 92A0 21 47 80         LD      HL, TXT_LEVEL_2
 143+ 92A3 16 0E            LD      D, 14
 144+ 92A5 1E 17            LD      E, 23
 145+ 92A7 CD 93 88         CALL    VDP_PrintString
 146+ 92AA C3 E1 92         JP      .Start
 147+ 92AD              .Level3:
 148+ 92AD 3A 09 B2         LD      A, (Var_Game_SelectedLevel)
 149+ 92B0 FE 03            CP      3
 150+ 92B2 C2 C2 92         JP      NZ, .Level4
 151+ 92B5 21 4E 80         LD      HL, TXT_LEVEL_3
 152+ 92B8 16 0E            LD      D, 14
 153+ 92BA 1E 17            LD      E, 23
 154+ 92BC CD 93 88         CALL    VDP_PrintString
 155+ 92BF C3 E1 92         JP      .Start
 156+ 92C2              .Level4:
 157+ 92C2 3A 09 B2         LD      A, (Var_Game_SelectedLevel)
 158+ 92C5 FE 04            CP      4
 159+ 92C7 C2 D7 92         JP      NZ, .Level5
 160+ 92CA 21 55 80         LD      HL, TXT_LEVEL_4
 161+ 92CD 16 0E            LD      D, 14
 162+ 92CF 1E 17            LD      E, 23
 163+ 92D1 CD 93 88         CALL    VDP_PrintString
 164+ 92D4 C3 E1 92         JP      .Start
 165+ 92D7              .Level5:
 166+ 92D7 21 5C 80         LD      HL, TXT_LEVEL_5
 167+ 92DA 16 0E            LD      D, 14
 168+ 92DC 1E 17            LD      E, 23
 169+ 92DE CD 93 88         CALL    VDP_PrintString
 170+ 92E1              .Start:
 171+ 92E1 21 B9 80         LD      HL, TXT_SPACE
 172+ 92E4 16 11            LD      D, 17
 173+ 92E6 1E 17            LD      E, 23
 174+ 92E8 CD 93 88         CALL    VDP_PrintString
 175+ 92EB 21 C1 80         LD      HL, TXT_START
 176+ 92EE 16 12            LD      D, 18
 177+ 92F0 1E 17            LD      E, 23
 178+ 92F2 CD 93 88         CALL    VDP_PrintString
 179+ 92F5 21 CA 80         LD      HL, TXT_GSSOCCER
 180+ 92F8 16 16            LD      D, 22
 181+ 92FA 1E 17            LD      E, 23
 182+ 92FC CD 93 88         CALL    VDP_PrintString
 183+ 92FF 21 D3 80         LD      HL, TXT_2025
 184+ 9302 16 15            LD      D, 21
 185+ 9304 1E 17            LD      E, 23
 186+ 9306 CD 93 88         CALL    VDP_PrintString
 187+ 9309 21 D8 80         LD      HL, TXT_PRACEK
 188+ 930C 16 17            LD      D, 23
 189+ 930E 1E 17            LD      E, 23
 190+ 9310 CD 93 88         CALL    VDP_PrintString
 191+ 9313 C9               RET
 192+ 9314
 193+ 9314
# file closed: ./inc/menu.asm
  17  9314                  INCLUDE "utils.asm"                     ; Include utilities library
# file opened: ./inc/utils.asm
   1+ 9314              ; ===================================================================
   2+ 9314              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 9314              ; ===================================================================
   4+ 9314
   5+ 9314              ; *** UTILS.ASM ***
   6+ 9314
   7+ 9314              ; ------ ROUTINES ------
   8+ 9314
   9+ 9314
  10+ 9314
  11+ 9314
  12+ 9314              ; ---------------------------------------------------------------------------
  13+ 9314              ; Reads keyboard and returns a code if one of the arrows or SPACE is pressed.
  14+ 9314              ; INPUT: -
  15+ 9314              ; OUTPUT:
  16+ 9314              ;   A = KEY_XXX constant, or 0 if no relevant key is pressed
  17+ 9314              ; MODIFIES:
  18+ 9314              ;   AF, BC, HL
  19+ 9314              ; ---------------------------------------------------------------------------
  20+ 9314
  21+ 9314              ; ------ ROUTINES ------
  22+ 9314
  23+ 9314
  24+ 9314
  25+ 9314              ; ---------------------------------------------------------------------------
  26+ 9314              ; Reads keyboard and returns a code if one of the arrows or SPACE is pressed.
  27+ 9314              ; INPUT: -
  28+ 9314              ; OUTPUT:
  29+ 9314              ;   A = KEY_XXX constant, or 0 if no relevant key is pressed
  30+ 9314              ; MODIFIES:
  31+ 9314              ;   AF, BC, HL
  32+ 9314              ; ---------------------------------------------------------------------------
  33+ 9314
  34+ 9314              ; ------ ROUTINES ------
  35+ 9314
  36+ 9314
  37+ 9314
  38+ 9314
  39+ 9314              ;------------------------------------------------------------------------
  40+ 9314              ; Read the keyboard
  41+ 9314              ; INPUT: -
  42+ 9314              ; OUTPUT:
  43+ 9314              ;   A: ASCII code of key pressed
  44+ 9314              ; MODIFY: HL, BC, AF
  45+ 9314              ;------------------------------------------------------------------------
  46+ 9314              Utils_ReadKeyboard:
  47+ 9314 21 00 80         LD  HL,KEYBOARD_MAP     ; Point HL at the keyboard list
  48+ 9317 16 08            LD  D, 8                ; This is the number of ports (rows) to check
  49+ 9319 0E FE            LD  C, #FE              ; C is always FEh for reading keyboard ports
  50+ 931B              .ReadKeyboard0:
  51+ 931B 46               LD  B, (HL)             ; Get the keyboard port address from table
  52+ 931C 23               INC HL                  ; Increment to list of keys
  53+ 931D ED 78            IN  A, (C)              ; Read the row of keys in
  54+ 931F E6 1F            AND #1F                 ; We are only interested in the first five bits
  55+ 9321 1E 05            LD  E, 5                ; This is the number of keys in the row
  56+ 9323              .ReadKeyboard1:
  57+ 9323 CB 3F            SRL A                   ; Shift A right; bit 0 sets carry bit
  58+ 9325 D2 36 93         JP  NC, .ReadKeyboard2   ; If the bit is 0, we've found our key
  59+ 9328 23               INC HL                  ; Go to next table address
  60+ 9329 1D               DEC E                   ; Decrement key loop counter
  61+ 932A C2 23 93         JP  NZ, .ReadKeyboard1   ; Loop around until this row finished
  62+ 932D 15               DEC D                   ; Decrement row loop counter
  63+ 932E C2 1B 93         JP  NZ, .ReadKeyboard0   ; Loop around until we are done
  64+ 9331 A7               AND A                   ; Clear A (no key found)
  65+ 9332 32 04 B2         LD  (Var_Utils_LastKbdKeyPressed), A
  66+ 9335 C9               RET
  67+ 9336              .ReadKeyboard2:
  68+ 9336 7E               LD  A, (HL)             ; We've found a key at this point; fetch the character code!
  69+ 9337 47               LD  B, A
  70+ 9338 3A 04 B2         LD  A,(Var_Utils_LastKbdKeyPressed)
  71+ 933B FE 00            CP  0
  72+ 933D CA 46 93         JP  Z, .ReadKeyboard3    ; If no key pressed before, skip the check
  73+ 9340 B8               CP  B                   ; Check if the key is the same as the last one pressed
  74+ 9341 C2 46 93         JP  NZ, .ReadKeyboard3    ; If it is, skip the rest of this routine
  75+ 9344 AF               XOR A               ; If it is the same, clear A (no key found)
  76+ 9345 C9               RET
  77+ 9346              .ReadKeyboard3:
  78+ 9346 78               LD  A, B
  79+ 9347 32 04 B2         LD  (Var_Utils_LastKbdKeyPressed), A
  80+ 934A 32 06 B2         LD  (Var_Utils_KbdKeyPressed), A
  81+ 934D C9               RET
  82+ 934E
  83+ 934E
  84+ 934E
  85+ 934E
  86+ 934E
  87+ 934E
  88+ 934E              ;------------------------------------------------------------------------
  89+ 934E              ; Utils_GetRandomNumber
  90+ 934E              ; OUTPUT: A = 0..127  (uniforme-ish)
  91+ 934E              ; MODIFIES: A, BC
  92+ 934E              ;------------------------------------------------------------------------
  93+ 934E              Utils_GetRandomNumber:
  94+ 934E 3A FC B1         LD   A,(Var_Utils_OldRnd)
  95+ 9351 4F               LD   C,A
  96+ 9352
  97+ 9352                  ; s = s*33 + R  (33 = 32 + 1)
  98+ 9352 87               ADD  A,A         ; 2
  99+ 9353 87               ADD  A,A         ; 4
 100+ 9354 87               ADD  A,A         ; 8
 101+ 9355 87               ADD  A,A         ; 16
 102+ 9356 87               ADD  A,A         ; 32
 103+ 9357 81               ADD  A,C         ; *33
 104+ 9358 4F               LD   C,A
 105+ 9359 ED 5F            LD   A,R
 106+ 935B 81               ADD  A,C
 107+ 935C
 108+ 935C 32 FC B1         LD   (Var_Utils_OldRnd),A
 109+ 935F E6 7F            AND  127         ; 0..127
 110+ 9361 C9               RET
 111+ 9362
 112+ 9362
 113+ 9362
 114+ 9362              ; --------------------------------------------------
 115+ 9362              ; Play beep
 116+ 9362              ; INPUT:
 117+ 9362              ;   B: Number of toggles
 118+ 9362              ;   C: Delay loop
 119+ 9362              ; --------------------------------------------------
 120+ 9362              PlayBeep:
 121+ 9362 C5               PUSH BC
 122+ 9363 3E 10            LD   A, 16          ; 0001 0000 → beeper ON
 123+ 9365              .BeepLoop:
 124+ 9365 D3 FE            OUT  (254), A       ; accendi
 125+ 9367 CD 75 93         CALL DelayHalf
 126+ 936A AF               XOR  A              ; A=0 → beeper OFF
 127+ 936B D3 FE            OUT  (254), A       ; spegni
 128+ 936D CD 75 93         CALL DelayHalf
 129+ 9370 05               DEC  B
 130+ 9371 20 F2            JR   NZ, .BeepLoop
 131+ 9373 C1               POP  BC
 132+ 9374 C9               RET
 133+ 9375
 134+ 9375              DelayHalf:
 135+ 9375 51               LD   D, C
 136+ 9376              .DH:
 137+ 9376 15               DEC  D
 138+ 9377 20 FD            JR   NZ, .DH
 139+ 9379 C9               RET
 140+ 937A
 141+ 937A
 142+ 937A
 143+ 937A
 144+ 937A              ; Genera un beep usando PSG con impostazioni sicure
 145+ 937A              Utils_PlayBeep:
 146+ 937A 06 50            ld  b,80        ; durata
 147+ 937C 16 18            ld  d,24        ; pitch (più basso = più acuto)
 148+ 937E CD 62 93         call PlayBeep
 149+ 9381 C9               RET
 150+ 9382
 151+ 9382              ;-----------------------------------------
 152+ 9382              ; Utils_PlayBeepGoalCorner - Beep più acuto (MSX)
 153+ 9382              ; Usa solo canale A, salva/ripristina mixer e volume
 154+ 9382              ;-----------------------------------------
 155+ 9382              Utils_PlayBeepGoalCorner:
 156+ 9382 06 50            ld  b,80        ; durata
 157+ 9384 16 04            ld  d,4         ; pitch (più basso = più acuto)
 158+ 9386 CD 62 93         call PlayBeep
 159+ 9389 C9               RET
 160+ 938A              Utils_PlayBeepHighLong:
 161+ 938A                  ;ld  b,80        ; durata
 162+ 938A                  ;ld  d,10         ; pitch (più basso = più acuto)
 163+ 938A                  ;call PlayBeep
 164+ 938A C9               RET
 165+ 938B
 166+ 938B
 167+ 938B
 168+ 938B
 169+ 938B
 170+ 938B
 171+ 938B
 172+ 938B
 173+ 938B              ; ------------------------------------------------------------
 174+ 938B              ; Var_Game_BeepStep (BYTE in RAM) - definiscila tu nel tuo blocco variabili
 175+ 938B              ; Var_Game_BeepStep: DB 0
 176+ 938B              ; ------------------------------------------------------------
 177+ 938B
 178+ 938B
 179+ 938B              ; ------------------------------------------------------------
 180+ 938B              ; Utils_PlayBeepTick
 181+ 938B              ; Un solo beep breve (ta).
 182+ 938B              ; Ogni chiamata usa il prossimo periodo: 250,235,220,205 (ciclico)
 183+ 938B              ; Suono più simile al BASIC: micro-decay 12->8->0 + tiny delay
 184+ 938B              ; ------------------------------------------------------------
 185+ 938B              Utils_PlayBeepTick:
 186+ 938B 3A 2C B2         ld  a, (Var_Game_MatchInProgress)
 187+ 938E FE 00            cp  NO
 188+ 9390 C8               RET Z
 189+ 9391 06 50            ld  b,80        ; durata
 190+ 9393 16 0A            ld  d,10         ; pitch (più basso = più acuto)
 191+ 9395 CD 62 93         call PlayBeep
 192+ 9398 C9               RET
 193+ 9399
 194+ 9399
 195+ 9399
 196+ 9399
 197+ 9399              ; ------------------------------------------------------------
 198+ 9399              ; Utils_ResetBeepTick
 199+ 9399              ; ------------------------------------------------------------
 200+ 9399              Utils_ResetBeepTick:
 201+ 9399 AF               XOR  A
 202+ 939A 32 33 B2         LD   (Var_Game_BeepStep),A
 203+ 939D C9               RET
 204+ 939E
 205+ 939E
# file closed: ./inc/utils.asm
  18  939E                  INCLUDE "game.asm"                      ; Include game library
# file opened: ./inc/game.asm
   1+ 939E
   2+ 939E              ; ===================================================================
   3+ 939E              ; GS11-Soccer - 2025 Fausto Pracek
   4+ 939E              ; ===================================================================
   5+ 939E
   6+ 939E              ; *** GAME.ASM ***
   7+ 939E
   8+ 939E              ; ------ ROUTINES ------
   9+ 939E              Game_InitVariables:
  10+ 939E 3E FF            LD      A, NO_VALUE
  11+ 93A0 32 31 B2         LD      (Var_Game_FirstKickType), A
  12+ 93A3 3E 00            LD      A, NO
  13+ 93A5 32 FD B1         LD      (Var_Utils_VblankStopped), A
  14+ 93A8 32 82 B2         LD      (Var_Hooks_ForceVdpRedraw), A
  15+ 93AB 32 7C B2         LD      (Var_Hooks_GameResumingWaiting), A
  16+ 93AE 3E 01            LD      A, GAME_MODE_1_PLAYER
  17+ 93B0 32 2F B2         LD      (Var_Game_SelectedPlayers), A
  18+ 93B3 3E 00            LD      A, NO
  19+ 93B5 32 2C B2         LD      (Var_Game_MatchInProgress), A
  20+ 93B8 3E 02            LD      A, 2
  21+ 93BA 32 22 B2         LD      (Var_Game_HumanPlayerSpeed), A
  22+ 93BD AF               XOR     A
  23+ 93BE 32 0E B2         LD      (Var_Game_BallUpdateTimer), A
  24+ 93C1 32 84 B2         LD      (Var_Hooks_GoalCerimonyCounter), A
  25+ 93C4 CD AD 86         CALL    Hooks_InitAICounters
  26+ 93C7 CD 59 9E         CALL    Game_StopShot
  27+ 93CA C9               RET
  28+ 93CB
  29+ 93CB
  30+ 93CB              ; ---------------------------------------------------------------------------
  31+ 93CB              ; Game_CheckVerticalShotPossessionStop
  32+ 93CB              ;
  33+ 93CB              ; INPUT:
  34+ 93CB              ;   D = BallY
  35+ 93CB              ;   E = BallX
  36+ 93CB              ; ---------------------------------------------------------------------------
  37+ 93CB              Game_CheckVerticalShotPossessionStop:
  38+ 93CB F5               push af
  39+ 93CC C5               push bc
  40+ 93CD D5               push de
  41+ 93CE E5               push hl
  42+ 93CF
  43+ 93CF                  ; ---------------------------
  44+ 93CF                  ; Check NERI: match esatto (Y,X)  ID 1..3
  45+ 93CF                  ; ---------------------------
  46+ 93CF 06 00            ld   b,TEAM_BLACK
  47+ 93D1 0E 01            ld   c,1
  48+ 93D3              .chk_black_loop:
  49+ 93D3 D5               push de
  50+ 93D4 CD 59 96         call Game_GetPlayerInfoById      ; HL = cur (H=Y, L=X)
  51+ 93D7 D1               pop  de
  52+ 93D8
  53+ 93D8 7C               ld   a,h
  54+ 93D9 BA               cp   d
  55+ 93DA 20 09            jr   nz,.chk_black_next
  56+ 93DC 7D               ld   a,l
  57+ 93DD BB               cp   e
  58+ 93DE 20 05            jr   nz,.chk_black_next
  59+ 93E0
  60+ 93E0 CD 59 9E         call Game_StopShot
  61+ 93E3 18 3B            jr   .done
  62+ 93E5
  63+ 93E5              .chk_black_next:
  64+ 93E5 0C               inc  c
  65+ 93E6 79               ld   a,c
  66+ 93E7 FE 04            cp   4
  67+ 93E9 20 E8            jr   nz,.chk_black_loop
  68+ 93EB
  69+ 93EB                  ; ---------------------------
  70+ 93EB                  ; Check BIANCHI: match su (BallY+1, BallX)  ID 1..3
  71+ 93EB                  ; ---------------------------
  72+ 93EB 06 01            ld   b,TEAM_WHITE
  73+ 93ED 0E 01            ld   c,1
  74+ 93EF              .chk_white_loop:
  75+ 93EF D5               push de
  76+ 93F0 CD 59 96         call Game_GetPlayerInfoById      ; HL = cur (H=Y, L=X)
  77+ 93F3 D1               pop  de
  78+ 93F4
  79+ 93F4 7A               ld   a,d
  80+ 93F5 3C               inc  a                           ; targetY = BallY+1
  81+ 93F6 BC               cp   h
  82+ 93F7 20 09            jr   nz,.chk_white_next
  83+ 93F9
  84+ 93F9 7B               ld   a,e
  85+ 93FA BD               cp   l
  86+ 93FB 20 05            jr   nz,.chk_white_next
  87+ 93FD
  88+ 93FD CD 59 9E         call Game_StopShot
  89+ 9400 18 1E            jr   .done
  90+ 9402
  91+ 9402              .chk_white_next:
  92+ 9402 0C               inc  c
  93+ 9403 79               ld   a,c
  94+ 9404 FE 04            cp   4
  95+ 9406 20 E7            jr   nz,.chk_white_loop
  96+ 9408
  97+ 9408                  ; ------------------------------------------------------------
  98+ 9408                  ; Nessun possesso: verifica stop per fondo campo del lato attuale
  99+ 9408                  ; e/o cambio metà campo
 100+ 9408                  ; ------------------------------------------------------------
 101+ 9408 3A 07 B2         ld   a,(Var_Game_ActiveFieldSide)
 102+ 940B FE 00            cp   FIELD_SOUTH_SIDE
 103+ 940D 20 0A            jr   nz,.field_is_north
 104+ 940F
 105+ 940F              ; ===== CAMPO SOUTH =====
 106+ 940F                  ; Se palla su riga 4 -> fondo campo / porta: stop tiro
 107+ 940F 7A               ld   a,d
 108+ 9410 FE 04            cp   4
 109+ 9412 20 0C            jr   nz,.done
 110+ 9414 CD 59 9E         call Game_StopShot
 111+ 9417 18 07            jr   .done
 112+ 9419
 113+ 9419
 114+ 9419
 115+ 9419              ; ===== CAMPO NORTH =====
 116+ 9419              .field_is_north:
 117+ 9419                  ; Se palla su riga 0 -> fondo campo / porta: stop tiro
 118+ 9419 7A               ld   a,d
 119+ 941A B7               or   a
 120+ 941B 20 03            jr   nz,.done
 121+ 941D CD 59 9E         call Game_StopShot
 122+ 9420
 123+ 9420              .done:
 124+ 9420 E1               pop  hl
 125+ 9421 D1               pop  de
 126+ 9422 C1               pop  bc
 127+ 9423 F1               pop  af
 128+ 9424 C9               ret
 129+ 9425
 130+ 9425
 131+ 9425
 132+ 9425
 133+ 9425              ; ---------------------------------------------------------------------------
 134+ 9425              ; Game_UpdateBallMovement
 135+ 9425              ; Da chiamare a ogni tick (AiTick) per muovere la palla se in tiro.
 136+ 9425              ;
 137+ 9425              ; Usa:
 138+ 9425              ;   Var_Game_BallDirection
 139+ 9425              ;   Var_Game_BallDiagonalMovCounter (0 normale, 255 caso speciale)
 140+ 9425              ;
 141+ 9425              ; Convenzioni:
 142+ 9425              ;   Game_GetBallPosition -> DE  (D=Y, E=X)
 143+ 9425              ;   Game_SetBallPosition usa DE (D=Y, E=X)
 144+ 9425              ;
 145+ 9425              ; Regole:
 146+ 9425              ; - Se BallDirection = NONE -> nessun movimento
 147+ 9425              ; - Caso speciale counter=255 (solo WHITE attaccante, campo NORTH, Y=2):
 148+ 9425              ;     * NORTH: primo tick = nessun movimento, counter->0
 149+ 9425              ;     * NE/NW: primo tick = solo laterale, counter->0
 150+ 9425              ; - Diagonali: ogni tick muove Y e prova a muovere X; se X è già al bordo
 151+ 9425              ;   che impedisce la diagonale, X non cambia ma il tick conta comunque.
 152+ 9425              ; - Il counter aumenta SEMPRE per direzioni diverse da:
 153+ 9425              ;       BALL_DIRECTION_NONE, BALL_DIRECTION_NORTH, BALL_DIRECTION_SOUTH
 154+ 9425              ; - Se (counter == 2) prima di uscire: Game_StopShot (stop definitivo tiro)
 155+ 9425              ; ---------------------------------------------------------------------------
 156+ 9425              Game_UpdateBallMovement:
 157+ 9425
 158+ 9425 3A 82 B2         ld    a,(Var_Hooks_ForceVdpRedraw)
 159+ 9428 FE 01            cp    YES
 160+ 942A C8               ret   z
 161+ 942B 3A 0E B2         LD    A, (Var_Game_BallUpdateTimer)
 162+ 942E 3C               inc   a
 163+ 942F 32 0E B2         LD    (Var_Game_BallUpdateTimer), A
 164+ 9432 FE 0A            CP    10
 165+ 9434 C0               RET    NZ
 166+ 9435 AF               XOR   A
 167+ 9436 32 0E B2         LD    (Var_Game_BallUpdateTimer), A
 168+ 9439
 169+ 9439 F5               push af
 170+ 943A C5               push bc
 171+ 943B D5               push de
 172+ 943C E5               push hl
 173+ 943D
 174+ 943D                  ; se palla ferma -> niente
 175+ 943D 3A 27 B2         ld   a,(Var_Game_BallDirection)
 176+ 9440 FE 00            cp   BALL_DIRECTION_NONE
 177+ 9442 CA 8D 95         jp   z,.done
 178+ 9445
 179+ 9445                  ; forza redraw
 180+ 9445 3E 01            ld   a,YES
 181+ 9447 32 82 B2         ld   (Var_Hooks_ForceVdpRedraw),a
 182+ 944A
 183+ 944A                  ; DE = (Y,X)
 184+ 944A CD 92 95         call Game_GetBallPosition         ; D=Y, E=X
 185+ 944D
 186+ 944D                  ; ------------------------------------------------------------
 187+ 944D                  ; Caso speciale "first tick grafico" (counter=255)
 188+ 944D                  ; ------------------------------------------------------------
 189+ 944D 3A 28 B2         ld   a,(Var_Game_BallDiagonalMovCounter)
 190+ 9450 FE FF            cp   255
 191+ 9452 20 3B            jr   nz,.normal_move
 192+ 9454
 193+ 9454 3A 27 B2         ld   a,(Var_Game_BallDirection)
 194+ 9457 FE 01            cp   BALL_DIRECTION_NORTH
 195+ 9459 28 0E            jr   z,.special_north
 196+ 945B FE 02            cp   BALL_DIRECTION_NORTH_EAST
 197+ 945D 28 11            jr   z,.special_ne
 198+ 945F FE 03            cp   BALL_DIRECTION_NORTH_WEST
 199+ 9461 28 1D            jr   z,.special_nw
 200+ 9463
 201+ 9463                  ; se per errore 255 con altre direzioni, normalizza
 202+ 9463 AF               xor  a
 203+ 9464 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
 204+ 9467 18 26            jr   .normal_move
 205+ 9469
 206+ 9469              .special_north:
 207+ 9469                  ; primo tick: nessun movimento, solo marker grafico.
 208+ 9469 AF               xor  a
 209+ 946A 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
 210+ 946D C3 83 95         jp   .done_check2
 211+ 9470
 212+ 9470              .special_ne:
 213+ 9470                  ; primo tick: solo laterale (X+1 se possibile)
 214+ 9470 7B               ld   a,e
 215+ 9471 FE 04            cp   4
 216+ 9473 28 04            jr   z,.special_ne_clear
 217+ 9475 1C               inc  e
 218+ 9476 CD 9D 95         call Game_SetBallPosition
 219+ 9479              .special_ne_clear:
 220+ 9479 AF               xor  a
 221+ 947A 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
 222+ 947D C3 83 95         jp   .done_check2
 223+ 9480
 224+ 9480              .special_nw:
 225+ 9480                  ; primo tick: solo laterale (X-1 se possibile)
 226+ 9480 7B               ld   a,e
 227+ 9481 B7               or   a
 228+ 9482 28 04            jr   z,.special_nw_clear
 229+ 9484 1D               dec  e
 230+ 9485 CD 9D 95         call Game_SetBallPosition
 231+ 9488              .special_nw_clear:
 232+ 9488 AF               xor  a
 233+ 9489 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
 234+ 948C C3 83 95         jp   .done_check2
 235+ 948F
 236+ 948F
 237+ 948F              ; ------------------------------------------------------------
 238+ 948F              ; Movimento normale
 239+ 948F              ; ------------------------------------------------------------
 240+ 948F              .normal_move:
 241+ 948F
 242+ 948F
 243+ 948F                  ; --- incremento counter SOLO se direzione è diagonale ---
 244+ 948F 3A 27 B2         ld   a,(Var_Game_BallDirection)
 245+ 9492 FE 00            cp   BALL_DIRECTION_NONE
 246+ 9494 28 0F            jr   z,.skip_counter_inc
 247+ 9496 FE 01            cp   BALL_DIRECTION_NORTH
 248+ 9498 28 0B            jr   z,.skip_counter_inc
 249+ 949A FE 04            cp   BALL_DIRECTION_SOUTH
 250+ 949C 28 07            jr   z,.skip_counter_inc
 251+ 949E
 252+ 949E 3A 28 B2         ld   a,(Var_Game_BallDiagonalMovCounter)
 253+ 94A1 3C               inc  a
 254+ 94A2 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
 255+ 94A5              .skip_counter_inc:
 256+ 94A5
 257+ 94A5 3E 01            ld a, YES
 258+ 94A7 32 82 B2         ld    (Var_Hooks_ForceVdpRedraw), a
 259+ 94AA
 260+ 94AA                  ; dispatch direzione
 261+ 94AA 3A 27 B2         ld   a,(Var_Game_BallDirection)
 262+ 94AD
 263+ 94AD FE 01            cp   BALL_DIRECTION_NORTH
 264+ 94AF 28 1E            jr   z,.move_north
 265+ 94B1
 266+ 94B1 FE 04            cp   BALL_DIRECTION_SOUTH
 267+ 94B3 28 57            jr   z,.move_south
 268+ 94B5
 269+ 94B5 FE 02            cp   BALL_DIRECTION_NORTH_EAST
 270+ 94B7 CA 47 95         jp   z,.move_ne
 271+ 94BA
 272+ 94BA FE 03            cp   BALL_DIRECTION_NORTH_WEST
 273+ 94BC CA 54 95         jp   z,.move_nw
 274+ 94BF
 275+ 94BF FE 05            cp   BALL_DIRECTION_SOUTH_EAST
 276+ 94C1 CA 60 95         jp   z,.move_se
 277+ 94C4
 278+ 94C4 FE 06            cp   BALL_DIRECTION_SOUTH_WEST
 279+ 94C6 CA 6E 95         jp   z,.move_sw
 280+ 94C9
 281+ 94C9                  ; direzione sconosciuta -> stop
 282+ 94C9 CD 59 9E         call Game_StopShot
 283+ 94CC C3 8D 95         jp   .done
 284+ 94CF
 285+ 94CF
 286+ 94CF              .move_north:
 287+ 94CF 15               dec     d
 288+ 94D0 7A               ld      a,d
 289+ 94D1 FE FF            cp      255
 290+ 94D3 20 2F            jr      nz,.move_north_continue
 291+ 94D5 14               inc     d
 292+ 94D6 3A 07 B2         ld      a, (Var_Game_ActiveFieldSide)
 293+ 94D9 FE 01            cp      FIELD_NORTH_SIDE
 294+ 94DB CA 7E 95         jp      z,.stop_now
 295+ 94DE CD 58 81         CALL    Hooks_TickStop
 296+ 94E1 3E 01            LD      A, FIELD_NORTH_SIDE
 297+ 94E3 32 07 B2         LD      (Var_Game_ActiveFieldSide),A
 298+ 94E6 CD A3 8B         CALL    VDP_DrawField
 299+ 94E9 CD B4 A2         CALL    Game_PutPlayersToNewFieldSide
 300+ 94EC 3E 01            ld      a,YES
 301+ 94EE 32 82 B2         ld      (Var_Hooks_ForceVdpRedraw),a
 302+ 94F1 CD 92 95         CALL    Game_GetBallPosition
 303+ 94F4 16 04            LD      D, 4
 304+ 94F6 CD 9D 95         CALL    Game_SetBallPosition
 305+ 94F9 3E FF            LD      A, NO_VALUE
 306+ 94FB 32 35 B2         LD      (Var_Game_BallYOldPosition), A
 307+ 94FE CD 50 81         CALL    Hooks_TickStart
 308+ 9501 C3 8D 95         jp      .done
 309+ 9504              .move_north_continue:
 310+ 9504 CD 9D 95         call Game_SetBallPosition
 311+ 9507
 312+ 9507                  ; --- NUOVO: stop se diventa possesso (verticale puro) ---
 313+ 9507 CD CB 93         call Game_CheckVerticalShotPossessionStop
 314+ 950A
 315+ 950A 18 77            jr   .done_check2
 316+ 950C
 317+ 950C
 318+ 950C              .move_south:
 319+ 950C 14               inc     d
 320+ 950D 7A               ld      a,d
 321+ 950E FE 05            cp      5
 322+ 9510 20 2D            jr      nz,.move_south_continue
 323+ 9512 15               dec     d
 324+ 9513 3A 07 B2         ld      a, (Var_Game_ActiveFieldSide)
 325+ 9516 FE 00            cp      FIELD_SOUTH_SIDE
 326+ 9518 28 64            jr      z,.stop_now
 327+ 951A CD 58 81         CALL    Hooks_TickStop
 328+ 951D 3E 00            LD      A, FIELD_SOUTH_SIDE
 329+ 951F 32 07 B2         LD      (Var_Game_ActiveFieldSide),A
 330+ 9522 CD A3 8B         CALL    VDP_DrawField
 331+ 9525 CD B4 A2         CALL    Game_PutPlayersToNewFieldSide
 332+ 9528 3E 01            ld      a,YES
 333+ 952A 32 82 B2         ld      (Var_Hooks_ForceVdpRedraw),a
 334+ 952D CD 92 95         CALL    Game_GetBallPosition
 335+ 9530 16 00            LD      D, 0
 336+ 9532 CD 9D 95         CALL    Game_SetBallPosition
 337+ 9535 3E FF            LD      A, NO_VALUE
 338+ 9537 32 35 B2         LD      (Var_Game_BallYOldPosition), A
 339+ 953A CD 50 81         CALL    Hooks_TickStart
 340+ 953D 18 4E            jr      .done
 341+ 953F
 342+ 953F              .move_south_continue:
 343+ 953F CD 9D 95         call Game_SetBallPosition
 344+ 9542
 345+ 9542                  ; --- NUOVO: stop se diventa possesso (verticale puro) ---
 346+ 9542 CD CB 93         call Game_CheckVerticalShotPossessionStop
 347+ 9545
 348+ 9545 18 3C            jr   .done_check2
 349+ 9547
 350+ 9547              ; Diagonali: muove SEMPRE Y, e X solo se non uscirebbe dal bordo.
 351+ 9547              .move_ne:
 352+ 9547                  ; Y--
 353+ 9547 7A               ld   a,d
 354+ 9548 B7               or   a
 355+ 9549 28 33            jr   z,.stop_now
 356+ 954B 15               dec  d
 357+ 954C                  ; X++ se possibile
 358+ 954C 7B               ld   a,e
 359+ 954D FE 04            cp   4
 360+ 954F 28 28            jr   z,.set_pos_only      ; a bordo -> solo verticale
 361+ 9551 1C               inc  e
 362+ 9552 18 25            jr   .set_pos_only
 363+ 9554
 364+ 9554              .move_nw:
 365+ 9554                  ; Y--
 366+ 9554 7A               ld   a,d
 367+ 9555 B7               or   a
 368+ 9556 28 26            jr   z,.stop_now
 369+ 9558 15               dec  d
 370+ 9559                  ; X-- se possibile
 371+ 9559 7B               ld   a,e
 372+ 955A B7               or   a
 373+ 955B 28 1C            jr   z,.set_pos_only
 374+ 955D 1D               dec  e
 375+ 955E 18 19            jr   .set_pos_only
 376+ 9560
 377+ 9560              .move_se:
 378+ 9560                  ; Y++
 379+ 9560 7A               ld   a,d
 380+ 9561 FE 04            cp   4
 381+ 9563 28 19            jr   z,.stop_now
 382+ 9565 14               inc  d
 383+ 9566                  ; X++ se possibile
 384+ 9566 7B               ld   a,e
 385+ 9567 FE 04            cp   4
 386+ 9569 28 0E            jr   z,.set_pos_only
 387+ 956B 1C               inc  e
 388+ 956C 18 0B            jr   .set_pos_only
 389+ 956E
 390+ 956E              .move_sw:
 391+ 956E                  ; Y++
 392+ 956E 7A               ld   a,d
 393+ 956F FE 04            cp   4
 394+ 9571 28 0B            jr   z,.stop_now
 395+ 9573 14               inc  d
 396+ 9574                  ; X-- se possibile
 397+ 9574 7B               ld   a,e
 398+ 9575 B7               or   a
 399+ 9576 28 01            jr   z,.set_pos_only
 400+ 9578 1D               dec  e
 401+ 9579
 402+ 9579              .set_pos_only:
 403+ 9579 CD 9D 95         call Game_SetBallPosition
 404+ 957C 18 05            jr   .done_check2
 405+ 957E
 406+ 957E
 407+ 957E              .stop_now:
 408+ 957E CD 59 9E         call Game_StopShot
 409+ 9581 18 0A            jr   .done
 410+ 9583
 411+ 9583
 412+ 9583              ; ------------------------------------------------------------
 413+ 9583              ; Check fine tiro dopo 2 tick (vale SOLO per diagonali perché
 414+ 9583              ; il counter viene incrementato solo in quei casi).
 415+ 9583              ; ------------------------------------------------------------
 416+ 9583              .done_check2:
 417+ 9583 3A 28 B2         ld   a,(Var_Game_BallDiagonalMovCounter)
 418+ 9586 FE 02            cp   2
 419+ 9588 20 03            jr   nz,.done
 420+ 958A CD 59 9E         call Game_StopShot
 421+ 958D
 422+ 958D              .done:
 423+ 958D E1               pop  hl
 424+ 958E D1               pop  de
 425+ 958F C1               pop  bc
 426+ 9590 F1               pop  af
 427+ 9591 C9               ret
 428+ 9592
 429+ 9592
 430+ 9592
 431+ 9592              ;------------------------------------------------------------------------
 432+ 9592              ; Get ball position
 433+ 9592              ; INPUT: -
 434+ 9592              ; OUTPUT: DE = X,Y
 435+ 9592              ; MODIFIES: -
 436+ 9592              ;------------------------------------------------------------------------
 437+ 9592              Game_GetBallPosition:
 438+ 9592 F5               PUSH    AF
 439+ 9593 3A 30 B2         LD      A, (Var_Game_BallXPosition)
 440+ 9596 5F               LD      E, A
 441+ 9597 3A 34 B2         LD      A, (Var_Game_BallYPosition)
 442+ 959A 57               LD      D, A
 443+ 959B F1               POP     AF
 444+ 959C C9               RET
 445+ 959D              ;------------------------------------------------------------------------
 446+ 959D              ; Set ball position
 447+ 959D              ; INPUT:  D = Y, E = X   (coordinate di matrice 0..4)
 448+ 959D              ; OUTPUT: -
 449+ 959D              ; MODIFIES: AF
 450+ 959D              ; NOTE:
 451+ 959D              ;   - Prima copia la posizione corrente in Var_Game_Ball*OldPosition
 452+ 959D              ;   - Poi aggiorna Var_Game_BallX/YPosition con la nuova
 453+ 959D              ;------------------------------------------------------------------------
 454+ 959D              Game_SetBallPosition:
 455+ 959D F5               PUSH    AF
 456+ 959E
 457+ 959E                  ; --- salviamo la posizione corrente come "old" ---
 458+ 959E 3A 30 B2         LD      A,(Var_Game_BallXPosition)
 459+ 95A1 32 36 B2         LD      (Var_Game_BallXOldPosition),A
 460+ 95A4
 461+ 95A4 3A 34 B2         LD      A,(Var_Game_BallYPosition)
 462+ 95A7 32 35 B2         LD      (Var_Game_BallYOldPosition),A
 463+ 95AA
 464+ 95AA                  ; --- scriviamo la nuova posizione (da D/E) ---
 465+ 95AA 7A               LD      A,D
 466+ 95AB 32 34 B2         LD      (Var_Game_BallYPosition),A
 467+ 95AE
 468+ 95AE 7B               LD      A,E
 469+ 95AF 32 30 B2         LD      (Var_Game_BallXPosition),A
 470+ 95B2
 471+ 95B2 F1               POP     AF
 472+ 95B3 C9               RET
 473+ 95B4
 474+ 95B4              ; ** UTILITY ROUTINES **
 475+ 95B4
 476+ 95B4              ; ---------------------------------------------------------------------------
 477+ 95B4              ; Calculates pointer to the player entry in Var_Game_PlayersInfo.
 478+ 95B4              ;
 479+ 95B4              ; INPUT:
 480+ 95B4              ;   B = TEAM (TEAM_BLACK=0, TEAM_WHITE=1)
 481+ 95B4              ;   C = ID   (0..3)  ; 4 players per team
 482+ 95B4              ;
 483+ 95B4              ; OUTPUT:
 484+ 95B4              ;   HL = pointer to entry start:
 485+ 95B4              ;        [0] PREV_X, [1] PREV_Y, [2] CUR_X, [3] CUR_Y,
 486+ 95B4              ;        [4] TEAM, [5] ID, [6] ROLE
 487+ 95B4              ;
 488+ 95B4              ; PRESERVES:
 489+ 95B4              ;   B = TEAM, C = ID    (utile per le routine chiamanti)
 490+ 95B4              ;
 491+ 95B4              ; MODIFIES:
 492+ 95B4              ;   AF, DE, HL
 493+ 95B4              ; ---------------------------------------------------------------------------
 494+ 95B4              GetPlayerEntryPtr:
 495+ 95B4                  ; n = TEAM*4 + ID  (TEAM_BLACK=0, TEAM_WHITE=1)
 496+ 95B4                  ; salvo TEAM/ID perché userò BC come registro di lavoro
 497+ 95B4 C5               PUSH BC
 498+ 95B5
 499+ 95B5 78               LD   A,B
 500+ 95B6 87               ADD  A,A           ; *2
 501+ 95B7 87               ADD  A,A           ; *4
 502+ 95B8 81               ADD  A,C           ; + ID → n (0..7)
 503+ 95B9
 504+ 95B9 4F               LD   C,A           ; C = n
 505+ 95BA 06 00            LD   B,0           ; BC = n (16-bit)
 506+ 95BC
 507+ 95BC                  ; HL = n * PLAYER_ENTRY_SIZE (7)
 508+ 95BC 21 00 00         LD   HL,0
 509+ 95BF 3E 07            LD   A,PLAYER_ENTRY_SIZE      ; A = 7
 510+ 95C1              .GPE_MulLoop:
 511+ 95C1 09               ADD  HL,BC                    ; HL += n
 512+ 95C2 3D               DEC  A
 513+ 95C3 20 FC            JR   NZ,.GPE_MulLoop          ; ripeti 7 volte
 514+ 95C5
 515+ 95C5                  ; A questo punto HL = n * 7
 516+ 95C5 11 37 B2         LD   DE,Var_Game_PlayersInfo
 517+ 95C8 19               ADD  HL,DE                    ; HL = base + n*7
 518+ 95C9
 519+ 95C9 C1               POP  BC                       ; ripristina TEAM/ID
 520+ 95CA C9               RET
 521+ 95CB
 522+ 95CB
 523+ 95CB              ; ---------------------------------------------------------------------------
 524+ 95CB              ; Determines the role of a player based on TEAM, FIELD DIRECTION and Y.
 525+ 95CB              ; NOTE:
 526+ 95CB              ;   This is intended for non-goalkeepers (ID != 0).
 527+ 95CB              ;   Goalkeepers are forced to ROLE_GOALKEEPER in SetPlayerInfo, but
 528+ 95CB              ;   mappings for goalkeeper rows are kept here for completeness.
 529+ 95CB              ;
 530+ 95CB              ; LOGIC (Var_Game_ActiveFieldSide = FIELD_NORTH_SIDE):
 531+ 95CB              ;   TEAM_BLACK:
 532+ 95CB              ;       Y=0 -> GOALKEEPER
 533+ 95CB              ;       Y=1 -> DEFENDER
 534+ 95CB              ;       Y=3 -> MIDFIELDER
 535+ 95CB              ;       else -> STRIKER
 536+ 95CB              ;   TEAM_WHITE (no visible goalkeeper):
 537+ 95CB              ;       Y=4 -> MIDFIELDER
 538+ 95CB              ;       Y=2 -> STRIKER
 539+ 95CB              ;       else -> STRIKER
 540+ 95CB              ;
 541+ 95CB              ; LOGIC (Var_Game_ActiveFieldSide = FIELD_SOUTH_SIDE):
 542+ 95CB              ;   TEAM_WHITE:
 543+ 95CB              ;       Y=4 -> GOALKEEPER
 544+ 95CB              ;       Y=3 -> DEFENDER
 545+ 95CB              ;       Y=1 -> MIDFIELDER
 546+ 95CB              ;       else -> STRIKER
 547+ 95CB              ;   TEAM_BLACK (no visible goalkeeper):
 548+ 95CB              ;       Y=0 -> MIDFIELDER
 549+ 95CB              ;       Y=2 -> STRIKER
 550+ 95CB              ;       else -> STRIKER
 551+ 95CB              ;
 552+ 95CB              ; INPUT:
 553+ 95CB              ;   B = TEAM (TEAM_WHITE or TEAM_BLACK)
 554+ 95CB              ;   D = Y (0..4)
 555+ 95CB              ; OUTPUT:
 556+ 95CB              ;   A = ROLE (ROLE_GOALKEEPER / ROLE_DEFENDER / ROLE_MIDFIELDER / ROLE_STRIKER)
 557+ 95CB              ; MODIFIES:
 558+ 95CB              ;   AF
 559+ 95CB              ; ---------------------------------------------------------------------------
 560+ 95CB              DeterminePlayerRole:
 561+ 95CB 3A 07 B2         LD   A,(Var_Game_ActiveFieldSide)
 562+ 95CE FE 01            CP   FIELD_NORTH_SIDE
 563+ 95D0 28 30            JR   Z,.NORTH
 564+ 95D2
 565+ 95D2              ; ===== FIELD DIRECTION SOUTH =======================================
 566+ 95D2
 567+ 95D2              .SOUTH:
 568+ 95D2                  ; Check which team
 569+ 95D2 78               LD   A,B
 570+ 95D3 FE 01            CP   TEAM_WHITE
 571+ 95D5 28 12            JR   Z,.SOUTH_WHITE
 572+ 95D7
 573+ 95D7                  ; --- TEAM_BLACK (no visible goalkeeper) ---
 574+ 95D7 7A               LD   A,D
 575+ 95D8 FE 00            CP   0
 576+ 95DA 28 07            JR   Z,.BLACK_MID_S
 577+ 95DC FE 02            CP   2
 578+ 95DE 28 06            JR   Z,.BLACK_STR_S
 579+ 95E0
 580+ 95E0 3E 03            LD   A,ROLE_STRIKER
 581+ 95E2 C9               RET
 582+ 95E3
 583+ 95E3              .BLACK_MID_S:
 584+ 95E3 3E 02            LD   A,ROLE_MIDFIELDER
 585+ 95E5 C9               RET
 586+ 95E6
 587+ 95E6              .BLACK_STR_S:
 588+ 95E6 3E 03            LD   A,ROLE_STRIKER
 589+ 95E8 C9               RET
 590+ 95E9
 591+ 95E9              ; --- TEAM_WHITE (with goalkeeper) ---
 592+ 95E9              .SOUTH_WHITE:
 593+ 95E9 7A               LD   A,D
 594+ 95EA FE 04            CP   4
 595+ 95EC 28 0B            JR   Z,.WHITE_GK_S
 596+ 95EE FE 03            CP   3
 597+ 95F0 28 0A            JR   Z,.WHITE_DEF_S
 598+ 95F2 FE 01            CP   1
 599+ 95F4 28 09            JR   Z,.WHITE_MID_S
 600+ 95F6
 601+ 95F6 3E 03            LD   A,ROLE_STRIKER
 602+ 95F8 C9               RET
 603+ 95F9
 604+ 95F9              .WHITE_GK_S:
 605+ 95F9 3E 00            LD   A,ROLE_GOALKEEPER
 606+ 95FB C9               RET
 607+ 95FC
 608+ 95FC              .WHITE_DEF_S:
 609+ 95FC 3E 01            LD   A,ROLE_DEFENDER
 610+ 95FE C9               RET
 611+ 95FF
 612+ 95FF              .WHITE_MID_S:
 613+ 95FF 3E 02            LD   A,ROLE_MIDFIELDER
 614+ 9601 C9               RET
 615+ 9602
 616+ 9602
 617+ 9602              ; ===== FIELD DIRECTION NORTH ======================================
 618+ 9602
 619+ 9602              .NORTH:
 620+ 9602                  ; Check which team
 621+ 9602 78               LD   A,B
 622+ 9603 FE 01            CP   TEAM_WHITE
 623+ 9605 28 19            JR   Z,.NORTH_WHITE
 624+ 9607
 625+ 9607                  ; --- TEAM_BLACK (with goalkeeper) ---
 626+ 9607 7A               LD   A,D
 627+ 9608 FE 00            CP   0
 628+ 960A 28 0B            JR   Z,.BLACK_GK_N
 629+ 960C FE 01            CP   1
 630+ 960E 28 0A            JR   Z,.BLACK_DEF_N
 631+ 9610 FE 03            CP   3
 632+ 9612 28 09            JR   Z,.BLACK_MID_N
 633+ 9614
 634+ 9614 3E 03            LD   A,ROLE_STRIKER
 635+ 9616 C9               RET
 636+ 9617
 637+ 9617              .BLACK_GK_N:
 638+ 9617 3E 00            LD   A,ROLE_GOALKEEPER
 639+ 9619 C9               RET
 640+ 961A
 641+ 961A              .BLACK_DEF_N:
 642+ 961A 3E 01            LD   A,ROLE_DEFENDER
 643+ 961C C9               RET
 644+ 961D
 645+ 961D              .BLACK_MID_N:
 646+ 961D 3E 02            LD   A,ROLE_MIDFIELDER
 647+ 961F C9               RET
 648+ 9620
 649+ 9620              ; --- TEAM_WHITE (no visible goalkeeper) ---
 650+ 9620              .NORTH_WHITE:
 651+ 9620 7A               LD   A,D
 652+ 9621 FE 04            CP   4
 653+ 9623 28 07            JR   Z,.WHITE_MID_N
 654+ 9625 FE 02            CP   2
 655+ 9627 28 06            JR   Z,.WHITE_STR_N
 656+ 9629
 657+ 9629 3E 03            LD   A,ROLE_STRIKER
 658+ 962B C9               RET
 659+ 962C
 660+ 962C              .WHITE_MID_N:
 661+ 962C 3E 02            LD   A,ROLE_MIDFIELDER
 662+ 962E C9               RET
 663+ 962F
 664+ 962F              .WHITE_STR_N:
 665+ 962F 3E 03            LD   A,ROLE_STRIKER
 666+ 9631 C9               RET
 667+ 9632
 668+ 9632              ; ---------------------------------------------------------------------------
 669+ 9632              ; Sets player info, updating previous and current positions and role.
 670+ 9632              ; Previous position is taken from old CUR_X/CUR_Y (if not NO_VALUE).
 671+ 9632              ; For ID = 0, the role is always ROLE_GOALKEEPER.
 672+ 9632              ;
 673+ 9632              ; INPUT:
 674+ 9632              ;   B = TEAM (TEAM_WHITE / TEAM_BLACK)
 675+ 9632              ;   C = ID   (0..3)
 676+ 9632              ;   D = new Y (0..4 o 255 per invisibile)
 677+ 9632              ;   E = new X (0..4 o 255 per invisibile)
 678+ 9632              ; OUTPUT:
 679+ 9632              ;   -
 680+ 9632              ; MODIFIES:
 681+ 9632              ;   AF, DE, HL
 682+ 9632              ; ---------------------------------------------------------------------------
 683+ 9632              SetPlayerInfo:
 684+ 9632 C5               PUSH    BC             ; salva TEAM, ID
 685+ 9633 D5               PUSH    DE             ; salva newY,newX
 686+ 9634
 687+ 9634                  ; HL -> inizio entry (PREV_X)
 688+ 9634 CD B4 95         CALL    GetPlayerEntryPtr
 689+ 9637
 690+ 9637                  ; ----- leggi vecchia CUR_X / CUR_Y -----
 691+ 9637 E5               PUSH    HL             ; salva base entry
 692+ 9638
 693+ 9638 23               INC     HL             ; PREV_Y
 694+ 9639 23               INC     HL             ; CUR_X
 695+ 963A 7E               LD      A,(HL)         ; A = old CUR_X
 696+ 963B 23               INC     HL             ; CUR_Y
 697+ 963C 4E               LD      C,(HL)         ; C = old CUR_Y
 698+ 963D
 699+ 963D E1               POP     HL             ; HL di nuovo su PREV_X
 700+ 963E
 701+ 963E                  ; ----- PREV_X / PREV_Y -----
 702+ 963E 77               LD      (HL),A         ; PREV_X = old CUR_X
 703+ 963F 23               INC     HL
 704+ 9640 71               LD      (HL),C         ; PREV_Y = old CUR_Y
 705+ 9641
 706+ 9641                  ; ----- CUR_X / CUR_Y -----
 707+ 9641 23               INC     HL             ; HL -> CUR_X
 708+ 9642 D1               POP     DE             ; D=newY, E=newX
 709+ 9643 73               LD      (HL),E         ; CUR_X
 710+ 9644 23               INC     HL
 711+ 9645 72               LD      (HL),D         ; CUR_Y
 712+ 9646
 713+ 9646                  ; ----- TEAM / ID / ROLE -----
 714+ 9646 23               INC     HL             ; TEAM
 715+ 9647 C1               POP     BC             ; ripristina TEAM,ID
 716+ 9648 70               LD      (HL),B         ; TEAM
 717+ 9649 23               INC     HL             ; ID
 718+ 964A 71               LD      (HL),C         ; ID
 719+ 964B 23               INC     HL             ; ROLE
 720+ 964C
 721+ 964C                  ; Se ID=0 → portiere fisso
 722+ 964C 79               LD      A,C
 723+ 964D B7               OR      A
 724+ 964E 20 04            JR      NZ,.not_goalkeeper
 725+ 9650
 726+ 9650 3E 00            LD      A,ROLE_GOALKEEPER
 727+ 9652 77               LD      (HL),A
 728+ 9653 C9               RET
 729+ 9654
 730+ 9654              .not_goalkeeper:
 731+ 9654                  ; determina il ruolo per i giocatori di movimento
 732+ 9654                  ; B = TEAM, D = Y sono ancora validi
 733+ 9654 CD CB 95         CALL    DeterminePlayerRole
 734+ 9657 77               LD      (HL),A
 735+ 9658 C9               RET
 736+ 9659
 737+ 9659              ; ---------------------------------------------------------------------------
 738+ 9659              ; Gets player info by TEAM and ID.
 739+ 9659              ;
 740+ 9659              ; INPUT:
 741+ 9659              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
 742+ 9659              ;   C = ID    (0..3)
 743+ 9659              ;
 744+ 9659              ; OUTPUT (se OK):
 745+ 9659              ;   HL = current position (H = Y, L = X)
 746+ 9659              ;   DE = previous position (D = prevY, E = prevX)
 747+ 9659              ;   A  = ROLE
 748+ 9659              ;   B  = TEAM (come in ingresso)
 749+ 9659              ;   C  = ID   (come in ingresso)
 750+ 9659              ;
 751+ 9659              ; OUTPUT (se ID fuori range):
 752+ 9659              ;   A  = NO_VALUE
 753+ 9659              ;
 754+ 9659              ; MODIFIES:
 755+ 9659              ;   AF, DE, HL
 756+ 9659              ; ---------------------------------------------------------------------------
 757+ 9659              Game_GetPlayerInfoById:
 758+ 9659 79               ld   a,c
 759+ 965A FE 04            cp   4
 760+ 965C 38 03            jr   c,.GPI_ValidId
 761+ 965E 3E FF            ld   a,NO_VALUE
 762+ 9660 C9               ret
 763+ 9661
 764+ 9661              .GPI_ValidId:
 765+ 9661                  ; salviamo TEAM/ID perché useremo B,C come temporanei
 766+ 9661 C5               push bc
 767+ 9662
 768+ 9662                  ; HL -> PREV_X dell'entry (usa TEAM/ID salvati dentro GetPlayerEntryPtr)
 769+ 9662                  ; GetPlayerEntryPtr preserva B,C da solo (fa PUSH/POP BC)
 770+ 9662 CD B4 95         call GetPlayerEntryPtr       ; HL = base entry (PREV_X)
 771+ 9665
 772+ 9665                  ; ----- PREV in DE -----
 773+ 9665 5E               ld   e,(hl)                  ; PREV_X
 774+ 9666 23               inc  hl
 775+ 9667 56               ld   d,(hl)                  ; PREV_Y
 776+ 9668
 777+ 9668                  ; ----- CUR in B,C temporanei -----
 778+ 9668 23               inc  hl                      ; CUR_X
 779+ 9669 4E               ld   c,(hl)                  ; C = CUR_X
 780+ 966A 23               inc  hl                      ; CUR_Y
 781+ 966B 46               ld   b,(hl)                  ; B = CUR_Y
 782+ 966C
 783+ 966C                  ; ----- ROLE in A -----
 784+ 966C 23               inc  hl                      ; TEAM
 785+ 966D 23               inc  hl                      ; ID
 786+ 966E 23               inc  hl                      ; ROLE
 787+ 966F 7E               ld   a,(hl)                  ; A = ROLE
 788+ 9670
 789+ 9670                  ; ----- ricomponi output -----
 790+ 9670                  ; HL = (Y,X)
 791+ 9670 60               ld   h,b                     ; H = CUR_Y
 792+ 9671 69               ld   l,c                     ; L = CUR_X
 793+ 9672
 794+ 9672                  ; DE già contiene (prevY,prevX)
 795+ 9672
 796+ 9672                  ; ripristina TEAM/ID originali in BC
 797+ 9672 C1               pop  bc                      ; B = TEAM, C = ID
 798+ 9673
 799+ 9673 C9               ret
 800+ 9674
 801+ 9674
 802+ 9674
 803+ 9674              ; ---------------------------------------------------------------------------
 804+ 9674              ; Searches a player by his current position (CUR_X, CUR_Y).
 805+ 9674              ;
 806+ 9674              ; INPUT:
 807+ 9674              ;   D = Y (curY)
 808+ 9674              ;   E = X (curX)
 809+ 9674              ;
 810+ 9674              ; OUTPUT (if found):
 811+ 9674              ;   B  = TEAM        (0 = TEAM_BLACK, 1 = TEAM_WHITE)
 812+ 9674              ;   C  = ID          (0..3)
 813+ 9674              ;   A  = ROLE
 814+ 9674              ;   DE = current position  (D = curY, E = curX)
 815+ 9674              ;   HL = previous position (H = prevY, L = prevX)
 816+ 9674              ;
 817+ 9674              ; OUTPUT (if not found):
 818+ 9674              ;   A  = NO_VALUE
 819+ 9674              ;
 820+ 9674              ; MODIFIES:
 821+ 9674              ;   AF, BC, DE, HL
 822+ 9674              ; ---------------------------------------------------------------------------
 823+ 9674              Game_GetPlayerInfoByPos:
 824+ 9674 06 00            LD   B,TEAM_BLACK
 825+ 9676              .black:
 826+ 9676 0E 00            LD   C,0                      ; ID = 0..3
 827+ 9678              .black_loop:
 828+ 9678 C5               PUSH BC
 829+ 9679 D5               PUSH DE
 830+ 967A CD 59 96         CALL Game_GetPlayerInfoById
 831+ 967D D1               POP DE
 832+ 967E C1               POP BC
 833+ 967F 7C               LD   A, H
 834+ 9680 BA               CP   D
 835+ 9681 20 08            JR   NZ,.black_loop_not_found
 836+ 9683 7D               LD   A, L
 837+ 9684 BB               CP   E
 838+ 9685 20 04            JR   NZ,.black_loop_not_found
 839+ 9687 CD 59 96         CALL Game_GetPlayerInfoById
 840+ 968A C9               RET
 841+ 968B              .black_loop_not_found
 842+ 968B 0C               INC  C
 843+ 968C 79               LD   A, C
 844+ 968D FE 04            CP   4
 845+ 968F 20 E7            JR   NZ, .black_loop
 846+ 9691 06 01            LD   B,TEAM_WHITE
 847+ 9693              .white:
 848+ 9693 0E 00            LD   C,0
 849+ 9695              .white_loop:
 850+ 9695 C5               PUSH BC
 851+ 9696 D5               PUSH DE
 852+ 9697 CD 59 96         CALL Game_GetPlayerInfoById
 853+ 969A D1               POP DE
 854+ 969B C1               POP BC
 855+ 969C 7C               LD   A, H
 856+ 969D BA               CP   D
 857+ 969E 20 08            JR   NZ,.white_loop_not_found
 858+ 96A0 7D               LD   A, L
 859+ 96A1 BB               CP   E
 860+ 96A2 20 04            JR   NZ,.white_loop_not_found
 861+ 96A4 CD 59 96         CALL Game_GetPlayerInfoById
 862+ 96A7 C9               RET
 863+ 96A8              .white_loop_not_found
 864+ 96A8 0C               INC  C
 865+ 96A9 79               LD   A, C
 866+ 96AA FE 04            CP   4
 867+ 96AC 20 E7            JR   NZ, .white_loop
 868+ 96AE 3E FF            LD   A, NO_VALUE
 869+ 96B0 C9               RET
 870+ 96B1
 871+ 96B1              ; ---------------------------------------------------------------------------
 872+ 96B1              ; Clears all previous positions (PREV_X, PREV_Y) for all players.
 873+ 96B1              ; PREV_X and PREV_Y are set to NO_VALUE (255).
 874+ 96B1              ;
 875+ 96B1              ; INPUT:
 876+ 96B1              ;  B: TEAM (TEAM_BLACK / TEAM_WHITE)
 877+ 96B1              ;  C: ID (0..3)
 878+ 96B1              ;   -
 879+ 96B1              ; OUTPUT:
 880+ 96B1              ;   -
 881+ 96B1              ; MODIFIES:
 882+ 96B1              ;   -
 883+ 96B1              ; ---------------------------------------------------------------------------
 884+ 96B1              Game_ClearSinglePlayerPrevPositions:
 885+ 96B1 D5               PUSH DE
 886+ 96B2 C5               PUSH BC
 887+ 96B3 E5               PUSH HL
 888+ 96B4 F5               PUSH AF
 889+ 96B5
 890+ 96B5
 891+ 96B5
 892+ 96B5 CD B4 95         CALL GetPlayerEntryPtr        ; HL -> PREV_X of this player
 893+ 96B8 3E FF            LD   A, NO_VALUE
 894+ 96BA 77               LD   (HL),A                   ; PREV_X = NO_VALUE
 895+ 96BB 23               INC  HL
 896+ 96BC 77               LD   (HL),A                   ; PREV_Y = NO_VALUE
 897+ 96BD
 898+ 96BD
 899+ 96BD
 900+ 96BD
 901+ 96BD F1               POP AF
 902+ 96BE E1               POP HL
 903+ 96BF C1               POP BC
 904+ 96C0 D1               POP DE
 905+ 96C1 C9               RET
 906+ 96C2              ; ---------------------------------------------------------------------------
 907+ 96C2              ; Clears all previous positions (PREV_X, PREV_Y) for all players.
 908+ 96C2              ; PREV_X and PREV_Y are set to NO_VALUE (255).
 909+ 96C2              ;
 910+ 96C2              ; INPUT:
 911+ 96C2              ;   -
 912+ 96C2              ; OUTPUT:
 913+ 96C2              ;   -
 914+ 96C2              ; MODIFIES:
 915+ 96C2              ;   AF, BC, HL
 916+ 96C2              ; ---------------------------------------------------------------------------
 917+ 96C2              ClearAllPrevPositions:
 918+ 96C2 3E FF            LD   A,NO_VALUE
 919+ 96C4
 920+ 96C4                  ; ---- Team BLACK ----
 921+ 96C4 06 00            LD   B,TEAM_BLACK
 922+ 96C6 CD CF 96         CALL .ClearTeamPrev
 923+ 96C9
 924+ 96C9                  ; ---- Team WHITE ----
 925+ 96C9 06 01            LD   B,TEAM_WHITE
 926+ 96CB CD CF 96         CALL .ClearTeamPrev
 927+ 96CE
 928+ 96CE C9               RET
 929+ 96CF
 930+ 96CF              ; Clears PREV_X / PREV_Y for one team (B = TEAM, C = 0..3)
 931+ 96CF              .ClearTeamPrev:
 932+ 96CF 0E 00            LD   C,0                      ; ID = 0..3
 933+ 96D1              .CT_Loop:
 934+ 96D1 C5               PUSH BC
 935+ 96D2 CD B4 95         CALL GetPlayerEntryPtr        ; HL -> PREV_X of this player
 936+ 96D5 3E FF            LD   A, NO_VALUE
 937+ 96D7 77               LD   (HL),A                   ; PREV_X = NO_VALUE
 938+ 96D8 23               INC  HL
 939+ 96D9 77               LD   (HL),A                   ; PREV_Y = NO_VALUE
 940+ 96DA
 941+ 96DA C1               POP  BC
 942+ 96DB 0C               INC  C
 943+ 96DC 79               LD   A,C                      ; *** qui confrontiamo C, non A vecchio ***
 944+ 96DD FE 04            CP   4
 945+ 96DF 20 F0            JR   NZ,.CT_Loop
 946+ 96E1 C9               RET
 947+ 96E2
 948+ 96E2
 949+ 96E2
 950+ 96E2
 951+ 96E2              ; ---------------------------------------------------------------------------
 952+ 96E2              ; Sets kickoff schema when WHITE team is attacking (field direction NORTH).
 953+ 96E2              ; Black goalkeeper is visible on row 0, white goalkeeper is hidden.
 954+ 96E2              ; Players layout (Y=row, X=col):
 955+ 96E2              ;   - Black GK:        Y=0, X=2
 956+ 96E2              ;   - Black DEF:       Y=1, X=1 and Y=1, X=3
 957+ 96E2              ;   - Black MID:       Y=3, X=4
 958+ 96E2              ;   - White MID:       Y=4, X=1,2,3
 959+ 96E2              ;   - White GK:        Y=255 (hidden), X=2
 960+ 96E2              ; Also sets virtual player variables for a black virtual player at (0,0).
 961+ 96E2              ; INPUT:
 962+ 96E2              ;   -
 963+ 96E2              ; OUTPUT:
 964+ 96E2              ;   Var_Game_ActiveFieldSide updated
 965+ 96E2              ;   Var_Game_PlayersInfo fully initialized for this schema
 966+ 96E2              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
 967+ 96E2              ; MODIFIES:
 968+ 96E2              ;   AF, BC, DE, HL
 969+ 96E2              ; ---------------------------------------------------------------------------
 970+ 96E2              Game_SetWhiteKickoffSchema:
 971+ 96E2 3E 01            LD   A, TEAM_WHITE
 972+ 96E4 32 25 B2         LD   (Var_Game_TeamWithBall), A
 973+ 96E7
 974+ 96E7 16 03            LD     D, 3
 975+ 96E9 1E 02            LD     E, 2
 976+ 96EB CD 9D 95         CALL   Game_SetBallPosition
 977+ 96EE 3E FF            LD     A, 255
 978+ 96F0 32 35 B2         LD     (Var_Game_BallYOldPosition ), A
 979+ 96F3 3E 00            LD      A, BALL_DIRECTION_NONE
 980+ 96F5 32 27 B2         LD      (Var_Game_BallDirection),A
 981+ 96F8
 982+ 96F8                  ; Set field direction to NORTH
 983+ 96F8 3E 01            LD   A,FIELD_NORTH_SIDE
 984+ 96FA 32 07 B2         LD   (Var_Game_ActiveFieldSide),A
 985+ 96FD
 986+ 96FD                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
 987+ 96FD
 988+ 96FD                  ; Black GK, ID=0, Y=0, X=2
 989+ 96FD 06 00            LD   B,TEAM_BLACK
 990+ 96FF 0E 00            LD   C,0                  ; ID=0 (goalkeeper)
 991+ 9701 16 00            LD   D,0                  ; Y
 992+ 9703 1E 02            LD   E,2                  ; X
 993+ 9705 CD 32 96         CALL SetPlayerInfo
 994+ 9708
 995+ 9708                  ; Black DEF 1, ID=1, Y=1, X=1
 996+ 9708 06 00            LD   B,TEAM_BLACK
 997+ 970A 0E 01            LD   C,1
 998+ 970C 16 01            LD   D,1
 999+ 970E 1E 01            LD   E,1
1000+ 9710 CD 32 96         CALL SetPlayerInfo
1001+ 9713
1002+ 9713                  ; Black DEF 2, ID=2, Y=1, X=3
1003+ 9713 06 00            LD   B,TEAM_BLACK
1004+ 9715 0E 02            LD   C,2
1005+ 9717 16 01            LD   D,1
1006+ 9719 1E 03            LD   E,3
1007+ 971B CD 32 96         CALL SetPlayerInfo
1008+ 971E
1009+ 971E                  ; Black MID, ID=3, Y=3, X=4
1010+ 971E 06 00            LD   B,TEAM_BLACK
1011+ 9720 0E 03            LD   C,3
1012+ 9722 16 03            LD   D,3
1013+ 9724 1E 04            LD   E,4
1014+ 9726 CD 32 96         CALL SetPlayerInfo
1015+ 9729
1016+ 9729                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1017+ 9729
1018+ 9729                  ; White GK hidden, ID=0, Y=255, X=2
1019+ 9729 06 01            LD   B,TEAM_WHITE
1020+ 972B 0E 00            LD   C,0
1021+ 972D 16 FF            LD   D,255
1022+ 972F 1E 02            LD   E,2
1023+ 9731 CD 32 96         CALL SetPlayerInfo
1024+ 9734
1025+ 9734                  ; White MID 1, ID=1, Y=4, X=1
1026+ 9734 06 01            LD   B,TEAM_WHITE
1027+ 9736 0E 01            LD   C,1
1028+ 9738 16 04            LD   D,4
1029+ 973A 1E 01            LD   E,1
1030+ 973C CD 32 96         CALL SetPlayerInfo
1031+ 973F
1032+ 973F                  ; White MID 2, ID=2, Y=4, X=2
1033+ 973F 06 01            LD   B,TEAM_WHITE
1034+ 9741 0E 02            LD   C,2
1035+ 9743 16 04            LD   D,4
1036+ 9745 1E 02            LD   E,2
1037+ 9747 CD 32 96         CALL SetPlayerInfo
1038+ 974A
1039+ 974A                  ; White MID 3, ID=3, Y=4, X=3
1040+ 974A 06 01            LD   B,TEAM_WHITE
1041+ 974C 0E 03            LD   C,3
1042+ 974E 16 04            LD   D,4
1043+ 9750 1E 03            LD   E,3
1044+ 9752 CD 32 96         CALL SetPlayerInfo
1045+ 9755
1046+ 9755                  ; ---- VIRTUAL PLAYER ------------------------------------------
1047+ 9755
1048+ 9755 3E 00            LD   A,TEAM_BLACK
1049+ 9757 32 2B B2         LD   (Var_Game_VirtualPlayerTeam),A
1050+ 975A
1051+ 975A AF               XOR   A
1052+ 975B 32 2A B2         LD   (Var_Game_VirtualPlayerXPos),A   ; X=0
1053+ 975E 3E 03            LD   A, 3
1054+ 9760 32 29 B2         LD   (Var_Game_VirtualPlayerYPos),A
1055+ 9763                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1056+ 9763 CD C2 96         CALL ClearAllPrevPositions
1057+ 9766
1058+ 9766 C9               RET
1059+ 9767
1060+ 9767              ; ---------------------------------------------------------------------------
1061+ 9767              ; Sets kickoff schema when BLACK team is attacking (field direction SOUTH).
1062+ 9767              ; White goalkeeper is visible on row 4, black goalkeeper is hidden.
1063+ 9767              ; Players layout (Y=row, X=col):
1064+ 9767              ;   - White GK:        Y=4, X=2
1065+ 9767              ;   - White DEF:       Y=3, X=1 and Y=3, X=3
1066+ 9767              ;   - White MID:       Y=1, X=0
1067+ 9767              ;   - Black MID:       Y=0, X=1,2,3
1068+ 9767              ;   - Black GK:        Y=255 (hidden), X=2
1069+ 9767              ; Also sets virtual player variables for a white virtual player at (1,4).
1070+ 9767              ; INPUT:
1071+ 9767              ;   -
1072+ 9767              ; OUTPUT:
1073+ 9767              ;   Var_Game_ActiveFieldSide updated
1074+ 9767              ;   Var_Game_PlayersInfo fully initialized for this schema
1075+ 9767              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1076+ 9767              ; MODIFIES:
1077+ 9767              ;   AF, BC, DE, HL
1078+ 9767              ; ---------------------------------------------------------------------------
1079+ 9767              Game_SetBlackKickoffSchema:
1080+ 9767 3E 00            LD   A, TEAM_BLACK
1081+ 9769 32 25 B2         LD   (Var_Game_TeamWithBall), A
1082+ 976C
1083+ 976C 16 00            LD     D, 0
1084+ 976E 1E 02            LD     E, 2
1085+ 9770 CD 9D 95         CALL   Game_SetBallPosition
1086+ 9773 3E FF            LD     A, 255
1087+ 9775 32 35 B2         LD     (Var_Game_BallYOldPosition ), A
1088+ 9778 3E 00            LD   A, BALL_DIRECTION_NONE
1089+ 977A 32 27 B2         LD   (Var_Game_BallDirection),A
1090+ 977D
1091+ 977D                  ; Set field direction to SOUTH
1092+ 977D 3E 00            LD   A,FIELD_SOUTH_SIDE
1093+ 977F 32 07 B2         LD   (Var_Game_ActiveFieldSide),A
1094+ 9782
1095+ 9782                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1096+ 9782
1097+ 9782                  ; White GK, ID=0, Y=4, X=2
1098+ 9782 06 01            LD   B,TEAM_WHITE
1099+ 9784 0E 00            LD   C,0
1100+ 9786 16 04            LD   D,4
1101+ 9788 1E 02            LD   E,2
1102+ 978A CD 32 96         CALL SetPlayerInfo
1103+ 978D
1104+ 978D                  ; White DEF 1, ID=1, Y=3, X=1
1105+ 978D 06 01            LD   B,TEAM_WHITE
1106+ 978F 0E 01            LD   C,1
1107+ 9791 16 03            LD   D,3
1108+ 9793 1E 01            LD   E,1
1109+ 9795 CD 32 96         CALL SetPlayerInfo
1110+ 9798
1111+ 9798                  ; White DEF 2, ID=2, Y=3, X=3
1112+ 9798 06 01            LD   B,TEAM_WHITE
1113+ 979A 0E 02            LD   C,2
1114+ 979C 16 03            LD   D,3
1115+ 979E 1E 03            LD   E,3
1116+ 97A0 CD 32 96         CALL SetPlayerInfo
1117+ 97A3
1118+ 97A3                  ; White MID, ID=3, Y=1, X=0
1119+ 97A3 06 01            LD   B,TEAM_WHITE
1120+ 97A5 0E 03            LD   C,3
1121+ 97A7 16 01            LD   D,1
1122+ 97A9 1E 00            LD   E,0
1123+ 97AB CD 32 96         CALL SetPlayerInfo
1124+ 97AE
1125+ 97AE                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1126+ 97AE
1127+ 97AE                  ; Black GK hidden, ID=0, Y=255, X=2
1128+ 97AE 06 00            LD   B,TEAM_BLACK
1129+ 97B0 0E 00            LD   C,0
1130+ 97B2 16 FF            LD   D,255
1131+ 97B4 1E 02            LD   E,2
1132+ 97B6 CD 32 96         CALL SetPlayerInfo
1133+ 97B9
1134+ 97B9                  ; Black MID 1, ID=1, Y=0, X=1
1135+ 97B9 06 00            LD   B,TEAM_BLACK
1136+ 97BB 0E 01            LD   C,1
1137+ 97BD 16 00            LD   D,0
1138+ 97BF 1E 01            LD   E,1
1139+ 97C1 CD 32 96         CALL SetPlayerInfo
1140+ 97C4
1141+ 97C4                  ; Black MID 2, ID=2, Y=0, X=2
1142+ 97C4 06 00            LD   B,TEAM_BLACK
1143+ 97C6 0E 02            LD   C,2
1144+ 97C8 16 00            LD   D,0
1145+ 97CA 1E 02            LD   E,2
1146+ 97CC CD 32 96         CALL SetPlayerInfo
1147+ 97CF
1148+ 97CF                  ; Black MID 3, ID=3, Y=0, X=3
1149+ 97CF 06 00            LD   B,TEAM_BLACK
1150+ 97D1 0E 03            LD   C,3
1151+ 97D3 16 00            LD   D,0
1152+ 97D5 1E 03            LD   E,3
1153+ 97D7 CD 32 96         CALL SetPlayerInfo
1154+ 97DA
1155+ 97DA                  ; ---- VIRTUAL PLAYER ------------------------------------------
1156+ 97DA
1157+ 97DA 3E 01            LD   A,TEAM_WHITE
1158+ 97DC 32 2B B2         LD   (Var_Game_VirtualPlayerTeam),A
1159+ 97DF
1160+ 97DF 3E 01            LD   A,1
1161+ 97E1 32 29 B2         LD   (Var_Game_VirtualPlayerYPos),A   ; Y=1
1162+ 97E4 3E 04            LD   A,4
1163+ 97E6 32 2A B2         LD   (Var_Game_VirtualPlayerXPos),A   ; X=4
1164+ 97E9
1165+ 97E9                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1166+ 97E9 CD C2 96         CALL ClearAllPrevPositions
1167+ 97EC
1168+ 97EC C9               RET
1169+ 97ED
1170+ 97ED              ; ---------------------------------------------------------------------------
1171+ 97ED              ; Sets restart-from-goal schema when BLACK team is defending and the
1172+ 97ED              ; active field side is NORTH.
1173+ 97ED              ;
1174+ 97ED              ; Player layout (Y=row, X=col):
1175+ 97ED              ;   - Black GK:        Y=0, X=2
1176+ 97ED              ;   - Black DEF:       Y=1, X=1 / X=2 / X=3
1177+ 97ED              ;   - White FWD:       Y=2, X=0 and Y=2, X=4
1178+ 97ED              ;   - White MID:       Y=4, X=3
1179+ 97ED              ;   - White GK:        Y=255 (hidden), X=2
1180+ 97ED              ;
1181+ 97ED              ; Virtual player:
1182+ 97ED              ;   Var_Game_VirtualPlayerTeam = TEAM_WHITE
1183+ 97ED              ;   Var_Game_VirtualPlayerYPos = 4
1184+ 97ED              ;   Var_Game_VirtualPlayerXPos = 1
1185+ 97ED              ;
1186+ 97ED              ; INPUT:
1187+ 97ED              ;   -
1188+ 97ED              ; OUTPUT:
1189+ 97ED              ;   Var_Game_ActiveFieldSide updated to FIELD_NORTH_SIDE
1190+ 97ED              ;   Var_Game_PlayersInfo filled for this schema
1191+ 97ED              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1192+ 97ED              ; MODIFIES:
1193+ 97ED              ;   AF, BC, DE, HL
1194+ 97ED              ; ---------------------------------------------------------------------------
1195+ 97ED              SetBlackRestartSchema:
1196+ 97ED 3E 00            LD   A, TEAM_BLACK
1197+ 97EF 32 25 B2         LD   (Var_Game_TeamWithBall), A
1198+ 97F2
1199+ 97F2 16 00            LD     D, 0
1200+ 97F4 1E 02            LD     E, 2
1201+ 97F6 CD 9D 95         CALL   Game_SetBallPosition
1202+ 97F9 3E FF            LD     A, 255
1203+ 97FB 32 35 B2         LD     (Var_Game_BallYOldPosition ), A
1204+ 97FE 3E 00            LD     A, BALL_DIRECTION_NONE
1205+ 9800 32 27 B2         LD     (Var_Game_BallDirection),A
1206+ 9803
1207+ 9803                  ; Set active field side to NORTH
1208+ 9803 3E 01            LD   A,FIELD_NORTH_SIDE
1209+ 9805 32 07 B2         LD   (Var_Game_ActiveFieldSide),A
1210+ 9808
1211+ 9808 3E 01            LD   A, YES
1212+ 980A 32 26 B2         LD   (Var_Game_GoalkeeperHasBall), A
1213+ 980D
1214+ 980D                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1215+ 980D
1216+ 980D                  ; Black GK, ID=0, Y=0, X=2
1217+ 980D 06 00            LD   B,TEAM_BLACK
1218+ 980F 0E 00            LD   C,0                  ; ID=0 (goalkeeper)
1219+ 9811 16 00            LD   D,0                  ; Y
1220+ 9813 1E 02            LD   E,2                  ; X
1221+ 9815 CD 32 96         CALL SetPlayerInfo
1222+ 9818
1223+ 9818                  ; Black DEF 1, ID=1, Y=1, X=1
1224+ 9818 06 00            LD   B,TEAM_BLACK
1225+ 981A 0E 01            LD   C,1
1226+ 981C 16 01            LD   D,1
1227+ 981E 1E 01            LD   E,1
1228+ 9820 CD 32 96         CALL SetPlayerInfo
1229+ 9823
1230+ 9823                  ; Black DEF 2, ID=2, Y=1, X=2
1231+ 9823 06 00            LD   B,TEAM_BLACK
1232+ 9825 0E 02            LD   C,2
1233+ 9827 16 01            LD   D,1
1234+ 9829 1E 02            LD   E,2
1235+ 982B CD 32 96         CALL SetPlayerInfo
1236+ 982E
1237+ 982E                  ; Black DEF 3, ID=3, Y=1, X=3
1238+ 982E 06 00            LD   B,TEAM_BLACK
1239+ 9830 0E 03            LD   C,3
1240+ 9832 16 01            LD   D,1
1241+ 9834 1E 03            LD   E,3
1242+ 9836 CD 32 96         CALL SetPlayerInfo
1243+ 9839
1244+ 9839                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1245+ 9839
1246+ 9839                  ; White GK hidden, ID=0, Y=255, X=2
1247+ 9839 06 01            LD   B,TEAM_WHITE
1248+ 983B 0E 00            LD   C,0
1249+ 983D 16 FF            LD   D,255
1250+ 983F 1E 02            LD   E,2
1251+ 9841 CD 32 96         CALL SetPlayerInfo
1252+ 9844
1253+ 9844                  ; White FWD 1, ID=1, Y=2, X=0
1254+ 9844 06 01            LD   B,TEAM_WHITE
1255+ 9846 0E 01            LD   C,1
1256+ 9848 16 02            LD   D,2
1257+ 984A 1E 00            LD   E,0
1258+ 984C CD 32 96         CALL SetPlayerInfo
1259+ 984F
1260+ 984F                  ; White FWD 2, ID=2, Y=2, X=4
1261+ 984F 06 01            LD   B,TEAM_WHITE
1262+ 9851 0E 02            LD   C,2
1263+ 9853 16 02            LD   D,2
1264+ 9855 1E 04            LD   E,4
1265+ 9857 CD 32 96         CALL SetPlayerInfo
1266+ 985A
1267+ 985A                  ; White MID, ID=3, Y=4, X=3
1268+ 985A 06 01            LD   B,TEAM_WHITE
1269+ 985C 0E 03            LD   C,3
1270+ 985E 16 04            LD   D,4
1271+ 9860 1E 03            LD   E,3
1272+ 9862 CD 32 96         CALL SetPlayerInfo
1273+ 9865
1274+ 9865                  ; ---- VIRTUAL PLAYER ------------------------------------------
1275+ 9865
1276+ 9865 3E 01            LD   A,TEAM_WHITE
1277+ 9867 32 2B B2         LD   (Var_Game_VirtualPlayerTeam),A
1278+ 986A
1279+ 986A 3E 04            LD   A,4
1280+ 986C 32 29 B2         LD   (Var_Game_VirtualPlayerYPos),A   ; Y=4
1281+ 986F 3E 01            LD   A,1
1282+ 9871 32 2A B2         LD   (Var_Game_VirtualPlayerXPos),A   ; X=1
1283+ 9874
1284+ 9874                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1285+ 9874 CD C2 96         CALL ClearAllPrevPositions
1286+ 9877
1287+ 9877 C9               RET
1288+ 9878
1289+ 9878              ; ---------------------------------------------------------------------------
1290+ 9878              ; Sets restart-from-goal schema when WHITE team is defending and the
1291+ 9878              ; active field side is SOUTH.
1292+ 9878              ;
1293+ 9878              ; Player layout (Y=row, X=col):
1294+ 9878              ;   - White GK:        Y=4, X=2
1295+ 9878              ;   - White DEF:       Y=3, X=1 / X=2 / X=3
1296+ 9878              ;   - Black FWD:       Y=2, X=0 and Y=2, X=4
1297+ 9878              ;   - Black MID:       Y=0, X=4
1298+ 9878              ;   - Black GK:        Y=255 (hidden), X=2
1299+ 9878              ;
1300+ 9878              ; Virtual player:
1301+ 9878              ;   Var_Game_VirtualPlayerTeam = TEAM_BLACK
1302+ 9878              ;   Var_Game_VirtualPlayerYPos = 0
1303+ 9878              ;   Var_Game_VirtualPlayerXPos = 0
1304+ 9878              ;
1305+ 9878              ; INPUT:
1306+ 9878              ;   -
1307+ 9878              ; OUTPUT:
1308+ 9878              ;   Var_Game_ActiveFieldSide updated to FIELD_SOUTH_SIDE
1309+ 9878              ;   Var_Game_PlayersInfo filled for this schema
1310+ 9878              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1311+ 9878              ; MODIFIES:
1312+ 9878              ;   AF, BC, DE, HL
1313+ 9878              ; ---------------------------------------------------------------------------
1314+ 9878              SetWhiteRestartSchema:
1315+ 9878 3E 01            LD   A, TEAM_WHITE
1316+ 987A 32 25 B2         LD   (Var_Game_TeamWithBall), A
1317+ 987D 16 04            LD     D, 4
1318+ 987F 1E 02            LD     E, 2
1319+ 9881 CD 9D 95         CALL   Game_SetBallPosition
1320+ 9884 3E FF            LD     A, 255
1321+ 9886 32 35 B2         LD     (Var_Game_BallYOldPosition ), A
1322+ 9889 3E 00            LD   A, BALL_DIRECTION_NONE
1323+ 988B 32 27 B2         LD   (Var_Game_BallDirection),A
1324+ 988E
1325+ 988E                  ; Set active field side to SOUTH
1326+ 988E 3E 00            LD   A,FIELD_SOUTH_SIDE
1327+ 9890 32 07 B2         LD   (Var_Game_ActiveFieldSide),A
1328+ 9893
1329+ 9893 3E 01            LD   A, YES
1330+ 9895 32 26 B2         LD   (Var_Game_GoalkeeperHasBall), A
1331+ 9898
1332+ 9898                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1333+ 9898
1334+ 9898                  ; White GK, ID=0, Y=4, X=2
1335+ 9898 06 01            LD   B,TEAM_WHITE
1336+ 989A 0E 00            LD   C,0
1337+ 989C 16 04            LD   D,4
1338+ 989E 1E 02            LD   E,2
1339+ 98A0 CD 32 96         CALL SetPlayerInfo
1340+ 98A3
1341+ 98A3                  ; White DEF 1, ID=1, Y=3, X=1
1342+ 98A3 06 01            LD   B,TEAM_WHITE
1343+ 98A5 0E 01            LD   C,1
1344+ 98A7 16 03            LD   D,3
1345+ 98A9 1E 01            LD   E,1
1346+ 98AB CD 32 96         CALL SetPlayerInfo
1347+ 98AE
1348+ 98AE                  ; White DEF 2, ID=2, Y=3, X=2
1349+ 98AE 06 01            LD   B,TEAM_WHITE
1350+ 98B0 0E 02            LD   C,2
1351+ 98B2 16 03            LD   D,3
1352+ 98B4 1E 02            LD   E,2
1353+ 98B6 CD 32 96         CALL SetPlayerInfo
1354+ 98B9
1355+ 98B9                  ; White DEF 3, ID=3, Y=3, X=3
1356+ 98B9 06 01            LD   B,TEAM_WHITE
1357+ 98BB 0E 03            LD   C,3
1358+ 98BD 16 03            LD   D,3
1359+ 98BF 1E 03            LD   E,3
1360+ 98C1 CD 32 96         CALL SetPlayerInfo
1361+ 98C4
1362+ 98C4                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1363+ 98C4
1364+ 98C4                  ; Black GK hidden, ID=0, Y=255, X=2
1365+ 98C4 06 00            LD   B,TEAM_BLACK
1366+ 98C6 0E 00            LD   C,0
1367+ 98C8 16 FF            LD   D,255
1368+ 98CA 1E 02            LD   E,2
1369+ 98CC CD 32 96         CALL SetPlayerInfo
1370+ 98CF
1371+ 98CF                  ; Black FWD 1, ID=1, Y=2, X=0
1372+ 98CF 06 00            LD   B,TEAM_BLACK
1373+ 98D1 0E 01            LD   C,1
1374+ 98D3 16 02            LD   D,2
1375+ 98D5 1E 00            LD   E,0
1376+ 98D7 CD 32 96         CALL SetPlayerInfo
1377+ 98DA
1378+ 98DA                  ; Black FWD 2, ID=2, Y=2, X=4
1379+ 98DA 06 00            LD   B,TEAM_BLACK
1380+ 98DC 0E 02            LD   C,2
1381+ 98DE 16 02            LD   D,2
1382+ 98E0 1E 04            LD   E,4
1383+ 98E2 CD 32 96         CALL SetPlayerInfo
1384+ 98E5
1385+ 98E5                  ; Black MID, ID=3, Y=0, X=4
1386+ 98E5 06 00            LD   B,TEAM_BLACK
1387+ 98E7 0E 03            LD   C,3
1388+ 98E9 16 00            LD   D,0
1389+ 98EB 1E 03            LD   E,3
1390+ 98ED CD 32 96         CALL SetPlayerInfo
1391+ 98F0
1392+ 98F0                  ; ---- VIRTUAL PLAYER ------------------------------------------
1393+ 98F0
1394+ 98F0 3E 00            LD   A,TEAM_BLACK
1395+ 98F2 32 2B B2         LD   (Var_Game_VirtualPlayerTeam),A
1396+ 98F5
1397+ 98F5 AF               XOR  A
1398+ 98F6 32 29 B2         LD   (Var_Game_VirtualPlayerYPos),A
1399+ 98F9 3E 01            LD   A, 1
1400+ 98FB 32 2A B2         LD   (Var_Game_VirtualPlayerXPos),A
1401+ 98FE
1402+ 98FE                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1403+ 98FE CD C2 96         CALL ClearAllPrevPositions
1404+ 9901
1405+ 9901 C9               RET
1406+ 9902
1407+ 9902
1408+ 9902
1409+ 9902              ; ---------------------------------------------------------------------------
1410+ 9902              ; ResumeGame
1411+ 9902              ;
1412+ 9902              ; Decide il tipo di ripresa in base a:
1413+ 9902              ;   - Var_Game_ActiveFieldSide
1414+ 9902              ;   - posizione Y della palla
1415+ 9902              ;
1416+ 9902              ; Casi:
1417+ 9902              ;   - Campo NORTH, BallY = 1 -> rimessa dal fondo NERA
1418+ 9902              ;   - Campo SOUTH, BallY = 2 -> rimessa dal fondo BIANCA
1419+ 9902              ;   - Campo SOUTH, BallY = 0 -> calcio d'inizio NERO
1420+ 9902              ;   - Campo NORTH, BallY = 3 -> calcio d'inizio BIANCO
1421+ 9902              ;
1422+ 9902              ; In tutti i casi:
1423+ 9902              ;   - sposta palla e giocatore centrale secondo le regole descritte
1424+ 9902              ;   - Var_Game_VirtualPlayerYPos = 255 (virtual sparisce)
1425+ 9902              ;   - Var_Game_BallDirection = BALL_DIRECTION_NONE
1426+ 9902              ;   - Var_Game_GoalkeeperHasBall = NO
1427+ 9902              ;   - chiama VDP_PlayerMatrixRedraw
1428+ 9902              ;
1429+ 9902              ; MODIFICA: AF, BC, DE, HL
1430+ 9902              ; ---------------------------------------------------------------------------
1431+ 9902              Game_Resume:
1432+ 9902 F5               push af
1433+ 9903 C5               push bc
1434+ 9904 D5               push de
1435+ 9905 E5               push hl
1436+ 9906
1437+ 9906                  ; ---- palla ferma e nessun portiere con palla ----
1438+ 9906 3E 00            ld   a,BALL_DIRECTION_NONE
1439+ 9908 32 27 B2         ld   (Var_Game_BallDirection),a
1440+ 990B
1441+ 990B 3E 00            ld   a,NO
1442+ 990D 32 26 B2         ld   (Var_Game_GoalkeeperHasBall),a
1443+ 9910
1444+ 9910                  ; ---- nascondi virtual player ----
1445+ 9910                  ;ld   a,255
1446+ 9910                  ;ld   (Var_Game_VirtualPlayerYPos),a
1447+ 9910
1448+ 9910                  ; ---- leggi posizione palla ----
1449+ 9910 CD 92 95         call Game_GetBallPosition
1450+ 9913                  ; salviamo Y in C per i confronti
1451+ 9913 4A               ld   c,d                   ; C = Y
1452+ 9914
1453+ 9914                  ; ---- leggi direzione campo ----
1454+ 9914 3A 07 B2         ld   a,(Var_Game_ActiveFieldSide)
1455+ 9917 FE 01            cp   FIELD_NORTH_SIDE
1456+ 9919 28 0B            jr   z,.field_north
1457+ 991B
1458+ 991B                  ; ===== FIELD_SOUTH_SIDE =====
1459+ 991B              .field_south:
1460+ 991B 79               ld   a,c                   ; A = BallY
1461+ 991C FE 04            cp   4
1462+ 991E 28 11            jr   z,.white_goal_kick    ; rimessa dal fondo BIANCA
1463+ 9920
1464+ 9920 FE 00            cp   0
1465+ 9922 28 17            jr   z,.black_kickoff      ; calcio d'inizio NERO
1466+ 9924
1467+ 9924 18 20            jr   .resume_done          ; nessun caso riconosciuto
1468+ 9926
1469+ 9926                  ; ===== FIELD_NORTH_SIDE =====
1470+ 9926              .field_north:
1471+ 9926 79               ld   a,c                   ; A = BallY
1472+ 9927 FE 00            cp   0
1473+ 9929 28 0B            jr   z,.black_goal_kick    ; rimessa dal fondo NERA
1474+ 992B
1475+ 992B FE 03            cp   3
1476+ 992D 28 11            jr   z,.white_kickoff      ; calcio d'inizio BIANCO
1477+ 992F
1478+ 992F 18 15            jr   .resume_done          ; nessun caso riconosciuto
1479+ 9931
1480+ 9931              ; --- Rimessa dal fondo BIANCA (campo SOUTH, ballY = 2) ---
1481+ 9931              .white_goal_kick:
1482+ 9931 CD 4B 99         call Resume_WhiteGoalKick
1483+ 9934 18 0D            jr   .after_case
1484+ 9936
1485+ 9936              ; --- Rimessa dal fondo NERA (campo NORTH, ballY = 1) ---
1486+ 9936              .black_goal_kick:
1487+ 9936 CD 9B 99         call Resume_BlackGoalKick
1488+ 9939 18 08            jr   .after_case
1489+ 993B
1490+ 993B              ; --- Calcio d'inizio NERO (campo SOUTH, ballY = 0) ---
1491+ 993B              .black_kickoff:
1492+ 993B CD EB 99         call Resume_BlackKickoff
1493+ 993E 18 03            jr   .after_case
1494+ 9940
1495+ 9940              ; --- Calcio d'inizio BIANCO (campo NORTH, ballY = 3) ---
1496+ 9940              .white_kickoff:
1497+ 9940 CD 31 9A         call Resume_WhiteKickoff
1498+ 9943                  ; fall-through
1499+ 9943
1500+ 9943              .after_case:
1501+ 9943
1502+ 9943                  ; ridisegna i giocatori (la palla verrà ridisegnata nella nuova posizione)
1503+ 9943 CD 01 8F         call VDP_PlayerMatrixRedraw
1504+ 9946
1505+ 9946              .resume_done:
1506+ 9946 E1               pop  hl
1507+ 9947 D1               pop  de
1508+ 9948 C1               pop  bc
1509+ 9949 F1               pop  af
1510+ 994A                  ;call Hooks_TickStart
1511+ 994A C9               ret
1512+ 994B
1513+ 994B              ; ---------------------------------------------------------------------------
1514+ 994B              ; Resume_WhiteGoalKick
1515+ 994B              ;
1516+ 994B              ; Schema atteso:
1517+ 994B              ;   - Palla:    Y=2, X=2
1518+ 994B              ;   - Bianchi:  Y=3, X=1,2,3   (centrale a 3,2)
1519+ 994B              ;
1520+ 994B              ; Azioni:
1521+ 994B              ;   - Palla -> (Y=2, X=1 o 3 a caso)
1522+ 994B              ;   - Giocatore centrale -> Y=1, X=random(0..4)
1523+ 994B              ; ---------------------------------------------------------------------------
1524+ 994B              Resume_WhiteGoalKick:
1525+ 994B AF               XOR  A
1526+ 994C 32 32 B2         LD   (Var_Game_FirstKickFrameCounter), A
1527+ 994F 3E 03            LD   A, FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
1528+ 9951 32 31 B2         LD   (Var_Game_FirstKickType), A
1529+ 9954 16 02            LD   D, 2
1530+ 9956 1E 02            LD   E, 2
1531+ 9958 CD 9D 95         CALL Game_SetBallPosition
1532+ 995B CD 01 8F         CALL VDP_PlayerMatrixRedraw
1533+ 995E C9               RET
1534+ 995F              .exec:
1535+ 995F CD 8C 8E         CALL  VDP_RemoveVirtualPlayer
1536+ 9962                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=2) ---
1537+ 9962 CD 77 9A         call Game_GetRandomByte
1538+ 9965 E6 01            and  1
1539+ 9967 2E 01            ld   l,1                ; default X = 1
1540+ 9969 28 02            jr   z,.ball_pos_ok
1541+ 996B 2E 03            ld   l,3                ; X = 3
1542+ 996D              .ball_pos_ok:
1543+ 996D 26 02            ld   h,2                ; Y = 2
1544+ 996F E5               PUSH HL
1545+ 9970 D1               POP  DE
1546+ 9971 CD 9D 95         call Game_SetBallPosition
1547+ 9974
1548+ 9974                  ; --- trova il giocatore centrale bianco (Y=3, X=2) ---
1549+ 9974 16 03            ld   d,3                ; Y=3
1550+ 9976 1E 02            ld   e,2                ; X=2
1551+ 9978 CD 74 96         call Game_GetPlayerInfoByPos
1552+ 997B FE FF            cp   NO_VALUE
1553+ 997D C8               ret  z                  ; se non trovato, esci senza fare altro
1554+ 997E
1555+ 997E                  ; qui: B = TEAM, C = ID del giocatore centrale
1556+ 997E
1557+ 997E                  ; --- genera nuova X (0..4) e sposta a Y=1 ---
1558+ 997E CD 7D 9A         call Game_GetRandom0_4  ; A = 0..4
1559+ 9981 5F               ld   e,a                ; E = newX
1560+ 9982 16 01            ld   d,1                ; D = newY (1)
1561+ 9984 CD 32 96         call SetPlayerInfo
1562+ 9987 3E 01            LD   A, YES
1563+ 9989 32 82 B2         LD   (Var_Hooks_ForceVdpRedraw), A
1564+ 998C 3E FF            LD   A, NO_VALUE
1565+ 998E 32 31 B2         LD   (Var_Game_FirstKickType), A
1566+ 9991 CD 50 81         CALL Hooks_TickStart
1567+ 9994 CD 02 AA         call Game_PlayBeep
1568+ 9997 C3 19 82         JP   VBlankISR.Exit
1569+ 999A C9           	ret
1570+ 999B              ; ---------------------------------------------------------------------------
1571+ 999B              ; Resume_BlackGoalKick
1572+ 999B              ;
1573+ 999B              ; Schema atteso:
1574+ 999B              ;   - Palla:   Y=1, X=2
1575+ 999B              ;   - Neri:    Y=1, X=1,2,3   (centrale a 1,2)
1576+ 999B              ;
1577+ 999B              ; Azioni:
1578+ 999B              ;   - Palla -> (Y=1, X=1 o 3 a caso)
1579+ 999B              ;   - Giocatore centrale -> Y=3, X=random(0..4)
1580+ 999B              ; ---------------------------------------------------------------------------
1581+ 999B              Resume_BlackGoalKick:
1582+ 999B AF               XOR  A
1583+ 999C 32 32 B2         LD   (Var_Game_FirstKickFrameCounter), A
1584+ 999F 3E 04            LD   A, FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
1585+ 99A1 32 31 B2         LD   (Var_Game_FirstKickType), A
1586+ 99A4 16 01            LD   D, 1
1587+ 99A6 1E 02            LD   E, 2
1588+ 99A8 CD 9D 95         CALL Game_SetBallPosition
1589+ 99AB CD 01 8F         CALL VDP_PlayerMatrixRedraw
1590+ 99AE C9               ret
1591+ 99AF              .exec:
1592+ 99AF CD 8C 8E         CALL  VDP_RemoveVirtualPlayer
1593+ 99B2                      ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=1) ---
1594+ 99B2 CD 77 9A         call Game_GetRandomByte
1595+ 99B5 E6 01            and  1
1596+ 99B7 2E 01            ld   l,1                ; default X = 1
1597+ 99B9 28 02            jr   z,.ball_pos_ok
1598+ 99BB 2E 03            ld   l,3                ; X = 3
1599+ 99BD              .ball_pos_ok:
1600+ 99BD 26 01            ld   h,1                ; Y = 1
1601+ 99BF E5               PUSH HL
1602+ 99C0 D1               POP  DE
1603+ 99C1 CD 9D 95         call Game_SetBallPosition
1604+ 99C4
1605+ 99C4                  ; --- trova il giocatore centrale nero (Y=1, X=2) ---
1606+ 99C4 16 01            ld   d,1                ; Y=1
1607+ 99C6 1E 02            ld   e,2                ; X=2
1608+ 99C8 CD 74 96         call Game_GetPlayerInfoByPos
1609+ 99CB FE FF            cp   NO_VALUE
1610+ 99CD C8               ret  z
1611+ 99CE
1612+ 99CE                  ; B = TEAM, C = ID del centrale
1613+ 99CE
1614+ 99CE                  ; --- genera nuova X (0..4) e sposta a Y=3 ---
1615+ 99CE CD 7D 9A         call Game_GetRandom0_4
1616+ 99D1 5F               ld   e,a                ; newX
1617+ 99D2 16 03            ld   d,3                ; newY = 3
1618+ 99D4 CD 32 96         call SetPlayerInfo
1619+ 99D7 3E 01            LD   A, YES
1620+ 99D9 32 82 B2         LD   (Var_Hooks_ForceVdpRedraw), A
1621+ 99DC 3E FF            LD   A, NO_VALUE
1622+ 99DE 32 31 B2         LD   (Var_Game_FirstKickType), A
1623+ 99E1 CD 50 81         CALL Hooks_TickStart
1624+ 99E4 CD 02 AA         call Game_PlayBeep
1625+ 99E7 C3 19 82         JP   VBlankISR.Exit
1626+ 99EA C9               ret
1627+ 99EB              ; ---------------------------------------------------------------------------
1628+ 99EB              ; Resume_BlackKickoff
1629+ 99EB              ;
1630+ 99EB              ; Schema atteso:
1631+ 99EB              ;   - Palla:   Y=0, X=2
1632+ 99EB              ;   - Neri:    Y=0, X=1,2,3   (centrale a 0,2)
1633+ 99EB              ;
1634+ 99EB              ; Azioni:
1635+ 99EB              ;   - Palla -> (Y=0, X=1 o 3 a caso)
1636+ 99EB              ;   - Giocatore centrale -> Y=2, X=random(0..4)
1637+ 99EB              ; ---------------------------------------------------------------------------
1638+ 99EB              Resume_BlackKickoff:
1639+ 99EB AF               XOR  A
1640+ 99EC 32 32 B2         LD   (Var_Game_FirstKickFrameCounter), A
1641+ 99EF 3E 02            LD   A, FIRST_KICK_TYPE_BLACK_HALF_FIELD
1642+ 99F1 32 31 B2         LD   (Var_Game_FirstKickType), A
1643+ 99F4 C9               RET
1644+ 99F5              .exec:
1645+ 99F5 CD 8C 8E         CALL  VDP_RemoveVirtualPlayer
1646+ 99F8                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=0) ---
1647+ 99F8 CD 77 9A         call Game_GetRandomByte
1648+ 99FB E6 01            and  1
1649+ 99FD 2E 01            ld   l,1                ; default X = 1
1650+ 99FF 28 02            jr   z,.ball_pos_ok
1651+ 9A01 2E 03            ld   l,3                ; X = 3
1652+ 9A03              .ball_pos_ok:
1653+ 9A03 26 00            ld   h,0                ; Y = 0
1654+ 9A05 E5               PUSH HL
1655+ 9A06 D1               POP  DE
1656+ 9A07 CD 9D 95         call Game_SetBallPosition
1657+ 9A0A
1658+ 9A0A                  ; --- trova il giocatore centrale nero (Y=0, X=2) ---
1659+ 9A0A 16 00            ld   d,0                ; Y=0
1660+ 9A0C 1E 02            ld   e,2                ; X=2
1661+ 9A0E CD 74 96         call Game_GetPlayerInfoByPos
1662+ 9A11 FE FF            cp   NO_VALUE
1663+ 9A13 C8               ret  z
1664+ 9A14
1665+ 9A14                  ; B = TEAM, C = ID
1666+ 9A14
1667+ 9A14                  ; --- genera nuova X (0..4) e sposta a Y=2 ---
1668+ 9A14 CD 7D 9A         call Game_GetRandom0_4
1669+ 9A17 5F               ld   e,a                ; newX
1670+ 9A18 16 02            ld   d,2                ; newY = 2
1671+ 9A1A CD 32 96         call SetPlayerInfo
1672+ 9A1D 3E 01            LD   A, YES
1673+ 9A1F 32 82 B2         LD   (Var_Hooks_ForceVdpRedraw), A
1674+ 9A22 3E FF            LD   A, NO_VALUE
1675+ 9A24 32 31 B2         LD   (Var_Game_FirstKickType), A
1676+ 9A27 CD 50 81         CALL Hooks_TickStart
1677+ 9A2A CD 02 AA         call Game_PlayBeep
1678+ 9A2D C3 19 82         JP   VBlankISR.Exit
1679+ 9A30 C9               ret
1680+ 9A31              ; ---------------------------------------------------------------------------
1681+ 9A31              ; Resume_WhiteKickoff
1682+ 9A31              ;
1683+ 9A31              ; Schema atteso:
1684+ 9A31              ;   - Palla:   Y=3, X=2
1685+ 9A31              ;   - Bianchi: Y=4, X=1,2,3   (centrale a 4,2)
1686+ 9A31              ;
1687+ 9A31              ; Azioni:
1688+ 9A31              ;   - Palla -> (Y=3, X=1 o 3 a caso)
1689+ 9A31              ;   - Giocatore centrale -> Y=2, X=random(0..4)
1690+ 9A31              ; ---------------------------------------------------------------------------
1691+ 9A31              Resume_WhiteKickoff:
1692+ 9A31 AF               XOR  A
1693+ 9A32 32 32 B2         LD   (Var_Game_FirstKickFrameCounter), A
1694+ 9A35 3E 01            LD   A, FIRST_KICK_TYPE_WHITE_HALF_FIELD
1695+ 9A37 32 31 B2         LD   (Var_Game_FirstKickType), A
1696+ 9A3A C9               RET
1697+ 9A3B              .exec:
1698+ 9A3B CD 8C 8E         CALL  VDP_RemoveVirtualPlayer
1699+ 9A3E                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=3) ---
1700+ 9A3E CD 77 9A         call Game_GetRandomByte
1701+ 9A41 E6 01            and  1
1702+ 9A43 2E 01            ld   l,1                ; default X = 1
1703+ 9A45 28 02            jr   z,.ball_pos_ok
1704+ 9A47 2E 03            ld   l,3                ; X = 3
1705+ 9A49              .ball_pos_ok:
1706+ 9A49 26 03            ld   h,3                ; Y = 3
1707+ 9A4B E5               PUSH HL
1708+ 9A4C D1               POP  DE
1709+ 9A4D CD 9D 95         call Game_SetBallPosition
1710+ 9A50
1711+ 9A50                  ; --- trova il giocatore centrale bianco (Y=4, X=2) ---
1712+ 9A50 16 04            ld   d,4                ; Y=4
1713+ 9A52 1E 02            ld   e,2                ; X=2
1714+ 9A54 CD 74 96         call Game_GetPlayerInfoByPos
1715+ 9A57 FE FF            cp   NO_VALUE
1716+ 9A59 C8               ret  z
1717+ 9A5A
1718+ 9A5A                  ; B = TEAM, C = ID
1719+ 9A5A
1720+ 9A5A                  ; --- genera nuova X (0..4) e sposta a Y=2 ---
1721+ 9A5A CD 7D 9A         call Game_GetRandom0_4
1722+ 9A5D 5F               ld   e,a                ; newX
1723+ 9A5E 16 02            ld   d,2                ; newY = 2
1724+ 9A60 CD 32 96         call SetPlayerInfo
1725+ 9A63 3E 01            LD   A, YES
1726+ 9A65 32 82 B2         LD   (Var_Hooks_ForceVdpRedraw), A
1727+ 9A68 3E FF            LD   A, NO_VALUE
1728+ 9A6A 32 31 B2         LD   (Var_Game_FirstKickType), A
1729+ 9A6D CD 50 81         CALL Hooks_TickStart
1730+ 9A70 CD 02 AA         call Game_PlayBeep
1731+ 9A73 C3 19 82         JP   VBlankISR.Exit
1732+ 9A76 C9               ret
1733+ 9A77
1734+ 9A77              ; ---------------------------------------------------------------------------
1735+ 9A77              ; Game_GetRandomByte
1736+ 9A77              ; Restituisce 0..255 utilizzando Utils_GetRandomNumber (0..127)
1737+ 9A77              ; MODIFIES: AF, BC
1738+ 9A77              ; ---------------------------------------------------------------------------
1739+ 9A77              Game_GetRandomByte:
1740+ 9A77 CD 4E 93         CALL Utils_GetRandomNumber     ; A = 0..127
1741+ 9A7A CB 27            SLA  A                         ; 0..254 (raddoppio)
1742+ 9A7C C9               RET
1743+ 9A7D              ; ---------------------------------------------------------------------------
1744+ 9A7D              ; Game_GetRandom0_4
1745+ 9A7D              ; Restituisce A = 0..4
1746+ 9A7D              ; MODIFIES: AF
1747+ 9A7D              ; ---------------------------------------------------------------------------
1748+ 9A7D              Game_GetRandom0_4:
1749+ 9A7D C5               PUSH BC
1750+ 9A7E D5               PUSH DE
1751+ 9A7F E5               PUSH HL
1752+ 9A80 CD 4E 93         CALL Utils_GetRandomNumber     ; A = 0..127
1753+ 9A83
1754+ 9A83                  ; riduci a 0..7 (modulo 8)
1755+ 9A83 E6 07            AND  00000111b                 ; 0..7
1756+ 9A85
1757+ 9A85 FE 05            CP   5
1758+ 9A87 38 02            JR   C,.ok                     ; 0..4 → ok
1759+ 9A89 D6 05            SUB  5                         ; 5,6,7 → 0,1,2
1760+ 9A8B              .ok:
1761+ 9A8B E1               POP  HL
1762+ 9A8C D1               POP  DE
1763+ 9A8D C1               POP  BC
1764+ 9A8E C9               RET
1765+ 9A8F
1766+ 9A8F              ; ---------------------------------------------------------------------------
1767+ 9A8F              ; Game_GetRandom0_20
1768+ 9A8F              ; Restituisce A = 0..20
1769+ 9A8F              ; Usa Utils_GetRandomNumber (0..127)
1770+ 9A8F              ; MODIFIES: AF
1771+ 9A8F              ; ---------------------------------------------------------------------------
1772+ 9A8F              Game_GetRandom0_20:
1773+ 9A8F C5               PUSH BC
1774+ 9A90              .loop:
1775+ 9A90 CD 4E 93         CALL Utils_GetRandomNumber     ; A = 0..127
1776+ 9A93 FE 69            CP   105                       ; 105 = 21 * 5
1777+ 9A95 30 F9            JR   NC,.loop                  ; scarta 105..127
1778+ 9A97                  ; A = 0..104
1779+ 9A97 06 15            LD   B,21
1780+ 9A99                  ; A mod 21
1781+ 9A99              .mod:
1782+ 9A99 90               SUB  B
1783+ 9A9A 30 FD            JR   NC,.mod
1784+ 9A9C 80               ADD  B                         ; ripristina ultimo valido
1785+ 9A9D C1               POP  BC
1786+ 9A9E C9               RET
1787+ 9A9F
1788+ 9A9F
1789+ 9A9F
1790+ 9A9F
1791+ 9A9F
1792+ 9A9F              ; ---------------------------------------------------------------------------
1793+ 9A9F              ; Game_GetPlayerIdWithBall
1794+ 9A9F              ;
1795+ 9A9F              ; Determina chi possiede la palla (se qualcuno) a seconda della posizione
1796+ 9A9F              ; della palla e dei giocatori.
1797+ 9A9F              ;
1798+ 9A9F              ; OUTPUT:
1799+ 9A9F              ;   A = TEAM_BLACK / TEAM_WHITE
1800+ 9A9F              ;       oppure BALL_STATUS_MOVING / BALL_STATUS_FREE / BALL_STATUS_CONTENDED
1801+ 9A9F              ;   H = ID giocatore che possiede la palla (0..3) oppure 255 se nessuno
1802+ 9A9F              ;   L = ID eventuale contendente (per ora sempre 255 nei casi definiti)
1803+ 9A9F              ;
1804+ 9A9F              ; MODIFIES:
1805+ 9A9F              ;   AF, BC, DE, HL
1806+ 9A9F              ; ---------------------------------------------------------------------------
1807+ 9A9F              Game_GetPlayerIdWithBall:
1808+ 9A9F                  ; default: nessuno
1809+ 9A9F 26 FF            ld   h,255
1810+ 9AA1 2E FF            ld   l,255
1811+ 9AA3
1812+ 9AA3                  ; --- 1) se la palla è in movimento, nessun possesso -------------------
1813+ 9AA3 3A 27 B2         ld   a,(Var_Game_BallDirection)
1814+ 9AA6 FE 00            cp   BALL_DIRECTION_NONE
1815+ 9AA8 28 03            jr   z,.check_static
1816+ 9AAA 3E 64            ld   a,BALL_STATUS_MOVING
1817+ 9AAC C9               ret
1818+ 9AAD
1819+ 9AAD              .check_static:
1820+ 9AAD                  ; --- 2) HL = X,Y della palla -----------------------------------------
1821+ 9AAD CD 92 95         call  Game_GetBallPosition
1822+ 9AB0 D5               PUSH  DE
1823+ 9AB1 E1               POP   HL
1824+ 9AB2                  ; azzera i flag temporanei
1825+ 9AB2 AF               xor  a
1826+ 9AB3 32 0C B2         ld   (Var_Game_BallTmp_FoundBelow),a
1827+ 9AB6 32 0F B2         ld   (Var_Game_BallTmp_FoundAbove),a
1828+ 9AB9
1829+ 9AB9                  ; salviamo la posizione della palla
1830+ 9AB9 E5               push hl                     ; [SP] = X,Y
1831+ 9ABA
1832+ 9ABA                  ; ============================================================
1833+ 9ABA                  ; Test 1: stessa cella della palla (giocatore nero, se presente)
1834+ 9ABA                  ; ============================================================
1835+ 9ABA                  ; D = Y, E = X
1836+ 9ABA 54               ld   d,h
1837+ 9ABB 5D               ld   e,l
1838+ 9ABC CD 74 96         call Game_GetPlayerInfoByPos
1839+ 9ABF FE FF            cp   NO_VALUE
1840+ 9AC1 28 0D            jr   z,.no_player_below
1841+ 9AC3
1842+ 9AC3                  ; trovato giocatore "sotto" (in stessa cella della palla)
1843+ 9AC3 3E 01            ld   a,1
1844+ 9AC5 32 0C B2         ld   (Var_Game_BallTmp_FoundBelow),a
1845+ 9AC8 78               ld   a,b
1846+ 9AC9 32 11 B2         ld   (Var_Game_BallTmp_TeamBelow),a
1847+ 9ACC 79               ld   a,c
1848+ 9ACD 32 12 B2         ld   (Var_Game_BallTmp_IdBelow),a
1849+ 9AD0
1850+ 9AD0              .no_player_below:
1851+ 9AD0
1852+ 9AD0                  ; ============================================================
1853+ 9AD0                  ; Test 2: riga successiva stessa colonna (giocatore bianco, se presente)
1854+ 9AD0                  ; ============================================================
1855+ 9AD0 E1               pop  hl                     ; HL = X,Y (ripristinato)
1856+ 9AD1 E5               push hl                     ; lo risalviamo per sicurezza (anche se poi non lo useremo più)
1857+ 9AD2
1858+ 9AD2 7C               ld   a,h                    ; A = Y
1859+ 9AD3 FE 04            cp   4
1860+ 9AD5 28 17            jr   z,.no_player_above     ; se Y=4, non esiste Y+1 nel campo 0..4
1861+ 9AD7
1862+ 9AD7 3C               inc  a                      ; Y+1
1863+ 9AD8 57               ld   d,a                    ; D = Y+1
1864+ 9AD9 5D               ld   e,l                    ; E = X
1865+ 9ADA CD 74 96         call Game_GetPlayerInfoByPos
1866+ 9ADD FE FF            cp   NO_VALUE
1867+ 9ADF 28 0D            jr   z,.no_player_above
1868+ 9AE1
1869+ 9AE1                  ; trovato giocatore "sopra" (in riga successiva)
1870+ 9AE1 3E 01            ld   a,1
1871+ 9AE3 32 0F B2         ld   (Var_Game_BallTmp_FoundAbove),a
1872+ 9AE6 78               ld   a,b
1873+ 9AE7 32 10 B2         ld   (Var_Game_BallTmp_TeamAbove),a
1874+ 9AEA 79               ld   a,c
1875+ 9AEB 32 13 B2         ld   (Var_Game_BallTmp_IdAbove),a
1876+ 9AEE
1877+ 9AEE              .no_player_above:
1878+ 9AEE E1               pop  hl                     ; buttiamo via la copia di sicurezza
1879+ 9AEF
1880+ 9AEF                  ; ============================================================
1881+ 9AEF                  ; 3) Valutazione combinazioni
1882+ 9AEF                  ; ============================================================
1883+ 9AEF
1884+ 9AEF                  ; carichiamo flag in A/B solo per facilità
1885+ 9AEF 3A 0C B2         ld   a,(Var_Game_BallTmp_FoundBelow)
1886+ 9AF2 47               ld   b,a                     ; B = foundBelow (0/1)
1887+ 9AF3 3A 0F B2         ld   a,(Var_Game_BallTmp_FoundAbove)
1888+ 9AF6 4F               ld   c,a                     ; C = foundAbove (0/1)
1889+ 9AF7
1890+ 9AF7                  ; caso: nessuno dei due
1891+ 9AF7 78               ld   a,b
1892+ 9AF8 B1               or   c
1893+ 9AF9 20 07            jr   nz,.not_free
1894+ 9AFB
1895+ 9AFB                  ; nessun giocatore sotto né sopra
1896+ 9AFB 3E 66            ld   a,BALL_STATUS_FREE
1897+ 9AFD 26 FF            ld   h,255
1898+ 9AFF 2E FF            ld   l,255
1899+ 9B01 C9               ret
1900+ 9B02
1901+ 9B02              .not_free:
1902+ 9B02                  ; caso: entrambi presenti → palla contesa
1903+ 9B02 78               ld   a,b                     ; A = foundBelow
1904+ 9B03 A1               and  c                       ; A = 1 solo se entrambi sono 1
1905+ 9B04 28 07            jr   z,.single_side
1906+ 9B06
1907+ 9B06                  ; palla contesa tra nero e bianco
1908+ 9B06 3E 65            ld   a,BALL_STATUS_CONTENDED
1909+ 9B08 26 FF            ld   h,255
1910+ 9B0A 2E FF            ld   l,255
1911+ 9B0C C9               ret
1912+ 9B0D
1913+ 9B0D              .single_side:
1914+ 9B0D                  ; se qui: esattamente uno dei due è 1.
1915+ 9B0D
1916+ 9B0D                  ; se foundBelow = 1 (giocatore nella cella della palla) → nero
1917+ 9B0D 78               ld   a,b
1918+ 9B0E B7               or   a
1919+ 9B0F 28 0A            jr   z,.only_above
1920+ 9B11
1921+ 9B11                  ; --- solo giocatore nella cella della palla (nero) --------------------
1922+ 9B11 3A 12 B2         ld   a,(Var_Game_BallTmp_IdBelow)    ; ID
1923+ 9B14 67               ld   h,a
1924+ 9B15 3A 11 B2         ld   a,(Var_Game_BallTmp_TeamBelow)  ; TEAM (tipicamente TEAM_BLACK)
1925+ 9B18
1926+ 9B18 2E FF            ld   l,255
1927+ 9B1A C9               ret
1928+ 9B1B
1929+ 9B1B              .only_above:
1930+ 9B1B                  ; --- solo giocatore nella riga successiva (bianco) --------------------
1931+ 9B1B 3A 13 B2         ld   a,(Var_Game_BallTmp_IdAbove)    ; ID
1932+ 9B1E 67               ld   h,a
1933+ 9B1F 3A 10 B2         ld   a,(Var_Game_BallTmp_TeamAbove)  ; TEAM (tipicamente TEAM_WHITE)
1934+ 9B22
1935+ 9B22 2E FF            ld   l,255
1936+ 9B24 C9               ret
1937+ 9B25              ; ---------------------------------------------------------------------------
1938+ 9B25              ; Game_TryMovePlayerVertically
1939+ 9B25              ;
1940+ 9B25              ; INPUT:
1941+ 9B25              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
1942+ 9B25              ;   C = ID    (0..3)
1943+ 9B25              ;   A = direzione richiesta:
1944+ 9B25              ;       PLAYER_ASKED_DIRECTION_NORTH
1945+ 9B25              ;       PLAYER_ASKED_DIRECTION_SOUTH
1946+ 9B25              ;
1947+ 9B25              ; OUTPUT:
1948+ 9B25              ;   A = SUCCESS oppure FAILURE
1949+ 9B25              ;
1950+ 9B25              ; MODIFIES:
1951+ 9B25              ;   AF, BC, DE, HL
1952+ 9B25              ; ---------------------------------------------------------------------------
1953+ 9B25              Game_TryMovePlayerVertically:
1954+ 9B25                  ; Salva la direzione richiesta
1955+ 9B25 F5               push af              ; [SP] = dir
1956+ 9B26
1957+ 9B26
1958+ 9B26                  ; --- i portieri NON possono muoversi verticalmente ---
1959+ 9B26 79               ld   a,c
1960+ 9B27 B7               or   a
1961+ 9B28 C2 2F 9B         jp   nz, .gtmv_not_goalkeeper
1962+ 9B2B
1963+ 9B2B                  ; ID=0 → portiere → FALLISCE
1964+ 9B2B F1               pop  af              ; rimuovi dir dallo stack
1965+ 9B2C 3E 00            ld   a,FAILURE
1966+ 9B2E C9               ret
1967+ 9B2F
1968+ 9B2F              .gtmv_not_goalkeeper:
1969+ 9B2F                  ; --- verifica che il giocatore NON abbia la palla ---
1970+ 9B2F C5               push bc              ; salva TEAM/ID per il confronto
1971+ 9B30 CD 9F 9A         call Game_GetPlayerIdWithBall
1972+ 9B33                  ; Risultato:
1973+ 9B33                  ;   A = stato/team (TEAM_BLACK/TEAM_WHITE o BALL_STATUS_xxx)
1974+ 9B33                  ;   H = ID del giocatore in possesso (o 255)
1975+ 9B33                  ;   L = ID contendente (o 255)
1976+ 9B33 C1               pop  bc              ; ripristina B=TEAM, C=ID del giocatore richiesto
1977+ 9B34 FE 65            CP   BALL_STATUS_CONTENDED
1978+ 9B36 20 04            JR   NZ, .no_contended_ball
1979+ 9B38
1980+ 9B38 F1               pop  af              ; rimuovi dir dallo stack
1981+ 9B39 3E 00            ld   a,FAILURE
1982+ 9B3B C9               ret
1983+ 9B3C
1984+ 9B3C              .no_contended_ball:
1985+ 9B3C                  ; Se A è TEAM_BLACK o TEAM_WHITE e (A==B e H==C) → ha la palla
1986+ 9B3C 57               ld   d,a             ; D = stato/team
1987+ 9B3D
1988+ 9B3D
1989+ 9B3D FE 00            cp   TEAM_BLACK
1990+ 9B3F CA 47 9B         jp   z, .gtmv_check_owner_team
1991+ 9B42 FE 01            cp   TEAM_WHITE
1992+ 9B44 C2 54 9B         jp   nz, .gtmv_no_ball_owned   ; stato non è un team → nessuno in possesso
1993+ 9B47
1994+ 9B47              .gtmv_check_owner_team:
1995+ 9B47                  ; A = TEAM_BLACK o TEAM_WHITE, D = stesso valore
1996+ 9B47 B8               cp   b
1997+ 9B48 C2 54 9B         jp   nz, .gtmv_no_ball_owned   ; altra squadra
1998+ 9B4B
1999+ 9B4B                  ; stessa squadra, confronta ID
2000+ 9B4B 7C               ld   a,h                       ; H = ID possessore
2001+ 9B4C B9               cp   c
2002+ 9B4D C2 54 9B         jp   nz, .gtmv_no_ball_owned   ; non è il nostro giocatore
2003+ 9B50
2004+ 9B50                  ; --- il giocatore richiesto ha la palla → non può muoversi verticalmente ---
2005+ 9B50 F1               pop  af                        ; rimuovi dir dallo stack
2006+ 9B51 3E 00            ld   a,FAILURE
2007+ 9B53 C9               ret
2008+ 9B54
2009+ 9B54              .gtmv_no_ball_owned:
2010+ 9B54                  ; --- recupera posizione corrente del giocatore ---
2011+ 9B54 CD 59 96         call Game_GetPlayerInfoById    ; HL = curr (H=Y, L=X)
2012+ 9B57
2013+ 9B57 E5               push hl
2014+ 9B58 D1               pop de                        ; DE = curr (D=currY, E=currX)
2015+ 9B59 CD F8 9C         CALL CheckBallAtPosition
2016+ 9B5C FE 01            CP   YES
2017+ 9B5E CA F5 9C         jp   z, .gtmv_fail_pop        ; palla sulla posizione corrente
2018+ 9B61                  ; HL: H = currY, L = currX
2019+ 9B61 F1               pop  af                        ; A = direzione richiesta
2020+ 9B62 57               ld   d,a                       ; D = direzione
2021+ 9B63                  ; H = currY, L = currX, B = TEAM, C = ID
2022+ 9B63
2023+ 9B63                  ; --- controlla metà campo attiva ---
2024+ 9B63 3A 07 B2         ld   a,(Var_Game_ActiveFieldSide)
2025+ 9B66 FE 01            cp   FIELD_NORTH_SIDE
2026+ 9B68 CA 29 9C         jp   z, .gtmv_side_north
2027+ 9B6B
2028+ 9B6B                  ; --------- FIELD_SOUTH_SIDE ---------------------------------
2029+ 9B6B              .gtmv_side_south:
2030+ 9B6B 78               ld   a,b
2031+ 9B6C FE 01            cp   TEAM_WHITE
2032+ 9B6E CA CD 9B         jp   z, .gtmv_south_white
2033+ 9B71
2034+ 9B71                  ; ----- TEAM_BLACK, FIELD_SOUTH_SIDE -----
2035+ 9B71 7A               ld   a,d                      ; direzione
2036+ 9B72 FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2037+ 9B74 CA 7F 9B         jp   z, .gtmv_sb_move_up
2038+ 9B77 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2039+ 9B79 CA A6 9B         jp   z, .gtmv_sb_move_down
2040+ 9B7C C3 F2 9C         jp   .gtmv_fail               ; direzione invalida
2041+ 9B7F
2042+ 9B7F              ; Nero, campo SOUTH, move NORTH:
2043+ 9B7F              ; deve essere su riga 2, target riga 0
2044+ 9B7F              .gtmv_sb_move_up:
2045+ 9B7F 7C               ld   a,h                      ; currY
2046+ 9B80 FE 02            cp   2
2047+ 9B82 C2 F2 9C         jp   nz, .gtmv_fail
2048+ 9B85
2049+ 9B85                  ; verifica che in (Y=0, X=L) non ci sia nessun giocatore
2050+ 9B85 16 00            ld   d,0                      ; targetY
2051+ 9B87 5D               ld   e,l                      ; targetX = currX
2052+ 9B88 C5               push bc
2053+ 9B89 E5               push hl
2054+ 9B8A CD 74 96         call Game_GetPlayerInfoByPos
2055+ 9B8D E1               pop  hl
2056+ 9B8E C1               pop  bc
2057+ 9B8F FE FF            cp   NO_VALUE
2058+ 9B91 C2 F2 9C         jp   nz, .gtmv_fail           ; cella occupata
2059+ 9B94
2060+ 9B94                  ; verifica che in (Y=0, X=L) non ci sia la palla
2061+ 9B94                  ;ld   d,0
2062+ 9B94                  ;ld   e,l
2063+ 9B94                  ;CALL CheckBallAtPosition
2064+ 9B94                  ;CP   NO
2065+ 9B94                  ;jp   z, .no_ball_sb_up
2066+ 9B94                  ;jp   .gtmv_fail               ; palla sulla destinazione
2067+ 9B94
2068+ 9B94              .no_ball_sb_up:
2069+ 9B94                  ; conta i compagni sulla riga 0
2070+ 9B94 C5               push bc
2071+ 9B95 16 00            ld   d,0
2072+ 9B97 CD 62 9E         call Game_CountTeamPlayersOnRow
2073+ 9B9A C1               pop  bc
2074+ 9B9B FE 02            cp   2
2075+ 9B9D D2 F2 9C         jp   nc, .gtmv_fail           ; già 2 → non possiamo aggiungerne un terzo
2076+ 9BA0
2077+ 9BA0                  ; sposta il giocatore a (0, X)
2078+ 9BA0 16 00            ld   d,0
2079+ 9BA2 5D               ld   e,l
2080+ 9BA3                  ;call SetPlayerInfo
2081+ 9BA3 C3 E7 9C         jp   .gtmv_success
2082+ 9BA6
2083+ 9BA6              ; Nero, campo SOUTH, move SOUTH:
2084+ 9BA6              ; deve essere su riga 0, target riga 2
2085+ 9BA6              .gtmv_sb_move_down:
2086+ 9BA6 7C               ld   a,h                      ; currY
2087+ 9BA7 FE 00            cp   0
2088+ 9BA9 C2 F2 9C         jp   nz, .gtmv_fail
2089+ 9BAC
2090+ 9BAC 16 02            ld   d,2
2091+ 9BAE 5D               ld   e,l
2092+ 9BAF C5               push bc
2093+ 9BB0 E5               push hl
2094+ 9BB1 CD 74 96         call Game_GetPlayerInfoByPos
2095+ 9BB4 E1               pop  hl
2096+ 9BB5 C1               pop  bc
2097+ 9BB6 FE FF            cp   NO_VALUE
2098+ 9BB8 C2 F2 9C         jp   nz, .gtmv_fail
2099+ 9BBB
2100+ 9BBB                  ;; verifica palla in (2, currX)
2101+ 9BBB                  ;ld   d,2
2102+ 9BBB                  ;ld   e,l
2103+ 9BBB                  ;CALL CheckBallAtPosition
2104+ 9BBB                  ;CP   NO
2105+ 9BBB                  ;jp   z, .no_ball_sb_down
2106+ 9BBB                  ;jp   .gtmv_fail
2107+ 9BBB
2108+ 9BBB              .no_ball_sb_down:
2109+ 9BBB                  ; conta i compagni sulla riga 2
2110+ 9BBB C5               push bc
2111+ 9BBC 16 02            ld   d,2
2112+ 9BBE CD 62 9E         call Game_CountTeamPlayersOnRow
2113+ 9BC1 C1               pop  bc
2114+ 9BC2 FE 02            cp   2
2115+ 9BC4 D2 F2 9C         jp   nc, .gtmv_fail
2116+ 9BC7
2117+ 9BC7 16 02            ld   d,2
2118+ 9BC9 5D               ld   e,l
2119+ 9BCA                  ;call SetPlayerInfo
2120+ 9BCA C3 E7 9C         jp   .gtmv_success
2121+ 9BCD
2122+ 9BCD              ; ----- TEAM_WHITE, FIELD_SOUTH_SIDE -----
2123+ 9BCD              .gtmv_south_white:
2124+ 9BCD 7A               ld   a,d                      ; direzione
2125+ 9BCE FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2126+ 9BD0 CA DB 9B         jp   z, .gtmv_sw_move_up
2127+ 9BD3 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2128+ 9BD5 CA 02 9C         jp   z, .gtmv_sw_move_down
2129+ 9BD8 C3 F2 9C         jp   .gtmv_fail
2130+ 9BDB
2131+ 9BDB              ; Bianco, campo SOUTH, move NORTH:
2132+ 9BDB              ; deve essere su riga 3, target riga 1
2133+ 9BDB              .gtmv_sw_move_up:
2134+ 9BDB 7C               ld   a,h                      ; currY
2135+ 9BDC FE 03            cp   3
2136+ 9BDE C2 F2 9C         jp   nz, .gtmv_fail
2137+ 9BE1
2138+ 9BE1
2139+ 9BE1 16 01            ld   d,1
2140+ 9BE3 5D               ld   e,l
2141+ 9BE4 C5               push bc
2142+ 9BE5 E5               push hl
2143+ 9BE6 CD 74 96         call Game_GetPlayerInfoByPos
2144+ 9BE9 E1               pop  hl
2145+ 9BEA C1               pop  bc
2146+ 9BEB FE FF            cp   NO_VALUE
2147+ 9BED
2148+ 9BED C2 F2 9C         jp   nz, .gtmv_fail
2149+ 9BF0
2150+ 9BF0                  ; verifica palla in (1, currX)
2151+ 9BF0                  ;ld   d,1
2152+ 9BF0                  ;ld   e,l
2153+ 9BF0                  ;CALL CheckBallAtPosition
2154+ 9BF0                  ;CP   NO
2155+ 9BF0                  ;jp   z, .no_ball_sw_up
2156+ 9BF0                  ;jp   .gtmv_fail
2157+ 9BF0
2158+ 9BF0              .no_ball_sw_up:
2159+ 9BF0                  ; conta i compagni sulla riga 1
2160+ 9BF0 C5               push bc
2161+ 9BF1 16 01            ld   d,1
2162+ 9BF3 CD 62 9E         call Game_CountTeamPlayersOnRow
2163+ 9BF6 C1               pop  bc
2164+ 9BF7 FE 02            cp   2
2165+ 9BF9 D2 F2 9C         jp   nc, .gtmv_fail
2166+ 9BFC
2167+ 9BFC 16 01            ld   d,1
2168+ 9BFE 5D               ld   e,l
2169+ 9BFF                  ;call SetPlayerInfo
2170+ 9BFF C3 E7 9C         jp   .gtmv_success
2171+ 9C02
2172+ 9C02              ; Bianco, campo SOUTH, move SOUTH:
2173+ 9C02              ; deve essere su riga 1, target riga 3
2174+ 9C02              .gtmv_sw_move_down:
2175+ 9C02 7C               ld   a,h                      ; currY
2176+ 9C03 FE 01            cp   1
2177+ 9C05 C2 F2 9C         jp   nz, .gtmv_fail
2178+ 9C08
2179+ 9C08
2180+ 9C08 16 03            ld   d,3
2181+ 9C0A 5D               ld   e,l
2182+ 9C0B C5               push bc
2183+ 9C0C E5               push hl
2184+ 9C0D CD 74 96         call Game_GetPlayerInfoByPos
2185+ 9C10 E1               pop  hl
2186+ 9C11 C1               pop  bc
2187+ 9C12
2188+ 9C12 FE FF            cp   NO_VALUE
2189+ 9C14
2190+ 9C14 C2 F2 9C         jp   nz, .gtmv_fail
2191+ 9C17
2192+ 9C17                  ; verifica palla in (3, currX)
2193+ 9C17                  ;ld   d,3
2194+ 9C17                  ;ld   e,l
2195+ 9C17                  ;CALL CheckBallAtPosition
2196+ 9C17                  ;CP   NO
2197+ 9C17                  ;jp   z, .no_ball_sw_down
2198+ 9C17                  ;jp   .gtmv_fail
2199+ 9C17
2200+ 9C17              .no_ball_sw_down:
2201+ 9C17                  ; conta i compagni sulla riga 3
2202+ 9C17 C5               push bc
2203+ 9C18 16 03            ld   d,3
2204+ 9C1A CD 62 9E         call Game_CountTeamPlayersOnRow
2205+ 9C1D C1               pop  bc
2206+ 9C1E FE 02            cp   2
2207+ 9C20 D2 F2 9C         jp   nc, .gtmv_fail
2208+ 9C23
2209+ 9C23 16 03            ld   d,3
2210+ 9C25 5D               ld   e,l
2211+ 9C26                  ;call SetPlayerInfo
2212+ 9C26 C3 E7 9C         jp   .gtmv_success
2213+ 9C29
2214+ 9C29
2215+ 9C29              ; --------- FIELD_NORTH_SIDE ------------------------------------
2216+ 9C29              .gtmv_side_north:
2217+ 9C29 78               ld   a,b
2218+ 9C2A FE 01            cp   TEAM_WHITE
2219+ 9C2C CA 8B 9C         jp   z, .gtmv_north_white
2220+ 9C2F
2221+ 9C2F                  ; ----- TEAM_BLACK, FIELD_NORTH_SIDE -----
2222+ 9C2F 7A               ld   a,d                      ; direzione
2223+ 9C30 FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2224+ 9C32 CA 3D 9C         jp   z, .gtmv_nb_move_up
2225+ 9C35 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2226+ 9C37 CA 64 9C         jp   z, .gtmv_nb_move_down
2227+ 9C3A C3 F2 9C         jp   .gtmv_fail
2228+ 9C3D
2229+ 9C3D              ; Nero, campo NORTH, move NORTH:
2230+ 9C3D              ; deve essere su riga 3, target riga 1
2231+ 9C3D              .gtmv_nb_move_up:
2232+ 9C3D 7C               ld   a,h                      ; currY
2233+ 9C3E FE 03            cp   3
2234+ 9C40 C2 F2 9C         jp   nz, .gtmv_fail
2235+ 9C43
2236+ 9C43
2237+ 9C43 16 01            ld   d,1
2238+ 9C45 5D               ld   e,l
2239+ 9C46 C5               push bc
2240+ 9C47 E5               push hl
2241+ 9C48 CD 74 96         call Game_GetPlayerInfoByPos
2242+ 9C4B E1               pop  hl
2243+ 9C4C C1               pop  bc
2244+ 9C4D FE FF            cp   NO_VALUE
2245+ 9C4F
2246+ 9C4F C2 F2 9C         jp   nz, .gtmv_fail
2247+ 9C52
2248+ 9C52                  ; verifica palla in (1, currX)
2249+ 9C52                  ;ld   d,1
2250+ 9C52                  ;ld   e,l
2251+ 9C52                  ;CALL CheckBallAtPosition
2252+ 9C52                  ;CP   NO
2253+ 9C52                  ;jp   z, .no_ball_nb_up
2254+ 9C52                  ;jp   .gtmv_fail
2255+ 9C52
2256+ 9C52              .no_ball_nb_up:
2257+ 9C52                  ; conta i compagni sulla riga 1
2258+ 9C52 C5               push bc
2259+ 9C53 16 01            ld   d,1
2260+ 9C55 CD 62 9E         call Game_CountTeamPlayersOnRow
2261+ 9C58 C1               pop  bc
2262+ 9C59 FE 02            cp   2
2263+ 9C5B CA F2 9C         jp   z, .gtmv_fail
2264+ 9C5E
2265+ 9C5E 16 01            ld   d,1
2266+ 9C60 5D               ld   e,l
2267+ 9C61                  ;call SetPlayerInfo
2268+ 9C61 C3 E7 9C         jp   .gtmv_success
2269+ 9C64
2270+ 9C64              ; Nero, campo NORTH, move SOUTH:
2271+ 9C64              ; deve essere su riga 1, target riga 3
2272+ 9C64              .gtmv_nb_move_down:
2273+ 9C64 7C               ld   a,h
2274+ 9C65 FE 01            cp   1
2275+ 9C67 C2 F2 9C         jp   nz, .gtmv_fail
2276+ 9C6A
2277+ 9C6A 16 03            ld   d,3
2278+ 9C6C 5D               ld   e,l
2279+ 9C6D C5               push bc
2280+ 9C6E E5               push hl
2281+ 9C6F CD 74 96         call Game_GetPlayerInfoByPos
2282+ 9C72 E1               pop  hl
2283+ 9C73 C1               pop  bc
2284+ 9C74 FE FF            cp   NO_VALUE
2285+ 9C76 C2 F2 9C         jp   nz, .gtmv_fail
2286+ 9C79
2287+ 9C79                  ; verifica palla in (3, currX)
2288+ 9C79                  ;ld   d,3
2289+ 9C79                  ;ld   e,l
2290+ 9C79                  ;CALL CheckBallAtPosition
2291+ 9C79                  ;CP   NO
2292+ 9C79                  ;jp   z, .no_ball_nb_down
2293+ 9C79                  ;jp   .gtmv_fail
2294+ 9C79
2295+ 9C79              .no_ball_nb_down:
2296+ 9C79                  ; conta i compagni sulla riga 3
2297+ 9C79 C5               push bc
2298+ 9C7A 16 03            ld   d,3
2299+ 9C7C CD 62 9E         call Game_CountTeamPlayersOnRow
2300+ 9C7F C1               pop  bc
2301+ 9C80 FE 02            cp   2
2302+ 9C82 D2 F2 9C         jp   nc, .gtmv_fail
2303+ 9C85
2304+ 9C85 16 03            ld   d,3
2305+ 9C87 5D               ld   e,l
2306+ 9C88                  ;call SetPlayerInfo
2307+ 9C88 C3 E7 9C         jp   .gtmv_success
2308+ 9C8B
2309+ 9C8B              ; ----- TEAM_WHITE, FIELD_NORTH_SIDE -----
2310+ 9C8B              .gtmv_north_white:
2311+ 9C8B 7A               ld   a,d                      ; direzione
2312+ 9C8C FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2313+ 9C8E CA 99 9C         jp   z, .gtmv_nw_move_up
2314+ 9C91 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2315+ 9C93 CA C0 9C         jp   z, .gtmv_nw_move_down
2316+ 9C96 C3 F2 9C         jp   .gtmv_fail
2317+ 9C99
2318+ 9C99              ; Bianco, campo NORTH, move NORTH:
2319+ 9C99              ; deve essere su riga 4, target riga 2
2320+ 9C99              .gtmv_nw_move_up:
2321+ 9C99 7C               ld   a,h                      ; currY
2322+ 9C9A FE 04            cp   4
2323+ 9C9C C2 F2 9C         jp   nz, .gtmv_fail
2324+ 9C9F
2325+ 9C9F 16 02            ld   d,2
2326+ 9CA1 5D               ld   e,l
2327+ 9CA2 C5               push bc
2328+ 9CA3 E5               push hl
2329+ 9CA4 CD 74 96         call Game_GetPlayerInfoByPos
2330+ 9CA7 E1               pop  hl
2331+ 9CA8 C1               pop  bc
2332+ 9CA9 FE FF            cp   NO_VALUE
2333+ 9CAB C2 F2 9C         jp   nz, .gtmv_fail
2334+ 9CAE
2335+ 9CAE                  ; verifica palla in (2, currX)
2336+ 9CAE                  ;ld   d,2
2337+ 9CAE                  ;ld   e,l
2338+ 9CAE                  ;CALL CheckBallAtPosition
2339+ 9CAE                  ;CP   NO
2340+ 9CAE                  ;jp   z, .no_ball_nw_up
2341+ 9CAE                  ;jp   .gtmv_fail
2342+ 9CAE
2343+ 9CAE              .no_ball_nw_up:
2344+ 9CAE                  ; conta i compagni sulla riga 2
2345+ 9CAE C5               push bc
2346+ 9CAF 16 02            ld   d,2
2347+ 9CB1 CD 62 9E         call Game_CountTeamPlayersOnRow
2348+ 9CB4 C1               pop  bc
2349+ 9CB5 FE 02            cp   2
2350+ 9CB7 D2 F2 9C         jp   nc, .gtmv_fail
2351+ 9CBA
2352+ 9CBA 16 02            ld   d,2
2353+ 9CBC 5D               ld   e,l
2354+ 9CBD                  ;call SetPlayerInfo
2355+ 9CBD C3 E7 9C         jp   .gtmv_success
2356+ 9CC0
2357+ 9CC0              ; Bianco, campo NORTH, move SOUTH:
2358+ 9CC0              ; deve essere su riga 2, target riga 4
2359+ 9CC0              .gtmv_nw_move_down:
2360+ 9CC0 7C               ld   a,h                      ; currY
2361+ 9CC1 FE 02            cp   2
2362+ 9CC3 C2 F2 9C         jp   nz, .gtmv_fail
2363+ 9CC6
2364+ 9CC6 16 04            ld   d,4
2365+ 9CC8 5D               ld   e,l
2366+ 9CC9 C5               push bc
2367+ 9CCA E5               push hl
2368+ 9CCB CD 74 96         call Game_GetPlayerInfoByPos
2369+ 9CCE E1               pop  hl
2370+ 9CCF C1               pop  bc
2371+ 9CD0 FE FF            cp   NO_VALUE
2372+ 9CD2 C2 F2 9C         jp   nz, .gtmv_fail
2373+ 9CD5
2374+ 9CD5                  ; verifica palla in (4, currX)
2375+ 9CD5                  ;ld   d,4
2376+ 9CD5                  ;ld   e,l
2377+ 9CD5                  ;CALL CheckBallAtPosition
2378+ 9CD5                  ;CP   NO
2379+ 9CD5                  ;jp   z, .no_ball_nw_down
2380+ 9CD5                  ;jp   .gtmv_fail
2381+ 9CD5
2382+ 9CD5              .no_ball_nw_down:
2383+ 9CD5                  ; conta i compagni sulla riga 4
2384+ 9CD5 C5               push bc
2385+ 9CD6 16 04            ld   d,4
2386+ 9CD8 CD 62 9E         call Game_CountTeamPlayersOnRow
2387+ 9CDB C1               pop  bc
2388+ 9CDC FE 02            cp   2
2389+ 9CDE D2 F2 9C         jp   nc, .gtmv_fail
2390+ 9CE1
2391+ 9CE1 16 04            ld   d,4
2392+ 9CE3 5D               ld   e,l
2393+ 9CE4                  ;call SetPlayerInfo
2394+ 9CE4 C3 E7 9C         jp   .gtmv_success
2395+ 9CE7
2396+ 9CE7
2397+ 9CE7              ; -------------------------------------------------------------------
2398+ 9CE7              .gtmv_success:
2399+ 9CE7 CD 32 96         call SetPlayerInfo
2400+ 9CEA                  ;CALL VDP_PlayerMatrixRedraw
2401+ 9CEA 3E 01            LD     A, YES
2402+ 9CEC 32 82 B2         LD     (Var_Hooks_ForceVdpRedraw), A
2403+ 9CEF 3E 01            ld   a,SUCCESS
2404+ 9CF1 C9               ret
2405+ 9CF2
2406+ 9CF2              .gtmv_fail:
2407+ 9CF2 3E 00            ld   a,FAILURE
2408+ 9CF4 C9               ret
2409+ 9CF5              .gtmv_fail_pop:
2410+ 9CF5 F1               pop  af                        ; rimuovi dir dallo stack
2411+ 9CF6 18 FA            JR   .gtmv_fail
2412+ 9CF8              ;---------------------------------------------------------------------------
2413+ 9CF8              ; Game_CheckBallAtPosition
2414+ 9CF8              ; Controlla se la palla si trova in (D,E).
2415+ 9CF8              ; INPUT:
2416+ 9CF8              ;   D = Y
2417+ 9CF8              ;   E = X
2418+ 9CF8              ; OUTPUT:
2419+ 9CF8              ;   A = YES (1) se la palla è in (D,E), NO (0) altrimenti
2420+ 9CF8              ; ---------------------------------------------------------------------------
2421+ 9CF8              CheckBallAtPosition:
2422+ 9CF8 E5               push hl
2423+ 9CF9 D5               push de
2424+ 9CFA E1               pop  hl
2425+ 9CFB
2426+ 9CFB CD 92 95         call Game_GetBallPosition
2427+ 9CFE 7A               ld   a, d
2428+ 9CFF BC               cp   h
2429+ 9D00 20 08            jr   nz, .NotFound
2430+ 9D02 7B               ld   a, e
2431+ 9D03 BD               cp   l
2432+ 9D04 20 04            jr   nz, .NotFound
2433+ 9D06 3E 01            LD   a, YES
2434+ 9D08              .Done:
2435+ 9D08 E1               pop  hl
2436+ 9D09
2437+ 9D09 C9               ret
2438+ 9D0A              .NotFound:
2439+ 9D0A 3E 00            LD   a, NO
2440+ 9D0C C3 08 9D         jp   .Done
2441+ 9D0F              ; ---------------------------------------------------------------------------
2442+ 9D0F              ; TryShot
2443+ 9D0F              ; INPUT:
2444+ 9D0F              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
2445+ 9D0F              ;   C = ID   (giocatore con palla)
2446+ 9D0F              ;
2447+ 9D0F              ; OUTPUT:
2448+ 9D0F              ;   Var_Game_BallDirection impostata
2449+ 9D0F              ;   Var_Game_BallDiagonalMovCounter:
2450+ 9D0F              ;       - 255 solo se (ActiveFieldSide=NORTH, TEAM=WHITE, shooterY=2)
2451+ 9D0F              ;       - 0 in tutti gli altri casi
2452+ 9D0F              ; ---------------------------------------------------------------------------
2453+ 9D0F              Game_TryShot:
2454+ 9D0F F5               push af
2455+ 9D10 C5               push bc
2456+ 9D11 D5               push de
2457+ 9D12 E5               push hl
2458+ 9D13
2459+ 9D13
2460+ 9D13                  ; Leggi posizione giocatore (H=Y, L=X)
2461+ 9D13 CD 59 96         call Game_GetPlayerInfoById
2462+ 9D16
2463+ 9D16                  ; Default counter=0
2464+ 9D16 AF               xor  a
2465+ 9D17 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
2466+ 9D1A
2467+ 9D1A                  ; Se campo NORTH e bianco e Y=2 => counter=255 (caso speciale)
2468+ 9D1A 3A 07 B2         ld   a,(Var_Game_ActiveFieldSide)
2469+ 9D1D FE 01            cp   FIELD_NORTH_SIDE
2470+ 9D1F 20 0F            jr   nz,.counter_done
2471+ 9D21 78               ld   a,b
2472+ 9D22 FE 01            cp   TEAM_WHITE
2473+ 9D24 20 0A            jr   nz,.counter_done
2474+ 9D26 7C               ld   a,h
2475+ 9D27 FE 02            cp   2
2476+ 9D29 20 05            jr   nz,.counter_done
2477+ 9D2B 3E FF            ld   a,255
2478+ 9D2D 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
2479+ 9D30              .counter_done:
2480+ 9D30
2481+ 9D30                  ; Decide direzione in base a campo/team/riga/colonna
2482+ 9D30 3A 07 B2         ld   a,(Var_Game_ActiveFieldSide)
2483+ 9D33 FE 01            cp   FIELD_NORTH_SIDE
2484+ 9D35 28 03            jr   z,.field_north
2485+ 9D37 C3 BA 9D         jp   .field_south
2486+ 9D3A
2487+ 9D3A              ; ==========================
2488+ 9D3A              ; CAMPO VISIBILE: NORTH
2489+ 9D3A              ; ==========================
2490+ 9D3A              .field_north:
2491+ 9D3A 78               ld   a,b
2492+ 9D3B FE 00            cp   TEAM_BLACK
2493+ 9D3D 28 02            jr   z,.north_black
2494+ 9D3F                  ; altrimenti TEAM_WHITE
2495+ 9D3F 18 30            jr   .north_white
2496+ 9D41
2497+ 9D41              .north_black:
2498+ 9D41                  ; Nero: da qualsiasi riga -> SOUTH / SOUTH_EAST / SOUTH_WEST
2499+ 9D41                  ; con vincolo bordo: X=0 => no SOUTH_WEST, X=4 => no SOUTH_EAST
2500+ 9D41 CD 77 9A         call Game_GetRandomByte
2501+ 9D44 E6 03            and  00000011b          ; 0..3
2502+ 9D46 FE 03            cp   3
2503+ 9D48 20 01            jr   nz,.nb_r_ok
2504+ 9D4A AF               xor  a                  ; 3 -> 0
2505+ 9D4B              .nb_r_ok:
2506+ 9D4B                  ; A = 0..2
2507+ 9D4B                  ; 0=SOUTH, 1=SOUTH_EAST, 2=SOUTH_WEST (poi validiamo bordi)
2508+ 9D4B 57               ld   d,a                ; D = scelta
2509+ 9D4C
2510+ 9D4C 7D               ld   a,l                ; X
2511+ 9D4D FE 00            cp   0
2512+ 9D4F 20 07            jr   nz,.nb_not_left
2513+ 9D51                  ; X=0: se scelta = SOUTH_WEST (2) -> forza SOUTH (0) o SOUTH_EAST (1)
2514+ 9D51 7A               ld   a,d
2515+ 9D52 FE 02            cp   2
2516+ 9D54 20 02            jr   nz,.nb_not_left
2517+ 9D56                  ; forza SOUTH_EAST (più "naturale" da sinistra) oppure SOUTH
2518+ 9D56 16 01            ld   d,1
2519+ 9D58              .nb_not_left:
2520+ 9D58 7D               ld   a,l
2521+ 9D59 FE 04            cp   4
2522+ 9D5B 20 07            jr   nz,.nb_choose
2523+ 9D5D                  ; X=4: se scelta = SOUTH_EAST (1) -> forza SOUTH_WEST (2) o SOUTH
2524+ 9D5D 7A               ld   a,d
2525+ 9D5E FE 01            cp   1
2526+ 9D60 20 02            jr   nz,.nb_choose
2527+ 9D62 16 02            ld   d,2
2528+ 9D64              .nb_choose:
2529+ 9D64 7A               ld   a,d
2530+ 9D65 B7               or   a
2531+ 9D66 CA 35 9E         jp   z,.set_south
2532+ 9D69 FE 01            cp   1
2533+ 9D6B CA 41 9E         jp   z,.set_se
2534+ 9D6E                  ; 2
2535+ 9D6E C3 45 9E         jp   .set_sw
2536+ 9D71
2537+ 9D71              .north_white:
2538+ 9D71 7C               ld   a,h                ; Y
2539+ 9D72 FE 04            cp   4
2540+ 9D74 28 07            jr   z,.nw_y4
2541+ 9D76 FE 02            cp   2
2542+ 9D78 28 33            jr   z,.nw_y2
2543+ 9D7A                  ; Fuori dalle righe previste: niente tiro
2544+ 9D7A C3 51 9E         jp   .stop_shot
2545+ 9D7D
2546+ 9D7D              .nw_y4:
2547+ 9D7D                  ; Bianco da riga 4: NORTH / NE / NW
2548+ 9D7D                  ; vincolo bordo: X=0 => no NW, X=4 => no NE
2549+ 9D7D CD 77 9A         call Game_GetRandomByte
2550+ 9D80 E6 03            and  00000011b          ; 0..3
2551+ 9D82 FE 03            cp   3
2552+ 9D84 20 01            jr   nz,.nw4_r_ok
2553+ 9D86 AF               xor  a
2554+ 9D87              .nw4_r_ok:
2555+ 9D87                  ; 0=NORTH, 1=NE, 2=NW
2556+ 9D87 57               ld   d,a
2557+ 9D88
2558+ 9D88 7D               ld   a,l
2559+ 9D89 FE 00            cp   0
2560+ 9D8B 20 07            jr   nz,.nw4_not_left
2561+ 9D8D 7A               ld   a,d
2562+ 9D8E FE 02            cp   2
2563+ 9D90 20 02            jr   nz,.nw4_not_left
2564+ 9D92 16 01            ld   d,1                ; da sinistra, evita NW -> forza NE (o straight, ma NE va bene)
2565+ 9D94              .nw4_not_left:
2566+ 9D94 7D               ld   a,l
2567+ 9D95 FE 04            cp   4
2568+ 9D97 20 07            jr   nz,.nw4_choose
2569+ 9D99 7A               ld   a,d
2570+ 9D9A FE 01            cp   1
2571+ 9D9C 20 02            jr   nz,.nw4_choose
2572+ 9D9E 16 02            ld   d,2                ; da destra, evita NE -> forza NW
2573+ 9DA0              .nw4_choose:
2574+ 9DA0 7A               ld   a,d
2575+ 9DA1 B7               or   a
2576+ 9DA2 CA 31 9E         jp   z,.set_north
2577+ 9DA5 FE 01            cp   1
2578+ 9DA7 CA 39 9E         jp   z,.set_ne
2579+ 9DAA C3 3D 9E         jp   .set_nw
2580+ 9DAD
2581+ 9DAD              .nw_y2:
2582+ 9DAD                  ; Caso speciale attaccante bianco in riga 2 (campo NORTH)
2583+ 9DAD                  ; - se X=1..3 -> NORTH
2584+ 9DAD                  ; - se X=0 -> NORTH_EAST
2585+ 9DAD                  ; - se X=4 -> NORTH_WEST
2586+ 9DAD 7D               ld   a,l
2587+ 9DAE FE 00            cp   0
2588+ 9DB0 CA 39 9E         jp   z,.set_ne
2589+ 9DB3 FE 04            cp   4
2590+ 9DB5 CA 3D 9E         jp   z,.set_nw
2591+ 9DB8 18 77            jr   .set_north
2592+ 9DBA
2593+ 9DBA
2594+ 9DBA              ; ==========================
2595+ 9DBA              ; CAMPO VISIBILE: SOUTH
2596+ 9DBA              ; ==========================
2597+ 9DBA              .field_south:
2598+ 9DBA 78               ld   a,b
2599+ 9DBB FE 01            cp   TEAM_WHITE
2600+ 9DBD 28 02            jr   z,.south_white
2601+ 9DBF                  ; altrimenti TEAM_BLACK
2602+ 9DBF 18 2D            jr   .south_black
2603+ 9DC1
2604+ 9DC1              .south_white:
2605+ 9DC1                  ; Bianco: da qualsiasi riga -> NORTH / NE / NW
2606+ 9DC1                  ; vincolo bordo: X=0 => no NW, X=4 => no NE
2607+ 9DC1 CD 77 9A         call Game_GetRandomByte
2608+ 9DC4 E6 03            and  00000011b
2609+ 9DC6 FE 03            cp   3
2610+ 9DC8 20 01            jr   nz,.sw_r_ok
2611+ 9DCA AF               xor  a
2612+ 9DCB              .sw_r_ok:
2613+ 9DCB                  ; 0=NORTH, 1=NE, 2=NW
2614+ 9DCB 57               ld   d,a
2615+ 9DCC
2616+ 9DCC 7D               ld   a,l
2617+ 9DCD FE 00            cp   0
2618+ 9DCF 20 07            jr   nz,.sw_not_left
2619+ 9DD1 7A               ld   a,d
2620+ 9DD2 FE 02            cp   2
2621+ 9DD4 20 02            jr   nz,.sw_not_left
2622+ 9DD6 16 01            ld   d,1
2623+ 9DD8              .sw_not_left:
2624+ 9DD8 7D               ld   a,l
2625+ 9DD9 FE 04            cp   4
2626+ 9DDB 20 07            jr   nz,.sw_choose
2627+ 9DDD 7A               ld   a,d
2628+ 9DDE FE 01            cp   1
2629+ 9DE0 20 02            jr   nz,.sw_choose
2630+ 9DE2 16 02            ld   d,2
2631+ 9DE4              .sw_choose:
2632+ 9DE4 7A               ld   a,d
2633+ 9DE5 B7               or   a
2634+ 9DE6 28 49            jr   z,.set_north
2635+ 9DE8 FE 01            cp   1
2636+ 9DEA 28 4D            jr   z,.set_ne
2637+ 9DEC 18 4F            jr   .set_nw
2638+ 9DEE
2639+ 9DEE              .south_black:
2640+ 9DEE 7C               ld   a,h                ; Y
2641+ 9DEF FE 00            cp   0
2642+ 9DF1 28 06            jr   z,.sb_y0
2643+ 9DF3 FE 02            cp   2
2644+ 9DF5 28 2F            jr   z,.sb_y2
2645+ 9DF7 18 58            jr   .stop_shot
2646+ 9DF9
2647+ 9DF9              .sb_y0:
2648+ 9DF9                  ; Nero da riga 0: SOUTH / SE / SW
2649+ 9DF9                  ; vincolo bordo: X=0 => no SW, X=4 => no SE
2650+ 9DF9 CD 77 9A         call Game_GetRandomByte
2651+ 9DFC E6 03            and  00000011b
2652+ 9DFE FE 03            cp   3
2653+ 9E00 20 01            jr   nz,.sb0_r_ok
2654+ 9E02 AF               xor  a
2655+ 9E03              .sb0_r_ok:
2656+ 9E03                  ; 0=SOUTH, 1=SE, 2=SW
2657+ 9E03 57               ld   d,a
2658+ 9E04
2659+ 9E04 7D               ld   a,l
2660+ 9E05 FE 00            cp   0
2661+ 9E07 20 07            jr   nz,.sb0_not_left
2662+ 9E09 7A               ld   a,d
2663+ 9E0A FE 02            cp   2
2664+ 9E0C 20 02            jr   nz,.sb0_not_left
2665+ 9E0E 16 01            ld   d,1
2666+ 9E10              .sb0_not_left:
2667+ 9E10 7D               ld   a,l
2668+ 9E11 FE 04            cp   4
2669+ 9E13 20 07            jr   nz,.sb0_choose
2670+ 9E15 7A               ld   a,d
2671+ 9E16 FE 01            cp   1
2672+ 9E18 20 02            jr   nz,.sb0_choose
2673+ 9E1A 16 02            ld   d,2
2674+ 9E1C              .sb0_choose:
2675+ 9E1C 7A               ld   a,d
2676+ 9E1D B7               or   a
2677+ 9E1E 28 15            jr   z,.set_south
2678+ 9E20 FE 01            cp   1
2679+ 9E22 28 1D            jr   z,.set_se
2680+ 9E24 18 1F            jr   .set_sw
2681+ 9E26
2682+ 9E26              .sb_y2:
2683+ 9E26                  ; Nero in riga 2 (campo SOUTH):
2684+ 9E26                  ; - X=1..3 -> SOUTH
2685+ 9E26                  ; - X=0 -> SOUTH_EAST
2686+ 9E26                  ; - X=4 -> SOUTH_WEST
2687+ 9E26 7D               ld   a,l
2688+ 9E27 FE 00            cp   0
2689+ 9E29 28 16            jr   z,.set_se
2690+ 9E2B FE 04            cp   4
2691+ 9E2D 28 16            jr   z,.set_sw
2692+ 9E2F 18 04            jr   .set_south
2693+ 9E31
2694+ 9E31
2695+ 9E31              ; ==========================
2696+ 9E31              ; SET DIREZIONI
2697+ 9E31              ; ==========================
2698+ 9E31              .set_north:
2699+ 9E31 3E 01            ld   a,BALL_DIRECTION_NORTH
2700+ 9E33 18 14            jr   .store_dir
2701+ 9E35              .set_south:
2702+ 9E35 3E 04            ld   a,BALL_DIRECTION_SOUTH
2703+ 9E37 18 10            jr   .store_dir
2704+ 9E39              .set_ne:
2705+ 9E39 3E 02            ld   a,BALL_DIRECTION_NORTH_EAST
2706+ 9E3B 18 0C            jr   .store_dir
2707+ 9E3D              .set_nw:
2708+ 9E3D 3E 03            ld   a,BALL_DIRECTION_NORTH_WEST
2709+ 9E3F 18 08            jr   .store_dir
2710+ 9E41              .set_se:
2711+ 9E41 3E 05            ld   a,BALL_DIRECTION_SOUTH_EAST
2712+ 9E43 18 04            jr   .store_dir
2713+ 9E45              .set_sw:
2714+ 9E45 3E 06            ld   a,BALL_DIRECTION_SOUTH_WEST
2715+ 9E47 18 00            jr   .store_dir
2716+ 9E49
2717+ 9E49              .store_dir:
2718+ 9E49 32 27 B2         ld   (Var_Game_BallDirection),a
2719+ 9E4C CD 02 AA         call Game_PlayBeep
2720+ 9E4F 18 03            jr   .done
2721+ 9E51
2722+ 9E51              .stop_shot:
2723+ 9E51 CD 59 9E         call Game_StopShot
2724+ 9E54
2725+ 9E54              .done:
2726+ 9E54 E1               pop  hl
2727+ 9E55 D1               pop  de
2728+ 9E56 C1               pop  bc
2729+ 9E57 F1               pop  af
2730+ 9E58 C9               ret
2731+ 9E59
2732+ 9E59
2733+ 9E59              ; ---------------------------------------------------------------------------
2734+ 9E59              ; Game_StopShot
2735+ 9E59              ; Ferma il tiro: azzera direzione e counter diagonale.
2736+ 9E59              ; ---------------------------------------------------------------------------
2737+ 9E59              Game_StopShot:
2738+ 9E59 3E 00            ld   a, BALL_DIRECTION_NONE
2739+ 9E5B 32 27 B2         ld   (Var_Game_BallDirection),a         ; BALL_DIRECTION_NONE = 0 (assunto)
2740+ 9E5E 32 28 B2         ld   (Var_Game_BallDiagonalMovCounter),a
2741+ 9E61 C9               ret
2742+ 9E62
2743+ 9E62
2744+ 9E62              ; ---------------------------------------------------------------------------
2745+ 9E62              ; Game_CountTeamPlayersOnRow
2746+ 9E62              ; Conta quanti giocatori della squadra B sono sulla riga D (Y = D).
2747+ 9E62              ;
2748+ 9E62              ; INPUT:
2749+ 9E62              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
2750+ 9E62              ;   D = Y (riga da controllare)
2751+ 9E62              ;
2752+ 9E62              ; OUTPUT:
2753+ 9E62              ;   A = numero di giocatori (0..4)
2754+ 9E62              ;
2755+ 9E62              ; MODIFIES:
2756+ 9E62              ;   AF, C, DE, HL
2757+ 9E62              ; ---------------------------------------------------------------------------
2758+ 9E62              Game_CountTeamPlayersOnRow:
2759+ 9E62 C5               PUSH BC
2760+ 9E63 D5               PUSH DE
2761+ 9E64 E5               PUSH HL
2762+ 9E65 7A               LD   A, D
2763+ 9E66 CD C0 A3         CALL GetAllPlayersOnARow
2764+ 9E69 78               LD   A, B
2765+ 9E6A FE FF            CP   NO_VALUE
2766+ 9E6C 28 10            JR   Z, .NoPlayersFound
2767+ 9E6E 79               LD   A, C
2768+ 9E6F FE FF            CP   NO_VALUE
2769+ 9E71 28 06            JR   Z, .OnePlayerFound
2770+ 9E73 3E 02            LD   A, 2
2771+ 9E75              .Done:
2772+ 9E75 E1               POP  HL
2773+ 9E76 D1               POP  DE
2774+ 9E77 C1               POP  BC
2775+ 9E78 C9               RET
2776+ 9E79              .OnePlayerFound:
2777+ 9E79 3E 01            LD   A, 1
2778+ 9E7B C3 75 9E         JP   .Done
2779+ 9E7E              .NoPlayersFound:
2780+ 9E7E AF               XOR  A
2781+ 9E7F C3 75 9E         JP   .Done
2782+ 9E82
2783+ 9E82              ; ---------------------------------------------------------------------------
2784+ 9E82              ; MoveGoalKeeper
2785+ 9E82              ; INPUT: B: Team
2786+ 9E82              ; ---------------------------------------------------------------------------
2787+ 9E82              MoveGoalKeeper:
2788+ 9E82 D5               PUSH DE
2789+ 9E83 E5               PUSH HL
2790+ 9E84 C5               PUSH BC
2791+ 9E85 F3               DI
2792+ 9E86 CD 58 81         CALL Hooks_TickStop
2793+ 9E89 0E 00            LD   C, 0
2794+ 9E8B CD 59 96         CALL Game_GetPlayerInfoById
2795+ 9E8E 7C               LD   A, H
2796+ 9E8F FE FF            CP   NO_VALUE
2797+ 9E91 28 24            JR   Z, .done
2798+ 9E93
2799+ 9E93 3A 0D B2         ld   a, (Var_Game_MoveTmpDir)
2800+ 9E96 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2801+ 9E98 20 09            jr   nz, .move_west
2802+ 9E9A                  ; --- move east ---
2803+ 9E9A 2C               inc  l
2804+ 9E9B 7D               LD   A, L
2805+ 9E9C FE 04            CP   4
2806+ 9E9E 28 17            JR   Z, .done
2807+ 9EA0 C3 A9 9E         JP   .set_pos
2808+ 9EA3              .move_west:
2809+ 9EA3
2810+ 9EA3                  ; --- move west ---
2811+ 9EA3 2D               dec  l
2812+ 9EA4 7D               LD   A, L
2813+ 9EA5 FE 00            CP   0
2814+ 9EA7 28 0E            JR   Z, .done
2815+ 9EA9              .set_pos:
2816+ 9EA9 C1               POP  BC
2817+ 9EAA C5               PUSH BC
2818+ 9EAB 0E 00            LD   C, 0
2819+ 9EAD 54               LD   D, H
2820+ 9EAE 5D               LD   E, L
2821+ 9EAF CD 32 96         CALL SetPlayerInfo
2822+ 9EB2 3E 01            LD   A, YES
2823+ 9EB4 32 82 B2         LD  (Var_Hooks_ForceVdpRedraw), A
2824+ 9EB7              .done
2825+ 9EB7 CD 50 81         CALL Hooks_TickStart
2826+ 9EBA C1               POP  BC
2827+ 9EBB E1               POP  HL
2828+ 9EBC D1               POP  DE
2829+ 9EBD C9               RET
2830+ 9EBE              ; ---------------------------------------------------------------------------
2831+ 9EBE              ; Game_TryMovePlayerHorizontally
2832+ 9EBE              ;
2833+ 9EBE              ; INPUT:
2834+ 9EBE              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
2835+ 9EBE              ;   C = ID    (0..3)
2836+ 9EBE              ;   A = direzione richiesta:
2837+ 9EBE              ;       PLAYER_ASKED_DIRECTION_EAST
2838+ 9EBE              ;       PLAYER_ASKED_DIRECTION_WEST
2839+ 9EBE              ;
2840+ 9EBE              ; OUTPUT:
2841+ 9EBE              ;   A = SUCCESS (0) oppure FAILURE (1)
2842+ 9EBE              ;
2843+ 9EBE              ; NOTE:
2844+ 9EBE              ;   - controlla SOLO la colonna adiacente nella direzione richiesta;
2845+ 9EBE              ;   - se lì c'è un compagno senza palla, prova prima a muovere lui
2846+ 9EBE              ;     ricorsivamente (stessa direzione);
2847+ 9EBE              ;   - se la catena non trova spazio o qualcuno ha la palla e blocca,
2848+ 9EBE              ;     ritorna FAILURE;
2849+ 9EBE              ;   - se la mossa è possibile:
2850+ 9EBE              ;       * sposta eventuale palla se:
2851+ 9EBE              ;           - BALL_STATUS_CONTENDED, oppure
2852+ 9EBE              ;           - posseduta dal giocatore che stiamo muovendo;
2853+ 9EBE              ;       * sposta il giocatore di 1 colonna in quella direzione;
2854+ 9EBE              ;   - limiti orizzontali:
2855+ 9EBE              ;       * portiere (ID=0): X in [1..3]
2856+ 9EBE              ;       * altri:            X in [0..4]
2857+ 9EBE              ; ---------------------------------------------------------------------------
2858+ 9EBE              Game_TryMovePlayerHorizontally:
2859+ 9EBE
2860+ 9EBE                  ; Salva la direzione richiesta (uguale in tutta la catena)
2861+ 9EBE 32 0D B2         ld   (Var_Game_MoveTmpDir),a
2862+ 9EC1
2863+ 9EC1
2864+ 9EC1
2865+ 9EC1 E5               push hl
2866+ 9EC2 C5               push bc
2867+ 9EC3
2868+ 9EC3 3A 82 B2         LD  A, (Var_Hooks_ForceVdpRedraw)
2869+ 9EC6 FE 01            CP  YES
2870+ 9EC8 CA F2 9F         jp   z,.fail_exit
2871+ 9ECB
2872+ 9ECB 78               ld   a, b
2873+ 9ECC 32 17 B2         ld   (Var_Game_TmpMoveTeam), a
2874+ 9ECF 79               ld   a, c
2875+ 9ED0 32 18 B2         ld   (Var_Game_TmpMoveId),a
2876+ 9ED3
2877+ 9ED3 CD 82 9E         CALL MoveGoalKeeper
2878+ 9ED6                  ; --- 1) Ottieni posizione corrente del giocatore (Y,X) ---
2879+ 9ED6                  ; HL = curr (H=Y, L=X), B=TEAM, C=ID, A=ROLE
2880+ 9ED6 C1               POP  BC
2881+ 9ED7 C5               PUSH BC
2882+ 9ED8 CD 59 96         call Game_GetPlayerInfoById
2883+ 9EDB
2884+ 9EDB 7C               ld   a, h
2885+ 9EDC 32 1C B2         ld   (Var_Game_TmpMoveRow), a
2886+ 9EDF 7D               ld   a, l
2887+ 9EE0 32 1D B2         ld   (Var_Game_TmpMovStartCol), a
2888+ 9EE3                  ; Salviamo posizione corrente su stack (frame locale):
2889+ 9EE3                  ;   [SP]   = HL (Y,X)
2890+ 9EE3                  ;   [SP+2] = BC (TEAM,ID)
2891+ 9EE3
2892+ 9EE3
2893+ 9EE3                  ; Ora:
2894+ 9EE3                  ;   HL = pos (H=Y,L=X)
2895+ 9EE3                  ;   BC = TEAM/ID corrente
2896+ 9EE3                  ;   stack: BC0, HL0  (dove 0 = questo livello di ricorsione)
2897+ 9EE3
2898+ 9EE3                  ; --- 2) Controllo limite laterale per questo giocatore ---
2899+ 9EE3
2900+ 9EE3                  ; X attuale in L, ID in C
2901+ 9EE3 7D               ld   a,l              ; A = X
2902+ 9EE4 57               ld   d,a              ; D = X (copia)
2903+ 9EE5
2904+ 9EE5 3A 0D B2         ld   a,(Var_Game_MoveTmpDir)
2905+ 9EE8 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2906+ 9EEA 20 12            jr   nz,.chk_west_limit
2907+ 9EEC
2908+ 9EEC                  ; ---- direzione EST ----
2909+ 9EEC 79               ld   a,c              ; ID
2910+ 9EED B7               or   a
2911+ 9EEE 20 06            jr   nz,.not_gk_east  ; ID != 0 => non portiere
2912+ 9EF0                  ; Portiere: limite destro X=3
2913+ 9EF0 7A               ld   a,d
2914+ 9EF1 FE 03            cp   3
2915+ 9EF3 CA F2 9F         jp   z,.fail_exit
2916+ 9EF6
2917+ 9EF6              .not_gk_east:
2918+ 9EF6 7A               ld   a,d
2919+ 9EF7 FE 04            cp   4                ; X == 4?
2920+ 9EF9 CA F2 9F         jp   z,.fail_exit     ; bordo destro campo
2921+ 9EFC 18 0F            jr   .compute_adjacent
2922+ 9EFE
2923+ 9EFE              .chk_west_limit:
2924+ 9EFE                  ; ---- direzione OVEST ----
2925+ 9EFE 79               ld   a,c
2926+ 9EFF B7               or   a
2927+ 9F00 20 06            jr   nz,.not_gk_west
2928+ 9F02                  ; Portiere: limite sinistro X=1
2929+ 9F02 7A               ld   a,d
2930+ 9F03 FE 01            cp   1
2931+ 9F05 CA F2 9F         jp   z,.fail_exit
2932+ 9F08
2933+ 9F08              .not_gk_west:
2934+ 9F08 7A               ld   a,d
2935+ 9F09 B7               or   a                ; X==0?
2936+ 9F0A CA F2 9F         jp   z,.fail_exit     ; bordo sinistro campo
2937+ 9F0D
2938+ 9F0D                  ; --- 3) Calcolo colonna adiacente e controllo occupante ---
2939+ 9F0D              .compute_adjacent:
2940+ 9F0D 5A               ld   e,d              ; E = X corrente
2941+ 9F0E 3A 0D B2         ld   a,(Var_Game_MoveTmpDir)
2942+ 9F11 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2943+ 9F13 20 08            jr   nz,.adj_west
2944+ 9F15 1C               inc  e                ; X+1
2945+ 9F16 7B               LD   A, E
2946+ 9F17 3C               INC     A
2947+ 9F18 32 1B B2         LD   (Var_Game_TmpMoveCompanionX), A
2948+ 9F1B 18 06            jr   .adj_done
2949+ 9F1D              .adj_west:
2950+ 9F1D 1D               dec  e                ; X-1
2951+ 9F1E 7B               LD   A, E
2952+ 9F1F 3D               DEC     A
2953+ 9F20 32 1B B2         LD   (Var_Game_TmpMoveCompanionX), A
2954+ 9F23              .adj_done:
2955+ 9F23
2956+ 9F23                  ; Game_GetPlayerInfoByPos: D = Y, E = X
2957+ 9F23 7C               ld   a,h
2958+ 9F24 57               ld   d,a              ; D = Y
2959+ 9F25                  ; E = colonna adiacente
2960+ 9F25
2961+ 9F25 CD 74 96         call Game_GetPlayerInfoByPos
2962+ 9F28 FE FF            cp   NO_VALUE
2963+ 9F2A 28 56            jr   z,.adjacent_free     ; nessun giocatore -> cella libera
2964+ 9F2C 79               ld   a, c
2965+ 9F2D 32 1A B2         ld   (Var_Game_TmpMoveCompanionId),a
2966+ 9F30                  ; --- 3b) C'è un compagno nella cella adiacente: B=TEAM_occ, C=ID_occ ---
2967+ 9F30                  ; Verifica che non abbia la palla e prova a spostarlo ricorsivamente.
2968+ 9F30
2969+ 9F30                  ; Salviamo B_occ,C_occ su stack
2970+ 9F30 C5               push bc                   ; [SP] = BC_occ, sotto BC0,HL0
2971+ 9F31
2972+ 9F31                  ; Controlla possesso palla del giocatore adiacente
2973+ 9F31 CD 9F 9A         call Game_GetPlayerIdWithBall  ; A=TEAM_* o BALL_STATUS_*, H=ID
2974+ 9F34
2975+ 9F34                  ; Ripristiniamo BC_occ
2976+ 9F34 C1               pop  bc                   ; BC = TEAM_occ,ID_occ
2977+ 9F35
2978+ 9F35                  ; Se A è TEAM_BLACK o TEAM_WHITE e coincide con B_occ,
2979+ 9F35                  ; e H coincide con ID_occ, allora quel giocatore ha la palla -> FAIL.
2980+ 9F35 3A 0D B2         ld   a,(Var_Game_MoveTmpDir)   ; A usato dopo, salviamo TEAM occ in D/E
2981+ 9F38 50               ld   d,b                   ; D = TEAM_occ
2982+ 9F39 59               ld   e,c                   ; E = ID_occ
2983+ 9F3A
2984+ 9F3A                  ; ATTENZIONE: GetPlayerIdWithBall ha già sovrascritto A,
2985+ 9F3A                  ; perciò rileggo dal luogo giusto:
2986+ 9F3A                  ;  - Team/Status era in A al RETURN -> lo abbiamo perso, quindi
2987+ 9F3A                  ;    rifacciamo la chiamata e subito dopo il confronto.
2988+ 9F3A
2989+ 9F3A                  ; Rifaccio la chiamata per avere A,H aggiornati
2990+ 9F3A CD 9F 9A         call Game_GetPlayerIdWithBall   ; A=TEAM_* o BALL_STATUS_*, H=ID
2991+ 9F3D
2992+ 9F3D FE 65            cp   BALL_STATUS_CONTENDED
2993+ 9F3F 20 03            jr   nz,.adj_done_not_contended
2994+ 9F41 3A 17 B2         ld   a, (Var_Game_TmpMoveTeam)
2995+ 9F44              .adj_done_not_contended:
2996+ 9F44                  ; Se A non è un TEAM, non è possesso
2997+ 9F44 FE 00            cp   TEAM_BLACK
2998+ 9F46 28 04            jr   z,.check_owner_team
2999+ 9F48 FE 01            cp   TEAM_WHITE
3000+ 9F4A 20 0E            jr   nz,.no_owner_companion
3001+ 9F4C
3002+ 9F4C              .check_owner_team:
3003+ 9F4C 57               LD   D, A
3004+ 9F4D 3A 17 B2         LD   A, (Var_Game_TmpMoveTeam)
3005+ 9F50 BA               cp   d                     ; A == D (TEAM_occ)?
3006+ 9F51 20 07            jr   nz,.no_owner_companion
3007+ 9F53 3A 1A B2         ld   a, (Var_Game_TmpMoveCompanionId)
3008+ 9F56 BC               cp   h                     ; H == ID_occ?
3009+ 9F57 CA F2 9F         jp   z,.fail_exit          ; quel compagno ha la palla -> non si spinge
3010+ 9F5A
3011+ 9F5A              .no_owner_companion:
3012+ 9F5A                  ; Possiamo provare a spostare il compagno ricorsivamente
3013+ 9F5A
3014+ 9F5A 3A 1A B2         ld a,(Var_Game_TmpMoveCompanionId)
3015+ 9F5D 4F               ld c, a
3016+ 9F5E 3A 17 B2         ld a, (Var_Game_TmpMoveTeam)
3017+ 9F61 47               ld b, a
3018+ 9F62 3A 1B B2         ld a, (Var_Game_TmpMoveCompanionX)
3019+ 9F65 5F               ld e, a
3020+ 9F66 FE FF            CP  255
3021+ 9F68 CA F2 9F         JP  Z, .fail_exit
3022+ 9F6B FE 05            CP  5
3023+ 9F6D CA F2 9F         JP  Z, .fail_exit
3024+ 9F70 3A 1C B2         ld a, (Var_Game_TmpMoveRow)
3025+ 9F73 57               ld d, a                   ; D=Y, E=X del compagno
3026+ 9F74 CD 32 96         call SetPlayerInfo
3027+ 9F77 3A 17 B2         ld a, (Var_Game_TmpMoveTeam)
3028+ 9F7A 47               ld b, a
3029+ 9F7B 3A 1A B2         ld a,(Var_Game_TmpMoveCompanionId)
3030+ 9F7E 4F               ld c, a
3031+ 9F7F CD B1 96         call Game_ClearSinglePlayerPrevPositions
3032+ 9F82                  ;jr   nz,.fail_exit         ; se il compagno non si può muovere -> FAIL
3033+ 9F82
3034+ 9F82                  ; Se siamo qui, la cella adiacente è diventata libera
3035+ 9F82              .adjacent_free:
3036+ 9F82
3037+ 9F82                  ; --- 4) Cella adiacente libera: decide se spostare anche la palla ---
3038+ 9F82                  ; Rilegge possesso palla DOPO eventuale movimento dei compagni
3039+ 9F82
3040+ 9F82
3041+ 9F82                  ; Recupera TEAM/ID e posizione corrente di QUESTO giocatore
3042+ 9F82                  ; (prima di muoverlo) dal frame su stack
3043+ 9F82 C1               pop  bc                    ; BC0 = TEAM,ID del giocatore chiamante
3044+ 9F83 E1               pop  hl                    ; HL0 = pos corrente (H=Y, L=X)
3045+ 9F84
3046+ 9F84 3A 18 B2         ld   a, (Var_Game_TmpMoveId)
3047+ 9F87 4F               ld   c, a
3048+ 9F88
3049+ 9F88 C5               push bc
3050+ 9F89 CD 9F 9A         call Game_GetPlayerIdWithBall   ; A=status/TEAM, H=ID possessore (o 255)
3051+ 9F8C C1               pop  bc
3052+ 9F8D
3053+ 9F8D
3054+ 9F8D                  ; A e H sono ancora quelli di GetPlayerIdWithBall
3055+ 9F8D
3056+ 9F8D                  ; Caso 1: palla contesa -> muoviamo palla
3057+ 9F8D FE 65            cp   BALL_STATUS_CONTENDED
3058+ 9F8F 28 07            jr   z,.move_ball
3059+ 9F91
3060+ 9F91                  ; Caso 2: A è TEAM del giocatore ed H è il suo ID -> possiede palla
3061+ 9F91 B8               cp   b
3062+ 9F92 20 3F            jr   nz,.no_ball_move
3063+ 9F94 7C               ld   a,h
3064+ 9F95 B9               cp   c
3065+ 9F96 20 3B            jr   nz,.no_ball_move
3066+ 9F98              .move_ball:
3067+ 9F98 3A 1D B2         ld   a, (Var_Game_TmpMovStartCol)
3068+ 9F9B CD 92 95         call Game_GetBallPosition
3069+ 9F9E BB               cp   e
3070+ 9F9F 20 32            jr   nz,.no_ball_move      ; palla non nella stessa colonna -> non muovo palla
3071+ 9FA1
3072+ 9FA1
3073+ 9FA1
3074+ 9FA1                  ; Sposta la palla di una colonna nella stessa direzione del movimento
3075+ 9FA1                  ; (Y invariato, X +/- 1 se dentro 0..4)
3076+ 9FA1 CD 92 95         call Game_GetBallPosition
3077+ 9FA4 3A 17 B2         LD    A, (Var_Game_TmpMoveTeam)
3078+ 9FA7 FE 00            CP   TEAM_BLACK
3079+ 9FA9 28 09            JR   Z,.mb_ckblack
3080+ 9FAB              .mb_ckwhite:
3081+ 9FAB 3A 1C B2         LD  A,(Var_Game_TmpMoveRow)
3082+ 9FAE 3D               DEC A
3083+ 9FAF BA               CP  D
3084+ 9FB0 20 21            JR  NZ,.no_ball_move      ; fuori campo -> non muovo palla
3085+ 9FB2 18 06            JR  .mb_continue
3086+ 9FB4              .mb_ckblack:
3087+ 9FB4 3A 1C B2         LD  A,(Var_Game_TmpMoveRow)
3088+ 9FB7 BA               CP  D
3089+ 9FB8 20 19            JR  NZ,.no_ball_move      ; fuori campo -> non muovo palla
3090+ 9FBA              .mb_continue:
3091+ 9FBA 3A 0D B2         ld   a,(Var_Game_MoveTmpDir)
3092+ 9FBD FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
3093+ 9FBF 20 09            jr   nz,.ball_west
3094+ 9FC1
3095+ 9FC1                  ; EST
3096+ 9FC1 7B               ld   a,e
3097+ 9FC2 3C               inc  a
3098+ 9FC3 FE 05            cp   5
3099+ 9FC5 30 0C            jr   nc,.no_ball_move      ; fuori campo -> non muovo palla
3100+ 9FC7 5F               ld   e,a
3101+ 9FC8 18 06            jr   .do_set_ball
3102+ 9FCA
3103+ 9FCA              .ball_west:
3104+ 9FCA                  ; OVEST
3105+ 9FCA 7B               ld   a,e
3106+ 9FCB B7               or   a
3107+ 9FCC 28 05            jr   z,.no_ball_move       ; già a 0 -> non muovo palla
3108+ 9FCE 3D               dec  a
3109+ 9FCF 5F               ld   e,a
3110+ 9FD0
3111+ 9FD0              .do_set_ball:
3112+ 9FD0
3113+ 9FD0
3114+ 9FD0 CD 9D 95         call Game_SetBallPosition
3115+ 9FD3
3116+ 9FD3              .no_ball_move:
3117+ 9FD3                  ; --- 5) Sposta il giocatore orizzontalmente ---
3118+ 9FD3                  ; HL contiene ancora la posizione del giocatore (da poco poppata)
3119+ 9FD3                  ; Se non fosse più valida, la ricalcoliamo:
3120+ 9FD3                  ;   B=TEAM, C=ID sono già corretti.
3121+ 9FD3 3A 18 B2         LD  A, (Var_Game_TmpMoveId)
3122+ 9FD6 4F               LD  C, A
3123+ 9FD7                  ; (riotteniamo posizione nel dubbio)
3124+ 9FD7 CD 59 96         call Game_GetPlayerInfoById     ; HL = pos aggiornata (dovrebbe essere la stessa)
3125+ 9FDA
3126+ 9FDA 54               ld   d,h                   ; D = Y (invariato)
3127+ 9FDB 5D               ld   e,l                   ; E = X
3128+ 9FDC
3129+ 9FDC 3A 0D B2         ld   a,(Var_Game_MoveTmpDir)
3130+ 9FDF FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
3131+ 9FE1 20 03            jr   nz,.player_west
3132+ 9FE3 1C               inc  e
3133+ 9FE4 18 01            jr   .do_set_player
3134+ 9FE6
3135+ 9FE6              .player_west:
3136+ 9FE6 1D               dec  e
3137+ 9FE7
3138+ 9FE7              .do_set_player:
3139+ 9FE7                  ; D=Y, E=newX, B=TEAM, C=ID
3140+ 9FE7 CD 32 96         call SetPlayerInfo
3141+ 9FEA 3E 01            LD     A, YES
3142+ 9FEC 32 82 B2         LD     (Var_Hooks_ForceVdpRedraw), A
3143+ 9FEF 3E 01            ld   a,SUCCESS
3144+ 9FF1 C9               ret
3145+ 9FF2
3146+ 9FF2              .fail_exit:
3147+ 9FF2                  ; Fallimento: svuota il frame locale (BC0,HL0) e ritorna FAILURE
3148+ 9FF2 C1               pop  bc        ; scarta BC0 (TEAM/ID di questo livello)
3149+ 9FF3 E1               pop  hl        ; scarta HL0 (pos)
3150+ 9FF4 3E 00            ld   a,FAILURE
3151+ 9FF6 C9               ret
3152+ 9FF7
3153+ 9FF7
3154+ 9FF7
3155+ 9FF7              ; ---------------------------------------------------------------------------
3156+ 9FF7              ; Black team horizontal move left asked
3157+ 9FF7              ; INPUT A: Direction
3158+ 9FF7              ; ---------------------------------------------------------------------------
3159+ 9FF7              Game_BlackTeamHorizMoveAsked:
3160+ 9FF7 32 0D B2         LD      (Var_Game_MoveTmpDir),A
3161+ 9FFA
3162+ 9FFA 3A 34 B2         LD      A, (Var_Game_BallYPosition)
3163+ 9FFD 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3164+ A000
3165+ A000 3A 27 B2         LD      A, (Var_Game_BallDirection)
3166+ A003 FE 00            CP      BALL_DIRECTION_NONE
3167+ A005 28 36            JR      Z, .after_row_choice
3168+ A007
3169+ A007 FE 01            CP      BALL_DIRECTION_NORTH
3170+ A009 28 1D            JR      Z, .north_direction
3171+ A00B FE 02            CP      BALL_DIRECTION_NORTH_EAST
3172+ A00D 28 19            JR      Z, .north_direction
3173+ A00F FE 03            CP      BALL_DIRECTION_NORTH_WEST
3174+ A011 28 15            JR      Z, .north_direction
3175+ A013              .south_direction:
3176+ A013 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3177+ A016 FE 00            CP      FIELD_SOUTH_SIDE
3178+ A018 28 07            JR      Z, .south_direction_south_side
3179+ A01A              .south_direction_north_side:
3180+ A01A 3E 03            LD      A, 3
3181+ A01C 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3182+ A01F 18 1C            JR      .after_row_choice
3183+ A021              .south_direction_south_side:
3184+ A021 3E 02            LD      A, 2
3185+ A023 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3186+ A026 18 15            JR      .after_row_choice
3187+ A028              .north_direction:
3188+ A028 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3189+ A02B FE 00            CP      FIELD_SOUTH_SIDE
3190+ A02D 28 07            JR      Z, .north_direction_south_side
3191+ A02F              .north_direction_north_side:
3192+ A02F 3E 02            LD      A, 2
3193+ A031 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3194+ A034 18 07            JR      .after_row_choice
3195+ A036              .north_direction_south_side:
3196+ A036 3E 00            LD      A, 0
3197+ A038 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3198+ A03B 18 00            JR      .after_row_choice
3199+ A03D
3200+ A03D              .after_row_choice:
3201+ A03D 3E 00            LD      A, NO
3202+ A03F 32 1F B2         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3203+ A042 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3204+ A045 FE 01            CP      PLAYER_ASKED_DIRECTION_EAST
3205+ A047 28 05            JR      Z, .AfterSort
3206+ A049 3E 01            LD      A, YES
3207+ A04B 32 1F B2         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3208+ A04E              .AfterSort:
3209+ A04E CD 9F 9A         CALL    Game_GetPlayerIdWithBall
3210+ A051 FE 00            CP      TEAM_BLACK
3211+ A053 CA 85 A0         JP      Z,.WithBallPossession
3212+ A056 FE 65            CP      BALL_STATUS_CONTENDED
3213+ A058 CA 7D A0         JP      Z,.ContendedBall
3214+ A05B
3215+ A05B 3A 1E B2         LD      A, (Var_Game_TmpAskedMovingRow)
3216+ A05E CD C0 A3         CALL    GetAllPlayersOnARow
3217+ A061 C5               PUSH    BC
3218+ A062 48               LD      C, B
3219+ A063 06 00            LD      B, TEAM_BLACK
3220+ A065 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3221+ A068 CD BE 9E         CALL    Game_TryMovePlayerHorizontally
3222+ A06B C1               POP     BC
3223+ A06C 79               LD      A, C
3224+ A06D FE FF            CP      NO_VALUE
3225+ A06F 20 02            JR      NZ, .NoBallPossessionSecondPlayer
3226+ A071 18 1F            JR      .Done
3227+ A073              .NoBallPossessionSecondPlayer:
3228+ A073 06 00            LD      B, TEAM_BLACK
3229+ A075 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3230+ A078 CD BE 9E         CALL    Game_TryMovePlayerHorizontally
3231+ A07B 18 15            JR      .Done
3232+ A07D
3233+ A07D
3234+ A07D              .ContendedBall:
3235+ A07D CD 92 95         CALL    Game_GetBallPosition
3236+ A080 CD 74 96         CALL    Game_GetPlayerInfoByPos
3237+ A083 79               LD      A, C
3238+ A084 67               LD      H, A
3239+ A085              .WithBallPossession:
3240+ A085 7C               LD      A, H
3241+ A086 FE FF            CP      NO_VALUE
3242+ A088 C8               RET     Z
3243+ A089 4F               LD      C, A
3244+ A08A 06 00            LD      B, TEAM_BLACK
3245+ A08C 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3246+ A08F CD BE 9E         CALL    Game_TryMovePlayerHorizontally
3247+ A092              .Done:
3248+ A092 C9               RET
3249+ A093              ; ---------------------------------------------------------------------------
3250+ A093              ; White team horizontal move left asked
3251+ A093              ; INPUT A: Direction
3252+ A093              ; ---------------------------------------------------------------------------
3253+ A093              Game_WhiteTeamHorizMoveAsked:
3254+ A093 32 0D B2         LD      (Var_Game_MoveTmpDir),A
3255+ A096
3256+ A096 3A 34 B2         LD      A, (Var_Game_BallYPosition)
3257+ A099 3C               INC     A
3258+ A09A 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3259+ A09D
3260+ A09D 3A 27 B2         LD      A, (Var_Game_BallDirection)
3261+ A0A0 FE 00            CP      BALL_DIRECTION_NONE
3262+ A0A2 28 36            JR      Z, .after_row_choice
3263+ A0A4
3264+ A0A4 FE 01            CP      BALL_DIRECTION_NORTH
3265+ A0A6 28 1D            JR      Z, .north_direction
3266+ A0A8 FE 02            CP      BALL_DIRECTION_NORTH_EAST
3267+ A0AA 28 19            JR      Z, .north_direction
3268+ A0AC FE 03            CP      BALL_DIRECTION_NORTH_WEST
3269+ A0AE 28 15            JR      Z, .north_direction
3270+ A0B0              .south_direction:
3271+ A0B0 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3272+ A0B3 FE 00            CP      FIELD_SOUTH_SIDE
3273+ A0B5 28 07            JR      Z, .south_direction_south_side
3274+ A0B7              .south_direction_north_side:
3275+ A0B7 3E 02            LD      A, 2
3276+ A0B9 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3277+ A0BC 18 1C            JR      .after_row_choice
3278+ A0BE              .south_direction_south_side:
3279+ A0BE 3E 03            LD      A, 3
3280+ A0C0 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3281+ A0C3 18 15            JR      .after_row_choice
3282+ A0C5              .north_direction:
3283+ A0C5 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3284+ A0C8 FE 00            CP      FIELD_SOUTH_SIDE
3285+ A0CA 28 07            JR      Z, .north_direction_south_side
3286+ A0CC              .north_direction_north_side:
3287+ A0CC 3E 02            LD      A, 2
3288+ A0CE 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3289+ A0D1 18 07            JR      .after_row_choice
3290+ A0D3              .north_direction_south_side:
3291+ A0D3 3E 01            LD      A, 1
3292+ A0D5 32 1E B2         LD      (Var_Game_TmpAskedMovingRow), A
3293+ A0D8 18 00            JR      .after_row_choice
3294+ A0DA
3295+ A0DA              .after_row_choice:
3296+ A0DA
3297+ A0DA 3E 00            LD      A, NO
3298+ A0DC 32 1F B2         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3299+ A0DF 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3300+ A0E2 FE 01            CP      PLAYER_ASKED_DIRECTION_EAST
3301+ A0E4 28 05            JR      Z, .AfterSort
3302+ A0E6 3E 01            LD      A, YES
3303+ A0E8 32 1F B2         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3304+ A0EB              .AfterSort:
3305+ A0EB CD 9F 9A         CALL    Game_GetPlayerIdWithBall
3306+ A0EE FE 01            CP      TEAM_WHITE
3307+ A0F0 CA 23 A1         JP      Z,.WithBallPossession
3308+ A0F3 FE 65            CP      BALL_STATUS_CONTENDED
3309+ A0F5 CA 1A A1         JP      Z,.ContendedBall
3310+ A0F8
3311+ A0F8 3A 1E B2         LD      A, (Var_Game_TmpAskedMovingRow)
3312+ A0FB CD C0 A3         CALL    GetAllPlayersOnARow
3313+ A0FE C5               PUSH    BC
3314+ A0FF 48               LD      C, B
3315+ A100 06 01            LD      B, TEAM_WHITE
3316+ A102 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3317+ A105 CD BE 9E         CALL    Game_TryMovePlayerHorizontally
3318+ A108 C1               POP     BC
3319+ A109 79               LD      A, C
3320+ A10A FE FF            CP      NO_VALUE
3321+ A10C 20 02            JR      NZ, .NoBallPossessionSecondPlayer
3322+ A10E 18 20            JR      .Done
3323+ A110              .NoBallPossessionSecondPlayer:
3324+ A110 06 01            LD      B, TEAM_WHITE
3325+ A112 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3326+ A115 CD BE 9E         CALL    Game_TryMovePlayerHorizontally
3327+ A118 18 16            JR      .Done
3328+ A11A
3329+ A11A              .ContendedBall:
3330+ A11A CD 92 95         CALL    Game_GetBallPosition
3331+ A11D 14               INC     D
3332+ A11E CD 74 96         CALL    Game_GetPlayerInfoByPos
3333+ A121 79               LD      A, C
3334+ A122 67               LD      H, A
3335+ A123              .WithBallPossession:
3336+ A123 7C               LD      A, H
3337+ A124 FE FF            CP      NO_VALUE
3338+ A126 C8               RET     Z
3339+ A127 4F               LD      C, A
3340+ A128 06 01            LD      B, TEAM_WHITE
3341+ A12A 3A 0D B2         LD      A, (Var_Game_MoveTmpDir)
3342+ A12D CD BE 9E         CALL    Game_TryMovePlayerHorizontally
3343+ A130              .Done:
3344+ A130 C9               RET
3345+ A131
3346+ A131              ; -----------------------------------------------------------
3347+ A131              ; Show game over
3348+ A131              ;
3349+ A131              ; INPUT: -
3350+ A131              ; OUTPUT: -
3351+ A131              ; MODIFIES:
3352+ A131              ;   A, HL, BC
3353+ A131              ; -----------------------------------------------------------
3354+ A131              Game_GameOver:
3355+ A131 CD 58 81         CALL    Hooks_TickStop
3356+ A134 3E 00            LD      A, NO
3357+ A136 32 2C B2         LD      (Var_Game_MatchInProgress), A
3358+ A139 26 00            LD      H, 0
3359+ A13B 2E 00            LD      L, 0
3360+ A13D 11 FE B1         LD      DE, Var_Utils_NumberToPrint
3361+ A140 CD 07 81         CALL    String_NumberToASCII
3362+ A143 21 FE B1         LD      HL, Var_Utils_NumberToPrint
3363+ A146 CD 2C 81         CALL    String_RemoveLeadingZeros
3364+ A149 21 FE B1         LD      HL, Var_Utils_NumberToPrint
3365+ A14C 16 01            LD      D, 1
3366+ A14E 1E 17            LD      E, 23
3367+ A150 CD 93 88         CALL    VDP_PrintString
3368+ A153
3369+ A153 21 FD 80         LD      HL, TXT_GAME_OVER
3370+ A156 16 0A            LD      D, 10
3371+ A158 1E 06            LD      E, 6
3372+ A15A CD 93 88         CALL    VDP_PrintString
3373+ A15D FB               EI
3374+ A15E              .Loop:
3375+ A15E CD 14 93         CALL    Utils_ReadKeyboard
3376+ A161 FE 20            CP      KBD_KEY_SPACE   ; KBD
3377+ A163 20 F9            JR      NZ, .Loop
3378+ A165 CD 93 91         CALL    Menu_Show
3379+ A168 C3 EF AA         JP      MainLoop
3380+ A16B
3381+ A16B              ; ---------------------------------------------------------------------------
3382+ A16B              ; Game_CheckStoppedBallOnGoalOrCorner
3383+ A16B              ;
3384+ A16B              ; Esegue controlli SOLO se la palla è ferma (BALL_DIRECTION_NONE).
3385+ A16B              ; Se la palla è sulla riga di fondo/porta del campo attivo:
3386+ A16B              ;   - X=0 o X=4  -> BallIsInCornerArea
3387+ A16B              ;   - X=1..3     -> se portiere sulla stessa cella: BallIsInGoalkeeperHands
3388+ A16B              ;                  altrimenti: BallIsInGoal
3389+ A16B              ;
3390+ A16B              ; Usa:
3391+ A16B              ;   Var_Game_BallDirection
3392+ A16B              ;   Var_Game_ActiveFieldSide
3393+ A16B              ;   Game_GetBallPosition      -> DE (D=Y, E=X)
3394+ A16B              ;   Game_GetPlayerInfoById    -> HL cur (H=Y, L=X)
3395+ A16B              ;
3396+ A16B              ; MODIFIES: AF,BC,DE,HL
3397+ A16B              ; ---------------------------------------------------------------------------
3398+ A16B              Game_CheckStoppedBallOnGoalOrCorner:
3399+ A16B F5               push af
3400+ A16C C5               push bc
3401+ A16D D5               push de
3402+ A16E E5               push hl
3403+ A16F
3404+ A16F                  ; Solo se palla ferma
3405+ A16F 3A 27 B2         ld   a,(Var_Game_BallDirection)
3406+ A172 FE 00            cp   BALL_DIRECTION_NONE
3407+ A174 20 5C            jr   nz,.done
3408+ A176
3409+ A176              ;    ; Solo se palla ferma
3410+ A176              ;    ld   a,(Var_Hooks_BlinkingIsActive)
3411+ A176              ;    cp   YES
3412+ A176              ;    jr   z,.done
3413+ A176
3414+ A176                  ; Leggi posizione palla: D=Y, E=X
3415+ A176 CD 92 95         call Game_GetBallPosition
3416+ A179
3417+ A179                  ; Determina se siamo su riga di fondo/porta del campo attivo
3418+ A179 3A 07 B2         ld   a,(Var_Game_ActiveFieldSide)
3419+ A17C FE 00            cp   FIELD_SOUTH_SIDE
3420+ A17E 20 28            jr   nz,.field_north
3421+ A180
3422+ A180              ; ===== CAMPO SOUTH: fondo/porta è riga 4 =====
3423+ A180              .field_south:
3424+ A180 7A               ld   a,d
3425+ A181 FE 04            cp   4
3426+ A183 20 4D            jr   nz,.done
3427+ A185
3428+ A185                  ; Se X=0 o 4 -> corner
3429+ A185 7B               ld   a,e
3430+ A186 B7               or   a
3431+ A187 28 46            jr   z,.corner
3432+ A189 FE 04            cp   4
3433+ A18B 28 42            jr   z,.corner
3434+ A18D
3435+ A18D                  ; X=1..3 -> verifica portiere BIANCO (TEAM_WHITE, ID=0)
3436+ A18D 06 01            ld   b,TEAM_WHITE
3437+ A18F 0E 00            ld   c,0
3438+ A191 D5               push de                  ; salva palla
3439+ A192 CD 59 96         call Game_GetPlayerInfoById   ; HL = cur (H=Y, L=X)
3440+ A195 D1               pop  de
3441+ A196
3442+ A196 7C               ld   a,h
3443+ A197 BA               cp   d
3444+ A198 20 09            jr   nz,.goal
3445+ A19A 7D               ld   a,l
3446+ A19B BB               cp   e
3447+ A19C 20 05            jr   nz,.goal
3448+ A19E
3449+ A19E CD 2B A2         call BallIsInGoalkeeperHands
3450+ A1A1 18 2F            jr   .done
3451+ A1A3
3452+ A1A3              .goal:
3453+ A1A3 CD D8 A1         call BallIsInGoal
3454+ A1A6 18 2A            jr   .done
3455+ A1A8
3456+ A1A8              ; ===== CAMPO NORTH: fondo/porta è riga 0 =====
3457+ A1A8              .field_north:
3458+ A1A8 7A               ld   a,d
3459+ A1A9 B7               or   a
3460+ A1AA 20 26            jr   nz,.done
3461+ A1AC
3462+ A1AC                  ; Se X=0 o 4 -> corner
3463+ A1AC 7B               ld   a,e
3464+ A1AD B7               or   a
3465+ A1AE 28 1F            jr   z,.corner
3466+ A1B0 FE 04            cp   4
3467+ A1B2 28 1B            jr   z,.corner
3468+ A1B4
3469+ A1B4                  ; X=1..3 -> verifica portiere NERO (TEAM_BLACK, ID=0)
3470+ A1B4 06 00            ld   b,TEAM_BLACK
3471+ A1B6 0E 00            ld   c,0
3472+ A1B8 D5               push de
3473+ A1B9 CD 59 96         call Game_GetPlayerInfoById
3474+ A1BC D1               pop  de
3475+ A1BD
3476+ A1BD 7C               ld   a,h
3477+ A1BE BA               cp   d
3478+ A1BF 20 09            jr   nz,.goal2
3479+ A1C1 7D               ld   a,l
3480+ A1C2 BB               cp   e
3481+ A1C3 20 05            jr   nz,.goal2
3482+ A1C5
3483+ A1C5 CD 2B A2         call BallIsInGoalkeeperHands
3484+ A1C8 18 08            jr   .done
3485+ A1CA
3486+ A1CA              .goal2:
3487+ A1CA CD D8 A1         call BallIsInGoal
3488+ A1CD 18 03            jr   .done
3489+ A1CF
3490+ A1CF              .corner:
3491+ A1CF CD 13 A2         call BallIsInCornerArea
3492+ A1D2
3493+ A1D2              .done:
3494+ A1D2 E1               pop  hl
3495+ A1D3 D1               pop  de
3496+ A1D4 C1               pop  bc
3497+ A1D5 F1               pop  af
3498+ A1D6 C9               ret
3499+ A1D7
3500+ A1D7              ; ---------------------------------------------------------------------------
3501+ A1D7              ; Game_GoalCerimony
3502+ A1D7              ; ----------------------------------------------------------------------------
3503+ A1D7              Game_GoalCerimony:
3504+ A1D7 C9               RET
3505+ A1D8              ; ---------------------------------------------------------------------------
3506+ A1D8              ; BallIsInGoal
3507+ A1D8              ; ----------------------------------------------------------------------------
3508+ A1D8              BallIsInGoal:
3509+ A1D8 CD 8C 88         CALL    Hooks_UpdateTimeToPlay
3510+ A1DB CD 58 81         CALL    Hooks_TickStop
3511+ A1DE
3512+ A1DE 3E 40            LD      A, TILE_BALL_BOTTOM
3513+ A1E0 47               LD      B, A
3514+ A1E1 3E D6            LD      A, TILE_FIELD
3515+ A1E3 4F               LD      C, A
3516+ A1E4 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3517+ A1E7 FE 01            CP      FIELD_NORTH_SIDE
3518+ A1E9 20 1F            JR      NZ, .BlackGoal
3519+ A1EB 3E 03            LD      A, TILE_CORNER_BALL
3520+ A1ED 47               LD      B, A
3521+ A1EE 3A 23 B2         LD      A, (Var_Game_ScoreWhite)
3522+ A1F1 3C               INC     A
3523+ A1F2 32 23 B2         LD     (Var_Game_ScoreWhite), A
3524+ A1F5              .TileBlinking:
3525+ A1F5 D5               PUSH    DE
3526+ A1F6 C5               PUSH    BC
3527+ A1F7 E5               PUSH    HL
3528+ A1F8 CD 32 91         CALL    VDP_ShowScores
3529+ A1FB E1               POP     HL
3530+ A1FC C1               POP     BC
3531+ A1FD D1               POP     DE
3532+ A1FE 3E 01            LD      A, BLINK_TYPE_GOAL
3533+ A200 32 77 B2         LD     (Var_Hooks_BlinkingType), A
3534+ A203 CD 4D A2         CALL    BlinkTileAtPosition
3535+ A206 CD 0C AA         call    Game_PlayBeepGoalCorner
3536+ A209 C9               RET
3537+ A20A              .BlackGoal:
3538+ A20A 3A 16 B2         LD      A, (Var_Game_ScoreBlack)
3539+ A20D 3C               INC     A
3540+ A20E 32 16 B2         LD     (Var_Game_ScoreBlack), A
3541+ A211 18 E2            JR      .TileBlinking
3542+ A213              ; ---------------------------------------------------------------------------
3543+ A213              ; BallIsInCornerArea
3544+ A213              ; ----------------------------------------------------------------------------
3545+ A213              BallIsInCornerArea:
3546+ A213 CD 8C 88         CALL    Hooks_UpdateTimeToPlay
3547+ A216 CD 58 81         CALL    Hooks_TickStop
3548+ A219 3E 03            LD      A, TILE_CORNER_BALL
3549+ A21B 47               LD      B, A
3550+ A21C 3E 04            LD      A, TILE_CORNER_BALL_EMPTY
3551+ A21E 4F               LD      C, A
3552+ A21F              .TileBlinking:
3553+ A21F 3E 02            LD      A, BLINK_TYPE_CORNER
3554+ A221 32 77 B2         LD     (Var_Hooks_BlinkingType), A
3555+ A224 CD 4D A2         CALL    BlinkTileAtPosition
3556+ A227 CD 0C AA         call    Game_PlayBeepGoalCorner
3557+ A22A C9               RET
3558+ A22B              ; ---------------------------------------------------------------------------
3559+ A22B              ; BallIsInGoalkeeperHands
3560+ A22B              ; ----------------------------------------------------------------------------
3561+ A22B              BallIsInGoalkeeperHands:
3562+ A22B CD 8C 88         CALL    Hooks_UpdateTimeToPlay
3563+ A22E CD 58 81         CALL    Hooks_TickStop
3564+ A231 3E 70            LD      A, TILE_WHITE_GOALKEEPER_WITH_BALL
3565+ A233 47               LD      B, A
3566+ A234 3E D6            LD      A, TILE_FIELD
3567+ A236 4F               LD      C, A
3568+ A237 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3569+ A23A FE 01            CP      FIELD_NORTH_SIDE
3570+ A23C 20 03            JR      NZ, .TileBlinking
3571+ A23E 3E 90            LD      A, TILE_BLACK_GOALKEEPER_WITH_BALL
3572+ A240 47               LD      B, A
3573+ A241              .TileBlinking:
3574+ A241 3E 03            LD      A, BLINK_TYPE_GOALKEEPER
3575+ A243 32 77 B2         LD     (Var_Hooks_BlinkingType), A
3576+ A246 CD 4D A2         CALL    BlinkTileAtPosition
3577+ A249 CD 0C AA         call    Game_PlayBeepGoalCorner
3578+ A24C C9               RET
3579+ A24D              ; ---------------------------------------------------------------------------
3580+ A24D              ; BlinkTileAtPosition
3581+ A24D              ;INPUT: B: tile to show - C: tile to hide
3582+ A24D              ; ----------------------------------------------------------------------------
3583+ A24D              BlinkTileAtPosition:
3584+ A24D 32 77 B2         LD     (Var_Hooks_BlinkingType), A
3585+ A250 AF               XOR    A
3586+ A251 32 7B B2         LD     (Var_Hooks_BlinkingCounter), A
3587+ A254 32 7B B2         LD     (Var_Hooks_BlinkingCounter), A
3588+ A257 78               LD     A, B
3589+ A258 32 78 B2         LD     (Var_Hooks_BlinkingTileToShow), A
3590+ A25B 79               LD     A, C
3591+ A25C 32 79 B2         LD     (Var_Hooks_BlinkingTileToHide), A
3592+ A25F 78               LD     A, B
3593+ A260 32 7A B2         LD     (Var_Hooks_BlinkingActiveTile), A
3594+ A263 3E 01            LD     A, YES
3595+ A265 32 7F B2         LD     (Var_Hooks_BlinkingMustResetFrameCounter), A
3596+ A268 32 7E B2         LD     (Var_Hooks_BlinkingIsActive), A
3597+ A26B C9               RET
3598+ A26C              ; ---------------------------------------------------------------------------
3599+ A26C              ; Set visible field side
3600+ A26C              ; ---------------------------------------------------------------------------
3601+ A26C              Game_SetVisibileFieldSide:
3602+ A26C CD 9F 9A         CALL    Game_GetPlayerIdWithBall
3603+ A26F FE 00            CP      TEAM_BLACK
3604+ A271 28 1B            JR      Z, .SetSouthSide
3605+ A273 FE 01            CP      TEAM_WHITE
3606+ A275 28 01            JR      Z, .SetNorthSide
3607+ A277 C9               RET
3608+ A278              .SetNorthSide:
3609+ A278 47               LD      B, A
3610+ A279 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3611+ A27C FE 01            CP      FIELD_NORTH_SIDE
3612+ A27E C8               RET     Z
3613+ A27F 4C               LD      C, H
3614+ A280 CD 59 96         CALL    Game_GetPlayerInfoById
3615+ A283 7C               LD      A, H
3616+ A284 FE 01            CP      1
3617+ A286 C0               RET     NZ
3618+ A287 3E 01            LD      A, FIELD_NORTH_SIDE
3619+ A289 32 07 B2         LD      (Var_Game_ActiveFieldSide), A
3620+ A28C 18 14            JR      .Done
3621+ A28E              .SetSouthSide:
3622+ A28E 47               LD      B, A
3623+ A28F 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3624+ A292 FE 00            CP      FIELD_SOUTH_SIDE
3625+ A294 C8               RET     Z
3626+ A295 4C               LD      C, H
3627+ A296 CD 59 96         CALL    Game_GetPlayerInfoById
3628+ A299 7C               LD      A, H
3629+ A29A FE 03            CP      3
3630+ A29C C0               RET     NZ
3631+ A29D 3E 00            LD      A, FIELD_SOUTH_SIDE
3632+ A29F 32 07 B2         LD      (Var_Game_ActiveFieldSide), A
3633+ A2A2              .Done:
3634+ A2A2 CD 58 81         CALL    Hooks_TickStop
3635+ A2A5 CD A3 8B         CALL    VDP_DrawField
3636+ A2A8 CD B4 A2         CALL    Game_PutPlayersToNewFieldSide
3637+ A2AB 3E FF            LD      A, NO_VALUE
3638+ A2AD 32 35 B2         LD      (Var_Game_BallYOldPosition), A
3639+ A2B0 CD 50 81         CALL    Hooks_TickStart
3640+ A2B3 C9               RET
3641+ A2B4              ;----------------------------------------------------------------------------
3642+ A2B4              ; Game_PutPlayersToNewFieldSide
3643+ A2B4              ; Adjust players positions according to the new field side
3644+ A2B4              ; ----------------------------------------------------------------------------
3645+ A2B4              Game_PutPlayersToNewFieldSide:
3646+ A2B4 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
3647+ A2B7 FE 01            CP      FIELD_NORTH_SIDE
3648+ A2B9 20 74            JR      NZ, .SouthSide
3649+ A2BB              .NorthSide:
3650+ A2BB 06 00            LD      B, TEAM_BLACK
3651+ A2BD 0E 01            LD      C, 1
3652+ A2BF              .NorthSide_BLoop:
3653+ A2BF C5               PUSH    BC
3654+ A2C0 CD 59 96         CALL    Game_GetPlayerInfoById
3655+ A2C3 E5               PUSH    HL
3656+ A2C4 D1               POP     DE
3657+ A2C5 7A               LD      A, D
3658+ A2C6 FE 00            CP      0
3659+ A2C8 CC AB A3         CALL    Z, .BlackMidlefieldersFromSouthToNorth ; (0 to 3)
3660+ A2CB FE 02            CP      2
3661+ A2CD CC A8 A3         CALL    Z, .BlackStrikersFromSouthToNorth ; (2 to 1)
3662+ A2D0 3E 00            LD      A, TEAM_BLACK
3663+ A2D2 47               LD      B, A
3664+ A2D3 CD 32 96         CALL    SetPlayerInfo
3665+ A2D6 C1               POP     BC
3666+ A2D7 0C               INC     C
3667+ A2D8 79               LD      A, C
3668+ A2D9 FE 04            CP      4
3669+ A2DB 28 02            JR      Z, .NorthSideWhiteTeam
3670+ A2DD 18 E0            JR      .NorthSide_BLoop
3671+ A2DF              .NorthSideWhiteTeam:
3672+ A2DF 06 01            LD      B, TEAM_WHITE
3673+ A2E1 0E 00            LD      C, 0
3674+ A2E3              .NorthSide_WLoop:
3675+ A2E3 C5               PUSH    BC
3676+ A2E4 CD 59 96         CALL    Game_GetPlayerInfoById
3677+ A2E7 E5               PUSH    HL
3678+ A2E8 D1               POP     DE
3679+ A2E9 7A               LD      A, D
3680+ A2EA FE 03            CP      3
3681+ A2EC CC B1 A3         CALL    Z, .WhiteDefendersFromSouthToNorth ; (3 to 2)
3682+ A2EF FE 01            CP      1
3683+ A2F1 CC AE A3         CALL    Z, .WhiteMidlefieldersFromSouthToNorth ; (1 to 4)
3684+ A2F4 3E 01            LD      A, TEAM_WHITE
3685+ A2F6 47               LD      B, A
3686+ A2F7 CD 32 96         CALL    SetPlayerInfo
3687+ A2FA C1               POP     BC
3688+ A2FB 0C               INC     C
3689+ A2FC 79               LD      A, C
3690+ A2FD FE 04            CP      4
3691+ A2FF CA 04 A3         JP      Z, .NorthSideDonePlayers
3692+ A302 18 DF            JR      .NorthSide_WLoop
3693+ A304
3694+ A304              .NorthSideDonePlayers:
3695+ A304 06 00            LD      B, TEAM_BLACK
3696+ A306 0E 00            LD      C, 0
3697+ A308 C5               PUSH    BC
3698+ A309 CD 59 96         CALL    Game_GetPlayerInfoById
3699+ A30C C1               POP     BC
3700+ A30D 16 00            LD      D, 0
3701+ A30F 7D               LD      A, L
3702+ A310 5F               LD      E, A
3703+ A311 CD 32 96         CALL    SetPlayerInfo
3704+ A314
3705+ A314 06 01            LD      B, TEAM_WHITE
3706+ A316 0E 00            LD      C, 0
3707+ A318 C5               PUSH    BC
3708+ A319 CD 59 96         CALL    Game_GetPlayerInfoById
3709+ A31C C1               POP     BC
3710+ A31D 16 FF            LD      D, NO_VALUE
3711+ A31F 7D               LD      A, L
3712+ A320 5F               LD      E, A
3713+ A321 CD 32 96         CALL    SetPlayerInfo
3714+ A324 CD 92 95         CALL    Game_GetBallPosition
3715+ A327 3E 03            LD      A, 3
3716+ A329 57               LD      D, A
3717+ A32A CD 9D 95         CALL    Game_SetBallPosition
3718+ A32D
3719+ A32D 18 70            JR      .Done
3720+ A32F              .SouthSide:
3721+ A32F 06 00            LD      B, TEAM_BLACK
3722+ A331 0E 01            LD      C, 1
3723+ A333              .SouthSide_BLoop:
3724+ A333 C5               PUSH    BC
3725+ A334 CD 59 96         CALL    Game_GetPlayerInfoById
3726+ A337 E5               PUSH    HL
3727+ A338 D1               POP     DE
3728+ A339 7A               LD      A, D
3729+ A33A FE 01            CP      1
3730+ A33C CC B4 A3         CALL    Z, .BlackDefendersFromNorthToSouth ; (1 to 2)
3731+ A33F FE 03            CP      3
3732+ A341 CC B7 A3         CALL    Z, .BlackMidlefieldersFromNorthToSouth ; (3 to 0)
3733+ A344 3E 00            LD      A, TEAM_BLACK
3734+ A346 47               LD      B, A
3735+ A347 CD 32 96         CALL    SetPlayerInfo
3736+ A34A C1               POP     BC
3737+ A34B 0C               INC     C
3738+ A34C 79               LD      A, C
3739+ A34D FE 04            CP      4
3740+ A34F 28 02            JR      Z, .SouthSideWhiteTeam
3741+ A351 18 E0            JR      .SouthSide_BLoop
3742+ A353              .SouthSideWhiteTeam:
3743+ A353 06 01            LD      B, TEAM_WHITE
3744+ A355 0E 00            LD      C, 0
3745+ A357              .SouthSide_WLoop:
3746+ A357 C5               PUSH    BC
3747+ A358 CD 59 96         CALL    Game_GetPlayerInfoById
3748+ A35B E5               PUSH    HL
3749+ A35C D1               POP     DE
3750+ A35D 7A               LD      A, D
3751+ A35E FE 02            CP      2
3752+ A360 CC BA A3         CALL    Z, .WhiteStrikersFromNorthToSouth ; (2 to 3)
3753+ A363 FE 04            CP      4
3754+ A365 CC BD A3         CALL    Z, .WhiteMidlefieldersFromNorthToSouth ; (4 to 1)
3755+ A368 3E 01            LD      A, TEAM_WHITE
3756+ A36A 47               LD      B, A
3757+ A36B CD 32 96         CALL    SetPlayerInfo
3758+ A36E C1               POP     BC
3759+ A36F 0C               INC     C
3760+ A370 79               LD      A, C
3761+ A371 FE 04            CP      4
3762+ A373 28 02            JR      Z, .SouthSideDonePlayers
3763+ A375 18 E0            JR      .SouthSide_WLoop
3764+ A377              .SouthSideDonePlayers:
3765+ A377 06 00            LD      B, TEAM_BLACK
3766+ A379 0E 00            LD      C, 0
3767+ A37B C5               PUSH    BC
3768+ A37C CD 59 96         CALL    Game_GetPlayerInfoById
3769+ A37F C1               POP     BC
3770+ A380 16 FF            LD      D, NO_VALUE
3771+ A382 7D               LD      A, L
3772+ A383 5F               LD      E, A
3773+ A384 CD 32 96         CALL    SetPlayerInfo
3774+ A387
3775+ A387 06 01            LD      B, TEAM_WHITE
3776+ A389 0E 00            LD      C, 0
3777+ A38B C5               PUSH    BC
3778+ A38C CD 59 96         CALL    Game_GetPlayerInfoById
3779+ A38F C1               POP     BC
3780+ A390 16 04            LD      D, 4
3781+ A392 7D               LD      A, L
3782+ A393 5F               LD      E, A
3783+ A394 CD 32 96         CALL    SetPlayerInfo
3784+ A397 CD 92 95         CALL    Game_GetBallPosition
3785+ A39A AF               XOR     A
3786+ A39B 57               LD      D, A
3787+ A39C CD 9D 95         CALL    Game_SetBallPosition
3788+ A39F
3789+ A39F
3790+ A39F              .Done:
3791+ A39F CD C2 96         CALL    ClearAllPrevPositions
3792+ A3A2 3E 01            LD      A, YES
3793+ A3A4 32 82 B2         LD      (Var_Hooks_ForceVdpRedraw), A
3794+ A3A7 C9               RET
3795+ A3A8
3796+ A3A8              .BlackStrikersFromSouthToNorth:
3797+ A3A8 16 01            LD      D, 1
3798+ A3AA C9               RET
3799+ A3AB              .BlackMidlefieldersFromSouthToNorth:
3800+ A3AB 16 03            LD      D, 3
3801+ A3AD C9               RET
3802+ A3AE              .WhiteMidlefieldersFromSouthToNorth:
3803+ A3AE 16 04            LD      D, 4
3804+ A3B0 C9               RET
3805+ A3B1              .WhiteDefendersFromSouthToNorth:
3806+ A3B1 16 02            LD      D, 2
3807+ A3B3 C9               RET
3808+ A3B4              .BlackDefendersFromNorthToSouth:
3809+ A3B4 16 02            LD      D, 2
3810+ A3B6 C9               RET
3811+ A3B7              .BlackMidlefieldersFromNorthToSouth:
3812+ A3B7 16 00            LD      D, 0
3813+ A3B9 C9               RET
3814+ A3BA              .WhiteStrikersFromNorthToSouth:
3815+ A3BA 16 03            LD      D, 3
3816+ A3BC C9               RET
3817+ A3BD              .WhiteMidlefieldersFromNorthToSouth:
3818+ A3BD 16 01            LD      D, 1
3819+ A3BF C9               RET
3820+ A3C0
3821+ A3C0              ;---------------------------------------------------------------------------
3822+ A3C0              ; Get all players on a row
3823+ A3C0              ; INPUT:
3824+ A3C0              ;   A = Row
3825+ A3C0              ; OUTPUT:
3826+ A3C0              ;   B: First player found on that row (ID)
3827+ A3C0              ;   C: Second player found on that row (ID) or NO_VALUE
3828+ A3C0              ;----------------------------------------------------------------------------
3829+ A3C0              GetAllPlayersOnARow:
3830+ A3C0 26 FF            LD   H, NO_VALUE
3831+ A3C2 2E FF            LD   L, NO_VALUE
3832+ A3C4
3833+ A3C4 57               LD   D, A
3834+ A3C5 3A 1F B2         LD   A, (Var_Game_TmpMoveReadRowPlayersFromLeft)
3835+ A3C8 FE 01            CP   YES
3836+ A3CA 20 23            JR   NZ, .SearchFromRight
3837+ A3CC 1E 00            LD   E, 0
3838+ A3CE              .LoopLeft:
3839+ A3CE D5               PUSH  DE
3840+ A3CF E5               PUSH  HL
3841+ A3D0 CD 74 96         CALL Game_GetPlayerInfoByPos
3842+ A3D3 E1               POP   HL
3843+ A3D4 FE FF            CP  NO_VALUE
3844+ A3D6 28 09            JR  Z, .NextLeft
3845+ A3D8 7C               LD  A, H
3846+ A3D9 FE FF            CP  NO_VALUE
3847+ A3DB 20 03            JR  NZ, .LoopLeftL
3848+ A3DD 61               LD  H, C
3849+ A3DE 18 01            JR  .NextLeft
3850+ A3E0              .LoopLeftL:
3851+ A3E0 69               LD  L, C
3852+ A3E1              .NextLeft:
3853+ A3E1 D1               POP DE
3854+ A3E2 1C               INC E
3855+ A3E3 7D               LD  A, L
3856+ A3E4 FE FF            CP  NO_VALUE
3857+ A3E6 20 2A            JR  NZ, .Done
3858+ A3E8 7B               LD   A, E
3859+ A3E9 FE 05            CP  5
3860+ A3EB 28 25            JR Z,.Done
3861+ A3ED 18 DF            JR  .LoopLeft
3862+ A3EF              .SearchFromRight:
3863+ A3EF 1E 04            LD   E, 4
3864+ A3F1              .LoopRight:
3865+ A3F1 D5               PUSH  DE
3866+ A3F2 E5               PUSH  HL
3867+ A3F3 CD 74 96         CALL Game_GetPlayerInfoByPos
3868+ A3F6 E1               POP   HL
3869+ A3F7 FE FF            CP  NO_VALUE
3870+ A3F9 28 09            JR  Z, .NextRight
3871+ A3FB 7C               LD  A, H
3872+ A3FC FE FF            CP  NO_VALUE
3873+ A3FE 20 03            JR  NZ, .LoopRightL
3874+ A400 61               LD  H, C
3875+ A401 18 01            JR .NextRight
3876+ A403              .LoopRightL:
3877+ A403 69               LD  L, C
3878+ A404              .NextRight:
3879+ A404 D1               POP DE
3880+ A405 1D               DEC E
3881+ A406 7D               LD  A, L
3882+ A407 FE FF            CP  NO_VALUE
3883+ A409 20 07            JR NZ, .Done
3884+ A40B 7B               LD   A, E
3885+ A40C FE FF            CP  255
3886+ A40E 28 02            JR Z, .Done
3887+ A410 18 DF            JR  .LoopRight
3888+ A412
3889+ A412              .Done:
3890+ A412 44               ld B,H
3891+ A413 4D               ld C,L
3892+ A414 C9               RET
3893+ A415              Game_Start:
3894+ A415 CD AD 86         CALL    Hooks_InitAICounters
3895+ A418 3E 00            LD      A, NO
3896+ A41A 32 7E B2         LD      (Var_Hooks_BlinkingIsActive), A
3897+ A41D 3E 01            LD      A, 1
3898+ A41F 32 09 B2         LD      (Var_Game_SelectedLevel), A
3899+ A422 AF               XOR     A
3900+ A423 32 03 B2         LD      (Var_Utils_NumberToPrint+5),A
3901+ A426 32 85 B2         LD      (Var_Hooks_TickCounter),A
3902+ A429 3E 05            LD      A, TICK_SPEED
3903+ A42B 32 83 B2         LD      (Var_Hooks_TickSpeed), A
3904+ A42E 3E 01            LD      A, FIELD_NORTH_SIDE
3905+ A430 32 07 B2         LD      (Var_Game_ActiveFieldSide), A
3906+ A433 CD A3 8B         CALL    VDP_DrawField
3907+ A436 CD E2 96         CALL    Game_SetWhiteKickoffSchema
3908+ A439 CD 01 8F         CALL    VDP_PlayerMatrixRedraw
3909+ A43C CD 58 81         call    Hooks_TickStop
3910+ A43F CD 02 99         CALL    Game_Resume
3911+ A442 3E 01            LD      A, YES
3912+ A444 32 7C B2         LD      (Var_Hooks_GameResumingWaiting), A
3913+ A447
3914+ A447
3915+ A447                  ;ld   hl,SND_DATA
3916+ A447                  ;ld   de,SND_LEN        ; 1543 per il tuo file
3917+ A447                  ;call Sounds_PlayHLDE      ; parte la riproduzione in background
3918+ A447
3919+ A447
3920+ A447 C9               RET
3921+ A448
3922+ A448              ; ---------------------------------------------------------------------------
3923+ A448              ; ClearGameFieldForGoalCerimony
3924+ A448              ; ----------------------------------------------------------------------------
3925+ A448              Game_ClearGameFieldForGoalCerimony:
3926+ A448 F5               PUSH    AF
3927+ A449 C5               PUSH    BC
3928+ A44A D5               PUSH    DE
3929+ A44B E5               PUSH    HL
3930+ A44C 3A 07 B2         LD      A,(Var_Game_ActiveFieldSide)
3931+ A44F FE 01            CP      FIELD_NORTH_SIDE
3932+ A451 20 1D            JR      NZ, .SouthSideClear
3933+ A453              .NorthSideClear:
3934+ A453 16 01            LD      D, 1
3935+ A455              .Loop_North_Rows:
3936+ A455 D5               PUSH    DE
3937+ A456 1E 00            LD      E, 0
3938+ A458              .Loop_North_Cols:
3939+ A458 D5               PUSH    DE
3940+ A459 3E D6            LD      A,TILE_FIELD
3941+ A45B
3942+ A45B CD 35 89         CALL    VDP_DrawSprite
3943+ A45E D1               POP     DE
3944+ A45F 1C               INC     E
3945+ A460 7B               LD      A, E
3946+ A461 FE 05            CP      5
3947+ A463 28 02            JR      Z,.Done_North_Rows
3948+ A465 18 F1            JR      .Loop_North_Cols
3949+ A467              .Done_North_Rows:
3950+ A467 D1               POP     DE
3951+ A468 14               INC     D
3952+ A469 7A               LD      A, D
3953+ A46A FE 05            CP      5
3954+ A46C 28 1F            JR      Z,.Done
3955+ A46E 18 E5            JR      .Loop_North_Rows
3956+ A470
3957+ A470              .SouthSideClear:
3958+ A470 16 00            LD      D, 0
3959+ A472              .Loop_South_Rows:
3960+ A472 D5               PUSH    DE
3961+ A473 1E 00            LD      E, 0
3962+ A475              .Loop_South_Cols:
3963+ A475 D5               PUSH    DE
3964+ A476 3E D6            LD      A,TILE_FIELD
3965+ A478
3966+ A478 CD 35 89         CALL    VDP_DrawSprite
3967+ A47B D1               POP     DE
3968+ A47C 1C               INC     E
3969+ A47D 7B               LD      A, E
3970+ A47E FE 05            CP      5
3971+ A480 28 02            JR      Z,.Done_South_Rows
3972+ A482 18 F1            JR      .Loop_South_Cols
3973+ A484              .Done_South_Rows:
3974+ A484 D1               POP     DE
3975+ A485 14               INC     D
3976+ A486 7A               LD      A, D
3977+ A487 FE 04            CP      4
3978+ A489 28 02            JR      Z,.Done
3979+ A48B 18 E5            JR      .Loop_South_Rows
3980+ A48D
3981+ A48D              .Done:
3982+ A48D E1               POP     HL
3983+ A48E D1               POP     DE
3984+ A48F C1               POP     BC
3985+ A490 F1               POP     AF
3986+ A491 C9               RET
3987+ A492              ; ---------------------------------------------------------------------------
3988+ A492              ; PutCerimonyWhitePlayersPos1
3989+ A492              ; ----------------------------------------------------------------------------
3990+ A492              PutCerimonyWhitePlayersPos1:
3991+ A492 CD 8B 93         CALL    Utils_PlayBeepTick
3992+ A495 16 02            LD      D, 2
3993+ A497 1E 00            LD      E, 0
3994+ A499 D5               PUSH    DE
3995+ A49A 3E A0            LD      A,TILE_WHITE_PLAYER
3996+ A49C
3997+ A49C CD 35 89         CALL    VDP_DrawSprite
3998+ A49F D1               POP     DE
3999+ A4A0 16 02            LD      D, 2
4000+ A4A2 1E 01            LD      E, 1
4001+ A4A4 D5               PUSH    DE
4002+ A4A5 3E A0            LD      A,TILE_WHITE_PLAYER
4003+ A4A7
4004+ A4A7 CD 35 89         CALL    VDP_DrawSprite
4005+ A4AA D1               POP     DE
4006+ A4AB
4007+ A4AB 16 04            LD      D, 4
4008+ A4AD 1E 03            LD      E, 3
4009+ A4AF D5               PUSH    DE
4010+ A4B0 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4011+ A4B2
4012+ A4B2 CD 35 89         CALL    VDP_DrawSprite
4013+ A4B5 D1               POP     DE
4014+ A4B6 16 04            LD      D, 4
4015+ A4B8 1E 04            LD      E, 4
4016+ A4BA D5               PUSH    DE
4017+ A4BB 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4018+ A4BD
4019+ A4BD CD 35 89         CALL    VDP_DrawSprite
4020+ A4C0 D1               POP     DE
4021+ A4C1 C9               RET
4022+ A4C2
4023+ A4C2              ; ---------------------------------------------------------------------------
4024+ A4C2              ; PutCerimonyWhitePlayersPos2
4025+ A4C2              ; ----------------------------------------------------------------------------
4026+ A4C2              PutCerimonyWhitePlayersPos2:
4027+ A4C2 CD 8B 93         CALL    Utils_PlayBeepTick
4028+ A4C5 16 02            LD      D, 2
4029+ A4C7 1E 00            LD      E, 0
4030+ A4C9 D5               PUSH    DE
4031+ A4CA 3E D6            LD      A,TILE_FIELD
4032+ A4CC
4033+ A4CC CD 35 89         CALL    VDP_DrawSprite
4034+ A4CF D1               POP     DE
4035+ A4D0 16 02            LD      D, 2
4036+ A4D2 1E 02            LD      E, 2
4037+ A4D4 D5               PUSH    DE
4038+ A4D5 3E A0            LD      A,TILE_WHITE_PLAYER
4039+ A4D7
4040+ A4D7 CD 35 89         CALL    VDP_DrawSprite
4041+ A4DA D1               POP     DE
4042+ A4DB
4043+ A4DB 16 04            LD      D, 4
4044+ A4DD 1E 02            LD      E, 2
4045+ A4DF D5               PUSH    DE
4046+ A4E0 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4047+ A4E2
4048+ A4E2 CD 35 89         CALL    VDP_DrawSprite
4049+ A4E5 D1               POP     DE
4050+ A4E6 16 04            LD      D, 4
4051+ A4E8 1E 04            LD      E, 4
4052+ A4EA D5               PUSH    DE
4053+ A4EB 3E D6            LD      A, TILE_FIELD
4054+ A4ED
4055+ A4ED CD 35 89         CALL    VDP_DrawSprite
4056+ A4F0
4057+ A4F0 16 11            LD      D, 17
4058+ A4F2 1E 11            LD      E, 17
4059+ A4F4 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4060+ A4F6 CD 9F 88         CALL    VDP_PrintRamChar
4061+ A4F9 1E 12            LD      E, 18
4062+ A4FB 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4063+ A4FD CD 9F 88         CALL    VDP_PrintRamChar
4064+ A500 1E 13            LD      E, 19
4065+ A502 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4066+ A504 CD 9F 88         CALL    VDP_PrintRamChar
4067+ A507 1E 14            LD      E, 20
4068+ A509 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4069+ A50B CD 9F 88         CALL    VDP_PrintRamChar
4070+ A50E
4071+ A50E 16 11            LD      D, 17
4072+ A510 1E 0A            LD      E, 10
4073+ A512 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4074+ A514 CD 9F 88         call    VDP_PrintRamChar
4075+ A517 16 11            LD      D, 17
4076+ A519 1E 0B            LD      E, 11
4077+ A51B 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4078+ A51D CD 9F 88         call    VDP_PrintRamChar
4079+ A520
4080+ A520 16 11            LD      D, 17
4081+ A522 1E 0E            LD      E, 14
4082+ A524 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4083+ A526 CD 9F 88         call    VDP_PrintRamChar
4084+ A529 16 11            LD      D, 17
4085+ A52B 1E 0F            LD      E, 15
4086+ A52D 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4087+ A52F CD 9F 88         call    VDP_PrintRamChar
4088+ A532
4089+ A532 D1               POP     DE
4090+ A533 C9               RET
4091+ A534              ; ---------------------------------------------------------------------------
4092+ A534              ; PutCerimonyWhitePlayersPos3
4093+ A534              ; ----------------------------------------------------------------------------
4094+ A534              PutCerimonyWhitePlayersPos3:
4095+ A534 CD 8B 93         CALL    Utils_PlayBeepTick
4096+ A537 16 02            LD      D, 2
4097+ A539 1E 01            LD      E, 1
4098+ A53B D5               PUSH    DE
4099+ A53C 3E D6            LD      A,TILE_FIELD
4100+ A53E
4101+ A53E CD 35 89         CALL    VDP_DrawSprite
4102+ A541 D1               POP     DE
4103+ A542 16 02            LD      D, 2
4104+ A544 1E 03            LD      E, 3
4105+ A546 D5               PUSH    DE
4106+ A547 3E A0            LD      A,TILE_WHITE_PLAYER
4107+ A549
4108+ A549 CD 35 89         CALL    VDP_DrawSprite
4109+ A54C D1               POP     DE
4110+ A54D
4111+ A54D 16 04            LD      D, 4
4112+ A54F 1E 01            LD      E, 1
4113+ A551 D5               PUSH    DE
4114+ A552 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4115+ A554
4116+ A554 CD 35 89         CALL    VDP_DrawSprite
4117+ A557 D1               POP     DE
4118+ A558 16 04            LD      D, 4
4119+ A55A 1E 03            LD      E, 3
4120+ A55C D5               PUSH    DE
4121+ A55D 3E D6            LD      A, TILE_FIELD
4122+ A55F
4123+ A55F CD 35 89         CALL    VDP_DrawSprite
4124+ A562
4125+ A562 16 11            LD      D, 17
4126+ A564 1E 0D            LD      E, 13
4127+ A566 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4128+ A568 CD 9F 88         CALL    VDP_PrintRamChar
4129+ A56B 1E 0E            LD      E, 14
4130+ A56D 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4131+ A56F CD 9F 88         CALL    VDP_PrintRamChar
4132+ A572 1E 0F            LD      E, 15
4133+ A574 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4134+ A576 CD 9F 88         CALL    VDP_PrintRamChar
4135+ A579 1E 10            LD      E, 16
4136+ A57B 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4137+ A57D CD 9F 88         CALL    VDP_PrintRamChar
4138+ A580
4139+ A580
4140+ A580
4141+ A580 16 11            LD      D, 17
4142+ A582 1E 06            LD      E, 6
4143+ A584 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4144+ A586 CD 9F 88         call    VDP_PrintRamChar
4145+ A589 16 11            LD      D, 17
4146+ A58B 1E 07            LD      E, 7
4147+ A58D 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4148+ A58F CD 9F 88         call    VDP_PrintRamChar
4149+ A592 16 11            LD      D, 17
4150+ A594 1E 0A            LD      E, 10
4151+ A596 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4152+ A598 CD 9F 88         call    VDP_PrintRamChar
4153+ A59B 16 11            LD      D, 17
4154+ A59D 1E 0B            LD      E, 11
4155+ A59F 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4156+ A5A1 CD 9F 88         call    VDP_PrintRamChar
4157+ A5A4
4158+ A5A4 D1               POP     DE
4159+ A5A5 C9               RET
4160+ A5A6              ; ---------------------------------------------------------------------------
4161+ A5A6              ; PutCerimonyWhitePlayersPos4
4162+ A5A6              ; ----------------------------------------------------------------------------
4163+ A5A6              PutCerimonyWhitePlayersPos4:
4164+ A5A6 CD 8B 93         CALL    Utils_PlayBeepTick
4165+ A5A9 16 02            LD      D, 2
4166+ A5AB 1E 03            LD      E, 3
4167+ A5AD D5               PUSH    DE
4168+ A5AE 3E D6            LD      A,TILE_FIELD
4169+ A5B0
4170+ A5B0 CD 35 89         CALL    VDP_DrawSprite
4171+ A5B3 D1               POP     DE
4172+ A5B4 16 02            LD      D, 2
4173+ A5B6 1E 01            LD      E, 1
4174+ A5B8 D5               PUSH    DE
4175+ A5B9 3E A0            LD      A,TILE_WHITE_PLAYER
4176+ A5BB
4177+ A5BB CD 35 89         CALL    VDP_DrawSprite
4178+ A5BE D1               POP     DE
4179+ A5BF
4180+ A5BF 16 04            LD      D, 4
4181+ A5C1 1E 03            LD      E, 3
4182+ A5C3 D5               PUSH    DE
4183+ A5C4 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4184+ A5C6
4185+ A5C6 CD 35 89         CALL    VDP_DrawSprite
4186+ A5C9 D1               POP     DE
4187+ A5CA 16 04            LD      D, 4
4188+ A5CC 1E 01            LD      E, 1
4189+ A5CE D5               PUSH    DE
4190+ A5CF 3E D6            LD      A, TILE_FIELD
4191+ A5D1
4192+ A5D1 CD 35 89         CALL    VDP_DrawSprite
4193+ A5D4
4194+ A5D4 16 11            LD      D, 17
4195+ A5D6 1E 05            LD      E, 5
4196+ A5D8 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4197+ A5DA CD 9F 88         CALL    VDP_PrintRamChar
4198+ A5DD 1E 06            LD      E, 6
4199+ A5DF 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4200+ A5E1 CD 9F 88         CALL    VDP_PrintRamChar
4201+ A5E4 1E 07            LD      E, 7
4202+ A5E6 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4203+ A5E8 CD 9F 88         CALL    VDP_PrintRamChar
4204+ A5EB 1E 08            LD      E, 8
4205+ A5ED 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4206+ A5EF CD 9F 88         CALL    VDP_PrintRamChar
4207+ A5F2
4208+ A5F2
4209+ A5F2 16 11            LD      D, 17
4210+ A5F4 1E 0A            LD      E, 10
4211+ A5F6 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4212+ A5F8 CD 9F 88         call    VDP_PrintRamChar
4213+ A5FB 16 11            LD      D, 17
4214+ A5FD 1E 0B            LD      E, 11
4215+ A5FF 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4216+ A601 CD 9F 88         call    VDP_PrintRamChar
4217+ A604 16 11            LD      D, 17
4218+ A606 1E 0E            LD      E, 14
4219+ A608 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4220+ A60A CD 9F 88         call    VDP_PrintRamChar
4221+ A60D 16 11            LD      D, 17
4222+ A60F 1E 0F            LD      E, 15
4223+ A611 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4224+ A613 CD 9F 88         call    VDP_PrintRamChar
4225+ A616
4226+ A616
4227+ A616 D1               POP     DE
4228+ A617 C9               RET
4229+ A618              ; ---------------------------------------------------------------------------
4230+ A618              ; PutCerimonyWhitePlayersPos5
4231+ A618              ; ----------------------------------------------------------------------------
4232+ A618              PutCerimonyWhitePlayersPos5:
4233+ A618 CD 8A 93         CALL    Utils_PlayBeepHighLong
4234+ A61B 16 02            LD      D, 2
4235+ A61D 1E 02            LD      E, 2
4236+ A61F D5               PUSH    DE
4237+ A620 3E D6            LD      A,TILE_FIELD
4238+ A622
4239+ A622 CD 35 89         CALL    VDP_DrawSprite
4240+ A625 D1               POP     DE
4241+ A626 16 02            LD      D, 2
4242+ A628 1E 00            LD      E, 0
4243+ A62A D5               PUSH    DE
4244+ A62B 3E A0            LD      A,TILE_WHITE_PLAYER
4245+ A62D
4246+ A62D CD 35 89         CALL    VDP_DrawSprite
4247+ A630 D1               POP     DE
4248+ A631
4249+ A631 16 04            LD      D, 4
4250+ A633 1E 04            LD      E, 4
4251+ A635 D5               PUSH    DE
4252+ A636 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4253+ A638
4254+ A638 CD 35 89         CALL    VDP_DrawSprite
4255+ A63B D1               POP     DE
4256+ A63C 16 04            LD      D, 4
4257+ A63E 1E 02            LD      E, 2
4258+ A640 D5               PUSH    DE
4259+ A641 3E D6            LD      A, TILE_FIELD
4260+ A643
4261+ A643 CD 35 89         CALL    VDP_DrawSprite
4262+ A646
4263+ A646 16 11            LD      D, 17
4264+ A648 1E 09            LD      E, 9
4265+ A64A 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4266+ A64C CD 9F 88         CALL    VDP_PrintRamChar
4267+ A64F 1E 0A            LD      E, 10
4268+ A651 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4269+ A653 CD 9F 88         CALL    VDP_PrintRamChar
4270+ A656 1E 0B            LD      E, 11
4271+ A658 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4272+ A65A CD 9F 88         CALL    VDP_PrintRamChar
4273+ A65D 1E 0C            LD      E, 12
4274+ A65F 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4275+ A661 CD 9F 88         CALL    VDP_PrintRamChar
4276+ A664
4277+ A664 16 11            LD      D, 17
4278+ A666 1E 0E            LD      E, 14
4279+ A668 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4280+ A66A CD 9F 88         call    VDP_PrintRamChar
4281+ A66D 16 11            LD      D, 17
4282+ A66F 1E 0F            LD      E, 15
4283+ A671 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4284+ A673 CD 9F 88         call    VDP_PrintRamChar
4285+ A676 16 11            LD      D, 17
4286+ A678 1E 12            LD      E, 18
4287+ A67A 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4288+ A67C CD 9F 88         call    VDP_PrintRamChar
4289+ A67F 16 11            LD      D, 17
4290+ A681 1E 13            LD      E, 19
4291+ A683 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4292+ A685 CD 9F 88         call    VDP_PrintRamChar
4293+ A688
4294+ A688
4295+ A688 D1               POP     DE
4296+ A689 C9               RET
4297+ A68A              ; ---------------------------------------------------------------------------
4298+ A68A              ; PutCerimonyWhitePlayersPos6
4299+ A68A              ; ----------------------------------------------------------------------------
4300+ A68A              PutCerimonyWhitePlayersPos6:
4301+ A68A CD 8B 93         CALL    Utils_PlayBeepTick
4302+ A68D 16 02            LD      D, 2
4303+ A68F 1E 00            LD      E, 0
4304+ A691 D5               PUSH    DE
4305+ A692 3E D6            LD      A,TILE_FIELD
4306+ A694
4307+ A694 CD 35 89         CALL    VDP_DrawSprite
4308+ A697 D1               POP     DE
4309+ A698 16 02            LD      D, 2
4310+ A69A 1E 02            LD      E, 2
4311+ A69C D5               PUSH    DE
4312+ A69D 3E A0            LD      A,TILE_WHITE_PLAYER
4313+ A69F
4314+ A69F CD 35 89         CALL    VDP_DrawSprite
4315+ A6A2 D1               POP     DE
4316+ A6A3
4317+ A6A3 16 04            LD      D, 4
4318+ A6A5 1E 02            LD      E, 2
4319+ A6A7 D5               PUSH    DE
4320+ A6A8 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4321+ A6AA
4322+ A6AA CD 35 89         CALL    VDP_DrawSprite
4323+ A6AD D1               POP     DE
4324+ A6AE 16 04            LD      D, 4
4325+ A6B0 1E 04            LD      E, 4
4326+ A6B2 D5               PUSH    DE
4327+ A6B3 3E D6            LD      A, TILE_FIELD
4328+ A6B5
4329+ A6B5 CD 35 89         CALL    VDP_DrawSprite
4330+ A6B8
4331+ A6B8 16 11            LD      D, 17
4332+ A6BA 1E 11            LD      E, 17
4333+ A6BC 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4334+ A6BE CD 9F 88         CALL    VDP_PrintRamChar
4335+ A6C1 1E 12            LD      E, 18
4336+ A6C3 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4337+ A6C5 CD 9F 88         CALL    VDP_PrintRamChar
4338+ A6C8 1E 13            LD      E, 19
4339+ A6CA 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4340+ A6CC CD 9F 88         CALL    VDP_PrintRamChar
4341+ A6CF 1E 14            LD      E, 20
4342+ A6D1 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4343+ A6D3 CD 9F 88         CALL    VDP_PrintRamChar
4344+ A6D6
4345+ A6D6 16 11            LD      D, 17
4346+ A6D8 1E 0E            LD      E, 14
4347+ A6DA 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4348+ A6DC CD 9F 88         call    VDP_PrintRamChar
4349+ A6DF 16 11            LD      D, 17
4350+ A6E1 1E 0F            LD      E, 15
4351+ A6E3 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4352+ A6E5 CD 9F 88         call    VDP_PrintRamChar
4353+ A6E8 16 11            LD      D, 17
4354+ A6EA 1E 0A            LD      E, 10
4355+ A6EC 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4356+ A6EE CD 9F 88         call    VDP_PrintRamChar
4357+ A6F1 16 11            LD      D, 17
4358+ A6F3 1E 0B            LD      E, 11
4359+ A6F5 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4360+ A6F7 CD 9F 88         call    VDP_PrintRamChar
4361+ A6FA D1               POP     DE
4362+ A6FB C9               RET
4363+ A6FC              ; ---------------------------------------------------------------------------
4364+ A6FC              ; PutCerimonyWhitePlayersPos7
4365+ A6FC              ; ----------------------------------------------------------------------------
4366+ A6FC              PutCerimonyWhitePlayersPos7:
4367+ A6FC CD 8B 93         CALL    Utils_PlayBeepTick
4368+ A6FF 16 02            LD      D, 2
4369+ A701 1E 01            LD      E, 1
4370+ A703 D5               PUSH    DE
4371+ A704 3E D6            LD      A,TILE_FIELD
4372+ A706
4373+ A706 CD 35 89         CALL    VDP_DrawSprite
4374+ A709 D1               POP     DE
4375+ A70A 16 02            LD      D, 2
4376+ A70C 1E 03            LD      E, 3
4377+ A70E D5               PUSH    DE
4378+ A70F 3E A0            LD      A,TILE_WHITE_PLAYER
4379+ A711
4380+ A711 CD 35 89         CALL    VDP_DrawSprite
4381+ A714 D1               POP     DE
4382+ A715
4383+ A715 16 04            LD      D, 4
4384+ A717 1E 01            LD      E, 1
4385+ A719 D5               PUSH    DE
4386+ A71A 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4387+ A71C
4388+ A71C CD 35 89         CALL    VDP_DrawSprite
4389+ A71F D1               POP     DE
4390+ A720 16 04            LD      D, 4
4391+ A722 1E 03            LD      E, 3
4392+ A724 D5               PUSH    DE
4393+ A725 3E D6            LD      A, TILE_FIELD
4394+ A727
4395+ A727 CD 35 89         CALL    VDP_DrawSprite
4396+ A72A
4397+ A72A 16 11            LD      D, 17
4398+ A72C 1E 0D            LD      E, 13
4399+ A72E 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4400+ A730 CD 9F 88         CALL    VDP_PrintRamChar
4401+ A733 1E 0E            LD      E, 14
4402+ A735 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4403+ A737 CD 9F 88         CALL    VDP_PrintRamChar
4404+ A73A 1E 0F            LD      E, 15
4405+ A73C 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4406+ A73E CD 9F 88         CALL    VDP_PrintRamChar
4407+ A741 1E 10            LD      E, 16
4408+ A743 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4409+ A745 CD 9F 88         CALL    VDP_PrintRamChar
4410+ A748
4411+ A748
4412+ A748
4413+ A748 16 11            LD      D, 17
4414+ A74A 1E 0A            LD      E, 10
4415+ A74C 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4416+ A74E CD 9F 88         call    VDP_PrintRamChar
4417+ A751 16 11            LD      D, 17
4418+ A753 1E 0B            LD      E, 11
4419+ A755 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4420+ A757 CD 9F 88         call    VDP_PrintRamChar
4421+ A75A 16 11            LD      D, 17
4422+ A75C 1E 06            LD      E, 6
4423+ A75E 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4424+ A760 CD 9F 88         call    VDP_PrintRamChar
4425+ A763 16 11            LD      D, 17
4426+ A765 1E 07            LD      E, 7
4427+ A767 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4428+ A769 CD 9F 88         call    VDP_PrintRamChar
4429+ A76C
4430+ A76C
4431+ A76C D1               POP     DE
4432+ A76D C9               RET
4433+ A76E              ; ---------------------------------------------------------------------------
4434+ A76E              ; PutCerimonyWhitePlayersPos8
4435+ A76E              ; ----------------------------------------------------------------------------
4436+ A76E              PutCerimonyWhitePlayersPos8:
4437+ A76E CD 8B 93         CALL    Utils_PlayBeepTick
4438+ A771 16 02            LD      D, 2
4439+ A773 1E 03            LD      E, 3
4440+ A775 D5               PUSH    DE
4441+ A776 3E D6            LD      A,TILE_FIELD
4442+ A778
4443+ A778 CD 35 89         CALL    VDP_DrawSprite
4444+ A77B D1               POP     DE
4445+ A77C 16 02            LD      D, 2
4446+ A77E 1E 01            LD      E, 1
4447+ A780 D5               PUSH    DE
4448+ A781 3E A0            LD      A,TILE_WHITE_PLAYER
4449+ A783
4450+ A783 CD 35 89         CALL    VDP_DrawSprite
4451+ A786 D1               POP     DE
4452+ A787
4453+ A787 16 04            LD      D, 4
4454+ A789 1E 03            LD      E, 3
4455+ A78B D5               PUSH    DE
4456+ A78C 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4457+ A78E
4458+ A78E CD 35 89         CALL    VDP_DrawSprite
4459+ A791 D1               POP     DE
4460+ A792 16 04            LD      D, 4
4461+ A794 1E 01            LD      E, 1
4462+ A796 D5               PUSH    DE
4463+ A797 3E D6            LD      A, TILE_FIELD
4464+ A799
4465+ A799 CD 35 89         CALL    VDP_DrawSprite
4466+ A79C
4467+ A79C 16 11            LD      D, 17
4468+ A79E 1E 05            LD      E, 5
4469+ A7A0 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4470+ A7A2 CD 9F 88         CALL    VDP_PrintRamChar
4471+ A7A5 1E 06            LD      E, 6
4472+ A7A7 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4473+ A7A9 CD 9F 88         CALL    VDP_PrintRamChar
4474+ A7AC 1E 07            LD      E, 7
4475+ A7AE 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4476+ A7B0 CD 9F 88         CALL    VDP_PrintRamChar
4477+ A7B3 1E 08            LD      E, 8
4478+ A7B5 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4479+ A7B7 CD 9F 88         CALL    VDP_PrintRamChar
4480+ A7BA
4481+ A7BA 16 11            LD      D, 17
4482+ A7BC 1E 0A            LD      E, 10
4483+ A7BE 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4484+ A7C0 CD 9F 88         call    VDP_PrintRamChar
4485+ A7C3 16 11            LD      D, 17
4486+ A7C5 1E 0B            LD      E, 11
4487+ A7C7 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4488+ A7C9 CD 9F 88         call    VDP_PrintRamChar
4489+ A7CC 16 11            LD      D, 17
4490+ A7CE 1E 0E            LD      E, 14
4491+ A7D0 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4492+ A7D2 CD 9F 88         call    VDP_PrintRamChar
4493+ A7D5 16 11            LD      D, 17
4494+ A7D7 1E 0F            LD      E, 15
4495+ A7D9 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4496+ A7DB CD 9F 88         call    VDP_PrintRamChar
4497+ A7DE
4498+ A7DE
4499+ A7DE D1               POP     DE
4500+ A7DF C9               RET
4501+ A7E0              ; ---------------------------------------------------------------------------
4502+ A7E0              ; PutCerimonyWhitePlayersPos9
4503+ A7E0              ; ----------------------------------------------------------------------------
4504+ A7E0              PutCerimonyWhitePlayersPos9:
4505+ A7E0 CD 8B 93         CALL    Utils_PlayBeepTick
4506+ A7E3 16 02            LD      D, 2
4507+ A7E5 1E 02            LD      E, 2
4508+ A7E7 D5               PUSH    DE
4509+ A7E8 3E D6            LD      A,TILE_FIELD
4510+ A7EA
4511+ A7EA CD 35 89         CALL    VDP_DrawSprite
4512+ A7ED D1               POP     DE
4513+ A7EE 16 02            LD      D, 2
4514+ A7F0 1E 00            LD      E, 0
4515+ A7F2 D5               PUSH    DE
4516+ A7F3 3E A0            LD      A,TILE_WHITE_PLAYER
4517+ A7F5
4518+ A7F5 CD 35 89         CALL    VDP_DrawSprite
4519+ A7F8 D1               POP     DE
4520+ A7F9
4521+ A7F9 16 04            LD      D, 4
4522+ A7FB 1E 04            LD      E, 4
4523+ A7FD D5               PUSH    DE
4524+ A7FE 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4525+ A800
4526+ A800 CD 35 89         CALL    VDP_DrawSprite
4527+ A803 D1               POP     DE
4528+ A804 16 04            LD      D, 4
4529+ A806 1E 02            LD      E, 2
4530+ A808 D5               PUSH    DE
4531+ A809 3E D6            LD      A, TILE_FIELD
4532+ A80B
4533+ A80B CD 35 89         CALL    VDP_DrawSprite
4534+ A80E
4535+ A80E 16 11            LD      D, 17
4536+ A810 1E 09            LD      E, 9
4537+ A812 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4538+ A814 CD 9F 88         CALL    VDP_PrintRamChar
4539+ A817 1E 0A            LD      E, 10
4540+ A819 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4541+ A81B CD 9F 88         CALL    VDP_PrintRamChar
4542+ A81E 1E 0B            LD      E, 11
4543+ A820 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4544+ A822 CD 9F 88         CALL    VDP_PrintRamChar
4545+ A825 1E 0C            LD      E, 12
4546+ A827 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4547+ A829 CD 9F 88         CALL    VDP_PrintRamChar
4548+ A82C
4549+ A82C 16 11            LD      D, 17
4550+ A82E 1E 0E            LD      E, 14
4551+ A830 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4552+ A832 CD 9F 88         call    VDP_PrintRamChar
4553+ A835 16 11            LD      D, 17
4554+ A837 1E 0F            LD      E, 15
4555+ A839 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4556+ A83B CD 9F 88         call    VDP_PrintRamChar
4557+ A83E 16 11            LD      D, 17
4558+ A840 1E 12            LD      E, 18
4559+ A842 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4560+ A844 CD 9F 88         call    VDP_PrintRamChar
4561+ A847 16 11            LD      D, 17
4562+ A849 1E 13            LD      E, 19
4563+ A84B 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4564+ A84D CD 9F 88         call    VDP_PrintRamChar
4565+ A850
4566+ A850 D1               POP     DE
4567+ A851 C9               RET
4568+ A852
4569+ A852
4570+ A852
4571+ A852
4572+ A852
4573+ A852
4574+ A852
4575+ A852
4576+ A852
4577+ A852
4578+ A852              ; ---------------------------------------------------------------------------
4579+ A852              ; PutCerimonyBlackPlayersPos1
4580+ A852              ; ----------------------------------------------------------------------------
4581+ A852              PutCerimonyBlackPlayersPos1:
4582+ A852 CD 8B 93         CALL    Utils_PlayBeepTick
4583+ A855 16 00            LD      D, 0
4584+ A857 1E 00            LD      E, 0
4585+ A859 D5               PUSH    DE
4586+ A85A 3E B0            LD      A,TILE_BLACK_PLAYER
4587+ A85C
4588+ A85C CD 35 89         CALL    VDP_DrawSprite
4589+ A85F D1               POP     DE
4590+ A860 16 00            LD      D, 0
4591+ A862 1E 01            LD      E, 1
4592+ A864 D5               PUSH    DE
4593+ A865 3E B0            LD      A,TILE_BLACK_PLAYER
4594+ A867
4595+ A867 CD 35 89         CALL    VDP_DrawSprite
4596+ A86A D1               POP     DE
4597+ A86B
4598+ A86B 16 02            LD      D, 2
4599+ A86D 1E 03            LD      E, 3
4600+ A86F D5               PUSH    DE
4601+ A870 3E B0            LD      A, TILE_BLACK_PLAYER
4602+ A872
4603+ A872 CD 35 89         CALL    VDP_DrawSprite
4604+ A875 D1               POP     DE
4605+ A876 16 02            LD      D, 2
4606+ A878 1E 04            LD      E, 4
4607+ A87A D5               PUSH    DE
4608+ A87B 3E B0            LD      A, TILE_BLACK_PLAYER
4609+ A87D
4610+ A87D CD 35 89         CALL    VDP_DrawSprite
4611+ A880 D1               POP     DE
4612+ A881 C9               RET
4613+ A882
4614+ A882              ; ---------------------------------------------------------------------------
4615+ A882              ; PutCerimonyBlackPlayersPos2
4616+ A882              ; ----------------------------------------------------------------------------
4617+ A882              PutCerimonyBlackPlayersPos2:
4618+ A882 CD 8B 93         CALL    Utils_PlayBeepTick
4619+ A885 16 00            LD      D, 0
4620+ A887 1E 00            LD      E, 0
4621+ A889 D5               PUSH    DE
4622+ A88A 3E D6            LD      A,TILE_FIELD
4623+ A88C
4624+ A88C CD 35 89         CALL    VDP_DrawSprite
4625+ A88F D1               POP     DE
4626+ A890 16 00            LD      D, 0
4627+ A892 1E 02            LD      E, 2
4628+ A894 D5               PUSH    DE
4629+ A895 3E B0            LD      A,TILE_BLACK_PLAYER
4630+ A897
4631+ A897 CD 35 89         CALL    VDP_DrawSprite
4632+ A89A D1               POP     DE
4633+ A89B
4634+ A89B 16 02            LD      D, 2
4635+ A89D 1E 02            LD      E, 2
4636+ A89F D5               PUSH    DE
4637+ A8A0 3E B0            LD      A, TILE_BLACK_PLAYER
4638+ A8A2
4639+ A8A2 CD 35 89         CALL    VDP_DrawSprite
4640+ A8A5 D1               POP     DE
4641+ A8A6 16 02            LD      D, 2
4642+ A8A8 1E 04            LD      E, 4
4643+ A8AA D5               PUSH    DE
4644+ A8AB 3E D6            LD      A, TILE_FIELD
4645+ A8AD
4646+ A8AD CD 35 89         CALL    VDP_DrawSprite
4647+ A8B0 D1               POP     DE
4648+ A8B1 C9               RET
4649+ A8B2              ; ---------------------------------------------------------------------------
4650+ A8B2              ; PutCerimonyBlackPlayersPos3
4651+ A8B2              ; ----------------------------------------------------------------------------
4652+ A8B2              PutCerimonyBlackPlayersPos3:
4653+ A8B2 CD 8B 93         CALL    Utils_PlayBeepTick
4654+ A8B5 16 00            LD      D, 0
4655+ A8B7 1E 01            LD      E, 1
4656+ A8B9 D5               PUSH    DE
4657+ A8BA 3E D6            LD      A,TILE_FIELD
4658+ A8BC
4659+ A8BC CD 35 89         CALL    VDP_DrawSprite
4660+ A8BF D1               POP     DE
4661+ A8C0 16 00            LD      D, 0
4662+ A8C2 1E 03            LD      E, 3
4663+ A8C4 D5               PUSH    DE
4664+ A8C5 3E B0            LD      A,TILE_BLACK_PLAYER
4665+ A8C7
4666+ A8C7 CD 35 89         CALL    VDP_DrawSprite
4667+ A8CA D1               POP     DE
4668+ A8CB
4669+ A8CB 16 02            LD      D, 2
4670+ A8CD 1E 01            LD      E, 1
4671+ A8CF D5               PUSH    DE
4672+ A8D0 3E B0            LD      A, TILE_BLACK_PLAYER
4673+ A8D2
4674+ A8D2 CD 35 89         CALL    VDP_DrawSprite
4675+ A8D5 D1               POP     DE
4676+ A8D6 16 02            LD      D, 2
4677+ A8D8 1E 03            LD      E, 3
4678+ A8DA D5               PUSH    DE
4679+ A8DB 3E D6            LD      A, TILE_FIELD
4680+ A8DD
4681+ A8DD CD 35 89         CALL    VDP_DrawSprite
4682+ A8E0 D1               POP     DE
4683+ A8E1 C9               RET
4684+ A8E2              ; ---------------------------------------------------------------------------
4685+ A8E2              ; PutCerimonyBlackPlayersPos4
4686+ A8E2              ; ----------------------------------------------------------------------------
4687+ A8E2              PutCerimonyBlackPlayersPos4:
4688+ A8E2 CD 8B 93         CALL    Utils_PlayBeepTick
4689+ A8E5 16 00            LD      D, 0
4690+ A8E7 1E 03            LD      E, 3
4691+ A8E9 D5               PUSH    DE
4692+ A8EA 3E D6            LD      A,TILE_FIELD
4693+ A8EC
4694+ A8EC CD 35 89         CALL    VDP_DrawSprite
4695+ A8EF D1               POP     DE
4696+ A8F0 16 00            LD      D, 0
4697+ A8F2 1E 01            LD      E, 1
4698+ A8F4 D5               PUSH    DE
4699+ A8F5 3E B0            LD      A,TILE_BLACK_PLAYER
4700+ A8F7
4701+ A8F7 CD 35 89         CALL    VDP_DrawSprite
4702+ A8FA D1               POP     DE
4703+ A8FB
4704+ A8FB 16 02            LD      D, 2
4705+ A8FD 1E 03            LD      E, 3
4706+ A8FF D5               PUSH    DE
4707+ A900 3E B0            LD      A, TILE_BLACK_PLAYER
4708+ A902
4709+ A902 CD 35 89         CALL    VDP_DrawSprite
4710+ A905 D1               POP     DE
4711+ A906 16 02            LD      D, 2
4712+ A908 1E 01            LD      E, 1
4713+ A90A D5               PUSH    DE
4714+ A90B 3E D6            LD      A, TILE_FIELD
4715+ A90D
4716+ A90D CD 35 89         CALL    VDP_DrawSprite
4717+ A910 D1               POP     DE
4718+ A911 C9               RET
4719+ A912              ; ---------------------------------------------------------------------------
4720+ A912              ; PutCerimonyBlackPlayersPos5
4721+ A912              ; ----------------------------------------------------------------------------
4722+ A912              PutCerimonyBlackPlayersPos5:
4723+ A912 CD 8A 93         CALL    Utils_PlayBeepHighLong
4724+ A915 16 00            LD      D, 0
4725+ A917 1E 02            LD      E, 2
4726+ A919 D5               PUSH    DE
4727+ A91A 3E D6            LD      A,TILE_FIELD
4728+ A91C
4729+ A91C CD 35 89         CALL    VDP_DrawSprite
4730+ A91F D1               POP     DE
4731+ A920 16 00            LD      D, 0
4732+ A922 1E 00            LD      E, 0
4733+ A924 D5               PUSH    DE
4734+ A925 3E B0            LD      A,TILE_BLACK_PLAYER
4735+ A927
4736+ A927 CD 35 89         CALL    VDP_DrawSprite
4737+ A92A D1               POP     DE
4738+ A92B
4739+ A92B 16 02            LD      D, 2
4740+ A92D 1E 04            LD      E, 4
4741+ A92F D5               PUSH    DE
4742+ A930 3E B0            LD      A, TILE_BLACK_PLAYER
4743+ A932
4744+ A932 CD 35 89         CALL    VDP_DrawSprite
4745+ A935 D1               POP     DE
4746+ A936 16 02            LD      D, 2
4747+ A938 1E 02            LD      E, 2
4748+ A93A D5               PUSH    DE
4749+ A93B 3E D6            LD      A, TILE_FIELD
4750+ A93D
4751+ A93D CD 35 89         CALL    VDP_DrawSprite
4752+ A940 D1               POP     DE
4753+ A941 C9               RET
4754+ A942              ; ---------------------------------------------------------------------------
4755+ A942              ; PutCerimonyBlackPlayersPos6
4756+ A942              ; ----------------------------------------------------------------------------
4757+ A942              PutCerimonyBlackPlayersPos6:
4758+ A942 CD 8B 93         CALL    Utils_PlayBeepTick
4759+ A945 16 00            LD      D, 0
4760+ A947 1E 00            LD      E, 0
4761+ A949 D5               PUSH    DE
4762+ A94A 3E D6            LD      A,TILE_FIELD
4763+ A94C
4764+ A94C CD 35 89         CALL    VDP_DrawSprite
4765+ A94F D1               POP     DE
4766+ A950 16 00            LD      D, 0
4767+ A952 1E 02            LD      E, 2
4768+ A954 D5               PUSH    DE
4769+ A955 3E B0            LD      A,TILE_BLACK_PLAYER
4770+ A957
4771+ A957 CD 35 89         CALL    VDP_DrawSprite
4772+ A95A D1               POP     DE
4773+ A95B
4774+ A95B 16 02            LD      D, 2
4775+ A95D 1E 02            LD      E, 2
4776+ A95F D5               PUSH    DE
4777+ A960 3E B0            LD      A, TILE_BLACK_PLAYER
4778+ A962
4779+ A962 CD 35 89         CALL    VDP_DrawSprite
4780+ A965 D1               POP     DE
4781+ A966 16 02            LD      D, 2
4782+ A968 1E 04            LD      E, 4
4783+ A96A D5               PUSH    DE
4784+ A96B 3E D6            LD      A, TILE_FIELD
4785+ A96D
4786+ A96D CD 35 89         CALL    VDP_DrawSprite
4787+ A970 D1               POP     DE
4788+ A971 C9               RET
4789+ A972              ; ---------------------------------------------------------------------------
4790+ A972              ; PutCerimonyBlackPlayersPos7
4791+ A972              ; ----------------------------------------------------------------------------
4792+ A972              PutCerimonyBlackPlayersPos7:
4793+ A972 CD 8B 93         CALL    Utils_PlayBeepTick
4794+ A975 16 00            LD      D, 0
4795+ A977 1E 01            LD      E, 1
4796+ A979 D5               PUSH    DE
4797+ A97A 3E D6            LD      A,TILE_FIELD
4798+ A97C
4799+ A97C CD 35 89         CALL    VDP_DrawSprite
4800+ A97F D1               POP     DE
4801+ A980 16 00            LD      D, 0
4802+ A982 1E 03            LD      E, 3
4803+ A984 D5               PUSH    DE
4804+ A985 3E B0            LD      A,TILE_BLACK_PLAYER
4805+ A987
4806+ A987 CD 35 89         CALL    VDP_DrawSprite
4807+ A98A D1               POP     DE
4808+ A98B
4809+ A98B 16 02            LD      D, 2
4810+ A98D 1E 01            LD      E, 1
4811+ A98F D5               PUSH    DE
4812+ A990 3E B0            LD      A, TILE_BLACK_PLAYER
4813+ A992
4814+ A992 CD 35 89         CALL    VDP_DrawSprite
4815+ A995 D1               POP     DE
4816+ A996 16 02            LD      D, 2
4817+ A998 1E 03            LD      E, 3
4818+ A99A D5               PUSH    DE
4819+ A99B 3E D6            LD      A, TILE_FIELD
4820+ A99D
4821+ A99D CD 35 89         CALL    VDP_DrawSprite
4822+ A9A0 D1               POP     DE
4823+ A9A1 C9               RET
4824+ A9A2              ; ---------------------------------------------------------------------------
4825+ A9A2              ; PutCerimonyBlackPlayersPos8
4826+ A9A2              ; ----------------------------------------------------------------------------
4827+ A9A2              PutCerimonyBlackPlayersPos8:
4828+ A9A2 CD 8B 93         CALL    Utils_PlayBeepTick
4829+ A9A5 16 00            LD      D, 0
4830+ A9A7 1E 03            LD      E, 3
4831+ A9A9 D5               PUSH    DE
4832+ A9AA 3E D6            LD      A,TILE_FIELD
4833+ A9AC
4834+ A9AC CD 35 89         CALL    VDP_DrawSprite
4835+ A9AF D1               POP     DE
4836+ A9B0 16 00            LD      D, 0
4837+ A9B2 1E 01            LD      E, 1
4838+ A9B4 D5               PUSH    DE
4839+ A9B5 3E B0            LD      A,TILE_BLACK_PLAYER
4840+ A9B7
4841+ A9B7 CD 35 89         CALL    VDP_DrawSprite
4842+ A9BA D1               POP     DE
4843+ A9BB
4844+ A9BB 16 02            LD      D, 2
4845+ A9BD 1E 03            LD      E, 3
4846+ A9BF D5               PUSH    DE
4847+ A9C0 3E B0            LD      A, TILE_BLACK_PLAYER
4848+ A9C2
4849+ A9C2 CD 35 89         CALL    VDP_DrawSprite
4850+ A9C5 D1               POP     DE
4851+ A9C6 16 02            LD      D, 2
4852+ A9C8 1E 01            LD      E, 1
4853+ A9CA D5               PUSH    DE
4854+ A9CB 3E D6            LD      A, TILE_FIELD
4855+ A9CD
4856+ A9CD CD 35 89         CALL    VDP_DrawSprite
4857+ A9D0 D1               POP     DE
4858+ A9D1 C9               RET
4859+ A9D2              ; ---------------------------------------------------------------------------
4860+ A9D2              ; PutCerimonyBlackPlayersPos9
4861+ A9D2              ; ----------------------------------------------------------------------------
4862+ A9D2              PutCerimonyBlackPlayersPos9:
4863+ A9D2 CD 8B 93         CALL    Utils_PlayBeepTick
4864+ A9D5 16 00            LD      D, 0
4865+ A9D7 1E 02            LD      E, 2
4866+ A9D9 D5               PUSH    DE
4867+ A9DA 3E D6            LD      A,TILE_FIELD
4868+ A9DC
4869+ A9DC CD 35 89         CALL    VDP_DrawSprite
4870+ A9DF D1               POP     DE
4871+ A9E0 16 00            LD      D, 0
4872+ A9E2 1E 00            LD      E, 0
4873+ A9E4 D5               PUSH    DE
4874+ A9E5 3E B0            LD      A,TILE_BLACK_PLAYER
4875+ A9E7
4876+ A9E7 CD 35 89         CALL    VDP_DrawSprite
4877+ A9EA D1               POP     DE
4878+ A9EB
4879+ A9EB 16 02            LD      D, 2
4880+ A9ED 1E 04            LD      E, 4
4881+ A9EF D5               PUSH    DE
4882+ A9F0 3E B0            LD      A, TILE_BLACK_PLAYER
4883+ A9F2
4884+ A9F2 CD 35 89         CALL    VDP_DrawSprite
4885+ A9F5 D1               POP     DE
4886+ A9F6 16 02            LD      D, 2
4887+ A9F8 1E 02            LD      E, 2
4888+ A9FA D5               PUSH    DE
4889+ A9FB 3E D6            LD      A, TILE_FIELD
4890+ A9FD
4891+ A9FD CD 35 89         CALL    VDP_DrawSprite
4892+ AA00 D1               POP     DE
4893+ AA01 C9               RET
4894+ AA02              ; ---------------------------------------------------------------------------
4895+ AA02              ; Game_PlayBeep
4896+ AA02              ; ----------------------------------------------------------------------------
4897+ AA02              Game_PlayBeep:
4898+ AA02 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
4899+ AA05 FE 01            CP      YES
4900+ AA07 C0               RET     NZ
4901+ AA08 CD 7A 93         CALL    Utils_PlayBeep
4902+ AA0B C9               RET
4903+ AA0C              ; ---------------------------------------------------------------------------
4904+ AA0C              ; Game_PlayBeepGoalCorner
4905+ AA0C              ; ----------------------------------------------------------------------------
4906+ AA0C              Game_PlayBeepGoalCorner:
4907+ AA0C 3A 2C B2         LD      A, (Var_Game_MatchInProgress)
4908+ AA0F FE 01            CP      YES
4909+ AA11 C0               RET     NZ
4910+ AA12 CD 82 93         CALL    Utils_PlayBeepGoalCorner
4911+ AA15 C9               RET
4912+ AA16
4913+ AA16              ; ---------------------------------------------------------------------------
4914+ AA16              ; CerimonyRedrawHalfFieldLine
4915+ AA16              ; ----------------------------------------------------------------------------
4916+ AA16              CerimonyRedrawHalfFieldLine:
4917+ AA16 D5               PUSH DE
4918+ AA17 3A 07 B2         LD   A, (Var_Game_ActiveFieldSide)
4919+ AA1A FE 01            CP   FIELD_NORTH_SIDE
4920+ AA1C 28 04            JR   Z, .North
4921+ AA1E 16 07            LD   D, 7
4922+ AA20 18 02            JR   .Continue
4923+ AA22              .North:
4924+ AA22 16 11            LD   D, 17
4925+ AA24              .Continue:
4926+ AA24 1E 01            LD   E, 1
4927+ AA26              .Loop:
4928+ AA26 D5               PUSH DE
4929+ AA27 3E D2            LD   A, TILE_FIELD_LINE_HORIZONTAL
4930+ AA29 CD 9F 88         CALL VDP_PrintRamChar
4931+ AA2C D1               POP  DE
4932+ AA2D 1C               INC  E
4933+ AA2E 7B               LD   A, E
4934+ AA2F FE 15            CP   21
4935+ AA31 28 02            JR   Z, .Done
4936+ AA33 18 F1            JR   .Loop
4937+ AA35              .Done:
4938+ AA35 D1               POP DE
4939+ AA36 C9               RET
4940+ AA37              ; ---------------------------------------------------------------------------
4941+ AA37              ; Game_GoalCelebration_DrawFrame
4942+ AA37              ;
4943+ AA37              ; INPUT:
4944+ AA37              ;   A = tick (8..1)   ; 8 = first move, 1 = last move
4945+ AA37
4946+ AA37              ;
4947+ AA37              ; MODIFIES: AF,BC,DE,HL
4948+ AA37              ; ---------------------------------------------------------------------------
4949+ AA37              Game_GoalCelebration_DrawFrame:
4950+ AA37 E5               PUSH    HL
4951+ AA38 D5               PUSH    DE
4952+ AA39 C5               PUSH    BC
4953+ AA3A F5               PUSH    AF
4954+ AA3B 3A 07 B2         LD      A, (Var_Game_ActiveFieldSide)
4955+ AA3E FE 01            CP      FIELD_NORTH_SIDE
4956+ AA40 20 51            JR      NZ, .BlackTeam
4957+ AA42              ; ===== WHITE TEAM CELEBRATION =====
4958+ AA42              .WhiteTeam:
4959+ AA42 F1               POP     AF
4960+ AA43 FE 08            CP      8
4961+ AA45 20 06            JR      NZ, .White7
4962+ AA47 CD 92 A4         CALL    PutCerimonyWhitePlayersPos1
4963+ AA4A C3 DF AA         JP      .Done
4964+ AA4D              .White7:
4965+ AA4D FE 07            CP      7
4966+ AA4F 20 06            JR      NZ, .White6
4967+ AA51 CD C2 A4         CALL    PutCerimonyWhitePlayersPos2
4968+ AA54 C3 DF AA         JP      .Done
4969+ AA57              .White6:
4970+ AA57 FE 06            CP      6
4971+ AA59 20 06            JR      NZ, .White5
4972+ AA5B CD 34 A5         CALL    PutCerimonyWhitePlayersPos3
4973+ AA5E C3 DF AA         JP      .Done
4974+ AA61              .White5:
4975+ AA61 FE 05            CP      5
4976+ AA63 20 05            JR      NZ, .White4
4977+ AA65 CD A6 A5         CALL    PutCerimonyWhitePlayersPos4
4978+ AA68 18 75            JR      .Done
4979+ AA6A              .White4:
4980+ AA6A FE 04            CP      4
4981+ AA6C 20 05            JR      NZ, .White3
4982+ AA6E CD 18 A6         CALL    PutCerimonyWhitePlayersPos5
4983+ AA71 18 6C            JR      .Done
4984+ AA73              .White3:
4985+ AA73 FE 03            CP      3
4986+ AA75 20 05            JR      NZ, .White2
4987+ AA77 CD 8A A6         CALL    PutCerimonyWhitePlayersPos6
4988+ AA7A 18 63            JR      .Done
4989+ AA7C              .White2:
4990+ AA7C FE 02            CP      2
4991+ AA7E 20 05            JR      NZ, .White1
4992+ AA80 CD FC A6         CALL    PutCerimonyWhitePlayersPos7
4993+ AA83 18 5A            JR      .Done
4994+ AA85              .White1:
4995+ AA85 FE 01            CP      1
4996+ AA87 20 05            JR      NZ, .White0
4997+ AA89 CD 6E A7         CALL    PutCerimonyWhitePlayersPos8
4998+ AA8C 18 51            JR      .Done
4999+ AA8E              .White0:
5000+ AA8E CD E0 A7         CALL    PutCerimonyWhitePlayersPos9
5001+ AA91 18 4C            JR      .Done
5002+ AA93              ; ===== BLACK TEAM CELEBRATION =====
5003+ AA93              .BlackTeam:
5004+ AA93 F1               POP     AF
5005+ AA94 FE 08            CP      8
5006+ AA96 20 05            JR      NZ, .Black7
5007+ AA98 CD 52 A8         CALL    PutCerimonyBlackPlayersPos1
5008+ AA9B 18 42            JR      .Done
5009+ AA9D              .Black7:
5010+ AA9D FE 07            CP      7
5011+ AA9F 20 05            JR      NZ, .Black6
5012+ AAA1 CD 82 A8         CALL    PutCerimonyBlackPlayersPos2
5013+ AAA4 18 39            JR      .Done
5014+ AAA6              .Black6:
5015+ AAA6 FE 06            CP      6
5016+ AAA8 20 05            JR      NZ, .Black5
5017+ AAAA CD B2 A8         CALL    PutCerimonyBlackPlayersPos3
5018+ AAAD 18 30            JR      .Done
5019+ AAAF              .Black5:
5020+ AAAF FE 05            CP      5
5021+ AAB1 20 05            JR      NZ, .Black4
5022+ AAB3 CD E2 A8         CALL    PutCerimonyBlackPlayersPos4
5023+ AAB6 18 27            JR      .Done
5024+ AAB8              .Black4:
5025+ AAB8 FE 04            CP      4
5026+ AABA 20 05            JR      NZ, .Black3
5027+ AABC CD 12 A9         CALL    PutCerimonyBlackPlayersPos5
5028+ AABF 18 1E            JR      .Done
5029+ AAC1              .Black3:
5030+ AAC1 FE 03            CP      3
5031+ AAC3 20 05            JR      NZ, .Black2
5032+ AAC5 CD 42 A9         CALL    PutCerimonyBlackPlayersPos6
5033+ AAC8 18 15            JR      .Done
5034+ AACA              .Black2:
5035+ AACA FE 02            CP      2
5036+ AACC 20 05            JR      NZ, .Black1
5037+ AACE CD 72 A9         CALL    PutCerimonyBlackPlayersPos7
5038+ AAD1 18 0C            JR      .Done
5039+ AAD3              .Black1:
5040+ AAD3 FE 01            CP      1
5041+ AAD5 20 05            JR      NZ, .Black0
5042+ AAD7 CD A2 A9         CALL    PutCerimonyBlackPlayersPos8
5043+ AADA 18 03            JR      .Done
5044+ AADC              .Black0:
5045+ AADC CD D2 A9         CALL    PutCerimonyBlackPlayersPos9
5046+ AADF
5047+ AADF              .Done:
5048+ AADF C1               POP     BC
5049+ AAE0 D1               POP     DE
5050+ AAE1 E1               POP     HL
5051+ AAE2 C9               RET
5052+ AAE3              ; ----- CONSTANTS ------
5053+ AAE3
# file closed: ./inc/game.asm
  19  AAE3
  20  AAE3
  21  AAE3              Begin:
  22  AAE3
  23  AAE3 CD 9E 93         CALL    Game_InitVariables              ; Initialize the screen
  24  AAE6
  25  AAE6 CD 16 89         CALL    VDP_ClearScreen
  26  AAE9
  27  AAE9 CD 09 89         CALL    VDP_LoadTiles                   ; Load tiles into RAM
  28  AAEC
  29  AAEC CD 93 91         CALL    Menu_Show
  30  AAEF
  31  AAEF
  32  AAEF              MainLoop:
  33  AAEF FB               EI
  34  AAF0 76               HALT
  35  AAF1 F3               DI
  36  AAF2 CD 60 81         CALL    VBlankISR
  37  AAF5 18 F8            jr      MainLoop
  38  AAF7
  39  AAF7
  40  AAF7
  41  AAF7
  42  AAF7
  43  AAF7
  44  AAF7
  45  AAF7
  46  AAF7
  47  AAF7
  48  AAF7              ; VARIABLES RAM AREA
  49  AAF7                  INCLUDE "tiles.asm"             ; Include tiles definitions
# file opened: ./inc/tiles.asm
   1+ AAF7              ; ===================================================================
   2+ AAF7              ; GS11-Soccer - 2025 Fausto Pracek
   3+ AAF7              ; ===================================================================
   4+ AAF7
   5+ AAF7              ; *** TILES.ASM ***
   6+ AAF7
   7+ AAF7
   8+ AAF7              TILES:
   9+ AAF7              ; Char " "
  10+ AAF7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  10+ AAFB 00 00 00 00
  11+ AAFF              ; Char "!"
  12+ AAFF 00 30 30 30      DB 0x00,0x30,0x30,0x30,0x30,0x00,0x30,0x00
  12+ AB03 30 00 30 00
  13+ AB07              ; Char """
  14+ AB07 00 6C 6C 48      DB 0x00,0x6C,0x6C,0x48,0x00,0x00,0x00,0x00
  14+ AB0B 00 00 00 00
  15+ AB0F              ; Char "#"
  16+ AB0F 00 2C 7E 2C      DB 0x00,0x2C,0x7E,0x2C,0x2C,0x7E,0x2C,0x00
  16+ AB13 2C 7E 2C 00
  17+ AB17              ; Char "$"
  18+ AB17 00 18 3E 58      DB 0x00,0x18,0x3E,0x58,0x3C,0x1A,0x7C,0x00
  18+ AB1B 3C 1A 7C 00
  19+ AB1F              ; Char "%"
  20+ AB1F 00 62 64 08      DB 0x00,0x62,0x64,0x08,0x10,0x26,0x46,0x00
  20+ AB23 10 26 46 00
  21+ AB27              ; Char "&"
  22+ AB27 00 38 6C 38      DB 0x00,0x38,0x6C,0x38,0x6A,0x64,0x3A,0x00
  22+ AB2B 6A 64 3A 00
  23+ AB2F              ; Char "'"
  24+ AB2F 00 30 30 20      DB 0x00,0x30,0x30,0x20,0x00,0x00,0x00,0x00
  24+ AB33 00 00 00 00
  25+ AB37              ; Char "("
  26+ AB37 00 0C 18 18      DB 0x00,0x0C,0x18,0x18,0x18,0x18,0x0C,0x00
  26+ AB3B 18 18 0C 00
  27+ AB3F              ; Char ")"
  28+ AB3F 00 30 18 18      DB 0x00,0x30,0x18,0x18,0x18,0x18,0x30,0x00
  28+ AB43 18 18 30 00
  29+ AB47              ; Char "*"
  30+ AB47 00 00 00 66      DB 0x00,0x00,0x00,0x66,0x18,0x66,0x00,0x00
  30+ AB4B 18 66 00 00
  31+ AB4F              ; Char "+"
  32+ AB4F 00 00 18 18      DB 0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00
  32+ AB53 7E 18 18 00
  33+ AB57              ; Char ","
  34+ AB57 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x10
  34+ AB5B 00 30 30 10
  35+ AB5F              ; Char "-"
  36+ AB5F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x3C,0x00,0x00,0x00
  36+ AB63 3C 00 00 00
  37+ AB67              ; Char "."
  38+ AB67 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00
  38+ AB6B 00 30 30 00
  39+ AB6F              ; Char "/"
  40+ AB6F 00 02 06 0C      DB 0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0x00
  40+ AB73 18 30 60 00
  41+ AB77              ; Char "0"
  42+ AB77 00 3C 66 6E      DB 0x00,0x3C,0x66,0x6E,0x76,0x66,0x3C,0x00
  42+ AB7B 76 66 3C 00
  43+ AB7F              ; Char "1"
  44+ AB7F 00 18 38 58      DB 0x00,0x18,0x38,0x58,0x18,0x18,0x7E,0x00
  44+ AB83 18 18 7E 00
  45+ AB87              ; Char "2"
  46+ AB87 00 3C 46 1C      DB 0x00,0x3C,0x46,0x1C,0x30,0x60,0x7E,0x00
  46+ AB8B 30 60 7E 00
  47+ AB8F              ; Char "3"
  48+ AB8F 00 3C 46 1C      DB 0x00,0x3C,0x46,0x1C,0x06,0x46,0x3C,0x00
  48+ AB93 06 46 3C 00
  49+ AB97              ; Char "4"
  50+ AB97 00 30 30 60      DB 0x00,0x30,0x30,0x60,0x7E,0x0C,0x0C,0x00
  50+ AB9B 7E 0C 0C 00
  51+ AB9F              ; Char "5"
  52+ AB9F 00 7E 60 7E      DB 0x00,0x7E,0x60,0x7E,0x06,0x46,0x3C,0x00
  52+ ABA3 06 46 3C 00
  53+ ABA7              ; Char "6"
  54+ ABA7 00 3C 60 7C      DB 0x00,0x3C,0x60,0x7C,0x66,0x66,0x3C,0x00
  54+ ABAB 66 66 3C 00
  55+ ABAF              ; Char "7"
  56+ ABAF 00 7E 06 0C      DB 0x00,0x7E,0x06,0x0C,0x18,0x18,0x18,0x00
  56+ ABB3 18 18 18 00
  57+ ABB7              ; Char "8"
  58+ ABB7 00 3C 66 3C      DB 0x00,0x3C,0x66,0x3C,0x66,0x66,0x3C,0x00
  58+ ABBB 66 66 3C 00
  59+ ABBF              ; Char "9"
  60+ ABBF 00 3C 66 3E      DB 0x00,0x3C,0x66,0x3E,0x06,0x66,0x3C,0x00
  60+ ABC3 06 66 3C 00
  61+ ABC7              ; Char ":"
  62+ ABC7 00 00 30 30      DB 0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x00
  62+ ABCB 00 30 30 00
  63+ ABCF              ; Char ";"
  64+ ABCF 00 00 30 30      DB 0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x10
  64+ ABD3 00 30 30 10
  65+ ABD7              ; Char "<"
  66+ ABD7 00 0C 18 30      DB 0x00,0x0C,0x18,0x30,0x30,0x18,0x0C,0x00
  66+ ABDB 30 18 0C 00
  67+ ABDF              ; Char "="
  68+ ABDF 00 00 00 7E      DB 0x00,0x00,0x00,0x7E,0x00,0x7E,0x00,0x00
  68+ ABE3 00 7E 00 00
  69+ ABE7              ; Char ">"
  70+ ABE7 00 30 18 0C      DB 0x00,0x30,0x18,0x0C,0x0C,0x18,0x30,0x00
  70+ ABEB 0C 18 30 00
  71+ ABEF              ; Char "?"
  72+ ABEF 00 3C 66 0E      DB 0x00,0x3C,0x66,0x0E,0x18,0x00,0x18,0x00
  72+ ABF3 18 00 18 00
  73+ ABF7              ; Char "@"
  74+ ABF7 00 3C 66 06      DB 0x00,0x3C,0x66,0x06,0x36,0x56,0x3C,0x00
  74+ ABFB 36 56 3C 00
  75+ ABFF              ; Char "A"
  76+ ABFF 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00
  76+ AC03 7E 66 66 00
  77+ AC07              ; Char "B"
  78+ AC07 00 7C 66 7C      DB 0x00,0x7C,0x66,0x7C,0x66,0x66,0x7C,0x00
  78+ AC0B 66 66 7C 00
  79+ AC0F              ; Char "C"
  80+ AC0F 00 3C 66 60      DB 0x00,0x3C,0x66,0x60,0x60,0x66,0x3C,0x00
  80+ AC13 60 66 3C 00
  81+ AC17              ; Char "D"
  82+ AC17 00 7C 66 66      DB 0x00,0x7C,0x66,0x66,0x66,0x66,0x7C,0x00
  82+ AC1B 66 66 7C 00
  83+ AC1F              ; Char "E"
  84+ AC1F 00 7E 60 7C      DB 0x00,0x7E,0x60,0x7C,0x60,0x60,0x7E,0x00
  84+ AC23 60 60 7E 00
  85+ AC27              ; Char "F"
  86+ AC27 00 7E 60 7C      DB 0x00,0x7E,0x60,0x7C,0x60,0x60,0x60,0x00
  86+ AC2B 60 60 60 00
  87+ AC2F              ; Char "G"
  88+ AC2F 00 3C 66 60      DB 0x00,0x3C,0x66,0x60,0x6E,0x66,0x3C,0x00
  88+ AC33 6E 66 3C 00
  89+ AC37              ; Char "H"
  90+ AC37 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x7E,0x66,0x66,0x00
  90+ AC3B 7E 66 66 00
  91+ AC3F              ; Char "I"
  92+ AC3F 00 3C 18 18      DB 0x00,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00
  92+ AC43 18 18 3C 00
  93+ AC47              ; Char "J"
  94+ AC47 00 7E 18 18      DB 0x00,0x7E,0x18,0x18,0x18,0x58,0x30,0x00
  94+ AC4B 18 58 30 00
  95+ AC4F              ; Char "K"
  96+ AC4F 00 66 6C 78      DB 0x00,0x66,0x6C,0x78,0x78,0x6C,0x66,0x00
  96+ AC53 78 6C 66 00
  97+ AC57              ; Char "L"
  98+ AC57 00 60 60 60      DB 0x00,0x60,0x60,0x60,0x60,0x60,0x7E,0x00
  98+ AC5B 60 60 7E 00
  99+ AC5F              ; Char "M"
 100+ AC5F 00 42 66 7E      DB 0x00,0x42,0x66,0x7E,0x66,0x66,0x66,0x00
 100+ AC63 66 66 66 00
 101+ AC67              ; Char "N"
 102+ AC67 00 46 66 76      DB 0x00,0x46,0x66,0x76,0x6E,0x66,0x62,0x00
 102+ AC6B 6E 66 62 00
 103+ AC6F              ; Char "O"
 104+ AC6F 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x66,0x66,0x3C,0x00
 104+ AC73 66 66 3C 00
 105+ AC77              ; Char "P"
 106+ AC77 00 7C 66 66      DB 0x00,0x7C,0x66,0x66,0x7C,0x60,0x60,0x00
 106+ AC7B 7C 60 60 00
 107+ AC7F              ; Char "Q"
 108+ AC7F 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x66,0x68,0x36,0x00
 108+ AC83 66 68 36 00
 109+ AC87              ; Char "R"
 110+ AC87 00 7C 66 7C      DB 0x00,0x7C,0x66,0x7C,0x66,0x66,0x66,0x00
 110+ AC8B 66 66 66 00
 111+ AC8F              ; Char "S"
 112+ AC8F 00 3C 60 3C      DB 0x00,0x3C,0x60,0x3C,0x06,0x46,0x3C,0x00
 112+ AC93 06 46 3C 00
 113+ AC97              ; Char "T"
 114+ AC97 00 7E 18 18      DB 0x00,0x7E,0x18,0x18,0x18,0x18,0x18,0x00
 114+ AC9B 18 18 18 00
 115+ AC9F              ; Char "U"
 116+ AC9F 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x00
 116+ ACA3 66 66 3C 00
 117+ ACA7              ; Char "V"
 118+ ACA7 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x3C,0x3C,0x18,0x00
 118+ ACAB 3C 3C 18 00
 119+ ACAF              ; Char "W"
 120+ ACAF 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x7E,0x66,0x42,0x00
 120+ ACB3 7E 66 42 00
 121+ ACB7              ; Char "X"
 122+ ACB7 00 66 76 1C      DB 0x00,0x66,0x76,0x1C,0x38,0x6E,0x66,0x00
 122+ ACBB 38 6E 66 00
 123+ ACBF              ; Char "Y"
 124+ ACBF 00 66 66 3C      DB 0x00,0x66,0x66,0x3C,0x18,0x18,0x18,0x00
 124+ ACC3 18 18 18 00
 125+ ACC7              ; Char "Z"
 126+ ACC7 00 7E 06 1C      DB 0x00,0x7E,0x06,0x1C,0x30,0x60,0x7E,0x00
 126+ ACCB 30 60 7E 00
 127+ ACCF              ; Char "["
 128+ ACCF 00 38 30 30      DB 0x00,0x38,0x30,0x30,0x30,0x30,0x38,0x00
 128+ ACD3 30 30 38 00
 129+ ACD7              ; Char "\"
 130+ ACD7 00 40 60 30      DB 0x00,0x40,0x60,0x30,0x18,0x0C,0x06,0x00
 130+ ACDB 18 0C 06 00
 131+ ACDF              ; Char "]"
 132+ ACDF 00 38 18 18      DB 0x00,0x38,0x18,0x18,0x18,0x18,0x38,0x00
 132+ ACE3 18 18 38 00
 133+ ACE7              ; Char "^"
 134+ ACE7 00 18 3C 66      DB 0x00,0x18,0x3C,0x66,0x00,0x00,0x00,0x00
 134+ ACEB 00 00 00 00
 135+ ACEF              ; Char "_" *** CHANGED TO BOTTOM ARROW ***
 136+ ACEF 00 10 10 10      DB 0x00,0x10,0x10,0x10,0x54,0x38,0x10,0x00
 136+ ACF3 54 38 10 00
 137+ ACF7              ; Ball (bottom)
 138+ ACF7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 138+ ACFB 00 00 00 00
 139+ ACFF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 139+ AD03 00 00 00 00
 140+ AD07 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 140+ AD0B 00 00 00 00
 141+ AD0F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 141+ AD13 00 00 00 00
 142+ AD17 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 142+ AD1B 00 00 00 00
 143+ AD1F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 143+ AD23 00 00 00 00
 144+ AD27 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 144+ AD2B 00 00 00 00
 145+ AD2F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 145+ AD33 00 00 00 00
 146+ AD37 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 146+ AD3B 00 00 00 00
 147+ AD3F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 147+ AD43 00 00 00 00
 148+ AD47 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 148+ AD4B 00 00 00 00
 149+ AD4F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 149+ AD53 00 00 00 00
 150+ AD57 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 150+ AD5B 00 00 00 00
 151+ AD5F 00 03 07 0F      DB 0x00,0x03,0x07,0x0F,0x0F,0x0F,0x07,0x03
 151+ AD63 0F 0F 07 03
 152+ AD67 00 C0 E0 F0      DB 0x00,0xC0,0xE0,0xF0,0xF0,0xF0,0xE0,0xC0
 152+ AD6B F0 F0 E0 C0
 153+ AD6F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 153+ AD73 00 00 00 00
 154+ AD77              ; White player near half field
 155+ AD77 00 00 0D 1F      DB 0x00,0x00,0x0D,0x1F,0x1F,0x0F,0x06,0x00
 155+ AD7B 1F 0F 06 00
 156+ AD7F F0 E0 E0 E0      DB 0xF0,0xE0,0xE0,0xE0,0xE0,0x60,0x60,0x60
 156+ AD83 E0 60 60 60
 157+ AD87 F8 7C 7E 7F      DB 0xF8,0x7C,0x7E,0x7F,0x6F,0x67,0x63,0x60
 157+ AD8B 6F 67 63 60
 158+ AD8F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x00
 158+ AD93 80 80 80 00
 159+ AD97 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 159+ AD9B 00 00 00 00
 160+ AD9F 7F 7F 00 7F      DB 0x7F,0x7F,0x00,0x7F,0x7F,0x79,0xF9,0xF1
 160+ ADA3 7F 79 F9 F1
 161+ ADA7 E0 E0 00 E0      DB 0xE0,0xE0,0x00,0xE0,0xE0,0xE0,0xE0,0xC0
 161+ ADAB E0 E0 E0 C0
 162+ ADAF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 162+ ADB3 00 00 00 00
 163+ ADB7 00 01 01 03      DB 0x00,0x01,0x01,0x03,0x03,0x03,0x00,0x00
 163+ ADBB 03 03 00 00
 164+ ADBF F0 E0 E0 E0      DB 0xF0,0xE0,0xE0,0xE0,0xC0,0xC0,0x00,0x00
 164+ ADC3 C0 C0 00 00
 165+ ADC7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 165+ ADCB 00 00 00 00
 166+ ADCF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 166+ ADD3 00 00 00 00
 167+ ADD7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 167+ ADDB 00 00 00 00
 168+ ADDF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 168+ ADE3 00 00 00 00
 169+ ADE7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 169+ ADEB 00 00 00 00
 170+ ADEF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 170+ ADF3 00 00 00 00
 171+ ADF7
 172+ ADF7              ; White goalkeeper
 173+ ADF7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 173+ ADFB 00 00 00 00
 174+ ADFF 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 174+ AE03 07 1F 37 FB
 175+ AE07 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 175+ AE0B E0 F8 EC DF
 176+ AE0F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 176+ AE13 00 00 00 00
 177+ AE17 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x00
 177+ AE1B 03 03 03 00
 178+ AE1F F8 F0 F0 B0      DB 0xF8,0xF0,0xF0,0xB0,0x90,0x90,0x9F,0x1F
 178+ AE23 90 90 9F 1F
 179+ AE27 1F 0F 0F 0D      DB 0x1F,0x0F,0x0F,0x0D,0x09,0x09,0xF9,0xF8
 179+ AE2B 09 09 F9 F8
 180+ AE2F 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,0x00
 180+ AE33 C0 C0 C0 00
 181+ AE37 03 00 00 00      DB 0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 181+ AE3B 00 00 00 00
 182+ AE3F 80 1F 1F 1F      DB 0x80,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 182+ AE43 1E 1C 1C 1C
 183+ AE47 01 F8 F8 F8      DB 0x01,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 183+ AE4B 78 38 38 38
 184+ AE4F C0 00 00 00      DB 0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 184+ AE53 00 00 00 00
 185+ AE57 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 185+ AE5B 00 00 00 00
 186+ AE5F 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 186+ AE63 1C 00 00 00
 187+ AE67 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 187+ AE6B 38 00 00 00
 188+ AE6F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 188+ AE73 00 00 00 00
 189+ AE77              ; White goalkeeper with ball
 190+ AE77 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 190+ AE7B 00 00 00 00
 191+ AE7F 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 191+ AE83 07 1F 37 FB
 192+ AE87 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 192+ AE8B E0 F8 EC DF
 193+ AE8F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 193+ AE93 00 00 00 00
 194+ AE97 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x01,0x00,0x00,0x00
 194+ AE9B 01 00 00 00
 195+ AE9F F8 F0 F0 F0      DB 0xF8,0xF0,0xF0,0xF0,0xF0,0x10,0x1F,0x1F
 195+ AEA3 F0 10 1F 1F
 196+ AEA7 1F 0F 0F 0F      DB 0x1F,0x0F,0x0F,0x0F,0x0F,0x08,0xF8,0xF8
 196+ AEAB 0F 08 F8 F8
 197+ AEAF 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00
 197+ AEB3 80 00 00 00
 198+ AEB7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 198+ AEBB 00 00 00 00
 199+ AEBF 00 1F 1F 1F      DB 0x00,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 199+ AEC3 1E 1C 1C 1C
 200+ AEC7 00 F8 F8 F8      DB 0x00,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 200+ AECB 78 38 38 38
 201+ AECF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 201+ AED3 00 00 00 00
 202+ AED7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 202+ AEDB 00 00 00 00
 203+ AEDF 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 203+ AEE3 1C 00 00 00
 204+ AEE7 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 204+ AEEB 38 00 00 00
 205+ AEEF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 205+ AEF3 00 00 00 00
 206+ AEF7              ; Black goalkeeper
 207+ AEF7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 207+ AEFB 00 00 00 00
 208+ AEFF 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 208+ AF03 07 1F 37 FB
 209+ AF07 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 209+ AF0B E0 F8 EC DF
 210+ AF0F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 210+ AF13 00 00 00 00
 211+ AF17 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x00
 211+ AF1B 03 03 03 00
 212+ AF1F FC FF FF BF      DB 0xFC,0xFF,0xFF,0xBF,0x9F,0x9F,0x9F,0x1F
 212+ AF23 9F 9F 9F 1F
 213+ AF27 3F FF FF FD      DB 0x3F,0xFF,0xFF,0xFD,0xF9,0xF9,0xF9,0xF8
 213+ AF2B F9 F9 F9 F8
 214+ AF2F 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,0x00
 214+ AF33 C0 C0 C0 00
 215+ AF37 03 00 00 00      DB 0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 215+ AF3B 00 00 00 00
 216+ AF3F 80 1F 1F 1F      DB 0x80,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 216+ AF43 1E 1C 1C 1C
 217+ AF47 01 F8 F8 F8      DB 0x01,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 217+ AF4B 78 38 38 38
 218+ AF4F C0 00 00 00      DB 0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 218+ AF53 00 00 00 00
 219+ AF57 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 219+ AF5B 00 00 00 00
 220+ AF5F 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 220+ AF63 1C 00 00 00
 221+ AF67 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 221+ AF6B 38 00 00 00
 222+ AF6F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 222+ AF73 00 00 00 00
 223+ AF77              ; Black goalkeeper with ball
 224+ AF77 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 224+ AF7B 00 00 00 00
 225+ AF7F 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x3C,0xF9
 225+ AF83 07 1F 3C F9
 226+ AF87 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0x3C,0x9F
 226+ AF8B E0 F8 3C 9F
 227+ AF8F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 227+ AF93 00 00 00 00
 228+ AF97 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x01,0x00,0x00,0x00
 228+ AF9B 01 00 00 00
 229+ AF9F FB FF FF FB      DB 0xFB,0xFF,0xFF,0xFB,0xF9,0x1C,0x1F,0x1F
 229+ AFA3 F9 1C 1F 1F
 230+ AFA7 DF FF FF DF      DB 0xDF,0xFF,0xFF,0xDF,0x9F,0x38,0xF8,0xF8
 230+ AFAB 9F 38 F8 F8
 231+ AFAF 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00
 231+ AFB3 80 00 00 00
 232+ AFB7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 232+ AFBB 00 00 00 00
 233+ AFBF 00 1F 1F 1F      DB 0x00,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 233+ AFC3 1E 1C 1C 1C
 234+ AFC7 00 F8 F8 F8      DB 0x00,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 234+ AFCB 78 38 38 38
 235+ AFCF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 235+ AFD3 00 00 00 00
 236+ AFD7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 236+ AFDB 00 00 00 00
 237+ AFDF 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 237+ AFE3 1C 00 00 00
 238+ AFE7 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 238+ AFEB 38 00 00 00
 239+ AFEF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 239+ AFF3 00 00 00 00
 240+ AFF7              ; White player
 241+ AFF7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 241+ AFFB 00 00 00 00
 242+ AFFF 00 07 0F 0F      DB 0x00,0x07,0x0F,0x0F,0x0F,0x3F,0x7F,0xF0
 242+ B003 0F 3F 7F F0
 243+ B007 00 80 C0 C0      DB 0x00,0x80,0xC0,0xC0,0xC0,0xE0,0xF0,0xF8
 243+ B00B C0 E0 F0 F8
 244+ B00F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 244+ B013 00 00 00 00
 245+ B017 00 0D 1F 1F      DB 0x00,0x0D,0x1F,0x1F,0x0F,0x06,0x00,0x00
 245+ B01B 0F 06 00 00
 246+ B01F E0 E0 E0 E0      DB 0xE0,0xE0,0xE0,0xE0,0x60,0x60,0x60,0x7F
 246+ B023 60 60 60 7F
 247+ B027 7C 7E 7F 6F      DB 0x7C,0x7E,0x7F,0x6F,0x67,0x63,0x60,0xE0
 247+ B02B 67 63 60 E0
 248+ B02F 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00
 248+ B033 80 80 00 00
 249+ B037 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 249+ B03B 00 00 00 00
 250+ B03F 7F 00 7F 7F      DB 0x7F,0x00,0x7F,0x7F,0x79,0xF9,0xF1,0xF0
 250+ B043 79 F9 F1 F0
 251+ B047 E0 00 E0 E0      DB 0xE0,0x00,0xE0,0xE0,0xE0,0xE0,0xC0,0x00
 251+ B04B E0 E0 C0 00
 252+ B04F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 252+ B053 00 00 00 00
 253+ B057 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x00,0x00,0x00
 253+ B05B 03 00 00 00
 254+ B05F E0 E0 E0 C0      DB 0xE0,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00
 254+ B063 C0 00 00 00
 255+ B067 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 255+ B06B 00 00 00 00
 256+ B06F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 256+ B073 00 00 00 00
 257+ B077              ; Black player
 258+ B077 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 258+ B07B 00 00 00 00
 259+ B07F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01
 259+ B083 00 00 00 01
 260+ B087 00 00 0F 1F      DB 0x00,0x00,0x0F,0x1F,0x1F,0x1F,0xDF,0xEE
 260+ B08B 1F 1F DF EE
 261+ B08F 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x60,0xF0
 261+ B093 80 80 60 F0
 262+ B097 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 262+ B09B 00 00 00 00
 263+ B09F 03 0F 1F 3E      DB 0x03,0x0F,0x1F,0x3E,0x3C,0x38,0x00,0x00
 263+ B0A3 3C 38 00 00
 264+ B0A7 F1 FF FF FF      DB 0xF1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
 264+ B0AB FF FF FF FF
 265+ B0AF F8 FC FE DE      DB 0xF8,0xFC,0xFE,0xDE,0xCE,0xC6,0xC0,0xC0
 265+ B0B3 CE C6 C0 C0
 266+ B0B7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 266+ B0BB 00 00 00 00
 267+ B0BF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 267+ B0C3 00 00 00 00
 268+ B0C7 FF FF 00 FF      DB 0xFF,0xFF,0x00,0xFF,0xFF,0xF3,0xF1,0x71
 268+ B0CB FF F3 F1 71
 269+ B0CF C0 C0 00 C0      DB 0xC0,0xC0,0x00,0xC0,0xC0,0xC0,0xE0,0xE0
 269+ B0D3 C0 C0 E0 E0
 270+ B0D7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 270+ B0DB 00 00 00 00
 271+ B0DF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 271+ B0E3 00 00 00 00
 272+ B0E7 01 01 00 00      DB 0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00
 272+ B0EB 00 00 00 00
 273+ B0EF E0 E0 F0 F0      DB 0xE0,0xE0,0xF0,0xF0,0xF8,0x78,0x78,0x18
 273+ B0F3 F8 78 78 18
 274+ B0F7              ; Black player with ball
 275+ B0F7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 275+ B0FB 00 00 00 00
 276+ B0FF 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01
 276+ B103 00 00 00 01
 277+ B107 00 00 0F 1F      DB 0x00,0x00,0x0F,0x1F,0x1F,0x1F,0xDF,0xEE
 277+ B10B 1F 1F DF EE
 278+ B10F 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x60,0xF0
 278+ B113 80 80 60 F0
 279+ B117 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 279+ B11B 00 00 00 00
 280+ B11F 03 0F 1F 3E      DB 0x03,0x0F,0x1F,0x3E,0x3C,0x38,0x00,0x00
 280+ B123 3C 38 00 00
 281+ B127 F1 FF FF FF      DB 0xF1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
 281+ B12B FF FF FF FF
 282+ B12F F8 FC FE DE      DB 0xF8,0xFC,0xFE,0xDE,0xCE,0xC6,0xC0,0xC0
 282+ B133 CE C6 C0 C0
 283+ B137 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 283+ B13B 00 00 00 00
 284+ B13F 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 284+ B143 00 00 00 00
 285+ B147 FF FF 00 FF      DB 0xFF,0xFF,0x00,0xFF,0xFF,0xF3,0xF1,0x71
 285+ B14B FF F3 F1 71
 286+ B14F C0 C0 00 C0      DB 0xC0,0xC0,0x00,0xC0,0xC0,0xC0,0xE0,0xE0
 286+ B153 C0 C0 E0 E0
 287+ B157 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 287+ B15B 00 00 00 00
 288+ B15F 00 07 0F 1F      DB 0x00,0x07,0x0F,0x1F,0x1F,0x1F,0x0F,0x07
 288+ B163 1F 1F 0F 07
 289+ B167 01 81 C0 E0      DB 0x01,0x81,0xC0,0xE0,0xE0,0xE0,0xC0,0x80
 289+ B16B E0 E0 C0 80
 290+ B16F E0 E0 F0 F0      DB 0xE0,0xE0,0xF0,0xF0,0xF8,0x78,0x78,0x18
 290+ B173 F8 78 78 18
 291+ B177              ; Field line (top-left)
 292+ B177 00 00 00 1F      DB 0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x10
 292+ B17B 10 10 10 10
 293+ B17F              ; Field line (vertical)
 294+ B17F 10 10 10 10      DB 0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10
 294+ B183 10 10 10 10
 295+ B187              ; Field line (horizontal)
 296+ B187 00 00 00 FF      DB 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00
 296+ B18B 00 00 00 00
 297+ B18F              ; Field line (top-right)
 298+ B18F 00 00 00 F0      DB 0x00,0x00,0x00,0xF0,0x10,0x10,0x10,0x10
 298+ B193 10 10 10 10
 299+ B197              ; Field line (bottom-left)
 300+ B197 10 10 10 1F      DB 0x10,0x10,0x10,0x1F,0x00,0x00,0x00,0x00
 300+ B19B 00 00 00 00
 301+ B19F              ; Field line (bottom-right)
 302+ B19F 10 10 10 F0      DB 0x10,0x10,0x10,0xF0,0x00,0x00,0x00,0x00
 302+ B1A3 00 00 00 00
 303+ B1A7              ; Field
 304+ B1A7 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 304+ B1AB 00 00 00 00
 305+ B1AF              ; Field line (left-cross)
 306+ B1AF 10 10 10 1F      DB 0x10,0x10,0x10,0x1F,0x10,0x10,0x10,0x10
 306+ B1B3 10 10 10 10
 307+ B1B7              ; Field line (right-cross)
 308+ B1B7 10 10 10 F0      DB 0x10,0x10,0x10,0xF0,0x10,0x10,0x10,0x10
 308+ B1BB 10 10 10 10
 309+ B1BF              ; Field half line with white player head 1
 310+ B1BF 00 07 0F FF      DB 0x00,0x07,0x0F,0xFF,0x0F,0x0F,0x3F,0x7F
 310+ B1C3 0F 0F 3F 7F
 311+ B1C7                  ; Field half line with white player head 2
 312+ B1C7 00 80 C0 FF      DB 0x00,0x80,0xC0,0xFF,0xC0,0xC0,0xE0,0xF0
 312+ B1CB C0 C0 E0 F0
 313+ B1CF              ; Ball overlay (TOP-LEFT)  tile 251  ← mirror del bottom-left
 314+ B1CF 03 07 0F 0F      DB 0x03,0x07,0x0F,0x0F,0x0F,0x07,0x03,0x00
 314+ B1D3 0F 07 03 00
 315+ B1D7              ; Ball overlay (TOP-RIGHT) tile 252  ← mirror del bottom-right
 316+ B1D7 C0 E0 F0 F0      DB 0xC0,0xE0,0xF0,0xF0,0xF0,0xE0,0xC0,0x00
 316+ B1DB F0 E0 C0 00
 317+ B1DF              ; Ball back overlay RIGHT-SHIFTED (2 tiles, same size as game ball)
 318+ B1DF              ; LEFT part  (pattern 253)
 319+ B1DF 00 01 03 03      DB 0x00,0x01,0x03,0x03,0x03,0x01,0x00,0x00
 319+ B1E3 03 01 00 00
 320+ B1E7              ; RIGHT part (pattern 254)
 321+ B1E7 F0 F8 FC FC      DB 0xF0,0xF8,0xFC,0xFC,0xFC,0xF8,0xF0,0x00
 321+ B1EB FC F8 F0 00
 322+ B1EF              ; WHITE PLAYER WITH BALL part (pattern 255)
 323+ B1EF F3 E7 EF CF      DB 0xF3,0xE7,0xEF,0xCF,0xCF,0x07,0x03,0x00
 323+ B1F3 CF 07 03 00
 324+ B1F7
 325+ B1F7
 326+ B1F7
# file closed: ./inc/tiles.asm
  50  B1F7                  INCLUDE "vars.asm"              ; Include variables definitions
# file opened: ./inc/vars.asm
   1+ B1F7              ; ===================================================================
   2+ B1F7              ; GS11-Soccer - 2025 Fausto Pracek
   3+ B1F7              ; ===================================================================
   4+ B1F7
   5+ B1F7
   6+ B1F7
   7+ B1F7
   8+ B1F7
   9+ B1F7              ; -------------------------------------------------------------------
  10+ B1F7              ; General variables
  11+ B1F7              ; -------------------------------------------------------------------
  12+ B1F7 00           Var_Sounds_Playing:                             DEFB    0
  13+ B1F8 00 00        Var_Sounds_Ptr:                                 DEFW    0
  14+ B1FA 00 00        Var_Sounds_Len:                                 DEFW    0
  15+ B1FC 00           Var_Utils_OldRnd:                               DEFB    0
  16+ B1FD 00           Var_Utils_VblankStopped:                        DEFB    0
  17+ B1FE 00 00 00...  Var_Utils_NumberToPrint:                        DEFS    6,0
  18+ B204 00           Var_Utils_LastKbdKeyPressed:                    DEFB    0
  19+ B205 00           Var_Utils_ULA_Shadow:                           DEFB    0
  20+ B206 00           Var_Utils_KbdKeyPressed:                        DEFB    0
  21+ B207              ; -------------------------------------------------------------------
  22+ B207              ; Game variables
  23+ B207              ; -------------------------------------------------------------------
  24+ B207 00           Var_Game_ActiveFieldSide:                       DEFB    0
  25+ B208 00           Var_Game_SecondsToPlay:                         DEFB    0
  26+ B209 00           Var_Game_SelectedLevel:                         DEFB    0
  27+ B20A 00           Var_Game_BallOwnerTeamOrStatus:                 DEFB    0
  28+ B20B 00           Var_Game_BallOwnerId:                           DEFB    0
  29+ B20C 00           Var_Game_BallTmp_FoundBelow:                    DEFB    0
  30+ B20D 00           Var_Game_MoveTmpDir:                            DEFB    0
  31+ B20E 00           Var_Game_BallUpdateTimer:                       DEFB    0
  32+ B20F 00           Var_Game_BallTmp_FoundAbove:                    DEFB    0
  33+ B210 00           Var_Game_BallTmp_TeamAbove:                     DEFB    0
  34+ B211 00           Var_Game_BallTmp_TeamBelow:                     DEFB    0
  35+ B212 00           Var_Game_BallTmp_IdBelow:                       DEFB    0
  36+ B213 00           Var_Game_BallTmp_IdAbove:                       DEFB    0
  37+ B214 00           Var_Game_LastWhitePlayerMovedID:                DEFB    0
  38+ B215 00           Var_Game_LastBlackPlayerMovedID:                DEFB    0
  39+ B216 00           Var_Game_ScoreBlack:                            DEFB    0
  40+ B217 00           Var_Game_TmpMoveTeam:                           DEFB    0
  41+ B218 00           Var_Game_TmpMoveId:                             DEFB    0
  42+ B219 00           Var_Game_TmpMoveDir:                            DEFB    0
  43+ B21A 00           Var_Game_TmpMoveCompanionId:                    DEFB    0
  44+ B21B 00           Var_Game_TmpMoveCompanionX:                     DEFB    0
  45+ B21C 00           Var_Game_TmpMoveRow:                            DEFB    0
  46+ B21D 00           Var_Game_TmpMovStartCol:                        DEFB    0
  47+ B21E 00           Var_Game_TmpAskedMovingRow:                     DEFB    0
  48+ B21F 00           Var_Game_TmpMoveReadRowPlayersFromLeft:         DEFB    0
  49+ B220 00           Var_Game_TmpNewX:                               DEFB    0
  50+ B221 00           Var_Game_TmpNewY:                               DEFB    0
  51+ B222 00           Var_Game_HumanPlayerSpeed:                      DEFB    0
  52+ B223 00           Var_Game_ScoreWhite:                            DEFB    0
  53+ B224 00           Var_Game_TimeToPlay:                            DEFB    0
  54+ B225 00           Var_Game_TeamWithBall:                          DEFB    0
  55+ B226 00           Var_Game_GoalkeeperHasBall:                     DEFB    0
  56+ B227 00           Var_Game_BallDirection:                         DEFB    0
  57+ B228 00           Var_Game_BallDiagonalMovCounter:                DEFB    0
  58+ B229 00           Var_Game_VirtualPlayerYPos:                     DEFB    0
  59+ B22A 00           Var_Game_VirtualPlayerXPos:                     DEFB    0
  60+ B22B 00           Var_Game_VirtualPlayerTeam:                     DEFB    0
  61+ B22C 00           Var_Game_MatchInProgress:                       DEFB    0
  62+ B22D 00           Var_Game_PlayersSpeed:                          DEFB    0
  63+ B22E 00           Var_Game_TempTeam:                              DEFB    0
  64+ B22F 00           Var_Game_SelectedPlayers:                       DEFB    0
  65+ B230 00           Var_Game_BallXPosition:                         DEFB    0
  66+ B231 00           Var_Game_FirstKickType:                         DEFB    0
  67+ B232 00           Var_Game_FirstKickFrameCounter:                 DEFB    0
  68+ B233 00           Var_Game_BeepStep:                              DEFB    0
  69+ B234 00           Var_Game_BallYPosition:                         DEFB    0
  70+ B235 00           Var_Game_BallYOldPosition:                      DEFB    0
  71+ B236 00           Var_Game_BallXOldPosition:                      DEFB    0
  72+ B237
  73+ B237              ; 56 bytes come in MSX: Var_Game_PlayersInfo + 56
  74+ B237 00 00 00...  Var_Game_PlayersInfo:                           DEFS    56,0
  75+ B26F
  76+ B26F 00           Var_Vdp_HalfFieldHorzLinePos:                   DEFB    0
  77+ B270 00           Var_VdpTemp:                                    DEFB    0
  78+ B271
  79+ B271              ; -------------------------------------------------------------------
  80+ B271              ; Hooks / counters
  81+ B271              ; -------------------------------------------------------------------
  82+ B271 00 00 00 00  Var_Hooks_Old_HTIMI:                            DEFS    4,0     ; 4
  83+ B275 00           Var_Hooks_FrameCounter:                         DEFB    0
  84+ B276 00           Var_Hooks_AiCounterBlack:                       DEFB    0
  85+ B277 00           Var_Hooks_BlinkingType:                         DEFB    0
  86+ B278 00           Var_Hooks_BlinkingTileToShow:                   DEFB    0
  87+ B279 00           Var_Hooks_BlinkingTileToHide:                   DEFB    0
  88+ B27A 00           Var_Hooks_BlinkingActiveTile:                   DEFB    0
  89+ B27B 00           Var_Hooks_BlinkingCounter:                      DEFB    0
  90+ B27C 00           Var_Hooks_GameResumingWaiting:                  DEFB    0
  91+ B27D 00           Var_Hooks_CerimonySpeedCounter:                 DEFB    0
  92+ B27E 00           Var_Hooks_BlinkingIsActive:                     DEFB    0
  93+ B27F 00           Var_Hooks_BlinkingMustResetFrameCounter:        DEFB    0
  94+ B280 00           Var_Hooks_BestDistanceId:                       DEFB    0
  95+ B281 00           Var_Hooks_BestDistanceX:                        DEFB    0
  96+ B282 00           Var_Hooks_ForceVdpRedraw:                       DEFB    0
  97+ B283 00           Var_Hooks_TickSpeed:                            DEFB    0
  98+ B284 00           Var_Hooks_GoalCerimonyCounter:                  DEFB    0
  99+ B285 00           Var_Hooks_TickCounter:                          DEFB    0
 100+ B286 00           Var_Hooks_TickSuspended:                        DEFB    0
 101+ B287
 102+ B287              ; commento originale: 5 bytes
 103+ B287 00 00 00...  Var_Hook_RowOccupancy:                          DEFS    5,0
 104+ B28C
 105+ B28C 00           Var_Hooks_AiCounterWhite:                       DEFB    0
 106+ B28D 00           Var_Hooks_SecondsCounter:                       DEFB    0
 107+ B28E 00           Var_Hooks_MinutesCounter:                       DEFB    0
 108+ B28F
 109+ B28F
# file closed: ./inc/vars.asm
  51  B28F
  52  B28F                  SAVESNA "./out/gssoccer.sna", Begin
  53  B28F              END
  54  B28F
  55  B28F
  56  B28F
# file closed: ./src/GSSOCCER.asm
