# file opened: ./src/GSSOCCER.asm
   1  0000              ; ===================================================================
   2  0000              ; SAM.PR World - 2025 Fausto Pracek
   3  0000              ; ===================================================================
   4  0000
   5  0000                      DEVICE ZXSPECTRUM48
   6  0000                      SLDOPT COMMENT WPMEM, LOGPOINT, ASSERTION
   7  0000
   8  0000                      ORG 0x8000               ; Loader address (0x8000)
   9  8000
  10  8000
  11  8000                      INCLUDE "constants.asm"
# file opened: ./inc/constants.asm
   1+ 8000              ; ===================================================================
   2+ 8000              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8000              ; ===================================================================
   4+ 8000
   5+ 8000              ; *** CONSTANTS.ASM ***
   6+ 8000
   7+ 8000              SND_DATA:
   8+ 8000
   9+ 8000                   incbin "gssoccer.snd"
  10+ 8607
  11+ 8607              SCR_BASE                            EQU 0x4000      ; Base address of the Spectrum screen
  12+ 8607              ATTR_BASE                           EQU 0x5800      ; Start of the attribute area
  13+ 8607              ROM_CHAR_SET_ADDRESS                EQU 0x3D00      ; Start of the ROM character set
  14+ 8607              RAM_CHAR_SET_ADDRESS                EQU 0x9C40      ; Start of the RAM character set
  15+ 8607
  16+ 8607              MATCH_TIME:                         EQU 60
  17+ 8607              TICK_SPEED:                         EQU 5
  18+ 8607
  19+ 8607              TILE_CORNER:                        EQU 0
  20+ 8607              TILE_WHITE_PLAYER_WITH_BALL         EQU 1
  21+ 8607              TILE_BLACK_PLAYER_WITH_BACK_BALL    EQU 2
  22+ 8607              TILE_CORNER_BALL:                   EQU 3
  23+ 8607              TILE_CORNER_BALL_EMPTY:             EQU 4
  24+ 8607              TILE_REMOVE_WHITE_PLAYER_AND_BALL:  EQU 5
  25+ 8607              TILE_BALL_TOP:                      EQU 6
  26+ 8607              TILE_BALL_TOP_FRONT:                EQU 7
  27+ 8607              TILE_BALL_BOTTOM:                   EQU 64
  28+ 8607              TILE_WHITE_PLAYER_NEAR_HALF_FIELD:  EQU 80
  29+ 8607              TILE_WHITE_GOALKEEPER:              EQU 96
  30+ 8607              TILE_WHITE_GOALKEEPER_WITH_BALL:    EQU 112
  31+ 8607              TILE_BLACK_GOALKEEPER:              EQU 128
  32+ 8607              TILE_BLACK_GOALKEEPER_WITH_BALL:    EQU 144
  33+ 8607              TILE_WHITE_PLAYER:                  EQU 160
  34+ 8607              TILE_BLACK_PLAYER:                  EQU 176
  35+ 8607              TILE_BLACK_PLAYER_WITH_BALL:        EQU 192
  36+ 8607              TILE_FIELD_LINE_TOP_LEFT:           EQU 208
  37+ 8607              TILE_FIELD_LINE_VERTICAL:           EQU 209
  38+ 8607              TILE_FIELD_LINE_HORIZONTAL:         EQU 210
  39+ 8607              TILE_FIELD_LINE_TOP_RIGHT:          EQU 211
  40+ 8607              TILE_FIELD_LINE_BOTTOM_LEFT:        EQU 212
  41+ 8607              TILE_FIELD_LINE_BOTTOM_RIGHT:       EQU 213
  42+ 8607              TILE_FIELD:                         EQU 214
  43+ 8607              TILE_FIELD_LINE_LEFT_CROSS:         EQU 215
  44+ 8607              TILE_FIELD_LINE_RIGHT_CROSS:        EQU 216
  45+ 8607              TILE_FIELD_LINE_WHITE_PLAYER_1:     EQU 217
  46+ 8607              TILE_FIELD_LINE_WHITE_PLAYER_2:     EQU 218
  47+ 8607              TILE_BALL_BOTTOM_LEFT:              EQU TILE_BALL_BOTTOM + 14   ; 78
  48+ 8607              TILE_BALL_BOTTOM_RIGHT:             EQU TILE_BALL_BOTTOM + 15   ; 79
  49+ 8607              TILE_BALL_TOP_LEFT:                 EQU 221
  50+ 8607              TILE_BALL_TOP_RIGHT:                EQU 222
  51+ 8607              TILE_BALL_FEET_OVERLAY_L            EQU 219   ; già esistente (top-left)
  52+ 8607              TILE_BALL_FEET_OVERLAY_R            EQU 220   ; già esistente (top-right)
  53+ 8607              TILE_BALL_BACK_OVERLAY_L            EQU 221   ; nuovo: spalla, parte sinistra
  54+ 8607              TILE_BALL_BACK_OVERLAY_R            EQU 222   ; nuovo: spalla, parte destra
  55+ 8607              TILE_WHITE_PLAYER_AND_BALL          EQU 223
  56+ 8607
  57+ 8607
  58+ 8607
  59+ 8607              TILE_PLAYERS_COLOR:                 EQU 0x13
  60+ 8607              TILE_FIELDS_LINES_COLOR:            EQU 0x13
  61+ 8607              TILE_BALL_BOTTOM_L                  EQU TILE_BALL_BOTTOM + 13
  62+ 8607              TILE_BALL_BOTTOM_R                  EQU TILE_BALL_BOTTOM + 14
  63+ 8607
  64+ 8607              GREEN_CHAR_ATTRIBUTE                EQU 0x20  ; Green on black
  65+ 8607
  66+ 8607              FIELD_NORTH_SIDE                    EQU 1
  67+ 8607              FIELD_SOUTH_SIDE                    EQU 0
  68+ 8607              YES                                 EQU 1
  69+ 8607              NO                                  EQU 0
  70+ 8607              GAME_MODE_2_PLAYERS                 EQU 2
  71+ 8607              GAME_MODE_1_PLAYER                  EQU 1
  72+ 8607              NO_VALUE                            EQU 255
  73+ 8607              TEAM_WHITE                          EQU 1
  74+ 8607              TEAM_BLACK                          EQU 0
  75+ 8607              ROLE_GOALKEEPER                     EQU 0
  76+ 8607              ROLE_DEFENDER                       EQU 1
  77+ 8607              ROLE_MIDFIELDER                     EQU 2
  78+ 8607              ROLE_STRIKER                        EQU 3
  79+ 8607
  80+ 8607              PLAYER_ENTRY_SIZE                   EQU 7  ; bytes per player entry in Var_Game_PlayersInfo
  81+ 8607
  82+ 8607              BALL_DIRECTION_NONE                 EQU 0
  83+ 8607              BALL_DIRECTION_NORTH                EQU 1
  84+ 8607              BALL_DIRECTION_NORTH_EAST           EQU 2
  85+ 8607              BALL_DIRECTION_NORTH_WEST           EQU 3
  86+ 8607              BALL_DIRECTION_SOUTH                EQU 4
  87+ 8607              BALL_DIRECTION_SOUTH_EAST           EQU 5
  88+ 8607              BALL_DIRECTION_SOUTH_WEST           EQU 6
  89+ 8607
  90+ 8607              PLAYER_ASKED_DIRECTION_EAST:        EQU 1
  91+ 8607              PLAYER_ASKED_DIRECTION_WEST:        EQU 2
  92+ 8607              PLAYER_ASKED_DIRECTION_NORTH:       EQU 3
  93+ 8607              PLAYER_ASKED_DIRECTION_SOUTH:       EQU 4
  94+ 8607
  95+ 8607              DEMO_MODE_LEVEL                     EQU 4
  96+ 8607
  97+ 8607              BALL_STATUS_MOVING                  EQU 100
  98+ 8607              BALL_STATUS_CONTENDED               EQU 101
  99+ 8607              BALL_STATUS_FREE                    EQU 102
 100+ 8607
 101+ 8607              SUCCESS                             EQU 1
 102+ 8607              FAILURE                             EQU 0
 103+ 8607
 104+ 8607              VDP_DATA                            EQU 098h
 105+ 8607              VDP_ADDR                            EQU 099h
 106+ 8607
 107+ 8607              BLINK_TYPE_GOAL                     EQU 1
 108+ 8607              BLINK_TYPE_CORNER                   EQU 2
 109+ 8607              BLINK_TYPE_GOALKEEPER               EQU 3
 110+ 8607              BLINK_FRAMES_DURATION               EQU 30
 111+ 8607
 112+ 8607              FIRST_KICK_TYPE_WHITE_HALF_FIELD:   EQU 1
 113+ 8607              FIRST_KICK_TYPE_BLACK_HALF_FIELD:   EQU 2
 114+ 8607              FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD: EQU 3
 115+ 8607              FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD: EQU 4
 116+ 8607
 117+ 8607
 118+ 8607              CERIMONY_MOVEMENT_SPEED:            EQU 20
 119+ 8607
 120+ 8607 FE 23 5A 58  KEYBOARD_MAP:                       DB #FE,"#","Z","X","C","V"
 120+ 860B 43 56
 121+ 860D FD 41 53 44                                      DB #FD,"A","S","D","F","G"
 121+ 8611 46 47
 122+ 8613 FB 51 57 45                                      DB #FB,"Q","W","E","R","T"
 122+ 8617 52 54
 123+ 8619 F7 31 32 33                                      DB #F7,"1","2","3","4","5"
 123+ 861D 34 35
 124+ 861F EF 30 39 38                                      DB #EF,"0","9","8","7","6"
 124+ 8623 37 36
 125+ 8625 DF 50 4F 49                                      DB #DF,"P","O","I","U","Y"
 125+ 8629 55 59
 126+ 862B BF 23 4C 4B                                      DB #BF,"#","L","K","J","H"
 126+ 862F 4A 48
 127+ 8631 7F 20 23 4D                                      DB #7F," ","#","M","N","B"
 127+ 8635 4E 42
 128+ 8637
# file closed: ./inc/constants.asm
  12  8637                      INCLUDE "vars.asm"
# file opened: ./inc/vars.asm
   1+ 8637              ; ===================================================================
   2+ 8637              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8637              ; ===================================================================
   4+ 8637
   5+ 8637
   6+ 8637                      ; Scegli qui la base RAM delle variabili
   7+ 8637
   8+ 8637
   9+ 8637              ; -------------------------------------------------------------------
  10+ 8637              ; General variables
  11+ 8637              ; -------------------------------------------------------------------
  12+ 8637 00           Var_Sounds_Playing:                         DEFB    0
  13+ 8638 00 00        Var_Sounds_Ptr:                             DEFW    0
  14+ 863A 00 00        Var_Sounds_Len:                             DEFW    0
  15+ 863C 00           Var_Utils_OldRnd:                           DEFB    0
  16+ 863D 00           Var_Utils_VblankStopped:                    DEFB    0
  17+ 863E 00 00 00...  Var_Utils_NumberToPrint:                    DEFS    6,0
  18+ 8644 00           Var_Utils_LastKbdKeyPressed:                DEFB    0
  19+ 8645 00           Var_Utils_KbdKeyPressed:                    DEFB    0
  20+ 8646              ; -------------------------------------------------------------------
  21+ 8646              ; Game variables
  22+ 8646              ; -------------------------------------------------------------------
  23+ 8646 00           Var_Game_ActiveFieldSide:                   DEFB    0
  24+ 8647 00           Var_Game_SecondsToPlay:                     DEFB    0
  25+ 8648 00           Var_Game_SelectedLevel:                     DEFB    0
  26+ 8649 00           Var_Game_BallOwnerTeamOrStatus:             DEFB    0
  27+ 864A 00           Var_Game_BallOwnerId:                       DEFB    0
  28+ 864B 00           Var_Game_BallTmp_FoundBelow:                DEFB    0
  29+ 864C 00           Var_Game_MoveTmpDir:                        DEFB    0
  30+ 864D 00           Var_Game_BallUpdateTimer:                   DEFB    0
  31+ 864E 00           Var_Game_BallTmp_FoundAbove:                DEFB    0
  32+ 864F 00           Var_Game_BallTmp_TeamAbove:                 DEFB    0
  33+ 8650 00           Var_Game_BallTmp_TeamBelow:                 DEFB    0
  34+ 8651 00           Var_Game_BallTmp_IdBelow:                   DEFB    0
  35+ 8652 00           Var_Game_BallTmp_IdAbove:                   DEFB    0
  36+ 8653 00           Var_Game_LastWhitePlayerMovedID:            DEFB    0
  37+ 8654 00           Var_Game_LastBlackPlayerMovedID:            DEFB    0
  38+ 8655 00           Var_Game_ScoreBlack:                        DEFB    0
  39+ 8656 00           Var_Game_TmpMoveTeam:                       DEFB    0
  40+ 8657 00           Var_Game_TmpMoveId:                         DEFB    0
  41+ 8658 00           Var_Game_TmpMoveDir:                        DEFB    0
  42+ 8659 00           Var_Game_TmpMoveCompanionId:                DEFB    0
  43+ 865A 00           Var_Game_TmpMoveCompanionX:                 DEFB    0
  44+ 865B 00           Var_Game_TmpMoveRow:                        DEFB    0
  45+ 865C 00           Var_Game_TmpMovStartCol:                    DEFB    0
  46+ 865D 00           Var_Game_TmpAskedMovingRow:                 DEFB    0
  47+ 865E 00           Var_Game_TmpMoveReadRowPlayersFromLeft:     DEFB    0
  48+ 865F 00           Var_Game_TmpNewX:                           DEFB    0
  49+ 8660 00           Var_Game_TmpNewY:                           DEFB    0
  50+ 8661 00           Var_Game_HumanPlayerSpeed:                  DEFB    0
  51+ 8662 00           Var_Game_ScoreWhite:                        DEFB    0
  52+ 8663 00           Var_Game_TimeToPlay:                        DEFB    0
  53+ 8664 00           Var_Game_TeamWithBall:                      DEFB    0
  54+ 8665 00           Var_Game_GoalkeeperHasBall:                 DEFB    0
  55+ 8666 00           Var_Game_BallDirection:                     DEFB    0
  56+ 8667 00           Var_Game_BallDiagonalMovCounter:            DEFB    0
  57+ 8668 00           Var_Game_VirtualPlayerYPos:                 DEFB    0
  58+ 8669 00           Var_Game_VirtualPlayerXPos:                 DEFB    0
  59+ 866A 00           Var_Game_VirtualPlayerTeam:                 DEFB    0
  60+ 866B 00           Var_Game_MatchInProgress:                   DEFB    0
  61+ 866C 00           Var_Game_PlayersSpeed:                      DEFB    0
  62+ 866D 00           Var_Game_TempTeam:                          DEFB    0
  63+ 866E 00           Var_Game_SelectedPlayers:                   DEFB    0
  64+ 866F 00           Var_Game_BallXPosition:                     DEFB    0
  65+ 8670 00           Var_Game_FirstKickType:                     DEFB    0
  66+ 8671 00           Var_Game_FirstKickFrameCounter:             DEFB    0
  67+ 8672 00           Var_Game_BeepStep:                          DEFB    0
  68+ 8673 00           Var_Game_BallYPosition:                     DEFB    0
  69+ 8674 00           Var_Game_BallYOldPosition:                  DEFB    0
  70+ 8675 00           Var_Game_BallXOldPosition:                  DEFB    0
  71+ 8676
  72+ 8676              ; 56 bytes come in MSX: Var_Game_PlayersInfo + 56
  73+ 8676 00 00 00...  Var_Game_PlayersInfo:                       DEFS    56,0
  74+ 86AE
  75+ 86AE 00           Var_Vdp_HalfFieldHorzLinePos:               DEFB    0
  76+ 86AF
  77+ 86AF              ; -------------------------------------------------------------------
  78+ 86AF              ; Hooks / counters
  79+ 86AF              ; -------------------------------------------------------------------
  80+ 86AF 00 00 00 00  Var_Hooks_Old_HTIMI:                        DEFS    4,0     ; 4
  81+ 86B3 00           Var_Hooks_FrameCounter:                     DEFB    0
  82+ 86B4 00           Var_Hooks_AiCounterBlack:                   DEFB    0
  83+ 86B5 00           Var_Hooks_BlinkingType:                     DEFB    0
  84+ 86B6 00           Var_Hooks_BlinkingTileToShow:               DEFB    0
  85+ 86B7 00           Var_Hooks_BlinkingTileToHide:               DEFB    0
  86+ 86B8 00           Var_Hooks_BlinkingActiveTile:               DEFB    0
  87+ 86B9 00           Var_Hooks_BlinkingCounter:                  DEFB    0
  88+ 86BA 00           Var_Hooks_GameResumingWaiting:              DEFB    0
  89+ 86BB 00           Var_Hooks_CerimonySpeedCounter:             DEFB    0
  90+ 86BC 00           Var_Hooks_BlinkingIsActive:                 DEFB    0
  91+ 86BD 00           Var_Hooks_BlinkingMustResetFrameCounter:    DEFB    0
  92+ 86BE 00           Var_Hooks_BestDistanceId:                   DEFB    0
  93+ 86BF 00           Var_Hooks_BestDistanceX:                    DEFB    0
  94+ 86C0 00           Var_Hooks_ForceVdpRedraw:                   DEFB    0
  95+ 86C1 00           Var_Hooks_TickSpeed:                        DEFB    0
  96+ 86C2 00           Var_Hooks_GoalCerimonyCounter:              DEFB    0
  97+ 86C3 00           Var_Hooks_TickCounter:                      DEFB    0
  98+ 86C4 00           Var_Hooks_TickSuspended:                    DEFB    0
  99+ 86C5
 100+ 86C5              ; commento originale: 5 bytes
 101+ 86C5 00 00 00...  Var_Hook_RowOccupancy:                      DEFS    5,0
 102+ 86CA
 103+ 86CA 00           Var_Hooks_AiCounterWhite:                   DEFB    0
 104+ 86CB 00           Var_Hooks_SecondsCounter:                   DEFB    0
 105+ 86CC 00           Var_Hooks_MinutesCounter:                   DEFB    0
 106+ 86CD
 107+ 86CD
# file closed: ./inc/vars.asm
  13  86CD                      INCLUDE "hooks.asm"			; Include hooks library
# file opened: ./inc/hooks.asm
   1+ 86CD              ; ===================================================================
   2+ 86CD              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 86CD              ; ===================================================================
   4+ 86CD
   5+ 86CD              ; *** HOOKS.ASM ***
   6+ 86CD
   7+ 86CD
   8+ 86CD              ;----------------------------------------------------------------------
   9+ 86CD              ; VBlank hook installation
  10+ 86CD              ; INPUT: -
  11+ 86CD              ; OUTPUT: -
  12+ 86CD              ; MODIFIES: A, DE, HL, BC
  13+ 86CD              ;----------------------------------------------------------------------
  14+ 86CD              Hooks_Init:
  15+ 86CD CD D5 86         CALL    SetM2RRoutine
  16+ 86D0 F3               DI                                      ; Disable interrupts
  17+ 86D1 ED 5E            IM      2                               ; Set the interrupt mode
  18+ 86D3 FB               EI                                      ; Enable interrupts
  19+ 86D4 C9               RET
  20+ 86D5
  21+ 86D5              ;----------------------------------------------------------------------
  22+ 86D5              ; SetM2RRoutine
  23+ 86D5              ;----------------------------------------------------------------------
  24+ 86D5              SetM2RRoutine:
  25+ 86D5 21 FF 86         LD      HL,VBlankISR
  26+ 86D8 DD 21 F0 FF      LD      IX,0xFFF0                       ; This code is to be written at 0xFF
  27+ 86DC DD 36 04 C3      LD      (IX+04h),0xC3                   ; Opcode for JP
  28+ 86E0 DD 75 05         LD      (IX+05h),L                      ; Store the address of the interrupt routine in
  29+ 86E3 DD 74 06         LD      (IX+06h),H
  30+ 86E6 DD 36 0F 18      LD      (IX+0Fh),0x18                   ; Opcode for JR; this will do JR to FFF4h
  31+ 86EA 3E 39            LD      A,0x39                          ; Interrupt table at page 0x3900 (ROM)
  32+ 86EC ED 47            LD      I,A                             ; Set the interrupt register to that page
  33+ 86EE C9               RET
  34+ 86EF
  35+ 86EF              ;----------------------------------------------------------------------
  36+ 86EF              ; Hooks_TickStart
  37+ 86EF              ;----------------------------------------------------------------------
  38+ 86EF              Hooks_TickStart:
  39+ 86EF F5               PUSH    AF
  40+ 86F0 3E 00            LD      A, NO
  41+ 86F2 32 C4 86         LD      (Var_Hooks_TickSuspended), A
  42+ 86F5 F1               POP     AF
  43+ 86F6 C9               RET
  44+ 86F7              ;----------------------------------------------------------------------
  45+ 86F7              ; Hooks_TickStop
  46+ 86F7              ;----------------------------------------------------------------------
  47+ 86F7              Hooks_TickStop:
  48+ 86F7 F5               PUSH    AF
  49+ 86F8 3E 01            LD      A, YES
  50+ 86FA 32 C4 86         LD      (Var_Hooks_TickSuspended), A
  51+ 86FD F1               POP     AF
  52+ 86FE C9               RET
  53+ 86FF
  54+ 86FF              ;----------------------------------------------------------------------
  55+ 86FF              ; VBlank ISR
  56+ 86FF              ; INPUT: -
  57+ 86FF              ; OUTPUT: -
  58+ 86FF              ; MODIFIES: A, DE, HL, BC
  59+ 86FF              ;----------------------------------------------------------------------
  60+ 86FF              VBlankISR:
  61+ 86FF F3               DI                                         ; Disable interrupts
  62+ 8700 F5               PUSH    AF                                 ; Save all the registers on the stack
  63+ 8701 C5               PUSH    BC                                 ; This is probably not necessary unless
  64+ 8702 D5               PUSH    DE                                 ; we're looking at returning cleanly
  65+ 8703 E5               PUSH    HL                                 ; back to BASIC at some point
  66+ 8704 DD E5            PUSH    IX
  67+ 8706 D9               EXX
  68+ 8707 08               EX      AF,AF'
  69+ 8708 F5               PUSH    AF
  70+ 8709 C5               PUSH    BC
  71+ 870A D5               PUSH    DE
  72+ 870B E5               PUSH    HL
  73+ 870C FD E5            PUSH    IY
  74+ 870E
  75+ 870E
  76+ 870E
  77+ 870E 3A B3 86         LD      A, (Var_Hooks_FrameCounter)
  78+ 8711 3C               INC     A
  79+ 8712 FE 33            CP      51
  80+ 8714 20 22            JR      NZ, .Continue
  81+ 8716
  82+ 8716 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
  83+ 8719 FE 00            CP      NO
  84+ 871B 28 07            JR      Z, .Time
  85+ 871D 3A 63 86         LD      A, (Var_Game_TimeToPlay)
  86+ 8720 3D               DEC     A
  87+ 8721 32 63 86         LD      (Var_Game_TimeToPlay), A
  88+ 8724              .Time:
  89+ 8724 3A CB 86         LD      A, (Var_Hooks_SecondsCounter)
  90+ 8727 3C               INC     A
  91+ 8728 FE 3D            CP      61
  92+ 872A 20 08            JR      NZ, .NewMinute
  93+ 872C 3A CC 86         LD      A, (Var_Hooks_MinutesCounter)
  94+ 872F 3C               INC     A
  95+ 8730 32 CC 86         LD      (Var_Hooks_MinutesCounter), A
  96+ 8733 AF               XOR     A           ; Reset the seconds counter
  97+ 8734              .NewMinute:
  98+ 8734 32 CB 86         LD      (Var_Hooks_SecondsCounter), A
  99+ 8737 AF               XOR     A       ; Reset the frame counter
 100+ 8738              .Continue:
 101+ 8738 32 B3 86         LD      (Var_Hooks_FrameCounter), A
 102+ 873B              .Done:
 103+ 873B 3A C2 86         LD      A, (Var_Hooks_GoalCerimonyCounter)
 104+ 873E FE 00            CP      0
 105+ 8740 28 08            JR      Z, .AfterGoalCerimony
 106+ 8742 FE FF            CP      NO_VALUE
 107+ 8744 CA BD 8A         JP      Z, .CheckBlinkingRestartAfterGoal
 108+ 8747 C3 BD 89         JP      .ShowGoalCeromony
 109+ 874A              .AfterGoalCerimony:
 110+ 874A CD FB 9F         CALL    Utils_PlayBeepHighLong
 111+ 874D 3A BA 86         LD      A, (Var_Hooks_GameResumingWaiting)
 112+ 8750 FE 01            CP      YES
 113+ 8752 CA A7 89         JP      Z, .CheckGameResumeWaiting
 114+ 8755 3A C4 86         LD      A, (Var_Hooks_TickSuspended)
 115+ 8758 FE 01            CP      YES
 116+ 875A 28 03            JR      Z, .AfterTick
 117+ 875C CD 1D 8B         CALL    AiTick
 118+ 875F              .AfterTick:
 119+ 875F 3A C0 86         LD     A, (Var_Hooks_ForceVdpRedraw)
 120+ 8762 FE 01            CP     YES
 121+ 8764 20 0B            JR     NZ, .AfterRedraw
 122+ 8766 3E 00            LD     A, NO
 123+ 8768 32 C0 86         LD     (Var_Hooks_ForceVdpRedraw), A
 124+ 876B CD CE AE         CALL   Game_SetVisibileFieldSide
 125+ 876E CD 15 9B         CALL   VDP_PlayerMatrixRedraw
 126+ 8771              .AfterRedraw:
 127+ 8771 3A 70 86         LD      A, (Var_Game_FirstKickType)
 128+ 8774 FE FF            CP      NO_VALUE
 129+ 8776 28 03            JR      Z, .AfterFirtsKickCheck
 130+ 8778 C3 07 89         JP      .CheckFirstKick
 131+ 877B              .AfterFirtsKickCheck:
 132+ 877B 3A BC 86         LD      A, (Var_Hooks_BlinkingIsActive)
 133+ 877E FE 01            CP      YES
 134+ 8780 CA 3B 8A         JP      Z, .CheckBlinkingState
 135+ 8783              .AfterBlinkingCheck:
 136+ 8783 CD CD AD         CALL   Game_CheckStoppedBallOnGoalOrCorner
 137+ 8786
 138+ 8786
 139+ 8786 CD EF 8A         CALL    UpdateMatchTime
 140+ 8789              .ReadKeyBoard:
 141+ 8789 CD AF 9F         CALL    Utils_ReadKeyboard
 142+ 878C 3A 45 86         LD      A, (Var_Utils_KbdKeyPressed)
 143+ 878F FE 20            CP      KBD_KEY_SPACE
 144+ 8791 CA F8 87         JP      Z, .SpaceButtonPressed
 145+ 8794 FE 35            CP      KBD_KEY_LEFT
 146+ 8796 CA 29 88         JP      Z, .LeftArrowPressed
 147+ 8799 FE 4A            CP      KBD_KEY_J
 148+ 879B CA 29 88         JP      Z, .LeftArrowPressed
 149+ 879E FE 38            CP      KBD_KEY_RIGHT
 150+ 87A0 CA 45 88         JP      Z, .RightArrowPressed
 151+ 87A3 FE 4B            CP      KBD_KEY_K
 152+ 87A5 CA 45 88         JP      Z, .RightArrowPressed
 153+ 87A8 FE 36            CP      KBD_KEY_DOWN
 154+ 87AA CA 37 88         JP      Z, .DownArrowPressed
 155+ 87AD FE 37            CP      KBD_KEY_UP
 156+ 87AF CA EA 87         JP      Z, .UpArrowPressed
 157+ 87B2 C3 49 00         JP      KBD_KEY_I
 158+ 87B5 CA EA 87         JP      Z, .UpArrowPressed
 159+ 87B8 FE 57            CP      KBD_KEY_W
 160+ 87BA CA D7 87         JP      Z, .WKeyPressed
 161+ 87BD FE 41            CP      KBD_KEY_A
 162+ 87BF CA 03 88         JP      Z, .AKeyPressed
 163+ 87C2 FE 53            CP      KBD_KEY_S
 164+ 87C4 CA 16 88         JP      Z, .SKeyPressed
 165+ 87C7              .Exit
 166+ 87C7 FD E1            POP     IY                                  ; Restore all the registers
 167+ 87C9 E1               POP     HL
 168+ 87CA D1               POP     DE
 169+ 87CB C1               POP     BC
 170+ 87CC F1               POP     AF
 171+ 87CD D9               EXX
 172+ 87CE 08               EX      AF,AF'
 173+ 87CF DD E1            POP     IX
 174+ 87D1 E1               POP     HL
 175+ 87D2 D1               POP     DE
 176+ 87D3 C1               POP     BC
 177+ 87D4 F1               POP     AF
 178+ 87D5 FB               EI                                      ; Enable interrupts
 179+ 87D6 C9               RET
 180+ 87D7              .WKeyPressed:
 181+ 87D7 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 182+ 87DA FE 00            CP      NO
 183+ 87DC CA F7 89         JP      Z, .StartGame
 184+ 87DF 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 185+ 87E2 FE 01            CP      GAME_MODE_1_PLAYER
 186+ 87E4 CA C7 87         JP      Z, .Exit
 187+ 87E7 C3 93 88         JP      .BlackTeamTryShotOrRestart
 188+ 87EA              .UpArrowPressed:
 189+ 87EA 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 190+ 87ED FE 01            CP      YES
 191+ 87EF CA CD 88         JP      Z, .WhiteTeamTryShotOrRestart
 192+ 87F2 C3 8A 89         JP     .LevelUp
 193+ 87F5 C3 C7 87         JP      .Exit
 194+ 87F8              .SpaceButtonPressed:
 195+ 87F8 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 196+ 87FB FE 00            CP      NO
 197+ 87FD CA F7 89         JP      Z, .StartGame
 198+ 8800 C3 CD 88         JP      .WhiteTeamTryShotOrRestart
 199+ 8803              .AKeyPressed:
 200+ 8803 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 201+ 8806 FE 00            CP      NO
 202+ 8808 CA C7 87         JP      Z, .Exit
 203+ 880B 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 204+ 880E FE 01            CP      GAME_MODE_1_PLAYER
 205+ 8810 CA C7 87         JP      Z, .Exit
 206+ 8813 C3 53 88         JP     .BlackTeamMoveLeft
 207+ 8816              .SKeyPressed:
 208+ 8816 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 209+ 8819 FE 00            CP      NO
 210+ 881B CA C7 87         JP      Z, .Exit
 211+ 881E 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 212+ 8821 FE 01            CP      GAME_MODE_1_PLAYER
 213+ 8823 CA C7 87         JP      Z, .Exit
 214+ 8826 C3 63 88         JP     .BlackTeamMoveRight
 215+ 8829              .LeftArrowPressed:
 216+ 8829 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 217+ 882C FE 01            CP      YES
 218+ 882E CA 73 88         JP      Z, .WhiteTeamMoveLeft
 219+ 8831 C3 4A 89         JP     .ChangeGameSelectedMode
 220+ 8834 C3 C7 87         JP      .Exit
 221+ 8837              .DownArrowPressed:
 222+ 8837 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 223+ 883A FE 01            CP      YES
 224+ 883C CA C7 87         JP      Z, .Exit
 225+ 883F C3 6D 89         JP     .LevelDown
 226+ 8842 C3 C7 87         JP      .Exit
 227+ 8845              .RightArrowPressed:
 228+ 8845 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 229+ 8848 FE 01            CP      YES
 230+ 884A CA 83 88         JP      Z, .WhiteTeamMoveRight
 231+ 884D C3 4A 89         JP     .ChangeGameSelectedMode
 232+ 8850 C3 C7 87         JP     .Exit
 233+ 8853              .BlackTeamMoveLeft:
 234+ 8853 3A 70 86         LD      A, (Var_Game_FirstKickType)
 235+ 8856 FE FF            CP      NO_VALUE
 236+ 8858 C2 C7 87         JP      NZ, .Exit
 237+ 885B 3E 02            LD      A, PLAYER_ASKED_DIRECTION_WEST
 238+ 885D CD 59 AC         CALL    Game_BlackTeamHorizMoveAsked
 239+ 8860 C3 C7 87         JP      .Exit
 240+ 8863              .BlackTeamMoveRight:
 241+ 8863 3A 70 86         LD      A, (Var_Game_FirstKickType)
 242+ 8866 FE FF            CP      NO_VALUE
 243+ 8868 C2 C7 87         JP      NZ, .Exit
 244+ 886B 3E 01            LD      A, PLAYER_ASKED_DIRECTION_EAST
 245+ 886D CD 59 AC         CALL    Game_BlackTeamHorizMoveAsked
 246+ 8870 C3 C7 87         JP      .Exit
 247+ 8873              .WhiteTeamMoveLeft:
 248+ 8873 3A 70 86         LD      A, (Var_Game_FirstKickType)
 249+ 8876 FE FF            CP      NO_VALUE
 250+ 8878 C2 C7 87         JP      NZ, .Exit
 251+ 887B 3E 02            LD      A, PLAYER_ASKED_DIRECTION_WEST
 252+ 887D CD F5 AC         CALL    Game_WhiteTeamHorizMoveAsked
 253+ 8880 C3 C7 87         JP      .Exit
 254+ 8883              .WhiteTeamMoveRight:
 255+ 8883 3A 70 86         LD      A, (Var_Game_FirstKickType)
 256+ 8886 FE FF            CP      NO_VALUE
 257+ 8888 C2 C7 87         JP      NZ, .Exit
 258+ 888B 3E 01            LD      A, PLAYER_ASKED_DIRECTION_EAST
 259+ 888D CD F5 AC         CALL    Game_WhiteTeamHorizMoveAsked
 260+ 8890 C3 C7 87         JP      .Exit
 261+ 8893              .BlackTeamTryShotOrRestart:
 262+ 8893 3A 70 86         LD      A, (Var_Game_FirstKickType)
 263+ 8896 FE FF            CP      NO_VALUE
 264+ 8898 28 21            JR      Z, .BlackTeamTryShot
 265+ 889A FE 02            CP      FIRST_KICK_TYPE_BLACK_HALF_FIELD
 266+ 889C 28 11            JR      Z,.BlackTeamRestartFromHalfField
 267+ 889E FE 04            CP      FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
 268+ 88A0 C2 C7 87         JP      NZ, .Exit
 269+ 88A3 3A 47 86         LD      A, (Var_Game_SecondsToPlay)
 270+ 88A6 32 63 86         LD      (Var_Game_TimeToPlay),A
 271+ 88A9 C3 1A A6         JP      Resume_BlackGoalKick.exec
 272+ 88AC C3 C7 87         JP      .Exit
 273+ 88AF              .BlackTeamRestartFromHalfField:
 274+ 88AF 3A 47 86         LD      A, (Var_Game_SecondsToPlay)
 275+ 88B2 32 63 86         LD      (Var_Game_TimeToPlay),A
 276+ 88B5 C3 5D A6         JP      Resume_BlackKickoff.exec
 277+ 88B8 C3 C7 87         JP      .Exit
 278+ 88BB              .BlackTeamTryShot:
 279+ 88BB CD 01 A7         CALL    Game_GetPlayerIdWithBall
 280+ 88BE FE 00            CP      TEAM_BLACK
 281+ 88C0 C2 C7 87         JP      NZ, .Exit
 282+ 88C3 3E 00            LD      A, TEAM_BLACK
 283+ 88C5 47               LD      B, A
 284+ 88C6 4C               LD      C, H
 285+ 88C7 CD 71 A9         CALL    Game_TryShot
 286+ 88CA C3 C7 87         JP      .Exit
 287+ 88CD              .WhiteTeamTryShotOrRestart:
 288+ 88CD 3A 70 86         LD      A, (Var_Game_FirstKickType)
 289+ 88D0 FE FF            CP      NO_VALUE
 290+ 88D2 28 21            JR      Z, .WhiteTeamTryShot
 291+ 88D4 FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 292+ 88D6 28 11            JR      Z,.WhiteTeamRestartFromHalfField
 293+ 88D8 FE 03            CP      FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
 294+ 88DA C2 C7 87         JP      NZ, .Exit
 295+ 88DD 3A 47 86         LD      A, (Var_Game_SecondsToPlay)
 296+ 88E0 32 63 86         LD      (Var_Game_TimeToPlay),A
 297+ 88E3 C3 CD A5         JP      Resume_WhiteGoalKick.exec
 298+ 88E6 C3 C7 87         JP      .Exit
 299+ 88E9              .WhiteTeamRestartFromHalfField:
 300+ 88E9 3A 47 86         LD      A, (Var_Game_SecondsToPlay)
 301+ 88EC 32 63 86         LD      (Var_Game_TimeToPlay),A
 302+ 88EF C3 A0 A6         JP      Resume_WhiteKickoff.exec
 303+ 88F2 C3 C7 87         JP      .Exit
 304+ 88F5              .WhiteTeamTryShot:
 305+ 88F5 CD 01 A7         CALL    Game_GetPlayerIdWithBall
 306+ 88F8 FE 01            CP      TEAM_WHITE
 307+ 88FA C2 C7 87         JP      NZ, .Exit
 308+ 88FD 3E 01            LD      A, TEAM_WHITE
 309+ 88FF 47               LD      B, A
 310+ 8900 4C               LD      C, H
 311+ 8901 CD 71 A9         CALL    Game_TryShot
 312+ 8904 C3 C7 87         JP      .Exit
 313+ 8907              .CheckFirstKick:
 314+ 8907 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 315+ 890A FE 00            CP      NO
 316+ 890C 28 10            JR      Z, .CheckFirstKickCpuTeam
 317+ 890E 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 318+ 8911 FE 02            CP      GAME_MODE_2_PLAYERS
 319+ 8913 CA 89 87         JP      Z, .ReadKeyBoard
 320+ 8916 3A 70 86         LD      A,(Var_Game_FirstKickType)
 321+ 8919 FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 322+ 891B CA 89 87         JP      Z, .ReadKeyBoard
 323+ 891E              .CheckFirstKickCpuTeam:
 324+ 891E 3A 71 86         LD      A, (Var_Game_FirstKickFrameCounter)
 325+ 8921 3C               INC     A
 326+ 8922 32 71 86         LD      (Var_Game_FirstKickFrameCounter), A
 327+ 8925 FE 1E            CP      BLINK_FRAMES_DURATION
 328+ 8927 C2 C7 87         JP      NZ, .Exit
 329+ 892A 3A 47 86         LD      A, (Var_Game_SecondsToPlay)
 330+ 892D 32 63 86         LD      (Var_Game_TimeToPlay),A
 331+ 8930 3A 70 86         LD      A, (Var_Game_FirstKickType)
 332+ 8933 FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 333+ 8935 CA A0 A6         JP      Z, Resume_WhiteKickoff.exec
 334+ 8938 FE 02            CP      FIRST_KICK_TYPE_BLACK_HALF_FIELD
 335+ 893A CA 5D A6         JP      Z, Resume_BlackKickoff.exec
 336+ 893D FE 03            CP      FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
 337+ 893F CA CD A5         JP      Z, Resume_WhiteGoalKick.exec
 338+ 8942 FE 04            CP      FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
 339+ 8944 CA 1A A6         JP      Z, Resume_BlackGoalKick.exec
 340+ 8947 C3 C7 87         JP       .Exit
 341+ 894A              .ChangeGameSelectedMode:
 342+ 894A 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 343+ 894D FE 01            CP      GAME_MODE_1_PLAYER
 344+ 894F 28 0E            JR      Z, .ChangeGameSelectedModeToGAME_MODE_2_PLAYERS
 345+ 8951              .ChangeGameSelectedModeToCPU:
 346+ 8951 3E 01            LD      A, GAME_MODE_1_PLAYER
 347+ 8953 32 6E 86         LD      (Var_Game_SelectedPlayers), A
 348+ 8956 CD 2F 9D         CALL    Menu_ShowOptions
 349+ 8959 CD F8 9F         CALL    Utils_PlayBeep
 350+ 895C C3 C7 87         JP      .Exit
 351+ 895F              .ChangeGameSelectedModeToGAME_MODE_2_PLAYERS:
 352+ 895F 3E 02            LD      A, GAME_MODE_2_PLAYERS
 353+ 8961 32 6E 86         LD      (Var_Game_SelectedPlayers), A
 354+ 8964 CD 2F 9D         CALL    Menu_ShowOptions
 355+ 8967 CD F8 9F         CALL    Utils_PlayBeep
 356+ 896A C3 C7 87         JP      .Exit
 357+ 896D              .LevelDown:
 358+ 896D 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 359+ 8970 FE 02            CP      GAME_MODE_2_PLAYERS
 360+ 8972 CA F0 9D         JP      Z, Menu_ShowOptions.Level1
 361+ 8975 3A 48 86         LD      A, (Var_Game_SelectedLevel)
 362+ 8978 FE 01            CP      1
 363+ 897A CA C7 87         JP      Z, .Exit
 364+ 897D 3D               DEC     A
 365+ 897E 32 48 86         LD      (Var_Game_SelectedLevel), A
 366+ 8981 CD F0 9D         CALL    Menu_ShowOptions.Level1
 367+ 8984 CD F8 9F         CALL    Utils_PlayBeep
 368+ 8987 C3 C7 87         JP      .Exit
 369+ 898A              .LevelUp:
 370+ 898A 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 371+ 898D FE 02            CP      GAME_MODE_2_PLAYERS
 372+ 898F CA F0 9D         JP      Z, Menu_ShowOptions.Level1
 373+ 8992 3A 48 86         LD      A, (Var_Game_SelectedLevel)
 374+ 8995 FE 05            CP      5
 375+ 8997 CA C7 87         JP      Z, .Exit
 376+ 899A 3C               INC     A
 377+ 899B 32 48 86         LD      (Var_Game_SelectedLevel), A
 378+ 899E CD F0 9D         CALL    Menu_ShowOptions.Level1
 379+ 89A1 CD F8 9F         CALL    Utils_PlayBeep
 380+ 89A4 C3 C7 87         JP      .Exit
 381+ 89A7              .CheckGameResumeWaiting:
 382+ 89A7 3A B3 86         LD      A, (Var_Hooks_FrameCounter)
 383+ 89AA FE 1E            CP      BLINK_FRAMES_DURATION
 384+ 89AC C2 C7 87         JP      NZ, .Exit
 385+ 89AF 3E 00            LD      A, NO
 386+ 89B1 32 BA 86         LD      (Var_Hooks_GameResumingWaiting), A
 387+ 89B4 CD 6D A5         CALL    Game_Resume
 388+ 89B7 CD 15 9B         CALL    VDP_PlayerMatrixRedraw
 389+ 89BA C3 C7 87         JP      .Exit
 390+ 89BD              .ShowGoalCeromony:
 391+ 89BD 3A BB 86         LD      A, (Var_Hooks_CerimonySpeedCounter)
 392+ 89C0 3C               INC     A
 393+ 89C1 32 BB 86         LD      (Var_Hooks_CerimonySpeedCounter), A
 394+ 89C4 FE 14            CP      CERIMONY_MOVEMENT_SPEED
 395+ 89C6 C2 C7 87         JP      NZ, .Exit
 396+ 89C9 AF               XOR     A
 397+ 89CA 32 BB 86         LD      (Var_Hooks_CerimonySpeedCounter), A
 398+ 89CD 3A C2 86         LD      A,(Var_Hooks_GoalCerimonyCounter)
 399+ 89D0 3D               DEC     A
 400+ 89D1 32 C2 86         LD      (Var_Hooks_GoalCerimonyCounter), A
 401+ 89D4 3E 01            LD      A, TEAM_WHITE
 402+ 89D6 47               LD      B, A
 403+ 89D7 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
 404+ 89DA FE 01            CP      FIELD_NORTH_SIDE
 405+ 89DC 28 03            JR      Z, .ShowGoalCerimonyTeamSelected
 406+ 89DE 3E 00            LD      A, TEAM_BLACK
 407+ 89E0 47               LD      B, A
 408+ 89E1              .ShowGoalCerimonyTeamSelected:
 409+ 89E1 3A C2 86         LD      A,(Var_Hooks_GoalCerimonyCounter)
 410+ 89E4 CD 68 B4         CALL    Game_GoalCelebration_DrawFrame
 411+ 89E7
 412+ 89E7 3A C2 86         LD      A,(Var_Hooks_GoalCerimonyCounter)
 413+ 89EA FE 00            CP      0
 414+ 89EC C2 C7 87         JP      NZ,.Exit
 415+ 89EF 3E FF            LD      A, NO_VALUE
 416+ 89F1 32 C2 86         LD      (Var_Hooks_GoalCerimonyCounter), A
 417+ 89F4 C3 C7 87         JP      .Exit
 418+ 89F7              .StartGame:
 419+ 89F7 3E FF            LD      A,NO_VALUE
 420+ 89F9 32 70 86         LD      (Var_Game_FirstKickType), A
 421+ 89FC 3E 00            LD      A, NO
 422+ 89FE 32 BC 86         LD      (Var_Hooks_BlinkingIsActive), A
 423+ 8A01 32 BA 86         LD      (Var_Hooks_GameResumingWaiting), A
 424+ 8A04 CD BB AA         CALL    Game_StopShot
 425+ 8A07 3E 00            LD      A, NO
 426+ 8A09 32 C0 86         LD      (Var_Hooks_ForceVdpRedraw), A
 427+ 8A0C 3A 48 86         LD      A, (Var_Game_SelectedLevel)
 428+ 8A0F 32 6C 86         LD      (Var_Game_PlayersSpeed), A
 429+ 8A12 3E 3C            LD      A, MATCH_TIME
 430+ 8A14 32 63 86         LD      (Var_Game_TimeToPlay), A
 431+ 8A17 CD 13 8E         CALL    Hooks_UpdateTimeToPlay
 432+ 8A1A AF               XOR     A
 433+ 8A1B 32 C2 86         LD      (Var_Hooks_GoalCerimonyCounter), A
 434+ 8A1E 32 4D 86         LD      (Var_Game_BallUpdateTimer), A
 435+ 8A21 32 62 86         LD      (Var_Game_ScoreWhite), A
 436+ 8A24 32 55 86         LD      (Var_Game_ScoreBlack), A
 437+ 8A27 CD A9 9C         CALL    VDP_ClearMenuSideArea
 438+ 8A2A 3E 01            LD      A, YES
 439+ 8A2C 32 6B 86         LD      (Var_Game_MatchInProgress), A
 440+ 8A2F CD BB 9C         CALL    VDP_ShowScores
 441+ 8A32 CD 77 B0         CALL    Game_Start
 442+ 8A35 CD EF 8A         CALL    UpdateMatchTime
 443+ 8A38 C3 C7 87         JP      .Exit
 444+ 8A3B              .CheckBlinkingState:
 445+ 8A3B CD F7 86         CALL    Hooks_TickStop
 446+ 8A3E 3A BD 86         LD      A, (Var_Hooks_BlinkingMustResetFrameCounter)
 447+ 8A41 FE 00            CP      NO
 448+ 8A43 CA 4A 8A         JP      Z,.CheckBlinkingStateAfterReset
 449+ 8A46 AF               XOR     A
 450+ 8A47 32 B3 86         LD      (Var_Hooks_FrameCounter), A
 451+ 8A4A              .CheckBlinkingStateAfterReset:
 452+ 8A4A 3A B3 86         LD      A, (Var_Hooks_FrameCounter)
 453+ 8A4D FE 1E            CP      BLINK_FRAMES_DURATION
 454+ 8A4F CA 5A 8A         JP      Z,.CheckBlinkingStateContinue
 455+ 8A52 3E 00            LD      A, NO
 456+ 8A54 32 BD 86         LD      (Var_Hooks_BlinkingMustResetFrameCounter), A
 457+ 8A57 C3 C7 87         JP      .Exit
 458+ 8A5A              .CheckBlinkingStateContinue:
 459+ 8A5A 3E 01            LD      A, YES
 460+ 8A5C 32 BD 86         LD      (Var_Hooks_BlinkingMustResetFrameCounter), A
 461+ 8A5F 3A B9 86         LD      A, (Var_Hooks_BlinkingCounter)
 462+ 8A62 3C               INC     A
 463+ 8A63 32 B9 86         LD      (Var_Hooks_BlinkingCounter), A
 464+ 8A66 FE 07            CP      7
 465+ 8A68 28 21            JR      Z,.CheckBlinkingStateStop
 466+ 8A6A 3A B6 86         LD      A, (Var_Hooks_BlinkingTileToShow)
 467+ 8A6D 47               LD      B, A
 468+ 8A6E 3A B8 86         LD      A, (Var_Hooks_BlinkingActiveTile)
 469+ 8A71 B8               CP      B
 470+ 8A72 20 04            JR      NZ, .CheckBlinkingStateShowTile
 471+ 8A74 3A B7 86         LD      A, (Var_Hooks_BlinkingTileToHide)
 472+ 8A77 47               LD      B, A
 473+ 8A78              .CheckBlinkingStateShowTile:
 474+ 8A78 78               LD      A, B
 475+ 8A79 32 B8 86         LD      (Var_Hooks_BlinkingActiveTile), A
 476+ 8A7C CD FD A1         CALL    Game_GetBallPosition
 477+ 8A7F CD 8F 9A         CALL    VDP_MapMatrixToScreen_DE
 478+ 8A82 3A B8 86         LD      A, (Var_Hooks_BlinkingActiveTile)
 479+ 8A85 CD BC 95         CALL    VDP_DrawSprite
 480+ 8A88 C3 C7 87         JP      .Exit
 481+ 8A8B              .CheckBlinkingStateStop:
 482+ 8A8B 3E 00            LD      A, NO
 483+ 8A8D 32 BC 86         LD      (Var_Hooks_BlinkingIsActive), A
 484+ 8A90 3A B5 86         LD      A, (Var_Hooks_BlinkingType)
 485+ 8A93 FE 01            CP      BLINK_TYPE_GOAL
 486+ 8A95 28 0F            JR      Z, .GoalCerimony
 487+ 8A97 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
 488+ 8A9A FE 01            CP      FIELD_NORTH_SIDE
 489+ 8A9C 20 17            JR      NZ,.CheckBlinkingRestartAfterNoGoalFromSouth
 490+ 8A9E CD A6 97         CALL    VDP_DrawField
 491+ 8AA1 CD 58 A4         CALL    SetBlackRestartSchema
 492+ 8AA4 18 3A            JR     .CheckBlinkingRestartResume
 493+ 8AA6              .GoalCerimony:
 494+ 8AA6 AF               XOR   A
 495+ 8AA7 32 BB 86         LD    (Var_Hooks_CerimonySpeedCounter), A
 496+ 8AAA CD AA B0         CALL  Game_ClearGameFieldForGoalCerimony
 497+ 8AAD 3E 09            LD    A, 9
 498+ 8AAF 32 C2 86         LD    (Var_Hooks_GoalCerimonyCounter), A
 499+ 8AB2 C3 C7 87         JP    .Exit
 500+ 8AB5              .CheckBlinkingRestartAfterNoGoalFromSouth:
 501+ 8AB5 CD A6 97         CALL    VDP_DrawField
 502+ 8AB8 CD E3 A4         CALL    SetWhiteRestartSchema
 503+ 8ABB 18 23            JR     .CheckBlinkingRestartResume
 504+ 8ABD              .CheckBlinkingRestartAfterGoal:
 505+ 8ABD AF               XOR     A
 506+ 8ABE 32 C2 86         LD      (Var_Hooks_GoalCerimonyCounter), A
 507+ 8AC1 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
 508+ 8AC4 FE 01            CP      FIELD_NORTH_SIDE
 509+ 8AC6 28 0D            JR      Z, .CheckBlinkingRestartAfterGoalFromSouth
 510+ 8AC8 3E 01            LD      A, FIELD_NORTH_SIDE
 511+ 8ACA 32 46 86         LD      (Var_Game_ActiveFieldSide), A
 512+ 8ACD CD A6 97         CALL    VDP_DrawField
 513+ 8AD0 CD 4D A3         CALL    Game_SetWhiteKickoffSchema
 514+ 8AD3 18 0B            JR      .CheckBlinkingRestartResume
 515+ 8AD5              .CheckBlinkingRestartAfterGoalFromSouth:
 516+ 8AD5 3E 00            LD      A, FIELD_SOUTH_SIDE
 517+ 8AD7 32 46 86         LD      (Var_Game_ActiveFieldSide), A
 518+ 8ADA CD A6 97         CALL    VDP_DrawField
 519+ 8ADD CD D2 A3         CALL    Game_SetBlackKickoffSchema
 520+ 8AE0              .CheckBlinkingRestartResume:
 521+ 8AE0 CD 15 9B         CALL   VDP_PlayerMatrixRedraw
 522+ 8AE3 AF               XOR    A
 523+ 8AE4 32 B3 86         LD     (Var_Hooks_FrameCounter), A
 524+ 8AE7 3E 01            LD     A, YES
 525+ 8AE9 32 BA 86         LD     (Var_Hooks_GameResumingWaiting), A
 526+ 8AEC C3 C7 87         JP     .Exit
 527+ 8AEF
 528+ 8AEF              UpdateMatchTime:
 529+ 8AEF 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
 530+ 8AF2 FE 00            CP      NO
 531+ 8AF4 C8               RET     Z
 532+ 8AF5 E5               PUSH    HL
 533+ 8AF6 D5               PUSH    DE
 534+ 8AF7 C5               PUSH    BC
 535+ 8AF8 3A 63 86         LD      A, (Var_Game_TimeToPlay)
 536+ 8AFB
 537+ 8AFB FE FF            CP      255
 538+ 8AFD CA 93 AD         JP      Z,  Game_GameOver
 539+ 8B00 11 3E 86         LD      DE, Var_Utils_NumberToPrint
 540+ 8B03 26 00            LD      H, 0
 541+ 8B05 6F               LD      L, A
 542+ 8B06 CD 6A 9F         CALL    String_NumberToASCII
 543+ 8B09 21 3E 86         LD      HL, Var_Utils_NumberToPrint
 544+ 8B0C CD 8E 9F         CALL    String_RemoveLeadingZeros
 545+ 8B0F 21 3E 86         LD      HL, Var_Utils_NumberToPrint
 546+ 8B12 16 01            LD      D, 1
 547+ 8B14 1E 1A            LD      E, 26
 548+ 8B16 CD 1A 95         CALL    VDP_PrintString
 549+ 8B19 C1               POP     BC
 550+ 8B1A D1               POP     DE
 551+ 8B1B E1               POP     HL
 552+ 8B1C C9               RET
 553+ 8B1D
 554+ 8B1D
 555+ 8B1D              ;----------------------------------------------------------------------------
 556+ 8B1D              ; AiTick
 557+ 8B1D              ;----------------------------------------------------------------------------
 558+ 8B1D              AiTick:
 559+ 8B1D F5               push af
 560+ 8B1E C5               push bc
 561+ 8B1F D5               push de
 562+ 8B20 E5               push hl
 563+ 8B21
 564+ 8B21 3A C0 86         ld  a,(Var_Hooks_ForceVdpRedraw)
 565+ 8B24 FE 01            cp  YES
 566+ 8B26 28 7C            jr  z, .done
 567+ 8B28
 568+ 8B28 CD 90 A0         call Game_UpdateBallMovement
 569+ 8B2B
 570+ 8B2B 3A C1 86         ld  a,(Var_Hooks_TickSpeed)
 571+ 8B2E 47               ld  b, a
 572+ 8B2F 3A C3 86         ld  a, (Var_Hooks_TickCounter)
 573+ 8B32 3C               inc a
 574+ 8B33 32 C3 86         ld  (Var_Hooks_TickCounter), a
 575+ 8B36 B8               cp  b
 576+ 8B37 20 6B            jr  nz, .done
 577+ 8B39
 578+ 8B39 AF               xor a
 579+ 8B3A 32 C3 86         ld  (Var_Hooks_TickCounter), a
 580+ 8B3D
 581+ 8B3D 3A 6C 86         ld   a,(Var_Game_PlayersSpeed)
 582+ 8B40 FE 01            cp   1
 583+ 8B42 30 02            jr   nc,.speed_ok
 584+ 8B44 3E 01            ld   a,1
 585+ 8B46              .speed_ok:
 586+ 8B46 FE 05            cp   5
 587+ 8B48 38 02            jr   c,.speed_ok2
 588+ 8B4A 3E 05            ld   a,5
 589+ 8B4C              .speed_ok2:
 590+ 8B4C 47               ld   b,a
 591+ 8B4D 3E 06            ld   a,6
 592+ 8B4F 90               sub  b
 593+ 8B50 47               ld   b,a                 ; B = delay (1..5)
 594+ 8B51
 595+ 8B51                  ; --- controlla se siamo in demo (match non in corso) ---
 596+ 8B51 3A 6B 86         ld   a,(Var_Game_MatchInProgress)
 597+ 8B54 FE 00            cp   NO
 598+ 8B56 28 0D            jr   z,.demo_mode
 599+ 8B58
 600+ 8B58                  ; --- partita normale ---
 601+ 8B58 3A 6E 86         ld   a,(Var_Game_SelectedPlayers)
 602+ 8B5B FE 01            cp   GAME_MODE_1_PLAYER
 603+ 8B5D 28 2E            jr   z,.one_player_mode
 604+ 8B5F FE 02            cp   GAME_MODE_2_PLAYERS
 605+ 8B61 28 3F            jr   z,.two_players_mode
 606+ 8B63 18 3F            jr   .done               ; modalità sconosciuta? non fare nulla
 607+ 8B65
 608+ 8B65              ; ---- DEMO: entrambe le squadre CPU --------------------------------
 609+ 8B65              .demo_mode:
 610+ 8B65                  ; TEAM_BLACK
 611+ 8B65 3A B4 86         ld   a,(Var_Hooks_AiCounterBlack)
 612+ 8B68 3C               inc  a
 613+ 8B69 32 B4 86         ld   (Var_Hooks_AiCounterBlack),a   ; <-- SALVA SEMPRE DOPO INC
 614+ 8B6C B8               cp   b
 615+ 8B6D 38 09            jr   c,.skip_black_demo
 616+ 8B6F AF               xor  a
 617+ 8B70 32 B4 86         ld   (Var_Hooks_AiCounterBlack),a   ; reset contatore
 618+ 8B73 06 00            ld   b,TEAM_BLACK
 619+ 8B75 CD A9 8B         call AiUpdateTeam
 620+ 8B78              .skip_black_demo:
 621+ 8B78
 622+ 8B78                  ; TEAM_WHITE
 623+ 8B78 3A CA 86         ld   a,(Var_Hooks_AiCounterWhite)
 624+ 8B7B 3C               inc  a
 625+ 8B7C 32 CA 86         ld   (Var_Hooks_AiCounterWhite),a   ; <-- SALVA SEMPRE DOPO INC
 626+ 8B7F B8               cp   b
 627+ 8B80 38 09            jr   c,.skip_white_demo
 628+ 8B82 AF               xor  a
 629+ 8B83 32 CA 86         ld   (Var_Hooks_AiCounterWhite),a   ; reset contatore
 630+ 8B86 06 01            ld   b,TEAM_WHITE
 631+ 8B88 CD A9 8B         call AiUpdateTeam
 632+ 8B8B              .skip_white_demo:
 633+ 8B8B 18 17            jr   .done
 634+ 8B8D
 635+ 8B8D              ; ---- 1 PLAYER: CPU controlla solo i NERI --------------------------
 636+ 8B8D              .one_player_mode:
 637+ 8B8D                  ; TEAM_BLACK CPU
 638+ 8B8D 3A B4 86         ld   a,(Var_Hooks_AiCounterBlack)
 639+ 8B90 3C               inc  a
 640+ 8B91 32 B4 86         ld   (Var_Hooks_AiCounterBlack),a   ; <-- SALVA SEMPRE DOPO INC
 641+ 8B94 B8               cp   b
 642+ 8B95 38 09            jr   c,.skip_black_1p
 643+ 8B97 AF               xor  a
 644+ 8B98 32 B4 86         ld   (Var_Hooks_AiCounterBlack),a   ; reset contatore
 645+ 8B9B 06 00            ld   b,TEAM_BLACK
 646+ 8B9D CD A9 8B         call AiUpdateTeam
 647+ 8BA0              .skip_black_1p:
 648+ 8BA0 18 02            jr   .done
 649+ 8BA2
 650+ 8BA2              ; ---- 2 PLAYERS: nessuna CPU --------------------------------------
 651+ 8BA2              .two_players_mode:
 652+ 8BA2                  ; niente
 653+ 8BA2 18 00            jr   .done
 654+ 8BA4
 655+ 8BA4              .done:
 656+ 8BA4 E1               pop  hl
 657+ 8BA5 D1               pop  de
 658+ 8BA6 C1               pop  bc
 659+ 8BA7 F1               pop  af
 660+ 8BA8 C9               ret
 661+ 8BA9
 662+ 8BA9
 663+ 8BA9              ; ---------------------------------------------------------------------------
 664+ 8BA9              ; AiUpdateTeam
 665+ 8BA9              ;
 666+ 8BA9              ; INPUT:
 667+ 8BA9              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 668+ 8BA9              ;
 669+ 8BA9              ; Usa:
 670+ 8BA9              ;   Game_GetPlayerIdWithBall
 671+ 8BA9              ;   AiUpdateGoalkeeper
 672+ 8BA9              ;   AiMoveChaserTowardBall
 673+ 8BA9              ;   AiBallCarrierDecision
 674+ 8BA9              ;   AiVerticalAdjustments
 675+ 8BA9              ;
 676+ 8BA9              ; Convenzioni Game_GetPlayerIdWithBall:
 677+ 8BA9              ;   A = stato/team:
 678+ 8BA9              ;       BALL_STATUS_MOVING
 679+ 8BA9              ;       BALL_STATUS_FREE
 680+ 8BA9              ;       BALL_STATUS_CONTENDED
 681+ 8BA9              ;       TEAM_BLACK / TEAM_WHITE (se una squadra ha il possesso)
 682+ 8BA9              ;   H = ID giocatore in possesso (o 255 se nessuno)
 683+ 8BA9              ;   L = ID contendente (o 255 se nessuno)
 684+ 8BA9              ; ---------------------------------------------------------------------------
 685+ 8BA9              AiUpdateTeam:
 686+ 8BA9 F5               push af
 687+ 8BAA C5               push bc
 688+ 8BAB D5               push de
 689+ 8BAC E5               push hl
 690+ 8BAD
 691+ 8BAD                  ; Salva TEAM di input
 692+ 8BAD 48               ld   c,b                 ; C = TEAM_ORIG
 693+ 8BAE C5               PUSH  BC
 694+ 8BAF                  ; Chi ha la palla?
 695+ 8BAF CD 01 A7         call Game_GetPlayerIdWithBall
 696+ 8BB2                  ; A = stato/team, H = ownerID (o 255), L = contenderID (o 255)
 697+ 8BB2 C1               POP   BC
 698+ 8BB3
 699+ 8BB3
 700+ 8BB3 5C               ld   e,h                 ; E = ownerID (se esiste)
 701+ 8BB4 57               ld   d,a                 ; D = stato/team
 702+ 8BB5                  ; --- caso: palla in movimento ---------------------------------
 703+ 8BB5
 704+ 8BB5 FE 64            cp   BALL_STATUS_MOVING
 705+ 8BB7 20 02            jr   nz, .chk_contended
 706+ 8BB9
 707+ 8BB9                  ; palla che viaggia: portiere si aggiusta un po', niente altro
 708+ 8BB9                  ;;call AiUpdateGoalkeeper
 709+ 8BB9 18 2D            jr   .done
 710+ 8BBB
 711+ 8BBB              .chk_contended:
 712+ 8BBB
 713+ 8BBB FE 65            cp   BALL_STATUS_CONTENDED
 714+ 8BBD 20 08            jr   nz, .chk_free
 715+ 8BBF
 716+ 8BBF                  ; palla contesa: per ora ci comportiamo come se fosse “palla libera”
 717+ 8BBF
 718+ 8BBF                  ;;call AiUpdateGoalkeeper
 719+ 8BBF CD 3C 8C         call AiMoveChaserTowardBall
 720+ 8BC2 CD 7C 8D         call AiVerticalAdjustments
 721+ 8BC5 18 21            jr   .done
 722+ 8BC7
 723+ 8BC7              .chk_free:
 724+ 8BC7
 725+ 8BC7 FE 66            cp   BALL_STATUS_FREE
 726+ 8BC9 20 08            jr   nz, .chk_team_possession
 727+ 8BCB
 728+ 8BCB                  ;; palla libera
 729+ 8BCB                  ;;call AiUpdateGoalkeeper
 730+ 8BCB CD 3C 8C         call AiMoveChaserTowardBall
 731+ 8BCE CD 7C 8D         call AiVerticalAdjustments
 732+ 8BD1 18 15            jr   .done
 733+ 8BD3
 734+ 8BD3              ; -------------------------------------------------------------------
 735+ 8BD3              ; Qui A (=D) è o TEAM_BLACK o TEAM_WHITE: una squadra ha il possesso
 736+ 8BD3              ; -------------------------------------------------------------------
 737+ 8BD3              .chk_team_possession:
 738+ 8BD3                  ; Se D == TEAM_ORIG -> la nostra squadra ha la palla
 739+ 8BD3 7A               ld   a,d                 ; team che ha la palla
 740+ 8BD4 B8               cp   b                   ; confronta con TEAM_ORIG
 741+ 8BD5 20 09            jr   nz, .enemy_has_ball
 742+ 8BD7
 743+ 8BD7                  ; === noi abbiamo la palla ===
 744+ 8BD7                  ; E = ownerID
 745+ 8BD7                  ;ld   b,c                 ; B = TEAM_ORIG
 746+ 8BD7 4B               ld   c,e                 ; C = ID portatore
 747+ 8BD8
 748+ 8BD8                  ; portiere
 749+ 8BD8                  ;;call AiUpdateGoalkeeper
 750+ 8BD8                  ; decisione portatore (muoversi / tirare / ecc.)
 751+ 8BD8 CD 3B 8D         call AiBallCarrierDecision
 752+ 8BDB                  ; opzionale: piccoli aggiustamenti verticali anche dei non portatori
 753+ 8BDB CD 7C 8D         call AiVerticalAdjustments
 754+ 8BDE 18 08            jr   .done
 755+ 8BE0
 756+ 8BE0              .enemy_has_ball:
 757+ 8BE0                  ; === l'altra squadra ha la palla ===
 758+ 8BE0                  ;ld   b,c                 ; B = TEAM_ORIG
 759+ 8BE0                  ;;call AiUpdateGoalkeeper
 760+ 8BE0 CD 3C 8C         call AiMoveChaserTowardBall
 761+ 8BE3 CD 7C 8D         call AiVerticalAdjustments
 762+ 8BE6 18 00            jr   .done
 763+ 8BE8
 764+ 8BE8              .done:
 765+ 8BE8 E1               pop  hl
 766+ 8BE9 D1               pop  de
 767+ 8BEA C1               pop  bc
 768+ 8BEB F1               pop  af
 769+ 8BEC C9               ret
 770+ 8BED
 771+ 8BED
 772+ 8BED              ; ---------------------------------------------------------------------------
 773+ 8BED              ; AiUpdateGoalkeeper
 774+ 8BED              ;
 775+ 8BED              ; INPUT:
 776+ 8BED              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 777+ 8BED              ;
 778+ 8BED              ; Logica:
 779+ 8BED              ;   - legge posizione palla
 780+ 8BED              ;   - targetX:
 781+ 8BED              ;       if 1..3 -> ballX
 782+ 8BED              ;       else    -> 2
 783+ 8BED              ;   - trova portiere (ID=0) con Game_GetPlayerInfoById
 784+ 8BED              ;   - con una certa probabilità (dipendente da Var_Game_PlayersSpeed)
 785+ 8BED              ;     prova a muovere il portiere orizzontalmente verso targetX.
 786+ 8BED              ; ---------------------------------------------------------------------------
 787+ 8BED              AiUpdateGoalkeeper:
 788+ 8BED F5               push af
 789+ 8BEE C5               push bc
 790+ 8BEF D5               push de
 791+ 8BF0 E5               push hl
 792+ 8BF1
 793+ 8BF1                  ; salvati il team
 794+ 8BF1 48               ld   c,b                 ; C = TEAM
 795+ 8BF2
 796+ 8BF2                  ; posizione palla
 797+ 8BF2 CD FD A1         call Game_GetBallPosition ; HL = X,Y  (H=Y, L=X)
 798+ 8BF5 D5               PUSH DE
 799+ 8BF6 E1               POP  HL
 800+ 8BF7
 801+ 8BF7                  ; targetX = (1..3 ? ballX : 2)
 802+ 8BF7 FE 01            cp   1
 803+ 8BF9 38 07            jr   c,.use_center
 804+ 8BFB FE 04            cp   4
 805+ 8BFD 30 03            jr   nc,.use_center
 806+ 8BFF 53               ld   d,e                 ; D = targetX = ballX
 807+ 8C00 18 02            jr   .got_target
 808+ 8C02
 809+ 8C02              .use_center:
 810+ 8C02 16 02            ld   d,2                 ; targetX = 2
 811+ 8C04
 812+ 8C04              .got_target:
 813+ 8C04                  ; prendi posizione portiere (ID=0)
 814+ 8C04 41               ld   b,c                 ; B = TEAM
 815+ 8C05 0E 00            ld   c,0                 ; ID = 0
 816+ 8C07 CD C4 A2         call Game_GetPlayerInfoById
 817+ 8C0A                  ; HL = curr (H=Y, L=X)
 818+ 8C0A 7D               ld   a,l                 ; goalieX
 819+ 8C0B 5F               ld   e,a                 ; E = goalieX
 820+ 8C0C
 821+ 8C0C                  ; se già in colonna giusta → niente
 822+ 8C0C 7B               ld   a,e
 823+ 8C0D BA               cp   d
 824+ 8C0E 28 1F            jr   z,.done
 825+ 8C10
 826+ 8C10                  ; probabilità di muoversi dipendente da Var_Game_PlayersSpeed
 827+ 8C10 C5               push bc
 828+ 8C11 CD D9 A6         call Game_GetRandomByte
 829+ 8C14 C1               pop  bc
 830+ 8C15 E6 0F            and  00001111b           ; 0..15
 831+ 8C17 67               ld   h,a
 832+ 8C18 3A 6C 86         ld   a,(Var_Game_PlayersSpeed) ; 1..5
 833+ 8C1B                  ; più alto => più facile che H < soglia
 834+ 8C1B C6 03            add  a,3                 ; speed 1..5 -> soglia 4..8
 835+ 8C1D BC               cp   h
 836+ 8C1E 38 0F            jr   c,.done             ; random >= soglia -> non si muove
 837+ 8C20
 838+ 8C20                  ; decide direzione verso targetX
 839+ 8C20 7B               ld   a,e                 ; goalieX
 840+ 8C21 BA               cp   d                   ; targetX
 841+ 8C22 38 02            jr   c,.move_east
 842+ 8C24 18 04            jr   .move_west
 843+ 8C26
 844+ 8C26              .move_east:
 845+ 8C26 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
 846+ 8C28 18 02            jr   .do_move
 847+ 8C2A
 848+ 8C2A              .move_west:
 849+ 8C2A 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
 850+ 8C2C
 851+ 8C2C              .do_move:
 852+ 8C2C                  ; A = dir, B = TEAM, C = 0 (portiere)
 853+ 8C2C CD 20 AB         call Game_TryMovePlayerHorizontally
 854+ 8C2F                  ; ignoriamo SUCCESS/FAILURE
 855+ 8C2F              .done:
 856+ 8C2F E1               pop  hl
 857+ 8C30 D1               pop  de
 858+ 8C31 C1               pop  bc
 859+ 8C32 F1               pop  af
 860+ 8C33 C9               ret
 861+ 8C34              ;---------------------------------------------------------------------------
 862+ 8C34              ; Hooks_InitAICounters
 863+ 8C34              ;---------------------------------------------------------------------------
 864+ 8C34              Hooks_InitAICounters:
 865+ 8C34 AF               xor  a
 866+ 8C35 32 B4 86         ld   (Var_Hooks_AiCounterBlack),a
 867+ 8C38 32 CA 86         ld   (Var_Hooks_AiCounterWhite),a
 868+ 8C3B C9               ret
 869+ 8C3C              ; ---------------------------------------------------------------------------
 870+ 8C3C              ; AiMoveChaserTowardBall
 871+ 8C3C              ;
 872+ 8C3C              ; INPUT:
 873+ 8C3C              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 874+ 8C3C              ;
 875+ 8C3C              ; Logica:
 876+ 8C3C              ;   - calcola ballY/ballX
 877+ 8C3C              ;   - riga target per cercare un "chaser":
 878+ 8C3C              ;       * TEAM_BLACK:   stessa riga della palla
 879+ 8C3C              ;       * TEAM_WHITE:   riga della palla + 1 (se <=4), altrimenti riga palla
 880+ 8C3C              ;   - Scorre ID=0..3 e memorizza il giocatore di quella riga più vicino
 881+ 8C3C              ;     in X alla palla.
 882+ 8C3C              ;   - Con certa probabilità (dipendente da PlayersSpeed) lo muove di
 883+ 8C3C              ;     una cella a sinistra/destra verso la palla, usando
 884+ 8C3C              ;     Game_TryMovePlayerHorizontally.
 885+ 8C3C              ;   - Possibilità di restare fermo: più bassa a velocità alte.
 886+ 8C3C              ; ---------------------------------------------------------------------------
 887+ 8C3C              AiMoveChaserTowardBall:
 888+ 8C3C
 889+ 8C3C F5               push af
 890+ 8C3D C5               push bc
 891+ 8C3E D5               push de
 892+ 8C3F E5               push hl
 893+ 8C40
 894+ 8C40 C5               push bc
 895+ 8C41 CD 01 A7         CALL Game_GetPlayerIdWithBall
 896+ 8C44 C1               pop  bc
 897+ 8C45 FE 65            CP   BALL_STATUS_CONTENDED
 898+ 8C47 20 12            JR   NZ,.no_contended_ball
 899+ 8C49
 900+ 8C49 C5               push    bc
 901+ 8C4A
 902+ 8C4A CD FD A1         CALL    Game_GetBallPosition
 903+ 8C4D C1               pop     bc
 904+ 8C4E 62               ld      h, d
 905+ 8C4F 78               ld      a, b
 906+ 8C50 FE 01            cp      TEAM_WHITE
 907+ 8C52 20 01            jr      NZ,.contended_team_found
 908+ 8C54 24               inc     h
 909+ 8C55              .contended_team_found:
 910+ 8C55 54               ld     d, h
 911+ 8C56 CD DF A2         CALL   Game_GetPlayerInfoByPos
 912+ 8C59 18 4A            JR     .after_player_to_move_found
 913+ 8C5B
 914+ 8C5B
 915+ 8C5B
 916+ 8C5B              .no_contended_ball:
 917+ 8C5B 48               ld   c,b                 ; C = TEAM
 918+ 8C5C
 919+ 8C5C                  ; ball pos
 920+ 8C5C CD FD A1         call Game_GetBallPosition    ; HL = X,Y
 921+ 8C5F D5               PUSH DE
 922+ 8C60 E1               POP  HL
 923+ 8C61
 924+ 8C61                  ; riga su cui cercare chaser
 925+ 8C61 79               ld   a,c                 ; TEAM
 926+ 8C62 FE 01            cp   TEAM_WHITE
 927+ 8C64 20 0A            jr   nz,.use_same_row
 928+ 8C66
 929+ 8C66                  ; TEAM_WHITE: riga ballY+1 se <=4, altrimenti ballY
 930+ 8C66 7A               ld   a,d
 931+ 8C67 3C               inc  a
 932+ 8C68 FE 05            cp   5
 933+ 8C6A 38 01            jr   c,.set_target_row
 934+ 8C6C 7A               ld   a,d
 935+ 8C6D              .set_target_row:
 936+ 8C6D 57               ld   d,a                 ; D = targetRow
 937+ 8C6E 18 00            jr   .got_target_row
 938+ 8C70
 939+ 8C70              .use_same_row:
 940+ 8C70                  ; TEAM_BLACK: stessa riga palla
 941+ 8C70                  ; D è già ballY
 942+ 8C70              .got_target_row:
 943+ 8C70
 944+ 8C70
 945+ 8C70
 946+ 8C70
 947+ 8C70                  ; cerca il giocatore più vicino in X a ballX sulla riga D
 948+ 8C70 41               ld   b,c                 ; B = TEAM
 949+ 8C71 0E 00            ld   c,0                 ; ID = 0
 950+ 8C73 3E FF            ld   a,255               ; bestID = 255 (none)
 951+ 8C75 32 BF 86         ld   (Var_Hooks_BestDistanceX),a
 952+ 8C78 32 BE 86         ld   (Var_Hooks_BestDistanceId),a
 953+ 8C7B
 954+ 8C7B
 955+ 8C7B              .chaser_loop:
 956+ 8C7B
 957+ 8C7B C5               push bc
 958+ 8C7C D5               push de
 959+ 8C7D CD C4 A2         call Game_GetPlayerInfoById   ; HL = pos (H=Y, L=X)
 960+ 8C80 D1               pop  de
 961+ 8C81 C1               pop  bc
 962+ 8C82
 963+ 8C82 7C               ld   a,h                 ; currY
 964+ 8C83 BA               cp   d
 965+ 8C84 20 11            jr   nz,.next_id         ; non su riga target
 966+ 8C86
 967+ 8C86                  ; su riga target, calcola |X - ballX|
 968+ 8C86 7D               ld   a,l                 ; currX
 969+ 8C87 93               sub  e                   ; X - ballX
 970+ 8C88 F2 8D 8C         jp   p,.dist_ok
 971+ 8C8B ED 44            neg
 972+ 8C8D              .dist_ok:
 973+ 8C8D                  ; A = distanza
 974+ 8C8D BD               cp   l                   ; confronta con bestDist (L)
 975+ 8C8E 30 07            jr   nc,.next_id         ; se >= bestDist, tieni quello vecchio
 976+ 8C90
 977+ 8C90                  ; nuovo migliore
 978+ 8C90 32 BF 86         ld   (Var_Hooks_BestDistanceX),a                 ; bestDist = A
 979+ 8C93 79               ld   a,c
 980+ 8C94 32 BE 86         ld   (Var_Hooks_BestDistanceId),a                 ; bestID = C
 981+ 8C97
 982+ 8C97              .next_id:
 983+ 8C97 0C               inc  c
 984+ 8C98 79               ld   a,c
 985+ 8C99 FE 04            cp   4
 986+ 8C9B 20 DE            jr   nz,.chaser_loop
 987+ 8C9D
 988+ 8C9D                  ; se bestID=255 -> nessun giocatore su quella riga
 989+ 8C9D 3A BE 86         ld   a,(Var_Hooks_BestDistanceId)
 990+ 8CA0 FE FF            cp   255
 991+ 8CA2 C2 D7 8C         jp   nz,.good_player_found
 992+ 8CA5
 993+ 8CA5              .after_player_to_move_found:
 994+ 8CA5 3E 01            ld    a, 1
 995+ 8CA7 32 BE 86         ld    (Var_Hooks_BestDistanceId), a
 996+ 8CAA 0E 01            ld    c, 1
 997+ 8CAC D5               push  de
 998+ 8CAD C5               push  bc
 999+ 8CAE CD C4 A2         CALL  Game_GetPlayerInfoById
1000+ 8CB1 C1               pop   bc
1001+ 8CB2 D1               pop   de
1002+ 8CB3 7C               ld    a, h
1003+ 8CB4 BA               cp    d
1004+ 8CB5 28 20            JR    z, .good_player_found
1005+ 8CB7
1006+ 8CB7 3E 02            ld    a, 2
1007+ 8CB9 32 BE 86         ld    (Var_Hooks_BestDistanceId), a
1008+ 8CBC 0E 02            ld    c, 2
1009+ 8CBE D5               push  de
1010+ 8CBF C5               push  bc
1011+ 8CC0 CD C4 A2         CALL  Game_GetPlayerInfoById
1012+ 8CC3 C1               pop   bc
1013+ 8CC4 D1               pop   de
1014+ 8CC5 7C               ld    a, h
1015+ 8CC6 BA               cp    d
1016+ 8CC7 28 0E            JR    z, .good_player_found
1017+ 8CC9
1018+ 8CC9 3E 03            ld    a, 3
1019+ 8CCB 32 BE 86         ld    (Var_Hooks_BestDistanceId), a
1020+ 8CCE 0E 03            ld    c, 3
1021+ 8CD0 D5               push  de
1022+ 8CD1 C5               push  bc
1023+ 8CD2 CD C4 A2         CALL  Game_GetPlayerInfoById
1024+ 8CD5 C1               pop   bc
1025+ 8CD6 D1               pop   de
1026+ 8CD7
1027+ 8CD7
1028+ 8CD7              .good_player_found:
1029+ 8CD7                  ; --- decidi se muoverlo o lasciarlo fermo ---
1030+ 8CD7                  ; probabilità di muoversi ~ PlayersSpeed / 5
1031+ 8CD7 CD D9 A6         call Game_GetRandomByte
1032+ 8CDA E6 07            and  00000111b           ; 0..7
1033+ 8CDC 57               ld   d,a                 ; rand
1034+ 8CDD
1035+ 8CDD 3A 6C 86         ld   a,(Var_Game_PlayersSpeed)
1036+ 8CE0                  ; speed 1..5 -> soglia 1..5
1037+ 8CE0 BA               cp   d
1038+ 8CE1 38 53            jr   c,.done             ; rand > speed -> non si muove (resta fermo)
1039+ 8CE3
1040+ 8CE3 E5               push    hl
1041+ 8CE4 C5               push    bc
1042+ 8CE5 CD 01 A7         CALL    Game_GetPlayerIdWithBall
1043+ 8CE8 C1               pop     bc
1044+ 8CE9 E1               pop     hl
1045+ 8CEA FE 65            CP      BALL_STATUS_CONTENDED
1046+ 8CEC 20 0E            JR      NZ,.after_ball_contended_check
1047+ 8CEE
1048+ 8CEE CD FD A1         CALL    Game_GetBallPosition
1049+ 8CF1 78               LD      A, B
1050+ 8CF2 FE 01            CP      TEAM_WHITE
1051+ 8CF4 20 01            JR      NZ, .contended_get_player
1052+ 8CF6
1053+ 8CF6 14               INC     D
1054+ 8CF7
1055+ 8CF7                  ;JR      .done
1056+ 8CF7              .contended_get_player:
1057+ 8CF7                  ;push    bc
1058+ 8CF7 CD DF A2         call    Game_GetPlayerInfoByPos
1059+ 8CFA                  ;pop     bc
1060+ 8CFA 18 09            jr      .move_chaser
1061+ 8CFC
1062+ 8CFC
1063+ 8CFC              .after_ball_contended_check:
1064+ 8CFC                  ; --- NUCLEO PULITO PER LA PARTE FINALE ---
1065+ 8CFC                  ; B = TEAM (non toccato), H = bestID, E = ballX
1066+ 8CFC 3A BE 86         ld   a, (Var_Hooks_BestDistanceId)
1067+ 8CFF 4F               ld   c,a                 ; C = bestID
1068+ 8D00 C5               push bc
1069+ 8D01 CD C4 A2         call Game_GetPlayerInfoById   ; HL = curr pos
1070+ 8D04 C1               pop  bc                  ; B=TEAM, C=bestID
1071+ 8D05              .move_chaser:
1072+ 8D05 E5               push hl
1073+ 8D06 CD FD A1         CALL Game_GetBallPosition
1074+ 8D09 E1               pop hl
1075+ 8D0A 7D               ld   a,l                 ; currX
1076+ 8D0B BB               cp   e
1077+ 8D0C 28 0C            jr   z,.chaser_same_col
1078+ 8D0E 38 02            jr   c,.chaser_go_east   ; currX < ballX
1079+ 8D10 18 04            jr   .chaser_go_west     ; currX > ballX
1080+ 8D12
1081+ 8D12              .chaser_go_east:
1082+ 8D12 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1083+ 8D14 18 17            jr   .chaser_do_move
1084+ 8D16
1085+ 8D16              .chaser_go_west:
1086+ 8D16 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1087+ 8D18 18 13            jr   .chaser_do_move
1088+ 8D1A
1089+ 8D1A              .chaser_same_col:
1090+ 8D1A                  ; stessa colonna → 50% move left/right, 50% restare fermo
1091+ 8D1A C5               push bc
1092+ 8D1B CD DF A6         call Game_GetRandom0_4
1093+ 8D1E C1               pop  bc
1094+ 8D1F FE 00            cp  0
1095+ 8D21 28 13            jr  z,.done              ; 1/4 → fermo
1096+ 8D23
1097+ 8D23                  ;ld   a,l
1098+ 8D23                  ;cp   0
1099+ 8D23                  ;jr   z,.chaser_go_east
1100+ 8D23                  ;cp   4
1101+ 8D23                  ;jr   z,.chaser_go_west
1102+ 8D23              ;
1103+ 8D23                  ;push bc
1104+ 8D23                  ;call Game_GetRandom0_4
1105+ 8D23                  ;pop  bc
1106+ 8D23                  ;cp  0
1107+ 8D23                  ;jr  z,.chaser_go_west
1108+ 8D23 FE 01            cp  1
1109+ 8D25 28 EF            jr  z,.chaser_go_west
1110+ 8D27 FE 03            cp  3
1111+ 8D29 28 EB            jr  z,.chaser_go_west
1112+ 8D2B 18 E5            jr  .chaser_go_east
1113+ 8D2D
1114+ 8D2D              .chaser_do_move:
1115+ 8D2D CD F7 86         CALL Hooks_TickStop
1116+ 8D30 CD 20 AB         call Game_TryMovePlayerHorizontally
1117+ 8D33 CD EF 86         CALL Hooks_TickStart
1118+ 8D36                  ; ignoriamo SUCCESS/FAILURE
1119+ 8D36
1120+ 8D36              .done:
1121+ 8D36 E1               pop  hl
1122+ 8D37 D1               pop  de
1123+ 8D38 C1               pop  bc
1124+ 8D39 F1               pop  af
1125+ 8D3A C9               ret
1126+ 8D3B
1127+ 8D3B              ; ---------------------------------------------------------------------------
1128+ 8D3B              ; AiBallCarrierDecision
1129+ 8D3B              ;
1130+ 8D3B              ; INPUT:
1131+ 8D3B              ;   B = TEAM
1132+ 8D3B              ;   C = ID del portatore
1133+ 8D3B              ; ---------------------------------------------------------------------------
1134+ 8D3B              AiBallCarrierDecision:
1135+ 8D3B F5               push af
1136+ 8D3C C5               push bc
1137+ 8D3D D5               push de
1138+ 8D3E E5               push hl
1139+ 8D3F
1140+ 8D3F                  ; BC in ingresso: B = TEAM, C = ID del portatore
1141+ 8D3F 50               ld   d,b                 ; salva TEAM
1142+ 8D40 59               ld   e,c                 ; salva ID
1143+ 8D41
1144+ 8D41                  ; random 0..7
1145+ 8D41 CD F1 A6         CALL  Game_GetRandom0_20
1146+ 8D44 67               ld    h,a                 ; H = rand 0..7
1147+ 8D45
1148+ 8D45 3A 6C 86         ld   a,(Var_Game_PlayersSpeed)
1149+ 8D48 CB 27            SLA A
1150+ 8D4A CB 27            SLA A
1151+ 8D4C                  ; speed alta -> più probabilità di agire
1152+ 8D4C BC               cp   h
1153+ 8D4D 38 28            jr   c,.do_nothing       ; rand > speed -> sta fermo
1154+ 8D4F
1155+ 8D4F                  ; altrimenti sceglie azione:
1156+ 8D4F                  ;   0..2  -> tiro
1157+ 8D4F                  ;   3..4  -> move east
1158+ 8D4F                  ;   5..6  -> move west
1159+ 8D4F                  ;   7     -> tentativo verticale
1160+ 8D4F 7C               ld   a,h
1161+ 8D50 FE 02            cp   2
1162+ 8D52 38 0A            jr   c,.try_shot
1163+ 8D54 FE 05            cp   5
1164+ 8D56 38 0D            jr   c,.move_east
1165+ 8D58 FE 08            cp   8
1166+ 8D5A 38 12            jr   c,.move_west
1167+ 8D5C 18 19            jr   .done
1168+ 8D5E
1169+ 8D5E              .try_shot:
1170+ 8D5E 42               ld   b,d                 ; ripristina TEAM
1171+ 8D5F 4B               ld   c,e                 ; ripristina ID
1172+ 8D60 CD 71 A9         call Game_TryShot
1173+ 8D63 18 12            jr   .done
1174+ 8D65
1175+ 8D65              .move_east:
1176+ 8D65 42               ld   b,d
1177+ 8D66 4B               ld   c,e
1178+ 8D67 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1179+ 8D69 CD 20 AB         call Game_TryMovePlayerHorizontally
1180+ 8D6C 18 09            jr   .done
1181+ 8D6E
1182+ 8D6E              .move_west:
1183+ 8D6E 42               ld   b,d
1184+ 8D6F 4B               ld   c,e
1185+ 8D70 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1186+ 8D72 CD 20 AB         call Game_TryMovePlayerHorizontally
1187+ 8D75 18 00            jr   .done
1188+ 8D77
1189+ 8D77
1190+ 8D77              .do_nothing:
1191+ 8D77                  ; resta fermo
1192+ 8D77
1193+ 8D77              .done:
1194+ 8D77 E1               pop  hl
1195+ 8D78 D1               pop  de
1196+ 8D79 C1               pop  bc
1197+ 8D7A F1               pop  af
1198+ 8D7B C9               ret
1199+ 8D7C
1200+ 8D7C
1201+ 8D7C              ; ---------------------------------------------------------------------------
1202+ 8D7C              ; AiVerticalAdjustments
1203+ 8D7C              ;
1204+ 8D7C              ; INPUT:
1205+ 8D7C              ;   B = TEAM
1206+ 8D7C              ; NOTE:
1207+ 8D7C              ;   - muove solo giocatori ID 1..3 (mai il portiere)
1208+ 8D7C              ;   - non muove il giocatore che ha la palla
1209+ 8D7C              ; ---------------------------------------------------------------------------
1210+ 8D7C              AiVerticalAdjustments:
1211+ 8D7C F5               push af
1212+ 8D7D C5               push bc
1213+ 8D7E D5               push de
1214+ 8D7F E5               push hl
1215+ 8D80
1216+ 8D80
1217+ 8D80
1218+ 8D80
1219+ 8D80 50               ld   d,b                 ; D = TEAM (salvato)
1220+ 8D81
1221+ 8D81                  ; probabilità di attivare il blocco verticale
1222+ 8D81 CD F1 A6         call Game_GetRandom0_20
1223+ 8D84
1224+ 8D84 FE 0F            cp   15
1225+ 8D86 30 33            jr   nc,.done            ; ~12.5% dei tick
1226+ 8D88
1227+ 8D88              ; --- scegli un ID 1..3 ------------------------------------------------
1228+ 8D88              .gen_id:
1229+ 8D88 CD DF A6         call Game_GetRandom0_4   ; 0..4
1230+ 8D8B FE 01            cp   1
1231+ 8D8D 38 2C            jr   c,.done           ; 0 -> scarta
1232+ 8D8F FE 04            cp   4
1233+ 8D91 30 28            jr   nc,.done          ; 4 -> scarta (vogliamo 1..3)
1234+ 8D93 4F               ld   c,a                 ; C = ID (1..3)
1235+ 8D94 59               ld   e,c                 ; E = ID salvato
1236+ 8D95
1237+ 8D95                  ; --- verifica che NON sia il possessore della palla ---------------
1238+ 8D95                  ; (Game_GetPlayerIdWithBall distrugge BC, quindi lo salviamo)
1239+ 8D95 C5               push bc                  ; salva TEAM (B) e ID (C)
1240+ 8D96 CD 01 A7         call Game_GetPlayerIdWithBall
1241+ 8D99                  ; A = stato/team, H = ownerID (o 255), L = contendenteID (o 255)
1242+ 8D99 C1               pop  bc                  ; ripristina B=TEAM, C=ID scelto (1..3)
1243+ 8D9A
1244+ 8D9A                  ; Se A è TEAM_BLACK / TEAM_WHITE e coincide con B,
1245+ 8D9A                  ; e H == C -> questo giocatore ha la palla => NON muoverlo
1246+ 8D9A FE 00            cp   TEAM_BLACK
1247+ 8D9C 28 06            jr   z,.check_owner
1248+ 8D9E FE 01            cp   TEAM_WHITE
1249+ 8DA0 28 02            jr   z,.check_owner
1250+ 8DA2 18 07            jr   .no_owner           ; palla libera / contesa / in movimento
1251+ 8DA4
1252+ 8DA4              .check_owner:
1253+ 8DA4 B8               cp   b                   ; team col possesso == nostro team?
1254+ 8DA5 20 04            jr   nz,.no_owner
1255+ 8DA7 7C               ld   a,h                 ; ownerID
1256+ 8DA8 B9               cp   c                   ; è proprio il nostro giocatore?
1257+ 8DA9 28 10            jr   z,.done             ; sì -> non muovere verticalmente
1258+ 8DAB
1259+ 8DAB              .no_owner:
1260+ 8DAB                  ; --- scegli direzione N/S (random) ------------------------------
1261+ 8DAB
1262+ 8DAB
1263+ 8DAB CD DF A6         call Game_GetRandom0_4
1264+ 8DAE
1265+ 8DAE
1266+ 8DAE
1267+ 8DAE FE 01            CP   1
1268+ 8DB0 28 0E            JR   z,.move_down
1269+ 8DB2 FE 03            CP   3
1270+ 8DB4 30 0A            JR   nc,.move_down
1271+ 8DB6 3E 03            ld   a,PLAYER_ASKED_DIRECTION_NORTH
1272+ 8DB8
1273+ 8DB8              .do_move:
1274+ 8DB8 CD 87 A7         call Game_TryMovePlayerVertically
1275+ 8DBB
1276+ 8DBB              .done:
1277+ 8DBB E1               pop  hl
1278+ 8DBC D1               pop  de
1279+ 8DBD C1               pop  bc
1280+ 8DBE F1               pop  af
1281+ 8DBF C9               ret
1282+ 8DC0              .move_down:
1283+ 8DC0 3E 04            ld   a,PLAYER_ASKED_DIRECTION_SOUTH
1284+ 8DC2 18 F4            jr   .do_move
1285+ 8DC4
1286+ 8DC4
1287+ 8DC4              ; ---------------------------------------------------------------------------
1288+ 8DC4              ; Game_Ai_MoveHoriz_AwayOrRandom
1289+ 8DC4              ;
1290+ 8DC4              ; INPUT:
1291+ 8DC4              ;   B = TEAM
1292+ 8DC4              ;   C = ID del giocatore coinvolto nella contesa
1293+ 8DC4              ;
1294+ 8DC4              ; Effetto:
1295+ 8DC4              ;   - Legge posizione di questo giocatore e quella dell'altro (se vuoi
1296+ 8DC4              ;     puoi passare anche l'altro X in un registro).
1297+ 8DC4              ;   - Per semplicità:
1298+ 8DC4              ;       * se X=0 -> prova solo EAST
1299+ 8DC4              ;       * se X=4 -> prova solo WEST
1300+ 8DC4              ;       * se X=1 e a sinistra c'è compagno -> forza EAST
1301+ 8DC4              ;       * se X=3 e a destra   c'è compagno -> forza WEST
1302+ 8DC4              ;       * altrimenti dir random LEFT/RIGHT.
1303+ 8DC4              ;   - Chiama Game_TryMovePlayerHorizontally
1304+ 8DC4              ; ---------------------------------------------------------------------------
1305+ 8DC4              Game_Ai_MoveHoriz_AwayOrRandom:
1306+ 8DC4 F5               push af
1307+ 8DC5 C5               push bc
1308+ 8DC6 D5               push de
1309+ 8DC7 E5               push hl
1310+ 8DC8
1311+ 8DC8                  ; prendi posizione corrente
1312+ 8DC8 CD C4 A2         call Game_GetPlayerInfoById      ; HL = pos (H=Y, L=X)
1313+ 8DCB 54               ld   d,h                         ; D = Y
1314+ 8DCC 5D               ld   e,l                         ; E = X
1315+ 8DCD
1316+ 8DCD                  ; bordi assoluti
1317+ 8DCD 7B               ld   a,e
1318+ 8DCE FE 00            cp   0
1319+ 8DD0 28 33            jr   z,.force_east
1320+ 8DD2 FE 04            cp   4
1321+ 8DD4 28 33            jr   z,.force_west
1322+ 8DD6
1323+ 8DD6                  ; colonne 1 o 3 con compagno accanto?
1324+ 8DD6                  ;  - se X=1 e a sinistra (0) c'è un compagno → forza east
1325+ 8DD6                  ;  - se X=3 e a destra  (4) c'è un compagno → forza west
1326+ 8DD6
1327+ 8DD6 FE 01            cp   1
1328+ 8DD8 20 0E            jr   nz,.check_x3
1329+ 8DDA                  ; X=1: controlla (Y,0)
1330+ 8DDA C5               push bc
1331+ 8DDB 54               ld   d,h          ; Y
1332+ 8DDC 1E 00            ld   e,0
1333+ 8DDE CD DF A2         call Game_GetPlayerInfoByPos
1334+ 8DE1 C1               pop  bc
1335+ 8DE2 FE FF            cp   NO_VALUE
1336+ 8DE4 20 1F            jr   nz,.force_east   ; qualcuno lì → forza east
1337+ 8DE6 18 10            jr   .rand_dir
1338+ 8DE8
1339+ 8DE8              .check_x3:
1340+ 8DE8 FE 03            cp   3
1341+ 8DEA 20 0C            jr   nz,.rand_dir
1342+ 8DEC                  ; X=3: controlla (Y,4)
1343+ 8DEC C5               push bc
1344+ 8DED 54               ld   d,h
1345+ 8DEE 1E 04            ld   e,4
1346+ 8DF0 CD DF A2         call Game_GetPlayerInfoByPos
1347+ 8DF3 C1               pop  bc
1348+ 8DF4 FE FF            cp   NO_VALUE
1349+ 8DF6 20 11            jr   nz,.force_west
1350+ 8DF8
1351+ 8DF8              .rand_dir:
1352+ 8DF8                  ; direzione random
1353+ 8DF8 CD D9 A6         call Game_GetRandomByte
1354+ 8DFB E6 01            and 00000001b
1355+ 8DFD 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1356+ 8DFF 28 0A            jr   z,.do_move
1357+ 8E01 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1358+ 8E03 18 06            jr   .do_move
1359+ 8E05
1360+ 8E05              .force_east:
1361+ 8E05 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1362+ 8E07 18 02            jr   .do_move
1363+ 8E09
1364+ 8E09              .force_west:
1365+ 8E09 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1366+ 8E0B
1367+ 8E0B              .do_move:
1368+ 8E0B CD 20 AB         call Game_TryMovePlayerHorizontally
1369+ 8E0E
1370+ 8E0E E1               pop  hl
1371+ 8E0F D1               pop  de
1372+ 8E10 C1               pop  bc
1373+ 8E11 F1               pop  af
1374+ 8E12 C9               ret
1375+ 8E13              ;---------------------------------------------------------------------------
1376+ 8E13              ; Hooks_UpdateTimeToPlay
1377+ 8E13              ;---------------------------------------------------------------------------
1378+ 8E13              Hooks_UpdateTimeToPlay:
1379+ 8E13 3A 63 86         LD      A, (Var_Game_TimeToPlay)
1380+ 8E16 32 47 86         LD      (Var_Game_SecondsToPlay), A
1381+ 8E19 C9               RET
1382+ 8E1A
# file closed: ./inc/hooks.asm
  14  8E1A                      INCLUDE "tiles.asm"                     ; Include tiles definitions
# file opened: ./inc/tiles.asm
   1+ 8E1A              ; ===================================================================
   2+ 8E1A              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8E1A              ; ===================================================================
   4+ 8E1A
   5+ 8E1A              ; *** TILES.ASM ***
   6+ 8E1A
   7+ 8E1A
   8+ 8E1A              TILES:
   9+ 8E1A              ; Char " "
  10+ 8E1A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  10+ 8E1E 00 00 00 00
  11+ 8E22              ; Char "!"
  12+ 8E22 00 30 30 30      DB 0x00,0x30,0x30,0x30,0x30,0x00,0x30,0x00
  12+ 8E26 30 00 30 00
  13+ 8E2A              ; Char """
  14+ 8E2A 00 6C 6C 48      DB 0x00,0x6C,0x6C,0x48,0x00,0x00,0x00,0x00
  14+ 8E2E 00 00 00 00
  15+ 8E32              ; Char "#"
  16+ 8E32 00 2C 7E 2C      DB 0x00,0x2C,0x7E,0x2C,0x2C,0x7E,0x2C,0x00
  16+ 8E36 2C 7E 2C 00
  17+ 8E3A              ; Char "$"
  18+ 8E3A 00 18 3E 58      DB 0x00,0x18,0x3E,0x58,0x3C,0x1A,0x7C,0x00
  18+ 8E3E 3C 1A 7C 00
  19+ 8E42              ; Char "%"
  20+ 8E42 00 62 64 08      DB 0x00,0x62,0x64,0x08,0x10,0x26,0x46,0x00
  20+ 8E46 10 26 46 00
  21+ 8E4A              ; Char "&"
  22+ 8E4A 00 38 6C 38      DB 0x00,0x38,0x6C,0x38,0x6A,0x64,0x3A,0x00
  22+ 8E4E 6A 64 3A 00
  23+ 8E52              ; Char "'"
  24+ 8E52 00 30 30 20      DB 0x00,0x30,0x30,0x20,0x00,0x00,0x00,0x00
  24+ 8E56 00 00 00 00
  25+ 8E5A              ; Char "("
  26+ 8E5A 00 0C 18 18      DB 0x00,0x0C,0x18,0x18,0x18,0x18,0x0C,0x00
  26+ 8E5E 18 18 0C 00
  27+ 8E62              ; Char ")"
  28+ 8E62 00 30 18 18      DB 0x00,0x30,0x18,0x18,0x18,0x18,0x30,0x00
  28+ 8E66 18 18 30 00
  29+ 8E6A              ; Char "*"
  30+ 8E6A 00 00 00 66      DB 0x00,0x00,0x00,0x66,0x18,0x66,0x00,0x00
  30+ 8E6E 18 66 00 00
  31+ 8E72              ; Char "+"
  32+ 8E72 00 00 18 18      DB 0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00
  32+ 8E76 7E 18 18 00
  33+ 8E7A              ; Char ","
  34+ 8E7A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x10
  34+ 8E7E 00 30 30 10
  35+ 8E82              ; Char "-"
  36+ 8E82 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x3C,0x00,0x00,0x00
  36+ 8E86 3C 00 00 00
  37+ 8E8A              ; Char "."
  38+ 8E8A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00
  38+ 8E8E 00 30 30 00
  39+ 8E92              ; Char "/"
  40+ 8E92 00 02 06 0C      DB 0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0x00
  40+ 8E96 18 30 60 00
  41+ 8E9A              ; Char "0"
  42+ 8E9A 00 3C 66 6E      DB 0x00,0x3C,0x66,0x6E,0x76,0x66,0x3C,0x00
  42+ 8E9E 76 66 3C 00
  43+ 8EA2              ; Char "1"
  44+ 8EA2 00 18 38 58      DB 0x00,0x18,0x38,0x58,0x18,0x18,0x7E,0x00
  44+ 8EA6 18 18 7E 00
  45+ 8EAA              ; Char "2"
  46+ 8EAA 00 3C 46 1C      DB 0x00,0x3C,0x46,0x1C,0x30,0x60,0x7E,0x00
  46+ 8EAE 30 60 7E 00
  47+ 8EB2              ; Char "3"
  48+ 8EB2 00 3C 46 1C      DB 0x00,0x3C,0x46,0x1C,0x06,0x46,0x3C,0x00
  48+ 8EB6 06 46 3C 00
  49+ 8EBA              ; Char "4"
  50+ 8EBA 00 30 30 60      DB 0x00,0x30,0x30,0x60,0x7E,0x0C,0x0C,0x00
  50+ 8EBE 7E 0C 0C 00
  51+ 8EC2              ; Char "5"
  52+ 8EC2 00 7E 60 7E      DB 0x00,0x7E,0x60,0x7E,0x06,0x46,0x3C,0x00
  52+ 8EC6 06 46 3C 00
  53+ 8ECA              ; Char "6"
  54+ 8ECA 00 3C 60 7C      DB 0x00,0x3C,0x60,0x7C,0x66,0x66,0x3C,0x00
  54+ 8ECE 66 66 3C 00
  55+ 8ED2              ; Char "7"
  56+ 8ED2 00 7E 06 0C      DB 0x00,0x7E,0x06,0x0C,0x18,0x18,0x18,0x00
  56+ 8ED6 18 18 18 00
  57+ 8EDA              ; Char "8"
  58+ 8EDA 00 3C 66 3C      DB 0x00,0x3C,0x66,0x3C,0x66,0x66,0x3C,0x00
  58+ 8EDE 66 66 3C 00
  59+ 8EE2              ; Char "9"
  60+ 8EE2 00 3C 66 3E      DB 0x00,0x3C,0x66,0x3E,0x06,0x66,0x3C,0x00
  60+ 8EE6 06 66 3C 00
  61+ 8EEA              ; Char ":"
  62+ 8EEA 00 00 30 30      DB 0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x00
  62+ 8EEE 00 30 30 00
  63+ 8EF2              ; Char ";"
  64+ 8EF2 00 00 30 30      DB 0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x10
  64+ 8EF6 00 30 30 10
  65+ 8EFA              ; Char "<"
  66+ 8EFA 00 0C 18 30      DB 0x00,0x0C,0x18,0x30,0x30,0x18,0x0C,0x00
  66+ 8EFE 30 18 0C 00
  67+ 8F02              ; Char "="
  68+ 8F02 00 00 00 7E      DB 0x00,0x00,0x00,0x7E,0x00,0x7E,0x00,0x00
  68+ 8F06 00 7E 00 00
  69+ 8F0A              ; Char ">"
  70+ 8F0A 00 30 18 0C      DB 0x00,0x30,0x18,0x0C,0x0C,0x18,0x30,0x00
  70+ 8F0E 0C 18 30 00
  71+ 8F12              ; Char "?"
  72+ 8F12 00 3C 66 0E      DB 0x00,0x3C,0x66,0x0E,0x18,0x00,0x18,0x00
  72+ 8F16 18 00 18 00
  73+ 8F1A              ; Char "@"
  74+ 8F1A 00 3C 66 06      DB 0x00,0x3C,0x66,0x06,0x36,0x56,0x3C,0x00
  74+ 8F1E 36 56 3C 00
  75+ 8F22              ; Char "A"
  76+ 8F22 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00
  76+ 8F26 7E 66 66 00
  77+ 8F2A              ; Char "B"
  78+ 8F2A 00 7C 66 7C      DB 0x00,0x7C,0x66,0x7C,0x66,0x66,0x7C,0x00
  78+ 8F2E 66 66 7C 00
  79+ 8F32              ; Char "C"
  80+ 8F32 00 3C 66 60      DB 0x00,0x3C,0x66,0x60,0x60,0x66,0x3C,0x00
  80+ 8F36 60 66 3C 00
  81+ 8F3A              ; Char "D"
  82+ 8F3A 00 7C 66 66      DB 0x00,0x7C,0x66,0x66,0x66,0x66,0x7C,0x00
  82+ 8F3E 66 66 7C 00
  83+ 8F42              ; Char "E"
  84+ 8F42 00 7E 60 7C      DB 0x00,0x7E,0x60,0x7C,0x60,0x60,0x7E,0x00
  84+ 8F46 60 60 7E 00
  85+ 8F4A              ; Char "F"
  86+ 8F4A 00 7E 60 7C      DB 0x00,0x7E,0x60,0x7C,0x60,0x60,0x60,0x00
  86+ 8F4E 60 60 60 00
  87+ 8F52              ; Char "G"
  88+ 8F52 00 3C 66 60      DB 0x00,0x3C,0x66,0x60,0x6E,0x66,0x3C,0x00
  88+ 8F56 6E 66 3C 00
  89+ 8F5A              ; Char "H"
  90+ 8F5A 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x7E,0x66,0x66,0x00
  90+ 8F5E 7E 66 66 00
  91+ 8F62              ; Char "I"
  92+ 8F62 00 3C 18 18      DB 0x00,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00
  92+ 8F66 18 18 3C 00
  93+ 8F6A              ; Char "J"
  94+ 8F6A 00 7E 18 18      DB 0x00,0x7E,0x18,0x18,0x18,0x58,0x30,0x00
  94+ 8F6E 18 58 30 00
  95+ 8F72              ; Char "K"
  96+ 8F72 00 66 6C 78      DB 0x00,0x66,0x6C,0x78,0x78,0x6C,0x66,0x00
  96+ 8F76 78 6C 66 00
  97+ 8F7A              ; Char "L"
  98+ 8F7A 00 60 60 60      DB 0x00,0x60,0x60,0x60,0x60,0x60,0x7E,0x00
  98+ 8F7E 60 60 7E 00
  99+ 8F82              ; Char "M"
 100+ 8F82 00 42 66 7E      DB 0x00,0x42,0x66,0x7E,0x66,0x66,0x66,0x00
 100+ 8F86 66 66 66 00
 101+ 8F8A              ; Char "N"
 102+ 8F8A 00 46 66 76      DB 0x00,0x46,0x66,0x76,0x6E,0x66,0x62,0x00
 102+ 8F8E 6E 66 62 00
 103+ 8F92              ; Char "O"
 104+ 8F92 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x66,0x66,0x3C,0x00
 104+ 8F96 66 66 3C 00
 105+ 8F9A              ; Char "P"
 106+ 8F9A 00 7C 66 66      DB 0x00,0x7C,0x66,0x66,0x7C,0x60,0x60,0x00
 106+ 8F9E 7C 60 60 00
 107+ 8FA2              ; Char "Q"
 108+ 8FA2 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x66,0x68,0x36,0x00
 108+ 8FA6 66 68 36 00
 109+ 8FAA              ; Char "R"
 110+ 8FAA 00 7C 66 7C      DB 0x00,0x7C,0x66,0x7C,0x66,0x66,0x66,0x00
 110+ 8FAE 66 66 66 00
 111+ 8FB2              ; Char "S"
 112+ 8FB2 00 3C 60 3C      DB 0x00,0x3C,0x60,0x3C,0x06,0x46,0x3C,0x00
 112+ 8FB6 06 46 3C 00
 113+ 8FBA              ; Char "T"
 114+ 8FBA 00 7E 18 18      DB 0x00,0x7E,0x18,0x18,0x18,0x18,0x18,0x00
 114+ 8FBE 18 18 18 00
 115+ 8FC2              ; Char "U"
 116+ 8FC2 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x00
 116+ 8FC6 66 66 3C 00
 117+ 8FCA              ; Char "V"
 118+ 8FCA 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x3C,0x3C,0x18,0x00
 118+ 8FCE 3C 3C 18 00
 119+ 8FD2              ; Char "W"
 120+ 8FD2 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x7E,0x66,0x42,0x00
 120+ 8FD6 7E 66 42 00
 121+ 8FDA              ; Char "X"
 122+ 8FDA 00 66 76 1C      DB 0x00,0x66,0x76,0x1C,0x38,0x6E,0x66,0x00
 122+ 8FDE 38 6E 66 00
 123+ 8FE2              ; Char "Y"
 124+ 8FE2 00 66 66 3C      DB 0x00,0x66,0x66,0x3C,0x18,0x18,0x18,0x00
 124+ 8FE6 18 18 18 00
 125+ 8FEA              ; Char "Z"
 126+ 8FEA 00 7E 06 1C      DB 0x00,0x7E,0x06,0x1C,0x30,0x60,0x7E,0x00
 126+ 8FEE 30 60 7E 00
 127+ 8FF2              ; Char "["
 128+ 8FF2 00 38 30 30      DB 0x00,0x38,0x30,0x30,0x30,0x30,0x38,0x00
 128+ 8FF6 30 30 38 00
 129+ 8FFA              ; Char "\"
 130+ 8FFA 00 40 60 30      DB 0x00,0x40,0x60,0x30,0x18,0x0C,0x06,0x00
 130+ 8FFE 18 0C 06 00
 131+ 9002              ; Char "]"
 132+ 9002 00 38 18 18      DB 0x00,0x38,0x18,0x18,0x18,0x18,0x38,0x00
 132+ 9006 18 18 38 00
 133+ 900A              ; Char "^"
 134+ 900A 00 18 3C 66      DB 0x00,0x18,0x3C,0x66,0x00,0x00,0x00,0x00
 134+ 900E 00 00 00 00
 135+ 9012              ; Char "_" *** CHANGED TO BOTTOM ARROW ***
 136+ 9012 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x66,0x3C,0x18,0x00
 136+ 9016 66 3C 18 00
 137+ 901A              ; Ball (bottom)
 138+ 901A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 138+ 901E 00 00 00 00
 139+ 9022 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 139+ 9026 00 00 00 00
 140+ 902A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 140+ 902E 00 00 00 00
 141+ 9032 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 141+ 9036 00 00 00 00
 142+ 903A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 142+ 903E 00 00 00 00
 143+ 9042 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 143+ 9046 00 00 00 00
 144+ 904A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 144+ 904E 00 00 00 00
 145+ 9052 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 145+ 9056 00 00 00 00
 146+ 905A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 146+ 905E 00 00 00 00
 147+ 9062 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 147+ 9066 00 00 00 00
 148+ 906A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 148+ 906E 00 00 00 00
 149+ 9072 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 149+ 9076 00 00 00 00
 150+ 907A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 150+ 907E 00 00 00 00
 151+ 9082 00 03 07 0F      DB 0x00,0x03,0x07,0x0F,0x0F,0x0F,0x07,0x03
 151+ 9086 0F 0F 07 03
 152+ 908A 00 C0 E0 F0      DB 0x00,0xC0,0xE0,0xF0,0xF0,0xF0,0xE0,0xC0
 152+ 908E F0 F0 E0 C0
 153+ 9092 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 153+ 9096 00 00 00 00
 154+ 909A              ; White player near half field
 155+ 909A 00 00 0D 1F      DB 0x00,0x00,0x0D,0x1F,0x1F,0x0F,0x06,0x00
 155+ 909E 1F 0F 06 00
 156+ 90A2 F0 E0 E0 E0      DB 0xF0,0xE0,0xE0,0xE0,0xE0,0x60,0x60,0x60
 156+ 90A6 E0 60 60 60
 157+ 90AA F8 7C 7E 7F      DB 0xF8,0x7C,0x7E,0x7F,0x6F,0x67,0x63,0x60
 157+ 90AE 6F 67 63 60
 158+ 90B2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x00
 158+ 90B6 80 80 80 00
 159+ 90BA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 159+ 90BE 00 00 00 00
 160+ 90C2 7F 7F 00 7F      DB 0x7F,0x7F,0x00,0x7F,0x7F,0x79,0xF9,0xF1
 160+ 90C6 7F 79 F9 F1
 161+ 90CA E0 E0 00 E0      DB 0xE0,0xE0,0x00,0xE0,0xE0,0xE0,0xE0,0xC0
 161+ 90CE E0 E0 E0 C0
 162+ 90D2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 162+ 90D6 00 00 00 00
 163+ 90DA 00 01 01 03      DB 0x00,0x01,0x01,0x03,0x03,0x03,0x00,0x00
 163+ 90DE 03 03 00 00
 164+ 90E2 F0 E0 E0 E0      DB 0xF0,0xE0,0xE0,0xE0,0xC0,0xC0,0x00,0x00
 164+ 90E6 C0 C0 00 00
 165+ 90EA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 165+ 90EE 00 00 00 00
 166+ 90F2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 166+ 90F6 00 00 00 00
 167+ 90FA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 167+ 90FE 00 00 00 00
 168+ 9102 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 168+ 9106 00 00 00 00
 169+ 910A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 169+ 910E 00 00 00 00
 170+ 9112 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 170+ 9116 00 00 00 00
 171+ 911A
 172+ 911A              ; White goalkeeper
 173+ 911A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 173+ 911E 00 00 00 00
 174+ 9122 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 174+ 9126 07 1F 37 FB
 175+ 912A 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 175+ 912E E0 F8 EC DF
 176+ 9132 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 176+ 9136 00 00 00 00
 177+ 913A 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x00
 177+ 913E 03 03 03 00
 178+ 9142 F8 F0 F0 B0      DB 0xF8,0xF0,0xF0,0xB0,0x90,0x90,0x9F,0x1F
 178+ 9146 90 90 9F 1F
 179+ 914A 1F 0F 0F 0D      DB 0x1F,0x0F,0x0F,0x0D,0x09,0x09,0xF9,0xF8
 179+ 914E 09 09 F9 F8
 180+ 9152 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,0x00
 180+ 9156 C0 C0 C0 00
 181+ 915A 03 00 00 00      DB 0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 181+ 915E 00 00 00 00
 182+ 9162 80 1F 1F 1F      DB 0x80,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 182+ 9166 1E 1C 1C 1C
 183+ 916A 01 F8 F8 F8      DB 0x01,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 183+ 916E 78 38 38 38
 184+ 9172 C0 00 00 00      DB 0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 184+ 9176 00 00 00 00
 185+ 917A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 185+ 917E 00 00 00 00
 186+ 9182 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 186+ 9186 1C 00 00 00
 187+ 918A 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 187+ 918E 38 00 00 00
 188+ 9192 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 188+ 9196 00 00 00 00
 189+ 919A              ; White goalkeeper with ball
 190+ 919A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 190+ 919E 00 00 00 00
 191+ 91A2 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 191+ 91A6 07 1F 37 FB
 192+ 91AA 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 192+ 91AE E0 F8 EC DF
 193+ 91B2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 193+ 91B6 00 00 00 00
 194+ 91BA 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x01,0x00,0x00,0x00
 194+ 91BE 01 00 00 00
 195+ 91C2 F8 F0 F0 F0      DB 0xF8,0xF0,0xF0,0xF0,0xF0,0x10,0x1F,0x1F
 195+ 91C6 F0 10 1F 1F
 196+ 91CA 1F 0F 0F 0F      DB 0x1F,0x0F,0x0F,0x0F,0x0F,0x08,0xF8,0xF8
 196+ 91CE 0F 08 F8 F8
 197+ 91D2 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00
 197+ 91D6 80 00 00 00
 198+ 91DA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 198+ 91DE 00 00 00 00
 199+ 91E2 00 1F 1F 1F      DB 0x00,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 199+ 91E6 1E 1C 1C 1C
 200+ 91EA 00 F8 F8 F8      DB 0x00,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 200+ 91EE 78 38 38 38
 201+ 91F2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 201+ 91F6 00 00 00 00
 202+ 91FA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 202+ 91FE 00 00 00 00
 203+ 9202 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 203+ 9206 1C 00 00 00
 204+ 920A 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 204+ 920E 38 00 00 00
 205+ 9212 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 205+ 9216 00 00 00 00
 206+ 921A              ; Black goalkeeper
 207+ 921A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 207+ 921E 00 00 00 00
 208+ 9222 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 208+ 9226 07 1F 37 FB
 209+ 922A 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 209+ 922E E0 F8 EC DF
 210+ 9232 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 210+ 9236 00 00 00 00
 211+ 923A 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x00
 211+ 923E 03 03 03 00
 212+ 9242 FC FF FF BF      DB 0xFC,0xFF,0xFF,0xBF,0x9F,0x9F,0x9F,0x1F
 212+ 9246 9F 9F 9F 1F
 213+ 924A 3F FF FF FD      DB 0x3F,0xFF,0xFF,0xFD,0xF9,0xF9,0xF9,0xF8
 213+ 924E F9 F9 F9 F8
 214+ 9252 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,0x00
 214+ 9256 C0 C0 C0 00
 215+ 925A 03 00 00 00      DB 0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 215+ 925E 00 00 00 00
 216+ 9262 80 1F 1F 1F      DB 0x80,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 216+ 9266 1E 1C 1C 1C
 217+ 926A 01 F8 F8 F8      DB 0x01,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 217+ 926E 78 38 38 38
 218+ 9272 C0 00 00 00      DB 0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 218+ 9276 00 00 00 00
 219+ 927A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 219+ 927E 00 00 00 00
 220+ 9282 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 220+ 9286 1C 00 00 00
 221+ 928A 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 221+ 928E 38 00 00 00
 222+ 9292 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 222+ 9296 00 00 00 00
 223+ 929A              ; Black goalkeeper with ball
 224+ 929A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 224+ 929E 00 00 00 00
 225+ 92A2 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x3C,0xF9
 225+ 92A6 07 1F 3C F9
 226+ 92AA 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0x3C,0x9F
 226+ 92AE E0 F8 3C 9F
 227+ 92B2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 227+ 92B6 00 00 00 00
 228+ 92BA 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x01,0x00,0x00,0x00
 228+ 92BE 01 00 00 00
 229+ 92C2 FB FF FF FB      DB 0xFB,0xFF,0xFF,0xFB,0xF9,0x1C,0x1F,0x1F
 229+ 92C6 F9 1C 1F 1F
 230+ 92CA DF FF FF DF      DB 0xDF,0xFF,0xFF,0xDF,0x9F,0x38,0xF8,0xF8
 230+ 92CE 9F 38 F8 F8
 231+ 92D2 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00
 231+ 92D6 80 00 00 00
 232+ 92DA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 232+ 92DE 00 00 00 00
 233+ 92E2 00 1F 1F 1F      DB 0x00,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 233+ 92E6 1E 1C 1C 1C
 234+ 92EA 00 F8 F8 F8      DB 0x00,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 234+ 92EE 78 38 38 38
 235+ 92F2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 235+ 92F6 00 00 00 00
 236+ 92FA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 236+ 92FE 00 00 00 00
 237+ 9302 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 237+ 9306 1C 00 00 00
 238+ 930A 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 238+ 930E 38 00 00 00
 239+ 9312 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 239+ 9316 00 00 00 00
 240+ 931A              ; White player
 241+ 931A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 241+ 931E 00 00 00 00
 242+ 9322 00 07 0F 0F      DB 0x00,0x07,0x0F,0x0F,0x0F,0x3F,0x7F,0xF0
 242+ 9326 0F 3F 7F F0
 243+ 932A 00 80 C0 C0      DB 0x00,0x80,0xC0,0xC0,0xC0,0xE0,0xF0,0xF8
 243+ 932E C0 E0 F0 F8
 244+ 9332 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 244+ 9336 00 00 00 00
 245+ 933A 00 0D 1F 1F      DB 0x00,0x0D,0x1F,0x1F,0x0F,0x06,0x00,0x00
 245+ 933E 0F 06 00 00
 246+ 9342 E0 E0 E0 E0      DB 0xE0,0xE0,0xE0,0xE0,0x60,0x60,0x60,0x7F
 246+ 9346 60 60 60 7F
 247+ 934A 7C 7E 7F 6F      DB 0x7C,0x7E,0x7F,0x6F,0x67,0x63,0x60,0xE0
 247+ 934E 67 63 60 E0
 248+ 9352 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00
 248+ 9356 80 80 00 00
 249+ 935A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 249+ 935E 00 00 00 00
 250+ 9362 7F 00 7F 7F      DB 0x7F,0x00,0x7F,0x7F,0x79,0xF9,0xF1,0xF0
 250+ 9366 79 F9 F1 F0
 251+ 936A E0 00 E0 E0      DB 0xE0,0x00,0xE0,0xE0,0xE0,0xE0,0xC0,0x00
 251+ 936E E0 E0 C0 00
 252+ 9372 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 252+ 9376 00 00 00 00
 253+ 937A 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x00,0x00,0x00
 253+ 937E 03 00 00 00
 254+ 9382 E0 E0 E0 C0      DB 0xE0,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00
 254+ 9386 C0 00 00 00
 255+ 938A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 255+ 938E 00 00 00 00
 256+ 9392 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 256+ 9396 00 00 00 00
 257+ 939A              ; Black player
 258+ 939A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 258+ 939E 00 00 00 00
 259+ 93A2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01
 259+ 93A6 00 00 00 01
 260+ 93AA 00 00 0F 1F      DB 0x00,0x00,0x0F,0x1F,0x1F,0x1F,0xDF,0xEE
 260+ 93AE 1F 1F DF EE
 261+ 93B2 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x60,0xF0
 261+ 93B6 80 80 60 F0
 262+ 93BA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 262+ 93BE 00 00 00 00
 263+ 93C2 03 0F 1F 3E      DB 0x03,0x0F,0x1F,0x3E,0x3C,0x38,0x00,0x00
 263+ 93C6 3C 38 00 00
 264+ 93CA F1 FF FF FF      DB 0xF1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
 264+ 93CE FF FF FF FF
 265+ 93D2 F8 FC FE DE      DB 0xF8,0xFC,0xFE,0xDE,0xCE,0xC6,0xC0,0xC0
 265+ 93D6 CE C6 C0 C0
 266+ 93DA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 266+ 93DE 00 00 00 00
 267+ 93E2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 267+ 93E6 00 00 00 00
 268+ 93EA FF FF 00 FF      DB 0xFF,0xFF,0x00,0xFF,0xFF,0xF3,0xF1,0x71
 268+ 93EE FF F3 F1 71
 269+ 93F2 C0 C0 00 C0      DB 0xC0,0xC0,0x00,0xC0,0xC0,0xC0,0xE0,0xE0
 269+ 93F6 C0 C0 E0 E0
 270+ 93FA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 270+ 93FE 00 00 00 00
 271+ 9402 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 271+ 9406 00 00 00 00
 272+ 940A 01 01 00 00      DB 0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00
 272+ 940E 00 00 00 00
 273+ 9412 E0 E0 F0 F0      DB 0xE0,0xE0,0xF0,0xF0,0xF8,0x78,0x78,0x18
 273+ 9416 F8 78 78 18
 274+ 941A              ; Black player with ball
 275+ 941A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 275+ 941E 00 00 00 00
 276+ 9422 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01
 276+ 9426 00 00 00 01
 277+ 942A 00 00 0F 1F      DB 0x00,0x00,0x0F,0x1F,0x1F,0x1F,0xDF,0xEE
 277+ 942E 1F 1F DF EE
 278+ 9432 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x60,0xF0
 278+ 9436 80 80 60 F0
 279+ 943A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 279+ 943E 00 00 00 00
 280+ 9442 03 0F 1F 3E      DB 0x03,0x0F,0x1F,0x3E,0x3C,0x38,0x00,0x00
 280+ 9446 3C 38 00 00
 281+ 944A F1 FF FF FF      DB 0xF1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
 281+ 944E FF FF FF FF
 282+ 9452 F8 FC FE DE      DB 0xF8,0xFC,0xFE,0xDE,0xCE,0xC6,0xC0,0xC0
 282+ 9456 CE C6 C0 C0
 283+ 945A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 283+ 945E 00 00 00 00
 284+ 9462 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 284+ 9466 00 00 00 00
 285+ 946A FF FF 00 FF      DB 0xFF,0xFF,0x00,0xFF,0xFF,0xF3,0xF1,0x71
 285+ 946E FF F3 F1 71
 286+ 9472 C0 C0 00 C0      DB 0xC0,0xC0,0x00,0xC0,0xC0,0xC0,0xE0,0xE0
 286+ 9476 C0 C0 E0 E0
 287+ 947A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 287+ 947E 00 00 00 00
 288+ 9482 00 07 0F 1F      DB 0x00,0x07,0x0F,0x1F,0x1F,0x1F,0x0F,0x07
 288+ 9486 1F 1F 0F 07
 289+ 948A 01 81 C0 E0      DB 0x01,0x81,0xC0,0xE0,0xE0,0xE0,0xC0,0x80
 289+ 948E E0 E0 C0 80
 290+ 9492 E0 E0 F0 F0      DB 0xE0,0xE0,0xF0,0xF0,0xF8,0x78,0x78,0x18
 290+ 9496 F8 78 78 18
 291+ 949A              ; Field line (top-left)
 292+ 949A 00 00 00 1F      DB 0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x10
 292+ 949E 10 10 10 10
 293+ 94A2              ; Field line (vertical)
 294+ 94A2 10 10 10 10      DB 0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10
 294+ 94A6 10 10 10 10
 295+ 94AA              ; Field line (horizontal)
 296+ 94AA 00 00 00 FF      DB 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00
 296+ 94AE 00 00 00 00
 297+ 94B2              ; Field line (top-right)
 298+ 94B2 00 00 00 F0      DB 0x00,0x00,0x00,0xF0,0x10,0x10,0x10,0x10
 298+ 94B6 10 10 10 10
 299+ 94BA              ; Field line (bottom-left)
 300+ 94BA 10 10 10 1F      DB 0x10,0x10,0x10,0x1F,0x00,0x00,0x00,0x00
 300+ 94BE 00 00 00 00
 301+ 94C2              ; Field line (bottom-right)
 302+ 94C2 10 10 10 F0      DB 0x10,0x10,0x10,0xF0,0x00,0x00,0x00,0x00
 302+ 94C6 00 00 00 00
 303+ 94CA              ; Field
 304+ 94CA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 304+ 94CE 00 00 00 00
 305+ 94D2              ; Field line (left-cross)
 306+ 94D2 10 10 10 1F      DB 0x10,0x10,0x10,0x1F,0x10,0x10,0x10,0x10
 306+ 94D6 10 10 10 10
 307+ 94DA              ; Field line (right-cross)
 308+ 94DA 10 10 10 F0      DB 0x10,0x10,0x10,0xF0,0x10,0x10,0x10,0x10
 308+ 94DE 10 10 10 10
 309+ 94E2              ; Field half line with white player head 1
 310+ 94E2 00 07 0F FF      DB 0x00,0x07,0x0F,0xFF,0x0F,0x0F,0x3F,0x7F
 310+ 94E6 0F 0F 3F 7F
 311+ 94EA                  ; Field half line with white player head 2
 312+ 94EA 00 80 C0 FF      DB 0x00,0x80,0xC0,0xFF,0xC0,0xC0,0xE0,0xF0
 312+ 94EE C0 C0 E0 F0
 313+ 94F2              ; Ball overlay (TOP-LEFT)  tile 251  ← mirror del bottom-left
 314+ 94F2 03 07 0F 0F      DB 0x03,0x07,0x0F,0x0F,0x0F,0x07,0x03,0x00
 314+ 94F6 0F 07 03 00
 315+ 94FA              ; Ball overlay (TOP-RIGHT) tile 252  ← mirror del bottom-right
 316+ 94FA C0 E0 F0 F0      DB 0xC0,0xE0,0xF0,0xF0,0xF0,0xE0,0xC0,0x00
 316+ 94FE F0 E0 C0 00
 317+ 9502              ; Ball back overlay RIGHT-SHIFTED (2 tiles, same size as game ball)
 318+ 9502              ; LEFT part  (pattern 253)
 319+ 9502 00 01 03 03      DB 0x00,0x01,0x03,0x03,0x03,0x01,0x00,0x00
 319+ 9506 03 01 00 00
 320+ 950A              ; RIGHT part (pattern 254)
 321+ 950A F0 F8 FC FC      DB 0xF0,0xF8,0xFC,0xFC,0xFC,0xF8,0xF0,0x00
 321+ 950E FC F8 F0 00
 322+ 9512              ; WHITE PLAYER WITH BALL part (pattern 255)
 323+ 9512 F3 E7 EF CF      DB 0xF3,0xE7,0xEF,0xCF,0xCF,0x07,0x03,0x00
 323+ 9516 CF 07 03 00
 324+ 951A              ; ------ ROUTINES ------
 325+ 951A
 326+ 951A
 327+ 951A              ; ------ CONSTANTS ------
 328+ 951A
 329+ 951A
# file closed: ./inc/tiles.asm
  15  951A                      INCLUDE "vdp.asm"                       ; Include screen library
# file opened: ./inc/vdp.asm
   1+ 951A              ; ===================================================================
   2+ 951A              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 951A              ; ===================================================================
   4+ 951A
   5+ 951A              ; *** SCREEN.ASM (sjasm-normalized, buffered & fast VRAM I/O) ***
   6+ 951A
   7+ 951A
   8+ 951A              ;------------------------------------------------------------------------
   9+ 951A              ; Print string
  10+ 951A              ; INPUT:  HL = pointer to null-terminated string
  11+ 951A              ;         D,E = character position (Y,X)
  12+ 951A              ;------------------------------------------------------------------------
  13+ 951A              VDP_PrintString:
  14+ 951A 7E               ld      a,(hl)
  15+ 951B B7               or      a
  16+ 951C C8               ret     z
  17+ 951D F5               push    af
  18+ 951E CD 58 95         call    VDP_PrintRomChar
  19+ 9521 F1               pop     af
  20+ 9522 1C               inc     e
  21+ 9523 23               inc     hl
  22+ 9524 18 F4            jr      VDP_PrintString
  23+ 9526
  24+ 9526
  25+ 9526              ;------------------------------------------------------------------------
  26+ 9526              ; Print a single RAM character out to a screen address
  27+ 9526              ; INPUT:
  28+ 9526              ;   A: Character to print
  29+ 9526              ;   D: Character Y position
  30+ 9526              ;   E: Character X position
  31+ 9526              ; OUTPUT: -
  32+ 9526              ; MODIFIES: -
  33+ 9526              ;------------------------------------------------------------------------
  34+ 9526              VDP_PrintRamChar:
  35+ 9526 D5                   PUSH    DE
  36+ 9527 F5                   PUSH    AF
  37+ 9528 FE 40                CP      TILE_BALL_BOTTOM
  38+ 952A 38 05                JR      C, .AfterColorCheck
  39+ 952C 3E 20                LD      A, GREEN_CHAR_ATTRIBUTE
  40+ 952E CD 87 97             CALL    VDP_SetCharAttribute
  41+ 9531              .AfterColorCheck:
  42+ 9531 F1                   POP     AF
  43+ 9532 D1                   POP     DE
  44+ 9533
  45+ 9533
  46+ 9533
  47+ 9533
  48+ 9533
  49+ 9533 D5                   PUSH    DE
  50+ 9534 D9                   EXX                                 ; Backup registers BC, DE, HL
  51+ 9535 D1                   POP     DE
  52+ 9536 F5                   PUSH    AF
  53+ 9537 21 40 9C             LD      HL, RAM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
  54+ 953A 06 00                LD      B,0                         ; BC = character code
  55+ 953C 4F                   LD      C, A
  56+ 953D CB 21                SLA     C                           ; Multiply by 8 by shifting
  57+ 953F CB 10                RL      B
  58+ 9541 CB 21                SLA     C
  59+ 9543 CB 10                RL      B
  60+ 9545 CB 21                SLA     C
  61+ 9547 CB 10                RL      B
  62+ 9549 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
  63+ 954A CD 7F 95             CALL    GetCharAddress              ; Get screen position in DE
  64+ 954D 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
  65+ 954F              .PrintRamCharL1:
  66+ 954F 7E                   LD      A,(HL)                      ; Get the byte from the ROM into A
  67+ 9550 12                   LD      (DE),A                      ; Stick A onto the screen
  68+ 9551 23                   INC     HL                          ; Goto next byte of character
  69+ 9552 14                   INC     D                           ; Goto next line on screen
  70+ 9553 10 FA                DJNZ    .PrintRamCharL1              ; Loop around whilst it is Not Zero (NZ)
  71+ 9555 D9                   EXX                                 ; Restore registers BC, DE, HL
  72+ 9556 F1                   POP     AF
  73+ 9557 C9                   RET
  74+ 9558              ;------------------------------------------------------------------------
  75+ 9558              ; Print a single ROM character out to a screen address
  76+ 9558              ; INPUT:
  77+ 9558              ;   A: Character to print
  78+ 9558              ;   D: Character Y position
  79+ 9558              ;   E: Character X position
  80+ 9558              ; OUTPUT: -
  81+ 9558              ; MODIFIES: -
  82+ 9558              ;------------------------------------------------------------------------
  83+ 9558              VDP_PrintRomChar:
  84+ 9558 D5                   PUSH    DE
  85+ 9559 D9                   EXX                                 ; Backup registers BC, DE, HL
  86+ 955A D1                   POP     DE
  87+ 955B F5                   PUSH    AF
  88+ 955C 21 00 3D             LD      HL, ROM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
  89+ 955F 06 00                LD      B,0                         ; BC = character code
  90+ 9561 D6 20                SUB     32                          ; Adjust for the character set
  91+ 9563 4F                   LD      C, A
  92+ 9564 CB 21                SLA     C                           ; Multiply by 8 by shifting
  93+ 9566 CB 10                RL      B
  94+ 9568 CB 21                SLA     C
  95+ 956A CB 10                RL      B
  96+ 956C CB 21                SLA     C
  97+ 956E CB 10                RL      B
  98+ 9570 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
  99+ 9571 CD 7F 95             CALL    GetCharAddress              ; Get screen position in DE
 100+ 9574 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
 101+ 9576              .PrintRomCharL1:
 102+ 9576 7E                   LD      A,(HL)                      ; Get the byte from the ROM into A
 103+ 9577 12                   LD      (DE),A                      ; Stick A onto the screen
 104+ 9578 23                   INC     HL                          ; Goto next byte of character
 105+ 9579 14                   INC     D                           ; Goto next line on screen
 106+ 957A 10 FA                DJNZ    .PrintRomCharL1              ; Loop around whilst it is Not Zero (NZ)
 107+ 957C D9                   EXX                                 ; Restore registers BC, DE, HL
 108+ 957D F1                   POP     AF
 109+ 957E C9                   RET
 110+ 957F
 111+ 957F              ;------------------------------------------------------------------------
 112+ 957F              ; Get screen address from a character (X,Y) coordinate
 113+ 957F              ; INPUT:
 114+ 957F              ;   D: Y character position (0-23)
 115+ 957F              ;   E: X character position (0-31)
 116+ 957F              ; OUTPUT:
 117+ 957F              ;   DE: screen address
 118+ 957F              ; MODIFIES: A
 119+ 957F              ;------------------------------------------------------------------------
 120+ 957F              GetCharAddress:
 121+ 957F 7A                   LD      A,D
 122+ 9580 E6 07                AND     %00000111
 123+ 9582 1F                   RRA
 124+ 9583 1F                   RRA
 125+ 9584 1F                   RRA
 126+ 9585 1F                   RRA
 127+ 9586 B3                   OR      E
 128+ 9587 5F                   LD      E,A
 129+ 9588 7A                   LD      A,D
 130+ 9589 E6 18                AND     %00011000
 131+ 958B F6 40                OR      %01000000
 132+ 958D 57                   LD      D,A
 133+ 958E C9                   RET
 134+ 958F
 135+ 958F              ;------------------------------------------------------------------------
 136+ 958F              ; Load tiles from ROM to VRAM
 137+ 958F              ;------------------------------------------------------------------------
 138+ 958F              VDP_LoadTiles:
 139+ 958F F3               DI                      ; Interrupts disabled
 140+ 9590 11 40 9C         LD      DE, RAM_CHAR_SET_ADDRESS
 141+ 9593 21 1A 8E         LD      HL, TILES
 142+ 9596 01 00 07         LD      BC, 1792
 143+ 9599 ED B0            LDIR
 144+ 959B FB               EI                      ; Interrupts enabled
 145+ 959C C9               RET
 146+ 959D              ;------------------------------------------------------------------------
 147+ 959D              ; Clear screen (INVARIATA)
 148+ 959D              ;------------------------------------------------------------------------
 149+ 959D              VDP_ClearScreen:
 150+ 959D 3E 00            LD   A, 0           ; 0 in the lower 3 bits = black
 151+ 959F D3 FE            OUT  (254), A       ; Send A to port 0xFE
 152+ 95A1
 153+ 95A1                  ;----------------------------------------------------------
 154+ 95A1                  ; Clear 6144 bytes of screen pixel area (0x4000..0x57FF)
 155+ 95A1                  ;----------------------------------------------------------
 156+ 95A1
 157+ 95A1 21 00 40         LD   HL, 0x4000      ; Start address of pixel area
 158+ 95A4 11 01 40         LD   DE, 0x4001      ; DE = HL + 1 for LDIR
 159+ 95A7 01 00 18         LD   BC, 6144        ; Number of bytes to clear
 160+ 95AA 36 00            LD   (HL), 0         ; Store 0 in the first byte
 161+ 95AC ED B0            LDIR                 ; Repeats until BC = 0 (fills with 0)
 162+ 95AE
 163+ 95AE                  ;----------------------------------------------------------
 164+ 95AE                  ; Fill 768 bytes of attributes area (0x5800..0x5AFF)
 165+ 95AE                  ; with 0x07 (white on black)
 166+ 95AE                  ;----------------------------------------------------------
 167+ 95AE
 168+ 95AE 21 00 58         LD   HL, 0x5800      ; Start address of attributes area
 169+ 95B1 11 01 58         LD   DE, 0x5801      ; DE = HL + 1 for LDIR
 170+ 95B4 01 00 03         LD   BC, 768         ; Number of attribute bytes
 171+ 95B7 36 07            LD   (HL), 0x07      ; Attribute = 0x07 (white on black)
 172+ 95B9 ED B0            LDIR                 ; Fill the attribute area with 0x07
 173+ 95BB
 174+ 95BB C9               RET
 175+ 95BC
 176+ 95BC
 177+ 95BC
 178+ 95BC
 179+ 95BC
 180+ 95BC
 181+ 95BC              ; -----------------------------------------------------------
 182+ 95BC              ; Draw sprite (32x32 tile)
 183+ 95BC              ; INPUT: D = row (Y), E = col (X), A = tile index
 184+ 95BC              ; -----------------------------------------------------------
 185+ 95BC              VDP_DrawSprite:
 186+ 95BC F5               PUSH    AF
 187+ 95BD 7A               ld      a,d
 188+ 95BE 87               add     a,a          ; *2
 189+ 95BF 87               add     a,a          ; *4
 190+ 95C0 57               ld      d,a
 191+ 95C1
 192+ 95C1 7B               ld      a,e
 193+ 95C2 87               add     a,a          ; *2
 194+ 95C3 87               add     a,a          ; *4
 195+ 95C4 5F               ld      e,a
 196+ 95C5 1C               inc     e
 197+ 95C6 14               inc     d
 198+ 95C7 F1               POP     AF
 199+ 95C8 4F               ld      c,a
 200+ 95C9 FE 04            cp      TILE_CORNER_BALL_EMPTY
 201+ 95CB 28 10            jr      z,.CornerBallArea
 202+ 95CD FE 00            cp      TILE_CORNER
 203+ 95CF 28 0C            jr      z,.CornerBallArea
 204+ 95D1 FE 06            cp      TILE_BALL_TOP
 205+ 95D3 28 6D            jr      z,.TopBall
 206+ 95D5 FE 07            cp      TILE_BALL_TOP_FRONT
 207+ 95D7 28 79            jr      z,.TopBallFront
 208+ 95D9 FE 03            cp      TILE_CORNER_BALL
 209+ 95DB 20 23            jr      nz,.TileField
 210+ 95DD
 211+ 95DD              .CornerBallArea:
 212+ 95DD 7A               ld      a,d
 213+ 95DE FE 01            cp      1
 214+ 95E0 20 04            jr      nz,.CornerBallEmptyBottom
 215+ 95E2 16 02            ld      d,2
 216+ 95E4 18 02            jr      .CornerBallEmptySide
 217+ 95E6              .CornerBallEmptyBottom:
 218+ 95E6 16 15            ld      d,21
 219+ 95E8              .CornerBallEmptySide:
 220+ 95E8 1C               inc     e
 221+ 95E9 79               ld      a,c
 222+ 95EA FE 04            cp      TILE_CORNER_BALL_EMPTY
 223+ 95EC 28 06            jr      z,.CornerBallEmptyTile
 224+ 95EE FE 00            cp      TILE_CORNER
 225+ 95F0 28 02            jr      z,.CornerBallEmptyTile
 226+ 95F2 18 0C            jr      .TileField
 227+ 95F4              .CornerBallEmptyTile:
 228+ 95F4 3E 6F            ld      a,111
 229+ 95F6 CD 26 95         call    VDP_PrintRamChar
 230+ 95F9 1C               inc     e
 231+ 95FA 3E 6F            ld      a,111
 232+ 95FC CD 26 95         call    VDP_PrintRamChar
 233+ 95FF C9               ret
 234+ 9600              .TileField:
 235+ 9600 FE D6            cp      TILE_FIELD
 236+ 9602 C2 32 96         jp      nz,.CornerBall
 237+ 9605
 238+ 9605 D5               push    de
 239+ 9606 F5               push    af
 240+ 9607 C5               push    bc
 241+ 9608 E5               push    hl
 242+ 9609
 243+ 9609 62               ld      h,d
 244+ 960A 6B               ld      l,e
 245+ 960B 42               ld      b,d
 246+ 960C 04               inc     b
 247+ 960D 04               inc     b
 248+ 960E 04               inc     b
 249+ 960F 04               inc     b
 250+ 9610 4B               ld      c,e
 251+ 9611 0C               inc     c
 252+ 9612 0C               inc     c
 253+ 9613 0C               inc     c
 254+ 9614 0C               inc     c
 255+ 9615
 256+ 9615              .EmptyRowLoop:
 257+ 9615 7A               ld      a,d
 258+ 9616 B8               cp      b
 259+ 9617 CA 2D 96         jp      z,.EmptyExit
 260+ 961A
 261+ 961A 5D               ld      e,l
 262+ 961B              .EmptyColLoop:
 263+ 961B 7B               ld      a,e
 264+ 961C B9               cp      c
 265+ 961D CA 29 96         jp      z,.EmptyNextRow
 266+ 9620
 267+ 9620 3E D6            ld      a,TILE_FIELD
 268+ 9622 CD 26 95         call    VDP_PrintRamChar
 269+ 9625 1C               inc     e
 270+ 9626 C3 1B 96         jp      .EmptyColLoop
 271+ 9629
 272+ 9629              .EmptyNextRow:
 273+ 9629 14               inc     d
 274+ 962A C3 15 96         jp      .EmptyRowLoop
 275+ 962D
 276+ 962D              .EmptyExit:
 277+ 962D E1               pop     hl
 278+ 962E C1               pop     bc
 279+ 962F F1               pop     af
 280+ 9630 D1               pop     de
 281+ 9631 C9               ret
 282+ 9632
 283+ 9632              .CornerBall:
 284+ 9632 FE 03            cp      TILE_CORNER_BALL
 285+ 9634 20 2D            jr      nz,.Dispatch
 286+ 9636 3E 6D            ld      a,109
 287+ 9638 CD 26 95         call    VDP_PrintRamChar
 288+ 963B 1C               inc     e
 289+ 963C 3E 6E            ld      a,110
 290+ 963E CD 26 95         call    VDP_PrintRamChar
 291+ 9641 C9               ret
 292+ 9642
 293+ 9642              .TopBall:
 294+ 9642 FE 06            cp      TILE_BALL_TOP
 295+ 9644 20 1D            jr      nz,.Dispatch
 296+ 9646 3E 6D            ld      a,109
 297+ 9648 CD 26 95         call    VDP_PrintRamChar
 298+ 964B 1C               inc     e
 299+ 964C 3E 6E            ld      a,110
 300+ 964E CD 26 95         call    VDP_PrintRamChar
 301+ 9651 C9               ret
 302+ 9652
 303+ 9652              .TopBallFront:
 304+ 9652 FE 07            cp      TILE_BALL_TOP_FRONT
 305+ 9654 20 0D            jr      nz,.Dispatch
 306+ 9656 1C               inc     e
 307+ 9657 3E 6D            ld      a,109
 308+ 9659 CD 26 95         call    VDP_PrintRamChar
 309+ 965C 1C               inc     e
 310+ 965D 3E 6E            ld      a,110
 311+ 965F CD 26 95         call    VDP_PrintRamChar
 312+ 9662 C9               ret
 313+ 9663
 314+ 9663              ; ---------- dispatcher ----------
 315+ 9663              .Dispatch:
 316+ 9663 FE A0            cp      TILE_WHITE_PLAYER
 317+ 9665 CA 75 96         jp      z,.MaybeWhiteHalfLine
 318+ 9668 FE 01            cp      TILE_WHITE_PLAYER_WITH_BALL
 319+ 966A CA 99 96         jp      z,.DrawWhiteWithFeetBall
 320+ 966D FE 02            cp      TILE_BLACK_PLAYER_WITH_BACK_BALL
 321+ 966F CA EC 96         jp      z,.DrawBlackWithBackBall
 322+ 9672 C3 05 97         jp      .BaseDraw
 323+ 9675
 324+ 9675              ; ---------- white: “testa nella metà campo” ----------
 325+ 9675              .MaybeWhiteHalfLine:
 326+ 9675 3A AE 86         ld      a,(Var_Vdp_HalfFieldHorzLinePos)
 327+ 9678 47               ld      b,a
 328+ 9679 7A               ld      a,d
 329+ 967A 3D               dec     a
 330+ 967B B8               cp      b
 331+ 967C 20 16            jr      nz,.DrawWhiteBaseNormal
 332+ 967E
 333+ 967E D5               push    de
 334+ 967F 50               ld      d,b
 335+ 9680 7B               ld      a,e
 336+ 9681 3C               inc     a
 337+ 9682 5F               ld      e,a
 338+ 9683 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
 339+ 9685 CD 26 95         call    VDP_PrintRamChar
 340+ 9688 1C               inc     e
 341+ 9689 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
 342+ 968B CD 26 95         call    VDP_PrintRamChar
 343+ 968E D1               pop     de
 344+ 968F
 345+ 968F 3E 50            ld      a,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 346+ 9691 C3 05 97         jp      .BaseDraw
 347+ 9694
 348+ 9694              .DrawWhiteBaseNormal:
 349+ 9694 3E A0            ld      a,TILE_WHITE_PLAYER
 350+ 9696 C3 05 97         jp      .BaseDraw
 351+ 9699
 352+ 9699              ; ---------- white con palla ai piedi ----------
 353+ 9699              .DrawWhiteWithFeetBall:
 354+ 9699 3A AE 86         ld      a,(Var_Vdp_HalfFieldHorzLinePos)
 355+ 969C 47               ld      b,a
 356+ 969D 7A               ld      a,d
 357+ 969E 3D               dec     a
 358+ 969F B8               cp      b
 359+ 96A0 20 11            jr      nz,.NoHalf
 360+ 96A2
 361+ 96A2 D5               push    de
 362+ 96A3 50               ld      d,b
 363+ 96A4 7B               ld      a,e
 364+ 96A5 3C               inc     a
 365+ 96A6 5F               ld      e,a
 366+ 96A7 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
 367+ 96A9 CD 26 95         call    VDP_PrintRamChar
 368+ 96AC 1C               inc     e
 369+ 96AD 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
 370+ 96AF CD 26 95         call    VDP_PrintRamChar
 371+ 96B2 D1               pop     de
 372+ 96B3
 373+ 96B3              .NoHalf:
 374+ 96B3 79               ld      a,c
 375+ 96B4 FE 01            cp      TILE_WHITE_PLAYER_WITH_BALL
 376+ 96B6 28 1C            jr      z,.Half
 377+ 96B8
 378+ 96B8 3E A0            ld      a,TILE_WHITE_PLAYER
 379+ 96BA CD 05 97         call    .BaseDraw
 380+ 96BD
 381+ 96BD D5               push    de
 382+ 96BE 7A               ld      a,d
 383+ 96BF C6 03            add     a,3
 384+ 96C1 57               ld      d,a
 385+ 96C2 7B               ld      a,e
 386+ 96C3 C6 02            add     a,2
 387+ 96C5 5F               ld      e,a
 388+ 96C6 1D               dec     e
 389+ 96C7 3E DF            ld      a,TILE_WHITE_PLAYER_AND_BALL
 390+ 96C9 CD 26 95         call    VDP_PrintRamChar
 391+ 96CC 1C               inc     e
 392+ 96CD 3E DC            ld      a,TILE_BALL_FEET_OVERLAY_R
 393+ 96CF CD 26 95         call    VDP_PrintRamChar
 394+ 96D2 D1               pop     de
 395+ 96D3 C9               ret
 396+ 96D4
 397+ 96D4              .Half:
 398+ 96D4 D5               push    de
 399+ 96D5 7A               ld      a,d
 400+ 96D6 C6 03            add     a,3
 401+ 96D8 57               ld      d,a
 402+ 96D9 7B               ld      a,e
 403+ 96DA C6 02            add     a,2
 404+ 96DC 5F               ld      e,a
 405+ 96DD 1D               dec     e
 406+ 96DE 3E DF            ld      a,TILE_WHITE_PLAYER_AND_BALL
 407+ 96E0 15               dec     d
 408+ 96E1 CD 26 95         call    VDP_PrintRamChar
 409+ 96E4 1C               inc     e
 410+ 96E5 3E DC            ld      a,TILE_BALL_FEET_OVERLAY_R
 411+ 96E7 CD 26 95         call    VDP_PrintRamChar
 412+ 96EA D1               pop     de
 413+ 96EB C9               ret
 414+ 96EC
 415+ 96EC              ; ---------- nero con palla alle spalle ----------
 416+ 96EC              .DrawBlackWithBackBall:
 417+ 96EC 3E B0            ld      a,TILE_BLACK_PLAYER
 418+ 96EE CD 05 97         call    .BaseDraw
 419+ 96F1
 420+ 96F1 D5               push    de
 421+ 96F2 7B               ld      a,e
 422+ 96F3 FE 1F            cp      31
 423+ 96F5 CA 03 97         jp      z,.WBack_Done
 424+ 96F8 3E DD            ld      a,TILE_BALL_BACK_OVERLAY_L
 425+ 96FA CD 26 95         call    VDP_PrintRamChar
 426+ 96FD 1C               inc     e
 427+ 96FE 3E DE            ld      a,TILE_BALL_BACK_OVERLAY_R
 428+ 9700 CD 26 95         call    VDP_PrintRamChar
 429+ 9703              .WBack_Done:
 430+ 9703 D1               pop     de
 431+ 9704 C9               ret
 432+ 9705
 433+ 9705              ; ---------- routine di base: disegna 4x4 a partire da A ----------
 434+ 9705              .BaseDraw:
 435+ 9705 D5               push    de
 436+ 9706 F5               push    af
 437+ 9707
 438+ 9707 CD 26 95         call    VDP_PrintRamChar
 439+ 970A 1C               inc     e
 440+ 970B 3C               inc     a
 441+ 970C CD 26 95         call    VDP_PrintRamChar
 442+ 970F 1C               inc     e
 443+ 9710 3C               inc     a
 444+ 9711 CD 26 95         call    VDP_PrintRamChar
 445+ 9714 1C               inc     e
 446+ 9715 3C               inc     a
 447+ 9716 CD 26 95         call    VDP_PrintRamChar
 448+ 9719
 449+ 9719 14               inc     d
 450+ 971A 1D               dec     e
 451+ 971B 1D               dec     e
 452+ 971C 1D               dec     e
 453+ 971D 3C               inc     a
 454+ 971E CD 26 95         call    VDP_PrintRamChar
 455+ 9721 1C               inc     e
 456+ 9722 3C               inc     a
 457+ 9723 CD 26 95         call    VDP_PrintRamChar
 458+ 9726 1C               inc     e
 459+ 9727 3C               inc     a
 460+ 9728 CD 26 95         call    VDP_PrintRamChar
 461+ 972B 1C               inc     e
 462+ 972C 3C               inc     a
 463+ 972D CD 26 95         call    VDP_PrintRamChar
 464+ 9730
 465+ 9730 14               inc     d
 466+ 9731 1D               dec     e
 467+ 9732 1D               dec     e
 468+ 9733 1D               dec     e
 469+ 9734 3C               inc     a
 470+ 9735 CD 26 95         call    VDP_PrintRamChar
 471+ 9738 1C               inc     e
 472+ 9739 3C               inc     a
 473+ 973A CD 26 95         call    VDP_PrintRamChar
 474+ 973D 1C               inc     e
 475+ 973E 3C               inc     a
 476+ 973F CD 26 95         call    VDP_PrintRamChar
 477+ 9742 1C               inc     e
 478+ 9743 3C               inc     a
 479+ 9744 CD 26 95         call    VDP_PrintRamChar
 480+ 9747
 481+ 9747 14               inc     d
 482+ 9748 1D               dec     e
 483+ 9749 1D               dec     e
 484+ 974A 1D               dec     e
 485+ 974B 3C               inc     a
 486+ 974C CD 26 95         call    VDP_PrintRamChar
 487+ 974F 1C               inc     e
 488+ 9750 3C               inc     a
 489+ 9751 CD 26 95         call    VDP_PrintRamChar
 490+ 9754 1C               inc     e
 491+ 9755 3C               inc     a
 492+ 9756 CD 26 95         call    VDP_PrintRamChar
 493+ 9759 1C               inc     e
 494+ 975A 3C               inc     a
 495+ 975B CD 26 95         call    VDP_PrintRamChar
 496+ 975E
 497+ 975E F1               pop     af
 498+ 975F D1               pop     de
 499+ 9760 C9               ret
 500+ 9761
 501+ 9761
 502+ 9761
 503+ 9761              ; -----------------------------------------------------------
 504+ 9761              ; Fill game field area to green
 505+ 9761              ; -----------------------------------------------------------
 506+ 9761              FillGameFieldAreaToGreen:
 507+ 9761 F5               push    af
 508+ 9762 C5               push    bc
 509+ 9763 D5               push    de
 510+ 9764 E5               push    hl
 511+ 9765
 512+ 9765 16 00            ld      d, 0
 513+ 9767
 514+ 9767              .Row:
 515+ 9767 D5               push    de
 516+ 9768 1E 01            ld      e, 1
 517+ 976A              .Col:
 518+ 976A D5               push    de
 519+ 976B 3E D6            ld      a, TILE_FIELD
 520+ 976D CD 26 95         call    VDP_PrintRamChar
 521+ 9770 D1               pop     de
 522+ 9771 1C               inc     e
 523+ 9772 7B               ld      a, e
 524+ 9773 FE 15            cp      21
 525+ 9775 28 02            jr      z, .NextRow
 526+ 9777 18 F1            jr      .Col
 527+ 9779              .NextRow:
 528+ 9779 D1               pop     de
 529+ 977A 14               inc     d
 530+ 977B 7A               ld      a, d
 531+ 977C FE 18            cp      24
 532+ 977E 28 02            jr      z, .Done
 533+ 9780 18 E5            jr     .Row
 534+ 9782              .Done:
 535+ 9782 E1               pop     hl
 536+ 9783 D1               pop     de
 537+ 9784 C1               pop     bc
 538+ 9785 F1               pop     af
 539+ 9786 C9               ret
 540+ 9787
 541+ 9787
 542+ 9787
 543+ 9787              ;------------------------------------------------------------------------
 544+ 9787              ; Set screen charater attribute
 545+ 9787              ; INPUT:
 546+ 9787              ;   A: Value
 547+ 9787              ;   D: Character Y position
 548+ 9787              ;   E: Character X position
 549+ 9787              ; OUTPUT: -
 550+ 9787              ; MODIFIES: HL
 551+ 9787              ;------------------------------------------------------------------------
 552+ 9787              VDP_SetCharAttribute:
 553+ 9787 D5                   PUSH    DE
 554+ 9788 E5                   PUSH    HL
 555+ 9789 C5                   PUSH    BC
 556+ 978A F5                   PUSH    AF
 557+ 978B 7A                   LD      A, D    ; Load row in A
 558+ 978C                      ; Before keeping the bits of the third, we carry out the rotations
 559+ 978C 0F                   RRCA
 560+ 978D 0F                   RRCA         ; Passes the bits of the third to bits 0 and 1
 561+ 978E 0F                   RRCA         ; and those of the row to bits 5, 6 and 7
 562+ 978F 6F                   LD      L, A    ; Load the result in L
 563+ 9790 E6 03                AND     0x03     ; A = bits of the third
 564+ 9792 F6 58                OR      0x58     ; Adds the fixed bits of the high part of the address
 565+ 9794 67                   LD      H, A    ; H = 0101 10TT
 566+ 9795 7D                   LD      A, L   ; A = row in bits 5, 6 and 7 and third in bits 0 and 1
 567+ 9796 E6 E0                AND     0xE0     ; Keeps the bits of the line
 568+ 9798 B3                   OR      E       ; Adds the bits of the column
 569+ 9799 6F                   LD      L, A    ; L = RRRC CCCC
 570+ 979A F1                   POP     AF
 571+ 979B 77                   LD      (HL),A          ; Scrivi l'attributo
 572+ 979C FE FF                CP      0xFF
 573+ 979E 20 02                JR      NZ, SetAttributeAtDE_1
 574+ 97A0
 575+ 97A0 36 14                LD      (HL),20
 576+ 97A2              SetAttributeAtDE_1:
 577+ 97A2
 578+ 97A2
 579+ 97A2
 580+ 97A2 C1                   POP     BC
 581+ 97A3 E1                   POP     HL
 582+ 97A4 D1                   POP     DE
 583+ 97A5 C9                   RET
 584+ 97A6
 585+ 97A6              ; -----------------------------------------------------------
 586+ 97A6              ; Draw field
 587+ 97A6              ; -----------------------------------------------------------
 588+ 97A6              VDP_DrawField:
 589+ 97A6
 590+ 97A6 CD 61 97         call    FillGameFieldAreaToGreen
 591+ 97A9 3E 00            ld      a,0
 592+ 97AB              .VLinesLoop:
 593+ 97AB F5               push    af
 594+ 97AC 57               ld      d,a
 595+ 97AD 1E 00            ld      e,0
 596+ 97AF 3E D1            ld      a,TILE_FIELD_LINE_VERTICAL
 597+ 97B1 0E 01            ld      c,1
 598+ 97B3 CD 26 95         call    VDP_PrintRamChar
 599+ 97B6
 600+ 97B6 1E 15            ld      e,21
 601+ 97B8 3E D1            ld      a,TILE_FIELD_LINE_VERTICAL
 602+ 97BA 0E 01            ld      c,1
 603+ 97BC CD 26 95         call    VDP_PrintRamChar
 604+ 97BF
 605+ 97BF F1               pop     af
 606+ 97C0 3C               inc     a
 607+ 97C1 FE 18            cp      24
 608+ 97C3 20 E6            jr      nz,.VLinesLoop
 609+ 97C5
 610+ 97C5
 611+ 97C5
 612+ 97C5
 613+ 97C5 3A 46 86         ld      a,(Var_Game_ActiveFieldSide)
 614+ 97C8 FE 01            cp      FIELD_NORTH_SIDE
 615+ 97CA CA 31 99         jp      z,.North
 616+ 97CD
 617+ 97CD              ; ---------- SOUTH ----------
 618+ 97CD              .South:
 619+ 97CD                  ; pulizia angoli interni
 620+ 97CD 16 17            ld   d,23
 621+ 97CF 1E 00            ld   e,0
 622+ 97D1 3E D6            ld   a,TILE_FIELD
 623+ 97D3 CD 26 95         call VDP_PrintRamChar
 624+ 97D6 16 16            ld   d,22
 625+ 97D8 1E 00            ld   e,0
 626+ 97DA 3E D6            ld   a,TILE_FIELD
 627+ 97DC CD 26 95         call VDP_PrintRamChar
 628+ 97DF 16 15            ld   d,21
 629+ 97E1 1E 00            ld   e,0
 630+ 97E3 3E D6            ld   a,TILE_FIELD
 631+ 97E5 CD 26 95         call VDP_PrintRamChar
 632+ 97E8 16 14            ld   d,20
 633+ 97EA 1E 00            ld   e,0
 634+ 97EC 3E D6            ld   a,TILE_FIELD
 635+ 97EE CD 26 95         call VDP_PrintRamChar
 636+ 97F1 16 17            ld   d,23
 637+ 97F3 1E 15            ld   e,21
 638+ 97F5 3E D6            ld   a,TILE_FIELD
 639+ 97F7 CD 26 95         call VDP_PrintRamChar
 640+ 97FA 16 16            ld   d,22
 641+ 97FC 1E 15            ld   e,21
 642+ 97FE 3E D6            ld   a,TILE_FIELD
 643+ 9800 CD 26 95         call VDP_PrintRamChar
 644+ 9803 16 15            ld   d,21
 645+ 9805 1E 15            ld   e,21
 646+ 9807 3E D6            ld   a,TILE_FIELD
 647+ 9809 CD 26 95         call VDP_PrintRamChar
 648+ 980C 16 14            ld   d,20
 649+ 980E 1E 15            ld   e,21
 650+ 9810 3E D6            ld   a,TILE_FIELD
 651+ 9812 CD 26 95         call VDP_PrintRamChar
 652+ 9815
 653+ 9815                  ; angoli e montanti
 654+ 9815 16 13            ld   d,19
 655+ 9817 1E 00            ld   e,0
 656+ 9819 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 657+ 981B CD 26 95         call VDP_PrintRamChar
 658+ 981E 16 13            ld   d,19
 659+ 9820 1E 15            ld   e,21
 660+ 9822 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 661+ 9824 CD 26 95         call VDP_PrintRamChar
 662+ 9827 16 17            ld   d,23
 663+ 9829 1E 04            ld   e,4
 664+ 982B 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 665+ 982D CD 26 95         call VDP_PrintRamChar
 666+ 9830 16 17            ld   d,23
 667+ 9832 1E 11            ld   e,17
 668+ 9834 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 669+ 9836 CD 26 95         call VDP_PrintRamChar
 670+ 9839 16 13            ld   d,19
 671+ 983B 1E 04            ld   e,4
 672+ 983D 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 673+ 983F CD 26 95         call VDP_PrintRamChar
 674+ 9842 16 13            ld   d,19
 675+ 9844 1E 11            ld   e,17
 676+ 9846 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 677+ 9848 CD 26 95         call VDP_PrintRamChar
 678+ 984B
 679+ 984B                  ; montanti verticali
 680+ 984B 16 14            ld   d,20
 681+ 984D 1E 11            ld   e,17
 682+ 984F 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 683+ 9851 0E 01            ld   c,1
 684+ 9853 CD 26 95         call VDP_PrintRamChar
 685+ 9856 16 15            ld   d,21
 686+ 9858 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 687+ 985A 0E 01            ld   c,1
 688+ 985C CD 26 95         call VDP_PrintRamChar
 689+ 985F 16 16            ld   d,22
 690+ 9861 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 691+ 9863 0E 01            ld   c,1
 692+ 9865 CD 26 95         call VDP_PrintRamChar
 693+ 9868 16 14            ld   d,20
 694+ 986A 1E 04            ld   e,4
 695+ 986C 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 696+ 986E 0E 01            ld   c,1
 697+ 9870 CD 26 95         call VDP_PrintRamChar
 698+ 9873 16 15            ld   d,21
 699+ 9875 1E 04            ld   e,4
 700+ 9877 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 701+ 9879 0E 01            ld   c,1
 702+ 987B CD 26 95         call VDP_PrintRamChar
 703+ 987E 16 16            ld   d,22
 704+ 9880 1E 04            ld   e,4
 705+ 9882 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 706+ 9884 0E 01            ld   c,1
 707+ 9886 CD 26 95         call VDP_PrintRamChar
 708+ 9889
 709+ 9889                  ; segmenti orizzontali
 710+ 9889 16 13            ld   d,19
 711+ 988B 1E 01            ld   e,1
 712+ 988D 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 713+ 988F CD 26 95         call VDP_PrintRamChar
 714+ 9892 1E 02            ld   e,2
 715+ 9894 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 716+ 9896 CD 26 95         call VDP_PrintRamChar
 717+ 9899 1E 03            ld   e,3
 718+ 989B 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 719+ 989D CD 26 95         call VDP_PrintRamChar
 720+ 98A0 1E 12            ld   e,18
 721+ 98A2 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 722+ 98A4 CD 26 95         call VDP_PrintRamChar
 723+ 98A7 1E 13            ld   e,19
 724+ 98A9 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 725+ 98AB CD 26 95         call VDP_PrintRamChar
 726+ 98AE 1E 14            ld   e,20
 727+ 98B0 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 728+ 98B2 CD 26 95         call VDP_PrintRamChar
 729+ 98B5 16 17            ld   d,23
 730+ 98B7 1E 05            ld   e,5
 731+ 98B9 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 732+ 98BB CD 26 95         call VDP_PrintRamChar
 733+ 98BE 1E 06            ld   e,6
 734+ 98C0 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 735+ 98C2 CD 26 95         call VDP_PrintRamChar
 736+ 98C5 1E 07            ld   e,7
 737+ 98C7 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 738+ 98C9 CD 26 95         call VDP_PrintRamChar
 739+ 98CC 1E 08            ld   e,8
 740+ 98CE 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 741+ 98D0 CD 26 95         call VDP_PrintRamChar
 742+ 98D3 1E 09            ld   e,9
 743+ 98D5 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 744+ 98D7 CD 26 95         call VDP_PrintRamChar
 745+ 98DA 1E 0A            ld   e,10
 746+ 98DC 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 747+ 98DE CD 26 95         call VDP_PrintRamChar
 748+ 98E1 1E 0B            ld   e,11
 749+ 98E3 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 750+ 98E5 CD 26 95         call VDP_PrintRamChar
 751+ 98E8 1E 0C            ld   e,12
 752+ 98EA 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 753+ 98EC CD 26 95         call VDP_PrintRamChar
 754+ 98EF 1E 0D            ld   e,13
 755+ 98F1 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 756+ 98F3 CD 26 95         call VDP_PrintRamChar
 757+ 98F6 1E 0E            ld   e,14
 758+ 98F8 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 759+ 98FA CD 26 95         call VDP_PrintRamChar
 760+ 98FD 1E 0F            ld   e,15
 761+ 98FF 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 762+ 9901 CD 26 95         call VDP_PrintRamChar
 763+ 9904 1E 10            ld   e,16
 764+ 9906 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 765+ 9908 CD 26 95         call VDP_PrintRamChar
 766+ 990B
 767+ 990B                  ; croci
 768+ 990B 16 06            ld   d,6
 769+ 990D 1E 00            ld   e,0
 770+ 990F 3E D7            ld   a,TILE_FIELD_LINE_LEFT_CROSS
 771+ 9911 CD 26 95         call VDP_PrintRamChar
 772+ 9914 1E 15            ld   e,21
 773+ 9916 3E D8            ld   a,TILE_FIELD_LINE_RIGHT_CROSS
 774+ 9918 CD 26 95         call VDP_PrintRamChar
 775+ 991B
 776+ 991B                  ; metà campo (riga 6): da col 1 a 20
 777+ 991B 3E 01            ld   a,1
 778+ 991D              .SouthLoop:
 779+ 991D 16 06            ld   d,6
 780+ 991F F5               push af
 781+ 9920 5F               ld   e,a
 782+ 9921 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 783+ 9923 0E 01            ld   c,1
 784+ 9925 CD 26 95         call VDP_PrintRamChar
 785+ 9928 F1               pop  af
 786+ 9929 3C               inc  a
 787+ 992A FE 15            cp   21
 788+ 992C 20 EF            jr   nz,.SouthLoop
 789+ 992E C3 8E 9A         jp   .Done
 790+ 9931              .North:
 791+ 9931 16 00            ld   d,0
 792+ 9933 1E 00            ld   e,0
 793+ 9935 3E D6            ld   a,TILE_FIELD
 794+ 9937 CD 26 95         call VDP_PrintRamChar
 795+ 993A 16 01            ld   d,1
 796+ 993C 1E 00            ld   e,0
 797+ 993E 3E D6            ld   a,TILE_FIELD
 798+ 9940 CD 26 95         call VDP_PrintRamChar
 799+ 9943 16 02            ld   d,2
 800+ 9945 1E 00            ld   e,0
 801+ 9947 3E D6            ld   a,TILE_FIELD
 802+ 9949 CD 26 95         call VDP_PrintRamChar
 803+ 994C 16 03            ld   d,3
 804+ 994E 1E 00            ld   e,0
 805+ 9950 3E D6            ld   a,TILE_FIELD
 806+ 9952 CD 26 95         call VDP_PrintRamChar
 807+ 9955 16 00            ld   d,0
 808+ 9957 1E 15            ld   e,21
 809+ 9959 3E D6            ld   a,TILE_FIELD
 810+ 995B CD 26 95         call VDP_PrintRamChar
 811+ 995E 16 01            ld   d,1
 812+ 9960 1E 15            ld   e,21
 813+ 9962 3E D6            ld   a,TILE_FIELD
 814+ 9964 CD 26 95         call VDP_PrintRamChar
 815+ 9967 16 02            ld   d,2
 816+ 9969 1E 15            ld   e,21
 817+ 996B 3E D6            ld   a,TILE_FIELD
 818+ 996D CD 26 95         call VDP_PrintRamChar
 819+ 9970 16 03            ld   d,3
 820+ 9972 1E 15            ld   e,21
 821+ 9974 3E D6            ld   a,TILE_FIELD
 822+ 9976 CD 26 95         call VDP_PrintRamChar
 823+ 9979
 824+ 9979                  ; angoli e montanti
 825+ 9979 16 04            ld   d,4
 826+ 997B 1E 00            ld   e,0
 827+ 997D 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 828+ 997F CD 26 95         call VDP_PrintRamChar
 829+ 9982 16 04            ld   d,4
 830+ 9984 1E 15            ld   e,21
 831+ 9986 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 832+ 9988 CD 26 95         call VDP_PrintRamChar
 833+ 998B 16 00            ld   d,0
 834+ 998D 1E 04            ld   e,4
 835+ 998F 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 836+ 9991 CD 26 95         call VDP_PrintRamChar
 837+ 9994 16 00            ld   d,0
 838+ 9996 1E 11            ld   e,17
 839+ 9998 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 840+ 999A CD 26 95         call VDP_PrintRamChar
 841+ 999D 16 04            ld   d,4
 842+ 999F 1E 04            ld   e,4
 843+ 99A1 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 844+ 99A3 CD 26 95         call VDP_PrintRamChar
 845+ 99A6 16 04            ld   d,4
 846+ 99A8 1E 11            ld   e,17
 847+ 99AA 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 848+ 99AC CD 26 95         call VDP_PrintRamChar
 849+ 99AF
 850+ 99AF                  ; montanti verticali
 851+ 99AF 16 01            ld   d,1
 852+ 99B1 1E 11            ld   e,17
 853+ 99B3 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 854+ 99B5 CD 26 95         call VDP_PrintRamChar
 855+ 99B8 16 02            ld   d,2
 856+ 99BA 1E 11            ld   e,17
 857+ 99BC 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 858+ 99BE CD 26 95         call VDP_PrintRamChar
 859+ 99C1 16 03            ld   d,3
 860+ 99C3 1E 11            ld   e,17
 861+ 99C5 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 862+ 99C7 CD 26 95         call VDP_PrintRamChar
 863+ 99CA 16 01            ld   d,1
 864+ 99CC 1E 04            ld   e,4
 865+ 99CE 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 866+ 99D0 CD 26 95         call VDP_PrintRamChar
 867+ 99D3 16 02            ld   d,2
 868+ 99D5 1E 04            ld   e,4
 869+ 99D7 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 870+ 99D9 CD 26 95         call VDP_PrintRamChar
 871+ 99DC 16 03            ld   d,3
 872+ 99DE 1E 04            ld   e,4
 873+ 99E0 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 874+ 99E2 CD 26 95         call VDP_PrintRamChar
 875+ 99E5
 876+ 99E5                  ; segmenti orizzontali
 877+ 99E5 16 04            ld   d,4
 878+ 99E7 1E 01            ld   e,1
 879+ 99E9 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 880+ 99EB CD 26 95         call VDP_PrintRamChar
 881+ 99EE 1E 02            ld   e,2
 882+ 99F0 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 883+ 99F2 CD 26 95         call VDP_PrintRamChar
 884+ 99F5 1E 03            ld   e,3
 885+ 99F7 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 886+ 99F9 CD 26 95         call VDP_PrintRamChar
 887+ 99FC 1E 12            ld   e,18
 888+ 99FE 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 889+ 9A00 CD 26 95         call VDP_PrintRamChar
 890+ 9A03 1E 13            ld   e,19
 891+ 9A05 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 892+ 9A07 CD 26 95         call VDP_PrintRamChar
 893+ 9A0A 1E 14            ld   e,20
 894+ 9A0C 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 895+ 9A0E CD 26 95         call VDP_PrintRamChar
 896+ 9A11 16 00            ld   d,0
 897+ 9A13 1E 05            ld   e,5
 898+ 9A15 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 899+ 9A17 CD 26 95         call VDP_PrintRamChar
 900+ 9A1A 16 00            ld   d,0
 901+ 9A1C 1E 06            ld   e,6
 902+ 9A1E 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 903+ 9A20 CD 26 95         call VDP_PrintRamChar
 904+ 9A23 16 00            ld   d,0
 905+ 9A25 1E 07            ld   e,7
 906+ 9A27 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 907+ 9A29 CD 26 95         call VDP_PrintRamChar
 908+ 9A2C 1E 08            ld   e,8
 909+ 9A2E 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 910+ 9A30 CD 26 95         call VDP_PrintRamChar
 911+ 9A33 1E 09            ld   e,9
 912+ 9A35 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 913+ 9A37 CD 26 95         call VDP_PrintRamChar
 914+ 9A3A 1E 0A            ld   e,10
 915+ 9A3C 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 916+ 9A3E CD 26 95         call VDP_PrintRamChar
 917+ 9A41 1E 0B            ld   e,11
 918+ 9A43 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 919+ 9A45 CD 26 95         call VDP_PrintRamChar
 920+ 9A48 1E 0C            ld   e,12
 921+ 9A4A 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 922+ 9A4C CD 26 95         call VDP_PrintRamChar
 923+ 9A4F 1E 0D            ld   e,13
 924+ 9A51 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 925+ 9A53 CD 26 95         call VDP_PrintRamChar
 926+ 9A56 1E 0E            ld   e,14
 927+ 9A58 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 928+ 9A5A CD 26 95         call VDP_PrintRamChar
 929+ 9A5D 1E 0F            ld   e,15
 930+ 9A5F 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 931+ 9A61 CD 26 95         call VDP_PrintRamChar
 932+ 9A64 1E 10            ld   e,16
 933+ 9A66 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 934+ 9A68 CD 26 95         call VDP_PrintRamChar
 935+ 9A6B                  ; croci
 936+ 9A6B 16 11            ld   d,17
 937+ 9A6D 1E 00            ld   e,0
 938+ 9A6F 3E D7            ld   a,TILE_FIELD_LINE_LEFT_CROSS
 939+ 9A71 CD 26 95         call VDP_PrintRamChar
 940+ 9A74 1E 15            ld   e,21
 941+ 9A76 3E D8            ld   a,TILE_FIELD_LINE_RIGHT_CROSS
 942+ 9A78 CD 26 95         call VDP_PrintRamChar
 943+ 9A7B
 944+ 9A7B                  ; metà campo (riga 17): da col 1 a 20
 945+ 9A7B 3E 01            ld   a,1
 946+ 9A7D              .NorthLoop:
 947+ 9A7D 16 11            ld   d,17
 948+ 9A7F F5               push af
 949+ 9A80 5F               ld   e,a
 950+ 9A81 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 951+ 9A83 0E 01            ld   c,1
 952+ 9A85 CD 26 95         call VDP_PrintRamChar
 953+ 9A88 F1               pop  af
 954+ 9A89 3C               inc  a
 955+ 9A8A FE 15            cp   21
 956+ 9A8C 20 EF            jr   nz, .NorthLoop
 957+ 9A8E              .Done:
 958+ 9A8E                  ;POP  AF
 959+ 9A8E                  ;OR   01000000b      ; forza display ON (bit 6 = 1) indipendentemente dal valore letto
 960+ 9A8E                  ;LD   C, 1
 961+ 9A8E                  ;CALL VDP_SetReg
 962+ 9A8E                  ;POP  BC
 963+ 9A8E                  ;POP  AF
 964+ 9A8E C9               RET
 965+ 9A8F              ; ---------------------------------------------------------------------------
 966+ 9A8F              ; Maps logical 5x5 matrix coords (0..4) in DE to Name Table coordinates.
 967+ 9A8F              ;
 968+ 9A8F              ; INPUT:
 969+ 9A8F              ;   D = logical Y (0..4)
 970+ 9A8F              ;   E = logical X (0..4)
 971+ 9A8F              ;   Var_Game_ActiveFieldSide:
 972+ 9A8F              ;       FIELD_NORTH_SIDE / FIELD_SOUTH_SIDE
 973+ 9A8F              ; OUTPUT:
 974+ 9A8F              ;   D = screen row  (Name Table)
 975+ 9A8F              ;   E = screen col  (Name Table)
 976+ 9A8F              ; MODIFIES:
 977+ 9A8F              ;   AF
 978+ 9A8F              ; ---------------------------------------------------------------------------
 979+ 9A8F              VDP_MapMatrixToScreen_DE:
 980+ 9A8F                  ; ---- Columns: X 0..4 -> 1,5,9,13,17 ----
 981+ 9A8F 7B               LD      A,E
 982+ 9A90 87               ADD     A,A          ; 2X
 983+ 9A91 87               ADD     A,A          ; 4X
 984+ 9A92 3C               INC     A            ; 4X+1
 985+ 9A93 5F               LD      E,A
 986+ 9A94
 987+ 9A94                  ; ---- Rows: dipendono dalla metà campo attiva ----
 988+ 9A94 3A 46 86         LD      A,(Var_Game_ActiveFieldSide)
 989+ 9A97 FE 01            CP      FIELD_NORTH_SIDE
 990+ 9A99 28 20            JR      Z,.NorthRows
 991+ 9A9B
 992+ 9A9B                  ; ===== SOUTH =====
 993+ 9A9B                  ; Y: 0,1,2,3,4 -> 2,7,11,15,19
 994+ 9A9B 7A               LD      A,D
 995+ 9A9C FE 00            CP      0
 996+ 9A9E 28 0F            JR      Z,.SRow0
 997+ 9AA0 FE 01            CP      1
 998+ 9AA2 28 0E            JR      Z,.SRow1
 999+ 9AA4 FE 02            CP      2
1000+ 9AA6 28 0D            JR      Z,.SRow2
1001+ 9AA8 FE 03            CP      3
1002+ 9AAA 28 0C            JR      Z,.SRow3
1003+ 9AAC 16 13            LD      D,19
1004+ 9AAE C9               RET
1005+ 9AAF
1006+ 9AAF              .SRow0:
1007+ 9AAF 16 02            LD      D,2
1008+ 9AB1 C9               RET
1009+ 9AB2              .SRow1:
1010+ 9AB2 16 07            LD      D,7
1011+ 9AB4 C9               RET
1012+ 9AB5              .SRow2:
1013+ 9AB5 16 0B            LD      D,11
1014+ 9AB7 C9               RET
1015+ 9AB8              .SRow3:
1016+ 9AB8 16 0F            LD      D,15
1017+ 9ABA C9               RET
1018+ 9ABB
1019+ 9ABB                  ; ===== NORTH =====
1020+ 9ABB              .NorthRows:
1021+ 9ABB                  ; Y: 0,1,2,3,4 -> 1,5,9,13,18
1022+ 9ABB 7A               LD      A,D
1023+ 9ABC 87               ADD     A,A          ; 2Y
1024+ 9ABD 87               ADD     A,A          ; 4Y
1025+ 9ABE 3C               INC     A            ; 4Y+1  => 1,5,9,13,17
1026+ 9ABF FE 11            CP      17
1027+ 9AC1 20 01            JR      NZ,.NRowOK
1028+ 9AC3 3C               INC     A            ; solo per Y=4: 17 -> 18
1029+ 9AC4              .NRowOK:
1030+ 9AC4 57               LD      D,A
1031+ 9AC5 C9               RET
1032+ 9AC6              ; ---------------------------------------------------------
1033+ 9AC6              ; Rimuove il giocatore virtuale dallo schermo (se visibile)
1034+ 9AC6              ; ---------------------------------------------------------
1035+ 9AC6              VDP_RemoveVirtualPlayer:
1036+ 9AC6 3A 68 86         LD  A,(Var_Game_VirtualPlayerYPos)
1037+ 9AC9 FE FF            CP  255
1038+ 9ACB C8               RET Z
1039+ 9ACC 57               LD  D, A
1040+ 9ACD 3A 69 86         LD  A,(Var_Game_VirtualPlayerXPos)
1041+ 9AD0 5F               LD  E, A
1042+ 9AD1 CD 8F 9A         CALL VDP_MapMatrixToScreen_DE
1043+ 9AD4 3E D6            LD  A, TILE_FIELD
1044+ 9AD6 CD BC 95         CALL VDP_DrawSprite
1045+ 9AD9 3E FF            LD  A, 255
1046+ 9ADB 32 68 86         LD  (Var_Game_VirtualPlayerYPos), A
1047+ 9ADE C9               RET
1048+ 9ADF              ; ---------------------------------------------------------
1049+ 9ADF              ; Disegno del giocatore virtuale (se visibile)
1050+ 9ADF              ; ---------------------------------------------------------
1051+ 9ADF              VDP_PlayerMatrixRedraw_DrawVirtual:
1052+ 9ADF                  ; se Y = 255 → non disegnare
1053+ 9ADF 3A 68 86         ld   a,(Var_Game_VirtualPlayerYPos)
1054+ 9AE2 FE FF            cp   255
1055+ 9AE4 28 22            jr   z,VDP_PlayerMatrixRedraw_Done   ; salta se invisibile
1056+ 9AE6
1057+ 9AE6                  ; D = Y, E = X (coordinate di matrice 0..4)
1058+ 9AE6 57               ld   d,a                             ; D = Y
1059+ 9AE7 3A 69 86         ld   a,(Var_Game_VirtualPlayerXPos)
1060+ 9AEA 5F               ld   e,a                             ; E = X
1061+ 9AEB
1062+ 9AEB                  ; salviamo i registri che useremo
1063+ 9AEB F5               push af
1064+ 9AEC C5               push bc
1065+ 9AED D5               push de
1066+ 9AEE E5               push hl
1067+ 9AEF
1068+ 9AEF                  ; scegli il tile in base alla squadra virtuale
1069+ 9AEF 3A 6A 86         ld   a,(Var_Game_VirtualPlayerTeam)
1070+ 9AF2 FE 00            cp   TEAM_BLACK
1071+ 9AF4 20 04            jr   nz,.VirtWhite
1072+ 9AF6
1073+ 9AF6                  ; squadra nera → usa giocatore nero
1074+ 9AF6 3E B0            ld   a,TILE_BLACK_PLAYER
1075+ 9AF8 18 02            jr   .VirtHaveTile
1076+ 9AFA
1077+ 9AFA              .VirtWhite:
1078+ 9AFA                  ; squadra bianca → usa giocatore bianco
1079+ 9AFA 3E A0            ld   a,TILE_WHITE_PLAYER
1080+ 9AFC
1081+ 9AFC              .VirtHaveTile:
1082+ 9AFC                  ; mappa (D,E) -> coordinate schermo in (D,E)
1083+ 9AFC F5               PUSH  AF
1084+ 9AFD CD 8F 9A         call VDP_MapMatrixToScreen_DE
1085+ 9B00 F1               POP   AF
1086+ 9B01                  ; A = tile di base, D,E = row/col → disegna lo sprite
1087+ 9B01 CD BC 95         call VDP_DrawSprite
1088+ 9B04
1089+ 9B04                  ; ripristina registri
1090+ 9B04 E1               pop  hl
1091+ 9B05 D1               pop  de
1092+ 9B06 C1               pop  bc
1093+ 9B07 F1               pop  af
1094+ 9B08
1095+ 9B08              VDP_PlayerMatrixRedraw_Done:
1096+ 9B08                  ; qui metti i tuoi:
1097+ 9B08                  ; POP HL
1098+ 9B08                  ; POP DE
1099+ 9B08                  ; POP BC
1100+ 9B08                  ; POP AF
1101+ 9B08 C9                RET
1102+ 9B09
1103+ 9B09              ;----------------------------------------------------------------------------
1104+ 9B09              ;  Sets VDP register
1105+ 9B09              ;----------------------------------------------------------------------------
1106+ 9B09              VDP_SetReg:
1107+ 9B09                  ; In: A = value, C = reg#
1108+ 9B09                  ; Usa la porta VDP control: 99h
1109+ 9B09
1110+ 9B09 F5               push af
1111+ 9B0A DB 99            in   a,(099h)        ; reset latch (riallinea first/second write)
1112+ 9B0C F1               pop  af
1113+ 9B0D
1114+ 9B0D D3 99            out  (099h),a        ; value
1115+ 9B0F 79               ld   a,c
1116+ 9B10 F6 80            or   080h
1117+ 9B12 D3 99            out  (099h),a        ; select register write
1118+ 9B14 C9               ret
1119+ 9B15
1120+ 9B15              ; ---------------------------------------------------------------------------
1121+ 9B15              ; Redraws all players on screen using Var_Game_PlayersInfo, tramite
1122+ 9B15              ; GetPlayerInfoById.
1123+ 9B15              ;
1124+ 9B15              ; Per ogni giocatore:
1125+ 9B15              ;   - prende PREV_X/PREV_Y e CUR_X/CUR_Y da GetPlayerInfoById;
1126+ 9B15              ;   - se PREV_Y != 255 disegna TILE_FIELD alla vecchia posizione;
1127+ 9B15              ;   - se CUR_Y  != 255 disegna la tile corretta alla posizione attuale:
1128+ 9B15              ;       * ID = 0 (portiere):
1129+ 9B15              ;           - se Var_Game_GoalkeeperHasBall = YES:
1130+ 9B15              ;               TEAM_BLACK -> TILE_BLACK_GOALKEEPER_WITH_BALL
1131+ 9B15              ;               TEAM_WHITE -> TILE_WHITE_GOALKEEPER_WITH_BALL
1132+ 9B15              ;           - altrimenti:
1133+ 9B15              ;               TEAM_BLACK -> TILE_BLACK_GOALKEEPER
1134+ 9B15              ;               TEAM_WHITE -> TILE_WHITE_GOALKEEPER
1135+ 9B15              ;       * ID != 0:
1136+ 9B15              ;               TEAM_BLACK -> TILE_BLACK_PLAYER
1137+ 9B15              ;               TEAM_WHITE -> TILE_WHITE_PLAYER
1138+ 9B15              ;
1139+ 9B15              ; INPUT:  -
1140+ 9B15              ; OUTPUT: giocatori ridisegnati
1141+ 9B15              ; PRESERVA: AF, BC, DE, HL
1142+ 9B15              ; ---------------------------------------------------------------------------
1143+ 9B15              VDP_PlayerMatrixRedraw:
1144+ 9B15 F5               PUSH AF
1145+ 9B16 C5               PUSH BC
1146+ 9B17 D5               PUSH DE
1147+ 9B18 E5               PUSH HL
1148+ 9B19
1149+ 9B19 3A 74 86         ld  a,(Var_Game_BallYOldPosition)
1150+ 9B1C FE FF            cp  NO_VALUE
1151+ 9B1E 28 0D            jr  z,.no_old_ball
1152+ 9B20
1153+ 9B20 57               ld  d,a                          ; Y old
1154+ 9B21 3A 75 86         ld  a,(Var_Game_BallXOldPosition)
1155+ 9B24 5F               ld  e,a                          ; X old
1156+ 9B25 CD 8F 9A         call VDP_MapMatrixToScreen_DE
1157+ 9B28 3E D6            ld  a,TILE_FIELD
1158+ 9B2A CD BC 95         call VDP_DrawSprite
1159+ 9B2D
1160+ 9B2D
1161+ 9B2D
1162+ 9B2D
1163+ 9B2D              .no_old_ball:
1164+ 9B2D
1165+ 9B2D                  ; ---- disegna prima TEAM_BLACK, poi TEAM_WHITE ----
1166+ 9B2D 06 00            LD   B,TEAM_BLACK
1167+ 9B2F CD 32 9C         CALL VPMR_DrawTeam
1168+ 9B32
1169+ 9B32 06 01            LD   B,TEAM_WHITE
1170+ 9B34 CD 32 9C         CALL VPMR_DrawTeam
1171+ 9B37 CD DF 9A         CALL VDP_PlayerMatrixRedraw_DrawVirtual
1172+ 9B3A CD 45 9B         CALL VDP_DrawBallOnMatrix
1173+ 9B3D CD 1C A3         CALL Game_ClearSinglePlayerPrevPositions
1174+ 9B40 E1               POP  HL
1175+ 9B41 D1               POP  DE
1176+ 9B42 C1               POP  BC
1177+ 9B43 F1               POP  AF
1178+ 9B44 C9               RET
1179+ 9B45
1180+ 9B45              ;---------------------------------------------------------------
1181+ 9B45              ; Disegna la palla sulla matrice (o portiere/giocatore con palla)
1182+ 9B45              ; Usa:
1183+ 9B45              ;   Var_Game_BallXPosition / Var_Game_BallYPosition
1184+ 9B45              ;   Var_Game_BallDirection, Var_Game_BallDiagonalMovCounter
1185+ 9B45              ;   Var_Game_ActiveFieldSide
1186+ 9B45              ;---------------------------------------------------------------
1187+ 9B45              VDP_DrawBallOnMatrix:
1188+ 9B45 F5               push af
1189+ 9B46 C5               push bc
1190+ 9B47 D5               push de
1191+ 9B48 E5               push hl
1192+ 9B49
1193+ 9B49                  ; di default nessun portiere con palla
1194+ 9B49 3E 00            ld   a,NO
1195+ 9B4B 32 65 86         ld   (Var_Game_GoalkeeperHasBall),a
1196+ 9B4E
1197+ 9B4E                  ; HL = X,Y della palla
1198+ 9B4E CD FD A1         call Game_GetBallPosition
1199+ 9B51
1200+ 9B51                  ; cerca eventuale giocatore in D/E
1201+ 9B51 CD DF A2         call Game_GetPlayerInfoByPos
1202+ 9B54 FE FF            cp   NO_VALUE
1203+ 9B56 CA D1 9B         jp   z,.no_player      ; casella vuota → gestisce solo la palla
1204+ 9B59
1205+ 9B59                  ;-----------------------------------------------------------
1206+ 9B59                  ; QUI C’E’ UN GIOCATORE
1207+ 9B59                  ;  B = TEAM   (0 nero, 1 bianco)
1208+ 9B59                  ;  C = ID     (0 portiere)
1209+ 9B59                  ;  A = ROLE
1210+ 9B59                  ;  HL = pos corrente, DE = pos precedente
1211+ 9B59                  ;-----------------------------------------------------------
1212+ 9B59
1213+ 9B59 79               ld   a,c
1214+ 9B5A B7               or   a
1215+ 9B5B 20 1A            jr   nz,.field_player      ; ID!=0 → giocatore di movimento
1216+ 9B5D
1217+ 9B5D                  ;--------- PORTIERE ----------------------------------------
1218+ 9B5D 3E 01            ld   a,YES
1219+ 9B5F 32 65 86         ld   (Var_Game_GoalkeeperHasBall),a
1220+ 9B62
1221+ 9B62 78               ld   a,b
1222+ 9B63 FE 00            cp   TEAM_BLACK
1223+ 9B65 20 08            jr   nz,.white_gk
1224+ 9B67 CD BB AA         call Game_StopShot
1225+ 9B6A 3E 90            ld   a,TILE_BLACK_GOALKEEPER_WITH_BALL
1226+ 9B6C C3 FB 9B         jp   .draw_sprite_with_ball_pos
1227+ 9B6F
1228+ 9B6F              .white_gk:
1229+ 9B6F CD BB AA         call Game_StopShot
1230+ 9B72 3E 70            ld   a,TILE_WHITE_GOALKEEPER_WITH_BALL
1231+ 9B74 C3 FB 9B         jp   .draw_sprite_with_ball_pos
1232+ 9B77
1233+ 9B77
1234+ 9B77              ;--------- GIOCATORE DI MOVIMENTO -------------------------------
1235+ 9B77              .field_player:
1236+ 9B77                  ; logica in base a Var_Game_BallDirection
1237+ 9B77 3A 66 86         ld   a,(Var_Game_BallDirection)
1238+ 9B7A FE 00            cp   BALL_DIRECTION_NONE
1239+ 9B7C 28 1A            jr   z,.bp_none
1240+ 9B7E FE 01            cp   BALL_DIRECTION_NORTH
1241+ 9B80 28 1F            jr   z,.bp_north
1242+ 9B82 FE 02            cp   BALL_DIRECTION_NORTH_EAST
1243+ 9B84 28 2D            jr   z,.bp_ne_nw
1244+ 9B86 FE 03            cp   BALL_DIRECTION_NORTH_WEST
1245+ 9B88 28 29            jr   z,.bp_ne_nw
1246+ 9B8A FE 04            cp   BALL_DIRECTION_SOUTH
1247+ 9B8C 28 30            jr   z,.bp_south
1248+ 9B8E FE 05            cp   BALL_DIRECTION_SOUTH_EAST
1249+ 9B90 28 30            jr   z,.bp_se_sw
1250+ 9B92 FE 06            cp   BALL_DIRECTION_SOUTH_WEST
1251+ 9B94 28 2C            jr   z,.bp_se_sw
1252+ 9B96                  ; default → trattiamo come palla ferma
1253+ 9B96 18 00            jr   .bp_none
1254+ 9B98
1255+ 9B98              ; palla statica sul giocatore → semplicemente “contatto”,
1256+ 9B98              ; giocatore nero con palla e direzione azzerata (adatta se vuoi
1257+ 9B98              ; gestire anche il bianco come nel tuo codice originale)
1258+ 9B98              .bp_none:
1259+ 9B98 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1260+ 9B9A 4F               ld   c,a
1261+ 9B9B CD BB AA         call Game_StopShot
1262+ 9B9E 79               ld   a,c
1263+ 9B9F 18 5A            jr   .draw_sprite_with_ball_pos
1264+ 9BA1
1265+ 9BA1              ; palla che arriva da N → se nero: tiene la palla e si ferma,
1266+ 9BA1              ; se bianco: solo disegno del bianco con palla (come da specifiche).
1267+ 9BA1              .bp_north:
1268+ 9BA1 78               ld   a,b
1269+ 9BA2 FE 00            cp   TEAM_BLACK
1270+ 9BA4 20 09            jr   nz,.bp_north_white
1271+ 9BA6 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1272+ 9BA8 4F               ld   c,a
1273+ 9BA9 CD BB AA         call Game_StopShot
1274+ 9BAC 79               ld   a,c
1275+ 9BAD 18 4C            jr   .draw_sprite_with_ball_pos
1276+ 9BAF
1277+ 9BAF              .bp_north_white:
1278+ 9BAF 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1279+ 9BB1 18 48            jr   .draw_sprite_with_ball_pos
1280+ 9BB3
1281+ 9BB3              ; diagonale NORD (NE/NW) con contatore=1 → palla dietro al giocatore
1282+ 9BB3              .bp_ne_nw:
1283+ 9BB3 3A 67 86         ld   a,(Var_Game_BallDiagonalMovCounter)
1284+ 9BB6 FE 00            cp   0
1285+ 9BB8 20 73            jr   nz,.exit            ; niente di speciale
1286+ 9BBA 3E 02            ld   a,TILE_BLACK_PLAYER_WITH_BACK_BALL
1287+ 9BBC 18 3D            jr   .draw_sprite_with_ball_pos
1288+ 9BBE
1289+ 9BBE              ; palla da S → nero la controlla e si ferma
1290+ 9BBE              .bp_south:
1291+ 9BBE 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1292+ 9BC0                  ;ld   c,a
1293+ 9BC0                  ;call Game_StopShot
1294+ 9BC0                  ;ld   a,c
1295+ 9BC0 18 39            jr   .draw_sprite_with_ball_pos
1296+ 9BC2
1297+ 9BC2              ; diagonale SUD (SE/SW)
1298+ 9BC2              .bp_se_sw:
1299+ 9BC2 3A 67 86         ld   a,(Var_Game_BallDiagonalMovCounter)
1300+ 9BC5 FE 00            cp   0
1301+ 9BC7 28 04            jr   z,.bp_se_sw_counter1
1302+ 9BC9
1303+ 9BC9                  ; contatore !=1 → nero riceve palla davanti e si ferma
1304+ 9BC9 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1305+ 9BCB                  ;ld   c,a
1306+ 9BCB                  ;call Game_StopShot
1307+ 9BCB                  ;ld   a,c
1308+ 9BCB 18 2E            jr   .draw_sprite_with_ball_pos
1309+ 9BCD
1310+ 9BCD              .bp_se_sw_counter1:
1311+ 9BCD                  ; contatore=1 → bianco con palla
1312+ 9BCD 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1313+ 9BCF 18 2A            jr   .draw_sprite_with_ball_pos
1314+ 9BD1
1315+ 9BD1
1316+ 9BD1              ;================ CASO NESSUN GIOCATORE NELLA CASELLA ==============
1317+ 9BD1              .no_player:
1318+ 9BD1                  ; Qui dobbiamo decidere se BALL_BOTTOM o BALL_TOP.
1319+ 9BD1                  ; *** IMPORTANTE ***:
1320+ 9BD1                  ;  - teniamo la tile in C
1321+ 9BD1                  ;  - usiamo A solo per confronti
1322+ 9BD1 0E 40            ld   c,TILE_BALL_BOTTOM       ; default
1323+ 9BD3
1324+ 9BD3                  ; --- caso 1: diagonale NORD (NE/NW) con contatore = 1 → BALL_TOP
1325+ 9BD3 3A 66 86         ld   a,(Var_Game_BallDirection)
1326+ 9BD6 FE 02            cp   BALL_DIRECTION_NORTH_EAST
1327+ 9BD8 28 04            jr   z,.np_diag_north
1328+ 9BDA FE 03            cp   BALL_DIRECTION_NORTH_WEST
1329+ 9BDC 20 09            jr   nz,.np_after_diag
1330+ 9BDE
1331+ 9BDE              .np_diag_north:
1332+ 9BDE 3A 67 86         ld   a,(Var_Game_BallDiagonalMovCounter)
1333+ 9BE1 FE 00            cp   0
1334+ 9BE3 20 02            jr   nz,.np_after_diag
1335+ 9BE5 0E 06            ld   c,TILE_BALL_TOP          ; override
1336+ 9BE7
1337+ 9BE7              .np_after_diag:
1338+ 9BE7 79               ld   a,c                       ; rimetti la tile scelta in A
1339+ 9BE8 18 00            jr   .chk_fieldside_top
1340+ 9BEA
1341+ 9BEA
1342+ 9BEA              ;----------------- TUO BLOCCO OTTIMIZZATO --------------------------
1343+ 9BEA              ; --- caso 2: FIELD_NORTH_SIDE e Y=0 -> BALL_TOP --------------
1344+ 9BEA              .chk_fieldside_top:
1345+ 9BEA 4F               ld   c,a                       ; salva la tile in C
1346+ 9BEB
1347+ 9BEB 3A 46 86         ld   a,(Var_Game_ActiveFieldSide)
1348+ 9BEE FE 01            cp   FIELD_NORTH_SIDE
1349+ 9BF0 20 08            jr   nz,.draw_sprite_prep
1350+ 9BF2
1351+ 9BF2 3A 73 86         ld   a,(Var_Game_BallYPosition)
1352+ 9BF5 B7               or   a
1353+ 9BF6 20 02            jr   nz,.draw_sprite_prep
1354+ 9BF8 0E 03            ld   c,TILE_CORNER_BALL           ; Y=0 in direzione NORTH -> BALL_TOP
1355+ 9BFA
1356+ 9BFA              .draw_sprite_prep:
1357+ 9BFA 79               ld   a,c                       ; A = tile definitiva (TOP/BOTTOM/altro)
1358+ 9BFB
1359+ 9BFB
1360+ 9BFB              ; ====== DISEGNO DELLO SPRITE (palla o giocatore con palla) ========
1361+ 9BFB
1362+ 9BFB              ; Se arriviamo dai casi giocatore, ricarichiamo sempre le coordinate
1363+ 9BFB              ; della palla prima di disegnare.
1364+ 9BFB              .draw_sprite_with_ball_pos:
1365+ 9BFB 47               ld   b,a                       ; salva tile in B
1366+ 9BFC
1367+ 9BFC CD FD A1         call Game_GetBallPosition           ; HL = X,Y
1368+ 9BFF
1369+ 9BFF
1370+ 9BFF 78               ld   a,b                       ; ripristina tile
1371+ 9C00                  ; cade in .draw_sprite
1372+ 9C00
1373+ 9C00              .draw_sprite:
1374+ 9C00                  ; A = tile, D = Y, E = X (coord matrice)
1375+ 9C00 FE 40            CP   TILE_BALL_BOTTOM
1376+ 9C02 20 1F            JR   NZ, .draw_sprite_continue
1377+ 9C04 3A 46 86         LD   A, (Var_Game_ActiveFieldSide)
1378+ 9C07 FE 01            CP   FIELD_NORTH_SIDE
1379+ 9C09 28 0B            JR   Z, .darw_ball_north_field
1380+ 9C0B 3A 73 86         LD   A, (Var_Game_BallYPosition)
1381+ 9C0E FE 04            CP   4
1382+ 9C10 28 0F            JR   Z, .draw_ball_top
1383+ 9C12 3E 40            LD   A, TILE_BALL_BOTTOM
1384+ 9C14 18 0D            JR   .draw_sprite_continue
1385+ 9C16              .darw_ball_north_field:
1386+ 9C16 3A 73 86         LD   A, (Var_Game_BallYPosition)
1387+ 9C19 FE 00            CP   0
1388+ 9C1B 28 04            JR   Z, .draw_ball_top
1389+ 9C1D 3E 40            LD   A, TILE_BALL_BOTTOM
1390+ 9C1F 18 02            JR   .draw_sprite_continue
1391+ 9C21              .draw_ball_top:
1392+ 9C21 3E 03            LD   A, TILE_CORNER_BALL
1393+ 9C23              .draw_sprite_continue:
1394+ 9C23 F5               push af
1395+ 9C24 CD 8F 9A         call VDP_MapMatrixToScreen_DE
1396+ 9C27 F1               pop  af
1397+ 9C28 CD BC 95         call VDP_DrawSprite
1398+ 9C2B 18 00            jr   .exit
1399+ 9C2D
1400+ 9C2D
1401+ 9C2D              .exit:
1402+ 9C2D E1               pop  hl
1403+ 9C2E D1               pop  de
1404+ 9C2F C1               pop  bc
1405+ 9C30 F1               pop  af
1406+ 9C31 C9               ret
1407+ 9C32
1408+ 9C32              ; ---------------------------------------------------------------------------
1409+ 9C32              ; Disegna tutti i 4 giocatori di una squadra
1410+ 9C32              ; INPUT:
1411+ 9C32              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
1412+ 9C32              ; MODIFICA:
1413+ 9C32              ;   AF, BC, DE, HL
1414+ 9C32              ; ---------------------------------------------------------------------------
1415+ 9C32              VPMR_DrawTeam:
1416+ 9C32 0E 00            LD   C,0                    ; ID = 0..3
1417+ 9C34              VPMR_PlayerLoop:
1418+ 9C34 C5               PUSH BC                     ; salva TEAM/ID per dopo
1419+ 9C35
1420+ 9C35 CD C4 A2         CALL Game_GetPlayerInfoById
1421+ 9C38                  ; dopo la call:
1422+ 9C38                  ;   DE = prev (D=prevY, E=prevX)
1423+ 9C38                  ;   HL = cur  (H=curY,  L=curX)
1424+ 9C38                  ;   A  = ROLE
1425+ 9C38                  ;   B  = TEAM
1426+ 9C38                  ;   C  = ID
1427+ 9C38
1428+ 9C38                  ; ----- CLEAR PREVIOUS POSITION (se valida) --------------------
1429+ 9C38 7A               LD   A,D                    ; prevY
1430+ 9C39 FE FF            CP   255
1431+ 9C3B 28 0E            JR   Z,VPMR_SkipClear
1432+ 9C3D
1433+ 9C3D
1434+ 9C3D                  ; mappa coord logiche prev -> schermo
1435+ 9C3D E5               PUSH HL                     ; salvo current
1436+ 9C3E C5               PUSH BC
1437+ 9C3F F5               PUSH AF                     ; non mi interessa il contenuto, ma proteggo A
1438+ 9C40
1439+ 9C40                  ;CALL VDP_MapMatrixToScreen_DE   ; DE = coord schermo
1440+ 9C40 3E D6            LD   A,TILE_FIELD
1441+ 9C42 CD BC 95         CALL VDP_DrawSprite             ; D=row, E=col, A=tile
1442+ 9C45
1443+ 9C45 F1               POP  AF
1444+ 9C46 C1               POP  BC
1445+ 9C47 E1               POP  HL
1446+ 9C48 CD 1C A3         CALL Game_ClearSinglePlayerPrevPositions
1447+ 9C4B              VPMR_SkipClear:
1448+ 9C4B                  ; ----- DRAW CURRENT POSITION (se visibile) -------------------
1449+ 9C4B 7C               LD   A,H                    ; curY
1450+ 9C4C FE FF            CP   255
1451+ 9C4E 28 50            JR   Z,VPMR_AfterDraw       ; giocatore invisibile (es. portiere nascosto)
1452+ 9C50
1453+ 9C50                  ; D,E = coord logiche correnti
1454+ 9C50 54               LD   D,H
1455+ 9C51 5D               LD   E,L
1456+ 9C52
1457+ 9C52                  ; mappa coord logiche -> schermo
1458+ 9C52 F5               PUSH AF
1459+ 9C53 C5               PUSH BC
1460+ 9C54 E5               PUSH HL
1461+ 9C55 CD 8F 9A         CALL VDP_MapMatrixToScreen_DE
1462+ 9C58 E1               POP  HL
1463+ 9C59 C1               POP  BC
1464+ 9C5A F1               POP  AF
1465+ 9C5B                  ; ora D,E = coord schermo
1466+ 9C5B
1467+ 9C5B                  ; ----- determina la tile in A -----------------------
1468+ 9C5B 79               LD   A,C                    ; A = ID
1469+ 9C5C B7               OR   A
1470+ 9C5D 20 21            JR   NZ,VPMR_FieldPlayer    ; ID != 0 → giocatore di movimento
1471+ 9C5F
1472+ 9C5F                  ; ===== PORTIERE =====
1473+ 9C5F 3A 65 86         LD   A,(Var_Game_GoalkeeperHasBall)
1474+ 9C62 FE 01            CP   YES
1475+ 9C64 20 0D            JR   NZ,VPMR_GK_NoBall
1476+ 9C66
1477+ 9C66                  ; portiere CON palla
1478+ 9C66 78               LD   A,B                    ; TEAM
1479+ 9C67 FE 00            CP   TEAM_BLACK
1480+ 9C69 20 04            JR   NZ,VPMR_WhiteGKWithBall
1481+ 9C6B 3E 90            LD   A,TILE_BLACK_GOALKEEPER_WITH_BALL
1482+ 9C6D 18 2E            JR   VPMR_DoDraw
1483+ 9C6F
1484+ 9C6F              VPMR_WhiteGKWithBall:
1485+ 9C6F 3E 70            LD   A,TILE_WHITE_GOALKEEPER_WITH_BALL
1486+ 9C71 18 2A            JR   VPMR_DoDraw
1487+ 9C73
1488+ 9C73              VPMR_GK_NoBall:
1489+ 9C73                  ; portiere SENZA palla
1490+ 9C73 78               LD   A,B
1491+ 9C74 FE 00            CP   TEAM_BLACK
1492+ 9C76 20 04            JR   NZ,VPMR_WhiteGKNoBall
1493+ 9C78 3E 80            LD   A,TILE_BLACK_GOALKEEPER
1494+ 9C7A 18 21            JR   VPMR_DoDraw
1495+ 9C7C
1496+ 9C7C              VPMR_WhiteGKNoBall:
1497+ 9C7C 3E 60            LD   A,TILE_WHITE_GOALKEEPER
1498+ 9C7E 18 1D            JR   VPMR_DoDraw
1499+ 9C80
1500+ 9C80                  ; ===== GIOCATORE DI MOVIMENTO =====
1501+ 9C80              VPMR_FieldPlayer:
1502+ 9C80 78               LD   A,B
1503+ 9C81 FE 00            CP   TEAM_BLACK
1504+ 9C83 20 04            JR   NZ,VPMR_WhitePlayer
1505+ 9C85 3E B0            LD   A,TILE_BLACK_PLAYER
1506+ 9C87 18 14            JR   VPMR_DoDraw
1507+ 9C89
1508+ 9C89              VPMR_WhitePlayer:
1509+ 9C89 E5               PUSH  HL
1510+ 9C8A D1               POP   DE
1511+ 9C8B 3A 46 86         LD   A, (Var_Game_ActiveFieldSide)
1512+ 9C8E FE 00            CP   FIELD_SOUTH_SIDE
1513+ 9C90 28 09            JR   Z, VPMR_WhiteStandardPlayer
1514+ 9C92 7C               LD   A, H
1515+ 9C93 FE 04            CP   4
1516+ 9C95 20 04            JR   NZ, VPMR_WhiteStandardPlayer
1517+ 9C97 3E 50            LD   A,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
1518+ 9C99 18 02            JR   VPMR_DoDraw
1519+ 9C9B              VPMR_WhiteStandardPlayer:
1520+ 9C9B 3E A0            LD   A,TILE_WHITE_PLAYER
1521+ 9C9D              VPMR_DoDraw:
1522+ 9C9D CD BC 95         CALL VDP_DrawSprite          ; usa D,E già mappate
1523+ 9CA0
1524+ 9CA0              VPMR_AfterDraw:
1525+ 9CA0 C1               POP  BC                      ; ripristina TEAM/ID salvati a inizio ciclo
1526+ 9CA1
1527+ 9CA1 0C               INC  C
1528+ 9CA2 79               LD   A,C
1529+ 9CA3 FE 04            CP   4
1530+ 9CA5 C2 34 9C         JP   NZ,VPMR_PlayerLoop
1531+ 9CA8 C9               RET
1532+ 9CA9
1533+ 9CA9
1534+ 9CA9
1535+ 9CA9
1536+ 9CA9
1537+ 9CA9
1538+ 9CA9
1539+ 9CA9
1540+ 9CA9              ; ---------------------------------------------------------------------------
1541+ 9CA9              ; Pulisce l'area laterale del menu (colonne 23)
1542+ 9CA9              ; ---------------------------------------------------------------------------
1543+ 9CA9              VDP_ClearMenuSideArea:
1544+ 9CA9 AF               XOR     A
1545+ 9CAA              .Loop:
1546+ 9CAA F5               PUSH    AF
1547+ 9CAB 57               LD      D, A
1548+ 9CAC 1E 17            LD      E, 23
1549+ 9CAE 21 44 9F         LD      HL, TXT_EMPTY
1550+ 9CB1 CD 1A 95         CALL    VDP_PrintString
1551+ 9CB4
1552+ 9CB4 F1               POP     AF
1553+ 9CB5 3C               INC     A
1554+ 9CB6 FE 15            CP      21
1555+ 9CB8 C8               RET     Z
1556+ 9CB9 18 EF            JR      .Loop
1557+ 9CBB
1558+ 9CBB
1559+ 9CBB
1560+ 9CBB              VDP_ShowScores:
1561+ 9CBB 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
1562+ 9CBE FE 01            CP      YES
1563+ 9CC0 C0               RET     NZ
1564+ 9CC1 16 00            LD      D, 0
1565+ 9CC3 1E 17            LD      E, 23
1566+ 9CC5 21 4D 9F         LD      HL, TXT_TIME
1567+ 9CC8 CD 1A 95         CALL    VDP_PrintString
1568+ 9CCB
1569+ 9CCB 16 05            LD      D, 5
1570+ 9CCD 1E 17            LD      E, 23
1571+ 9CCF 21 52 9F         LD      HL, TXT_BLACK_TEAM
1572+ 9CD2 CD 1A 95         CALL    VDP_PrintString
1573+ 9CD5
1574+ 9CD5 16 0A            LD      D, 10
1575+ 9CD7 1E 17            LD      E, 23
1576+ 9CD9 21 5B 9F         LD      HL, TXT_WHITE_TEAM
1577+ 9CDC CD 1A 95         CALL    VDP_PrintString
1578+ 9CDF D5               PUSH    DE
1579+ 9CE0 E5               PUSH    HL
1580+ 9CE1 3A 62 86         LD      A, (Var_Game_ScoreWhite)
1581+ 9CE4 26 00            LD      H, 0
1582+ 9CE6 6F               LD      L, A
1583+ 9CE7 11 3E 86         LD      DE, Var_Utils_NumberToPrint
1584+ 9CEA CD 6A 9F         CALL    String_NumberToASCII
1585+ 9CED 21 3E 86         LD      HL, Var_Utils_NumberToPrint
1586+ 9CF0 CD 8E 9F         CALL    String_RemoveLeadingZeros
1587+ 9CF3 21 3E 86         LD      HL, Var_Utils_NumberToPrint
1588+ 9CF6 16 0B            LD      D, 11
1589+ 9CF8 1E 1A            LD      E, 26
1590+ 9CFA CD 1A 95         CALL    VDP_PrintString
1591+ 9CFD
1592+ 9CFD 3A 55 86         LD      A, (Var_Game_ScoreBlack)
1593+ 9D00 26 00            LD      H, 0
1594+ 9D02 6F               LD      L, A
1595+ 9D03 11 3E 86         LD      DE, Var_Utils_NumberToPrint
1596+ 9D06 CD 6A 9F         CALL    String_NumberToASCII
1597+ 9D09 21 3E 86         LD      HL, Var_Utils_NumberToPrint
1598+ 9D0C CD 8E 9F         CALL    String_RemoveLeadingZeros
1599+ 9D0F 21 3E 86         LD      HL, Var_Utils_NumberToPrint
1600+ 9D12 16 06            LD      D, 6
1601+ 9D14 1E 1A            LD      E, 26
1602+ 9D16 CD 1A 95         CALL    VDP_PrintString
1603+ 9D19
1604+ 9D19 E1               POP     HL
1605+ 9D1A D1               POP     DE
1606+ 9D1B C9               RET
1607+ 9D1C
1608+ 9D1C
# file closed: ./inc/vdp.asm
  16  9D1C                      INCLUDE "menu.asm"                      ; Include menu library
# file opened: ./inc/menu.asm
   1+ 9D1C              ; ===================================================================
   2+ 9D1C              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 9D1C              ; ===================================================================
   4+ 9D1C
   5+ 9D1C              ; *** MENU.ASM ***
   6+ 9D1C
   7+ 9D1C              ; ------ ROUTINES ------
   8+ 9D1C
   9+ 9D1C              ;------------------------------------------------------------------------
  10+ 9D1C              ; Show menu
  11+ 9D1C              ; INPUT: -
  12+ 9D1C              ; OUTPUT: -
  13+ 9D1C              ; MODIFY: A, DE, HL, BC
  14+ 9D1C              ;-------------------------------------------------------------------------
  15+ 9D1C              Menu_Show:
  16+ 9D1C CD EF 86         CALL    Hooks_TickStart
  17+ 9D1F CD 34 8C         CALL    Hooks_InitAICounters
  18+ 9D22 3E 02            LD      A, 2
  19+ 9D24 32 6C 86         LD      (Var_Game_PlayersSpeed), A ; set default players speed to 2
  20+ 9D27 CD 77 B0         CALL    Game_Start
  21+ 9D2A CD 2F 9D         CALL    Menu_ShowOptions
  22+ 9D2D FB               EI
  23+ 9D2E C9               RET
  24+ 9D2F
  25+ 9D2F              Menu_ShowOptions:
  26+ 9D2F CD A9 9C         CALL    VDP_ClearMenuSideArea
  27+ 9D32
  28+ 9D32 21 CE 9E         LD      HL, TXT_BTN_PLY1_1
  29+ 9D35 16 00            LD      D, 0
  30+ 9D37 1E 17            LD      E, 23
  31+ 9D39 CD 1A 95         CALL    VDP_PrintString
  32+ 9D3C 21 D7 9E         LD      HL, TXT_BTN_PLY1_2
  33+ 9D3F 16 01            LD      D, 1
  34+ 9D41 1E 18            LD      E, 24
  35+ 9D43 CD 1A 95         CALL    VDP_PrintString
  36+ 9D46 21 DE 9E         LD      HL, TXT_BTN_PLY1_3
  37+ 9D49 16 02            LD      D, 2
  38+ 9D4B 1E 18            LD      E, 24
  39+ 9D4D CD 1A 95         CALL    VDP_PrintString
  40+ 9D50 21 E5 9E         LD      HL, TXT_BTN_PLY1_4
  41+ 9D53 16 03            LD      D, 3
  42+ 9D55 1E 18            LD      E, 24
  43+ 9D57 CD 1A 95         CALL    VDP_PrintString
  44+ 9D5A 21 ED 9E         LD      HL, TXT_BTN_PLY1_5
  45+ 9D5D 16 04            LD      D, 4
  46+ 9D5F 1E 18            LD      E, 24
  47+ 9D61 CD 1A 95         CALL    VDP_PrintString
  48+ 9D64
  49+ 9D64
  50+ 9D64 21 44 9F         LD      HL, TXT_EMPTY
  51+ 9D67 16 0E            LD      D, 14
  52+ 9D69 1E 17            LD      E, 23
  53+ 9D6B CD 1A 95         CALL    VDP_PrintString
  54+ 9D6E
  55+ 9D6E
  56+ 9D6E 21 44 9F         LD      HL, TXT_EMPTY
  57+ 9D71 16 06            LD      D, 6
  58+ 9D73 1E 17            LD      E, 23
  59+ 9D75 CD 1A 95         CALL    VDP_PrintString
  60+ 9D78 21 44 9F         LD      HL, TXT_EMPTY
  61+ 9D7B 16 07            LD      D, 7
  62+ 9D7D 1E 18            LD      E, 24
  63+ 9D7F CD 1A 95         CALL    VDP_PrintString
  64+ 9D82 21 44 9F         LD      HL, TXT_EMPTY
  65+ 9D85 16 08            LD      D, 8
  66+ 9D87 1E 18            LD      E, 24
  67+ 9D89 CD 1A 95         CALL    VDP_PrintString
  68+ 9D8C 21 44 9F         LD      HL, TXT_EMPTY
  69+ 9D8F 16 09            LD      D, 9
  70+ 9D91 1E 18            LD      E, 24
  71+ 9D93 CD 1A 95         CALL    VDP_PrintString
  72+ 9D96 21 44 9F         LD      HL, TXT_EMPTY
  73+ 9D99 16 0A            LD      D, 10
  74+ 9D9B 1E 18            LD      E, 24
  75+ 9D9D CD 1A 95         CALL    VDP_PrintString
  76+ 9DA0
  77+ 9DA0
  78+ 9DA0 21 96 9E         LD      HL, TXT_CPU
  79+ 9DA3 16 0D            LD      D, 13
  80+ 9DA5 1E 17            LD      E, 23
  81+ 9DA7 CD 1A 95         CALL    VDP_PrintString
  82+ 9DAA
  83+ 9DAA 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
  84+ 9DAD FE 01            CP      GAME_MODE_1_PLAYER
  85+ 9DAF 28 3F            JR      Z, .Level1
  86+ 9DB1 21 8E 9E         LD      HL, TXT_GAME_MODE_2_PLAYERS
  87+ 9DB4 16 0D            LD      D, 13
  88+ 9DB6 1E 17            LD      E, 23
  89+ 9DB8 CD 1A 95         CALL    VDP_PrintString
  90+ 9DBB 21 F5 9E         LD      HL, TXT_BTN_PLY2_1
  91+ 9DBE 16 06            LD      D, 6
  92+ 9DC0 1E 17            LD      E, 23
  93+ 9DC2 CD 1A 95         CALL    VDP_PrintString
  94+ 9DC5 21 FE 9E         LD      HL, TXT_BTN_PLY2_2
  95+ 9DC8 16 07            LD      D, 7
  96+ 9DCA 1E 18            LD      E, 24
  97+ 9DCC CD 1A 95         CALL    VDP_PrintString
  98+ 9DCF 21 05 9F         LD      HL, TXT_BTN_PLY2_3
  99+ 9DD2 16 08            LD      D, 8
 100+ 9DD4 1E 18            LD      E, 24
 101+ 9DD6 CD 1A 95         CALL    VDP_PrintString
 102+ 9DD9 21 0C 9F         LD      HL, TXT_BTN_PLY2_4
 103+ 9DDC 16 09            LD      D, 9
 104+ 9DDE 1E 18            LD      E, 24
 105+ 9DE0 CD 1A 95         CALL    VDP_PrintString
 106+ 9DE3 21 14 9F         LD      HL, TXT_BTN_PLY2_5
 107+ 9DE6 16 0A            LD      D, 10
 108+ 9DE8 1E 18            LD      E, 24
 109+ 9DEA CD 1A 95         CALL    VDP_PrintString
 110+ 9DED CD 5B 9E         CALL    .Start
 111+ 9DF0
 112+ 9DF0
 113+ 9DF0              .Level1
 114+ 9DF0 21 C6 9E         LD      HL, TXT_LEVEL_NO
 115+ 9DF3 16 0E            LD      D, 14
 116+ 9DF5 1E 17            LD      E, 23
 117+ 9DF7 CD 1A 95         CALL    VDP_PrintString
 118+ 9DFA 3A 6E 86         LD      A, (Var_Game_SelectedPlayers)
 119+ 9DFD FE 02            CP      GAME_MODE_2_PLAYERS
 120+ 9DFF 28 5A            JR      Z, .Start
 121+ 9E01
 122+ 9E01
 123+ 9E01 3A 48 86         LD      A, (Var_Game_SelectedLevel)
 124+ 9E04 FE 01            CP      1
 125+ 9E06 20 0D            JR      NZ, .Level2
 126+ 9E08 21 9E 9E         LD      HL, TXT_LEVEL_1
 127+ 9E0B 16 0E            LD      D, 14
 128+ 9E0D 1E 17            LD      E, 23
 129+ 9E0F CD 1A 95         CALL    VDP_PrintString
 130+ 9E12 C3 5B 9E         JP      .Start
 131+ 9E15              .Level2:
 132+ 9E15 3A 48 86         LD      A, (Var_Game_SelectedLevel)
 133+ 9E18 FE 02            CP      2
 134+ 9E1A 20 0D            JR      NZ, .Level3
 135+ 9E1C 21 A6 9E         LD      HL, TXT_LEVEL_2
 136+ 9E1F 16 0E            LD      D, 14
 137+ 9E21 1E 17            LD      E, 23
 138+ 9E23 CD 1A 95         CALL    VDP_PrintString
 139+ 9E26 C3 5B 9E         JP      .Start
 140+ 9E29              .Level3:
 141+ 9E29 3A 48 86         LD      A, (Var_Game_SelectedLevel)
 142+ 9E2C FE 03            CP      3
 143+ 9E2E 20 0D            JR      NZ, .Level4
 144+ 9E30 21 AE 9E         LD      HL, TXT_LEVEL_3
 145+ 9E33 16 0E            LD      D, 14
 146+ 9E35 1E 17            LD      E, 23
 147+ 9E37 CD 1A 95         CALL    VDP_PrintString
 148+ 9E3A C3 5B 9E         JP      .Start
 149+ 9E3D              .Level4:
 150+ 9E3D 3A 48 86         LD      A, (Var_Game_SelectedLevel)
 151+ 9E40 FE 04            CP      4
 152+ 9E42 20 0D            JR      NZ, .Level5
 153+ 9E44 21 B6 9E         LD      HL, TXT_LEVEL_4
 154+ 9E47 16 0E            LD      D, 14
 155+ 9E49 1E 17            LD      E, 23
 156+ 9E4B CD 1A 95         CALL    VDP_PrintString
 157+ 9E4E C3 5B 9E         JP      .Start
 158+ 9E51              .Level5:
 159+ 9E51 21 BE 9E         LD      HL, TXT_LEVEL_5
 160+ 9E54 16 0E            LD      D, 14
 161+ 9E56 1E 17            LD      E, 23
 162+ 9E58 CD 1A 95         CALL    VDP_PrintString
 163+ 9E5B              .Start:
 164+ 9E5B 21 1C 9F         LD      HL, TXT_SPACE
 165+ 9E5E 16 11            LD      D, 17
 166+ 9E60 1E 17            LD      E, 23
 167+ 9E62 CD 1A 95         CALL    VDP_PrintString
 168+ 9E65 21 24 9F         LD      HL, TXT_START
 169+ 9E68 16 12            LD      D, 18
 170+ 9E6A 1E 17            LD      E, 23
 171+ 9E6C CD 1A 95         CALL    VDP_PrintString
 172+ 9E6F 21 2D 9F         LD      HL, TXT_GSSOCCER
 173+ 9E72 16 16            LD      D, 22
 174+ 9E74 1E 17            LD      E, 23
 175+ 9E76 CD 1A 95         CALL    VDP_PrintString
 176+ 9E79 21 36 9F         LD      HL, TXT_2025
 177+ 9E7C 16 15            LD      D, 21
 178+ 9E7E 1E 17            LD      E, 23
 179+ 9E80 CD 1A 95         CALL    VDP_PrintString
 180+ 9E83 21 3B 9F         LD      HL, TXT_PRACEK
 181+ 9E86 16 17            LD      D, 23
 182+ 9E88 1E 17            LD      E, 23
 183+ 9E8A CD 1A 95         CALL    VDP_PrintString
 184+ 9E8D C9               RET
 185+ 9E8E
 186+ 9E8E
 187+ 9E8E              ; ------ CONSTANTS ------
 188+ 9E8E 3C 32 50 4C  TXT_GAME_MODE_2_PLAYERS:   DB "<2PLYS>",0
 188+ 9E92 59 53 3E 00
 189+ 9E96 3C 20 43 50  TXT_CPU:        DB "< CPU >",0
 189+ 9E9A 55 20 3E 00
 190+ 9E9E 5E 4C 45 56  TXT_LEVEL_1:    DB "^LEV.1_",0
 190+ 9EA2 2E 31 5F 00
 191+ 9EA6 5E 4C 45 56  TXT_LEVEL_2:    DB "^LEV.2_",0
 191+ 9EAA 2E 32 5F 00
 192+ 9EAE 5E 4C 45 56  TXT_LEVEL_3:    DB "^LEV.3_",0
 192+ 9EB2 2E 33 5F 00
 193+ 9EB6 5E 4C 45 56  TXT_LEVEL_4:    DB "^LEV.4_",0
 193+ 9EBA 2E 34 5F 00
 194+ 9EBE 5E 4C 45 56  TXT_LEVEL_5:    DB "^LEV.5_",0
 194+ 9EC2 2E 35 5F 00
 195+ 9EC6 20 20 20 20  TXT_LEVEL_NO:   DB "       ",0
 195+ 9ECA 20 20 20 00
 196+ 9ECE 50 4C 41 59  TXT_BTN_PLY1_1: DB "PLAYER 1",0
 196+ 9ED2 45 52 20 31
 196+ 9ED6 00
 197+ 9ED7 5E 20 53 48  TXT_BTN_PLY1_2: DB "^ SHOT",0
 197+ 9EDB 4F 54 00
 198+ 9EDE 3C 20 4C 45  TXT_BTN_PLY1_3: DB "< LEFT",0
 198+ 9EE2 46 54 00
 199+ 9EE5 3E 20 52 49  TXT_BTN_PLY1_4: DB "> RIGHT",0
 199+ 9EE9 47 48 54 00
 200+ 9EED 20 20 20 20  TXT_BTN_PLY1_5: DB "       ",0 ; OR JOY1
 200+ 9EF1 20 20 20 00
 201+ 9EF5 50 4C 41 59  TXT_BTN_PLY2_1: DB "PLAYER 2",0
 201+ 9EF9 45 52 20 32
 201+ 9EFD 00
 202+ 9EFE 57 20 53 48  TXT_BTN_PLY2_2: DB "W SHOT",0
 202+ 9F02 4F 54 00
 203+ 9F05 41 20 4C 45  TXT_BTN_PLY2_3: DB "A LEFT",0
 203+ 9F09 46 54 00
 204+ 9F0C 53 20 52 49  TXT_BTN_PLY2_4: DB "S RIGHT",0
 204+ 9F10 47 48 54 00
 205+ 9F14 20 20 20 20  TXT_BTN_PLY2_5: DB "       ",0 ; OR JOY2
 205+ 9F18 20 20 20 00
 206+ 9F1C 20 53 50 41  TXT_SPACE:      DB " SPACE ",0 ; SPC/FIRE
 206+ 9F20 43 45 20 00
 207+ 9F24 54 4F 20 53  TXT_START:      DB "TO START",0
 207+ 9F28 54 41 52 54
 207+ 9F2C 00
 208+ 9F2D 47 53 53 4F  TXT_GSSOCCER:   DB "GSSOCCER",0
 208+ 9F31 43 43 45 52
 208+ 9F35 00
 209+ 9F36 32 30 32 35  TXT_2025:       DB "2025",0
 209+ 9F3A 00
 210+ 9F3B 46 2E 50 52  TXT_PRACEK:     DB "F.PRACEK",0
 210+ 9F3F 41 43 45 4B
 210+ 9F43 00
 211+ 9F44 20 20 20 20  TXT_EMPTY:      DB "        ",0
 211+ 9F48 20 20 20 20
 211+ 9F4C 00
 212+ 9F4D 54 49 4D 45  TXT_TIME:       DB "TIME",0
 212+ 9F51 00
 213+ 9F52 56 49 53 49  TXT_BLACK_TEAM: DB "VISITORS",0
 213+ 9F56 54 4F 52 53
 213+ 9F5A 00
 214+ 9F5B 48 4F 4D 45  TXT_WHITE_TEAM: DB "HOME",0
 214+ 9F5F 00
 215+ 9F60 47 41 4D 45  TXT_GAME_OVER:  DB "GAME OVER",0
 215+ 9F64 20 4F 56 45
 215+ 9F68 52 00
 216+ 9F6A
 217+ 9F6A
# file closed: ./inc/menu.asm
  17  9F6A                      INCLUDE "utils.asm"                     ; Include utilities library
# file opened: ./inc/utils.asm
   1+ 9F6A              ; ===================================================================
   2+ 9F6A              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 9F6A              ; ===================================================================
   4+ 9F6A
   5+ 9F6A              ; *** UTILS.ASM ***
   6+ 9F6A
   7+ 9F6A              ; ------ ROUTINES ------
   8+ 9F6A
   9+ 9F6A              ;--------------------------------------------------------------------------
  10+ 9F6A              ; Convert a 16-bit unsigned number to a string of ASCII digits.
  11+ 9F6A              ; INPUT:
  12+ 9F6A              ;   HL = the 16-bit unsigned number to convert.
  13+ 9F6A              ; OUTPUT: -
  14+ 9F6A              ; MODIFY: HL, DE, BC, AF
  15+ 9F6A              ;--------------------------------------------------------------------------
  16+ 9F6A              String_NumberToASCII:
  17+ 9F6A 01 F0 D8        LD       BC,-10000
  18+ 9F6D CD 83 9F        CALL     .Num1
  19+ 9F70 01 18 FC        LD       BC,-1000
  20+ 9F73 CD 83 9F        CALL     .Num1
  21+ 9F76 01 9C FF        LD       BC,-100
  22+ 9F79 CD 83 9F        CALL     .Num1
  23+ 9F7C 0E F6           LD       C,-10
  24+ 9F7E CD 83 9F        CALL     .Num1
  25+ 9F81 0E FF           LD       C,-1
  26+ 9F83              .Num1:
  27+ 9F83 3E 2F           LD       A,'0'-1
  28+ 9F85              .Num2:
  29+ 9F85 3C              INC      A
  30+ 9F86 09              ADD      HL, BC
  31+ 9F87 38 FC           JR       C, .Num2
  32+ 9F89 ED 42           SBC      HL, BC
  33+ 9F8B 12              LD       (DE), A
  34+ 9F8C 13              INC      DE
  35+ 9F8D C9              RET
  36+ 9F8E
  37+ 9F8E              ;---------------------------------------------------------------------
  38+ 9F8E              ; Remove leading zeros from the string
  39+ 9F8E              ; INPUT:
  40+ 9F8E              ;   HL: Pointer to the string
  41+ 9F8E              ; OUTPUT: -
  42+ 9F8E              ; MODIFY: HL, AF, BC
  43+ 9F8E              ;---------------------------------------------------------------------
  44+ 9F8E              String_RemoveLeadingZeros:
  45+ 9F8E CD A1 9F         CALL    String_GetLength  ; Get the length of the string
  46+ 9F91 47               LD      B, A            ; Set B to the number of digits
  47+ 9F92              .Loop:
  48+ 9F92                  ; Check if we are at the last digit; if so, exit.
  49+ 9F92 78               LD      A, B
  50+ 9F93 FE 01            CP      1
  51+ 9F95 C8               RET     Z
  52+ 9F96                  ; Load the current character.
  53+ 9F96 7E               LD      A, (HL)
  54+ 9F97 FE 30            CP      '0'
  55+ 9F99 C0               RET     NZ  ; If the character is not '0', we've reached the first
  56+ 9F9A                                        ; nonzero digit; stop replacing.
  57+ 9F9A                  ; Replace the '0' with a space.
  58+ 9F9A 3E 20            LD       A, ' '
  59+ 9F9C 77               LD      (HL), A
  60+ 9F9D 23               INC     HL              ; Advance to the next character.
  61+ 9F9E 05               DEC     B               ; Decrement the digit counter.
  62+ 9F9F 18 F1            JR      .Loop
  63+ 9FA1
  64+ 9FA1
  65+ 9FA1              ;---------------------------------------------------------------------
  66+ 9FA1              ; Get the length of a string in bytes
  67+ 9FA1              ; INPUT:
  68+ 9FA1              ;   HL: Pointer to the string
  69+ 9FA1              ; OUTPUT: -
  70+ 9FA1              ; MODIFY: HL, AF, BC
  71+ 9FA1              ;---------------------------------------------------------------------
  72+ 9FA1              String_GetLength:
  73+ 9FA1 E5               PUSH    HL          ; save HL
  74+ 9FA2 AF               XOR     A           ; A = 0
  75+ 9FA3 47               LD      B, A        ; B = 0 (length counter)
  76+ 9FA4
  77+ 9FA4              .Loop:
  78+ 9FA4 7E               LD      A, (HL)     ; load byte
  79+ 9FA5 B7               OR      A           ; set Z if it’s zero
  80+ 9FA6 28 04            JR      Z, .Done
  81+ 9FA8 04               INC     B           ; increment length
  82+ 9FA9 23               INC     HL
  83+ 9FAA 18 F8            JR      .Loop
  84+ 9FAC
  85+ 9FAC              .Done:
  86+ 9FAC E1               POP     HL          ; restore HL
  87+ 9FAD 78               LD      A, B        ; return length in A
  88+ 9FAE C9               RET
  89+ 9FAF
  90+ 9FAF
  91+ 9FAF
  92+ 9FAF              ; ---------------------------------------------------------------------------
  93+ 9FAF              ; Reads keyboard and returns a code if one of the arrows or SPACE is pressed.
  94+ 9FAF              ; INPUT: -
  95+ 9FAF              ; OUTPUT:
  96+ 9FAF              ;   A = KEY_XXX constant, or 0 if no relevant key is pressed
  97+ 9FAF              ; MODIFIES:
  98+ 9FAF              ;   AF, BC, HL
  99+ 9FAF              ; ---------------------------------------------------------------------------
 100+ 9FAF
 101+ 9FAF              ; ------ ROUTINES ------
 102+ 9FAF
 103+ 9FAF
 104+ 9FAF
 105+ 9FAF
 106+ 9FAF              ;------------------------------------------------------------------------
 107+ 9FAF              ; Read the keyboard
 108+ 9FAF              ; INPUT: -
 109+ 9FAF              ; OUTPUT:
 110+ 9FAF              ;   A: ASCII code of key pressed
 111+ 9FAF              ; MODIFY: HL, BC, AF
 112+ 9FAF              ;------------------------------------------------------------------------
 113+ 9FAF              Utils_ReadKeyboard:
 114+ 9FAF 21 07 86         LD  HL,KEYBOARD_MAP     ; Point HL at the keyboard list
 115+ 9FB2 16 08            LD  D, 8                ; This is the number of ports (rows) to check
 116+ 9FB4 0E FE            LD  C, #FE              ; C is always FEh for reading keyboard ports
 117+ 9FB6              .ReadKeyboard0:
 118+ 9FB6 46               LD  B, (HL)             ; Get the keyboard port address from table
 119+ 9FB7 23               INC HL                  ; Increment to list of keys
 120+ 9FB8 ED 78            IN  A, (C)              ; Read the row of keys in
 121+ 9FBA E6 1F            AND #1F                 ; We are only interested in the first five bits
 122+ 9FBC 1E 05            LD  E, 5                ; This is the number of keys in the row
 123+ 9FBE              .ReadKeyboard1:
 124+ 9FBE CB 3F            SRL A                   ; Shift A right; bit 0 sets carry bit
 125+ 9FC0 30 0C            JR  NC, .ReadKeyboard2   ; If the bit is 0, we've found our key
 126+ 9FC2 23               INC HL                  ; Go to next table address
 127+ 9FC3 1D               DEC E                   ; Decrement key loop counter
 128+ 9FC4 20 F8            JR  NZ, .ReadKeyboard1   ; Loop around until this row finished
 129+ 9FC6 15               DEC D                   ; Decrement row loop counter
 130+ 9FC7 20 ED            JR  NZ, .ReadKeyboard0   ; Loop around until we are done
 131+ 9FC9 A7               AND A                   ; Clear A (no key found)
 132+ 9FCA 32 44 86         LD  (Var_Utils_LastKbdKeyPressed), A
 133+ 9FCD C9               RET
 134+ 9FCE              .ReadKeyboard2:
 135+ 9FCE 7E               LD  A, (HL)             ; We've found a key at this point; fetch the character code!
 136+ 9FCF 47               LD  B, A
 137+ 9FD0 3A 44 86         LD  A,(Var_Utils_LastKbdKeyPressed)
 138+ 9FD3 FE 00            CP  0
 139+ 9FD5 28 05            JR  Z, .ReadKeyboard3    ; If no key pressed before, skip the check
 140+ 9FD7 B8               CP  B                   ; Check if the key is the same as the last one pressed
 141+ 9FD8 20 02            JR  NZ, .ReadKeyboard3    ; If it is, skip the rest of this routine
 142+ 9FDA AF               XOR A               ; If it is the same, clear A (no key found)
 143+ 9FDB C9               RET
 144+ 9FDC              .ReadKeyboard3:
 145+ 9FDC 78               LD  A, B
 146+ 9FDD 32 44 86         LD  (Var_Utils_LastKbdKeyPressed), A
 147+ 9FE0 32 45 86         LD  (Var_Utils_KbdKeyPressed), A
 148+ 9FE3 C9               RET
 149+ 9FE4
 150+ 9FE4
 151+ 9FE4              ;------------------------------------------------------------------------
 152+ 9FE4              ; Utils_GetRandomNumber
 153+ 9FE4              ; OUTPUT: A = 0..127  (uniforme-ish)
 154+ 9FE4              ; MODIFIES: A, BC
 155+ 9FE4              ;------------------------------------------------------------------------
 156+ 9FE4              Utils_GetRandomNumber:
 157+ 9FE4 3A 3C 86         LD   A,(Var_Utils_OldRnd)
 158+ 9FE7 4F               LD   C,A
 159+ 9FE8
 160+ 9FE8                  ; s = s*33 + R  (33 = 32 + 1)
 161+ 9FE8 87               ADD  A,A         ; 2
 162+ 9FE9 87               ADD  A,A         ; 4
 163+ 9FEA 87               ADD  A,A         ; 8
 164+ 9FEB 87               ADD  A,A         ; 16
 165+ 9FEC 87               ADD  A,A         ; 32
 166+ 9FED 81               ADD  A,C         ; *33
 167+ 9FEE 4F               LD   C,A
 168+ 9FEF ED 5F            LD   A,R
 169+ 9FF1 81               ADD  A,C
 170+ 9FF2
 171+ 9FF2 32 3C 86         LD   (Var_Utils_OldRnd),A
 172+ 9FF5 E6 7F            AND  127         ; 0..127
 173+ 9FF7 C9               RET
 174+ 9FF8
 175+ 9FF8
 176+ 9FF8
 177+ 9FF8
 178+ 9FF8
 179+ 9FF8              ; Genera un beep usando PSG con impostazioni sicure
 180+ 9FF8              Utils_PlayBeep:
 181+ 9FF8 C9               RET
 182+ 9FF9
 183+ 9FF9              ;-----------------------------------------
 184+ 9FF9              ; Utils_PlayBeepGoalCorner - Beep più acuto (MSX)
 185+ 9FF9              ; Usa solo canale A, salva/ripristina mixer e volume
 186+ 9FF9              ;-----------------------------------------
 187+ 9FF9              Utils_PlayBeepGoalCorner:
 188+ 9FF9 C9               RET
 189+ 9FFA
 190+ 9FFA
 191+ 9FFA
 192+ 9FFA
 193+ 9FFA
 194+ 9FFA
 195+ 9FFA
 196+ 9FFA
 197+ 9FFA
 198+ 9FFA              ; ------------------------------------------------------------
 199+ 9FFA              ; Var_Game_BeepStep (BYTE in RAM) - definiscila tu nel tuo blocco variabili
 200+ 9FFA              ; Var_Game_BeepStep: DB 0
 201+ 9FFA              ; ------------------------------------------------------------
 202+ 9FFA
 203+ 9FFA
 204+ 9FFA              ; ------------------------------------------------------------
 205+ 9FFA              ; Utils_PlayBeepTick
 206+ 9FFA              ; Un solo beep breve (ta).
 207+ 9FFA              ; Ogni chiamata usa il prossimo periodo: 250,235,220,205 (ciclico)
 208+ 9FFA              ; Suono più simile al BASIC: micro-decay 12->8->0 + tiny delay
 209+ 9FFA              ; ------------------------------------------------------------
 210+ 9FFA              Utils_PlayBeepTick:
 211+ 9FFA C9               RET
 212+ 9FFB
 213+ 9FFB
 214+ 9FFB              ; ------------------------------------------------------------
 215+ 9FFB              ; Utils_PlayBeepHighLong
 216+ 9FFB              ; Un beep singolo più acuto e più lungo (taaaa).
 217+ 9FFB              ; Anche qui micro-decay per avvicinarsi al BASIC.
 218+ 9FFB              ; ------------------------------------------------------------
 219+ 9FFB              Utils_PlayBeepHighLong:
 220+ 9FFB C9               RET
 221+ 9FFC
 222+ 9FFC
 223+ 9FFC              ; ------------------------------------------------------------
 224+ 9FFC              ; Utils_ResetBeepTick
 225+ 9FFC              ; ------------------------------------------------------------
 226+ 9FFC              Utils_ResetBeepTick:
 227+ 9FFC AF               XOR  A
 228+ 9FFD 32 72 86         LD   (Var_Game_BeepStep),A
 229+ A000 C9               RET
 230+ A001
 231+ A001
 232+ A001
 233+ A001
 234+ A001              ; ------------------------------------------------------------
 235+ A001              ; Tabelle
 236+ A001              ; ------------------------------------------------------------
 237+ A001              Utils_BeepPeriods4:
 238+ A001 FA 00 EB 00      DW 250,235,220,205
 238+ A005 DC 00 CD 00
 239+ A009
 240+ A009
 241+ A009              ; ------ CONSTANTS ------
 242+ A009              KBD_KEY_NONE    EQU 0
 243+ A009              KBD_KEY_SPACE   EQU 32
 244+ A009
 245+ A009              KBD_KEY_UP      EQU 55
 246+ A009              KBD_KEY_DOWN    EQU 54
 247+ A009              KBD_KEY_LEFT    EQU 53
 248+ A009              KBD_KEY_RIGHT   EQU 56
 249+ A009
 250+ A009              KBD_KEY_W       EQU 87
 251+ A009              KBD_KEY_A       EQU 65
 252+ A009              KBD_KEY_S       EQU 83
 253+ A009
 254+ A009
 255+ A009              KBD_KEY_J       EQU 74
 256+ A009              KBD_KEY_K       EQU 75
 257+ A009              KBD_KEY_I       EQU 73
# file closed: ./inc/utils.asm
  18  A009                      INCLUDE "game.asm"                      ; Include game library
# file opened: ./inc/game.asm
   1+ A009
   2+ A009              ; ===================================================================
   3+ A009              ; GS11-Soccer - 2025 Fausto Pracek
   4+ A009              ; ===================================================================
   5+ A009
   6+ A009              ; *** GAME.ASM ***
   7+ A009
   8+ A009              ; ------ ROUTINES ------
   9+ A009              Game_InitVariables:
  10+ A009 3E FF            LD      A, NO_VALUE
  11+ A00B 32 70 86         LD      (Var_Game_FirstKickType), A
  12+ A00E 3E 00            LD      A, NO
  13+ A010 32 3D 86         LD      (Var_Utils_VblankStopped), A
  14+ A013 32 C0 86         LD      (Var_Hooks_ForceVdpRedraw), A
  15+ A016 32 BA 86         LD      (Var_Hooks_GameResumingWaiting), A
  16+ A019 3E 01            LD      A, GAME_MODE_1_PLAYER
  17+ A01B 32 6E 86         LD      (Var_Game_SelectedPlayers), A
  18+ A01E 3E 00            LD      A, NO
  19+ A020 32 6B 86         LD      (Var_Game_MatchInProgress), A
  20+ A023 3E 02            LD      A, 2
  21+ A025 32 61 86         LD      (Var_Game_HumanPlayerSpeed), A
  22+ A028 AF               XOR     A
  23+ A029 32 4D 86         LD      (Var_Game_BallUpdateTimer), A
  24+ A02C 32 C2 86         LD      (Var_Hooks_GoalCerimonyCounter), A
  25+ A02F CD 34 8C         CALL    Hooks_InitAICounters
  26+ A032 CD BB AA         CALL    Game_StopShot
  27+ A035 C9               RET
  28+ A036
  29+ A036
  30+ A036              ; ---------------------------------------------------------------------------
  31+ A036              ; Game_CheckVerticalShotPossessionStop
  32+ A036              ;
  33+ A036              ; INPUT:
  34+ A036              ;   D = BallY
  35+ A036              ;   E = BallX
  36+ A036              ; ---------------------------------------------------------------------------
  37+ A036              Game_CheckVerticalShotPossessionStop:
  38+ A036 F5               push af
  39+ A037 C5               push bc
  40+ A038 D5               push de
  41+ A039 E5               push hl
  42+ A03A
  43+ A03A                  ; ---------------------------
  44+ A03A                  ; Check NERI: match esatto (Y,X)  ID 1..3
  45+ A03A                  ; ---------------------------
  46+ A03A 06 00            ld   b,TEAM_BLACK
  47+ A03C 0E 01            ld   c,1
  48+ A03E              .chk_black_loop:
  49+ A03E D5               push de
  50+ A03F CD C4 A2         call Game_GetPlayerInfoById      ; HL = cur (H=Y, L=X)
  51+ A042 D1               pop  de
  52+ A043
  53+ A043 7C               ld   a,h
  54+ A044 BA               cp   d
  55+ A045 20 09            jr   nz,.chk_black_next
  56+ A047 7D               ld   a,l
  57+ A048 BB               cp   e
  58+ A049 20 05            jr   nz,.chk_black_next
  59+ A04B
  60+ A04B CD BB AA         call Game_StopShot
  61+ A04E 18 3B            jr   .done
  62+ A050
  63+ A050              .chk_black_next:
  64+ A050 0C               inc  c
  65+ A051 79               ld   a,c
  66+ A052 FE 04            cp   4
  67+ A054 20 E8            jr   nz,.chk_black_loop
  68+ A056
  69+ A056                  ; ---------------------------
  70+ A056                  ; Check BIANCHI: match su (BallY+1, BallX)  ID 1..3
  71+ A056                  ; ---------------------------
  72+ A056 06 01            ld   b,TEAM_WHITE
  73+ A058 0E 01            ld   c,1
  74+ A05A              .chk_white_loop:
  75+ A05A D5               push de
  76+ A05B CD C4 A2         call Game_GetPlayerInfoById      ; HL = cur (H=Y, L=X)
  77+ A05E D1               pop  de
  78+ A05F
  79+ A05F 7A               ld   a,d
  80+ A060 3C               inc  a                           ; targetY = BallY+1
  81+ A061 BC               cp   h
  82+ A062 20 09            jr   nz,.chk_white_next
  83+ A064
  84+ A064 7B               ld   a,e
  85+ A065 BD               cp   l
  86+ A066 20 05            jr   nz,.chk_white_next
  87+ A068
  88+ A068 CD BB AA         call Game_StopShot
  89+ A06B 18 1E            jr   .done
  90+ A06D
  91+ A06D              .chk_white_next:
  92+ A06D 0C               inc  c
  93+ A06E 79               ld   a,c
  94+ A06F FE 04            cp   4
  95+ A071 20 E7            jr   nz,.chk_white_loop
  96+ A073
  97+ A073                  ; ------------------------------------------------------------
  98+ A073                  ; Nessun possesso: verifica stop per fondo campo del lato attuale
  99+ A073                  ; e/o cambio metà campo
 100+ A073                  ; ------------------------------------------------------------
 101+ A073 3A 46 86         ld   a,(Var_Game_ActiveFieldSide)
 102+ A076 FE 00            cp   FIELD_SOUTH_SIDE
 103+ A078 20 0A            jr   nz,.field_is_north
 104+ A07A
 105+ A07A              ; ===== CAMPO SOUTH =====
 106+ A07A                  ; Se palla su riga 4 -> fondo campo / porta: stop tiro
 107+ A07A 7A               ld   a,d
 108+ A07B FE 04            cp   4
 109+ A07D 20 0C            jr   nz,.done
 110+ A07F CD BB AA         call Game_StopShot
 111+ A082 18 07            jr   .done
 112+ A084
 113+ A084
 114+ A084
 115+ A084              ; ===== CAMPO NORTH =====
 116+ A084              .field_is_north:
 117+ A084                  ; Se palla su riga 0 -> fondo campo / porta: stop tiro
 118+ A084 7A               ld   a,d
 119+ A085 B7               or   a
 120+ A086 20 03            jr   nz,.done
 121+ A088 CD BB AA         call Game_StopShot
 122+ A08B
 123+ A08B              .done:
 124+ A08B E1               pop  hl
 125+ A08C D1               pop  de
 126+ A08D C1               pop  bc
 127+ A08E F1               pop  af
 128+ A08F C9               ret
 129+ A090
 130+ A090
 131+ A090
 132+ A090
 133+ A090              ; ---------------------------------------------------------------------------
 134+ A090              ; Game_UpdateBallMovement
 135+ A090              ; Da chiamare a ogni tick (AiTick) per muovere la palla se in tiro.
 136+ A090              ;
 137+ A090              ; Usa:
 138+ A090              ;   Var_Game_BallDirection
 139+ A090              ;   Var_Game_BallDiagonalMovCounter (0 normale, 255 caso speciale)
 140+ A090              ;
 141+ A090              ; Convenzioni:
 142+ A090              ;   Game_GetBallPosition -> DE  (D=Y, E=X)
 143+ A090              ;   Game_SetBallPosition usa DE (D=Y, E=X)
 144+ A090              ;
 145+ A090              ; Regole:
 146+ A090              ; - Se BallDirection = NONE -> nessun movimento
 147+ A090              ; - Caso speciale counter=255 (solo WHITE attaccante, campo NORTH, Y=2):
 148+ A090              ;     * NORTH: primo tick = nessun movimento, counter->0
 149+ A090              ;     * NE/NW: primo tick = solo laterale, counter->0
 150+ A090              ; - Diagonali: ogni tick muove Y e prova a muovere X; se X è già al bordo
 151+ A090              ;   che impedisce la diagonale, X non cambia ma il tick conta comunque.
 152+ A090              ; - Il counter aumenta SEMPRE per direzioni diverse da:
 153+ A090              ;       BALL_DIRECTION_NONE, BALL_DIRECTION_NORTH, BALL_DIRECTION_SOUTH
 154+ A090              ; - Se (counter == 2) prima di uscire: Game_StopShot (stop definitivo tiro)
 155+ A090              ; ---------------------------------------------------------------------------
 156+ A090              Game_UpdateBallMovement:
 157+ A090
 158+ A090 3A C0 86         ld    a,(Var_Hooks_ForceVdpRedraw)
 159+ A093 FE 01            cp    YES
 160+ A095 C8               ret   z
 161+ A096 3A 4D 86         LD    A, (Var_Game_BallUpdateTimer)
 162+ A099 3C               inc   a
 163+ A09A 32 4D 86         LD    (Var_Game_BallUpdateTimer), A
 164+ A09D FE 0A            CP    10
 165+ A09F C0               RET    NZ
 166+ A0A0 AF               XOR   A
 167+ A0A1 32 4D 86         LD    (Var_Game_BallUpdateTimer), A
 168+ A0A4
 169+ A0A4 F5               push af
 170+ A0A5 C5               push bc
 171+ A0A6 D5               push de
 172+ A0A7 E5               push hl
 173+ A0A8
 174+ A0A8                  ; se palla ferma -> niente
 175+ A0A8 3A 66 86         ld   a,(Var_Game_BallDirection)
 176+ A0AB FE 00            cp   BALL_DIRECTION_NONE
 177+ A0AD CA F8 A1         jp   z,.done
 178+ A0B0
 179+ A0B0                  ; forza redraw
 180+ A0B0 3E 01            ld   a,YES
 181+ A0B2 32 C0 86         ld   (Var_Hooks_ForceVdpRedraw),a
 182+ A0B5
 183+ A0B5                  ; DE = (Y,X)
 184+ A0B5 CD FD A1         call Game_GetBallPosition         ; D=Y, E=X
 185+ A0B8
 186+ A0B8                  ; ------------------------------------------------------------
 187+ A0B8                  ; Caso speciale "first tick grafico" (counter=255)
 188+ A0B8                  ; ------------------------------------------------------------
 189+ A0B8 3A 67 86         ld   a,(Var_Game_BallDiagonalMovCounter)
 190+ A0BB FE FF            cp   255
 191+ A0BD 20 3B            jr   nz,.normal_move
 192+ A0BF
 193+ A0BF 3A 66 86         ld   a,(Var_Game_BallDirection)
 194+ A0C2 FE 01            cp   BALL_DIRECTION_NORTH
 195+ A0C4 28 0E            jr   z,.special_north
 196+ A0C6 FE 02            cp   BALL_DIRECTION_NORTH_EAST
 197+ A0C8 28 11            jr   z,.special_ne
 198+ A0CA FE 03            cp   BALL_DIRECTION_NORTH_WEST
 199+ A0CC 28 1D            jr   z,.special_nw
 200+ A0CE
 201+ A0CE                  ; se per errore 255 con altre direzioni, normalizza
 202+ A0CE AF               xor  a
 203+ A0CF 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
 204+ A0D2 18 26            jr   .normal_move
 205+ A0D4
 206+ A0D4              .special_north:
 207+ A0D4                  ; primo tick: nessun movimento, solo marker grafico.
 208+ A0D4 AF               xor  a
 209+ A0D5 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
 210+ A0D8 C3 EE A1         jp   .done_check2
 211+ A0DB
 212+ A0DB              .special_ne:
 213+ A0DB                  ; primo tick: solo laterale (X+1 se possibile)
 214+ A0DB 7B               ld   a,e
 215+ A0DC FE 04            cp   4
 216+ A0DE 28 04            jr   z,.special_ne_clear
 217+ A0E0 1C               inc  e
 218+ A0E1 CD 08 A2         call Game_SetBallPosition
 219+ A0E4              .special_ne_clear:
 220+ A0E4 AF               xor  a
 221+ A0E5 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
 222+ A0E8 C3 EE A1         jp   .done_check2
 223+ A0EB
 224+ A0EB              .special_nw:
 225+ A0EB                  ; primo tick: solo laterale (X-1 se possibile)
 226+ A0EB 7B               ld   a,e
 227+ A0EC B7               or   a
 228+ A0ED 28 04            jr   z,.special_nw_clear
 229+ A0EF 1D               dec  e
 230+ A0F0 CD 08 A2         call Game_SetBallPosition
 231+ A0F3              .special_nw_clear:
 232+ A0F3 AF               xor  a
 233+ A0F4 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
 234+ A0F7 C3 EE A1         jp   .done_check2
 235+ A0FA
 236+ A0FA
 237+ A0FA              ; ------------------------------------------------------------
 238+ A0FA              ; Movimento normale
 239+ A0FA              ; ------------------------------------------------------------
 240+ A0FA              .normal_move:
 241+ A0FA
 242+ A0FA
 243+ A0FA                  ; --- incremento counter SOLO se direzione è diagonale ---
 244+ A0FA 3A 66 86         ld   a,(Var_Game_BallDirection)
 245+ A0FD FE 00            cp   BALL_DIRECTION_NONE
 246+ A0FF 28 0F            jr   z,.skip_counter_inc
 247+ A101 FE 01            cp   BALL_DIRECTION_NORTH
 248+ A103 28 0B            jr   z,.skip_counter_inc
 249+ A105 FE 04            cp   BALL_DIRECTION_SOUTH
 250+ A107 28 07            jr   z,.skip_counter_inc
 251+ A109
 252+ A109 3A 67 86         ld   a,(Var_Game_BallDiagonalMovCounter)
 253+ A10C 3C               inc  a
 254+ A10D 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
 255+ A110              .skip_counter_inc:
 256+ A110
 257+ A110 3E 01            ld a, YES
 258+ A112 32 C0 86         ld    (Var_Hooks_ForceVdpRedraw), a
 259+ A115
 260+ A115                  ; dispatch direzione
 261+ A115 3A 66 86         ld   a,(Var_Game_BallDirection)
 262+ A118
 263+ A118 FE 01            cp   BALL_DIRECTION_NORTH
 264+ A11A 28 1E            jr   z,.move_north
 265+ A11C
 266+ A11C FE 04            cp   BALL_DIRECTION_SOUTH
 267+ A11E 28 57            jr   z,.move_south
 268+ A120
 269+ A120 FE 02            cp   BALL_DIRECTION_NORTH_EAST
 270+ A122 CA B2 A1         jp   z,.move_ne
 271+ A125
 272+ A125 FE 03            cp   BALL_DIRECTION_NORTH_WEST
 273+ A127 CA BF A1         jp   z,.move_nw
 274+ A12A
 275+ A12A FE 05            cp   BALL_DIRECTION_SOUTH_EAST
 276+ A12C CA CB A1         jp   z,.move_se
 277+ A12F
 278+ A12F FE 06            cp   BALL_DIRECTION_SOUTH_WEST
 279+ A131 CA D9 A1         jp   z,.move_sw
 280+ A134
 281+ A134                  ; direzione sconosciuta -> stop
 282+ A134 CD BB AA         call Game_StopShot
 283+ A137 C3 F8 A1         jp   .done
 284+ A13A
 285+ A13A
 286+ A13A              .move_north:
 287+ A13A 15               dec     d
 288+ A13B 7A               ld      a,d
 289+ A13C FE FF            cp      255
 290+ A13E 20 2F            jr      nz,.move_north_continue
 291+ A140 14               inc     d
 292+ A141 3A 46 86         ld      a, (Var_Game_ActiveFieldSide)
 293+ A144 FE 01            cp      FIELD_NORTH_SIDE
 294+ A146 CA E9 A1         jp      z,.stop_now
 295+ A149 CD F7 86         CALL    Hooks_TickStop
 296+ A14C 3E 01            LD      A, FIELD_NORTH_SIDE
 297+ A14E 32 46 86         LD      (Var_Game_ActiveFieldSide),A
 298+ A151 CD A6 97         CALL    VDP_DrawField
 299+ A154 CD 16 AF         CALL    Game_PutPlayersToNewFieldSide
 300+ A157 3E 01            ld      a,YES
 301+ A159 32 C0 86         ld      (Var_Hooks_ForceVdpRedraw),a
 302+ A15C CD FD A1         CALL    Game_GetBallPosition
 303+ A15F 16 04            LD      D, 4
 304+ A161 CD 08 A2         CALL    Game_SetBallPosition
 305+ A164 3E FF            LD      A, NO_VALUE
 306+ A166 32 74 86         LD      (Var_Game_BallYOldPosition), A
 307+ A169 CD EF 86         CALL    Hooks_TickStart
 308+ A16C C3 F8 A1         jp      .done
 309+ A16F              .move_north_continue:
 310+ A16F CD 08 A2         call Game_SetBallPosition
 311+ A172
 312+ A172                  ; --- NUOVO: stop se diventa possesso (verticale puro) ---
 313+ A172 CD 36 A0         call Game_CheckVerticalShotPossessionStop
 314+ A175
 315+ A175 18 77            jr   .done_check2
 316+ A177
 317+ A177
 318+ A177              .move_south:
 319+ A177 14               inc     d
 320+ A178 7A               ld      a,d
 321+ A179 FE 05            cp      5
 322+ A17B 20 2D            jr      nz,.move_south_continue
 323+ A17D 15               dec     d
 324+ A17E 3A 46 86         ld      a, (Var_Game_ActiveFieldSide)
 325+ A181 FE 00            cp      FIELD_SOUTH_SIDE
 326+ A183 28 64            jr      z,.stop_now
 327+ A185 CD F7 86         CALL    Hooks_TickStop
 328+ A188 3E 00            LD      A, FIELD_SOUTH_SIDE
 329+ A18A 32 46 86         LD      (Var_Game_ActiveFieldSide),A
 330+ A18D CD A6 97         CALL    VDP_DrawField
 331+ A190 CD 16 AF         CALL    Game_PutPlayersToNewFieldSide
 332+ A193 3E 01            ld      a,YES
 333+ A195 32 C0 86         ld      (Var_Hooks_ForceVdpRedraw),a
 334+ A198 CD FD A1         CALL    Game_GetBallPosition
 335+ A19B 16 00            LD      D, 0
 336+ A19D CD 08 A2         CALL    Game_SetBallPosition
 337+ A1A0 3E FF            LD      A, NO_VALUE
 338+ A1A2 32 74 86         LD      (Var_Game_BallYOldPosition), A
 339+ A1A5 CD EF 86         CALL    Hooks_TickStart
 340+ A1A8 18 4E            jr      .done
 341+ A1AA
 342+ A1AA              .move_south_continue:
 343+ A1AA CD 08 A2         call Game_SetBallPosition
 344+ A1AD
 345+ A1AD                  ; --- NUOVO: stop se diventa possesso (verticale puro) ---
 346+ A1AD CD 36 A0         call Game_CheckVerticalShotPossessionStop
 347+ A1B0
 348+ A1B0 18 3C            jr   .done_check2
 349+ A1B2
 350+ A1B2              ; Diagonali: muove SEMPRE Y, e X solo se non uscirebbe dal bordo.
 351+ A1B2              .move_ne:
 352+ A1B2                  ; Y--
 353+ A1B2 7A               ld   a,d
 354+ A1B3 B7               or   a
 355+ A1B4 28 33            jr   z,.stop_now
 356+ A1B6 15               dec  d
 357+ A1B7                  ; X++ se possibile
 358+ A1B7 7B               ld   a,e
 359+ A1B8 FE 04            cp   4
 360+ A1BA 28 28            jr   z,.set_pos_only      ; a bordo -> solo verticale
 361+ A1BC 1C               inc  e
 362+ A1BD 18 25            jr   .set_pos_only
 363+ A1BF
 364+ A1BF              .move_nw:
 365+ A1BF                  ; Y--
 366+ A1BF 7A               ld   a,d
 367+ A1C0 B7               or   a
 368+ A1C1 28 26            jr   z,.stop_now
 369+ A1C3 15               dec  d
 370+ A1C4                  ; X-- se possibile
 371+ A1C4 7B               ld   a,e
 372+ A1C5 B7               or   a
 373+ A1C6 28 1C            jr   z,.set_pos_only
 374+ A1C8 1D               dec  e
 375+ A1C9 18 19            jr   .set_pos_only
 376+ A1CB
 377+ A1CB              .move_se:
 378+ A1CB                  ; Y++
 379+ A1CB 7A               ld   a,d
 380+ A1CC FE 04            cp   4
 381+ A1CE 28 19            jr   z,.stop_now
 382+ A1D0 14               inc  d
 383+ A1D1                  ; X++ se possibile
 384+ A1D1 7B               ld   a,e
 385+ A1D2 FE 04            cp   4
 386+ A1D4 28 0E            jr   z,.set_pos_only
 387+ A1D6 1C               inc  e
 388+ A1D7 18 0B            jr   .set_pos_only
 389+ A1D9
 390+ A1D9              .move_sw:
 391+ A1D9                  ; Y++
 392+ A1D9 7A               ld   a,d
 393+ A1DA FE 04            cp   4
 394+ A1DC 28 0B            jr   z,.stop_now
 395+ A1DE 14               inc  d
 396+ A1DF                  ; X-- se possibile
 397+ A1DF 7B               ld   a,e
 398+ A1E0 B7               or   a
 399+ A1E1 28 01            jr   z,.set_pos_only
 400+ A1E3 1D               dec  e
 401+ A1E4
 402+ A1E4              .set_pos_only:
 403+ A1E4 CD 08 A2         call Game_SetBallPosition
 404+ A1E7 18 05            jr   .done_check2
 405+ A1E9
 406+ A1E9
 407+ A1E9              .stop_now:
 408+ A1E9 CD BB AA         call Game_StopShot
 409+ A1EC 18 0A            jr   .done
 410+ A1EE
 411+ A1EE
 412+ A1EE              ; ------------------------------------------------------------
 413+ A1EE              ; Check fine tiro dopo 2 tick (vale SOLO per diagonali perché
 414+ A1EE              ; il counter viene incrementato solo in quei casi).
 415+ A1EE              ; ------------------------------------------------------------
 416+ A1EE              .done_check2:
 417+ A1EE 3A 67 86         ld   a,(Var_Game_BallDiagonalMovCounter)
 418+ A1F1 FE 02            cp   2
 419+ A1F3 20 03            jr   nz,.done
 420+ A1F5 CD BB AA         call Game_StopShot
 421+ A1F8
 422+ A1F8              .done:
 423+ A1F8 E1               pop  hl
 424+ A1F9 D1               pop  de
 425+ A1FA C1               pop  bc
 426+ A1FB F1               pop  af
 427+ A1FC C9               ret
 428+ A1FD
 429+ A1FD
 430+ A1FD
 431+ A1FD              ;------------------------------------------------------------------------
 432+ A1FD              ; Get ball position
 433+ A1FD              ; INPUT: -
 434+ A1FD              ; OUTPUT: DE = X,Y
 435+ A1FD              ; MODIFIES: -
 436+ A1FD              ;------------------------------------------------------------------------
 437+ A1FD              Game_GetBallPosition:
 438+ A1FD F5               PUSH    AF
 439+ A1FE 3A 6F 86         LD      A, (Var_Game_BallXPosition)
 440+ A201 5F               LD      E, A
 441+ A202 3A 73 86         LD      A, (Var_Game_BallYPosition)
 442+ A205 57               LD      D, A
 443+ A206 F1               POP     AF
 444+ A207 C9               RET
 445+ A208              ;------------------------------------------------------------------------
 446+ A208              ; Set ball position
 447+ A208              ; INPUT:  D = Y, E = X   (coordinate di matrice 0..4)
 448+ A208              ; OUTPUT: -
 449+ A208              ; MODIFIES: AF
 450+ A208              ; NOTE:
 451+ A208              ;   - Prima copia la posizione corrente in Var_Game_Ball*OldPosition
 452+ A208              ;   - Poi aggiorna Var_Game_BallX/YPosition con la nuova
 453+ A208              ;------------------------------------------------------------------------
 454+ A208              Game_SetBallPosition:
 455+ A208 F5               PUSH    AF
 456+ A209
 457+ A209                  ; --- salviamo la posizione corrente come "old" ---
 458+ A209 3A 6F 86         LD      A,(Var_Game_BallXPosition)
 459+ A20C 32 75 86         LD      (Var_Game_BallXOldPosition),A
 460+ A20F
 461+ A20F 3A 73 86         LD      A,(Var_Game_BallYPosition)
 462+ A212 32 74 86         LD      (Var_Game_BallYOldPosition),A
 463+ A215
 464+ A215                  ; --- scriviamo la nuova posizione (da D/E) ---
 465+ A215 7A               LD      A,D
 466+ A216 32 73 86         LD      (Var_Game_BallYPosition),A
 467+ A219
 468+ A219 7B               LD      A,E
 469+ A21A 32 6F 86         LD      (Var_Game_BallXPosition),A
 470+ A21D
 471+ A21D F1               POP     AF
 472+ A21E C9               RET
 473+ A21F
 474+ A21F              ; ** UTILITY ROUTINES **
 475+ A21F
 476+ A21F              ; ---------------------------------------------------------------------------
 477+ A21F              ; Calculates pointer to the player entry in Var_Game_PlayersInfo.
 478+ A21F              ;
 479+ A21F              ; INPUT:
 480+ A21F              ;   B = TEAM (TEAM_BLACK=0, TEAM_WHITE=1)
 481+ A21F              ;   C = ID   (0..3)  ; 4 players per team
 482+ A21F              ;
 483+ A21F              ; OUTPUT:
 484+ A21F              ;   HL = pointer to entry start:
 485+ A21F              ;        [0] PREV_X, [1] PREV_Y, [2] CUR_X, [3] CUR_Y,
 486+ A21F              ;        [4] TEAM, [5] ID, [6] ROLE
 487+ A21F              ;
 488+ A21F              ; PRESERVES:
 489+ A21F              ;   B = TEAM, C = ID    (utile per le routine chiamanti)
 490+ A21F              ;
 491+ A21F              ; MODIFIES:
 492+ A21F              ;   AF, DE, HL
 493+ A21F              ; ---------------------------------------------------------------------------
 494+ A21F              GetPlayerEntryPtr:
 495+ A21F                  ; n = TEAM*4 + ID  (TEAM_BLACK=0, TEAM_WHITE=1)
 496+ A21F                  ; salvo TEAM/ID perché userò BC come registro di lavoro
 497+ A21F C5               PUSH BC
 498+ A220
 499+ A220 78               LD   A,B
 500+ A221 87               ADD  A,A           ; *2
 501+ A222 87               ADD  A,A           ; *4
 502+ A223 81               ADD  A,C           ; + ID → n (0..7)
 503+ A224
 504+ A224 4F               LD   C,A           ; C = n
 505+ A225 06 00            LD   B,0           ; BC = n (16-bit)
 506+ A227
 507+ A227                  ; HL = n * PLAYER_ENTRY_SIZE (7)
 508+ A227 21 00 00         LD   HL,0
 509+ A22A 3E 07            LD   A,PLAYER_ENTRY_SIZE      ; A = 7
 510+ A22C              .GPE_MulLoop:
 511+ A22C 09               ADD  HL,BC                    ; HL += n
 512+ A22D 3D               DEC  A
 513+ A22E 20 FC            JR   NZ,.GPE_MulLoop          ; ripeti 7 volte
 514+ A230
 515+ A230                  ; A questo punto HL = n * 7
 516+ A230 11 76 86         LD   DE,Var_Game_PlayersInfo
 517+ A233 19               ADD  HL,DE                    ; HL = base + n*7
 518+ A234
 519+ A234 C1               POP  BC                       ; ripristina TEAM/ID
 520+ A235 C9               RET
 521+ A236
 522+ A236
 523+ A236              ; ---------------------------------------------------------------------------
 524+ A236              ; Determines the role of a player based on TEAM, FIELD DIRECTION and Y.
 525+ A236              ; NOTE:
 526+ A236              ;   This is intended for non-goalkeepers (ID != 0).
 527+ A236              ;   Goalkeepers are forced to ROLE_GOALKEEPER in SetPlayerInfo, but
 528+ A236              ;   mappings for goalkeeper rows are kept here for completeness.
 529+ A236              ;
 530+ A236              ; LOGIC (Var_Game_ActiveFieldSide = FIELD_NORTH_SIDE):
 531+ A236              ;   TEAM_BLACK:
 532+ A236              ;       Y=0 -> GOALKEEPER
 533+ A236              ;       Y=1 -> DEFENDER
 534+ A236              ;       Y=3 -> MIDFIELDER
 535+ A236              ;       else -> STRIKER
 536+ A236              ;   TEAM_WHITE (no visible goalkeeper):
 537+ A236              ;       Y=4 -> MIDFIELDER
 538+ A236              ;       Y=2 -> STRIKER
 539+ A236              ;       else -> STRIKER
 540+ A236              ;
 541+ A236              ; LOGIC (Var_Game_ActiveFieldSide = FIELD_SOUTH_SIDE):
 542+ A236              ;   TEAM_WHITE:
 543+ A236              ;       Y=4 -> GOALKEEPER
 544+ A236              ;       Y=3 -> DEFENDER
 545+ A236              ;       Y=1 -> MIDFIELDER
 546+ A236              ;       else -> STRIKER
 547+ A236              ;   TEAM_BLACK (no visible goalkeeper):
 548+ A236              ;       Y=0 -> MIDFIELDER
 549+ A236              ;       Y=2 -> STRIKER
 550+ A236              ;       else -> STRIKER
 551+ A236              ;
 552+ A236              ; INPUT:
 553+ A236              ;   B = TEAM (TEAM_WHITE or TEAM_BLACK)
 554+ A236              ;   D = Y (0..4)
 555+ A236              ; OUTPUT:
 556+ A236              ;   A = ROLE (ROLE_GOALKEEPER / ROLE_DEFENDER / ROLE_MIDFIELDER / ROLE_STRIKER)
 557+ A236              ; MODIFIES:
 558+ A236              ;   AF
 559+ A236              ; ---------------------------------------------------------------------------
 560+ A236              DeterminePlayerRole:
 561+ A236 3A 46 86         LD   A,(Var_Game_ActiveFieldSide)
 562+ A239 FE 01            CP   FIELD_NORTH_SIDE
 563+ A23B 28 30            JR   Z,.NORTH
 564+ A23D
 565+ A23D              ; ===== FIELD DIRECTION SOUTH =======================================
 566+ A23D
 567+ A23D              .SOUTH:
 568+ A23D                  ; Check which team
 569+ A23D 78               LD   A,B
 570+ A23E FE 01            CP   TEAM_WHITE
 571+ A240 28 12            JR   Z,.SOUTH_WHITE
 572+ A242
 573+ A242                  ; --- TEAM_BLACK (no visible goalkeeper) ---
 574+ A242 7A               LD   A,D
 575+ A243 FE 00            CP   0
 576+ A245 28 07            JR   Z,.BLACK_MID_S
 577+ A247 FE 02            CP   2
 578+ A249 28 06            JR   Z,.BLACK_STR_S
 579+ A24B
 580+ A24B 3E 03            LD   A,ROLE_STRIKER
 581+ A24D C9               RET
 582+ A24E
 583+ A24E              .BLACK_MID_S:
 584+ A24E 3E 02            LD   A,ROLE_MIDFIELDER
 585+ A250 C9               RET
 586+ A251
 587+ A251              .BLACK_STR_S:
 588+ A251 3E 03            LD   A,ROLE_STRIKER
 589+ A253 C9               RET
 590+ A254
 591+ A254              ; --- TEAM_WHITE (with goalkeeper) ---
 592+ A254              .SOUTH_WHITE:
 593+ A254 7A               LD   A,D
 594+ A255 FE 04            CP   4
 595+ A257 28 0B            JR   Z,.WHITE_GK_S
 596+ A259 FE 03            CP   3
 597+ A25B 28 0A            JR   Z,.WHITE_DEF_S
 598+ A25D FE 01            CP   1
 599+ A25F 28 09            JR   Z,.WHITE_MID_S
 600+ A261
 601+ A261 3E 03            LD   A,ROLE_STRIKER
 602+ A263 C9               RET
 603+ A264
 604+ A264              .WHITE_GK_S:
 605+ A264 3E 00            LD   A,ROLE_GOALKEEPER
 606+ A266 C9               RET
 607+ A267
 608+ A267              .WHITE_DEF_S:
 609+ A267 3E 01            LD   A,ROLE_DEFENDER
 610+ A269 C9               RET
 611+ A26A
 612+ A26A              .WHITE_MID_S:
 613+ A26A 3E 02            LD   A,ROLE_MIDFIELDER
 614+ A26C C9               RET
 615+ A26D
 616+ A26D
 617+ A26D              ; ===== FIELD DIRECTION NORTH ======================================
 618+ A26D
 619+ A26D              .NORTH:
 620+ A26D                  ; Check which team
 621+ A26D 78               LD   A,B
 622+ A26E FE 01            CP   TEAM_WHITE
 623+ A270 28 19            JR   Z,.NORTH_WHITE
 624+ A272
 625+ A272                  ; --- TEAM_BLACK (with goalkeeper) ---
 626+ A272 7A               LD   A,D
 627+ A273 FE 00            CP   0
 628+ A275 28 0B            JR   Z,.BLACK_GK_N
 629+ A277 FE 01            CP   1
 630+ A279 28 0A            JR   Z,.BLACK_DEF_N
 631+ A27B FE 03            CP   3
 632+ A27D 28 09            JR   Z,.BLACK_MID_N
 633+ A27F
 634+ A27F 3E 03            LD   A,ROLE_STRIKER
 635+ A281 C9               RET
 636+ A282
 637+ A282              .BLACK_GK_N:
 638+ A282 3E 00            LD   A,ROLE_GOALKEEPER
 639+ A284 C9               RET
 640+ A285
 641+ A285              .BLACK_DEF_N:
 642+ A285 3E 01            LD   A,ROLE_DEFENDER
 643+ A287 C9               RET
 644+ A288
 645+ A288              .BLACK_MID_N:
 646+ A288 3E 02            LD   A,ROLE_MIDFIELDER
 647+ A28A C9               RET
 648+ A28B
 649+ A28B              ; --- TEAM_WHITE (no visible goalkeeper) ---
 650+ A28B              .NORTH_WHITE:
 651+ A28B 7A               LD   A,D
 652+ A28C FE 04            CP   4
 653+ A28E 28 07            JR   Z,.WHITE_MID_N
 654+ A290 FE 02            CP   2
 655+ A292 28 06            JR   Z,.WHITE_STR_N
 656+ A294
 657+ A294 3E 03            LD   A,ROLE_STRIKER
 658+ A296 C9               RET
 659+ A297
 660+ A297              .WHITE_MID_N:
 661+ A297 3E 02            LD   A,ROLE_MIDFIELDER
 662+ A299 C9               RET
 663+ A29A
 664+ A29A              .WHITE_STR_N:
 665+ A29A 3E 03            LD   A,ROLE_STRIKER
 666+ A29C C9               RET
 667+ A29D
 668+ A29D              ; ---------------------------------------------------------------------------
 669+ A29D              ; Sets player info, updating previous and current positions and role.
 670+ A29D              ; Previous position is taken from old CUR_X/CUR_Y (if not NO_VALUE).
 671+ A29D              ; For ID = 0, the role is always ROLE_GOALKEEPER.
 672+ A29D              ;
 673+ A29D              ; INPUT:
 674+ A29D              ;   B = TEAM (TEAM_WHITE / TEAM_BLACK)
 675+ A29D              ;   C = ID   (0..3)
 676+ A29D              ;   D = new Y (0..4 o 255 per invisibile)
 677+ A29D              ;   E = new X (0..4 o 255 per invisibile)
 678+ A29D              ; OUTPUT:
 679+ A29D              ;   -
 680+ A29D              ; MODIFIES:
 681+ A29D              ;   AF, DE, HL
 682+ A29D              ; ---------------------------------------------------------------------------
 683+ A29D              SetPlayerInfo:
 684+ A29D C5               PUSH    BC             ; salva TEAM, ID
 685+ A29E D5               PUSH    DE             ; salva newY,newX
 686+ A29F
 687+ A29F                  ; HL -> inizio entry (PREV_X)
 688+ A29F CD 1F A2         CALL    GetPlayerEntryPtr
 689+ A2A2
 690+ A2A2                  ; ----- leggi vecchia CUR_X / CUR_Y -----
 691+ A2A2 E5               PUSH    HL             ; salva base entry
 692+ A2A3
 693+ A2A3 23               INC     HL             ; PREV_Y
 694+ A2A4 23               INC     HL             ; CUR_X
 695+ A2A5 7E               LD      A,(HL)         ; A = old CUR_X
 696+ A2A6 23               INC     HL             ; CUR_Y
 697+ A2A7 4E               LD      C,(HL)         ; C = old CUR_Y
 698+ A2A8
 699+ A2A8 E1               POP     HL             ; HL di nuovo su PREV_X
 700+ A2A9
 701+ A2A9                  ; ----- PREV_X / PREV_Y -----
 702+ A2A9 77               LD      (HL),A         ; PREV_X = old CUR_X
 703+ A2AA 23               INC     HL
 704+ A2AB 71               LD      (HL),C         ; PREV_Y = old CUR_Y
 705+ A2AC
 706+ A2AC                  ; ----- CUR_X / CUR_Y -----
 707+ A2AC 23               INC     HL             ; HL -> CUR_X
 708+ A2AD D1               POP     DE             ; D=newY, E=newX
 709+ A2AE 73               LD      (HL),E         ; CUR_X
 710+ A2AF 23               INC     HL
 711+ A2B0 72               LD      (HL),D         ; CUR_Y
 712+ A2B1
 713+ A2B1                  ; ----- TEAM / ID / ROLE -----
 714+ A2B1 23               INC     HL             ; TEAM
 715+ A2B2 C1               POP     BC             ; ripristina TEAM,ID
 716+ A2B3 70               LD      (HL),B         ; TEAM
 717+ A2B4 23               INC     HL             ; ID
 718+ A2B5 71               LD      (HL),C         ; ID
 719+ A2B6 23               INC     HL             ; ROLE
 720+ A2B7
 721+ A2B7                  ; Se ID=0 → portiere fisso
 722+ A2B7 79               LD      A,C
 723+ A2B8 B7               OR      A
 724+ A2B9 20 04            JR      NZ,.not_goalkeeper
 725+ A2BB
 726+ A2BB 3E 00            LD      A,ROLE_GOALKEEPER
 727+ A2BD 77               LD      (HL),A
 728+ A2BE C9               RET
 729+ A2BF
 730+ A2BF              .not_goalkeeper:
 731+ A2BF                  ; determina il ruolo per i giocatori di movimento
 732+ A2BF                  ; B = TEAM, D = Y sono ancora validi
 733+ A2BF CD 36 A2         CALL    DeterminePlayerRole
 734+ A2C2 77               LD      (HL),A
 735+ A2C3 C9               RET
 736+ A2C4
 737+ A2C4              ; ---------------------------------------------------------------------------
 738+ A2C4              ; Gets player info by TEAM and ID.
 739+ A2C4              ;
 740+ A2C4              ; INPUT:
 741+ A2C4              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
 742+ A2C4              ;   C = ID    (0..3)
 743+ A2C4              ;
 744+ A2C4              ; OUTPUT (se OK):
 745+ A2C4              ;   HL = current position (H = Y, L = X)
 746+ A2C4              ;   DE = previous position (D = prevY, E = prevX)
 747+ A2C4              ;   A  = ROLE
 748+ A2C4              ;   B  = TEAM (come in ingresso)
 749+ A2C4              ;   C  = ID   (come in ingresso)
 750+ A2C4              ;
 751+ A2C4              ; OUTPUT (se ID fuori range):
 752+ A2C4              ;   A  = NO_VALUE
 753+ A2C4              ;
 754+ A2C4              ; MODIFIES:
 755+ A2C4              ;   AF, DE, HL
 756+ A2C4              ; ---------------------------------------------------------------------------
 757+ A2C4              Game_GetPlayerInfoById:
 758+ A2C4 79               ld   a,c
 759+ A2C5 FE 04            cp   4
 760+ A2C7 38 03            jr   c,.GPI_ValidId
 761+ A2C9 3E FF            ld   a,NO_VALUE
 762+ A2CB C9               ret
 763+ A2CC
 764+ A2CC              .GPI_ValidId:
 765+ A2CC                  ; salviamo TEAM/ID perché useremo B,C come temporanei
 766+ A2CC C5               push bc
 767+ A2CD
 768+ A2CD                  ; HL -> PREV_X dell'entry (usa TEAM/ID salvati dentro GetPlayerEntryPtr)
 769+ A2CD                  ; GetPlayerEntryPtr preserva B,C da solo (fa PUSH/POP BC)
 770+ A2CD CD 1F A2         call GetPlayerEntryPtr       ; HL = base entry (PREV_X)
 771+ A2D0
 772+ A2D0                  ; ----- PREV in DE -----
 773+ A2D0 5E               ld   e,(hl)                  ; PREV_X
 774+ A2D1 23               inc  hl
 775+ A2D2 56               ld   d,(hl)                  ; PREV_Y
 776+ A2D3
 777+ A2D3                  ; ----- CUR in B,C temporanei -----
 778+ A2D3 23               inc  hl                      ; CUR_X
 779+ A2D4 4E               ld   c,(hl)                  ; C = CUR_X
 780+ A2D5 23               inc  hl                      ; CUR_Y
 781+ A2D6 46               ld   b,(hl)                  ; B = CUR_Y
 782+ A2D7
 783+ A2D7                  ; ----- ROLE in A -----
 784+ A2D7 23               inc  hl                      ; TEAM
 785+ A2D8 23               inc  hl                      ; ID
 786+ A2D9 23               inc  hl                      ; ROLE
 787+ A2DA 7E               ld   a,(hl)                  ; A = ROLE
 788+ A2DB
 789+ A2DB                  ; ----- ricomponi output -----
 790+ A2DB                  ; HL = (Y,X)
 791+ A2DB 60               ld   h,b                     ; H = CUR_Y
 792+ A2DC 69               ld   l,c                     ; L = CUR_X
 793+ A2DD
 794+ A2DD                  ; DE già contiene (prevY,prevX)
 795+ A2DD
 796+ A2DD                  ; ripristina TEAM/ID originali in BC
 797+ A2DD C1               pop  bc                      ; B = TEAM, C = ID
 798+ A2DE
 799+ A2DE C9               ret
 800+ A2DF
 801+ A2DF
 802+ A2DF
 803+ A2DF              ; ---------------------------------------------------------------------------
 804+ A2DF              ; Searches a player by his current position (CUR_X, CUR_Y).
 805+ A2DF              ;
 806+ A2DF              ; INPUT:
 807+ A2DF              ;   D = Y (curY)
 808+ A2DF              ;   E = X (curX)
 809+ A2DF              ;
 810+ A2DF              ; OUTPUT (if found):
 811+ A2DF              ;   B  = TEAM        (0 = TEAM_BLACK, 1 = TEAM_WHITE)
 812+ A2DF              ;   C  = ID          (0..3)
 813+ A2DF              ;   A  = ROLE
 814+ A2DF              ;   DE = current position  (D = curY, E = curX)
 815+ A2DF              ;   HL = previous position (H = prevY, L = prevX)
 816+ A2DF              ;
 817+ A2DF              ; OUTPUT (if not found):
 818+ A2DF              ;   A  = NO_VALUE
 819+ A2DF              ;
 820+ A2DF              ; MODIFIES:
 821+ A2DF              ;   AF, BC, DE, HL
 822+ A2DF              ; ---------------------------------------------------------------------------
 823+ A2DF              Game_GetPlayerInfoByPos:
 824+ A2DF 06 00            LD   B,TEAM_BLACK
 825+ A2E1              .black:
 826+ A2E1 0E 00            LD   C,0                      ; ID = 0..3
 827+ A2E3              .black_loop:
 828+ A2E3 C5               PUSH BC
 829+ A2E4 D5               PUSH DE
 830+ A2E5 CD C4 A2         CALL Game_GetPlayerInfoById
 831+ A2E8 D1               POP DE
 832+ A2E9 C1               POP BC
 833+ A2EA 7C               LD   A, H
 834+ A2EB BA               CP   D
 835+ A2EC 20 08            JR   NZ,.black_loop_not_found
 836+ A2EE 7D               LD   A, L
 837+ A2EF BB               CP   E
 838+ A2F0 20 04            JR   NZ,.black_loop_not_found
 839+ A2F2 CD C4 A2         CALL Game_GetPlayerInfoById
 840+ A2F5 C9               RET
 841+ A2F6              .black_loop_not_found
 842+ A2F6 0C               INC  C
 843+ A2F7 79               LD   A, C
 844+ A2F8 FE 04            CP   4
 845+ A2FA 20 E7            JR   NZ, .black_loop
 846+ A2FC 06 01            LD   B,TEAM_WHITE
 847+ A2FE              .white:
 848+ A2FE 0E 00            LD   C,0
 849+ A300              .white_loop:
 850+ A300 C5               PUSH BC
 851+ A301 D5               PUSH DE
 852+ A302 CD C4 A2         CALL Game_GetPlayerInfoById
 853+ A305 D1               POP DE
 854+ A306 C1               POP BC
 855+ A307 7C               LD   A, H
 856+ A308 BA               CP   D
 857+ A309 20 08            JR   NZ,.white_loop_not_found
 858+ A30B 7D               LD   A, L
 859+ A30C BB               CP   E
 860+ A30D 20 04            JR   NZ,.white_loop_not_found
 861+ A30F CD C4 A2         CALL Game_GetPlayerInfoById
 862+ A312 C9               RET
 863+ A313              .white_loop_not_found
 864+ A313 0C               INC  C
 865+ A314 79               LD   A, C
 866+ A315 FE 04            CP   4
 867+ A317 20 E7            JR   NZ, .white_loop
 868+ A319 3E FF            LD   A, NO_VALUE
 869+ A31B C9               RET
 870+ A31C
 871+ A31C              ; ---------------------------------------------------------------------------
 872+ A31C              ; Clears all previous positions (PREV_X, PREV_Y) for all players.
 873+ A31C              ; PREV_X and PREV_Y are set to NO_VALUE (255).
 874+ A31C              ;
 875+ A31C              ; INPUT:
 876+ A31C              ;  B: TEAM (TEAM_BLACK / TEAM_WHITE)
 877+ A31C              ;  C: ID (0..3)
 878+ A31C              ;   -
 879+ A31C              ; OUTPUT:
 880+ A31C              ;   -
 881+ A31C              ; MODIFIES:
 882+ A31C              ;   -
 883+ A31C              ; ---------------------------------------------------------------------------
 884+ A31C              Game_ClearSinglePlayerPrevPositions:
 885+ A31C D5               PUSH DE
 886+ A31D C5               PUSH BC
 887+ A31E E5               PUSH HL
 888+ A31F F5               PUSH AF
 889+ A320
 890+ A320
 891+ A320
 892+ A320 CD 1F A2         CALL GetPlayerEntryPtr        ; HL -> PREV_X of this player
 893+ A323 3E FF            LD   A, NO_VALUE
 894+ A325 77               LD   (HL),A                   ; PREV_X = NO_VALUE
 895+ A326 23               INC  HL
 896+ A327 77               LD   (HL),A                   ; PREV_Y = NO_VALUE
 897+ A328
 898+ A328
 899+ A328
 900+ A328
 901+ A328 F1               POP AF
 902+ A329 E1               POP HL
 903+ A32A C1               POP BC
 904+ A32B D1               POP DE
 905+ A32C C9               RET
 906+ A32D              ; ---------------------------------------------------------------------------
 907+ A32D              ; Clears all previous positions (PREV_X, PREV_Y) for all players.
 908+ A32D              ; PREV_X and PREV_Y are set to NO_VALUE (255).
 909+ A32D              ;
 910+ A32D              ; INPUT:
 911+ A32D              ;   -
 912+ A32D              ; OUTPUT:
 913+ A32D              ;   -
 914+ A32D              ; MODIFIES:
 915+ A32D              ;   AF, BC, HL
 916+ A32D              ; ---------------------------------------------------------------------------
 917+ A32D              ClearAllPrevPositions:
 918+ A32D 3E FF            LD   A,NO_VALUE
 919+ A32F
 920+ A32F                  ; ---- Team BLACK ----
 921+ A32F 06 00            LD   B,TEAM_BLACK
 922+ A331 CD 3A A3         CALL .ClearTeamPrev
 923+ A334
 924+ A334                  ; ---- Team WHITE ----
 925+ A334 06 01            LD   B,TEAM_WHITE
 926+ A336 CD 3A A3         CALL .ClearTeamPrev
 927+ A339
 928+ A339 C9               RET
 929+ A33A
 930+ A33A              ; Clears PREV_X / PREV_Y for one team (B = TEAM, C = 0..3)
 931+ A33A              .ClearTeamPrev:
 932+ A33A 0E 00            LD   C,0                      ; ID = 0..3
 933+ A33C              .CT_Loop:
 934+ A33C C5               PUSH BC
 935+ A33D CD 1F A2         CALL GetPlayerEntryPtr        ; HL -> PREV_X of this player
 936+ A340 3E FF            LD   A, NO_VALUE
 937+ A342 77               LD   (HL),A                   ; PREV_X = NO_VALUE
 938+ A343 23               INC  HL
 939+ A344 77               LD   (HL),A                   ; PREV_Y = NO_VALUE
 940+ A345
 941+ A345 C1               POP  BC
 942+ A346 0C               INC  C
 943+ A347 79               LD   A,C                      ; *** qui confrontiamo C, non A vecchio ***
 944+ A348 FE 04            CP   4
 945+ A34A 20 F0            JR   NZ,.CT_Loop
 946+ A34C C9               RET
 947+ A34D
 948+ A34D
 949+ A34D
 950+ A34D
 951+ A34D              ; ---------------------------------------------------------------------------
 952+ A34D              ; Sets kickoff schema when WHITE team is attacking (field direction NORTH).
 953+ A34D              ; Black goalkeeper is visible on row 0, white goalkeeper is hidden.
 954+ A34D              ; Players layout (Y=row, X=col):
 955+ A34D              ;   - Black GK:        Y=0, X=2
 956+ A34D              ;   - Black DEF:       Y=1, X=1 and Y=1, X=3
 957+ A34D              ;   - Black MID:       Y=3, X=4
 958+ A34D              ;   - White MID:       Y=4, X=1,2,3
 959+ A34D              ;   - White GK:        Y=255 (hidden), X=2
 960+ A34D              ; Also sets virtual player variables for a black virtual player at (0,0).
 961+ A34D              ; INPUT:
 962+ A34D              ;   -
 963+ A34D              ; OUTPUT:
 964+ A34D              ;   Var_Game_ActiveFieldSide updated
 965+ A34D              ;   Var_Game_PlayersInfo fully initialized for this schema
 966+ A34D              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
 967+ A34D              ; MODIFIES:
 968+ A34D              ;   AF, BC, DE, HL
 969+ A34D              ; ---------------------------------------------------------------------------
 970+ A34D              Game_SetWhiteKickoffSchema:
 971+ A34D 3E 01            LD   A, TEAM_WHITE
 972+ A34F 32 64 86         LD   (Var_Game_TeamWithBall), A
 973+ A352
 974+ A352 16 03            LD     D, 3
 975+ A354 1E 02            LD     E, 2
 976+ A356 CD 08 A2         CALL   Game_SetBallPosition
 977+ A359 3E FF            LD     A, 255
 978+ A35B 32 74 86         LD     (Var_Game_BallYOldPosition ), A
 979+ A35E 3E 00            LD      A, BALL_DIRECTION_NONE
 980+ A360 32 66 86         LD      (Var_Game_BallDirection),A
 981+ A363
 982+ A363                  ; Set field direction to NORTH
 983+ A363 3E 01            LD   A,FIELD_NORTH_SIDE
 984+ A365 32 46 86         LD   (Var_Game_ActiveFieldSide),A
 985+ A368
 986+ A368                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
 987+ A368
 988+ A368                  ; Black GK, ID=0, Y=0, X=2
 989+ A368 06 00            LD   B,TEAM_BLACK
 990+ A36A 0E 00            LD   C,0                  ; ID=0 (goalkeeper)
 991+ A36C 16 00            LD   D,0                  ; Y
 992+ A36E 1E 02            LD   E,2                  ; X
 993+ A370 CD 9D A2         CALL SetPlayerInfo
 994+ A373
 995+ A373                  ; Black DEF 1, ID=1, Y=1, X=1
 996+ A373 06 00            LD   B,TEAM_BLACK
 997+ A375 0E 01            LD   C,1
 998+ A377 16 01            LD   D,1
 999+ A379 1E 01            LD   E,1
1000+ A37B CD 9D A2         CALL SetPlayerInfo
1001+ A37E
1002+ A37E                  ; Black DEF 2, ID=2, Y=1, X=3
1003+ A37E 06 00            LD   B,TEAM_BLACK
1004+ A380 0E 02            LD   C,2
1005+ A382 16 01            LD   D,1
1006+ A384 1E 03            LD   E,3
1007+ A386 CD 9D A2         CALL SetPlayerInfo
1008+ A389
1009+ A389                  ; Black MID, ID=3, Y=3, X=4
1010+ A389 06 00            LD   B,TEAM_BLACK
1011+ A38B 0E 03            LD   C,3
1012+ A38D 16 03            LD   D,3
1013+ A38F 1E 04            LD   E,4
1014+ A391 CD 9D A2         CALL SetPlayerInfo
1015+ A394
1016+ A394                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1017+ A394
1018+ A394                  ; White GK hidden, ID=0, Y=255, X=2
1019+ A394 06 01            LD   B,TEAM_WHITE
1020+ A396 0E 00            LD   C,0
1021+ A398 16 FF            LD   D,255
1022+ A39A 1E 02            LD   E,2
1023+ A39C CD 9D A2         CALL SetPlayerInfo
1024+ A39F
1025+ A39F                  ; White MID 1, ID=1, Y=4, X=1
1026+ A39F 06 01            LD   B,TEAM_WHITE
1027+ A3A1 0E 01            LD   C,1
1028+ A3A3 16 04            LD   D,4
1029+ A3A5 1E 01            LD   E,1
1030+ A3A7 CD 9D A2         CALL SetPlayerInfo
1031+ A3AA
1032+ A3AA                  ; White MID 2, ID=2, Y=4, X=2
1033+ A3AA 06 01            LD   B,TEAM_WHITE
1034+ A3AC 0E 02            LD   C,2
1035+ A3AE 16 04            LD   D,4
1036+ A3B0 1E 02            LD   E,2
1037+ A3B2 CD 9D A2         CALL SetPlayerInfo
1038+ A3B5
1039+ A3B5                  ; White MID 3, ID=3, Y=4, X=3
1040+ A3B5 06 01            LD   B,TEAM_WHITE
1041+ A3B7 0E 03            LD   C,3
1042+ A3B9 16 04            LD   D,4
1043+ A3BB 1E 03            LD   E,3
1044+ A3BD CD 9D A2         CALL SetPlayerInfo
1045+ A3C0
1046+ A3C0                  ; ---- VIRTUAL PLAYER ------------------------------------------
1047+ A3C0
1048+ A3C0 3E 00            LD   A,TEAM_BLACK
1049+ A3C2 32 6A 86         LD   (Var_Game_VirtualPlayerTeam),A
1050+ A3C5
1051+ A3C5 AF               XOR   A
1052+ A3C6 32 69 86         LD   (Var_Game_VirtualPlayerXPos),A   ; X=0
1053+ A3C9 3E 03            LD   A, 3
1054+ A3CB 32 68 86         LD   (Var_Game_VirtualPlayerYPos),A
1055+ A3CE                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1056+ A3CE CD 2D A3         CALL ClearAllPrevPositions
1057+ A3D1
1058+ A3D1 C9               RET
1059+ A3D2
1060+ A3D2              ; ---------------------------------------------------------------------------
1061+ A3D2              ; Sets kickoff schema when BLACK team is attacking (field direction SOUTH).
1062+ A3D2              ; White goalkeeper is visible on row 4, black goalkeeper is hidden.
1063+ A3D2              ; Players layout (Y=row, X=col):
1064+ A3D2              ;   - White GK:        Y=4, X=2
1065+ A3D2              ;   - White DEF:       Y=3, X=1 and Y=3, X=3
1066+ A3D2              ;   - White MID:       Y=1, X=0
1067+ A3D2              ;   - Black MID:       Y=0, X=1,2,3
1068+ A3D2              ;   - Black GK:        Y=255 (hidden), X=2
1069+ A3D2              ; Also sets virtual player variables for a white virtual player at (1,4).
1070+ A3D2              ; INPUT:
1071+ A3D2              ;   -
1072+ A3D2              ; OUTPUT:
1073+ A3D2              ;   Var_Game_ActiveFieldSide updated
1074+ A3D2              ;   Var_Game_PlayersInfo fully initialized for this schema
1075+ A3D2              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1076+ A3D2              ; MODIFIES:
1077+ A3D2              ;   AF, BC, DE, HL
1078+ A3D2              ; ---------------------------------------------------------------------------
1079+ A3D2              Game_SetBlackKickoffSchema:
1080+ A3D2 3E 00            LD   A, TEAM_BLACK
1081+ A3D4 32 64 86         LD   (Var_Game_TeamWithBall), A
1082+ A3D7
1083+ A3D7 16 00            LD     D, 0
1084+ A3D9 1E 02            LD     E, 2
1085+ A3DB CD 08 A2         CALL   Game_SetBallPosition
1086+ A3DE 3E FF            LD     A, 255
1087+ A3E0 32 74 86         LD     (Var_Game_BallYOldPosition ), A
1088+ A3E3 3E 00            LD   A, BALL_DIRECTION_NONE
1089+ A3E5 32 66 86         LD   (Var_Game_BallDirection),A
1090+ A3E8
1091+ A3E8                  ; Set field direction to SOUTH
1092+ A3E8 3E 00            LD   A,FIELD_SOUTH_SIDE
1093+ A3EA 32 46 86         LD   (Var_Game_ActiveFieldSide),A
1094+ A3ED
1095+ A3ED                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1096+ A3ED
1097+ A3ED                  ; White GK, ID=0, Y=4, X=2
1098+ A3ED 06 01            LD   B,TEAM_WHITE
1099+ A3EF 0E 00            LD   C,0
1100+ A3F1 16 04            LD   D,4
1101+ A3F3 1E 02            LD   E,2
1102+ A3F5 CD 9D A2         CALL SetPlayerInfo
1103+ A3F8
1104+ A3F8                  ; White DEF 1, ID=1, Y=3, X=1
1105+ A3F8 06 01            LD   B,TEAM_WHITE
1106+ A3FA 0E 01            LD   C,1
1107+ A3FC 16 03            LD   D,3
1108+ A3FE 1E 01            LD   E,1
1109+ A400 CD 9D A2         CALL SetPlayerInfo
1110+ A403
1111+ A403                  ; White DEF 2, ID=2, Y=3, X=3
1112+ A403 06 01            LD   B,TEAM_WHITE
1113+ A405 0E 02            LD   C,2
1114+ A407 16 03            LD   D,3
1115+ A409 1E 03            LD   E,3
1116+ A40B CD 9D A2         CALL SetPlayerInfo
1117+ A40E
1118+ A40E                  ; White MID, ID=3, Y=1, X=0
1119+ A40E 06 01            LD   B,TEAM_WHITE
1120+ A410 0E 03            LD   C,3
1121+ A412 16 01            LD   D,1
1122+ A414 1E 00            LD   E,0
1123+ A416 CD 9D A2         CALL SetPlayerInfo
1124+ A419
1125+ A419                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1126+ A419
1127+ A419                  ; Black GK hidden, ID=0, Y=255, X=2
1128+ A419 06 00            LD   B,TEAM_BLACK
1129+ A41B 0E 00            LD   C,0
1130+ A41D 16 FF            LD   D,255
1131+ A41F 1E 02            LD   E,2
1132+ A421 CD 9D A2         CALL SetPlayerInfo
1133+ A424
1134+ A424                  ; Black MID 1, ID=1, Y=0, X=1
1135+ A424 06 00            LD   B,TEAM_BLACK
1136+ A426 0E 01            LD   C,1
1137+ A428 16 00            LD   D,0
1138+ A42A 1E 01            LD   E,1
1139+ A42C CD 9D A2         CALL SetPlayerInfo
1140+ A42F
1141+ A42F                  ; Black MID 2, ID=2, Y=0, X=2
1142+ A42F 06 00            LD   B,TEAM_BLACK
1143+ A431 0E 02            LD   C,2
1144+ A433 16 00            LD   D,0
1145+ A435 1E 02            LD   E,2
1146+ A437 CD 9D A2         CALL SetPlayerInfo
1147+ A43A
1148+ A43A                  ; Black MID 3, ID=3, Y=0, X=3
1149+ A43A 06 00            LD   B,TEAM_BLACK
1150+ A43C 0E 03            LD   C,3
1151+ A43E 16 00            LD   D,0
1152+ A440 1E 03            LD   E,3
1153+ A442 CD 9D A2         CALL SetPlayerInfo
1154+ A445
1155+ A445                  ; ---- VIRTUAL PLAYER ------------------------------------------
1156+ A445
1157+ A445 3E 01            LD   A,TEAM_WHITE
1158+ A447 32 6A 86         LD   (Var_Game_VirtualPlayerTeam),A
1159+ A44A
1160+ A44A 3E 01            LD   A,1
1161+ A44C 32 68 86         LD   (Var_Game_VirtualPlayerYPos),A   ; Y=1
1162+ A44F 3E 04            LD   A,4
1163+ A451 32 69 86         LD   (Var_Game_VirtualPlayerXPos),A   ; X=4
1164+ A454
1165+ A454                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1166+ A454 CD 2D A3         CALL ClearAllPrevPositions
1167+ A457
1168+ A457 C9               RET
1169+ A458
1170+ A458              ; ---------------------------------------------------------------------------
1171+ A458              ; Sets restart-from-goal schema when BLACK team is defending and the
1172+ A458              ; active field side is NORTH.
1173+ A458              ;
1174+ A458              ; Player layout (Y=row, X=col):
1175+ A458              ;   - Black GK:        Y=0, X=2
1176+ A458              ;   - Black DEF:       Y=1, X=1 / X=2 / X=3
1177+ A458              ;   - White FWD:       Y=2, X=0 and Y=2, X=4
1178+ A458              ;   - White MID:       Y=4, X=3
1179+ A458              ;   - White GK:        Y=255 (hidden), X=2
1180+ A458              ;
1181+ A458              ; Virtual player:
1182+ A458              ;   Var_Game_VirtualPlayerTeam = TEAM_WHITE
1183+ A458              ;   Var_Game_VirtualPlayerYPos = 4
1184+ A458              ;   Var_Game_VirtualPlayerXPos = 1
1185+ A458              ;
1186+ A458              ; INPUT:
1187+ A458              ;   -
1188+ A458              ; OUTPUT:
1189+ A458              ;   Var_Game_ActiveFieldSide updated to FIELD_NORTH_SIDE
1190+ A458              ;   Var_Game_PlayersInfo filled for this schema
1191+ A458              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1192+ A458              ; MODIFIES:
1193+ A458              ;   AF, BC, DE, HL
1194+ A458              ; ---------------------------------------------------------------------------
1195+ A458              SetBlackRestartSchema:
1196+ A458 3E 00            LD   A, TEAM_BLACK
1197+ A45A 32 64 86         LD   (Var_Game_TeamWithBall), A
1198+ A45D
1199+ A45D 16 00            LD     D, 0
1200+ A45F 1E 02            LD     E, 2
1201+ A461 CD 08 A2         CALL   Game_SetBallPosition
1202+ A464 3E FF            LD     A, 255
1203+ A466 32 74 86         LD     (Var_Game_BallYOldPosition ), A
1204+ A469 3E 00            LD     A, BALL_DIRECTION_NONE
1205+ A46B 32 66 86         LD     (Var_Game_BallDirection),A
1206+ A46E
1207+ A46E                  ; Set active field side to NORTH
1208+ A46E 3E 01            LD   A,FIELD_NORTH_SIDE
1209+ A470 32 46 86         LD   (Var_Game_ActiveFieldSide),A
1210+ A473
1211+ A473 3E 01            LD   A, YES
1212+ A475 32 65 86         LD   (Var_Game_GoalkeeperHasBall), A
1213+ A478
1214+ A478                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1215+ A478
1216+ A478                  ; Black GK, ID=0, Y=0, X=2
1217+ A478 06 00            LD   B,TEAM_BLACK
1218+ A47A 0E 00            LD   C,0                  ; ID=0 (goalkeeper)
1219+ A47C 16 00            LD   D,0                  ; Y
1220+ A47E 1E 02            LD   E,2                  ; X
1221+ A480 CD 9D A2         CALL SetPlayerInfo
1222+ A483
1223+ A483                  ; Black DEF 1, ID=1, Y=1, X=1
1224+ A483 06 00            LD   B,TEAM_BLACK
1225+ A485 0E 01            LD   C,1
1226+ A487 16 01            LD   D,1
1227+ A489 1E 01            LD   E,1
1228+ A48B CD 9D A2         CALL SetPlayerInfo
1229+ A48E
1230+ A48E                  ; Black DEF 2, ID=2, Y=1, X=2
1231+ A48E 06 00            LD   B,TEAM_BLACK
1232+ A490 0E 02            LD   C,2
1233+ A492 16 01            LD   D,1
1234+ A494 1E 02            LD   E,2
1235+ A496 CD 9D A2         CALL SetPlayerInfo
1236+ A499
1237+ A499                  ; Black DEF 3, ID=3, Y=1, X=3
1238+ A499 06 00            LD   B,TEAM_BLACK
1239+ A49B 0E 03            LD   C,3
1240+ A49D 16 01            LD   D,1
1241+ A49F 1E 03            LD   E,3
1242+ A4A1 CD 9D A2         CALL SetPlayerInfo
1243+ A4A4
1244+ A4A4                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1245+ A4A4
1246+ A4A4                  ; White GK hidden, ID=0, Y=255, X=2
1247+ A4A4 06 01            LD   B,TEAM_WHITE
1248+ A4A6 0E 00            LD   C,0
1249+ A4A8 16 FF            LD   D,255
1250+ A4AA 1E 02            LD   E,2
1251+ A4AC CD 9D A2         CALL SetPlayerInfo
1252+ A4AF
1253+ A4AF                  ; White FWD 1, ID=1, Y=2, X=0
1254+ A4AF 06 01            LD   B,TEAM_WHITE
1255+ A4B1 0E 01            LD   C,1
1256+ A4B3 16 02            LD   D,2
1257+ A4B5 1E 00            LD   E,0
1258+ A4B7 CD 9D A2         CALL SetPlayerInfo
1259+ A4BA
1260+ A4BA                  ; White FWD 2, ID=2, Y=2, X=4
1261+ A4BA 06 01            LD   B,TEAM_WHITE
1262+ A4BC 0E 02            LD   C,2
1263+ A4BE 16 02            LD   D,2
1264+ A4C0 1E 04            LD   E,4
1265+ A4C2 CD 9D A2         CALL SetPlayerInfo
1266+ A4C5
1267+ A4C5                  ; White MID, ID=3, Y=4, X=3
1268+ A4C5 06 01            LD   B,TEAM_WHITE
1269+ A4C7 0E 03            LD   C,3
1270+ A4C9 16 04            LD   D,4
1271+ A4CB 1E 03            LD   E,3
1272+ A4CD CD 9D A2         CALL SetPlayerInfo
1273+ A4D0
1274+ A4D0                  ; ---- VIRTUAL PLAYER ------------------------------------------
1275+ A4D0
1276+ A4D0 3E 01            LD   A,TEAM_WHITE
1277+ A4D2 32 6A 86         LD   (Var_Game_VirtualPlayerTeam),A
1278+ A4D5
1279+ A4D5 3E 04            LD   A,4
1280+ A4D7 32 68 86         LD   (Var_Game_VirtualPlayerYPos),A   ; Y=4
1281+ A4DA 3E 01            LD   A,1
1282+ A4DC 32 69 86         LD   (Var_Game_VirtualPlayerXPos),A   ; X=1
1283+ A4DF
1284+ A4DF                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1285+ A4DF CD 2D A3         CALL ClearAllPrevPositions
1286+ A4E2
1287+ A4E2 C9               RET
1288+ A4E3
1289+ A4E3              ; ---------------------------------------------------------------------------
1290+ A4E3              ; Sets restart-from-goal schema when WHITE team is defending and the
1291+ A4E3              ; active field side is SOUTH.
1292+ A4E3              ;
1293+ A4E3              ; Player layout (Y=row, X=col):
1294+ A4E3              ;   - White GK:        Y=4, X=2
1295+ A4E3              ;   - White DEF:       Y=3, X=1 / X=2 / X=3
1296+ A4E3              ;   - Black FWD:       Y=2, X=0 and Y=2, X=4
1297+ A4E3              ;   - Black MID:       Y=0, X=4
1298+ A4E3              ;   - Black GK:        Y=255 (hidden), X=2
1299+ A4E3              ;
1300+ A4E3              ; Virtual player:
1301+ A4E3              ;   Var_Game_VirtualPlayerTeam = TEAM_BLACK
1302+ A4E3              ;   Var_Game_VirtualPlayerYPos = 0
1303+ A4E3              ;   Var_Game_VirtualPlayerXPos = 0
1304+ A4E3              ;
1305+ A4E3              ; INPUT:
1306+ A4E3              ;   -
1307+ A4E3              ; OUTPUT:
1308+ A4E3              ;   Var_Game_ActiveFieldSide updated to FIELD_SOUTH_SIDE
1309+ A4E3              ;   Var_Game_PlayersInfo filled for this schema
1310+ A4E3              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1311+ A4E3              ; MODIFIES:
1312+ A4E3              ;   AF, BC, DE, HL
1313+ A4E3              ; ---------------------------------------------------------------------------
1314+ A4E3              SetWhiteRestartSchema:
1315+ A4E3 3E 01            LD   A, TEAM_WHITE
1316+ A4E5 32 64 86         LD   (Var_Game_TeamWithBall), A
1317+ A4E8 16 04            LD     D, 4
1318+ A4EA 1E 02            LD     E, 2
1319+ A4EC CD 08 A2         CALL   Game_SetBallPosition
1320+ A4EF 3E FF            LD     A, 255
1321+ A4F1 32 74 86         LD     (Var_Game_BallYOldPosition ), A
1322+ A4F4 3E 00            LD   A, BALL_DIRECTION_NONE
1323+ A4F6 32 66 86         LD   (Var_Game_BallDirection),A
1324+ A4F9
1325+ A4F9                  ; Set active field side to SOUTH
1326+ A4F9 3E 00            LD   A,FIELD_SOUTH_SIDE
1327+ A4FB 32 46 86         LD   (Var_Game_ActiveFieldSide),A
1328+ A4FE
1329+ A4FE 3E 01            LD   A, YES
1330+ A500 32 65 86         LD   (Var_Game_GoalkeeperHasBall), A
1331+ A503
1332+ A503                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1333+ A503
1334+ A503                  ; White GK, ID=0, Y=4, X=2
1335+ A503 06 01            LD   B,TEAM_WHITE
1336+ A505 0E 00            LD   C,0
1337+ A507 16 04            LD   D,4
1338+ A509 1E 02            LD   E,2
1339+ A50B CD 9D A2         CALL SetPlayerInfo
1340+ A50E
1341+ A50E                  ; White DEF 1, ID=1, Y=3, X=1
1342+ A50E 06 01            LD   B,TEAM_WHITE
1343+ A510 0E 01            LD   C,1
1344+ A512 16 03            LD   D,3
1345+ A514 1E 01            LD   E,1
1346+ A516 CD 9D A2         CALL SetPlayerInfo
1347+ A519
1348+ A519                  ; White DEF 2, ID=2, Y=3, X=2
1349+ A519 06 01            LD   B,TEAM_WHITE
1350+ A51B 0E 02            LD   C,2
1351+ A51D 16 03            LD   D,3
1352+ A51F 1E 02            LD   E,2
1353+ A521 CD 9D A2         CALL SetPlayerInfo
1354+ A524
1355+ A524                  ; White DEF 3, ID=3, Y=3, X=3
1356+ A524 06 01            LD   B,TEAM_WHITE
1357+ A526 0E 03            LD   C,3
1358+ A528 16 03            LD   D,3
1359+ A52A 1E 03            LD   E,3
1360+ A52C CD 9D A2         CALL SetPlayerInfo
1361+ A52F
1362+ A52F                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1363+ A52F
1364+ A52F                  ; Black GK hidden, ID=0, Y=255, X=2
1365+ A52F 06 00            LD   B,TEAM_BLACK
1366+ A531 0E 00            LD   C,0
1367+ A533 16 FF            LD   D,255
1368+ A535 1E 02            LD   E,2
1369+ A537 CD 9D A2         CALL SetPlayerInfo
1370+ A53A
1371+ A53A                  ; Black FWD 1, ID=1, Y=2, X=0
1372+ A53A 06 00            LD   B,TEAM_BLACK
1373+ A53C 0E 01            LD   C,1
1374+ A53E 16 02            LD   D,2
1375+ A540 1E 00            LD   E,0
1376+ A542 CD 9D A2         CALL SetPlayerInfo
1377+ A545
1378+ A545                  ; Black FWD 2, ID=2, Y=2, X=4
1379+ A545 06 00            LD   B,TEAM_BLACK
1380+ A547 0E 02            LD   C,2
1381+ A549 16 02            LD   D,2
1382+ A54B 1E 04            LD   E,4
1383+ A54D CD 9D A2         CALL SetPlayerInfo
1384+ A550
1385+ A550                  ; Black MID, ID=3, Y=0, X=4
1386+ A550 06 00            LD   B,TEAM_BLACK
1387+ A552 0E 03            LD   C,3
1388+ A554 16 00            LD   D,0
1389+ A556 1E 03            LD   E,3
1390+ A558 CD 9D A2         CALL SetPlayerInfo
1391+ A55B
1392+ A55B                  ; ---- VIRTUAL PLAYER ------------------------------------------
1393+ A55B
1394+ A55B 3E 00            LD   A,TEAM_BLACK
1395+ A55D 32 6A 86         LD   (Var_Game_VirtualPlayerTeam),A
1396+ A560
1397+ A560 AF               XOR  A
1398+ A561 32 68 86         LD   (Var_Game_VirtualPlayerYPos),A
1399+ A564 3E 01            LD   A, 1
1400+ A566 32 69 86         LD   (Var_Game_VirtualPlayerXPos),A
1401+ A569
1402+ A569                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1403+ A569 CD 2D A3         CALL ClearAllPrevPositions
1404+ A56C
1405+ A56C C9               RET
1406+ A56D
1407+ A56D
1408+ A56D
1409+ A56D              ; ---------------------------------------------------------------------------
1410+ A56D              ; ResumeGame
1411+ A56D              ;
1412+ A56D              ; Decide il tipo di ripresa in base a:
1413+ A56D              ;   - Var_Game_ActiveFieldSide
1414+ A56D              ;   - posizione Y della palla
1415+ A56D              ;
1416+ A56D              ; Casi:
1417+ A56D              ;   - Campo NORTH, BallY = 1 -> rimessa dal fondo NERA
1418+ A56D              ;   - Campo SOUTH, BallY = 2 -> rimessa dal fondo BIANCA
1419+ A56D              ;   - Campo SOUTH, BallY = 0 -> calcio d'inizio NERO
1420+ A56D              ;   - Campo NORTH, BallY = 3 -> calcio d'inizio BIANCO
1421+ A56D              ;
1422+ A56D              ; In tutti i casi:
1423+ A56D              ;   - sposta palla e giocatore centrale secondo le regole descritte
1424+ A56D              ;   - Var_Game_VirtualPlayerYPos = 255 (virtual sparisce)
1425+ A56D              ;   - Var_Game_BallDirection = BALL_DIRECTION_NONE
1426+ A56D              ;   - Var_Game_GoalkeeperHasBall = NO
1427+ A56D              ;   - chiama VDP_PlayerMatrixRedraw
1428+ A56D              ;
1429+ A56D              ; MODIFICA: AF, BC, DE, HL
1430+ A56D              ; ---------------------------------------------------------------------------
1431+ A56D              Game_Resume:
1432+ A56D F5               push af
1433+ A56E C5               push bc
1434+ A56F D5               push de
1435+ A570 E5               push hl
1436+ A571
1437+ A571                  ; ---- palla ferma e nessun portiere con palla ----
1438+ A571 3E 00            ld   a,BALL_DIRECTION_NONE
1439+ A573 32 66 86         ld   (Var_Game_BallDirection),a
1440+ A576
1441+ A576 3E 00            ld   a,NO
1442+ A578 32 65 86         ld   (Var_Game_GoalkeeperHasBall),a
1443+ A57B
1444+ A57B                  ; ---- nascondi virtual player ----
1445+ A57B                  ;ld   a,255
1446+ A57B                  ;ld   (Var_Game_VirtualPlayerYPos),a
1447+ A57B
1448+ A57B                  ; ---- leggi posizione palla ----
1449+ A57B CD FD A1         call Game_GetBallPosition
1450+ A57E                  ; salviamo Y in C per i confronti
1451+ A57E 4A               ld   c,d                   ; C = Y
1452+ A57F
1453+ A57F                  ; ---- leggi direzione campo ----
1454+ A57F 3A 46 86         ld   a,(Var_Game_ActiveFieldSide)
1455+ A582 FE 01            cp   FIELD_NORTH_SIDE
1456+ A584 28 0B            jr   z,.field_north
1457+ A586
1458+ A586                  ; ===== FIELD_SOUTH_SIDE =====
1459+ A586              .field_south:
1460+ A586 79               ld   a,c                   ; A = BallY
1461+ A587 FE 04            cp   4
1462+ A589 28 11            jr   z,.white_goal_kick    ; rimessa dal fondo BIANCA
1463+ A58B
1464+ A58B FE 00            cp   0
1465+ A58D 28 17            jr   z,.black_kickoff      ; calcio d'inizio NERO
1466+ A58F
1467+ A58F 18 23            jr   .resume_done          ; nessun caso riconosciuto
1468+ A591
1469+ A591                  ; ===== FIELD_NORTH_SIDE =====
1470+ A591              .field_north:
1471+ A591 79               ld   a,c                   ; A = BallY
1472+ A592 FE 00            cp   0
1473+ A594 28 0B            jr   z,.black_goal_kick    ; rimessa dal fondo NERA
1474+ A596
1475+ A596 FE 03            cp   3
1476+ A598 28 11            jr   z,.white_kickoff      ; calcio d'inizio BIANCO
1477+ A59A
1478+ A59A 18 18            jr   .resume_done          ; nessun caso riconosciuto
1479+ A59C
1480+ A59C              ; --- Rimessa dal fondo BIANCA (campo SOUTH, ballY = 2) ---
1481+ A59C              .white_goal_kick:
1482+ A59C CD B9 A5         call Resume_WhiteGoalKick
1483+ A59F 18 0D            jr   .after_case
1484+ A5A1
1485+ A5A1              ; --- Rimessa dal fondo NERA (campo NORTH, ballY = 1) ---
1486+ A5A1              .black_goal_kick:
1487+ A5A1 CD 06 A6         call Resume_BlackGoalKick
1488+ A5A4 18 08            jr   .after_case
1489+ A5A6
1490+ A5A6              ; --- Calcio d'inizio NERO (campo SOUTH, ballY = 0) ---
1491+ A5A6              .black_kickoff:
1492+ A5A6 CD 53 A6         call Resume_BlackKickoff
1493+ A5A9 18 03            jr   .after_case
1494+ A5AB
1495+ A5AB              ; --- Calcio d'inizio BIANCO (campo NORTH, ballY = 3) ---
1496+ A5AB              .white_kickoff:
1497+ A5AB CD 96 A6         call Resume_WhiteKickoff
1498+ A5AE                  ; fall-through
1499+ A5AE
1500+ A5AE              .after_case:
1501+ A5AE CD C6 9A         CALL  VDP_RemoveVirtualPlayer
1502+ A5B1                  ; ridisegna i giocatori (la palla verrà ridisegnata nella nuova posizione)
1503+ A5B1 CD 15 9B         call VDP_PlayerMatrixRedraw
1504+ A5B4
1505+ A5B4              .resume_done:
1506+ A5B4 E1               pop  hl
1507+ A5B5 D1               pop  de
1508+ A5B6 C1               pop  bc
1509+ A5B7 F1               pop  af
1510+ A5B8                  ;call Hooks_TickStart
1511+ A5B8 C9               ret
1512+ A5B9
1513+ A5B9              ; ---------------------------------------------------------------------------
1514+ A5B9              ; Resume_WhiteGoalKick
1515+ A5B9              ;
1516+ A5B9              ; Schema atteso:
1517+ A5B9              ;   - Palla:    Y=2, X=2
1518+ A5B9              ;   - Bianchi:  Y=3, X=1,2,3   (centrale a 3,2)
1519+ A5B9              ;
1520+ A5B9              ; Azioni:
1521+ A5B9              ;   - Palla -> (Y=2, X=1 o 3 a caso)
1522+ A5B9              ;   - Giocatore centrale -> Y=1, X=random(0..4)
1523+ A5B9              ; ---------------------------------------------------------------------------
1524+ A5B9              Resume_WhiteGoalKick:
1525+ A5B9 AF               XOR  A
1526+ A5BA 32 71 86         LD   (Var_Game_FirstKickFrameCounter), A
1527+ A5BD 3E 03            LD   A, FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
1528+ A5BF 32 70 86         LD   (Var_Game_FirstKickType), A
1529+ A5C2 16 02            LD   D, 2
1530+ A5C4 1E 02            LD   E, 2
1531+ A5C6 CD 08 A2         CALL Game_SetBallPosition
1532+ A5C9 CD 15 9B         CALL VDP_PlayerMatrixRedraw
1533+ A5CC C9               RET
1534+ A5CD              .exec:
1535+ A5CD                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=2) ---
1536+ A5CD CD D9 A6         call Game_GetRandomByte
1537+ A5D0 E6 01            and  1
1538+ A5D2 2E 01            ld   l,1                ; default X = 1
1539+ A5D4 28 02            jr   z,.ball_pos_ok
1540+ A5D6 2E 03            ld   l,3                ; X = 3
1541+ A5D8              .ball_pos_ok:
1542+ A5D8 26 02            ld   h,2                ; Y = 2
1543+ A5DA E5               PUSH HL
1544+ A5DB D1               POP  DE
1545+ A5DC CD 08 A2         call Game_SetBallPosition
1546+ A5DF
1547+ A5DF                  ; --- trova il giocatore centrale bianco (Y=3, X=2) ---
1548+ A5DF 16 03            ld   d,3                ; Y=3
1549+ A5E1 1E 02            ld   e,2                ; X=2
1550+ A5E3 CD DF A2         call Game_GetPlayerInfoByPos
1551+ A5E6 FE FF            cp   NO_VALUE
1552+ A5E8 C8               ret  z                  ; se non trovato, esci senza fare altro
1553+ A5E9
1554+ A5E9                  ; qui: B = TEAM, C = ID del giocatore centrale
1555+ A5E9
1556+ A5E9                  ; --- genera nuova X (0..4) e sposta a Y=1 ---
1557+ A5E9 CD DF A6         call Game_GetRandom0_4  ; A = 0..4
1558+ A5EC 5F               ld   e,a                ; E = newX
1559+ A5ED 16 01            ld   d,1                ; D = newY (1)
1560+ A5EF CD 9D A2         call SetPlayerInfo
1561+ A5F2 3E 01            LD   A, YES
1562+ A5F4 32 C0 86         LD   (Var_Hooks_ForceVdpRedraw), A
1563+ A5F7 3E FF            LD   A, NO_VALUE
1564+ A5F9 32 70 86         LD   (Var_Game_FirstKickType), A
1565+ A5FC CD EF 86         CALL Hooks_TickStart
1566+ A5FF CD 54 B4         call Game_PlayBeep
1567+ A602 C3 C7 87         JP   VBlankISR.Exit
1568+ A605 C9           	ret
1569+ A606              ; ---------------------------------------------------------------------------
1570+ A606              ; Resume_BlackGoalKick
1571+ A606              ;
1572+ A606              ; Schema atteso:
1573+ A606              ;   - Palla:   Y=1, X=2
1574+ A606              ;   - Neri:    Y=1, X=1,2,3   (centrale a 1,2)
1575+ A606              ;
1576+ A606              ; Azioni:
1577+ A606              ;   - Palla -> (Y=1, X=1 o 3 a caso)
1578+ A606              ;   - Giocatore centrale -> Y=3, X=random(0..4)
1579+ A606              ; ---------------------------------------------------------------------------
1580+ A606              Resume_BlackGoalKick:
1581+ A606 AF               XOR  A
1582+ A607 32 71 86         LD   (Var_Game_FirstKickFrameCounter), A
1583+ A60A 3E 04            LD   A, FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
1584+ A60C 32 70 86         LD   (Var_Game_FirstKickType), A
1585+ A60F 16 01            LD   D, 1
1586+ A611 1E 02            LD   E, 2
1587+ A613 CD 08 A2         CALL Game_SetBallPosition
1588+ A616 CD 15 9B         CALL VDP_PlayerMatrixRedraw
1589+ A619 C9               ret
1590+ A61A              .exec:
1591+ A61A                      ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=1) ---
1592+ A61A CD D9 A6         call Game_GetRandomByte
1593+ A61D E6 01            and  1
1594+ A61F 2E 01            ld   l,1                ; default X = 1
1595+ A621 28 02            jr   z,.ball_pos_ok
1596+ A623 2E 03            ld   l,3                ; X = 3
1597+ A625              .ball_pos_ok:
1598+ A625 26 01            ld   h,1                ; Y = 1
1599+ A627 E5               PUSH HL
1600+ A628 D1               POP  DE
1601+ A629 CD 08 A2         call Game_SetBallPosition
1602+ A62C
1603+ A62C                  ; --- trova il giocatore centrale nero (Y=1, X=2) ---
1604+ A62C 16 01            ld   d,1                ; Y=1
1605+ A62E 1E 02            ld   e,2                ; X=2
1606+ A630 CD DF A2         call Game_GetPlayerInfoByPos
1607+ A633 FE FF            cp   NO_VALUE
1608+ A635 C8               ret  z
1609+ A636
1610+ A636                  ; B = TEAM, C = ID del centrale
1611+ A636
1612+ A636                  ; --- genera nuova X (0..4) e sposta a Y=3 ---
1613+ A636 CD DF A6         call Game_GetRandom0_4
1614+ A639 5F               ld   e,a                ; newX
1615+ A63A 16 03            ld   d,3                ; newY = 3
1616+ A63C CD 9D A2         call SetPlayerInfo
1617+ A63F 3E 01            LD   A, YES
1618+ A641 32 C0 86         LD   (Var_Hooks_ForceVdpRedraw), A
1619+ A644 3E FF            LD   A, NO_VALUE
1620+ A646 32 70 86         LD   (Var_Game_FirstKickType), A
1621+ A649 CD EF 86         CALL Hooks_TickStart
1622+ A64C CD 54 B4         call Game_PlayBeep
1623+ A64F C3 C7 87         JP   VBlankISR.Exit
1624+ A652 C9               ret
1625+ A653              ; ---------------------------------------------------------------------------
1626+ A653              ; Resume_BlackKickoff
1627+ A653              ;
1628+ A653              ; Schema atteso:
1629+ A653              ;   - Palla:   Y=0, X=2
1630+ A653              ;   - Neri:    Y=0, X=1,2,3   (centrale a 0,2)
1631+ A653              ;
1632+ A653              ; Azioni:
1633+ A653              ;   - Palla -> (Y=0, X=1 o 3 a caso)
1634+ A653              ;   - Giocatore centrale -> Y=2, X=random(0..4)
1635+ A653              ; ---------------------------------------------------------------------------
1636+ A653              Resume_BlackKickoff:
1637+ A653 AF               XOR  A
1638+ A654 32 71 86         LD   (Var_Game_FirstKickFrameCounter), A
1639+ A657 3E 02            LD   A, FIRST_KICK_TYPE_BLACK_HALF_FIELD
1640+ A659 32 70 86         LD   (Var_Game_FirstKickType), A
1641+ A65C C9               RET
1642+ A65D              .exec:
1643+ A65D                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=0) ---
1644+ A65D CD D9 A6         call Game_GetRandomByte
1645+ A660 E6 01            and  1
1646+ A662 2E 01            ld   l,1                ; default X = 1
1647+ A664 28 02            jr   z,.ball_pos_ok
1648+ A666 2E 03            ld   l,3                ; X = 3
1649+ A668              .ball_pos_ok:
1650+ A668 26 00            ld   h,0                ; Y = 0
1651+ A66A E5               PUSH HL
1652+ A66B D1               POP  DE
1653+ A66C CD 08 A2         call Game_SetBallPosition
1654+ A66F
1655+ A66F                  ; --- trova il giocatore centrale nero (Y=0, X=2) ---
1656+ A66F 16 00            ld   d,0                ; Y=0
1657+ A671 1E 02            ld   e,2                ; X=2
1658+ A673 CD DF A2         call Game_GetPlayerInfoByPos
1659+ A676 FE FF            cp   NO_VALUE
1660+ A678 C8               ret  z
1661+ A679
1662+ A679                  ; B = TEAM, C = ID
1663+ A679
1664+ A679                  ; --- genera nuova X (0..4) e sposta a Y=2 ---
1665+ A679 CD DF A6         call Game_GetRandom0_4
1666+ A67C 5F               ld   e,a                ; newX
1667+ A67D 16 02            ld   d,2                ; newY = 2
1668+ A67F CD 9D A2         call SetPlayerInfo
1669+ A682 3E 01            LD   A, YES
1670+ A684 32 C0 86         LD   (Var_Hooks_ForceVdpRedraw), A
1671+ A687 3E FF            LD   A, NO_VALUE
1672+ A689 32 70 86         LD   (Var_Game_FirstKickType), A
1673+ A68C CD EF 86         CALL Hooks_TickStart
1674+ A68F CD 54 B4         call Game_PlayBeep
1675+ A692 C3 C7 87         JP   VBlankISR.Exit
1676+ A695 C9               ret
1677+ A696              ; ---------------------------------------------------------------------------
1678+ A696              ; Resume_WhiteKickoff
1679+ A696              ;
1680+ A696              ; Schema atteso:
1681+ A696              ;   - Palla:   Y=3, X=2
1682+ A696              ;   - Bianchi: Y=4, X=1,2,3   (centrale a 4,2)
1683+ A696              ;
1684+ A696              ; Azioni:
1685+ A696              ;   - Palla -> (Y=3, X=1 o 3 a caso)
1686+ A696              ;   - Giocatore centrale -> Y=2, X=random(0..4)
1687+ A696              ; ---------------------------------------------------------------------------
1688+ A696              Resume_WhiteKickoff:
1689+ A696 AF               XOR  A
1690+ A697 32 71 86         LD   (Var_Game_FirstKickFrameCounter), A
1691+ A69A 3E 01            LD   A, FIRST_KICK_TYPE_WHITE_HALF_FIELD
1692+ A69C 32 70 86         LD   (Var_Game_FirstKickType), A
1693+ A69F C9               RET
1694+ A6A0              .exec:
1695+ A6A0                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=3) ---
1696+ A6A0 CD D9 A6         call Game_GetRandomByte
1697+ A6A3 E6 01            and  1
1698+ A6A5 2E 01            ld   l,1                ; default X = 1
1699+ A6A7 28 02            jr   z,.ball_pos_ok
1700+ A6A9 2E 03            ld   l,3                ; X = 3
1701+ A6AB              .ball_pos_ok:
1702+ A6AB 26 03            ld   h,3                ; Y = 3
1703+ A6AD E5               PUSH HL
1704+ A6AE D1               POP  DE
1705+ A6AF CD 08 A2         call Game_SetBallPosition
1706+ A6B2
1707+ A6B2                  ; --- trova il giocatore centrale bianco (Y=4, X=2) ---
1708+ A6B2 16 04            ld   d,4                ; Y=4
1709+ A6B4 1E 02            ld   e,2                ; X=2
1710+ A6B6 CD DF A2         call Game_GetPlayerInfoByPos
1711+ A6B9 FE FF            cp   NO_VALUE
1712+ A6BB C8               ret  z
1713+ A6BC
1714+ A6BC                  ; B = TEAM, C = ID
1715+ A6BC
1716+ A6BC                  ; --- genera nuova X (0..4) e sposta a Y=2 ---
1717+ A6BC CD DF A6         call Game_GetRandom0_4
1718+ A6BF 5F               ld   e,a                ; newX
1719+ A6C0 16 02            ld   d,2                ; newY = 2
1720+ A6C2 CD 9D A2         call SetPlayerInfo
1721+ A6C5 3E 01            LD   A, YES
1722+ A6C7 32 C0 86         LD   (Var_Hooks_ForceVdpRedraw), A
1723+ A6CA 3E FF            LD   A, NO_VALUE
1724+ A6CC 32 70 86         LD   (Var_Game_FirstKickType), A
1725+ A6CF CD EF 86         CALL Hooks_TickStart
1726+ A6D2 CD 54 B4         call Game_PlayBeep
1727+ A6D5 C3 C7 87         JP   VBlankISR.Exit
1728+ A6D8 C9               ret
1729+ A6D9
1730+ A6D9              ; ---------------------------------------------------------------------------
1731+ A6D9              ; Game_GetRandomByte
1732+ A6D9              ; Restituisce 0..255 utilizzando Utils_GetRandomNumber (0..127)
1733+ A6D9              ; MODIFIES: AF, BC
1734+ A6D9              ; ---------------------------------------------------------------------------
1735+ A6D9              Game_GetRandomByte:
1736+ A6D9 CD E4 9F         CALL Utils_GetRandomNumber     ; A = 0..127
1737+ A6DC CB 27            SLA  A                         ; 0..254 (raddoppio)
1738+ A6DE C9               RET
1739+ A6DF              ; ---------------------------------------------------------------------------
1740+ A6DF              ; Game_GetRandom0_4
1741+ A6DF              ; Restituisce A = 0..4
1742+ A6DF              ; MODIFIES: AF
1743+ A6DF              ; ---------------------------------------------------------------------------
1744+ A6DF              Game_GetRandom0_4:
1745+ A6DF C5               PUSH BC
1746+ A6E0 D5               PUSH DE
1747+ A6E1 E5               PUSH HL
1748+ A6E2 CD E4 9F         CALL Utils_GetRandomNumber     ; A = 0..127
1749+ A6E5
1750+ A6E5                  ; riduci a 0..7 (modulo 8)
1751+ A6E5 E6 07            AND  00000111b                 ; 0..7
1752+ A6E7
1753+ A6E7 FE 05            CP   5
1754+ A6E9 38 02            JR   C,.ok                     ; 0..4 → ok
1755+ A6EB D6 05            SUB  5                         ; 5,6,7 → 0,1,2
1756+ A6ED              .ok:
1757+ A6ED E1               POP  HL
1758+ A6EE D1               POP  DE
1759+ A6EF C1               POP  BC
1760+ A6F0 C9               RET
1761+ A6F1
1762+ A6F1              ; ---------------------------------------------------------------------------
1763+ A6F1              ; Game_GetRandom0_20
1764+ A6F1              ; Restituisce A = 0..20
1765+ A6F1              ; Usa Utils_GetRandomNumber (0..127)
1766+ A6F1              ; MODIFIES: AF
1767+ A6F1              ; ---------------------------------------------------------------------------
1768+ A6F1              Game_GetRandom0_20:
1769+ A6F1 C5               PUSH BC
1770+ A6F2              .loop:
1771+ A6F2 CD E4 9F         CALL Utils_GetRandomNumber     ; A = 0..127
1772+ A6F5 FE 69            CP   105                       ; 105 = 21 * 5
1773+ A6F7 30 F9            JR   NC,.loop                  ; scarta 105..127
1774+ A6F9                  ; A = 0..104
1775+ A6F9 06 15            LD   B,21
1776+ A6FB                  ; A mod 21
1777+ A6FB              .mod:
1778+ A6FB 90               SUB  B
1779+ A6FC 30 FD            JR   NC,.mod
1780+ A6FE 80               ADD  B                         ; ripristina ultimo valido
1781+ A6FF C1               POP  BC
1782+ A700 C9               RET
1783+ A701
1784+ A701
1785+ A701
1786+ A701
1787+ A701
1788+ A701              ; ---------------------------------------------------------------------------
1789+ A701              ; Game_GetPlayerIdWithBall
1790+ A701              ;
1791+ A701              ; Determina chi possiede la palla (se qualcuno) a seconda della posizione
1792+ A701              ; della palla e dei giocatori.
1793+ A701              ;
1794+ A701              ; OUTPUT:
1795+ A701              ;   A = TEAM_BLACK / TEAM_WHITE
1796+ A701              ;       oppure BALL_STATUS_MOVING / BALL_STATUS_FREE / BALL_STATUS_CONTENDED
1797+ A701              ;   H = ID giocatore che possiede la palla (0..3) oppure 255 se nessuno
1798+ A701              ;   L = ID eventuale contendente (per ora sempre 255 nei casi definiti)
1799+ A701              ;
1800+ A701              ; MODIFIES:
1801+ A701              ;   AF, BC, DE, HL
1802+ A701              ; ---------------------------------------------------------------------------
1803+ A701              Game_GetPlayerIdWithBall:
1804+ A701                  ; default: nessuno
1805+ A701 26 FF            ld   h,255
1806+ A703 2E FF            ld   l,255
1807+ A705
1808+ A705                  ; --- 1) se la palla è in movimento, nessun possesso -------------------
1809+ A705 3A 66 86         ld   a,(Var_Game_BallDirection)
1810+ A708 FE 00            cp   BALL_DIRECTION_NONE
1811+ A70A 28 03            jr   z,.check_static
1812+ A70C 3E 64            ld   a,BALL_STATUS_MOVING
1813+ A70E C9               ret
1814+ A70F
1815+ A70F              .check_static:
1816+ A70F                  ; --- 2) HL = X,Y della palla -----------------------------------------
1817+ A70F CD FD A1         call  Game_GetBallPosition
1818+ A712 D5               PUSH  DE
1819+ A713 E1               POP   HL
1820+ A714                  ; azzera i flag temporanei
1821+ A714 AF               xor  a
1822+ A715 32 4B 86         ld   (Var_Game_BallTmp_FoundBelow),a
1823+ A718 32 4E 86         ld   (Var_Game_BallTmp_FoundAbove),a
1824+ A71B
1825+ A71B                  ; salviamo la posizione della palla
1826+ A71B E5               push hl                     ; [SP] = X,Y
1827+ A71C
1828+ A71C                  ; ============================================================
1829+ A71C                  ; Test 1: stessa cella della palla (giocatore nero, se presente)
1830+ A71C                  ; ============================================================
1831+ A71C                  ; D = Y, E = X
1832+ A71C 54               ld   d,h
1833+ A71D 5D               ld   e,l
1834+ A71E CD DF A2         call Game_GetPlayerInfoByPos
1835+ A721 FE FF            cp   NO_VALUE
1836+ A723 28 0D            jr   z,.no_player_below
1837+ A725
1838+ A725                  ; trovato giocatore "sotto" (in stessa cella della palla)
1839+ A725 3E 01            ld   a,1
1840+ A727 32 4B 86         ld   (Var_Game_BallTmp_FoundBelow),a
1841+ A72A 78               ld   a,b
1842+ A72B 32 50 86         ld   (Var_Game_BallTmp_TeamBelow),a
1843+ A72E 79               ld   a,c
1844+ A72F 32 51 86         ld   (Var_Game_BallTmp_IdBelow),a
1845+ A732
1846+ A732              .no_player_below:
1847+ A732
1848+ A732                  ; ============================================================
1849+ A732                  ; Test 2: riga successiva stessa colonna (giocatore bianco, se presente)
1850+ A732                  ; ============================================================
1851+ A732 E1               pop  hl                     ; HL = X,Y (ripristinato)
1852+ A733 E5               push hl                     ; lo risalviamo per sicurezza (anche se poi non lo useremo più)
1853+ A734
1854+ A734 7C               ld   a,h                    ; A = Y
1855+ A735 FE 04            cp   4
1856+ A737 28 17            jr   z,.no_player_above     ; se Y=4, non esiste Y+1 nel campo 0..4
1857+ A739
1858+ A739 3C               inc  a                      ; Y+1
1859+ A73A 57               ld   d,a                    ; D = Y+1
1860+ A73B 5D               ld   e,l                    ; E = X
1861+ A73C CD DF A2         call Game_GetPlayerInfoByPos
1862+ A73F FE FF            cp   NO_VALUE
1863+ A741 28 0D            jr   z,.no_player_above
1864+ A743
1865+ A743                  ; trovato giocatore "sopra" (in riga successiva)
1866+ A743 3E 01            ld   a,1
1867+ A745 32 4E 86         ld   (Var_Game_BallTmp_FoundAbove),a
1868+ A748 78               ld   a,b
1869+ A749 32 4F 86         ld   (Var_Game_BallTmp_TeamAbove),a
1870+ A74C 79               ld   a,c
1871+ A74D 32 52 86         ld   (Var_Game_BallTmp_IdAbove),a
1872+ A750
1873+ A750              .no_player_above:
1874+ A750 E1               pop  hl                     ; buttiamo via la copia di sicurezza
1875+ A751
1876+ A751                  ; ============================================================
1877+ A751                  ; 3) Valutazione combinazioni
1878+ A751                  ; ============================================================
1879+ A751
1880+ A751                  ; carichiamo flag in A/B solo per facilità
1881+ A751 3A 4B 86         ld   a,(Var_Game_BallTmp_FoundBelow)
1882+ A754 47               ld   b,a                     ; B = foundBelow (0/1)
1883+ A755 3A 4E 86         ld   a,(Var_Game_BallTmp_FoundAbove)
1884+ A758 4F               ld   c,a                     ; C = foundAbove (0/1)
1885+ A759
1886+ A759                  ; caso: nessuno dei due
1887+ A759 78               ld   a,b
1888+ A75A B1               or   c
1889+ A75B 20 07            jr   nz,.not_free
1890+ A75D
1891+ A75D                  ; nessun giocatore sotto né sopra
1892+ A75D 3E 66            ld   a,BALL_STATUS_FREE
1893+ A75F 26 FF            ld   h,255
1894+ A761 2E FF            ld   l,255
1895+ A763 C9               ret
1896+ A764
1897+ A764              .not_free:
1898+ A764                  ; caso: entrambi presenti → palla contesa
1899+ A764 78               ld   a,b                     ; A = foundBelow
1900+ A765 A1               and  c                       ; A = 1 solo se entrambi sono 1
1901+ A766 28 07            jr   z,.single_side
1902+ A768
1903+ A768                  ; palla contesa tra nero e bianco
1904+ A768 3E 65            ld   a,BALL_STATUS_CONTENDED
1905+ A76A 26 FF            ld   h,255
1906+ A76C 2E FF            ld   l,255
1907+ A76E C9               ret
1908+ A76F
1909+ A76F              .single_side:
1910+ A76F                  ; se qui: esattamente uno dei due è 1.
1911+ A76F
1912+ A76F                  ; se foundBelow = 1 (giocatore nella cella della palla) → nero
1913+ A76F 78               ld   a,b
1914+ A770 B7               or   a
1915+ A771 28 0A            jr   z,.only_above
1916+ A773
1917+ A773                  ; --- solo giocatore nella cella della palla (nero) --------------------
1918+ A773 3A 51 86         ld   a,(Var_Game_BallTmp_IdBelow)    ; ID
1919+ A776 67               ld   h,a
1920+ A777 3A 50 86         ld   a,(Var_Game_BallTmp_TeamBelow)  ; TEAM (tipicamente TEAM_BLACK)
1921+ A77A
1922+ A77A 2E FF            ld   l,255
1923+ A77C C9               ret
1924+ A77D
1925+ A77D              .only_above:
1926+ A77D                  ; --- solo giocatore nella riga successiva (bianco) --------------------
1927+ A77D 3A 52 86         ld   a,(Var_Game_BallTmp_IdAbove)    ; ID
1928+ A780 67               ld   h,a
1929+ A781 3A 4F 86         ld   a,(Var_Game_BallTmp_TeamAbove)  ; TEAM (tipicamente TEAM_WHITE)
1930+ A784
1931+ A784 2E FF            ld   l,255
1932+ A786 C9               ret
1933+ A787              ; ---------------------------------------------------------------------------
1934+ A787              ; Game_TryMovePlayerVertically
1935+ A787              ;
1936+ A787              ; INPUT:
1937+ A787              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
1938+ A787              ;   C = ID    (0..3)
1939+ A787              ;   A = direzione richiesta:
1940+ A787              ;       PLAYER_ASKED_DIRECTION_NORTH
1941+ A787              ;       PLAYER_ASKED_DIRECTION_SOUTH
1942+ A787              ;
1943+ A787              ; OUTPUT:
1944+ A787              ;   A = SUCCESS oppure FAILURE
1945+ A787              ;
1946+ A787              ; MODIFIES:
1947+ A787              ;   AF, BC, DE, HL
1948+ A787              ; ---------------------------------------------------------------------------
1949+ A787              Game_TryMovePlayerVertically:
1950+ A787                  ; Salva la direzione richiesta
1951+ A787 F5               push af              ; [SP] = dir
1952+ A788
1953+ A788
1954+ A788                  ; --- i portieri NON possono muoversi verticalmente ---
1955+ A788 79               ld   a,c
1956+ A789 B7               or   a
1957+ A78A C2 91 A7         jp   nz, .gtmv_not_goalkeeper
1958+ A78D
1959+ A78D                  ; ID=0 → portiere → FALLISCE
1960+ A78D F1               pop  af              ; rimuovi dir dallo stack
1961+ A78E 3E 00            ld   a,FAILURE
1962+ A790 C9               ret
1963+ A791
1964+ A791              .gtmv_not_goalkeeper:
1965+ A791                  ; --- verifica che il giocatore NON abbia la palla ---
1966+ A791 C5               push bc              ; salva TEAM/ID per il confronto
1967+ A792 CD 01 A7         call Game_GetPlayerIdWithBall
1968+ A795                  ; Risultato:
1969+ A795                  ;   A = stato/team (TEAM_BLACK/TEAM_WHITE o BALL_STATUS_xxx)
1970+ A795                  ;   H = ID del giocatore in possesso (o 255)
1971+ A795                  ;   L = ID contendente (o 255)
1972+ A795 C1               pop  bc              ; ripristina B=TEAM, C=ID del giocatore richiesto
1973+ A796 FE 65            CP   BALL_STATUS_CONTENDED
1974+ A798 20 04            JR   NZ, .no_contended_ball
1975+ A79A
1976+ A79A F1               pop  af              ; rimuovi dir dallo stack
1977+ A79B 3E 00            ld   a,FAILURE
1978+ A79D C9               ret
1979+ A79E
1980+ A79E              .no_contended_ball:
1981+ A79E                  ; Se A è TEAM_BLACK o TEAM_WHITE e (A==B e H==C) → ha la palla
1982+ A79E 57               ld   d,a             ; D = stato/team
1983+ A79F
1984+ A79F
1985+ A79F FE 00            cp   TEAM_BLACK
1986+ A7A1 CA A9 A7         jp   z, .gtmv_check_owner_team
1987+ A7A4 FE 01            cp   TEAM_WHITE
1988+ A7A6 C2 B6 A7         jp   nz, .gtmv_no_ball_owned   ; stato non è un team → nessuno in possesso
1989+ A7A9
1990+ A7A9              .gtmv_check_owner_team:
1991+ A7A9                  ; A = TEAM_BLACK o TEAM_WHITE, D = stesso valore
1992+ A7A9 B8               cp   b
1993+ A7AA C2 B6 A7         jp   nz, .gtmv_no_ball_owned   ; altra squadra
1994+ A7AD
1995+ A7AD                  ; stessa squadra, confronta ID
1996+ A7AD 7C               ld   a,h                       ; H = ID possessore
1997+ A7AE B9               cp   c
1998+ A7AF C2 B6 A7         jp   nz, .gtmv_no_ball_owned   ; non è il nostro giocatore
1999+ A7B2
2000+ A7B2                  ; --- il giocatore richiesto ha la palla → non può muoversi verticalmente ---
2001+ A7B2 F1               pop  af                        ; rimuovi dir dallo stack
2002+ A7B3 3E 00            ld   a,FAILURE
2003+ A7B5 C9               ret
2004+ A7B6
2005+ A7B6              .gtmv_no_ball_owned:
2006+ A7B6                  ; --- recupera posizione corrente del giocatore ---
2007+ A7B6 CD C4 A2         call Game_GetPlayerInfoById    ; HL = curr (H=Y, L=X)
2008+ A7B9
2009+ A7B9 E5               push hl
2010+ A7BA D1               pop de                        ; DE = curr (D=currY, E=currX)
2011+ A7BB CD 5A A9         CALL CheckBallAtPosition
2012+ A7BE FE 01            CP   YES
2013+ A7C0 CA 57 A9         jp   z, .gtmv_fail_pop        ; palla sulla posizione corrente
2014+ A7C3                  ; HL: H = currY, L = currX
2015+ A7C3 F1               pop  af                        ; A = direzione richiesta
2016+ A7C4 57               ld   d,a                       ; D = direzione
2017+ A7C5                  ; H = currY, L = currX, B = TEAM, C = ID
2018+ A7C5
2019+ A7C5                  ; --- controlla metà campo attiva ---
2020+ A7C5 3A 46 86         ld   a,(Var_Game_ActiveFieldSide)
2021+ A7C8 FE 01            cp   FIELD_NORTH_SIDE
2022+ A7CA CA 8B A8         jp   z, .gtmv_side_north
2023+ A7CD
2024+ A7CD                  ; --------- FIELD_SOUTH_SIDE ---------------------------------
2025+ A7CD              .gtmv_side_south:
2026+ A7CD 78               ld   a,b
2027+ A7CE FE 01            cp   TEAM_WHITE
2028+ A7D0 CA 2F A8         jp   z, .gtmv_south_white
2029+ A7D3
2030+ A7D3                  ; ----- TEAM_BLACK, FIELD_SOUTH_SIDE -----
2031+ A7D3 7A               ld   a,d                      ; direzione
2032+ A7D4 FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2033+ A7D6 CA E1 A7         jp   z, .gtmv_sb_move_up
2034+ A7D9 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2035+ A7DB CA 08 A8         jp   z, .gtmv_sb_move_down
2036+ A7DE C3 54 A9         jp   .gtmv_fail               ; direzione invalida
2037+ A7E1
2038+ A7E1              ; Nero, campo SOUTH, move NORTH:
2039+ A7E1              ; deve essere su riga 2, target riga 0
2040+ A7E1              .gtmv_sb_move_up:
2041+ A7E1 7C               ld   a,h                      ; currY
2042+ A7E2 FE 02            cp   2
2043+ A7E4 C2 54 A9         jp   nz, .gtmv_fail
2044+ A7E7
2045+ A7E7                  ; verifica che in (Y=0, X=L) non ci sia nessun giocatore
2046+ A7E7 16 00            ld   d,0                      ; targetY
2047+ A7E9 5D               ld   e,l                      ; targetX = currX
2048+ A7EA C5               push bc
2049+ A7EB E5               push hl
2050+ A7EC CD DF A2         call Game_GetPlayerInfoByPos
2051+ A7EF E1               pop  hl
2052+ A7F0 C1               pop  bc
2053+ A7F1 FE FF            cp   NO_VALUE
2054+ A7F3 C2 54 A9         jp   nz, .gtmv_fail           ; cella occupata
2055+ A7F6
2056+ A7F6                  ; verifica che in (Y=0, X=L) non ci sia la palla
2057+ A7F6                  ;ld   d,0
2058+ A7F6                  ;ld   e,l
2059+ A7F6                  ;CALL CheckBallAtPosition
2060+ A7F6                  ;CP   NO
2061+ A7F6                  ;jp   z, .no_ball_sb_up
2062+ A7F6                  ;jp   .gtmv_fail               ; palla sulla destinazione
2063+ A7F6
2064+ A7F6              .no_ball_sb_up:
2065+ A7F6                  ; conta i compagni sulla riga 0
2066+ A7F6 C5               push bc
2067+ A7F7 16 00            ld   d,0
2068+ A7F9 CD C4 AA         call Game_CountTeamPlayersOnRow
2069+ A7FC C1               pop  bc
2070+ A7FD FE 02            cp   2
2071+ A7FF D2 54 A9         jp   nc, .gtmv_fail           ; già 2 → non possiamo aggiungerne un terzo
2072+ A802
2073+ A802                  ; sposta il giocatore a (0, X)
2074+ A802 16 00            ld   d,0
2075+ A804 5D               ld   e,l
2076+ A805                  ;call SetPlayerInfo
2077+ A805 C3 49 A9         jp   .gtmv_success
2078+ A808
2079+ A808              ; Nero, campo SOUTH, move SOUTH:
2080+ A808              ; deve essere su riga 0, target riga 2
2081+ A808              .gtmv_sb_move_down:
2082+ A808 7C               ld   a,h                      ; currY
2083+ A809 FE 00            cp   0
2084+ A80B C2 54 A9         jp   nz, .gtmv_fail
2085+ A80E
2086+ A80E 16 02            ld   d,2
2087+ A810 5D               ld   e,l
2088+ A811 C5               push bc
2089+ A812 E5               push hl
2090+ A813 CD DF A2         call Game_GetPlayerInfoByPos
2091+ A816 E1               pop  hl
2092+ A817 C1               pop  bc
2093+ A818 FE FF            cp   NO_VALUE
2094+ A81A C2 54 A9         jp   nz, .gtmv_fail
2095+ A81D
2096+ A81D                  ;; verifica palla in (2, currX)
2097+ A81D                  ;ld   d,2
2098+ A81D                  ;ld   e,l
2099+ A81D                  ;CALL CheckBallAtPosition
2100+ A81D                  ;CP   NO
2101+ A81D                  ;jp   z, .no_ball_sb_down
2102+ A81D                  ;jp   .gtmv_fail
2103+ A81D
2104+ A81D              .no_ball_sb_down:
2105+ A81D                  ; conta i compagni sulla riga 2
2106+ A81D C5               push bc
2107+ A81E 16 02            ld   d,2
2108+ A820 CD C4 AA         call Game_CountTeamPlayersOnRow
2109+ A823 C1               pop  bc
2110+ A824 FE 02            cp   2
2111+ A826 D2 54 A9         jp   nc, .gtmv_fail
2112+ A829
2113+ A829 16 02            ld   d,2
2114+ A82B 5D               ld   e,l
2115+ A82C                  ;call SetPlayerInfo
2116+ A82C C3 49 A9         jp   .gtmv_success
2117+ A82F
2118+ A82F              ; ----- TEAM_WHITE, FIELD_SOUTH_SIDE -----
2119+ A82F              .gtmv_south_white:
2120+ A82F 7A               ld   a,d                      ; direzione
2121+ A830 FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2122+ A832 CA 3D A8         jp   z, .gtmv_sw_move_up
2123+ A835 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2124+ A837 CA 64 A8         jp   z, .gtmv_sw_move_down
2125+ A83A C3 54 A9         jp   .gtmv_fail
2126+ A83D
2127+ A83D              ; Bianco, campo SOUTH, move NORTH:
2128+ A83D              ; deve essere su riga 3, target riga 1
2129+ A83D              .gtmv_sw_move_up:
2130+ A83D 7C               ld   a,h                      ; currY
2131+ A83E FE 03            cp   3
2132+ A840 C2 54 A9         jp   nz, .gtmv_fail
2133+ A843
2134+ A843
2135+ A843 16 01            ld   d,1
2136+ A845 5D               ld   e,l
2137+ A846 C5               push bc
2138+ A847 E5               push hl
2139+ A848 CD DF A2         call Game_GetPlayerInfoByPos
2140+ A84B E1               pop  hl
2141+ A84C C1               pop  bc
2142+ A84D FE FF            cp   NO_VALUE
2143+ A84F
2144+ A84F C2 54 A9         jp   nz, .gtmv_fail
2145+ A852
2146+ A852                  ; verifica palla in (1, currX)
2147+ A852                  ;ld   d,1
2148+ A852                  ;ld   e,l
2149+ A852                  ;CALL CheckBallAtPosition
2150+ A852                  ;CP   NO
2151+ A852                  ;jp   z, .no_ball_sw_up
2152+ A852                  ;jp   .gtmv_fail
2153+ A852
2154+ A852              .no_ball_sw_up:
2155+ A852                  ; conta i compagni sulla riga 1
2156+ A852 C5               push bc
2157+ A853 16 01            ld   d,1
2158+ A855 CD C4 AA         call Game_CountTeamPlayersOnRow
2159+ A858 C1               pop  bc
2160+ A859 FE 02            cp   2
2161+ A85B D2 54 A9         jp   nc, .gtmv_fail
2162+ A85E
2163+ A85E 16 01            ld   d,1
2164+ A860 5D               ld   e,l
2165+ A861                  ;call SetPlayerInfo
2166+ A861 C3 49 A9         jp   .gtmv_success
2167+ A864
2168+ A864              ; Bianco, campo SOUTH, move SOUTH:
2169+ A864              ; deve essere su riga 1, target riga 3
2170+ A864              .gtmv_sw_move_down:
2171+ A864 7C               ld   a,h                      ; currY
2172+ A865 FE 01            cp   1
2173+ A867 C2 54 A9         jp   nz, .gtmv_fail
2174+ A86A
2175+ A86A
2176+ A86A 16 03            ld   d,3
2177+ A86C 5D               ld   e,l
2178+ A86D C5               push bc
2179+ A86E E5               push hl
2180+ A86F CD DF A2         call Game_GetPlayerInfoByPos
2181+ A872 E1               pop  hl
2182+ A873 C1               pop  bc
2183+ A874
2184+ A874 FE FF            cp   NO_VALUE
2185+ A876
2186+ A876 C2 54 A9         jp   nz, .gtmv_fail
2187+ A879
2188+ A879                  ; verifica palla in (3, currX)
2189+ A879                  ;ld   d,3
2190+ A879                  ;ld   e,l
2191+ A879                  ;CALL CheckBallAtPosition
2192+ A879                  ;CP   NO
2193+ A879                  ;jp   z, .no_ball_sw_down
2194+ A879                  ;jp   .gtmv_fail
2195+ A879
2196+ A879              .no_ball_sw_down:
2197+ A879                  ; conta i compagni sulla riga 3
2198+ A879 C5               push bc
2199+ A87A 16 03            ld   d,3
2200+ A87C CD C4 AA         call Game_CountTeamPlayersOnRow
2201+ A87F C1               pop  bc
2202+ A880 FE 02            cp   2
2203+ A882 D2 54 A9         jp   nc, .gtmv_fail
2204+ A885
2205+ A885 16 03            ld   d,3
2206+ A887 5D               ld   e,l
2207+ A888                  ;call SetPlayerInfo
2208+ A888 C3 49 A9         jp   .gtmv_success
2209+ A88B
2210+ A88B
2211+ A88B              ; --------- FIELD_NORTH_SIDE ------------------------------------
2212+ A88B              .gtmv_side_north:
2213+ A88B 78               ld   a,b
2214+ A88C FE 01            cp   TEAM_WHITE
2215+ A88E CA ED A8         jp   z, .gtmv_north_white
2216+ A891
2217+ A891                  ; ----- TEAM_BLACK, FIELD_NORTH_SIDE -----
2218+ A891 7A               ld   a,d                      ; direzione
2219+ A892 FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2220+ A894 CA 9F A8         jp   z, .gtmv_nb_move_up
2221+ A897 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2222+ A899 CA C6 A8         jp   z, .gtmv_nb_move_down
2223+ A89C C3 54 A9         jp   .gtmv_fail
2224+ A89F
2225+ A89F              ; Nero, campo NORTH, move NORTH:
2226+ A89F              ; deve essere su riga 3, target riga 1
2227+ A89F              .gtmv_nb_move_up:
2228+ A89F 7C               ld   a,h                      ; currY
2229+ A8A0 FE 03            cp   3
2230+ A8A2 C2 54 A9         jp   nz, .gtmv_fail
2231+ A8A5
2232+ A8A5
2233+ A8A5 16 01            ld   d,1
2234+ A8A7 5D               ld   e,l
2235+ A8A8 C5               push bc
2236+ A8A9 E5               push hl
2237+ A8AA CD DF A2         call Game_GetPlayerInfoByPos
2238+ A8AD E1               pop  hl
2239+ A8AE C1               pop  bc
2240+ A8AF FE FF            cp   NO_VALUE
2241+ A8B1
2242+ A8B1 C2 54 A9         jp   nz, .gtmv_fail
2243+ A8B4
2244+ A8B4                  ; verifica palla in (1, currX)
2245+ A8B4                  ;ld   d,1
2246+ A8B4                  ;ld   e,l
2247+ A8B4                  ;CALL CheckBallAtPosition
2248+ A8B4                  ;CP   NO
2249+ A8B4                  ;jp   z, .no_ball_nb_up
2250+ A8B4                  ;jp   .gtmv_fail
2251+ A8B4
2252+ A8B4              .no_ball_nb_up:
2253+ A8B4                  ; conta i compagni sulla riga 1
2254+ A8B4 C5               push bc
2255+ A8B5 16 01            ld   d,1
2256+ A8B7 CD C4 AA         call Game_CountTeamPlayersOnRow
2257+ A8BA C1               pop  bc
2258+ A8BB FE 02            cp   2
2259+ A8BD CA 54 A9         jp   z, .gtmv_fail
2260+ A8C0
2261+ A8C0 16 01            ld   d,1
2262+ A8C2 5D               ld   e,l
2263+ A8C3                  ;call SetPlayerInfo
2264+ A8C3 C3 49 A9         jp   .gtmv_success
2265+ A8C6
2266+ A8C6              ; Nero, campo NORTH, move SOUTH:
2267+ A8C6              ; deve essere su riga 1, target riga 3
2268+ A8C6              .gtmv_nb_move_down:
2269+ A8C6 7C               ld   a,h
2270+ A8C7 FE 01            cp   1
2271+ A8C9 C2 54 A9         jp   nz, .gtmv_fail
2272+ A8CC
2273+ A8CC 16 03            ld   d,3
2274+ A8CE 5D               ld   e,l
2275+ A8CF C5               push bc
2276+ A8D0 E5               push hl
2277+ A8D1 CD DF A2         call Game_GetPlayerInfoByPos
2278+ A8D4 E1               pop  hl
2279+ A8D5 C1               pop  bc
2280+ A8D6 FE FF            cp   NO_VALUE
2281+ A8D8 C2 54 A9         jp   nz, .gtmv_fail
2282+ A8DB
2283+ A8DB                  ; verifica palla in (3, currX)
2284+ A8DB                  ;ld   d,3
2285+ A8DB                  ;ld   e,l
2286+ A8DB                  ;CALL CheckBallAtPosition
2287+ A8DB                  ;CP   NO
2288+ A8DB                  ;jp   z, .no_ball_nb_down
2289+ A8DB                  ;jp   .gtmv_fail
2290+ A8DB
2291+ A8DB              .no_ball_nb_down:
2292+ A8DB                  ; conta i compagni sulla riga 3
2293+ A8DB C5               push bc
2294+ A8DC 16 03            ld   d,3
2295+ A8DE CD C4 AA         call Game_CountTeamPlayersOnRow
2296+ A8E1 C1               pop  bc
2297+ A8E2 FE 02            cp   2
2298+ A8E4 D2 54 A9         jp   nc, .gtmv_fail
2299+ A8E7
2300+ A8E7 16 03            ld   d,3
2301+ A8E9 5D               ld   e,l
2302+ A8EA                  ;call SetPlayerInfo
2303+ A8EA C3 49 A9         jp   .gtmv_success
2304+ A8ED
2305+ A8ED              ; ----- TEAM_WHITE, FIELD_NORTH_SIDE -----
2306+ A8ED              .gtmv_north_white:
2307+ A8ED 7A               ld   a,d                      ; direzione
2308+ A8EE FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2309+ A8F0 CA FB A8         jp   z, .gtmv_nw_move_up
2310+ A8F3 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2311+ A8F5 CA 22 A9         jp   z, .gtmv_nw_move_down
2312+ A8F8 C3 54 A9         jp   .gtmv_fail
2313+ A8FB
2314+ A8FB              ; Bianco, campo NORTH, move NORTH:
2315+ A8FB              ; deve essere su riga 4, target riga 2
2316+ A8FB              .gtmv_nw_move_up:
2317+ A8FB 7C               ld   a,h                      ; currY
2318+ A8FC FE 04            cp   4
2319+ A8FE C2 54 A9         jp   nz, .gtmv_fail
2320+ A901
2321+ A901 16 02            ld   d,2
2322+ A903 5D               ld   e,l
2323+ A904 C5               push bc
2324+ A905 E5               push hl
2325+ A906 CD DF A2         call Game_GetPlayerInfoByPos
2326+ A909 E1               pop  hl
2327+ A90A C1               pop  bc
2328+ A90B FE FF            cp   NO_VALUE
2329+ A90D C2 54 A9         jp   nz, .gtmv_fail
2330+ A910
2331+ A910                  ; verifica palla in (2, currX)
2332+ A910                  ;ld   d,2
2333+ A910                  ;ld   e,l
2334+ A910                  ;CALL CheckBallAtPosition
2335+ A910                  ;CP   NO
2336+ A910                  ;jp   z, .no_ball_nw_up
2337+ A910                  ;jp   .gtmv_fail
2338+ A910
2339+ A910              .no_ball_nw_up:
2340+ A910                  ; conta i compagni sulla riga 2
2341+ A910 C5               push bc
2342+ A911 16 02            ld   d,2
2343+ A913 CD C4 AA         call Game_CountTeamPlayersOnRow
2344+ A916 C1               pop  bc
2345+ A917 FE 02            cp   2
2346+ A919 D2 54 A9         jp   nc, .gtmv_fail
2347+ A91C
2348+ A91C 16 02            ld   d,2
2349+ A91E 5D               ld   e,l
2350+ A91F                  ;call SetPlayerInfo
2351+ A91F C3 49 A9         jp   .gtmv_success
2352+ A922
2353+ A922              ; Bianco, campo NORTH, move SOUTH:
2354+ A922              ; deve essere su riga 2, target riga 4
2355+ A922              .gtmv_nw_move_down:
2356+ A922 7C               ld   a,h                      ; currY
2357+ A923 FE 02            cp   2
2358+ A925 C2 54 A9         jp   nz, .gtmv_fail
2359+ A928
2360+ A928 16 04            ld   d,4
2361+ A92A 5D               ld   e,l
2362+ A92B C5               push bc
2363+ A92C E5               push hl
2364+ A92D CD DF A2         call Game_GetPlayerInfoByPos
2365+ A930 E1               pop  hl
2366+ A931 C1               pop  bc
2367+ A932 FE FF            cp   NO_VALUE
2368+ A934 C2 54 A9         jp   nz, .gtmv_fail
2369+ A937
2370+ A937                  ; verifica palla in (4, currX)
2371+ A937                  ;ld   d,4
2372+ A937                  ;ld   e,l
2373+ A937                  ;CALL CheckBallAtPosition
2374+ A937                  ;CP   NO
2375+ A937                  ;jp   z, .no_ball_nw_down
2376+ A937                  ;jp   .gtmv_fail
2377+ A937
2378+ A937              .no_ball_nw_down:
2379+ A937                  ; conta i compagni sulla riga 4
2380+ A937 C5               push bc
2381+ A938 16 04            ld   d,4
2382+ A93A CD C4 AA         call Game_CountTeamPlayersOnRow
2383+ A93D C1               pop  bc
2384+ A93E FE 02            cp   2
2385+ A940 D2 54 A9         jp   nc, .gtmv_fail
2386+ A943
2387+ A943 16 04            ld   d,4
2388+ A945 5D               ld   e,l
2389+ A946                  ;call SetPlayerInfo
2390+ A946 C3 49 A9         jp   .gtmv_success
2391+ A949
2392+ A949
2393+ A949              ; -------------------------------------------------------------------
2394+ A949              .gtmv_success:
2395+ A949 CD 9D A2         call SetPlayerInfo
2396+ A94C                  ;CALL VDP_PlayerMatrixRedraw
2397+ A94C 3E 01            LD     A, YES
2398+ A94E 32 C0 86         LD     (Var_Hooks_ForceVdpRedraw), A
2399+ A951 3E 01            ld   a,SUCCESS
2400+ A953 C9               ret
2401+ A954
2402+ A954              .gtmv_fail:
2403+ A954 3E 00            ld   a,FAILURE
2404+ A956 C9               ret
2405+ A957              .gtmv_fail_pop:
2406+ A957 F1               pop  af                        ; rimuovi dir dallo stack
2407+ A958 18 FA            JR   .gtmv_fail
2408+ A95A              ;---------------------------------------------------------------------------
2409+ A95A              ; Game_CheckBallAtPosition
2410+ A95A              ; Controlla se la palla si trova in (D,E).
2411+ A95A              ; INPUT:
2412+ A95A              ;   D = Y
2413+ A95A              ;   E = X
2414+ A95A              ; OUTPUT:
2415+ A95A              ;   A = YES (1) se la palla è in (D,E), NO (0) altrimenti
2416+ A95A              ; ---------------------------------------------------------------------------
2417+ A95A              CheckBallAtPosition:
2418+ A95A E5               push hl
2419+ A95B D5               push de
2420+ A95C E1               pop  hl
2421+ A95D
2422+ A95D CD FD A1         call Game_GetBallPosition
2423+ A960 7A               ld   a, d
2424+ A961 BC               cp   h
2425+ A962 20 08            jr   nz, .NotFound
2426+ A964 7B               ld   a, e
2427+ A965 BD               cp   l
2428+ A966 20 04            jr   nz, .NotFound
2429+ A968 3E 01            LD   a, YES
2430+ A96A              .Done:
2431+ A96A E1               pop  hl
2432+ A96B
2433+ A96B C9               ret
2434+ A96C              .NotFound:
2435+ A96C 3E 00            LD   a, NO
2436+ A96E C3 6A A9         jp   .Done
2437+ A971              ; ---------------------------------------------------------------------------
2438+ A971              ; TryShot
2439+ A971              ; INPUT:
2440+ A971              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
2441+ A971              ;   C = ID   (giocatore con palla)
2442+ A971              ;
2443+ A971              ; OUTPUT:
2444+ A971              ;   Var_Game_BallDirection impostata
2445+ A971              ;   Var_Game_BallDiagonalMovCounter:
2446+ A971              ;       - 255 solo se (ActiveFieldSide=NORTH, TEAM=WHITE, shooterY=2)
2447+ A971              ;       - 0 in tutti gli altri casi
2448+ A971              ; ---------------------------------------------------------------------------
2449+ A971              Game_TryShot:
2450+ A971 F5               push af
2451+ A972 C5               push bc
2452+ A973 D5               push de
2453+ A974 E5               push hl
2454+ A975
2455+ A975 CD 54 B4         call Game_PlayBeep
2456+ A978                  ; Leggi posizione giocatore (H=Y, L=X)
2457+ A978 CD C4 A2         call Game_GetPlayerInfoById
2458+ A97B
2459+ A97B                  ; Default counter=0
2460+ A97B AF               xor  a
2461+ A97C 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
2462+ A97F
2463+ A97F                  ; Se campo NORTH e bianco e Y=2 => counter=255 (caso speciale)
2464+ A97F 3A 46 86         ld   a,(Var_Game_ActiveFieldSide)
2465+ A982 FE 01            cp   FIELD_NORTH_SIDE
2466+ A984 20 0F            jr   nz,.counter_done
2467+ A986 78               ld   a,b
2468+ A987 FE 01            cp   TEAM_WHITE
2469+ A989 20 0A            jr   nz,.counter_done
2470+ A98B 7C               ld   a,h
2471+ A98C FE 02            cp   2
2472+ A98E 20 05            jr   nz,.counter_done
2473+ A990 3E FF            ld   a,255
2474+ A992 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
2475+ A995              .counter_done:
2476+ A995
2477+ A995                  ; Decide direzione in base a campo/team/riga/colonna
2478+ A995 3A 46 86         ld   a,(Var_Game_ActiveFieldSide)
2479+ A998 FE 01            cp   FIELD_NORTH_SIDE
2480+ A99A 28 03            jr   z,.field_north
2481+ A99C C3 1F AA         jp   .field_south
2482+ A99F
2483+ A99F              ; ==========================
2484+ A99F              ; CAMPO VISIBILE: NORTH
2485+ A99F              ; ==========================
2486+ A99F              .field_north:
2487+ A99F 78               ld   a,b
2488+ A9A0 FE 00            cp   TEAM_BLACK
2489+ A9A2 28 02            jr   z,.north_black
2490+ A9A4                  ; altrimenti TEAM_WHITE
2491+ A9A4 18 30            jr   .north_white
2492+ A9A6
2493+ A9A6              .north_black:
2494+ A9A6                  ; Nero: da qualsiasi riga -> SOUTH / SOUTH_EAST / SOUTH_WEST
2495+ A9A6                  ; con vincolo bordo: X=0 => no SOUTH_WEST, X=4 => no SOUTH_EAST
2496+ A9A6 CD D9 A6         call Game_GetRandomByte
2497+ A9A9 E6 03            and  00000011b          ; 0..3
2498+ A9AB FE 03            cp   3
2499+ A9AD 20 01            jr   nz,.nb_r_ok
2500+ A9AF AF               xor  a                  ; 3 -> 0
2501+ A9B0              .nb_r_ok:
2502+ A9B0                  ; A = 0..2
2503+ A9B0                  ; 0=SOUTH, 1=SOUTH_EAST, 2=SOUTH_WEST (poi validiamo bordi)
2504+ A9B0 57               ld   d,a                ; D = scelta
2505+ A9B1
2506+ A9B1 7D               ld   a,l                ; X
2507+ A9B2 FE 00            cp   0
2508+ A9B4 20 07            jr   nz,.nb_not_left
2509+ A9B6                  ; X=0: se scelta = SOUTH_WEST (2) -> forza SOUTH (0) o SOUTH_EAST (1)
2510+ A9B6 7A               ld   a,d
2511+ A9B7 FE 02            cp   2
2512+ A9B9 20 02            jr   nz,.nb_not_left
2513+ A9BB                  ; forza SOUTH_EAST (più "naturale" da sinistra) oppure SOUTH
2514+ A9BB 16 01            ld   d,1
2515+ A9BD              .nb_not_left:
2516+ A9BD 7D               ld   a,l
2517+ A9BE FE 04            cp   4
2518+ A9C0 20 07            jr   nz,.nb_choose
2519+ A9C2                  ; X=4: se scelta = SOUTH_EAST (1) -> forza SOUTH_WEST (2) o SOUTH
2520+ A9C2 7A               ld   a,d
2521+ A9C3 FE 01            cp   1
2522+ A9C5 20 02            jr   nz,.nb_choose
2523+ A9C7 16 02            ld   d,2
2524+ A9C9              .nb_choose:
2525+ A9C9 7A               ld   a,d
2526+ A9CA B7               or   a
2527+ A9CB CA 9A AA         jp   z,.set_south
2528+ A9CE FE 01            cp   1
2529+ A9D0 CA A6 AA         jp   z,.set_se
2530+ A9D3                  ; 2
2531+ A9D3 C3 AA AA         jp   .set_sw
2532+ A9D6
2533+ A9D6              .north_white:
2534+ A9D6 7C               ld   a,h                ; Y
2535+ A9D7 FE 04            cp   4
2536+ A9D9 28 07            jr   z,.nw_y4
2537+ A9DB FE 02            cp   2
2538+ A9DD 28 33            jr   z,.nw_y2
2539+ A9DF                  ; Fuori dalle righe previste: niente tiro
2540+ A9DF C3 B3 AA         jp   .stop_shot
2541+ A9E2
2542+ A9E2              .nw_y4:
2543+ A9E2                  ; Bianco da riga 4: NORTH / NE / NW
2544+ A9E2                  ; vincolo bordo: X=0 => no NW, X=4 => no NE
2545+ A9E2 CD D9 A6         call Game_GetRandomByte
2546+ A9E5 E6 03            and  00000011b          ; 0..3
2547+ A9E7 FE 03            cp   3
2548+ A9E9 20 01            jr   nz,.nw4_r_ok
2549+ A9EB AF               xor  a
2550+ A9EC              .nw4_r_ok:
2551+ A9EC                  ; 0=NORTH, 1=NE, 2=NW
2552+ A9EC 57               ld   d,a
2553+ A9ED
2554+ A9ED 7D               ld   a,l
2555+ A9EE FE 00            cp   0
2556+ A9F0 20 07            jr   nz,.nw4_not_left
2557+ A9F2 7A               ld   a,d
2558+ A9F3 FE 02            cp   2
2559+ A9F5 20 02            jr   nz,.nw4_not_left
2560+ A9F7 16 01            ld   d,1                ; da sinistra, evita NW -> forza NE (o straight, ma NE va bene)
2561+ A9F9              .nw4_not_left:
2562+ A9F9 7D               ld   a,l
2563+ A9FA FE 04            cp   4
2564+ A9FC 20 07            jr   nz,.nw4_choose
2565+ A9FE 7A               ld   a,d
2566+ A9FF FE 01            cp   1
2567+ AA01 20 02            jr   nz,.nw4_choose
2568+ AA03 16 02            ld   d,2                ; da destra, evita NE -> forza NW
2569+ AA05              .nw4_choose:
2570+ AA05 7A               ld   a,d
2571+ AA06 B7               or   a
2572+ AA07 CA 96 AA         jp   z,.set_north
2573+ AA0A FE 01            cp   1
2574+ AA0C CA 9E AA         jp   z,.set_ne
2575+ AA0F C3 A2 AA         jp   .set_nw
2576+ AA12
2577+ AA12              .nw_y2:
2578+ AA12                  ; Caso speciale attaccante bianco in riga 2 (campo NORTH)
2579+ AA12                  ; - se X=1..3 -> NORTH
2580+ AA12                  ; - se X=0 -> NORTH_EAST
2581+ AA12                  ; - se X=4 -> NORTH_WEST
2582+ AA12 7D               ld   a,l
2583+ AA13 FE 00            cp   0
2584+ AA15 CA 9E AA         jp   z,.set_ne
2585+ AA18 FE 04            cp   4
2586+ AA1A CA A2 AA         jp   z,.set_nw
2587+ AA1D 18 77            jr   .set_north
2588+ AA1F
2589+ AA1F
2590+ AA1F              ; ==========================
2591+ AA1F              ; CAMPO VISIBILE: SOUTH
2592+ AA1F              ; ==========================
2593+ AA1F              .field_south:
2594+ AA1F 78               ld   a,b
2595+ AA20 FE 01            cp   TEAM_WHITE
2596+ AA22 28 02            jr   z,.south_white
2597+ AA24                  ; altrimenti TEAM_BLACK
2598+ AA24 18 2D            jr   .south_black
2599+ AA26
2600+ AA26              .south_white:
2601+ AA26                  ; Bianco: da qualsiasi riga -> NORTH / NE / NW
2602+ AA26                  ; vincolo bordo: X=0 => no NW, X=4 => no NE
2603+ AA26 CD D9 A6         call Game_GetRandomByte
2604+ AA29 E6 03            and  00000011b
2605+ AA2B FE 03            cp   3
2606+ AA2D 20 01            jr   nz,.sw_r_ok
2607+ AA2F AF               xor  a
2608+ AA30              .sw_r_ok:
2609+ AA30                  ; 0=NORTH, 1=NE, 2=NW
2610+ AA30 57               ld   d,a
2611+ AA31
2612+ AA31 7D               ld   a,l
2613+ AA32 FE 00            cp   0
2614+ AA34 20 07            jr   nz,.sw_not_left
2615+ AA36 7A               ld   a,d
2616+ AA37 FE 02            cp   2
2617+ AA39 20 02            jr   nz,.sw_not_left
2618+ AA3B 16 01            ld   d,1
2619+ AA3D              .sw_not_left:
2620+ AA3D 7D               ld   a,l
2621+ AA3E FE 04            cp   4
2622+ AA40 20 07            jr   nz,.sw_choose
2623+ AA42 7A               ld   a,d
2624+ AA43 FE 01            cp   1
2625+ AA45 20 02            jr   nz,.sw_choose
2626+ AA47 16 02            ld   d,2
2627+ AA49              .sw_choose:
2628+ AA49 7A               ld   a,d
2629+ AA4A B7               or   a
2630+ AA4B 28 49            jr   z,.set_north
2631+ AA4D FE 01            cp   1
2632+ AA4F 28 4D            jr   z,.set_ne
2633+ AA51 18 4F            jr   .set_nw
2634+ AA53
2635+ AA53              .south_black:
2636+ AA53 7C               ld   a,h                ; Y
2637+ AA54 FE 00            cp   0
2638+ AA56 28 06            jr   z,.sb_y0
2639+ AA58 FE 02            cp   2
2640+ AA5A 28 2F            jr   z,.sb_y2
2641+ AA5C 18 55            jr   .stop_shot
2642+ AA5E
2643+ AA5E              .sb_y0:
2644+ AA5E                  ; Nero da riga 0: SOUTH / SE / SW
2645+ AA5E                  ; vincolo bordo: X=0 => no SW, X=4 => no SE
2646+ AA5E CD D9 A6         call Game_GetRandomByte
2647+ AA61 E6 03            and  00000011b
2648+ AA63 FE 03            cp   3
2649+ AA65 20 01            jr   nz,.sb0_r_ok
2650+ AA67 AF               xor  a
2651+ AA68              .sb0_r_ok:
2652+ AA68                  ; 0=SOUTH, 1=SE, 2=SW
2653+ AA68 57               ld   d,a
2654+ AA69
2655+ AA69 7D               ld   a,l
2656+ AA6A FE 00            cp   0
2657+ AA6C 20 07            jr   nz,.sb0_not_left
2658+ AA6E 7A               ld   a,d
2659+ AA6F FE 02            cp   2
2660+ AA71 20 02            jr   nz,.sb0_not_left
2661+ AA73 16 01            ld   d,1
2662+ AA75              .sb0_not_left:
2663+ AA75 7D               ld   a,l
2664+ AA76 FE 04            cp   4
2665+ AA78 20 07            jr   nz,.sb0_choose
2666+ AA7A 7A               ld   a,d
2667+ AA7B FE 01            cp   1
2668+ AA7D 20 02            jr   nz,.sb0_choose
2669+ AA7F 16 02            ld   d,2
2670+ AA81              .sb0_choose:
2671+ AA81 7A               ld   a,d
2672+ AA82 B7               or   a
2673+ AA83 28 15            jr   z,.set_south
2674+ AA85 FE 01            cp   1
2675+ AA87 28 1D            jr   z,.set_se
2676+ AA89 18 1F            jr   .set_sw
2677+ AA8B
2678+ AA8B              .sb_y2:
2679+ AA8B                  ; Nero in riga 2 (campo SOUTH):
2680+ AA8B                  ; - X=1..3 -> SOUTH
2681+ AA8B                  ; - X=0 -> SOUTH_EAST
2682+ AA8B                  ; - X=4 -> SOUTH_WEST
2683+ AA8B 7D               ld   a,l
2684+ AA8C FE 00            cp   0
2685+ AA8E 28 16            jr   z,.set_se
2686+ AA90 FE 04            cp   4
2687+ AA92 28 16            jr   z,.set_sw
2688+ AA94 18 04            jr   .set_south
2689+ AA96
2690+ AA96
2691+ AA96              ; ==========================
2692+ AA96              ; SET DIREZIONI
2693+ AA96              ; ==========================
2694+ AA96              .set_north:
2695+ AA96 3E 01            ld   a,BALL_DIRECTION_NORTH
2696+ AA98 18 14            jr   .store_dir
2697+ AA9A              .set_south:
2698+ AA9A 3E 04            ld   a,BALL_DIRECTION_SOUTH
2699+ AA9C 18 10            jr   .store_dir
2700+ AA9E              .set_ne:
2701+ AA9E 3E 02            ld   a,BALL_DIRECTION_NORTH_EAST
2702+ AAA0 18 0C            jr   .store_dir
2703+ AAA2              .set_nw:
2704+ AAA2 3E 03            ld   a,BALL_DIRECTION_NORTH_WEST
2705+ AAA4 18 08            jr   .store_dir
2706+ AAA6              .set_se:
2707+ AAA6 3E 05            ld   a,BALL_DIRECTION_SOUTH_EAST
2708+ AAA8 18 04            jr   .store_dir
2709+ AAAA              .set_sw:
2710+ AAAA 3E 06            ld   a,BALL_DIRECTION_SOUTH_WEST
2711+ AAAC 18 00            jr   .store_dir
2712+ AAAE
2713+ AAAE              .store_dir:
2714+ AAAE 32 66 86         ld   (Var_Game_BallDirection),a
2715+ AAB1 18 03            jr   .done
2716+ AAB3
2717+ AAB3              .stop_shot:
2718+ AAB3 CD BB AA         call Game_StopShot
2719+ AAB6
2720+ AAB6              .done:
2721+ AAB6 E1               pop  hl
2722+ AAB7 D1               pop  de
2723+ AAB8 C1               pop  bc
2724+ AAB9 F1               pop  af
2725+ AABA C9               ret
2726+ AABB
2727+ AABB
2728+ AABB              ; ---------------------------------------------------------------------------
2729+ AABB              ; Game_StopShot
2730+ AABB              ; Ferma il tiro: azzera direzione e counter diagonale.
2731+ AABB              ; ---------------------------------------------------------------------------
2732+ AABB              Game_StopShot:
2733+ AABB 3E 00            ld   a, BALL_DIRECTION_NONE
2734+ AABD 32 66 86         ld   (Var_Game_BallDirection),a         ; BALL_DIRECTION_NONE = 0 (assunto)
2735+ AAC0 32 67 86         ld   (Var_Game_BallDiagonalMovCounter),a
2736+ AAC3 C9               ret
2737+ AAC4
2738+ AAC4
2739+ AAC4              ; ---------------------------------------------------------------------------
2740+ AAC4              ; Game_CountTeamPlayersOnRow
2741+ AAC4              ; Conta quanti giocatori della squadra B sono sulla riga D (Y = D).
2742+ AAC4              ;
2743+ AAC4              ; INPUT:
2744+ AAC4              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
2745+ AAC4              ;   D = Y (riga da controllare)
2746+ AAC4              ;
2747+ AAC4              ; OUTPUT:
2748+ AAC4              ;   A = numero di giocatori (0..4)
2749+ AAC4              ;
2750+ AAC4              ; MODIFIES:
2751+ AAC4              ;   AF, C, DE, HL
2752+ AAC4              ; ---------------------------------------------------------------------------
2753+ AAC4              Game_CountTeamPlayersOnRow:
2754+ AAC4 C5               PUSH BC
2755+ AAC5 D5               PUSH DE
2756+ AAC6 E5               PUSH HL
2757+ AAC7 7A               LD   A, D
2758+ AAC8 CD 22 B0         CALL GetAllPlayersOnARow
2759+ AACB 78               LD   A, B
2760+ AACC FE FF            CP   NO_VALUE
2761+ AACE 28 10            JR   Z, .NoPlayersFound
2762+ AAD0 79               LD   A, C
2763+ AAD1 FE FF            CP   NO_VALUE
2764+ AAD3 28 06            JR   Z, .OnePlayerFound
2765+ AAD5 3E 02            LD   A, 2
2766+ AAD7              .Done:
2767+ AAD7 E1               POP  HL
2768+ AAD8 D1               POP  DE
2769+ AAD9 C1               POP  BC
2770+ AADA C9               RET
2771+ AADB              .OnePlayerFound:
2772+ AADB 3E 01            LD   A, 1
2773+ AADD C3 D7 AA         JP   .Done
2774+ AAE0              .NoPlayersFound:
2775+ AAE0 AF               XOR  A
2776+ AAE1 C3 D7 AA         JP   .Done
2777+ AAE4
2778+ AAE4              ; ---------------------------------------------------------------------------
2779+ AAE4              ; MoveGoalKeeper
2780+ AAE4              ; INPUT: B: Team
2781+ AAE4              ; ---------------------------------------------------------------------------
2782+ AAE4              MoveGoalKeeper:
2783+ AAE4 D5               PUSH DE
2784+ AAE5 E5               PUSH HL
2785+ AAE6 C5               PUSH BC
2786+ AAE7 F3               DI
2787+ AAE8 CD F7 86         CALL Hooks_TickStop
2788+ AAEB 0E 00            LD   C, 0
2789+ AAED CD C4 A2         CALL Game_GetPlayerInfoById
2790+ AAF0 7C               LD   A, H
2791+ AAF1 FE FF            CP   NO_VALUE
2792+ AAF3 28 24            JR   Z, .done
2793+ AAF5
2794+ AAF5 3A 4C 86         ld   a, (Var_Game_MoveTmpDir)
2795+ AAF8 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2796+ AAFA 20 09            jr   nz, .move_west
2797+ AAFC                  ; --- move east ---
2798+ AAFC 2C               inc  l
2799+ AAFD 7D               LD   A, L
2800+ AAFE FE 04            CP   4
2801+ AB00 28 17            JR   Z, .done
2802+ AB02 C3 0B AB         JP   .set_pos
2803+ AB05              .move_west:
2804+ AB05
2805+ AB05                  ; --- move west ---
2806+ AB05 2D               dec  l
2807+ AB06 7D               LD   A, L
2808+ AB07 FE 00            CP   0
2809+ AB09 28 0E            JR   Z, .done
2810+ AB0B              .set_pos:
2811+ AB0B C1               POP  BC
2812+ AB0C C5               PUSH BC
2813+ AB0D 0E 00            LD   C, 0
2814+ AB0F 54               LD   D, H
2815+ AB10 5D               LD   E, L
2816+ AB11 CD 9D A2         CALL SetPlayerInfo
2817+ AB14 3E 01            LD   A, YES
2818+ AB16 32 C0 86         LD  (Var_Hooks_ForceVdpRedraw), A
2819+ AB19              .done
2820+ AB19 CD EF 86         CALL Hooks_TickStart
2821+ AB1C C1               POP  BC
2822+ AB1D E1               POP  HL
2823+ AB1E D1               POP  DE
2824+ AB1F C9               RET
2825+ AB20              ; ---------------------------------------------------------------------------
2826+ AB20              ; Game_TryMovePlayerHorizontally
2827+ AB20              ;
2828+ AB20              ; INPUT:
2829+ AB20              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
2830+ AB20              ;   C = ID    (0..3)
2831+ AB20              ;   A = direzione richiesta:
2832+ AB20              ;       PLAYER_ASKED_DIRECTION_EAST
2833+ AB20              ;       PLAYER_ASKED_DIRECTION_WEST
2834+ AB20              ;
2835+ AB20              ; OUTPUT:
2836+ AB20              ;   A = SUCCESS (0) oppure FAILURE (1)
2837+ AB20              ;
2838+ AB20              ; NOTE:
2839+ AB20              ;   - controlla SOLO la colonna adiacente nella direzione richiesta;
2840+ AB20              ;   - se lì c'è un compagno senza palla, prova prima a muovere lui
2841+ AB20              ;     ricorsivamente (stessa direzione);
2842+ AB20              ;   - se la catena non trova spazio o qualcuno ha la palla e blocca,
2843+ AB20              ;     ritorna FAILURE;
2844+ AB20              ;   - se la mossa è possibile:
2845+ AB20              ;       * sposta eventuale palla se:
2846+ AB20              ;           - BALL_STATUS_CONTENDED, oppure
2847+ AB20              ;           - posseduta dal giocatore che stiamo muovendo;
2848+ AB20              ;       * sposta il giocatore di 1 colonna in quella direzione;
2849+ AB20              ;   - limiti orizzontali:
2850+ AB20              ;       * portiere (ID=0): X in [1..3]
2851+ AB20              ;       * altri:            X in [0..4]
2852+ AB20              ; ---------------------------------------------------------------------------
2853+ AB20              Game_TryMovePlayerHorizontally:
2854+ AB20
2855+ AB20                  ; Salva la direzione richiesta (uguale in tutta la catena)
2856+ AB20 32 4C 86         ld   (Var_Game_MoveTmpDir),a
2857+ AB23
2858+ AB23
2859+ AB23
2860+ AB23 E5               push hl
2861+ AB24 C5               push bc
2862+ AB25
2863+ AB25 3A C0 86         LD  A, (Var_Hooks_ForceVdpRedraw)
2864+ AB28 FE 01            CP  YES
2865+ AB2A CA 54 AC         jp   z,.fail_exit
2866+ AB2D
2867+ AB2D 78               ld   a, b
2868+ AB2E 32 56 86         ld   (Var_Game_TmpMoveTeam), a
2869+ AB31 79               ld   a, c
2870+ AB32 32 57 86         ld   (Var_Game_TmpMoveId),a
2871+ AB35
2872+ AB35 CD E4 AA         CALL MoveGoalKeeper
2873+ AB38                  ; --- 1) Ottieni posizione corrente del giocatore (Y,X) ---
2874+ AB38                  ; HL = curr (H=Y, L=X), B=TEAM, C=ID, A=ROLE
2875+ AB38 C1               POP  BC
2876+ AB39 C5               PUSH BC
2877+ AB3A CD C4 A2         call Game_GetPlayerInfoById
2878+ AB3D
2879+ AB3D 7C               ld   a, h
2880+ AB3E 32 5B 86         ld   (Var_Game_TmpMoveRow), a
2881+ AB41 7D               ld   a, l
2882+ AB42 32 5C 86         ld   (Var_Game_TmpMovStartCol), a
2883+ AB45                  ; Salviamo posizione corrente su stack (frame locale):
2884+ AB45                  ;   [SP]   = HL (Y,X)
2885+ AB45                  ;   [SP+2] = BC (TEAM,ID)
2886+ AB45
2887+ AB45
2888+ AB45                  ; Ora:
2889+ AB45                  ;   HL = pos (H=Y,L=X)
2890+ AB45                  ;   BC = TEAM/ID corrente
2891+ AB45                  ;   stack: BC0, HL0  (dove 0 = questo livello di ricorsione)
2892+ AB45
2893+ AB45                  ; --- 2) Controllo limite laterale per questo giocatore ---
2894+ AB45
2895+ AB45                  ; X attuale in L, ID in C
2896+ AB45 7D               ld   a,l              ; A = X
2897+ AB46 57               ld   d,a              ; D = X (copia)
2898+ AB47
2899+ AB47 3A 4C 86         ld   a,(Var_Game_MoveTmpDir)
2900+ AB4A FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2901+ AB4C 20 12            jr   nz,.chk_west_limit
2902+ AB4E
2903+ AB4E                  ; ---- direzione EST ----
2904+ AB4E 79               ld   a,c              ; ID
2905+ AB4F B7               or   a
2906+ AB50 20 06            jr   nz,.not_gk_east  ; ID != 0 => non portiere
2907+ AB52                  ; Portiere: limite destro X=3
2908+ AB52 7A               ld   a,d
2909+ AB53 FE 03            cp   3
2910+ AB55 CA 54 AC         jp   z,.fail_exit
2911+ AB58
2912+ AB58              .not_gk_east:
2913+ AB58 7A               ld   a,d
2914+ AB59 FE 04            cp   4                ; X == 4?
2915+ AB5B CA 54 AC         jp   z,.fail_exit     ; bordo destro campo
2916+ AB5E 18 0F            jr   .compute_adjacent
2917+ AB60
2918+ AB60              .chk_west_limit:
2919+ AB60                  ; ---- direzione OVEST ----
2920+ AB60 79               ld   a,c
2921+ AB61 B7               or   a
2922+ AB62 20 06            jr   nz,.not_gk_west
2923+ AB64                  ; Portiere: limite sinistro X=1
2924+ AB64 7A               ld   a,d
2925+ AB65 FE 01            cp   1
2926+ AB67 CA 54 AC         jp   z,.fail_exit
2927+ AB6A
2928+ AB6A              .not_gk_west:
2929+ AB6A 7A               ld   a,d
2930+ AB6B B7               or   a                ; X==0?
2931+ AB6C CA 54 AC         jp   z,.fail_exit     ; bordo sinistro campo
2932+ AB6F
2933+ AB6F                  ; --- 3) Calcolo colonna adiacente e controllo occupante ---
2934+ AB6F              .compute_adjacent:
2935+ AB6F 5A               ld   e,d              ; E = X corrente
2936+ AB70 3A 4C 86         ld   a,(Var_Game_MoveTmpDir)
2937+ AB73 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2938+ AB75 20 08            jr   nz,.adj_west
2939+ AB77 1C               inc  e                ; X+1
2940+ AB78 7B               LD   A, E
2941+ AB79 3C               INC     A
2942+ AB7A 32 5A 86         LD   (Var_Game_TmpMoveCompanionX), A
2943+ AB7D 18 06            jr   .adj_done
2944+ AB7F              .adj_west:
2945+ AB7F 1D               dec  e                ; X-1
2946+ AB80 7B               LD   A, E
2947+ AB81 3D               DEC     A
2948+ AB82 32 5A 86         LD   (Var_Game_TmpMoveCompanionX), A
2949+ AB85              .adj_done:
2950+ AB85
2951+ AB85                  ; Game_GetPlayerInfoByPos: D = Y, E = X
2952+ AB85 7C               ld   a,h
2953+ AB86 57               ld   d,a              ; D = Y
2954+ AB87                  ; E = colonna adiacente
2955+ AB87
2956+ AB87 CD DF A2         call Game_GetPlayerInfoByPos
2957+ AB8A FE FF            cp   NO_VALUE
2958+ AB8C 28 56            jr   z,.adjacent_free     ; nessun giocatore -> cella libera
2959+ AB8E 79               ld   a, c
2960+ AB8F 32 59 86         ld   (Var_Game_TmpMoveCompanionId),a
2961+ AB92                  ; --- 3b) C'è un compagno nella cella adiacente: B=TEAM_occ, C=ID_occ ---
2962+ AB92                  ; Verifica che non abbia la palla e prova a spostarlo ricorsivamente.
2963+ AB92
2964+ AB92                  ; Salviamo B_occ,C_occ su stack
2965+ AB92 C5               push bc                   ; [SP] = BC_occ, sotto BC0,HL0
2966+ AB93
2967+ AB93                  ; Controlla possesso palla del giocatore adiacente
2968+ AB93 CD 01 A7         call Game_GetPlayerIdWithBall  ; A=TEAM_* o BALL_STATUS_*, H=ID
2969+ AB96
2970+ AB96                  ; Ripristiniamo BC_occ
2971+ AB96 C1               pop  bc                   ; BC = TEAM_occ,ID_occ
2972+ AB97
2973+ AB97                  ; Se A è TEAM_BLACK o TEAM_WHITE e coincide con B_occ,
2974+ AB97                  ; e H coincide con ID_occ, allora quel giocatore ha la palla -> FAIL.
2975+ AB97 3A 4C 86         ld   a,(Var_Game_MoveTmpDir)   ; A usato dopo, salviamo TEAM occ in D/E
2976+ AB9A 50               ld   d,b                   ; D = TEAM_occ
2977+ AB9B 59               ld   e,c                   ; E = ID_occ
2978+ AB9C
2979+ AB9C                  ; ATTENZIONE: GetPlayerIdWithBall ha già sovrascritto A,
2980+ AB9C                  ; perciò rileggo dal luogo giusto:
2981+ AB9C                  ;  - Team/Status era in A al RETURN -> lo abbiamo perso, quindi
2982+ AB9C                  ;    rifacciamo la chiamata e subito dopo il confronto.
2983+ AB9C
2984+ AB9C                  ; Rifaccio la chiamata per avere A,H aggiornati
2985+ AB9C CD 01 A7         call Game_GetPlayerIdWithBall   ; A=TEAM_* o BALL_STATUS_*, H=ID
2986+ AB9F
2987+ AB9F FE 65            cp   BALL_STATUS_CONTENDED
2988+ ABA1 20 03            jr   nz,.adj_done_not_contended
2989+ ABA3 3A 56 86         ld   a, (Var_Game_TmpMoveTeam)
2990+ ABA6              .adj_done_not_contended:
2991+ ABA6                  ; Se A non è un TEAM, non è possesso
2992+ ABA6 FE 00            cp   TEAM_BLACK
2993+ ABA8 28 04            jr   z,.check_owner_team
2994+ ABAA FE 01            cp   TEAM_WHITE
2995+ ABAC 20 0E            jr   nz,.no_owner_companion
2996+ ABAE
2997+ ABAE              .check_owner_team:
2998+ ABAE 57               LD   D, A
2999+ ABAF 3A 56 86         LD   A, (Var_Game_TmpMoveTeam)
3000+ ABB2 BA               cp   d                     ; A == D (TEAM_occ)?
3001+ ABB3 20 07            jr   nz,.no_owner_companion
3002+ ABB5 3A 59 86         ld   a, (Var_Game_TmpMoveCompanionId)
3003+ ABB8 BC               cp   h                     ; H == ID_occ?
3004+ ABB9 CA 54 AC         jp   z,.fail_exit          ; quel compagno ha la palla -> non si spinge
3005+ ABBC
3006+ ABBC              .no_owner_companion:
3007+ ABBC                  ; Possiamo provare a spostare il compagno ricorsivamente
3008+ ABBC
3009+ ABBC 3A 59 86         ld a,(Var_Game_TmpMoveCompanionId)
3010+ ABBF 4F               ld c, a
3011+ ABC0 3A 56 86         ld a, (Var_Game_TmpMoveTeam)
3012+ ABC3 47               ld b, a
3013+ ABC4 3A 5A 86         ld a, (Var_Game_TmpMoveCompanionX)
3014+ ABC7 5F               ld e, a
3015+ ABC8 FE FF            CP  255
3016+ ABCA CA 54 AC         JP  Z, .fail_exit
3017+ ABCD FE 05            CP  5
3018+ ABCF CA 54 AC         JP  Z, .fail_exit
3019+ ABD2 3A 5B 86         ld a, (Var_Game_TmpMoveRow)
3020+ ABD5 57               ld d, a                   ; D=Y, E=X del compagno
3021+ ABD6 CD 9D A2         call SetPlayerInfo
3022+ ABD9 3A 56 86         ld a, (Var_Game_TmpMoveTeam)
3023+ ABDC 47               ld b, a
3024+ ABDD 3A 59 86         ld a,(Var_Game_TmpMoveCompanionId)
3025+ ABE0 4F               ld c, a
3026+ ABE1 CD 1C A3         call Game_ClearSinglePlayerPrevPositions
3027+ ABE4                  ;jr   nz,.fail_exit         ; se il compagno non si può muovere -> FAIL
3028+ ABE4
3029+ ABE4                  ; Se siamo qui, la cella adiacente è diventata libera
3030+ ABE4              .adjacent_free:
3031+ ABE4
3032+ ABE4                  ; --- 4) Cella adiacente libera: decide se spostare anche la palla ---
3033+ ABE4                  ; Rilegge possesso palla DOPO eventuale movimento dei compagni
3034+ ABE4
3035+ ABE4
3036+ ABE4                  ; Recupera TEAM/ID e posizione corrente di QUESTO giocatore
3037+ ABE4                  ; (prima di muoverlo) dal frame su stack
3038+ ABE4 C1               pop  bc                    ; BC0 = TEAM,ID del giocatore chiamante
3039+ ABE5 E1               pop  hl                    ; HL0 = pos corrente (H=Y, L=X)
3040+ ABE6
3041+ ABE6 3A 57 86         ld   a, (Var_Game_TmpMoveId)
3042+ ABE9 4F               ld   c, a
3043+ ABEA
3044+ ABEA C5               push bc
3045+ ABEB CD 01 A7         call Game_GetPlayerIdWithBall   ; A=status/TEAM, H=ID possessore (o 255)
3046+ ABEE C1               pop  bc
3047+ ABEF
3048+ ABEF
3049+ ABEF                  ; A e H sono ancora quelli di GetPlayerIdWithBall
3050+ ABEF
3051+ ABEF                  ; Caso 1: palla contesa -> muoviamo palla
3052+ ABEF FE 65            cp   BALL_STATUS_CONTENDED
3053+ ABF1 28 07            jr   z,.move_ball
3054+ ABF3
3055+ ABF3                  ; Caso 2: A è TEAM del giocatore ed H è il suo ID -> possiede palla
3056+ ABF3 B8               cp   b
3057+ ABF4 20 3F            jr   nz,.no_ball_move
3058+ ABF6 7C               ld   a,h
3059+ ABF7 B9               cp   c
3060+ ABF8 20 3B            jr   nz,.no_ball_move
3061+ ABFA              .move_ball:
3062+ ABFA 3A 5C 86         ld   a, (Var_Game_TmpMovStartCol)
3063+ ABFD CD FD A1         call Game_GetBallPosition
3064+ AC00 BB               cp   e
3065+ AC01 20 32            jr   nz,.no_ball_move      ; palla non nella stessa colonna -> non muovo palla
3066+ AC03
3067+ AC03
3068+ AC03
3069+ AC03                  ; Sposta la palla di una colonna nella stessa direzione del movimento
3070+ AC03                  ; (Y invariato, X +/- 1 se dentro 0..4)
3071+ AC03 CD FD A1         call Game_GetBallPosition
3072+ AC06 3A 56 86         LD    A, (Var_Game_TmpMoveTeam)
3073+ AC09 FE 00            CP   TEAM_BLACK
3074+ AC0B 28 09            JR   Z,.mb_ckblack
3075+ AC0D              .mb_ckwhite:
3076+ AC0D 3A 5B 86         LD  A,(Var_Game_TmpMoveRow)
3077+ AC10 3D               DEC A
3078+ AC11 BA               CP  D
3079+ AC12 20 21            JR  NZ,.no_ball_move      ; fuori campo -> non muovo palla
3080+ AC14 18 06            JR  .mb_continue
3081+ AC16              .mb_ckblack:
3082+ AC16 3A 5B 86         LD  A,(Var_Game_TmpMoveRow)
3083+ AC19 BA               CP  D
3084+ AC1A 20 19            JR  NZ,.no_ball_move      ; fuori campo -> non muovo palla
3085+ AC1C              .mb_continue:
3086+ AC1C 3A 4C 86         ld   a,(Var_Game_MoveTmpDir)
3087+ AC1F FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
3088+ AC21 20 09            jr   nz,.ball_west
3089+ AC23
3090+ AC23                  ; EST
3091+ AC23 7B               ld   a,e
3092+ AC24 3C               inc  a
3093+ AC25 FE 05            cp   5
3094+ AC27 30 0C            jr   nc,.no_ball_move      ; fuori campo -> non muovo palla
3095+ AC29 5F               ld   e,a
3096+ AC2A 18 06            jr   .do_set_ball
3097+ AC2C
3098+ AC2C              .ball_west:
3099+ AC2C                  ; OVEST
3100+ AC2C 7B               ld   a,e
3101+ AC2D B7               or   a
3102+ AC2E 28 05            jr   z,.no_ball_move       ; già a 0 -> non muovo palla
3103+ AC30 3D               dec  a
3104+ AC31 5F               ld   e,a
3105+ AC32
3106+ AC32              .do_set_ball:
3107+ AC32
3108+ AC32
3109+ AC32 CD 08 A2         call Game_SetBallPosition
3110+ AC35
3111+ AC35              .no_ball_move:
3112+ AC35                  ; --- 5) Sposta il giocatore orizzontalmente ---
3113+ AC35                  ; HL contiene ancora la posizione del giocatore (da poco poppata)
3114+ AC35                  ; Se non fosse più valida, la ricalcoliamo:
3115+ AC35                  ;   B=TEAM, C=ID sono già corretti.
3116+ AC35 3A 57 86         LD  A, (Var_Game_TmpMoveId)
3117+ AC38 4F               LD  C, A
3118+ AC39                  ; (riotteniamo posizione nel dubbio)
3119+ AC39 CD C4 A2         call Game_GetPlayerInfoById     ; HL = pos aggiornata (dovrebbe essere la stessa)
3120+ AC3C
3121+ AC3C 54               ld   d,h                   ; D = Y (invariato)
3122+ AC3D 5D               ld   e,l                   ; E = X
3123+ AC3E
3124+ AC3E 3A 4C 86         ld   a,(Var_Game_MoveTmpDir)
3125+ AC41 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
3126+ AC43 20 03            jr   nz,.player_west
3127+ AC45 1C               inc  e
3128+ AC46 18 01            jr   .do_set_player
3129+ AC48
3130+ AC48              .player_west:
3131+ AC48 1D               dec  e
3132+ AC49
3133+ AC49              .do_set_player:
3134+ AC49                  ; D=Y, E=newX, B=TEAM, C=ID
3135+ AC49 CD 9D A2         call SetPlayerInfo
3136+ AC4C 3E 01            LD     A, YES
3137+ AC4E 32 C0 86         LD     (Var_Hooks_ForceVdpRedraw), A
3138+ AC51 3E 01            ld   a,SUCCESS
3139+ AC53 C9               ret
3140+ AC54
3141+ AC54              .fail_exit:
3142+ AC54                  ; Fallimento: svuota il frame locale (BC0,HL0) e ritorna FAILURE
3143+ AC54 C1               pop  bc        ; scarta BC0 (TEAM/ID di questo livello)
3144+ AC55 E1               pop  hl        ; scarta HL0 (pos)
3145+ AC56 3E 00            ld   a,FAILURE
3146+ AC58 C9               ret
3147+ AC59
3148+ AC59
3149+ AC59
3150+ AC59              ; ---------------------------------------------------------------------------
3151+ AC59              ; Black team horizontal move left asked
3152+ AC59              ; INPUT A: Direction
3153+ AC59              ; ---------------------------------------------------------------------------
3154+ AC59              Game_BlackTeamHorizMoveAsked:
3155+ AC59 32 4C 86         LD      (Var_Game_MoveTmpDir),A
3156+ AC5C
3157+ AC5C 3A 73 86         LD      A, (Var_Game_BallYPosition)
3158+ AC5F 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3159+ AC62
3160+ AC62 3A 66 86         LD      A, (Var_Game_BallDirection)
3161+ AC65 FE 00            CP      BALL_DIRECTION_NONE
3162+ AC67 28 36            JR      Z, .after_row_choice
3163+ AC69
3164+ AC69 FE 01            CP      BALL_DIRECTION_NORTH
3165+ AC6B 28 1D            JR      Z, .north_direction
3166+ AC6D FE 02            CP      BALL_DIRECTION_NORTH_EAST
3167+ AC6F 28 19            JR      Z, .north_direction
3168+ AC71 FE 03            CP      BALL_DIRECTION_NORTH_WEST
3169+ AC73 28 15            JR      Z, .north_direction
3170+ AC75              .south_direction:
3171+ AC75 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3172+ AC78 FE 00            CP      FIELD_SOUTH_SIDE
3173+ AC7A 28 07            JR      Z, .south_direction_south_side
3174+ AC7C              .south_direction_north_side:
3175+ AC7C 3E 03            LD      A, 3
3176+ AC7E 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3177+ AC81 18 1C            JR      .after_row_choice
3178+ AC83              .south_direction_south_side:
3179+ AC83 3E 02            LD      A, 2
3180+ AC85 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3181+ AC88 18 15            JR      .after_row_choice
3182+ AC8A              .north_direction:
3183+ AC8A 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3184+ AC8D FE 00            CP      FIELD_SOUTH_SIDE
3185+ AC8F 28 07            JR      Z, .north_direction_south_side
3186+ AC91              .north_direction_north_side:
3187+ AC91 3E 02            LD      A, 2
3188+ AC93 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3189+ AC96 18 07            JR      .after_row_choice
3190+ AC98              .north_direction_south_side:
3191+ AC98 3E 00            LD      A, 0
3192+ AC9A 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3193+ AC9D 18 00            JR      .after_row_choice
3194+ AC9F
3195+ AC9F              .after_row_choice:
3196+ AC9F 3E 00            LD      A, NO
3197+ ACA1 32 5E 86         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3198+ ACA4 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3199+ ACA7 FE 01            CP      PLAYER_ASKED_DIRECTION_EAST
3200+ ACA9 28 05            JR      Z, .AfterSort
3201+ ACAB 3E 01            LD      A, YES
3202+ ACAD 32 5E 86         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3203+ ACB0              .AfterSort:
3204+ ACB0 CD 01 A7         CALL    Game_GetPlayerIdWithBall
3205+ ACB3 FE 00            CP      TEAM_BLACK
3206+ ACB5 CA E7 AC         JP      Z,.WithBallPossession
3207+ ACB8 FE 65            CP      BALL_STATUS_CONTENDED
3208+ ACBA CA DF AC         JP      Z,.ContendedBall
3209+ ACBD
3210+ ACBD 3A 5D 86         LD      A, (Var_Game_TmpAskedMovingRow)
3211+ ACC0 CD 22 B0         CALL    GetAllPlayersOnARow
3212+ ACC3 C5               PUSH    BC
3213+ ACC4 48               LD      C, B
3214+ ACC5 06 00            LD      B, TEAM_BLACK
3215+ ACC7 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3216+ ACCA CD 20 AB         CALL    Game_TryMovePlayerHorizontally
3217+ ACCD C1               POP     BC
3218+ ACCE 79               LD      A, C
3219+ ACCF FE FF            CP      NO_VALUE
3220+ ACD1 20 02            JR      NZ, .NoBallPossessionSecondPlayer
3221+ ACD3 18 1F            JR      .Done
3222+ ACD5              .NoBallPossessionSecondPlayer:
3223+ ACD5 06 00            LD      B, TEAM_BLACK
3224+ ACD7 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3225+ ACDA CD 20 AB         CALL    Game_TryMovePlayerHorizontally
3226+ ACDD 18 15            JR      .Done
3227+ ACDF
3228+ ACDF
3229+ ACDF              .ContendedBall:
3230+ ACDF CD FD A1         CALL    Game_GetBallPosition
3231+ ACE2 CD DF A2         CALL    Game_GetPlayerInfoByPos
3232+ ACE5 79               LD      A, C
3233+ ACE6 67               LD      H, A
3234+ ACE7              .WithBallPossession:
3235+ ACE7 7C               LD      A, H
3236+ ACE8 FE FF            CP      NO_VALUE
3237+ ACEA C8               RET     Z
3238+ ACEB 4F               LD      C, A
3239+ ACEC 06 00            LD      B, TEAM_BLACK
3240+ ACEE 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3241+ ACF1 CD 20 AB         CALL    Game_TryMovePlayerHorizontally
3242+ ACF4              .Done:
3243+ ACF4 C9               RET
3244+ ACF5              ; ---------------------------------------------------------------------------
3245+ ACF5              ; White team horizontal move left asked
3246+ ACF5              ; INPUT A: Direction
3247+ ACF5              ; ---------------------------------------------------------------------------
3248+ ACF5              Game_WhiteTeamHorizMoveAsked:
3249+ ACF5 32 4C 86         LD      (Var_Game_MoveTmpDir),A
3250+ ACF8
3251+ ACF8 3A 73 86         LD      A, (Var_Game_BallYPosition)
3252+ ACFB 3C               INC     A
3253+ ACFC 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3254+ ACFF
3255+ ACFF 3A 66 86         LD      A, (Var_Game_BallDirection)
3256+ AD02 FE 00            CP      BALL_DIRECTION_NONE
3257+ AD04 28 36            JR      Z, .after_row_choice
3258+ AD06
3259+ AD06 FE 01            CP      BALL_DIRECTION_NORTH
3260+ AD08 28 1D            JR      Z, .north_direction
3261+ AD0A FE 02            CP      BALL_DIRECTION_NORTH_EAST
3262+ AD0C 28 19            JR      Z, .north_direction
3263+ AD0E FE 03            CP      BALL_DIRECTION_NORTH_WEST
3264+ AD10 28 15            JR      Z, .north_direction
3265+ AD12              .south_direction:
3266+ AD12 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3267+ AD15 FE 00            CP      FIELD_SOUTH_SIDE
3268+ AD17 28 07            JR      Z, .south_direction_south_side
3269+ AD19              .south_direction_north_side:
3270+ AD19 3E 02            LD      A, 2
3271+ AD1B 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3272+ AD1E 18 1C            JR      .after_row_choice
3273+ AD20              .south_direction_south_side:
3274+ AD20 3E 03            LD      A, 3
3275+ AD22 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3276+ AD25 18 15            JR      .after_row_choice
3277+ AD27              .north_direction:
3278+ AD27 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3279+ AD2A FE 00            CP      FIELD_SOUTH_SIDE
3280+ AD2C 28 07            JR      Z, .north_direction_south_side
3281+ AD2E              .north_direction_north_side:
3282+ AD2E 3E 02            LD      A, 2
3283+ AD30 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3284+ AD33 18 07            JR      .after_row_choice
3285+ AD35              .north_direction_south_side:
3286+ AD35 3E 01            LD      A, 1
3287+ AD37 32 5D 86         LD      (Var_Game_TmpAskedMovingRow), A
3288+ AD3A 18 00            JR      .after_row_choice
3289+ AD3C
3290+ AD3C              .after_row_choice:
3291+ AD3C
3292+ AD3C 3E 00            LD      A, NO
3293+ AD3E 32 5E 86         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3294+ AD41 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3295+ AD44 FE 01            CP      PLAYER_ASKED_DIRECTION_EAST
3296+ AD46 28 05            JR      Z, .AfterSort
3297+ AD48 3E 01            LD      A, YES
3298+ AD4A 32 5E 86         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3299+ AD4D              .AfterSort:
3300+ AD4D CD 01 A7         CALL    Game_GetPlayerIdWithBall
3301+ AD50 FE 01            CP      TEAM_WHITE
3302+ AD52 CA 85 AD         JP      Z,.WithBallPossession
3303+ AD55 FE 65            CP      BALL_STATUS_CONTENDED
3304+ AD57 CA 7C AD         JP      Z,.ContendedBall
3305+ AD5A
3306+ AD5A 3A 5D 86         LD      A, (Var_Game_TmpAskedMovingRow)
3307+ AD5D CD 22 B0         CALL    GetAllPlayersOnARow
3308+ AD60 C5               PUSH    BC
3309+ AD61 48               LD      C, B
3310+ AD62 06 01            LD      B, TEAM_WHITE
3311+ AD64 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3312+ AD67 CD 20 AB         CALL    Game_TryMovePlayerHorizontally
3313+ AD6A C1               POP     BC
3314+ AD6B 79               LD      A, C
3315+ AD6C FE FF            CP      NO_VALUE
3316+ AD6E 20 02            JR      NZ, .NoBallPossessionSecondPlayer
3317+ AD70 18 20            JR      .Done
3318+ AD72              .NoBallPossessionSecondPlayer:
3319+ AD72 06 01            LD      B, TEAM_WHITE
3320+ AD74 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3321+ AD77 CD 20 AB         CALL    Game_TryMovePlayerHorizontally
3322+ AD7A 18 16            JR      .Done
3323+ AD7C
3324+ AD7C              .ContendedBall:
3325+ AD7C CD FD A1         CALL    Game_GetBallPosition
3326+ AD7F 14               INC     D
3327+ AD80 CD DF A2         CALL    Game_GetPlayerInfoByPos
3328+ AD83 79               LD      A, C
3329+ AD84 67               LD      H, A
3330+ AD85              .WithBallPossession:
3331+ AD85 7C               LD      A, H
3332+ AD86 FE FF            CP      NO_VALUE
3333+ AD88 C8               RET     Z
3334+ AD89 4F               LD      C, A
3335+ AD8A 06 01            LD      B, TEAM_WHITE
3336+ AD8C 3A 4C 86         LD      A, (Var_Game_MoveTmpDir)
3337+ AD8F CD 20 AB         CALL    Game_TryMovePlayerHorizontally
3338+ AD92              .Done:
3339+ AD92 C9               RET
3340+ AD93
3341+ AD93              ; -----------------------------------------------------------
3342+ AD93              ; Show game over
3343+ AD93              ;
3344+ AD93              ; INPUT: -
3345+ AD93              ; OUTPUT: -
3346+ AD93              ; MODIFIES:
3347+ AD93              ;   A, HL, BC
3348+ AD93              ; -----------------------------------------------------------
3349+ AD93              Game_GameOver:
3350+ AD93 CD F7 86         CALL    Hooks_TickStop
3351+ AD96 3E 00            LD      A, NO
3352+ AD98 32 6B 86         LD      (Var_Game_MatchInProgress), A
3353+ AD9B 26 00            LD      H, 0
3354+ AD9D 2E 00            LD      L, 0
3355+ AD9F 11 3E 86         LD      DE, Var_Utils_NumberToPrint
3356+ ADA2 CD 6A 9F         CALL    String_NumberToASCII
3357+ ADA5 21 3E 86         LD      HL, Var_Utils_NumberToPrint
3358+ ADA8 CD 8E 9F         CALL    String_RemoveLeadingZeros
3359+ ADAB 21 3E 86         LD      HL, Var_Utils_NumberToPrint
3360+ ADAE 16 01            LD      D, 1
3361+ ADB0 1E 17            LD      E, 23
3362+ ADB2 CD 1A 95         CALL    VDP_PrintString
3363+ ADB5
3364+ ADB5 21 60 9F         LD      HL, TXT_GAME_OVER
3365+ ADB8 16 0A            LD      D, 10
3366+ ADBA 1E 06            LD      E, 6
3367+ ADBC CD 1A 95         CALL    VDP_PrintString
3368+ ADBF FB               EI
3369+ ADC0              .Loop:
3370+ ADC0 CD AF 9F         CALL    Utils_ReadKeyboard
3371+ ADC3 FE 20            CP      KBD_KEY_SPACE   ; KBD
3372+ ADC5 20 F9            JR      NZ, .Loop
3373+ ADC7 CD 1C 9D         CALL    Menu_Show
3374+ ADCA C3 30 B5         JP      MainLoop
3375+ ADCD
3376+ ADCD              ; ---------------------------------------------------------------------------
3377+ ADCD              ; Game_CheckStoppedBallOnGoalOrCorner
3378+ ADCD              ;
3379+ ADCD              ; Esegue controlli SOLO se la palla è ferma (BALL_DIRECTION_NONE).
3380+ ADCD              ; Se la palla è sulla riga di fondo/porta del campo attivo:
3381+ ADCD              ;   - X=0 o X=4  -> BallIsInCornerArea
3382+ ADCD              ;   - X=1..3     -> se portiere sulla stessa cella: BallIsInGoalkeeperHands
3383+ ADCD              ;                  altrimenti: BallIsInGoal
3384+ ADCD              ;
3385+ ADCD              ; Usa:
3386+ ADCD              ;   Var_Game_BallDirection
3387+ ADCD              ;   Var_Game_ActiveFieldSide
3388+ ADCD              ;   Game_GetBallPosition      -> DE (D=Y, E=X)
3389+ ADCD              ;   Game_GetPlayerInfoById    -> HL cur (H=Y, L=X)
3390+ ADCD              ;
3391+ ADCD              ; MODIFIES: AF,BC,DE,HL
3392+ ADCD              ; ---------------------------------------------------------------------------
3393+ ADCD              Game_CheckStoppedBallOnGoalOrCorner:
3394+ ADCD F5               push af
3395+ ADCE C5               push bc
3396+ ADCF D5               push de
3397+ ADD0 E5               push hl
3398+ ADD1
3399+ ADD1                  ; Solo se palla ferma
3400+ ADD1 3A 66 86         ld   a,(Var_Game_BallDirection)
3401+ ADD4 FE 00            cp   BALL_DIRECTION_NONE
3402+ ADD6 20 5C            jr   nz,.done
3403+ ADD8
3404+ ADD8              ;    ; Solo se palla ferma
3405+ ADD8              ;    ld   a,(Var_Hooks_BlinkingIsActive)
3406+ ADD8              ;    cp   YES
3407+ ADD8              ;    jr   z,.done
3408+ ADD8
3409+ ADD8                  ; Leggi posizione palla: D=Y, E=X
3410+ ADD8 CD FD A1         call Game_GetBallPosition
3411+ ADDB
3412+ ADDB                  ; Determina se siamo su riga di fondo/porta del campo attivo
3413+ ADDB 3A 46 86         ld   a,(Var_Game_ActiveFieldSide)
3414+ ADDE FE 00            cp   FIELD_SOUTH_SIDE
3415+ ADE0 20 28            jr   nz,.field_north
3416+ ADE2
3417+ ADE2              ; ===== CAMPO SOUTH: fondo/porta è riga 4 =====
3418+ ADE2              .field_south:
3419+ ADE2 7A               ld   a,d
3420+ ADE3 FE 04            cp   4
3421+ ADE5 20 4D            jr   nz,.done
3422+ ADE7
3423+ ADE7                  ; Se X=0 o 4 -> corner
3424+ ADE7 7B               ld   a,e
3425+ ADE8 B7               or   a
3426+ ADE9 28 46            jr   z,.corner
3427+ ADEB FE 04            cp   4
3428+ ADED 28 42            jr   z,.corner
3429+ ADEF
3430+ ADEF                  ; X=1..3 -> verifica portiere BIANCO (TEAM_WHITE, ID=0)
3431+ ADEF 06 01            ld   b,TEAM_WHITE
3432+ ADF1 0E 00            ld   c,0
3433+ ADF3 D5               push de                  ; salva palla
3434+ ADF4 CD C4 A2         call Game_GetPlayerInfoById   ; HL = cur (H=Y, L=X)
3435+ ADF7 D1               pop  de
3436+ ADF8
3437+ ADF8 7C               ld   a,h
3438+ ADF9 BA               cp   d
3439+ ADFA 20 09            jr   nz,.goal
3440+ ADFC 7D               ld   a,l
3441+ ADFD BB               cp   e
3442+ ADFE 20 05            jr   nz,.goal
3443+ AE00
3444+ AE00 CD 8D AE         call BallIsInGoalkeeperHands
3445+ AE03 18 2F            jr   .done
3446+ AE05
3447+ AE05              .goal:
3448+ AE05 CD 3A AE         call BallIsInGoal
3449+ AE08 18 2A            jr   .done
3450+ AE0A
3451+ AE0A              ; ===== CAMPO NORTH: fondo/porta è riga 0 =====
3452+ AE0A              .field_north:
3453+ AE0A 7A               ld   a,d
3454+ AE0B B7               or   a
3455+ AE0C 20 26            jr   nz,.done
3456+ AE0E
3457+ AE0E                  ; Se X=0 o 4 -> corner
3458+ AE0E 7B               ld   a,e
3459+ AE0F B7               or   a
3460+ AE10 28 1F            jr   z,.corner
3461+ AE12 FE 04            cp   4
3462+ AE14 28 1B            jr   z,.corner
3463+ AE16
3464+ AE16                  ; X=1..3 -> verifica portiere NERO (TEAM_BLACK, ID=0)
3465+ AE16 06 00            ld   b,TEAM_BLACK
3466+ AE18 0E 00            ld   c,0
3467+ AE1A D5               push de
3468+ AE1B CD C4 A2         call Game_GetPlayerInfoById
3469+ AE1E D1               pop  de
3470+ AE1F
3471+ AE1F 7C               ld   a,h
3472+ AE20 BA               cp   d
3473+ AE21 20 09            jr   nz,.goal2
3474+ AE23 7D               ld   a,l
3475+ AE24 BB               cp   e
3476+ AE25 20 05            jr   nz,.goal2
3477+ AE27
3478+ AE27 CD 8D AE         call BallIsInGoalkeeperHands
3479+ AE2A 18 08            jr   .done
3480+ AE2C
3481+ AE2C              .goal2:
3482+ AE2C CD 3A AE         call BallIsInGoal
3483+ AE2F 18 03            jr   .done
3484+ AE31
3485+ AE31              .corner:
3486+ AE31 CD 75 AE         call BallIsInCornerArea
3487+ AE34
3488+ AE34              .done:
3489+ AE34 E1               pop  hl
3490+ AE35 D1               pop  de
3491+ AE36 C1               pop  bc
3492+ AE37 F1               pop  af
3493+ AE38 C9               ret
3494+ AE39
3495+ AE39              ; ---------------------------------------------------------------------------
3496+ AE39              ; Game_GoalCerimony
3497+ AE39              ; ----------------------------------------------------------------------------
3498+ AE39              Game_GoalCerimony:
3499+ AE39 C9               RET
3500+ AE3A              ; ---------------------------------------------------------------------------
3501+ AE3A              ; BallIsInGoal
3502+ AE3A              ; ----------------------------------------------------------------------------
3503+ AE3A              BallIsInGoal:
3504+ AE3A CD 13 8E         CALL    Hooks_UpdateTimeToPlay
3505+ AE3D CD F7 86         CALL    Hooks_TickStop
3506+ AE40
3507+ AE40 3E 40            LD      A, TILE_BALL_BOTTOM
3508+ AE42 47               LD      B, A
3509+ AE43 3E D6            LD      A, TILE_FIELD
3510+ AE45 4F               LD      C, A
3511+ AE46 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3512+ AE49 FE 01            CP      FIELD_NORTH_SIDE
3513+ AE4B 20 1F            JR      NZ, .BlackGoal
3514+ AE4D 3E 03            LD      A, TILE_CORNER_BALL
3515+ AE4F 47               LD      B, A
3516+ AE50 3A 62 86         LD      A, (Var_Game_ScoreWhite)
3517+ AE53 3C               INC     A
3518+ AE54 32 62 86         LD     (Var_Game_ScoreWhite), A
3519+ AE57              .TileBlinking:
3520+ AE57 D5               PUSH    DE
3521+ AE58 C5               PUSH    BC
3522+ AE59 E5               PUSH    HL
3523+ AE5A CD BB 9C         CALL    VDP_ShowScores
3524+ AE5D E1               POP     HL
3525+ AE5E C1               POP     BC
3526+ AE5F D1               POP     DE
3527+ AE60 3E 01            LD      A, BLINK_TYPE_GOAL
3528+ AE62 32 B5 86         LD     (Var_Hooks_BlinkingType), A
3529+ AE65 CD AF AE         CALL    BlinkTileAtPosition
3530+ AE68 CD 5E B4         call    Game_PlayBeepGoalCorner
3531+ AE6B C9               RET
3532+ AE6C              .BlackGoal:
3533+ AE6C 3A 55 86         LD      A, (Var_Game_ScoreBlack)
3534+ AE6F 3C               INC     A
3535+ AE70 32 55 86         LD     (Var_Game_ScoreBlack), A
3536+ AE73 18 E2            JR      .TileBlinking
3537+ AE75              ; ---------------------------------------------------------------------------
3538+ AE75              ; BallIsInCornerArea
3539+ AE75              ; ----------------------------------------------------------------------------
3540+ AE75              BallIsInCornerArea:
3541+ AE75 CD 13 8E         CALL    Hooks_UpdateTimeToPlay
3542+ AE78 CD F7 86         CALL    Hooks_TickStop
3543+ AE7B 3E 03            LD      A, TILE_CORNER_BALL
3544+ AE7D 47               LD      B, A
3545+ AE7E 3E 04            LD      A, TILE_CORNER_BALL_EMPTY
3546+ AE80 4F               LD      C, A
3547+ AE81              .TileBlinking:
3548+ AE81 3E 02            LD      A, BLINK_TYPE_CORNER
3549+ AE83 32 B5 86         LD     (Var_Hooks_BlinkingType), A
3550+ AE86 CD AF AE         CALL    BlinkTileAtPosition
3551+ AE89 CD 5E B4         call    Game_PlayBeepGoalCorner
3552+ AE8C C9               RET
3553+ AE8D              ; ---------------------------------------------------------------------------
3554+ AE8D              ; BallIsInGoalkeeperHands
3555+ AE8D              ; ----------------------------------------------------------------------------
3556+ AE8D              BallIsInGoalkeeperHands:
3557+ AE8D CD 13 8E         CALL    Hooks_UpdateTimeToPlay
3558+ AE90 CD F7 86         CALL    Hooks_TickStop
3559+ AE93 3E 70            LD      A, TILE_WHITE_GOALKEEPER_WITH_BALL
3560+ AE95 47               LD      B, A
3561+ AE96 3E D6            LD      A, TILE_FIELD
3562+ AE98 4F               LD      C, A
3563+ AE99 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3564+ AE9C FE 01            CP      FIELD_NORTH_SIDE
3565+ AE9E 20 03            JR      NZ, .TileBlinking
3566+ AEA0 3E 90            LD      A, TILE_BLACK_GOALKEEPER_WITH_BALL
3567+ AEA2 47               LD      B, A
3568+ AEA3              .TileBlinking:
3569+ AEA3 3E 03            LD      A, BLINK_TYPE_GOALKEEPER
3570+ AEA5 32 B5 86         LD     (Var_Hooks_BlinkingType), A
3571+ AEA8 CD AF AE         CALL    BlinkTileAtPosition
3572+ AEAB CD 5E B4         call    Game_PlayBeepGoalCorner
3573+ AEAE C9               RET
3574+ AEAF              ; ---------------------------------------------------------------------------
3575+ AEAF              ; BlinkTileAtPosition
3576+ AEAF              ;INPUT: B: tile to show - C: tile to hide
3577+ AEAF              ; ----------------------------------------------------------------------------
3578+ AEAF              BlinkTileAtPosition:
3579+ AEAF 32 B5 86         LD     (Var_Hooks_BlinkingType), A
3580+ AEB2 AF               XOR    A
3581+ AEB3 32 B9 86         LD     (Var_Hooks_BlinkingCounter), A
3582+ AEB6 32 B9 86         LD     (Var_Hooks_BlinkingCounter), A
3583+ AEB9 78               LD     A, B
3584+ AEBA 32 B6 86         LD     (Var_Hooks_BlinkingTileToShow), A
3585+ AEBD 79               LD     A, C
3586+ AEBE 32 B7 86         LD     (Var_Hooks_BlinkingTileToHide), A
3587+ AEC1 78               LD     A, B
3588+ AEC2 32 B8 86         LD     (Var_Hooks_BlinkingActiveTile), A
3589+ AEC5 3E 01            LD     A, YES
3590+ AEC7 32 BD 86         LD     (Var_Hooks_BlinkingMustResetFrameCounter), A
3591+ AECA 32 BC 86         LD     (Var_Hooks_BlinkingIsActive), A
3592+ AECD C9               RET
3593+ AECE              ; ---------------------------------------------------------------------------
3594+ AECE              ; Set visible field side
3595+ AECE              ; ---------------------------------------------------------------------------
3596+ AECE              Game_SetVisibileFieldSide:
3597+ AECE CD 01 A7         CALL    Game_GetPlayerIdWithBall
3598+ AED1 FE 00            CP      TEAM_BLACK
3599+ AED3 28 1B            JR      Z, .SetSouthSide
3600+ AED5 FE 01            CP      TEAM_WHITE
3601+ AED7 28 01            JR      Z, .SetNorthSide
3602+ AED9 C9               RET
3603+ AEDA              .SetNorthSide:
3604+ AEDA 47               LD      B, A
3605+ AEDB 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3606+ AEDE FE 01            CP      FIELD_NORTH_SIDE
3607+ AEE0 C8               RET     Z
3608+ AEE1 4C               LD      C, H
3609+ AEE2 CD C4 A2         CALL    Game_GetPlayerInfoById
3610+ AEE5 7C               LD      A, H
3611+ AEE6 FE 01            CP      1
3612+ AEE8 C0               RET     NZ
3613+ AEE9 3E 01            LD      A, FIELD_NORTH_SIDE
3614+ AEEB 32 46 86         LD      (Var_Game_ActiveFieldSide), A
3615+ AEEE 18 14            JR      .Done
3616+ AEF0              .SetSouthSide:
3617+ AEF0 47               LD      B, A
3618+ AEF1 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3619+ AEF4 FE 00            CP      FIELD_SOUTH_SIDE
3620+ AEF6 C8               RET     Z
3621+ AEF7 4C               LD      C, H
3622+ AEF8 CD C4 A2         CALL    Game_GetPlayerInfoById
3623+ AEFB 7C               LD      A, H
3624+ AEFC FE 03            CP      3
3625+ AEFE C0               RET     NZ
3626+ AEFF 3E 00            LD      A, FIELD_SOUTH_SIDE
3627+ AF01 32 46 86         LD      (Var_Game_ActiveFieldSide), A
3628+ AF04              .Done:
3629+ AF04 CD F7 86         CALL    Hooks_TickStop
3630+ AF07 CD A6 97         CALL    VDP_DrawField
3631+ AF0A CD 16 AF         CALL    Game_PutPlayersToNewFieldSide
3632+ AF0D 3E FF            LD      A, NO_VALUE
3633+ AF0F 32 74 86         LD      (Var_Game_BallYOldPosition), A
3634+ AF12 CD EF 86         CALL    Hooks_TickStart
3635+ AF15 C9               RET
3636+ AF16              ;----------------------------------------------------------------------------
3637+ AF16              ; Game_PutPlayersToNewFieldSide
3638+ AF16              ; Adjust players positions according to the new field side
3639+ AF16              ; ----------------------------------------------------------------------------
3640+ AF16              Game_PutPlayersToNewFieldSide:
3641+ AF16 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
3642+ AF19 FE 01            CP      FIELD_NORTH_SIDE
3643+ AF1B 20 74            JR      NZ, .SouthSide
3644+ AF1D              .NorthSide:
3645+ AF1D 06 00            LD      B, TEAM_BLACK
3646+ AF1F 0E 01            LD      C, 1
3647+ AF21              .NorthSide_BLoop:
3648+ AF21 C5               PUSH    BC
3649+ AF22 CD C4 A2         CALL    Game_GetPlayerInfoById
3650+ AF25 E5               PUSH    HL
3651+ AF26 D1               POP     DE
3652+ AF27 7A               LD      A, D
3653+ AF28 FE 00            CP      0
3654+ AF2A CC 0D B0         CALL    Z, .BlackMidlefieldersFromSouthToNorth ; (0 to 3)
3655+ AF2D FE 02            CP      2
3656+ AF2F CC 0A B0         CALL    Z, .BlackStrikersFromSouthToNorth ; (2 to 1)
3657+ AF32 3E 00            LD      A, TEAM_BLACK
3658+ AF34 47               LD      B, A
3659+ AF35 CD 9D A2         CALL    SetPlayerInfo
3660+ AF38 C1               POP     BC
3661+ AF39 0C               INC     C
3662+ AF3A 79               LD      A, C
3663+ AF3B FE 04            CP      4
3664+ AF3D 28 02            JR      Z, .NorthSideWhiteTeam
3665+ AF3F 18 E0            JR      .NorthSide_BLoop
3666+ AF41              .NorthSideWhiteTeam:
3667+ AF41 06 01            LD      B, TEAM_WHITE
3668+ AF43 0E 00            LD      C, 0
3669+ AF45              .NorthSide_WLoop:
3670+ AF45 C5               PUSH    BC
3671+ AF46 CD C4 A2         CALL    Game_GetPlayerInfoById
3672+ AF49 E5               PUSH    HL
3673+ AF4A D1               POP     DE
3674+ AF4B 7A               LD      A, D
3675+ AF4C FE 03            CP      3
3676+ AF4E CC 13 B0         CALL    Z, .WhiteDefendersFromSouthToNorth ; (3 to 2)
3677+ AF51 FE 01            CP      1
3678+ AF53 CC 10 B0         CALL    Z, .WhiteMidlefieldersFromSouthToNorth ; (1 to 4)
3679+ AF56 3E 01            LD      A, TEAM_WHITE
3680+ AF58 47               LD      B, A
3681+ AF59 CD 9D A2         CALL    SetPlayerInfo
3682+ AF5C C1               POP     BC
3683+ AF5D 0C               INC     C
3684+ AF5E 79               LD      A, C
3685+ AF5F FE 04            CP      4
3686+ AF61 CA 66 AF         JP      Z, .NorthSideDonePlayers
3687+ AF64 18 DF            JR      .NorthSide_WLoop
3688+ AF66
3689+ AF66              .NorthSideDonePlayers:
3690+ AF66 06 00            LD      B, TEAM_BLACK
3691+ AF68 0E 00            LD      C, 0
3692+ AF6A C5               PUSH    BC
3693+ AF6B CD C4 A2         CALL    Game_GetPlayerInfoById
3694+ AF6E C1               POP     BC
3695+ AF6F 16 00            LD      D, 0
3696+ AF71 7D               LD      A, L
3697+ AF72 5F               LD      E, A
3698+ AF73 CD 9D A2         CALL    SetPlayerInfo
3699+ AF76
3700+ AF76 06 01            LD      B, TEAM_WHITE
3701+ AF78 0E 00            LD      C, 0
3702+ AF7A C5               PUSH    BC
3703+ AF7B CD C4 A2         CALL    Game_GetPlayerInfoById
3704+ AF7E C1               POP     BC
3705+ AF7F 16 FF            LD      D, NO_VALUE
3706+ AF81 7D               LD      A, L
3707+ AF82 5F               LD      E, A
3708+ AF83 CD 9D A2         CALL    SetPlayerInfo
3709+ AF86 CD FD A1         CALL    Game_GetBallPosition
3710+ AF89 3E 03            LD      A, 3
3711+ AF8B 57               LD      D, A
3712+ AF8C CD 08 A2         CALL    Game_SetBallPosition
3713+ AF8F
3714+ AF8F 18 70            JR      .Done
3715+ AF91              .SouthSide:
3716+ AF91 06 00            LD      B, TEAM_BLACK
3717+ AF93 0E 01            LD      C, 1
3718+ AF95              .SouthSide_BLoop:
3719+ AF95 C5               PUSH    BC
3720+ AF96 CD C4 A2         CALL    Game_GetPlayerInfoById
3721+ AF99 E5               PUSH    HL
3722+ AF9A D1               POP     DE
3723+ AF9B 7A               LD      A, D
3724+ AF9C FE 01            CP      1
3725+ AF9E CC 16 B0         CALL    Z, .BlackDefendersFromNorthToSouth ; (1 to 2)
3726+ AFA1 FE 03            CP      3
3727+ AFA3 CC 19 B0         CALL    Z, .BlackMidlefieldersFromNorthToSouth ; (3 to 0)
3728+ AFA6 3E 00            LD      A, TEAM_BLACK
3729+ AFA8 47               LD      B, A
3730+ AFA9 CD 9D A2         CALL    SetPlayerInfo
3731+ AFAC C1               POP     BC
3732+ AFAD 0C               INC     C
3733+ AFAE 79               LD      A, C
3734+ AFAF FE 04            CP      4
3735+ AFB1 28 02            JR      Z, .SouthSideWhiteTeam
3736+ AFB3 18 E0            JR      .SouthSide_BLoop
3737+ AFB5              .SouthSideWhiteTeam:
3738+ AFB5 06 01            LD      B, TEAM_WHITE
3739+ AFB7 0E 00            LD      C, 0
3740+ AFB9              .SouthSide_WLoop:
3741+ AFB9 C5               PUSH    BC
3742+ AFBA CD C4 A2         CALL    Game_GetPlayerInfoById
3743+ AFBD E5               PUSH    HL
3744+ AFBE D1               POP     DE
3745+ AFBF 7A               LD      A, D
3746+ AFC0 FE 02            CP      2
3747+ AFC2 CC 1C B0         CALL    Z, .WhiteStrikersFromNorthToSouth ; (2 to 3)
3748+ AFC5 FE 04            CP      4
3749+ AFC7 CC 1F B0         CALL    Z, .WhiteMidlefieldersFromNorthToSouth ; (4 to 1)
3750+ AFCA 3E 01            LD      A, TEAM_WHITE
3751+ AFCC 47               LD      B, A
3752+ AFCD CD 9D A2         CALL    SetPlayerInfo
3753+ AFD0 C1               POP     BC
3754+ AFD1 0C               INC     C
3755+ AFD2 79               LD      A, C
3756+ AFD3 FE 04            CP      4
3757+ AFD5 28 02            JR      Z, .SouthSideDonePlayers
3758+ AFD7 18 E0            JR      .SouthSide_WLoop
3759+ AFD9              .SouthSideDonePlayers:
3760+ AFD9 06 00            LD      B, TEAM_BLACK
3761+ AFDB 0E 00            LD      C, 0
3762+ AFDD C5               PUSH    BC
3763+ AFDE CD C4 A2         CALL    Game_GetPlayerInfoById
3764+ AFE1 C1               POP     BC
3765+ AFE2 16 FF            LD      D, NO_VALUE
3766+ AFE4 7D               LD      A, L
3767+ AFE5 5F               LD      E, A
3768+ AFE6 CD 9D A2         CALL    SetPlayerInfo
3769+ AFE9
3770+ AFE9 06 01            LD      B, TEAM_WHITE
3771+ AFEB 0E 00            LD      C, 0
3772+ AFED C5               PUSH    BC
3773+ AFEE CD C4 A2         CALL    Game_GetPlayerInfoById
3774+ AFF1 C1               POP     BC
3775+ AFF2 16 04            LD      D, 4
3776+ AFF4 7D               LD      A, L
3777+ AFF5 5F               LD      E, A
3778+ AFF6 CD 9D A2         CALL    SetPlayerInfo
3779+ AFF9 CD FD A1         CALL    Game_GetBallPosition
3780+ AFFC AF               XOR     A
3781+ AFFD 57               LD      D, A
3782+ AFFE CD 08 A2         CALL    Game_SetBallPosition
3783+ B001
3784+ B001
3785+ B001              .Done:
3786+ B001 CD 2D A3         CALL    ClearAllPrevPositions
3787+ B004 3E 01            LD      A, YES
3788+ B006 32 C0 86         LD      (Var_Hooks_ForceVdpRedraw), A
3789+ B009 C9               RET
3790+ B00A
3791+ B00A              .BlackStrikersFromSouthToNorth:
3792+ B00A 16 01            LD      D, 1
3793+ B00C C9               RET
3794+ B00D              .BlackMidlefieldersFromSouthToNorth:
3795+ B00D 16 03            LD      D, 3
3796+ B00F C9               RET
3797+ B010              .WhiteMidlefieldersFromSouthToNorth:
3798+ B010 16 04            LD      D, 4
3799+ B012 C9               RET
3800+ B013              .WhiteDefendersFromSouthToNorth:
3801+ B013 16 02            LD      D, 2
3802+ B015 C9               RET
3803+ B016              .BlackDefendersFromNorthToSouth:
3804+ B016 16 02            LD      D, 2
3805+ B018 C9               RET
3806+ B019              .BlackMidlefieldersFromNorthToSouth:
3807+ B019 16 00            LD      D, 0
3808+ B01B C9               RET
3809+ B01C              .WhiteStrikersFromNorthToSouth:
3810+ B01C 16 03            LD      D, 3
3811+ B01E C9               RET
3812+ B01F              .WhiteMidlefieldersFromNorthToSouth:
3813+ B01F 16 01            LD      D, 1
3814+ B021 C9               RET
3815+ B022
3816+ B022              ;---------------------------------------------------------------------------
3817+ B022              ; Get all players on a row
3818+ B022              ; INPUT:
3819+ B022              ;   A = Row
3820+ B022              ; OUTPUT:
3821+ B022              ;   B: First player found on that row (ID)
3822+ B022              ;   C: Second player found on that row (ID) or NO_VALUE
3823+ B022              ;----------------------------------------------------------------------------
3824+ B022              GetAllPlayersOnARow:
3825+ B022 26 FF            LD   H, NO_VALUE
3826+ B024 2E FF            LD   L, NO_VALUE
3827+ B026
3828+ B026 57               LD   D, A
3829+ B027 3A 5E 86         LD   A, (Var_Game_TmpMoveReadRowPlayersFromLeft)
3830+ B02A FE 01            CP   YES
3831+ B02C 20 23            JR   NZ, .SearchFromRight
3832+ B02E 1E 00            LD   E, 0
3833+ B030              .LoopLeft:
3834+ B030 D5               PUSH  DE
3835+ B031 E5               PUSH  HL
3836+ B032 CD DF A2         CALL Game_GetPlayerInfoByPos
3837+ B035 E1               POP   HL
3838+ B036 FE FF            CP  NO_VALUE
3839+ B038 28 09            JR  Z, .NextLeft
3840+ B03A 7C               LD  A, H
3841+ B03B FE FF            CP  NO_VALUE
3842+ B03D 20 03            JR  NZ, .LoopLeftL
3843+ B03F 61               LD  H, C
3844+ B040 18 01            JR  .NextLeft
3845+ B042              .LoopLeftL:
3846+ B042 69               LD  L, C
3847+ B043              .NextLeft:
3848+ B043 D1               POP DE
3849+ B044 1C               INC E
3850+ B045 7D               LD  A, L
3851+ B046 FE FF            CP  NO_VALUE
3852+ B048 20 2A            JR  NZ, .Done
3853+ B04A 7B               LD   A, E
3854+ B04B FE 05            CP  5
3855+ B04D 28 25            JR Z,.Done
3856+ B04F 18 DF            JR  .LoopLeft
3857+ B051              .SearchFromRight:
3858+ B051 1E 04            LD   E, 4
3859+ B053              .LoopRight:
3860+ B053 D5               PUSH  DE
3861+ B054 E5               PUSH  HL
3862+ B055 CD DF A2         CALL Game_GetPlayerInfoByPos
3863+ B058 E1               POP   HL
3864+ B059 FE FF            CP  NO_VALUE
3865+ B05B 28 09            JR  Z, .NextRight
3866+ B05D 7C               LD  A, H
3867+ B05E FE FF            CP  NO_VALUE
3868+ B060 20 03            JR  NZ, .LoopRightL
3869+ B062 61               LD  H, C
3870+ B063 18 01            JR .NextRight
3871+ B065              .LoopRightL:
3872+ B065 69               LD  L, C
3873+ B066              .NextRight:
3874+ B066 D1               POP DE
3875+ B067 1D               DEC E
3876+ B068 7D               LD  A, L
3877+ B069 FE FF            CP  NO_VALUE
3878+ B06B 20 07            JR NZ, .Done
3879+ B06D 7B               LD   A, E
3880+ B06E FE FF            CP  255
3881+ B070 28 02            JR Z, .Done
3882+ B072 18 DF            JR  .LoopRight
3883+ B074
3884+ B074              .Done:
3885+ B074 44               ld B,H
3886+ B075 4D               ld C,L
3887+ B076 C9               RET
3888+ B077              Game_Start:
3889+ B077 CD 34 8C         CALL    Hooks_InitAICounters
3890+ B07A 3E 00            LD      A, NO
3891+ B07C 32 BC 86         LD      (Var_Hooks_BlinkingIsActive), A
3892+ B07F 3E 01            LD      A, 1
3893+ B081 32 48 86         LD      (Var_Game_SelectedLevel), A
3894+ B084 AF               XOR     A
3895+ B085 32 43 86         LD      (Var_Utils_NumberToPrint+5),A
3896+ B088 32 C3 86         LD      (Var_Hooks_TickCounter),A
3897+ B08B 3E 05            LD      A, TICK_SPEED
3898+ B08D 32 C1 86         LD      (Var_Hooks_TickSpeed), A
3899+ B090 3E 01            LD      A, FIELD_NORTH_SIDE
3900+ B092 32 46 86         LD      (Var_Game_ActiveFieldSide), A
3901+ B095 CD A6 97         CALL    VDP_DrawField
3902+ B098 CD 4D A3         CALL    Game_SetWhiteKickoffSchema
3903+ B09B CD 15 9B         CALL    VDP_PlayerMatrixRedraw
3904+ B09E CD F7 86         call    Hooks_TickStop
3905+ B0A1 CD 6D A5         CALL    Game_Resume
3906+ B0A4 3E 01            LD      A, YES
3907+ B0A6 32 BA 86         LD      (Var_Hooks_GameResumingWaiting), A
3908+ B0A9
3909+ B0A9
3910+ B0A9                  ;ld   hl,SND_DATA
3911+ B0A9                  ;ld   de,SND_LEN        ; 1543 per il tuo file
3912+ B0A9                  ;call Sounds_PlayHLDE      ; parte la riproduzione in background
3913+ B0A9
3914+ B0A9
3915+ B0A9 C9               RET
3916+ B0AA
3917+ B0AA              ; ---------------------------------------------------------------------------
3918+ B0AA              ; ClearGameFieldForGoalCerimony
3919+ B0AA              ; ----------------------------------------------------------------------------
3920+ B0AA              Game_ClearGameFieldForGoalCerimony:
3921+ B0AA F5               PUSH    AF
3922+ B0AB C5               PUSH    BC
3923+ B0AC D5               PUSH    DE
3924+ B0AD E5               PUSH    HL
3925+ B0AE 3A 46 86         LD      A,(Var_Game_ActiveFieldSide)
3926+ B0B1 FE 01            CP      FIELD_NORTH_SIDE
3927+ B0B3 20 1D            JR      NZ, .SouthSideClear
3928+ B0B5              .NorthSideClear:
3929+ B0B5 16 01            LD      D, 1
3930+ B0B7              .Loop_North_Rows:
3931+ B0B7 D5               PUSH    DE
3932+ B0B8 1E 00            LD      E, 0
3933+ B0BA              .Loop_North_Cols:
3934+ B0BA D5               PUSH    DE
3935+ B0BB 3E D6            LD      A,TILE_FIELD
3936+ B0BD
3937+ B0BD CD BC 95         CALL    VDP_DrawSprite
3938+ B0C0 D1               POP     DE
3939+ B0C1 1C               INC     E
3940+ B0C2 7B               LD      A, E
3941+ B0C3 FE 05            CP      5
3942+ B0C5 28 02            JR      Z,.Done_North_Rows
3943+ B0C7 18 F1            JR      .Loop_North_Cols
3944+ B0C9              .Done_North_Rows:
3945+ B0C9 D1               POP     DE
3946+ B0CA 14               INC     D
3947+ B0CB 7A               LD      A, D
3948+ B0CC FE 05            CP      5
3949+ B0CE 28 1F            JR      Z,.Done
3950+ B0D0 18 E5            JR      .Loop_North_Rows
3951+ B0D2
3952+ B0D2              .SouthSideClear:
3953+ B0D2 16 00            LD      D, 0
3954+ B0D4              .Loop_South_Rows:
3955+ B0D4 D5               PUSH    DE
3956+ B0D5 1E 00            LD      E, 0
3957+ B0D7              .Loop_South_Cols:
3958+ B0D7 D5               PUSH    DE
3959+ B0D8 3E D6            LD      A,TILE_FIELD
3960+ B0DA
3961+ B0DA CD BC 95         CALL    VDP_DrawSprite
3962+ B0DD D1               POP     DE
3963+ B0DE 1C               INC     E
3964+ B0DF 7B               LD      A, E
3965+ B0E0 FE 05            CP      5
3966+ B0E2 28 02            JR      Z,.Done_South_Rows
3967+ B0E4 18 F1            JR      .Loop_South_Cols
3968+ B0E6              .Done_South_Rows:
3969+ B0E6 D1               POP     DE
3970+ B0E7 14               INC     D
3971+ B0E8 7A               LD      A, D
3972+ B0E9 FE 04            CP      4
3973+ B0EB 28 02            JR      Z,.Done
3974+ B0ED 18 E5            JR      .Loop_South_Rows
3975+ B0EF
3976+ B0EF              .Done:
3977+ B0EF E1               POP     HL
3978+ B0F0 D1               POP     DE
3979+ B0F1 C1               POP     BC
3980+ B0F2 F1               POP     AF
3981+ B0F3 C9               RET
3982+ B0F4              ; ---------------------------------------------------------------------------
3983+ B0F4              ; PutCerimonyWhitePlayersPos1
3984+ B0F4              ; ----------------------------------------------------------------------------
3985+ B0F4              PutCerimonyWhitePlayersPos1:
3986+ B0F4 CD FA 9F         CALL    Utils_PlayBeepTick
3987+ B0F7 16 02            LD      D, 2
3988+ B0F9 1E 00            LD      E, 0
3989+ B0FB D5               PUSH    DE
3990+ B0FC 3E A0            LD      A,TILE_WHITE_PLAYER
3991+ B0FE
3992+ B0FE CD BC 95         CALL    VDP_DrawSprite
3993+ B101 D1               POP     DE
3994+ B102 16 02            LD      D, 2
3995+ B104 1E 01            LD      E, 1
3996+ B106 D5               PUSH    DE
3997+ B107 3E A0            LD      A,TILE_WHITE_PLAYER
3998+ B109
3999+ B109 CD BC 95         CALL    VDP_DrawSprite
4000+ B10C D1               POP     DE
4001+ B10D
4002+ B10D 16 04            LD      D, 4
4003+ B10F 1E 03            LD      E, 3
4004+ B111 D5               PUSH    DE
4005+ B112 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4006+ B114
4007+ B114 CD BC 95         CALL    VDP_DrawSprite
4008+ B117 D1               POP     DE
4009+ B118 16 04            LD      D, 4
4010+ B11A 1E 04            LD      E, 4
4011+ B11C D5               PUSH    DE
4012+ B11D 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4013+ B11F
4014+ B11F CD BC 95         CALL    VDP_DrawSprite
4015+ B122 D1               POP     DE
4016+ B123 C9               RET
4017+ B124
4018+ B124              ; ---------------------------------------------------------------------------
4019+ B124              ; PutCerimonyWhitePlayersPos2
4020+ B124              ; ----------------------------------------------------------------------------
4021+ B124              PutCerimonyWhitePlayersPos2:
4022+ B124 CD FA 9F         CALL    Utils_PlayBeepTick
4023+ B127 16 02            LD      D, 2
4024+ B129 1E 00            LD      E, 0
4025+ B12B D5               PUSH    DE
4026+ B12C 3E D6            LD      A,TILE_FIELD
4027+ B12E
4028+ B12E CD BC 95         CALL    VDP_DrawSprite
4029+ B131 D1               POP     DE
4030+ B132 16 02            LD      D, 2
4031+ B134 1E 02            LD      E, 2
4032+ B136 D5               PUSH    DE
4033+ B137 3E A0            LD      A,TILE_WHITE_PLAYER
4034+ B139
4035+ B139 CD BC 95         CALL    VDP_DrawSprite
4036+ B13C D1               POP     DE
4037+ B13D
4038+ B13D 16 04            LD      D, 4
4039+ B13F 1E 02            LD      E, 2
4040+ B141 D5               PUSH    DE
4041+ B142 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4042+ B144
4043+ B144 CD BC 95         CALL    VDP_DrawSprite
4044+ B147 D1               POP     DE
4045+ B148 16 04            LD      D, 4
4046+ B14A 1E 04            LD      E, 4
4047+ B14C D5               PUSH    DE
4048+ B14D 3E D6            LD      A, TILE_FIELD
4049+ B14F
4050+ B14F CD BC 95         CALL    VDP_DrawSprite
4051+ B152 D1               POP     DE
4052+ B153 C9               RET
4053+ B154              ; ---------------------------------------------------------------------------
4054+ B154              ; PutCerimonyWhitePlayersPos3
4055+ B154              ; ----------------------------------------------------------------------------
4056+ B154              PutCerimonyWhitePlayersPos3:
4057+ B154 CD FA 9F         CALL    Utils_PlayBeepTick
4058+ B157 16 02            LD      D, 2
4059+ B159 1E 01            LD      E, 1
4060+ B15B D5               PUSH    DE
4061+ B15C 3E D6            LD      A,TILE_FIELD
4062+ B15E
4063+ B15E CD BC 95         CALL    VDP_DrawSprite
4064+ B161 D1               POP     DE
4065+ B162 16 02            LD      D, 2
4066+ B164 1E 03            LD      E, 3
4067+ B166 D5               PUSH    DE
4068+ B167 3E A0            LD      A,TILE_WHITE_PLAYER
4069+ B169
4070+ B169 CD BC 95         CALL    VDP_DrawSprite
4071+ B16C D1               POP     DE
4072+ B16D
4073+ B16D 16 04            LD      D, 4
4074+ B16F 1E 01            LD      E, 1
4075+ B171 D5               PUSH    DE
4076+ B172 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4077+ B174
4078+ B174 CD BC 95         CALL    VDP_DrawSprite
4079+ B177 D1               POP     DE
4080+ B178 16 04            LD      D, 4
4081+ B17A 1E 03            LD      E, 3
4082+ B17C D5               PUSH    DE
4083+ B17D 3E D6            LD      A, TILE_FIELD
4084+ B17F
4085+ B17F CD BC 95         CALL    VDP_DrawSprite
4086+ B182 D1               POP     DE
4087+ B183 C9               RET
4088+ B184              ; ---------------------------------------------------------------------------
4089+ B184              ; PutCerimonyWhitePlayersPos4
4090+ B184              ; ----------------------------------------------------------------------------
4091+ B184              PutCerimonyWhitePlayersPos4:
4092+ B184 CD FA 9F         CALL    Utils_PlayBeepTick
4093+ B187 16 02            LD      D, 2
4094+ B189 1E 03            LD      E, 3
4095+ B18B D5               PUSH    DE
4096+ B18C 3E D6            LD      A,TILE_FIELD
4097+ B18E
4098+ B18E CD BC 95         CALL    VDP_DrawSprite
4099+ B191 D1               POP     DE
4100+ B192 16 02            LD      D, 2
4101+ B194 1E 01            LD      E, 1
4102+ B196 D5               PUSH    DE
4103+ B197 3E A0            LD      A,TILE_WHITE_PLAYER
4104+ B199
4105+ B199 CD BC 95         CALL    VDP_DrawSprite
4106+ B19C D1               POP     DE
4107+ B19D
4108+ B19D 16 04            LD      D, 4
4109+ B19F 1E 03            LD      E, 3
4110+ B1A1 D5               PUSH    DE
4111+ B1A2 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4112+ B1A4
4113+ B1A4 CD BC 95         CALL    VDP_DrawSprite
4114+ B1A7 D1               POP     DE
4115+ B1A8 16 04            LD      D, 4
4116+ B1AA 1E 01            LD      E, 1
4117+ B1AC D5               PUSH    DE
4118+ B1AD 3E D6            LD      A, TILE_FIELD
4119+ B1AF
4120+ B1AF CD BC 95         CALL    VDP_DrawSprite
4121+ B1B2 D1               POP     DE
4122+ B1B3 C9               RET
4123+ B1B4              ; ---------------------------------------------------------------------------
4124+ B1B4              ; PutCerimonyWhitePlayersPos5
4125+ B1B4              ; ----------------------------------------------------------------------------
4126+ B1B4              PutCerimonyWhitePlayersPos5:
4127+ B1B4 CD FB 9F         CALL Utils_PlayBeepHighLong
4128+ B1B7 16 02            LD      D, 2
4129+ B1B9 1E 02            LD      E, 2
4130+ B1BB D5               PUSH    DE
4131+ B1BC 3E D6            LD      A,TILE_FIELD
4132+ B1BE
4133+ B1BE CD BC 95         CALL    VDP_DrawSprite
4134+ B1C1 D1               POP     DE
4135+ B1C2 16 02            LD      D, 2
4136+ B1C4 1E 00            LD      E, 0
4137+ B1C6 D5               PUSH    DE
4138+ B1C7 3E A0            LD      A,TILE_WHITE_PLAYER
4139+ B1C9
4140+ B1C9 CD BC 95         CALL    VDP_DrawSprite
4141+ B1CC D1               POP     DE
4142+ B1CD
4143+ B1CD 16 04            LD      D, 4
4144+ B1CF 1E 04            LD      E, 4
4145+ B1D1 D5               PUSH    DE
4146+ B1D2 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4147+ B1D4
4148+ B1D4 CD BC 95         CALL    VDP_DrawSprite
4149+ B1D7 D1               POP     DE
4150+ B1D8 16 04            LD      D, 4
4151+ B1DA 1E 02            LD      E, 2
4152+ B1DC D5               PUSH    DE
4153+ B1DD 3E D6            LD      A, TILE_FIELD
4154+ B1DF
4155+ B1DF CD BC 95         CALL    VDP_DrawSprite
4156+ B1E2 D1               POP     DE
4157+ B1E3 C9               RET
4158+ B1E4              ; ---------------------------------------------------------------------------
4159+ B1E4              ; PutCerimonyWhitePlayersPos6
4160+ B1E4              ; ----------------------------------------------------------------------------
4161+ B1E4              PutCerimonyWhitePlayersPos6:
4162+ B1E4 CD FA 9F         CALL    Utils_PlayBeepTick
4163+ B1E7 16 02            LD      D, 2
4164+ B1E9 1E 00            LD      E, 0
4165+ B1EB D5               PUSH    DE
4166+ B1EC 3E D6            LD      A,TILE_FIELD
4167+ B1EE
4168+ B1EE CD BC 95         CALL    VDP_DrawSprite
4169+ B1F1 D1               POP     DE
4170+ B1F2 16 02            LD      D, 2
4171+ B1F4 1E 02            LD      E, 2
4172+ B1F6 D5               PUSH    DE
4173+ B1F7 3E A0            LD      A,TILE_WHITE_PLAYER
4174+ B1F9
4175+ B1F9 CD BC 95         CALL    VDP_DrawSprite
4176+ B1FC D1               POP     DE
4177+ B1FD
4178+ B1FD 16 04            LD      D, 4
4179+ B1FF 1E 02            LD      E, 2
4180+ B201 D5               PUSH    DE
4181+ B202 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4182+ B204
4183+ B204 CD BC 95         CALL    VDP_DrawSprite
4184+ B207 D1               POP     DE
4185+ B208 16 04            LD      D, 4
4186+ B20A 1E 04            LD      E, 4
4187+ B20C D5               PUSH    DE
4188+ B20D 3E D6            LD      A, TILE_FIELD
4189+ B20F
4190+ B20F CD BC 95         CALL    VDP_DrawSprite
4191+ B212 D1               POP     DE
4192+ B213 C9               RET
4193+ B214              ; ---------------------------------------------------------------------------
4194+ B214              ; PutCerimonyWhitePlayersPos7
4195+ B214              ; ----------------------------------------------------------------------------
4196+ B214              PutCerimonyWhitePlayersPos7:
4197+ B214 CD FA 9F         CALL    Utils_PlayBeepTick
4198+ B217 16 02            LD      D, 2
4199+ B219 1E 01            LD      E, 1
4200+ B21B D5               PUSH    DE
4201+ B21C 3E D6            LD      A,TILE_FIELD
4202+ B21E
4203+ B21E CD BC 95         CALL    VDP_DrawSprite
4204+ B221 D1               POP     DE
4205+ B222 16 02            LD      D, 2
4206+ B224 1E 03            LD      E, 3
4207+ B226 D5               PUSH    DE
4208+ B227 3E A0            LD      A,TILE_WHITE_PLAYER
4209+ B229
4210+ B229 CD BC 95         CALL    VDP_DrawSprite
4211+ B22C D1               POP     DE
4212+ B22D
4213+ B22D 16 04            LD      D, 4
4214+ B22F 1E 01            LD      E, 1
4215+ B231 D5               PUSH    DE
4216+ B232 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4217+ B234
4218+ B234 CD BC 95         CALL    VDP_DrawSprite
4219+ B237 D1               POP     DE
4220+ B238 16 04            LD      D, 4
4221+ B23A 1E 03            LD      E, 3
4222+ B23C D5               PUSH    DE
4223+ B23D 3E D6            LD      A, TILE_FIELD
4224+ B23F
4225+ B23F CD BC 95         CALL    VDP_DrawSprite
4226+ B242 D1               POP     DE
4227+ B243 C9               RET
4228+ B244              ; ---------------------------------------------------------------------------
4229+ B244              ; PutCerimonyWhitePlayersPos8
4230+ B244              ; ----------------------------------------------------------------------------
4231+ B244              PutCerimonyWhitePlayersPos8:
4232+ B244 CD FA 9F         CALL    Utils_PlayBeepTick
4233+ B247 16 02            LD      D, 2
4234+ B249 1E 03            LD      E, 3
4235+ B24B D5               PUSH    DE
4236+ B24C 3E D6            LD      A,TILE_FIELD
4237+ B24E
4238+ B24E CD BC 95         CALL    VDP_DrawSprite
4239+ B251 D1               POP     DE
4240+ B252 16 02            LD      D, 2
4241+ B254 1E 01            LD      E, 1
4242+ B256 D5               PUSH    DE
4243+ B257 3E A0            LD      A,TILE_WHITE_PLAYER
4244+ B259
4245+ B259 CD BC 95         CALL    VDP_DrawSprite
4246+ B25C D1               POP     DE
4247+ B25D
4248+ B25D 16 04            LD      D, 4
4249+ B25F 1E 03            LD      E, 3
4250+ B261 D5               PUSH    DE
4251+ B262 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4252+ B264
4253+ B264 CD BC 95         CALL    VDP_DrawSprite
4254+ B267 D1               POP     DE
4255+ B268 16 04            LD      D, 4
4256+ B26A 1E 01            LD      E, 1
4257+ B26C D5               PUSH    DE
4258+ B26D 3E D6            LD      A, TILE_FIELD
4259+ B26F
4260+ B26F CD BC 95         CALL    VDP_DrawSprite
4261+ B272 D1               POP     DE
4262+ B273 C9               RET
4263+ B274              ; ---------------------------------------------------------------------------
4264+ B274              ; PutCerimonyWhitePlayersPos9
4265+ B274              ; ----------------------------------------------------------------------------
4266+ B274              PutCerimonyWhitePlayersPos9:
4267+ B274 CD FA 9F         CALL    Utils_PlayBeepTick
4268+ B277 16 02            LD      D, 2
4269+ B279 1E 02            LD      E, 2
4270+ B27B D5               PUSH    DE
4271+ B27C 3E D6            LD      A,TILE_FIELD
4272+ B27E
4273+ B27E CD BC 95         CALL    VDP_DrawSprite
4274+ B281 D1               POP     DE
4275+ B282 16 02            LD      D, 2
4276+ B284 1E 00            LD      E, 0
4277+ B286 D5               PUSH    DE
4278+ B287 3E A0            LD      A,TILE_WHITE_PLAYER
4279+ B289
4280+ B289 CD BC 95         CALL    VDP_DrawSprite
4281+ B28C D1               POP     DE
4282+ B28D
4283+ B28D 16 04            LD      D, 4
4284+ B28F 1E 04            LD      E, 4
4285+ B291 D5               PUSH    DE
4286+ B292 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4287+ B294
4288+ B294 CD BC 95         CALL    VDP_DrawSprite
4289+ B297 D1               POP     DE
4290+ B298 16 04            LD      D, 4
4291+ B29A 1E 02            LD      E, 2
4292+ B29C D5               PUSH    DE
4293+ B29D 3E D6            LD      A, TILE_FIELD
4294+ B29F
4295+ B29F CD BC 95         CALL    VDP_DrawSprite
4296+ B2A2 D1               POP     DE
4297+ B2A3 C9               RET
4298+ B2A4
4299+ B2A4
4300+ B2A4
4301+ B2A4
4302+ B2A4
4303+ B2A4
4304+ B2A4
4305+ B2A4
4306+ B2A4
4307+ B2A4
4308+ B2A4              ; ---------------------------------------------------------------------------
4309+ B2A4              ; PutCerimonyBlackPlayersPos1
4310+ B2A4              ; ----------------------------------------------------------------------------
4311+ B2A4              PutCerimonyBlackPlayersPos1:
4312+ B2A4 CD FA 9F         CALL    Utils_PlayBeepTick
4313+ B2A7 16 00            LD      D, 0
4314+ B2A9 1E 00            LD      E, 0
4315+ B2AB D5               PUSH    DE
4316+ B2AC 3E B0            LD      A,TILE_BLACK_PLAYER
4317+ B2AE
4318+ B2AE CD BC 95         CALL    VDP_DrawSprite
4319+ B2B1 D1               POP     DE
4320+ B2B2 16 00            LD      D, 0
4321+ B2B4 1E 01            LD      E, 1
4322+ B2B6 D5               PUSH    DE
4323+ B2B7 3E B0            LD      A,TILE_BLACK_PLAYER
4324+ B2B9
4325+ B2B9 CD BC 95         CALL    VDP_DrawSprite
4326+ B2BC D1               POP     DE
4327+ B2BD
4328+ B2BD 16 02            LD      D, 2
4329+ B2BF 1E 03            LD      E, 3
4330+ B2C1 D5               PUSH    DE
4331+ B2C2 3E B0            LD      A, TILE_BLACK_PLAYER
4332+ B2C4
4333+ B2C4 CD BC 95         CALL    VDP_DrawSprite
4334+ B2C7 D1               POP     DE
4335+ B2C8 16 02            LD      D, 2
4336+ B2CA 1E 04            LD      E, 4
4337+ B2CC D5               PUSH    DE
4338+ B2CD 3E B0            LD      A, TILE_BLACK_PLAYER
4339+ B2CF
4340+ B2CF CD BC 95         CALL    VDP_DrawSprite
4341+ B2D2 D1               POP     DE
4342+ B2D3 C9               RET
4343+ B2D4
4344+ B2D4              ; ---------------------------------------------------------------------------
4345+ B2D4              ; PutCerimonyBlackPlayersPos2
4346+ B2D4              ; ----------------------------------------------------------------------------
4347+ B2D4              PutCerimonyBlackPlayersPos2:
4348+ B2D4 CD FA 9F         CALL    Utils_PlayBeepTick
4349+ B2D7 16 00            LD      D, 0
4350+ B2D9 1E 00            LD      E, 0
4351+ B2DB D5               PUSH    DE
4352+ B2DC 3E D6            LD      A,TILE_FIELD
4353+ B2DE
4354+ B2DE CD BC 95         CALL    VDP_DrawSprite
4355+ B2E1 D1               POP     DE
4356+ B2E2 16 00            LD      D, 0
4357+ B2E4 1E 02            LD      E, 2
4358+ B2E6 D5               PUSH    DE
4359+ B2E7 3E B0            LD      A,TILE_BLACK_PLAYER
4360+ B2E9
4361+ B2E9 CD BC 95         CALL    VDP_DrawSprite
4362+ B2EC D1               POP     DE
4363+ B2ED
4364+ B2ED 16 02            LD      D, 2
4365+ B2EF 1E 02            LD      E, 2
4366+ B2F1 D5               PUSH    DE
4367+ B2F2 3E B0            LD      A, TILE_BLACK_PLAYER
4368+ B2F4
4369+ B2F4 CD BC 95         CALL    VDP_DrawSprite
4370+ B2F7 D1               POP     DE
4371+ B2F8 16 02            LD      D, 2
4372+ B2FA 1E 04            LD      E, 4
4373+ B2FC D5               PUSH    DE
4374+ B2FD 3E D6            LD      A, TILE_FIELD
4375+ B2FF
4376+ B2FF CD BC 95         CALL    VDP_DrawSprite
4377+ B302 D1               POP     DE
4378+ B303 C9               RET
4379+ B304              ; ---------------------------------------------------------------------------
4380+ B304              ; PutCerimonyBlackPlayersPos3
4381+ B304              ; ----------------------------------------------------------------------------
4382+ B304              PutCerimonyBlackPlayersPos3:
4383+ B304 CD FA 9F         CALL    Utils_PlayBeepTick
4384+ B307 16 00            LD      D, 0
4385+ B309 1E 01            LD      E, 1
4386+ B30B D5               PUSH    DE
4387+ B30C 3E D6            LD      A,TILE_FIELD
4388+ B30E
4389+ B30E CD BC 95         CALL    VDP_DrawSprite
4390+ B311 D1               POP     DE
4391+ B312 16 00            LD      D, 0
4392+ B314 1E 03            LD      E, 3
4393+ B316 D5               PUSH    DE
4394+ B317 3E B0            LD      A,TILE_BLACK_PLAYER
4395+ B319
4396+ B319 CD BC 95         CALL    VDP_DrawSprite
4397+ B31C D1               POP     DE
4398+ B31D
4399+ B31D 16 02            LD      D, 2
4400+ B31F 1E 01            LD      E, 1
4401+ B321 D5               PUSH    DE
4402+ B322 3E B0            LD      A, TILE_BLACK_PLAYER
4403+ B324
4404+ B324 CD BC 95         CALL    VDP_DrawSprite
4405+ B327 D1               POP     DE
4406+ B328 16 02            LD      D, 2
4407+ B32A 1E 03            LD      E, 3
4408+ B32C D5               PUSH    DE
4409+ B32D 3E D6            LD      A, TILE_FIELD
4410+ B32F
4411+ B32F CD BC 95         CALL    VDP_DrawSprite
4412+ B332 D1               POP     DE
4413+ B333 C9               RET
4414+ B334              ; ---------------------------------------------------------------------------
4415+ B334              ; PutCerimonyBlackPlayersPos4
4416+ B334              ; ----------------------------------------------------------------------------
4417+ B334              PutCerimonyBlackPlayersPos4:
4418+ B334 CD FA 9F         CALL    Utils_PlayBeepTick
4419+ B337 16 00            LD      D, 0
4420+ B339 1E 03            LD      E, 3
4421+ B33B D5               PUSH    DE
4422+ B33C 3E D6            LD      A,TILE_FIELD
4423+ B33E CD BC 95         CALL    VDP_DrawSprite
4424+ B341 D1               POP     DE
4425+ B342 16 00            LD      D, 0
4426+ B344 1E 01            LD      E, 1
4427+ B346 D5               PUSH    DE
4428+ B347 3E B0            LD      A,TILE_BLACK_PLAYER
4429+ B349 CD BC 95         CALL    VDP_DrawSprite
4430+ B34C D1               POP     DE
4431+ B34D
4432+ B34D 16 02            LD      D, 2
4433+ B34F 1E 03            LD      E, 3
4434+ B351 D5               PUSH    DE
4435+ B352 3E B0            LD      A, TILE_BLACK_PLAYER
4436+ B354 CD BC 95         CALL    VDP_DrawSprite
4437+ B357 D1               POP     DE
4438+ B358 16 02            LD      D, 2
4439+ B35A 1E 01            LD      E, 1
4440+ B35C D5               PUSH    DE
4441+ B35D 3E D6            LD      A, TILE_FIELD
4442+ B35F CD BC 95         CALL    VDP_DrawSprite
4443+ B362 D1               POP     DE
4444+ B363 C9               RET
4445+ B364              ; ---------------------------------------------------------------------------
4446+ B364              ; PutCerimonyBlackPlayersPos5
4447+ B364              ; ----------------------------------------------------------------------------
4448+ B364              PutCerimonyBlackPlayersPos5:
4449+ B364 CD FB 9F         CALL    Utils_PlayBeepHighLong
4450+ B367 16 00            LD      D, 0
4451+ B369 1E 02            LD      E, 2
4452+ B36B D5               PUSH    DE
4453+ B36C 3E D6            LD      A,TILE_FIELD
4454+ B36E CD BC 95         CALL    VDP_DrawSprite
4455+ B371 D1               POP     DE
4456+ B372 16 00            LD      D, 0
4457+ B374 1E 00            LD      E, 0
4458+ B376 D5               PUSH    DE
4459+ B377 3E B0            LD      A,TILE_BLACK_PLAYER
4460+ B379 CD BC 95         CALL    VDP_DrawSprite
4461+ B37C D1               POP     DE
4462+ B37D
4463+ B37D 16 02            LD      D, 2
4464+ B37F 1E 04            LD      E, 4
4465+ B381 D5               PUSH    DE
4466+ B382 3E B0            LD      A, TILE_BLACK_PLAYER
4467+ B384 CD BC 95         CALL    VDP_DrawSprite
4468+ B387 D1               POP     DE
4469+ B388 16 02            LD      D, 2
4470+ B38A 1E 02            LD      E, 2
4471+ B38C D5               PUSH    DE
4472+ B38D 3E D6            LD      A, TILE_FIELD
4473+ B38F CD BC 95         CALL    VDP_DrawSprite
4474+ B392 D1               POP     DE
4475+ B393 C9               RET
4476+ B394              ; ---------------------------------------------------------------------------
4477+ B394              ; PutCerimonyBlackPlayersPos6
4478+ B394              ; ----------------------------------------------------------------------------
4479+ B394              PutCerimonyBlackPlayersPos6:
4480+ B394 CD FA 9F         CALL    Utils_PlayBeepTick
4481+ B397 16 00            LD      D, 0
4482+ B399 1E 00            LD      E, 0
4483+ B39B D5               PUSH    DE
4484+ B39C 3E D6            LD      A,TILE_FIELD
4485+ B39E
4486+ B39E CD BC 95         CALL    VDP_DrawSprite
4487+ B3A1 D1               POP     DE
4488+ B3A2 16 00            LD      D, 0
4489+ B3A4 1E 02            LD      E, 2
4490+ B3A6 D5               PUSH    DE
4491+ B3A7 3E B0            LD      A,TILE_BLACK_PLAYER
4492+ B3A9 CD BC 95         CALL    VDP_DrawSprite
4493+ B3AC D1               POP     DE
4494+ B3AD
4495+ B3AD 16 02            LD      D, 2
4496+ B3AF 1E 02            LD      E, 2
4497+ B3B1 D5               PUSH    DE
4498+ B3B2 3E B0            LD      A, TILE_BLACK_PLAYER
4499+ B3B4 CD BC 95         CALL    VDP_DrawSprite
4500+ B3B7 D1               POP     DE
4501+ B3B8 16 02            LD      D, 2
4502+ B3BA 1E 04            LD      E, 4
4503+ B3BC D5               PUSH    DE
4504+ B3BD 3E D6            LD      A, TILE_FIELD
4505+ B3BF CD BC 95         CALL    VDP_DrawSprite
4506+ B3C2 D1               POP     DE
4507+ B3C3 C9               RET
4508+ B3C4              ; ---------------------------------------------------------------------------
4509+ B3C4              ; PutCerimonyBlackPlayersPos7
4510+ B3C4              ; ----------------------------------------------------------------------------
4511+ B3C4              PutCerimonyBlackPlayersPos7:
4512+ B3C4 CD FA 9F         CALL    Utils_PlayBeepTick
4513+ B3C7 16 00            LD      D, 0
4514+ B3C9 1E 01            LD      E, 1
4515+ B3CB D5               PUSH    DE
4516+ B3CC 3E D6            LD      A,TILE_FIELD
4517+ B3CE CD BC 95         CALL    VDP_DrawSprite
4518+ B3D1 D1               POP     DE
4519+ B3D2 16 00            LD      D, 0
4520+ B3D4 1E 03            LD      E, 3
4521+ B3D6 D5               PUSH    DE
4522+ B3D7 3E B0            LD      A,TILE_BLACK_PLAYER
4523+ B3D9 CD BC 95         CALL    VDP_DrawSprite
4524+ B3DC D1               POP     DE
4525+ B3DD
4526+ B3DD 16 02            LD      D, 2
4527+ B3DF 1E 01            LD      E, 1
4528+ B3E1 D5               PUSH    DE
4529+ B3E2 3E B0            LD      A, TILE_BLACK_PLAYER
4530+ B3E4 CD BC 95         CALL    VDP_DrawSprite
4531+ B3E7 D1               POP     DE
4532+ B3E8 16 02            LD      D, 2
4533+ B3EA 1E 03            LD      E, 3
4534+ B3EC D5               PUSH    DE
4535+ B3ED 3E D6            LD      A, TILE_FIELD
4536+ B3EF
4537+ B3EF CD BC 95         CALL    VDP_DrawSprite
4538+ B3F2 D1               POP     DE
4539+ B3F3 C9               RET
4540+ B3F4              ; ---------------------------------------------------------------------------
4541+ B3F4              ; PutCerimonyBlackPlayersPos8
4542+ B3F4              ; ----------------------------------------------------------------------------
4543+ B3F4              PutCerimonyBlackPlayersPos8:
4544+ B3F4 CD FA 9F         CALL    Utils_PlayBeepTick
4545+ B3F7 16 00            LD      D, 0
4546+ B3F9 1E 03            LD      E, 3
4547+ B3FB D5               PUSH    DE
4548+ B3FC 3E D6            LD      A,TILE_FIELD
4549+ B3FE
4550+ B3FE CD BC 95         CALL    VDP_DrawSprite
4551+ B401 D1               POP     DE
4552+ B402 16 00            LD      D, 0
4553+ B404 1E 01            LD      E, 1
4554+ B406 D5               PUSH    DE
4555+ B407 3E B0            LD      A,TILE_BLACK_PLAYER
4556+ B409
4557+ B409 CD BC 95         CALL    VDP_DrawSprite
4558+ B40C D1               POP     DE
4559+ B40D
4560+ B40D 16 02            LD      D, 2
4561+ B40F 1E 03            LD      E, 3
4562+ B411 D5               PUSH    DE
4563+ B412 3E B0            LD      A, TILE_BLACK_PLAYER
4564+ B414
4565+ B414 CD BC 95         CALL    VDP_DrawSprite
4566+ B417 D1               POP     DE
4567+ B418 16 02            LD      D, 2
4568+ B41A 1E 01            LD      E, 1
4569+ B41C D5               PUSH    DE
4570+ B41D 3E D6            LD      A, TILE_FIELD
4571+ B41F
4572+ B41F CD BC 95         CALL    VDP_DrawSprite
4573+ B422 D1               POP     DE
4574+ B423 C9               RET
4575+ B424              ; ---------------------------------------------------------------------------
4576+ B424              ; PutCerimonyBlackPlayersPos9
4577+ B424              ; ----------------------------------------------------------------------------
4578+ B424              PutCerimonyBlackPlayersPos9:
4579+ B424 CD FA 9F         CALL    Utils_PlayBeepTick
4580+ B427 16 00            LD      D, 0
4581+ B429 1E 02            LD      E, 2
4582+ B42B D5               PUSH    DE
4583+ B42C 3E D6            LD      A,TILE_FIELD
4584+ B42E CD BC 95         CALL    VDP_DrawSprite
4585+ B431 D1               POP     DE
4586+ B432 16 00            LD      D, 0
4587+ B434 1E 00            LD      E, 0
4588+ B436 D5               PUSH    DE
4589+ B437 3E B0            LD      A,TILE_BLACK_PLAYER
4590+ B439 CD BC 95         CALL    VDP_DrawSprite
4591+ B43C D1               POP     DE
4592+ B43D
4593+ B43D 16 02            LD      D, 2
4594+ B43F 1E 04            LD      E, 4
4595+ B441 D5               PUSH    DE
4596+ B442 3E B0            LD      A, TILE_BLACK_PLAYER
4597+ B444 CD BC 95           CALL    VDP_DrawSprite
4598+ B447 D1               POP     DE
4599+ B448 16 02            LD      D, 2
4600+ B44A 1E 02            LD      E, 2
4601+ B44C D5               PUSH    DE
4602+ B44D 3E D6            LD      A, TILE_FIELD
4603+ B44F CD BC 95          CALL    VDP_DrawSprite
4604+ B452 D1               POP     DE
4605+ B453 C9               RET
4606+ B454              ; ---------------------------------------------------------------------------
4607+ B454              ; Game_PlayBeep
4608+ B454              ; ----------------------------------------------------------------------------
4609+ B454              Game_PlayBeep:
4610+ B454 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
4611+ B457 FE 01            CP      YES
4612+ B459 C0               RET     NZ
4613+ B45A CD F8 9F         CALL    Utils_PlayBeep
4614+ B45D C9               RET
4615+ B45E              ; ---------------------------------------------------------------------------
4616+ B45E              ; Game_PlayBeepGoalCorner
4617+ B45E              ; ----------------------------------------------------------------------------
4618+ B45E              Game_PlayBeepGoalCorner:
4619+ B45E 3A 6B 86         LD      A, (Var_Game_MatchInProgress)
4620+ B461 FE 01            CP      YES
4621+ B463 C0               RET     NZ
4622+ B464 CD F9 9F         CALL    Utils_PlayBeepGoalCorner
4623+ B467 C9               RET
4624+ B468              ; ---------------------------------------------------------------------------
4625+ B468              ; Game_GoalCelebration_DrawFrame
4626+ B468              ;
4627+ B468              ; INPUT:
4628+ B468              ;   A = tick (8..1)   ; 8 = first move, 1 = last move
4629+ B468
4630+ B468              ;
4631+ B468              ; MODIFIES: AF,BC,DE,HL
4632+ B468              ; ---------------------------------------------------------------------------
4633+ B468              Game_GoalCelebration_DrawFrame:
4634+ B468 E5               PUSH    HL
4635+ B469 D5               PUSH    DE
4636+ B46A C5               PUSH    BC
4637+ B46B F5               PUSH    AF
4638+ B46C 3A 46 86         LD      A, (Var_Game_ActiveFieldSide)
4639+ B46F FE 01            CP      FIELD_NORTH_SIDE
4640+ B471 20 50            JR      NZ, .BlackTeam
4641+ B473              ; ===== WHITE TEAM CELEBRATION =====
4642+ B473              .WhiteTeam:
4643+ B473 F1               POP     AF
4644+ B474 FE 08            CP      8
4645+ B476 20 06            JR      NZ, .White7
4646+ B478 CD F4 B0         CALL    PutCerimonyWhitePlayersPos1
4647+ B47B C3 0F B5         JP      .Done
4648+ B47E              .White7:
4649+ B47E FE 07            CP      7
4650+ B480 20 06            JR      NZ, .White6
4651+ B482 CD 24 B1         CALL    PutCerimonyWhitePlayersPos2
4652+ B485 C3 0F B5         JP      .Done
4653+ B488              .White6:
4654+ B488 FE 06            CP      6
4655+ B48A 20 05            JR      NZ, .White5
4656+ B48C CD 54 B1         CALL    PutCerimonyWhitePlayersPos3
4657+ B48F 18 7E            JR      .Done
4658+ B491              .White5:
4659+ B491 FE 05            CP      5
4660+ B493 20 05            JR      NZ, .White4
4661+ B495 CD 84 B1         CALL    PutCerimonyWhitePlayersPos4
4662+ B498 18 75            JR      .Done
4663+ B49A              .White4:
4664+ B49A FE 04            CP      4
4665+ B49C 20 05            JR      NZ, .White3
4666+ B49E CD B4 B1         CALL    PutCerimonyWhitePlayersPos5
4667+ B4A1 18 6C            JR      .Done
4668+ B4A3              .White3:
4669+ B4A3 FE 03            CP      3
4670+ B4A5 20 05            JR      NZ, .White2
4671+ B4A7 CD E4 B1         CALL    PutCerimonyWhitePlayersPos6
4672+ B4AA 18 63            JR      .Done
4673+ B4AC              .White2:
4674+ B4AC FE 02            CP      2
4675+ B4AE 20 05            JR      NZ, .White1
4676+ B4B0 CD 14 B2         CALL    PutCerimonyWhitePlayersPos7
4677+ B4B3 18 5A            JR      .Done
4678+ B4B5              .White1:
4679+ B4B5 FE 01            CP      1
4680+ B4B7 20 05            JR      NZ, .White0
4681+ B4B9 CD 44 B2         CALL    PutCerimonyWhitePlayersPos8
4682+ B4BC 18 51            JR      .Done
4683+ B4BE              .White0:
4684+ B4BE CD 74 B2         CALL    PutCerimonyWhitePlayersPos9
4685+ B4C1 18 4C            JR      .Done
4686+ B4C3              ; ===== BLACK TEAM CELEBRATION =====
4687+ B4C3              .BlackTeam:
4688+ B4C3 F1               POP     AF
4689+ B4C4 FE 08            CP      8
4690+ B4C6 20 05            JR      NZ, .Black7
4691+ B4C8 CD A4 B2         CALL    PutCerimonyBlackPlayersPos1
4692+ B4CB 18 42            JR      .Done
4693+ B4CD              .Black7:
4694+ B4CD FE 07            CP      7
4695+ B4CF 20 05            JR      NZ, .Black6
4696+ B4D1 CD D4 B2         CALL    PutCerimonyBlackPlayersPos2
4697+ B4D4 18 39            JR      .Done
4698+ B4D6              .Black6:
4699+ B4D6 FE 06            CP      6
4700+ B4D8 20 05            JR      NZ, .Black5
4701+ B4DA CD 04 B3         CALL    PutCerimonyBlackPlayersPos3
4702+ B4DD 18 30            JR      .Done
4703+ B4DF              .Black5:
4704+ B4DF FE 05            CP      5
4705+ B4E1 20 05            JR      NZ, .Black4
4706+ B4E3 CD 34 B3         CALL    PutCerimonyBlackPlayersPos4
4707+ B4E6 18 27            JR      .Done
4708+ B4E8              .Black4:
4709+ B4E8 FE 04            CP      4
4710+ B4EA 20 05            JR      NZ, .Black3
4711+ B4EC CD 64 B3         CALL    PutCerimonyBlackPlayersPos5
4712+ B4EF 18 1E            JR      .Done
4713+ B4F1              .Black3:
4714+ B4F1 FE 03            CP      3
4715+ B4F3 20 05            JR      NZ, .Black2
4716+ B4F5 CD 94 B3         CALL    PutCerimonyBlackPlayersPos6
4717+ B4F8 18 15            JR      .Done
4718+ B4FA              .Black2:
4719+ B4FA FE 02            CP      2
4720+ B4FC 20 05            JR      NZ, .Black1
4721+ B4FE CD C4 B3         CALL    PutCerimonyBlackPlayersPos7
4722+ B501 18 0C            JR      .Done
4723+ B503              .Black1:
4724+ B503 FE 01            CP      1
4725+ B505 20 05            JR      NZ, .Black0
4726+ B507 CD F4 B3         CALL    PutCerimonyBlackPlayersPos8
4727+ B50A 18 03            JR      .Done
4728+ B50C              .Black0:
4729+ B50C CD 24 B4         CALL    PutCerimonyBlackPlayersPos9
4730+ B50F
4731+ B50F              .Done:
4732+ B50F C1               POP     BC
4733+ B510 D1               POP     DE
4734+ B511 E1               POP     HL
4735+ B512 C9               RET
4736+ B513              ; ----- CONSTANTS ------
4737+ B513
# file closed: ./inc/game.asm
  19  B513
  20  B513
  21  B513
  22  B513
  23  B513
  24  B513              InitGame:
  25  B513
  26  B513
  27  B513 CD 09 A0             CALL    Game_InitVariables              ; Initialize the screen
  28  B516
  29  B516 CD 9D 95             CALL    VDP_ClearScreen
  30  B519
  31  B519 CD 8F 95             CALL    VDP_LoadTiles                   ; Load tiles into RAM
  32  B51C                      ;CALL    VDP_SetPatternColors            ; Set pattern colors
  33  B51C
  34  B51C 3E 01                LD      A, FIELD_NORTH_SIDE
  35  B51E 32 46 86             LD      (Var_Game_ActiveFieldSide), A
  36  B521 CD A6 97             CALL    VDP_DrawField
  37  B524                      ;LD      D, 4
  38  B524                      ;LD      E, 4
  39  B524                      ;LD      A, TILE_WHITE_PLAYER
  40  B524                      ;CALL    VDP_DrawSprite
  41  B524 CD 4D A3             CALL     Game_SetWhiteKickoffSchema
  42  B527 CD 15 9B             CALL     VDP_PlayerMatrixRedraw
  43  B52A
  44  B52A CD 1C 9D             CALL    Menu_Show
  45  B52D CD CD 86             CALL    Hooks_Init                      ; Install the VBlank hook
  46  B530
  47  B530              MainLoop:
  48  B530 18 FE                JR      MainLoop
  49  B532
  50  B532
  51  B532                       SAVESNA "./out/gssoccer.sna", InitGame
  52  B532              END
  53  B532
  54  B532
  55  B532
  56  B532
  57  B532
  58  B532
# file closed: ./src/GSSOCCER.asm
