# file opened: ./src/GSSOCCER.asm
   1  0000              ; ===================================================================
   2  0000              ; GS11-Soccer - 2025 Fausto Pracek
   3  0000              ; ===================================================================
   4  0000
   5  0000              ; *** GSSOCCER.ASM ***
   6  0000
   7  0000                  DEVICE ZXSPECTRUM48
   8  0000                  SLDOPT COMMENT WPMEM, LOGPOINT, ASSERTION
   9  0000
  10  0000                  ORG 0x8000               ; Loader address (0x8000)
  11  8000
  12  8000                  INCLUDE "constants.asm"
# file opened: ./inc/constants.asm
   1+ 8000              ; ===================================================================
   2+ 8000              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8000              ; ===================================================================
   4+ 8000
   5+ 8000              ; *** CONSTANTS.ASM ***
   6+ 8000
   7+ 8000
   8+ 8000
   9+ 8000
  10+ 8000
  11+ 8000              PSG_SEL:                                        EQU 0A0h
  12+ 8000              PSG_WR:                                         EQU 0A1h
  13+ 8000              PSG_RD:                                         EQU 0A2h
  14+ 8000              SCR_BASE:                                       EQU 0x4000      ; Base address of the Spectrum screen
  15+ 8000              ATTR_BASE:                                      EQU 0x5800      ; Start of the attribute area
  16+ 8000              ROM_CHAR_SET_ADDRESS:                           EQU 0x3D00      ; Start of the ROM character set
  17+ 8000              RAM_CHAR_SET_ADDRESS:                           EQU 0xB500      ; Start of the RAM character set
  18+ 8000
  19+ 8000              MATCH_TIME:                                     EQU 60
  20+ 8000              TICK_SPEED:                                     EQU 5
  21+ 8000
  22+ 8000              TILE_CORNER:                                    EQU 0
  23+ 8000              TILE_WHITE_PLAYER_WITH_BALL:                    EQU 1
  24+ 8000              TILE_BLACK_PLAYER_WITH_BACK_BALL:               EQU 2
  25+ 8000              TILE_CORNER_BALL:                               EQU 3
  26+ 8000              TILE_CORNER_BALL_EMPTY:                         EQU 4
  27+ 8000              TILE_REMOVE_WHITE_PLAYER_AND_BALL:              EQU 5
  28+ 8000              TILE_BALL_TOP:                                  EQU 6
  29+ 8000              TILE_BALL_TOP_FRONT:                            EQU 7
  30+ 8000              TILE_BALL_BOTTOM:                               EQU 64
  31+ 8000              TILE_WHITE_PLAYER_NEAR_HALF_FIELD:              EQU 80
  32+ 8000              TILE_WHITE_GOALKEEPER:                          EQU 96
  33+ 8000              TILE_WHITE_GOALKEEPER_WITH_BALL:                EQU 112
  34+ 8000              TILE_BLACK_GOALKEEPER:                          EQU 128
  35+ 8000              TILE_BLACK_GOALKEEPER_WITH_BALL:                EQU 144
  36+ 8000              TILE_WHITE_PLAYER:                              EQU 160
  37+ 8000              TILE_BLACK_PLAYER:                              EQU 176
  38+ 8000              TILE_BLACK_PLAYER_WITH_BALL:                    EQU 192
  39+ 8000              TILE_FIELD_LINE_TOP_LEFT:                       EQU 208
  40+ 8000              TILE_FIELD_LINE_VERTICAL:                       EQU 209
  41+ 8000              TILE_FIELD_LINE_HORIZONTAL:                     EQU 210
  42+ 8000              TILE_FIELD_LINE_TOP_RIGHT:                      EQU 211
  43+ 8000              TILE_FIELD_LINE_BOTTOM_LEFT:                    EQU 212
  44+ 8000              TILE_FIELD_LINE_BOTTOM_RIGHT:                   EQU 213
  45+ 8000              TILE_FIELD:                                     EQU 214
  46+ 8000              TILE_FIELD_LINE_LEFT_CROSS:                     EQU 215
  47+ 8000              TILE_FIELD_LINE_RIGHT_CROSS:                    EQU 216
  48+ 8000              TILE_FIELD_LINE_WHITE_PLAYER_1:                 EQU 217
  49+ 8000              TILE_FIELD_LINE_WHITE_PLAYER_2:                 EQU 218
  50+ 8000              TILE_BALL_BOTTOM_LEFT:                          EQU TILE_BALL_BOTTOM + 14   ; 78
  51+ 8000              TILE_BALL_BOTTOM_RIGHT:                         EQU TILE_BALL_BOTTOM + 15   ; 79
  52+ 8000              TILE_BALL_TOP_LEFT:                             EQU 221
  53+ 8000              TILE_BALL_TOP_RIGHT:                            EQU 222
  54+ 8000              TILE_BALL_FEET_OVERLAY_L:                       EQU 219   ; già esistente (top-left)
  55+ 8000              TILE_BALL_FEET_OVERLAY_R:                       EQU 220   ; già esistente (top-right)
  56+ 8000              TILE_BALL_BACK_OVERLAY_L:                       EQU 221   ; nuovo: spalla, parte sinistra
  57+ 8000              TILE_BALL_BACK_OVERLAY_R:                       EQU 222   ; nuovo: spalla, parte destra
  58+ 8000              TILE_WHITE_PLAYER_AND_BALL:                     EQU 223
  59+ 8000
  60+ 8000
  61+ 8000
  62+ 8000              TILE_PLAYERS_COLOR:                             EQU 0x13
  63+ 8000              TILE_FIELDS_LINES_COLOR:                        EQU 0x13
  64+ 8000              TILE_BALL_BOTTOM_L:                             EQU TILE_BALL_BOTTOM + 13
  65+ 8000              TILE_BALL_BOTTOM_R:                             EQU TILE_BALL_BOTTOM + 14
  66+ 8000
  67+ 8000              GREEN_CHAR_ATTRIBUTE:                           EQU 0x20  ; Green on black
  68+ 8000
  69+ 8000              FIELD_NORTH_SIDE:                               EQU 1
  70+ 8000              FIELD_SOUTH_SIDE:                               EQU 0
  71+ 8000              YES:                                            EQU 1
  72+ 8000              NO:                                             EQU 0
  73+ 8000              GAME_MODE_2_PLAYERS:                            EQU 2
  74+ 8000              GAME_MODE_1_PLAYER:                             EQU 1
  75+ 8000              NO_VALUE:                                       EQU 255
  76+ 8000              TEAM_WHITE:                                     EQU 1
  77+ 8000              TEAM_BLACK:                                     EQU 0
  78+ 8000              ROLE_GOALKEEPER:                                EQU 0
  79+ 8000              ROLE_DEFENDER:                                  EQU 1
  80+ 8000              ROLE_MIDFIELDER:                                EQU 2
  81+ 8000              ROLE_STRIKER:                                   EQU 3
  82+ 8000
  83+ 8000              PLAYER_ENTRY_SIZE:                              EQU 7  ; bytes per player entry in Var_Game_PlayersInfo
  84+ 8000
  85+ 8000              BALL_DIRECTION_NONE:                            EQU 0
  86+ 8000              BALL_DIRECTION_NORTH:                           EQU 1
  87+ 8000              BALL_DIRECTION_NORTH_EAST:                      EQU 2
  88+ 8000              BALL_DIRECTION_NORTH_WEST:                      EQU 3
  89+ 8000              BALL_DIRECTION_SOUTH:                           EQU 4
  90+ 8000              BALL_DIRECTION_SOUTH_EAST:                      EQU 5
  91+ 8000              BALL_DIRECTION_SOUTH_WEST:                      EQU 6
  92+ 8000
  93+ 8000              PLAYER_ASKED_DIRECTION_EAST:                    EQU 1
  94+ 8000              PLAYER_ASKED_DIRECTION_WEST:                    EQU 2
  95+ 8000              PLAYER_ASKED_DIRECTION_NORTH:                   EQU 3
  96+ 8000              PLAYER_ASKED_DIRECTION_SOUTH:                   EQU 4
  97+ 8000
  98+ 8000              DEMO_MODE_LEVEL:                                EQU 4
  99+ 8000
 100+ 8000              BALL_STATUS_MOVING:                             EQU 100
 101+ 8000              BALL_STATUS_CONTENDED:                          EQU 101
 102+ 8000              BALL_STATUS_FREE:                               EQU 102
 103+ 8000
 104+ 8000              SUCCESS:                                        EQU 1
 105+ 8000              FAILURE:                                        EQU 0
 106+ 8000
 107+ 8000              VDP_DATA:                                       EQU 098h
 108+ 8000              VDP_ADDR:                                       EQU 099h
 109+ 8000
 110+ 8000              BLINK_TYPE_GOAL:                                EQU 1
 111+ 8000              BLINK_TYPE_CORNER:                              EQU 2
 112+ 8000              BLINK_TYPE_GOALKEEPER:                          EQU 3
 113+ 8000              BLINK_FRAMES_DURATION:                          EQU 30
 114+ 8000
 115+ 8000              FIRST_KICK_TYPE_WHITE_HALF_FIELD:               EQU 1
 116+ 8000              FIRST_KICK_TYPE_BLACK_HALF_FIELD:               EQU 2
 117+ 8000              FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD:             EQU 3
 118+ 8000              FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD:             EQU 4
 119+ 8000
 120+ 8000
 121+ 8000              CERIMONY_MOVEMENT_SPEED:                        EQU 20
 122+ 8000
 123+ 8000              KBD_KEY_NONE:                                   EQU 0
 124+ 8000              KBD_KEY_SPACE:                                  EQU 32
 125+ 8000
 126+ 8000              KBD_KEY_UP:                                     EQU 55
 127+ 8000              KBD_KEY_DOWN:                                   EQU 54
 128+ 8000              KBD_KEY_LEFT:                                   EQU 53
 129+ 8000              KBD_KEY_RIGHT:                                  EQU 56
 130+ 8000
 131+ 8000
 132+ 8000              KBD_KEY_W:                                      EQU 87
 133+ 8000              KBD_KEY_A:                                      EQU 65
 134+ 8000              KBD_KEY_S:                                      EQU 83
 135+ 8000
 136+ 8000
 137+ 8000              KBD_KEY_J:                                      EQU 74
 138+ 8000              KBD_KEY_K:                                      EQU 75
 139+ 8000              KBD_KEY_I:                                      EQU 73
 140+ 8000
 141+ 8000 FE 23 5A 58  KEYBOARD_MAP:                                   DEFB #FE,"#","Z","X","C","V"
 141+ 8004 43 56
 142+ 8006 FD 41 53 44                                                  DEFB #FD,"A","S","D","F","G"
 142+ 800A 46 47
 143+ 800C FB 51 57 45                                                  DEFB #FB,"Q","W","E","R","T"
 143+ 8010 52 54
 144+ 8012 F7 31 32 33                                                  DEFB #F7,"1","2","3","4","5"
 144+ 8016 34 35
 145+ 8018 EF 30 39 38                                                  DEFB #EF,"0","9","8","7","6"
 145+ 801C 37 36
 146+ 801E DF 50 4F 49                                                  DEFB #DF,"P","O","I","U","Y"
 146+ 8022 55 59
 147+ 8024 BF 23 4C 4B                                                  DEFB #BF,"#","L","K","J","H"
 147+ 8028 4A 48
 148+ 802A 7F 20 23 4D                                                  DEFB #7F," ","#","M","N","B"
 148+ 802E 4E 42
 149+ 8030
 150+ 8030 3C 32 50 4C  TXT_GAME_MODE_2_PLAYERS:                        DEFB "<2PLYS>",0
 150+ 8034 59 53 3E 00
 151+ 8038 3C 20 43 50  TXT_CPU:                                        DEFB "< CPU >",0
 151+ 803C 55 20 3E 00
 152+ 8040 5E 4C 45 56  TXT_LEVEL_1:                                    DEFB "^LEV.1",0
 152+ 8044 2E 31 00
 153+ 8047 5E 4C 45 56  TXT_LEVEL_2:                                    DEFB "^LEV.2",0
 153+ 804B 2E 32 00
 154+ 804E 5E 4C 45 56  TXT_LEVEL_3:                                    DEFB "^LEV.3",0
 154+ 8052 2E 33 00
 155+ 8055 5E 4C 45 56  TXT_LEVEL_4:                                    DEFB "^LEV.4",0
 155+ 8059 2E 34 00
 156+ 805C 5E 4C 45 56  TXT_LEVEL_5:                                    DEFB "^LEV.5",0
 156+ 8060 2E 35 00
 157+ 8063 20 20 20 20  TXT_LEVEL_NO:                                   DEFB "       ",0
 157+ 8067 20 20 20 00
 158+ 806B 50 4C 41 59  TXT_BTN_PLY1_1:                                 DEFB "PLAYER 1",0
 158+ 806F 45 52 20 31
 158+ 8073 00
 159+ 8074 5E 20 53 48  TXT_BTN_PLY1_2:                                 DEFB "^ SHOT",0
 159+ 8078 4F 54 00
 160+ 807B 3C 20 4C 45  TXT_BTN_PLY1_3:                                 DEFB "< LEFT",0
 160+ 807F 46 54 00
 161+ 8082 3E 20 52 49  TXT_BTN_PLY1_4:                                 DEFB "> RIGHT",0
 161+ 8086 47 48 54 00
 162+ 808A 20 20 20 20  TXT_BTN_PLY1_5:                                 DEFB "       ",0 ; OR JOY1
 162+ 808E 20 20 20 00
 163+ 8092 50 4C 41 59  TXT_BTN_PLY2_1:                                 DEFB "PLAYER 2",0
 163+ 8096 45 52 20 32
 163+ 809A 00
 164+ 809B 57 20 53 48  TXT_BTN_PLY2_2:                                 DEFB "W SHOT",0
 164+ 809F 4F 54 00
 165+ 80A2 41 20 4C 45  TXT_BTN_PLY2_3:                                 DEFB "A LEFT",0
 165+ 80A6 46 54 00
 166+ 80A9 53 20 52 49  TXT_BTN_PLY2_4:                                 DEFB "S RIGHT",0
 166+ 80AD 47 48 54 00
 167+ 80B1 20 20 20 20  TXT_BTN_PLY2_5:                                 DEFB "       ",0 ; OR JOY2
 167+ 80B5 20 20 20 00
 168+ 80B9 20 53 50 41  TXT_SPACE:                                      DEFB " SPACE ",0 ; SPC/FIRE
 168+ 80BD 43 45 20 00
 169+ 80C1 54 4F 20 53  TXT_START:                                      DEFB "TO START",0
 169+ 80C5 54 41 52 54
 169+ 80C9 00
 170+ 80CA 47 53 53 4F  TXT_GSSOCCER:                                   DEFB "GSSOCCER",0
 170+ 80CE 43 43 45 52
 170+ 80D2 00
 171+ 80D3 32 30 32 35  TXT_2025:                                       DEFB "2025",0
 171+ 80D7 00
 172+ 80D8 46 2E 50 52  TXT_PRACEK:                                     DEFB "F.PRACEK",0
 172+ 80DC 41 43 45 4B
 172+ 80E0 00
 173+ 80E1 20 20 20 20  TXT_EMPTY:                                      DEFB "        ",0
 173+ 80E5 20 20 20 20
 173+ 80E9 00
 174+ 80EA 54 49 4D 45  TXT_TIME:                                       DEFB "TIME",0
 174+ 80EE 00
 175+ 80EF 56 49 53 49  TXT_BLACK_TEAM:                                 DEFB "VISITORS",0
 175+ 80F3 54 4F 52 53
 175+ 80F7 00
 176+ 80F8 48 4F 4D 45  TXT_WHITE_TEAM:                                 DEFB "HOME",0
 176+ 80FC 00
 177+ 80FD 47 41 4D 45  TXT_GAME_OVER:                                  DEFB "GAME OVER",0
 177+ 8101 20 4F 56 45
 177+ 8105 52 00
# file closed: ./inc/constants.asm
  13  8107                  INCLUDE "string.asm"						; Include hooks library
# file opened: ./inc/string.asm
   1+ 8107              ; ===================================================================
   2+ 8107              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8107              ; ===================================================================
   4+ 8107
   5+ 8107              ; *** STRING.ASM ***
   6+ 8107
   7+ 8107              ; ------ ROUTINES ------
   8+ 8107
   9+ 8107              ;--------------------------------------------------------------------------
  10+ 8107              ; Convert a 16-bit unsigned number to a string of ASCII digits.
  11+ 8107              ; INPUT:
  12+ 8107              ;   HL = the 16-bit unsigned number to convert.
  13+ 8107              ; OUTPUT: -
  14+ 8107              ; MODIFY: HL, DE, BC, AF
  15+ 8107              ;--------------------------------------------------------------------------
  16+ 8107              String_NumberToASCII:
  17+ 8107 01 F0 D8        LD       BC,-10000
  18+ 810A CD 20 81        CALL     .Num1
  19+ 810D 01 18 FC        LD       BC,-1000
  20+ 8110 CD 20 81        CALL     .Num1
  21+ 8113 01 9C FF        LD       BC,-100
  22+ 8116 CD 20 81        CALL     .Num1
  23+ 8119 0E F6           LD       C,-10
  24+ 811B CD 20 81        CALL     .Num1
  25+ 811E 0E FF           LD       C,-1
  26+ 8120              .Num1:
  27+ 8120 3E 2F           LD       A,'0'-1
  28+ 8122              .Num2:
  29+ 8122 3C              INC      A
  30+ 8123 09              ADD      HL, BC
  31+ 8124 DA 22 81        JP       C, .Num2
  32+ 8127 ED 42           SBC      HL, BC
  33+ 8129 12              LD       (DE), A
  34+ 812A 13              INC      DE
  35+ 812B C9              RET
  36+ 812C
  37+ 812C              ;---------------------------------------------------------------------
  38+ 812C              ; Remove leading zeros from the string
  39+ 812C              ; INPUT:
  40+ 812C              ;   HL: Pointer to the string
  41+ 812C              ; OUTPUT: -
  42+ 812C              ; MODIFY: HL, AF, BC
  43+ 812C              ;---------------------------------------------------------------------
  44+ 812C              String_RemoveLeadingZeros:
  45+ 812C CD 40 81         CALL    String_GetLength  ; Get the length of the string
  46+ 812F 47               LD      B, A            ; Set B to the number of digits
  47+ 8130              .Loop:
  48+ 8130                  ; Check if we are at the last digit; if so, exit.
  49+ 8130 78               LD      A, B
  50+ 8131 FE 01            CP      1
  51+ 8133 C8               RET     Z
  52+ 8134                  ; Load the current character.
  53+ 8134 7E               LD      A, (HL)
  54+ 8135 FE 30            CP      '0'
  55+ 8137 C0               RET     NZ  ; If the character is not '0', we've reached the first
  56+ 8138                                        ; nonzero digit; stop replacing.
  57+ 8138                  ; Replace the '0' with a space.
  58+ 8138 3E 20            LD       A, ' '
  59+ 813A 77               LD      (HL), A
  60+ 813B 23               INC     HL              ; Advance to the next character.
  61+ 813C 05               DEC     B               ; Decrement the digit counter.
  62+ 813D C3 30 81         JP      .Loop
  63+ 8140
  64+ 8140
  65+ 8140
  66+ 8140              ;---------------------------------------------------------------------
  67+ 8140              ; Get the length of a string in bytes
  68+ 8140              ; INPUT:
  69+ 8140              ;   HL: Pointer to the string
  70+ 8140              ; OUTPUT: -
  71+ 8140              ; MODIFY: HL, AF, BC
  72+ 8140              ;---------------------------------------------------------------------
  73+ 8140              String_GetLength:
  74+ 8140 E5               PUSH    HL          ; save HL
  75+ 8141 AF               XOR     A           ; A = 0
  76+ 8142 47               LD      B, A        ; B = 0 (length counter)
  77+ 8143
  78+ 8143              .Loop:
  79+ 8143 7E               LD      A, (HL)     ; load byte
  80+ 8144 B7               OR      A           ; set Z if it’s zero
  81+ 8145 CA 4D 81         JP      Z, .Done
  82+ 8148 04               INC     B           ; increment length
  83+ 8149 23               INC     HL
  84+ 814A C3 43 81         JP      .Loop
  85+ 814D
  86+ 814D              .Done:
  87+ 814D E1               POP     HL          ; restore HL
  88+ 814E 78               LD      A, B        ; return length in A
  89+ 814F C9               RET
  90+ 8150
# file closed: ./inc/string.asm
  14  8150              	INCLUDE "hooks.asm"						; Include hooks library
# file opened: ./inc/hooks.asm
   1+ 8150              ; ===================================================================
   2+ 8150              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8150              ; ===================================================================
   4+ 8150
   5+ 8150              ; *** HOOKS.ASM ***
   6+ 8150
   7+ 8150
   8+ 8150
   9+ 8150              ; Hooks_TickStart
  10+ 8150              ;----------------------------------------------------------------------
  11+ 8150              Hooks_TickStart:
  12+ 8150 F5               PUSH    AF
  13+ 8151 3E 00            LD      A, NO
  14+ 8153 32 41 B2         LD      (Var_Hooks_TickSuspended), A
  15+ 8156 F1               POP     AF
  16+ 8157 C9               RET
  17+ 8158              ;----------------------------------------------------------------------
  18+ 8158              ; Hooks_TickStop
  19+ 8158              ;----------------------------------------------------------------------
  20+ 8158              Hooks_TickStop:
  21+ 8158 F5               PUSH    AF
  22+ 8159 3E 01            LD      A, YES
  23+ 815B 32 41 B2         LD      (Var_Hooks_TickSuspended), A
  24+ 815E F1               POP     AF
  25+ 815F C9               RET
  26+ 8160
  27+ 8160              ;----------------------------------------------------------------------
  28+ 8160              ; VBlank ISR
  29+ 8160              ; INPUT: -
  30+ 8160              ; OUTPUT: -
  31+ 8160              ; MODIFIES: A, DE, HL, BC
  32+ 8160              ;----------------------------------------------------------------------
  33+ 8160              VBlankISR:
  34+ 8160 F5               PUSH    AF
  35+ 8161 C5               PUSH    BC
  36+ 8162 D5               PUSH    DE
  37+ 8163 E5               PUSH    HL
  38+ 8164
  39+ 8164
  40+ 8164
  41+ 8164 3A 30 B2         LD      A, (Var_Hooks_FrameCounter)
  42+ 8167 3C               INC     A
  43+ 8168 FE 33            CP      51
  44+ 816A 20 22            JR      NZ, .Continue
  45+ 816C
  46+ 816C 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
  47+ 816F FE 00            CP      NO
  48+ 8171 28 07            JR      Z, .Time
  49+ 8173 3A DF B1         LD      A, (Var_Game_TimeToPlay)
  50+ 8176 3D               DEC     A
  51+ 8177 32 DF B1         LD      (Var_Game_TimeToPlay), A
  52+ 817A              .Time:
  53+ 817A 3A 48 B2         LD      A, (Var_Hooks_SecondsCounter)
  54+ 817D 3C               INC     A
  55+ 817E FE 3D            CP      61
  56+ 8180 20 08            JR      NZ, .NewMinute
  57+ 8182 3A 49 B2         LD      A, (Var_Hooks_MinutesCounter)
  58+ 8185 3C               INC     A
  59+ 8186 32 49 B2         LD      (Var_Hooks_MinutesCounter), A
  60+ 8189 AF               XOR     A           ; Reset the seconds counter
  61+ 818A              .NewMinute:
  62+ 818A 32 48 B2         LD      (Var_Hooks_SecondsCounter), A
  63+ 818D AF               XOR     A       ; Reset the frame counter
  64+ 818E              .Continue:
  65+ 818E 32 30 B2         LD      (Var_Hooks_FrameCounter), A
  66+ 8191              .Done:
  67+ 8191 3A 3F B2         LD      A, (Var_Hooks_GoalCerimonyCounter)
  68+ 8194 FE 00            CP      0
  69+ 8196 28 08            JR      Z, .AfterGoalCerimony
  70+ 8198 FE FF            CP      NO_VALUE
  71+ 819A CA 06 85         JP      Z, .CheckBlinkingRestartAfterGoal
  72+ 819D C3 06 84         JP      .ShowGoalCerimony
  73+ 81A0              .AfterGoalCerimony:
  74+ 81A0 CD 4B 93         CALL    Utils_PlayBeepHighLong
  75+ 81A3 3A 37 B2         LD      A, (Var_Hooks_GameResumingWaiting)
  76+ 81A6 FE 01            CP      YES
  77+ 81A8 CA F0 83         JP      Z, .CheckGameResumeWaiting
  78+ 81AB 3A 41 B2         LD      A, (Var_Hooks_TickSuspended)
  79+ 81AE FE 01            CP      YES
  80+ 81B0 28 03            JR      Z, .AfterTick
  81+ 81B2 CD 66 85         CALL    AiTick
  82+ 81B5              .AfterTick:
  83+ 81B5 3A 3D B2         LD     A, (Var_Hooks_ForceVdpRedraw)
  84+ 81B8 FE 01            CP     YES
  85+ 81BA 20 0B            JR     NZ, .AfterRedraw
  86+ 81BC 3E 00            LD     A, NO
  87+ 81BE 32 3D B2         LD     (Var_Hooks_ForceVdpRedraw), A
  88+ 81C1 CD 27 A2         CALL   Game_SetVisibileFieldSide
  89+ 81C4 CD D1 8E         CALL   VDP_PlayerMatrixRedraw
  90+ 81C7              .AfterRedraw:
  91+ 81C7 3A EC B1         LD      A, (Var_Game_FirstKickType)
  92+ 81CA FE FF            CP      NO_VALUE
  93+ 81CC 28 03            JR      Z, .AfterFirtsKickCheck
  94+ 81CE C3 50 83         JP      .CheckFirstKick
  95+ 81D1              .AfterFirtsKickCheck:
  96+ 81D1 3A 39 B2         LD      A, (Var_Hooks_BlinkingIsActive)
  97+ 81D4 FE 01            CP      YES
  98+ 81D6 CA 84 84         JP      Z, .CheckBlinkingState
  99+ 81D9              .AfterBlinkingCheck:
 100+ 81D9 CD 26 A1         CALL   Game_CheckStoppedBallOnGoalOrCorner
 101+ 81DC
 102+ 81DC
 103+ 81DC CD 38 85         CALL    UpdateMatchTime
 104+ 81DF              .ReadKeyBoard:
 105+ 81DF CD D5 92         CALL    Utils_ReadKeyboard
 106+ 81E2 FE 20            CP      KBD_KEY_SPACE
 107+ 81E4 CA 39 82         JP      Z, .SpaceButtonPressed
 108+ 81E7 FE 35            CP      KBD_KEY_LEFT
 109+ 81E9 CA 6A 82         JP      Z, .LeftArrowPressed
 110+ 81EC FE 38            CP      KBD_KEY_RIGHT
 111+ 81EE CA 8E 82         JP      Z, .RightArrowPressed
 112+ 81F1 FE 36            CP      KBD_KEY_DOWN
 113+ 81F3 CA 78 82         JP      Z, .DownArrowPressed
 114+ 81F6 FE 37            CP      KBD_KEY_UP
 115+ 81F8 CA 23 82         JP      Z, .UpArrowPressed
 116+ 81FB FE 57            CP      KBD_KEY_W
 117+ 81FD CA 10 82         JP      Z, .WKeyPressed
 118+ 8200 FE 41            CP      KBD_KEY_A
 119+ 8202 CA 44 82         JP      Z, .AKeyPressed
 120+ 8205 FE 53            CP      KBD_KEY_S
 121+ 8207 CA 57 82         JP      Z, .SKeyPressed
 122+ 820A              .Exit
 123+ 820A E1               POP    HL
 124+ 820B D1               POP    DE
 125+ 820C C1               POP    BC
 126+ 820D F1               POP    AF
 127+ 820E ED 4D            RETI ;JP     Var_Hooks_Old_HTIMI    ; return to the original code (inside the BIOS)
 128+ 8210              .WKeyPressed:
 129+ 8210 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 130+ 8213 FE 00            CP      NO
 131+ 8215 CA 40 84         JP      Z, .StartGame
 132+ 8218 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 133+ 821B FE 01            CP      GAME_MODE_1_PLAYER
 134+ 821D CA 0A 82         JP      Z, .Exit
 135+ 8220 C3 DC 82         JP      .BlackTeamTryShotOrRestart
 136+ 8223              .UpArrowPressed:
 137+ 8223 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 138+ 8226 FE 01            CP      YES
 139+ 8228 CA 16 83         JP      Z, .WhiteTeamTryShotOrRestart
 140+ 822B 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 141+ 822E FE 01            CP      GAME_MODE_1_PLAYER
 142+ 8230 C2 0A 82         JP      NZ, .Exit
 143+ 8233 C3 D3 83         JP     .LevelUp
 144+ 8236 C3 0A 82         JP      .Exit
 145+ 8239              .SpaceButtonPressed:
 146+ 8239 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 147+ 823C FE 00            CP      NO
 148+ 823E CA 40 84         JP      Z, .StartGame
 149+ 8241 C3 16 83         JP      .WhiteTeamTryShotOrRestart
 150+ 8244              .AKeyPressed:
 151+ 8244 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 152+ 8247 FE 00            CP      NO
 153+ 8249 CA 0A 82         JP      Z, .Exit
 154+ 824C 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 155+ 824F FE 01            CP      GAME_MODE_1_PLAYER
 156+ 8251 CA 0A 82         JP      Z, .Exit
 157+ 8254 C3 9C 82         JP     .BlackTeamMoveLeft
 158+ 8257              .SKeyPressed:
 159+ 8257 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 160+ 825A FE 00            CP      NO
 161+ 825C CA 0A 82         JP      Z, .Exit
 162+ 825F 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 163+ 8262 FE 01            CP      GAME_MODE_1_PLAYER
 164+ 8264 CA 0A 82         JP      Z, .Exit
 165+ 8267 C3 AC 82         JP     .BlackTeamMoveRight
 166+ 826A              .LeftArrowPressed:
 167+ 826A 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 168+ 826D FE 01            CP      YES
 169+ 826F CA BC 82         JP      Z, .WhiteTeamMoveLeft
 170+ 8272 C3 93 83         JP     .ChangeGameSelectedMode
 171+ 8275 C3 0A 82         JP      .Exit
 172+ 8278              .DownArrowPressed:
 173+ 8278 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 174+ 827B FE 01            CP      YES
 175+ 827D CA 0A 82         JP      Z, .Exit
 176+ 8280 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 177+ 8283 FE 01            CP      GAME_MODE_1_PLAYER
 178+ 8285 C2 0A 82         JP      NZ, .Exit
 179+ 8288 C3 B6 83         JP     .LevelDown
 180+ 828B C3 0A 82         JP      .Exit
 181+ 828E              .RightArrowPressed:
 182+ 828E 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 183+ 8291 FE 01            CP      YES
 184+ 8293 CA CC 82         JP      Z, .WhiteTeamMoveRight
 185+ 8296 C3 93 83         JP     .ChangeGameSelectedMode
 186+ 8299 C3 0A 82         JP     .Exit
 187+ 829C              .BlackTeamMoveLeft:
 188+ 829C 3A EC B1         LD      A, (Var_Game_FirstKickType)
 189+ 829F FE FF            CP      NO_VALUE
 190+ 82A1 C2 0A 82         JP      NZ, .Exit
 191+ 82A4 3E 02            LD      A, PLAYER_ASKED_DIRECTION_WEST
 192+ 82A6 CD B2 9F         CALL    Game_BlackTeamHorizMoveAsked
 193+ 82A9 C3 0A 82         JP      .Exit
 194+ 82AC              .BlackTeamMoveRight:
 195+ 82AC 3A EC B1         LD      A, (Var_Game_FirstKickType)
 196+ 82AF FE FF            CP      NO_VALUE
 197+ 82B1 C2 0A 82         JP      NZ, .Exit
 198+ 82B4 3E 01            LD      A, PLAYER_ASKED_DIRECTION_EAST
 199+ 82B6 CD B2 9F         CALL    Game_BlackTeamHorizMoveAsked
 200+ 82B9 C3 0A 82         JP      .Exit
 201+ 82BC              .WhiteTeamMoveLeft:
 202+ 82BC 3A EC B1         LD      A, (Var_Game_FirstKickType)
 203+ 82BF FE FF            CP      NO_VALUE
 204+ 82C1 C2 0A 82         JP      NZ, .Exit
 205+ 82C4 3E 02            LD      A, PLAYER_ASKED_DIRECTION_WEST
 206+ 82C6 CD 4E A0         CALL    Game_WhiteTeamHorizMoveAsked
 207+ 82C9 C3 0A 82         JP      .Exit
 208+ 82CC              .WhiteTeamMoveRight:
 209+ 82CC 3A EC B1         LD      A, (Var_Game_FirstKickType)
 210+ 82CF FE FF            CP      NO_VALUE
 211+ 82D1 C2 0A 82         JP      NZ, .Exit
 212+ 82D4 3E 01            LD      A, PLAYER_ASKED_DIRECTION_EAST
 213+ 82D6 CD 4E A0         CALL    Game_WhiteTeamHorizMoveAsked
 214+ 82D9 C3 0A 82         JP      .Exit
 215+ 82DC              .BlackTeamTryShotOrRestart:
 216+ 82DC 3A EC B1         LD      A, (Var_Game_FirstKickType)
 217+ 82DF FE FF            CP      NO_VALUE
 218+ 82E1 28 21            JR      Z, .BlackTeamTryShot
 219+ 82E3 FE 02            CP      FIRST_KICK_TYPE_BLACK_HALF_FIELD
 220+ 82E5 28 11            JR      Z,.BlackTeamRestartFromHalfField
 221+ 82E7 FE 04            CP      FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
 222+ 82E9 C2 0A 82         JP      NZ, .Exit
 223+ 82EC 3A C3 B1         LD      A, (Var_Game_SecondsToPlay)
 224+ 82EF 32 DF B1         LD      (Var_Game_TimeToPlay),A
 225+ 82F2 C3 6A 99         JP      Resume_BlackGoalKick.exec
 226+ 82F5 C3 0A 82         JP      .Exit
 227+ 82F8              .BlackTeamRestartFromHalfField:
 228+ 82F8 3A C3 B1         LD      A, (Var_Game_SecondsToPlay)
 229+ 82FB 32 DF B1         LD      (Var_Game_TimeToPlay),A
 230+ 82FE C3 B0 99         JP      Resume_BlackKickoff.exec
 231+ 8301 C3 0A 82         JP      .Exit
 232+ 8304              .BlackTeamTryShot:
 233+ 8304 CD 5A 9A         CALL    Game_GetPlayerIdWithBall
 234+ 8307 FE 00            CP      TEAM_BLACK
 235+ 8309 C2 0A 82         JP      NZ, .Exit
 236+ 830C 3E 00            LD      A, TEAM_BLACK
 237+ 830E 47               LD      B, A
 238+ 830F 4C               LD      C, H
 239+ 8310 CD CA 9C         CALL    Game_TryShot
 240+ 8313 C3 0A 82         JP      .Exit
 241+ 8316              .WhiteTeamTryShotOrRestart:
 242+ 8316 3A EC B1         LD      A, (Var_Game_FirstKickType)
 243+ 8319 FE FF            CP      NO_VALUE
 244+ 831B 28 21            JR      Z, .WhiteTeamTryShot
 245+ 831D FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 246+ 831F 28 11            JR      Z,.WhiteTeamRestartFromHalfField
 247+ 8321 FE 03            CP      FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
 248+ 8323 C2 0A 82         JP      NZ, .Exit
 249+ 8326 3A C3 B1         LD      A, (Var_Game_SecondsToPlay)
 250+ 8329 32 DF B1         LD      (Var_Game_TimeToPlay),A
 251+ 832C C3 1A 99         JP      Resume_WhiteGoalKick.exec
 252+ 832F C3 0A 82         JP      .Exit
 253+ 8332              .WhiteTeamRestartFromHalfField:
 254+ 8332 3A C3 B1         LD      A, (Var_Game_SecondsToPlay)
 255+ 8335 32 DF B1         LD      (Var_Game_TimeToPlay),A
 256+ 8338 C3 F6 99         JP      Resume_WhiteKickoff.exec
 257+ 833B C3 0A 82         JP      .Exit
 258+ 833E              .WhiteTeamTryShot:
 259+ 833E CD 5A 9A         CALL    Game_GetPlayerIdWithBall
 260+ 8341 FE 01            CP      TEAM_WHITE
 261+ 8343 C2 0A 82         JP      NZ, .Exit
 262+ 8346 3E 01            LD      A, TEAM_WHITE
 263+ 8348 47               LD      B, A
 264+ 8349 4C               LD      C, H
 265+ 834A CD CA 9C         CALL    Game_TryShot
 266+ 834D C3 0A 82         JP      .Exit
 267+ 8350              .CheckFirstKick:
 268+ 8350 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 269+ 8353 FE 00            CP      NO
 270+ 8355 28 10            JR      Z, .CheckFirstKickCpuTeam
 271+ 8357 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 272+ 835A FE 02            CP      GAME_MODE_2_PLAYERS
 273+ 835C CA DF 81         JP      Z, .ReadKeyBoard
 274+ 835F 3A EC B1         LD      A,(Var_Game_FirstKickType)
 275+ 8362 FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 276+ 8364 CA DF 81         JP      Z, .ReadKeyBoard
 277+ 8367              .CheckFirstKickCpuTeam:
 278+ 8367 3A ED B1         LD      A, (Var_Game_FirstKickFrameCounter)
 279+ 836A 3C               INC     A
 280+ 836B 32 ED B1         LD      (Var_Game_FirstKickFrameCounter), A
 281+ 836E FE 1E            CP      BLINK_FRAMES_DURATION
 282+ 8370 C2 0A 82         JP      NZ, .Exit
 283+ 8373 3A C3 B1         LD      A, (Var_Game_SecondsToPlay)
 284+ 8376 32 DF B1         LD      (Var_Game_TimeToPlay),A
 285+ 8379 3A EC B1         LD      A, (Var_Game_FirstKickType)
 286+ 837C FE 01            CP      FIRST_KICK_TYPE_WHITE_HALF_FIELD
 287+ 837E CA F6 99         JP      Z, Resume_WhiteKickoff.exec
 288+ 8381 FE 02            CP      FIRST_KICK_TYPE_BLACK_HALF_FIELD
 289+ 8383 CA B0 99         JP      Z, Resume_BlackKickoff.exec
 290+ 8386 FE 03            CP      FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
 291+ 8388 CA 1A 99         JP      Z, Resume_WhiteGoalKick.exec
 292+ 838B FE 04            CP      FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
 293+ 838D CA 6A 99         JP      Z, Resume_BlackGoalKick.exec
 294+ 8390 C3 0A 82         JP       .Exit
 295+ 8393              .ChangeGameSelectedMode:
 296+ 8393 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 297+ 8396 FE 01            CP      GAME_MODE_1_PLAYER
 298+ 8398 28 0E            JR      Z, .ChangeGameSelectedModeToGAME_MODE_2_PLAYERS
 299+ 839A              .ChangeGameSelectedModeToCPU:
 300+ 839A 3E 01            LD      A, GAME_MODE_1_PLAYER
 301+ 839C 32 EA B1         LD      (Var_Game_SelectedPlayers), A
 302+ 839F CD 76 91         CALL    Menu_ShowOptions
 303+ 83A2 CD 3B 93         CALL    Utils_PlayBeep
 304+ 83A5 C3 0A 82         JP      .Exit
 305+ 83A8              .ChangeGameSelectedModeToGAME_MODE_2_PLAYERS:
 306+ 83A8 3E 02            LD      A, GAME_MODE_2_PLAYERS
 307+ 83AA 32 EA B1         LD      (Var_Game_SelectedPlayers), A
 308+ 83AD CD 76 91         CALL    Menu_ShowOptions
 309+ 83B0 CD 3B 93         CALL    Utils_PlayBeep
 310+ 83B3 C3 0A 82         JP      .Exit
 311+ 83B6              .LevelDown:
 312+ 83B6 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 313+ 83B9 FE 02            CP      GAME_MODE_2_PLAYERS
 314+ 83BB CA 37 92         JP      Z, Menu_ShowOptions.Level1
 315+ 83BE 3A C4 B1         LD      A, (Var_Game_SelectedLevel)
 316+ 83C1 FE 01            CP      1
 317+ 83C3 CA 0A 82         JP      Z, .Exit
 318+ 83C6 3D               DEC     A
 319+ 83C7 32 C4 B1         LD      (Var_Game_SelectedLevel), A
 320+ 83CA CD 37 92         CALL    Menu_ShowOptions.Level1
 321+ 83CD CD 3B 93         CALL    Utils_PlayBeep
 322+ 83D0 C3 0A 82         JP      .Exit
 323+ 83D3              .LevelUp:
 324+ 83D3 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 325+ 83D6 FE 02            CP      GAME_MODE_2_PLAYERS
 326+ 83D8 CA 37 92         JP      Z, Menu_ShowOptions.Level1
 327+ 83DB 3A C4 B1         LD      A, (Var_Game_SelectedLevel)
 328+ 83DE FE 05            CP      5
 329+ 83E0 CA 0A 82         JP      Z, .Exit
 330+ 83E3 3C               INC     A
 331+ 83E4 32 C4 B1         LD      (Var_Game_SelectedLevel), A
 332+ 83E7 CD 37 92         CALL    Menu_ShowOptions.Level1
 333+ 83EA CD 3B 93         CALL    Utils_PlayBeep
 334+ 83ED C3 0A 82         JP      .Exit
 335+ 83F0              .CheckGameResumeWaiting:
 336+ 83F0 3A 30 B2         LD      A, (Var_Hooks_FrameCounter)
 337+ 83F3 FE 1E            CP      BLINK_FRAMES_DURATION
 338+ 83F5 C2 0A 82         JP      NZ, .Exit
 339+ 83F8 3E 00            LD      A, NO
 340+ 83FA 32 37 B2         LD      (Var_Hooks_GameResumingWaiting), A
 341+ 83FD CD BD 98         CALL    Game_Resume
 342+ 8400 CD D1 8E         CALL    VDP_PlayerMatrixRedraw
 343+ 8403 C3 0A 82         JP      .Exit
 344+ 8406              .ShowGoalCerimony:
 345+ 8406 3A 38 B2         LD      A, (Var_Hooks_CerimonySpeedCounter)
 346+ 8409 3C               INC     A
 347+ 840A 32 38 B2         LD      (Var_Hooks_CerimonySpeedCounter), A
 348+ 840D FE 14            CP      CERIMONY_MOVEMENT_SPEED
 349+ 840F C2 0A 82         JP      NZ, .Exit
 350+ 8412 AF               XOR     A
 351+ 8413 32 38 B2         LD      (Var_Hooks_CerimonySpeedCounter), A
 352+ 8416 3A 3F B2         LD      A,(Var_Hooks_GoalCerimonyCounter)
 353+ 8419 3D               DEC     A
 354+ 841A 32 3F B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 355+ 841D 3E 01            LD      A, TEAM_WHITE
 356+ 841F 47               LD      B, A
 357+ 8420 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
 358+ 8423 FE 01            CP      FIELD_NORTH_SIDE
 359+ 8425 28 03            JR      Z, .ShowGoalCerimonyTeamSelected
 360+ 8427 3E 00            LD      A, TEAM_BLACK
 361+ 8429 47               LD      B, A
 362+ 842A              .ShowGoalCerimonyTeamSelected:
 363+ 842A 3A 3F B2         LD      A,(Var_Hooks_GoalCerimonyCounter)
 364+ 842D CD F2 A9         CALL    Game_GoalCelebration_DrawFrame
 365+ 8430
 366+ 8430 3A 3F B2         LD      A,(Var_Hooks_GoalCerimonyCounter)
 367+ 8433 FE 00            CP      0
 368+ 8435 C2 DF 81         JP      NZ,.ReadKeyBoard
 369+ 8438 3E FF            LD      A, NO_VALUE
 370+ 843A 32 3F B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 371+ 843D C3 DF 81         JP      .ReadKeyBoard
 372+ 8440              .StartGame:
 373+ 8440 3E FF            LD      A,NO_VALUE
 374+ 8442 32 EC B1         LD      (Var_Game_FirstKickType), A
 375+ 8445 3E 00            LD      A, NO
 376+ 8447 32 39 B2         LD      (Var_Hooks_BlinkingIsActive), A
 377+ 844A 32 37 B2         LD      (Var_Hooks_GameResumingWaiting), A
 378+ 844D CD 14 9E         CALL    Game_StopShot
 379+ 8450 3E 00            LD      A, NO
 380+ 8452 32 3D B2         LD      (Var_Hooks_ForceVdpRedraw), A
 381+ 8455 3A C4 B1         LD      A, (Var_Game_SelectedLevel)
 382+ 8458 32 E8 B1         LD      (Var_Game_PlayersSpeed), A
 383+ 845B 3E 3C            LD      A, MATCH_TIME
 384+ 845D 32 DF B1         LD      (Var_Game_TimeToPlay), A
 385+ 8460 CD 5C 88         CALL    Hooks_UpdateTimeToPlay
 386+ 8463 AF               XOR     A
 387+ 8464 32 3F B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 388+ 8467 32 C9 B1         LD      (Var_Game_BallUpdateTimer), A
 389+ 846A 32 DE B1         LD      (Var_Game_ScoreWhite), A
 390+ 846D 32 D1 B1         LD      (Var_Game_ScoreBlack), A
 391+ 8470 CD EF 90         CALL    VDP_ClearMenuSideArea
 392+ 8473 3E 01            LD      A, YES
 393+ 8475 32 E7 B1         LD      (Var_Game_MatchInProgress), A
 394+ 8478 CD 02 91         CALL    VDP_ShowScores
 395+ 847B CD D0 A3         CALL    Game_Start
 396+ 847E CD 38 85         CALL    UpdateMatchTime
 397+ 8481 C3 0A 82         JP      .Exit
 398+ 8484              .CheckBlinkingState:
 399+ 8484 CD 58 81         CALL    Hooks_TickStop
 400+ 8487 3A 3A B2         LD      A, (Var_Hooks_BlinkingMustResetFrameCounter)
 401+ 848A FE 00            CP      NO
 402+ 848C CA 93 84         JP      Z,.CheckBlinkingStateAfterReset
 403+ 848F AF               XOR     A
 404+ 8490 32 30 B2         LD      (Var_Hooks_FrameCounter), A
 405+ 8493              .CheckBlinkingStateAfterReset:
 406+ 8493 3A 30 B2         LD      A, (Var_Hooks_FrameCounter)
 407+ 8496 FE 1E            CP      BLINK_FRAMES_DURATION
 408+ 8498 CA A3 84         JP      Z,.CheckBlinkingStateContinue
 409+ 849B 3E 00            LD      A, NO
 410+ 849D 32 3A B2         LD      (Var_Hooks_BlinkingMustResetFrameCounter), A
 411+ 84A0 C3 0A 82         JP      .Exit
 412+ 84A3              .CheckBlinkingStateContinue:
 413+ 84A3 3E 01            LD      A, YES
 414+ 84A5 32 3A B2         LD      (Var_Hooks_BlinkingMustResetFrameCounter), A
 415+ 84A8 3A 36 B2         LD      A, (Var_Hooks_BlinkingCounter)
 416+ 84AB 3C               INC     A
 417+ 84AC 32 36 B2         LD      (Var_Hooks_BlinkingCounter), A
 418+ 84AF FE 07            CP      7
 419+ 84B1 28 1E            JR      Z,.CheckBlinkingStateStop
 420+ 84B3 3A 33 B2         LD      A, (Var_Hooks_BlinkingTileToShow)
 421+ 84B6 47               LD      B, A
 422+ 84B7 3A 35 B2         LD      A, (Var_Hooks_BlinkingActiveTile)
 423+ 84BA B8               CP      B
 424+ 84BB 20 04            JR      NZ, .CheckBlinkingStateShowTile
 425+ 84BD 3A 34 B2         LD      A, (Var_Hooks_BlinkingTileToHide)
 426+ 84C0 47               LD      B, A
 427+ 84C1              .CheckBlinkingStateShowTile:
 428+ 84C1 78               LD      A, B
 429+ 84C2 32 35 B2         LD      (Var_Hooks_BlinkingActiveTile), A
 430+ 84C5 CD 4D 95         CALL    Game_GetBallPosition
 431+ 84C8 3A 35 B2         LD      A, (Var_Hooks_BlinkingActiveTile)
 432+ 84CB CD 05 89         CALL    VDP_DrawSprite
 433+ 84CE C3 DF 81         JP      .ReadKeyBoard
 434+ 84D1              .CheckBlinkingStateStop:
 435+ 84D1 3E 00            LD      A, NO
 436+ 84D3 32 39 B2         LD      (Var_Hooks_BlinkingIsActive), A
 437+ 84D6 3A 32 B2         LD      A, (Var_Hooks_BlinkingType)
 438+ 84D9 FE 01            CP      BLINK_TYPE_GOAL
 439+ 84DB 28 0F            JR      Z, .GoalCerimony
 440+ 84DD 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
 441+ 84E0 FE 01            CP      FIELD_NORTH_SIDE
 442+ 84E2 20 1A            JR      NZ,.CheckBlinkingRestartAfterNoGoalFromSouth
 443+ 84E4 CD 73 8B         CALL    VDP_DrawField
 444+ 84E7 CD A8 97         CALL    SetBlackRestartSchema
 445+ 84EA 18 3D            JR     .CheckBlinkingRestartResume
 446+ 84EC              .GoalCerimony:
 447+ 84EC AF               XOR   A
 448+ 84ED 32 38 B2         LD    (Var_Hooks_CerimonySpeedCounter), A
 449+ 84F0 CD 03 A4         CALL  Game_ClearGameFieldForGoalCerimony
 450+ 84F3 3E 09            LD    A, 9
 451+ 84F5 32 3F B2         LD    (Var_Hooks_GoalCerimonyCounter), A
 452+ 84F8 CD D1 A9         CALL    CerimonyRedrawHalfFieldLine
 453+ 84FB C3 0A 82         JP    .Exit
 454+ 84FE              .CheckBlinkingRestartAfterNoGoalFromSouth:
 455+ 84FE CD 73 8B         CALL    VDP_DrawField
 456+ 8501 CD 33 98         CALL    SetWhiteRestartSchema
 457+ 8504 18 23            JR     .CheckBlinkingRestartResume
 458+ 8506              .CheckBlinkingRestartAfterGoal:
 459+ 8506 AF               XOR     A
 460+ 8507 32 3F B2         LD      (Var_Hooks_GoalCerimonyCounter), A
 461+ 850A 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
 462+ 850D FE 01            CP      FIELD_NORTH_SIDE
 463+ 850F 28 0D            JR      Z, .CheckBlinkingRestartAfterGoalFromSouth
 464+ 8511 3E 01            LD      A, FIELD_NORTH_SIDE
 465+ 8513 32 C2 B1         LD      (Var_Game_ActiveFieldSide), A
 466+ 8516 CD 73 8B         CALL    VDP_DrawField
 467+ 8519 CD 9D 96         CALL    Game_SetWhiteKickoffSchema
 468+ 851C 18 0B            JR      .CheckBlinkingRestartResume
 469+ 851E              .CheckBlinkingRestartAfterGoalFromSouth:
 470+ 851E 3E 00            LD      A, FIELD_SOUTH_SIDE
 471+ 8520 32 C2 B1         LD      (Var_Game_ActiveFieldSide), A
 472+ 8523 CD 73 8B         CALL    VDP_DrawField
 473+ 8526 CD 22 97         CALL    Game_SetBlackKickoffSchema
 474+ 8529              .CheckBlinkingRestartResume:
 475+ 8529 CD D1 8E         CALL   VDP_PlayerMatrixRedraw
 476+ 852C AF               XOR    A
 477+ 852D 32 30 B2         LD     (Var_Hooks_FrameCounter), A
 478+ 8530 3E 01            LD     A, YES
 479+ 8532 32 37 B2         LD     (Var_Hooks_GameResumingWaiting), A
 480+ 8535 C3 0A 82         JP     .Exit
 481+ 8538
 482+ 8538              UpdateMatchTime:
 483+ 8538 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
 484+ 853B FE 00            CP      NO
 485+ 853D C8               RET     Z
 486+ 853E E5               PUSH    HL
 487+ 853F D5               PUSH    DE
 488+ 8540 C5               PUSH    BC
 489+ 8541 3A DF B1         LD      A, (Var_Game_TimeToPlay)
 490+ 8544
 491+ 8544 FE FF            CP      255
 492+ 8546 CA EC A0         JP      Z,  Game_GameOver
 493+ 8549 11 B9 B1         LD      DE, Var_Utils_NumberToPrint
 494+ 854C 26 00            LD      H, 0
 495+ 854E 6F               LD      L, A
 496+ 854F CD 07 81         CALL    String_NumberToASCII
 497+ 8552 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
 498+ 8555 CD 2C 81         CALL    String_RemoveLeadingZeros
 499+ 8558 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
 500+ 855B 16 01            LD      D, 1
 501+ 855D 1E 1A            LD      E, 26
 502+ 855F CD 63 88         CALL    VDP_PrintString
 503+ 8562 C1               POP     BC
 504+ 8563 D1               POP     DE
 505+ 8564 E1               POP     HL
 506+ 8565 C9               RET
 507+ 8566
 508+ 8566
 509+ 8566              ;----------------------------------------------------------------------------
 510+ 8566              ; AiTick
 511+ 8566              ;----------------------------------------------------------------------------
 512+ 8566              AiTick:
 513+ 8566 F5               push af
 514+ 8567 C5               push bc
 515+ 8568 D5               push de
 516+ 8569 E5               push hl
 517+ 856A
 518+ 856A 3A 3D B2         ld  a,(Var_Hooks_ForceVdpRedraw)
 519+ 856D FE 01            cp  YES
 520+ 856F 28 7C            jr  z, .done
 521+ 8571
 522+ 8571 CD E0 93         call Game_UpdateBallMovement
 523+ 8574
 524+ 8574 3A 3E B2         ld  a,(Var_Hooks_TickSpeed)
 525+ 8577 47               ld  b, a
 526+ 8578 3A 40 B2         ld  a, (Var_Hooks_TickCounter)
 527+ 857B 3C               inc a
 528+ 857C 32 40 B2         ld  (Var_Hooks_TickCounter), a
 529+ 857F B8               cp  b
 530+ 8580 20 6B            jr  nz, .done
 531+ 8582
 532+ 8582 AF               xor a
 533+ 8583 32 40 B2         ld  (Var_Hooks_TickCounter), a
 534+ 8586
 535+ 8586 3A E8 B1         ld   a,(Var_Game_PlayersSpeed)
 536+ 8589 FE 01            cp   1
 537+ 858B 30 02            jr   nc,.speed_ok
 538+ 858D 3E 01            ld   a,1
 539+ 858F              .speed_ok:
 540+ 858F FE 05            cp   5
 541+ 8591 38 02            jr   c,.speed_ok2
 542+ 8593 3E 05            ld   a,5
 543+ 8595              .speed_ok2:
 544+ 8595 47               ld   b,a
 545+ 8596 3E 06            ld   a,6
 546+ 8598 90               sub  b
 547+ 8599 47               ld   b,a                 ; B = delay (1..5)
 548+ 859A
 549+ 859A                  ; --- controlla se siamo in demo (match non in corso) ---
 550+ 859A 3A E7 B1         ld   a,(Var_Game_MatchInProgress)
 551+ 859D FE 00            cp   NO
 552+ 859F 28 0D            jr   z,.demo_mode
 553+ 85A1
 554+ 85A1                  ; --- partita normale ---
 555+ 85A1 3A EA B1         ld   a,(Var_Game_SelectedPlayers)
 556+ 85A4 FE 01            cp   GAME_MODE_1_PLAYER
 557+ 85A6 28 2E            jr   z,.one_player_mode
 558+ 85A8 FE 02            cp   GAME_MODE_2_PLAYERS
 559+ 85AA 28 3F            jr   z,.two_players_mode
 560+ 85AC 18 3F            jr   .done               ; modalità sconosciuta? non fare nulla
 561+ 85AE
 562+ 85AE              ; ---- DEMO: entrambe le squadre CPU --------------------------------
 563+ 85AE              .demo_mode:
 564+ 85AE                  ; TEAM_BLACK
 565+ 85AE 3A 31 B2         ld   a,(Var_Hooks_AiCounterBlack)
 566+ 85B1 3C               inc  a
 567+ 85B2 32 31 B2         ld   (Var_Hooks_AiCounterBlack),a   ; <-- SALVA SEMPRE DOPO INC
 568+ 85B5 B8               cp   b
 569+ 85B6 38 09            jr   c,.skip_black_demo
 570+ 85B8 AF               xor  a
 571+ 85B9 32 31 B2         ld   (Var_Hooks_AiCounterBlack),a   ; reset contatore
 572+ 85BC 06 00            ld   b,TEAM_BLACK
 573+ 85BE CD F2 85         call AiUpdateTeam
 574+ 85C1              .skip_black_demo:
 575+ 85C1
 576+ 85C1                  ; TEAM_WHITE
 577+ 85C1 3A 47 B2         ld   a,(Var_Hooks_AiCounterWhite)
 578+ 85C4 3C               inc  a
 579+ 85C5 32 47 B2         ld   (Var_Hooks_AiCounterWhite),a   ; <-- SALVA SEMPRE DOPO INC
 580+ 85C8 B8               cp   b
 581+ 85C9 38 09            jr   c,.skip_white_demo
 582+ 85CB AF               xor  a
 583+ 85CC 32 47 B2         ld   (Var_Hooks_AiCounterWhite),a   ; reset contatore
 584+ 85CF 06 01            ld   b,TEAM_WHITE
 585+ 85D1 CD F2 85         call AiUpdateTeam
 586+ 85D4              .skip_white_demo:
 587+ 85D4 18 17            jr   .done
 588+ 85D6
 589+ 85D6              ; ---- 1 PLAYER: CPU controlla solo i NERI --------------------------
 590+ 85D6              .one_player_mode:
 591+ 85D6                  ; TEAM_BLACK CPU
 592+ 85D6 3A 31 B2         ld   a,(Var_Hooks_AiCounterBlack)
 593+ 85D9 3C               inc  a
 594+ 85DA 32 31 B2         ld   (Var_Hooks_AiCounterBlack),a   ; <-- SALVA SEMPRE DOPO INC
 595+ 85DD B8               cp   b
 596+ 85DE 38 09            jr   c,.skip_black_1p
 597+ 85E0 AF               xor  a
 598+ 85E1 32 31 B2         ld   (Var_Hooks_AiCounterBlack),a   ; reset contatore
 599+ 85E4 06 00            ld   b,TEAM_BLACK
 600+ 85E6 CD F2 85         call AiUpdateTeam
 601+ 85E9              .skip_black_1p:
 602+ 85E9 18 02            jr   .done
 603+ 85EB
 604+ 85EB              ; ---- 2 PLAYERS: nessuna CPU --------------------------------------
 605+ 85EB              .two_players_mode:
 606+ 85EB                  ; niente
 607+ 85EB 18 00            jr   .done
 608+ 85ED
 609+ 85ED              .done:
 610+ 85ED E1               pop  hl
 611+ 85EE D1               pop  de
 612+ 85EF C1               pop  bc
 613+ 85F0 F1               pop  af
 614+ 85F1 C9               ret
 615+ 85F2
 616+ 85F2
 617+ 85F2              ; ---------------------------------------------------------------------------
 618+ 85F2              ; AiUpdateTeam
 619+ 85F2              ;
 620+ 85F2              ; INPUT:
 621+ 85F2              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 622+ 85F2              ;
 623+ 85F2              ; Usa:
 624+ 85F2              ;   Game_GetPlayerIdWithBall
 625+ 85F2              ;   AiUpdateGoalkeeper
 626+ 85F2              ;   AiMoveChaserTowardBall
 627+ 85F2              ;   AiBallCarrierDecision
 628+ 85F2              ;   AiVerticalAdjustments
 629+ 85F2              ;
 630+ 85F2              ; Convenzioni Game_GetPlayerIdWithBall:
 631+ 85F2              ;   A = stato/team:
 632+ 85F2              ;       BALL_STATUS_MOVING
 633+ 85F2              ;       BALL_STATUS_FREE
 634+ 85F2              ;       BALL_STATUS_CONTENDED
 635+ 85F2              ;       TEAM_BLACK / TEAM_WHITE (se una squadra ha il possesso)
 636+ 85F2              ;   H = ID giocatore in possesso (o 255 se nessuno)
 637+ 85F2              ;   L = ID contendente (o 255 se nessuno)
 638+ 85F2              ; ---------------------------------------------------------------------------
 639+ 85F2              AiUpdateTeam:
 640+ 85F2 F5               push af
 641+ 85F3 C5               push bc
 642+ 85F4 D5               push de
 643+ 85F5 E5               push hl
 644+ 85F6
 645+ 85F6                  ; Salva TEAM di input
 646+ 85F6 48               ld   c,b                 ; C = TEAM_ORIG
 647+ 85F7 C5               PUSH  BC
 648+ 85F8                  ; Chi ha la palla?
 649+ 85F8 CD 5A 9A         call Game_GetPlayerIdWithBall
 650+ 85FB                  ; A = stato/team, H = ownerID (o 255), L = contenderID (o 255)
 651+ 85FB C1               POP   BC
 652+ 85FC
 653+ 85FC
 654+ 85FC 5C               ld   e,h                 ; E = ownerID (se esiste)
 655+ 85FD 57               ld   d,a                 ; D = stato/team
 656+ 85FE                  ; --- caso: palla in movimento ---------------------------------
 657+ 85FE
 658+ 85FE FE 64            cp   BALL_STATUS_MOVING
 659+ 8600 20 02            jr   nz, .chk_contended
 660+ 8602
 661+ 8602                  ; palla che viaggia: portiere si aggiusta un po', niente altro
 662+ 8602                  ;;call AiUpdateGoalkeeper
 663+ 8602 18 2D            jr   .done
 664+ 8604
 665+ 8604              .chk_contended:
 666+ 8604
 667+ 8604 FE 65            cp   BALL_STATUS_CONTENDED
 668+ 8606 20 08            jr   nz, .chk_free
 669+ 8608
 670+ 8608                  ; palla contesa: per ora ci comportiamo come se fosse “palla libera”
 671+ 8608
 672+ 8608                  ;;call AiUpdateGoalkeeper
 673+ 8608 CD 85 86         call AiMoveChaserTowardBall
 674+ 860B CD C5 87         call AiVerticalAdjustments
 675+ 860E 18 21            jr   .done
 676+ 8610
 677+ 8610              .chk_free:
 678+ 8610
 679+ 8610 FE 66            cp   BALL_STATUS_FREE
 680+ 8612 20 08            jr   nz, .chk_team_possession
 681+ 8614
 682+ 8614                  ;; palla libera
 683+ 8614                  ;;call AiUpdateGoalkeeper
 684+ 8614 CD 85 86         call AiMoveChaserTowardBall
 685+ 8617 CD C5 87         call AiVerticalAdjustments
 686+ 861A 18 15            jr   .done
 687+ 861C
 688+ 861C              ; -------------------------------------------------------------------
 689+ 861C              ; Qui A (=D) è o TEAM_BLACK o TEAM_WHITE: una squadra ha il possesso
 690+ 861C              ; -------------------------------------------------------------------
 691+ 861C              .chk_team_possession:
 692+ 861C                  ; Se D == TEAM_ORIG -> la nostra squadra ha la palla
 693+ 861C 7A               ld   a,d                 ; team che ha la palla
 694+ 861D B8               cp   b                   ; confronta con TEAM_ORIG
 695+ 861E 20 09            jr   nz, .enemy_has_ball
 696+ 8620
 697+ 8620                  ; === noi abbiamo la palla ===
 698+ 8620                  ; E = ownerID
 699+ 8620                  ;ld   b,c                 ; B = TEAM_ORIG
 700+ 8620 4B               ld   c,e                 ; C = ID portatore
 701+ 8621
 702+ 8621                  ; portiere
 703+ 8621                  ;;call AiUpdateGoalkeeper
 704+ 8621                  ; decisione portatore (muoversi / tirare / ecc.)
 705+ 8621 CD 84 87         call AiBallCarrierDecision
 706+ 8624                  ; opzionale: piccoli aggiustamenti verticali anche dei non portatori
 707+ 8624 CD C5 87         call AiVerticalAdjustments
 708+ 8627 18 08            jr   .done
 709+ 8629
 710+ 8629              .enemy_has_ball:
 711+ 8629                  ; === l'altra squadra ha la palla ===
 712+ 8629                  ;ld   b,c                 ; B = TEAM_ORIG
 713+ 8629                  ;;call AiUpdateGoalkeeper
 714+ 8629 CD 85 86         call AiMoveChaserTowardBall
 715+ 862C CD C5 87         call AiVerticalAdjustments
 716+ 862F 18 00            jr   .done
 717+ 8631
 718+ 8631              .done:
 719+ 8631 E1               pop  hl
 720+ 8632 D1               pop  de
 721+ 8633 C1               pop  bc
 722+ 8634 F1               pop  af
 723+ 8635 C9               ret
 724+ 8636
 725+ 8636
 726+ 8636              ; ---------------------------------------------------------------------------
 727+ 8636              ; AiUpdateGoalkeeper
 728+ 8636              ;
 729+ 8636              ; INPUT:
 730+ 8636              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 731+ 8636              ;
 732+ 8636              ; Logica:
 733+ 8636              ;   - legge posizione palla
 734+ 8636              ;   - targetX:
 735+ 8636              ;       if 1..3 -> ballX
 736+ 8636              ;       else    -> 2
 737+ 8636              ;   - trova portiere (ID=0) con Game_GetPlayerInfoById
 738+ 8636              ;   - con una certa probabilità (dipendente da Var_Game_PlayersSpeed)
 739+ 8636              ;     prova a muovere il portiere orizzontalmente verso targetX.
 740+ 8636              ; ---------------------------------------------------------------------------
 741+ 8636              AiUpdateGoalkeeper:
 742+ 8636 F5               push af
 743+ 8637 C5               push bc
 744+ 8638 D5               push de
 745+ 8639 E5               push hl
 746+ 863A
 747+ 863A                  ; salvati il team
 748+ 863A 48               ld   c,b                 ; C = TEAM
 749+ 863B
 750+ 863B                  ; posizione palla
 751+ 863B CD 4D 95         call Game_GetBallPosition ; HL = X,Y  (H=Y, L=X)
 752+ 863E D5               PUSH DE
 753+ 863F E1               POP  HL
 754+ 8640
 755+ 8640                  ; targetX = (1..3 ? ballX : 2)
 756+ 8640 FE 01            cp   1
 757+ 8642 38 07            jr   c,.use_center
 758+ 8644 FE 04            cp   4
 759+ 8646 30 03            jr   nc,.use_center
 760+ 8648 53               ld   d,e                 ; D = targetX = ballX
 761+ 8649 18 02            jr   .got_target
 762+ 864B
 763+ 864B              .use_center:
 764+ 864B 16 02            ld   d,2                 ; targetX = 2
 765+ 864D
 766+ 864D              .got_target:
 767+ 864D                  ; prendi posizione portiere (ID=0)
 768+ 864D 41               ld   b,c                 ; B = TEAM
 769+ 864E 0E 00            ld   c,0                 ; ID = 0
 770+ 8650 CD 14 96         call Game_GetPlayerInfoById
 771+ 8653                  ; HL = curr (H=Y, L=X)
 772+ 8653 7D               ld   a,l                 ; goalieX
 773+ 8654 5F               ld   e,a                 ; E = goalieX
 774+ 8655
 775+ 8655                  ; se già in colonna giusta → niente
 776+ 8655 7B               ld   a,e
 777+ 8656 BA               cp   d
 778+ 8657 28 1F            jr   z,.done
 779+ 8659
 780+ 8659                  ; probabilità di muoversi dipendente da Var_Game_PlayersSpeed
 781+ 8659 C5               push bc
 782+ 865A CD 32 9A         call Game_GetRandomByte
 783+ 865D C1               pop  bc
 784+ 865E E6 0F            and  00001111b           ; 0..15
 785+ 8660 67               ld   h,a
 786+ 8661 3A E8 B1         ld   a,(Var_Game_PlayersSpeed) ; 1..5
 787+ 8664                  ; più alto => più facile che H < soglia
 788+ 8664 C6 03            add  a,3                 ; speed 1..5 -> soglia 4..8
 789+ 8666 BC               cp   h
 790+ 8667 38 0F            jr   c,.done             ; random >= soglia -> non si muove
 791+ 8669
 792+ 8669                  ; decide direzione verso targetX
 793+ 8669 7B               ld   a,e                 ; goalieX
 794+ 866A BA               cp   d                   ; targetX
 795+ 866B 38 02            jr   c,.move_east
 796+ 866D 18 04            jr   .move_west
 797+ 866F
 798+ 866F              .move_east:
 799+ 866F 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
 800+ 8671 18 02            jr   .do_move
 801+ 8673
 802+ 8673              .move_west:
 803+ 8673 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
 804+ 8675
 805+ 8675              .do_move:
 806+ 8675                  ; A = dir, B = TEAM, C = 0 (portiere)
 807+ 8675 CD 79 9E         call Game_TryMovePlayerHorizontally
 808+ 8678                  ; ignoriamo SUCCESS/FAILURE
 809+ 8678              .done:
 810+ 8678 E1               pop  hl
 811+ 8679 D1               pop  de
 812+ 867A C1               pop  bc
 813+ 867B F1               pop  af
 814+ 867C C9               ret
 815+ 867D              ;---------------------------------------------------------------------------
 816+ 867D              ; Hooks_InitAICounters
 817+ 867D              ;---------------------------------------------------------------------------
 818+ 867D              Hooks_InitAICounters:
 819+ 867D AF               xor  a
 820+ 867E 32 31 B2         ld   (Var_Hooks_AiCounterBlack),a
 821+ 8681 32 47 B2         ld   (Var_Hooks_AiCounterWhite),a
 822+ 8684 C9               ret
 823+ 8685              ; ---------------------------------------------------------------------------
 824+ 8685              ; AiMoveChaserTowardBall
 825+ 8685              ;
 826+ 8685              ; INPUT:
 827+ 8685              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
 828+ 8685              ;
 829+ 8685              ; Logica:
 830+ 8685              ;   - calcola ballY/ballX
 831+ 8685              ;   - riga target per cercare un "chaser":
 832+ 8685              ;       * TEAM_BLACK:   stessa riga della palla
 833+ 8685              ;       * TEAM_WHITE:   riga della palla + 1 (se <=4), altrimenti riga palla
 834+ 8685              ;   - Scorre ID=0..3 e memorizza il giocatore di quella riga più vicino
 835+ 8685              ;     in X alla palla.
 836+ 8685              ;   - Con certa probabilità (dipendente da PlayersSpeed) lo muove di
 837+ 8685              ;     una cella a sinistra/destra verso la palla, usando
 838+ 8685              ;     Game_TryMovePlayerHorizontally.
 839+ 8685              ;   - Possibilità di restare fermo: più bassa a velocità alte.
 840+ 8685              ; ---------------------------------------------------------------------------
 841+ 8685              AiMoveChaserTowardBall:
 842+ 8685
 843+ 8685 F5               push af
 844+ 8686 C5               push bc
 845+ 8687 D5               push de
 846+ 8688 E5               push hl
 847+ 8689
 848+ 8689 C5               push bc
 849+ 868A CD 5A 9A         CALL Game_GetPlayerIdWithBall
 850+ 868D C1               pop  bc
 851+ 868E FE 65            CP   BALL_STATUS_CONTENDED
 852+ 8690 20 12            JR   NZ,.no_contended_ball
 853+ 8692
 854+ 8692 C5               push    bc
 855+ 8693
 856+ 8693 CD 4D 95         CALL    Game_GetBallPosition
 857+ 8696 C1               pop     bc
 858+ 8697 62               ld      h, d
 859+ 8698 78               ld      a, b
 860+ 8699 FE 01            cp      TEAM_WHITE
 861+ 869B 20 01            jr      NZ,.contended_team_found
 862+ 869D 24               inc     h
 863+ 869E              .contended_team_found:
 864+ 869E 54               ld     d, h
 865+ 869F CD 2F 96         CALL   Game_GetPlayerInfoByPos
 866+ 86A2 18 4A            JR     .after_player_to_move_found
 867+ 86A4
 868+ 86A4
 869+ 86A4
 870+ 86A4              .no_contended_ball:
 871+ 86A4 48               ld   c,b                 ; C = TEAM
 872+ 86A5
 873+ 86A5                  ; ball pos
 874+ 86A5 CD 4D 95         call Game_GetBallPosition    ; HL = X,Y
 875+ 86A8 D5               PUSH DE
 876+ 86A9 E1               POP  HL
 877+ 86AA
 878+ 86AA                  ; riga su cui cercare chaser
 879+ 86AA 79               ld   a,c                 ; TEAM
 880+ 86AB FE 01            cp   TEAM_WHITE
 881+ 86AD 20 0A            jr   nz,.use_same_row
 882+ 86AF
 883+ 86AF                  ; TEAM_WHITE: riga ballY+1 se <=4, altrimenti ballY
 884+ 86AF 7A               ld   a,d
 885+ 86B0 3C               inc  a
 886+ 86B1 FE 05            cp   5
 887+ 86B3 38 01            jr   c,.set_target_row
 888+ 86B5 7A               ld   a,d
 889+ 86B6              .set_target_row:
 890+ 86B6 57               ld   d,a                 ; D = targetRow
 891+ 86B7 18 00            jr   .got_target_row
 892+ 86B9
 893+ 86B9              .use_same_row:
 894+ 86B9                  ; TEAM_BLACK: stessa riga palla
 895+ 86B9                  ; D è già ballY
 896+ 86B9              .got_target_row:
 897+ 86B9
 898+ 86B9
 899+ 86B9
 900+ 86B9
 901+ 86B9                  ; cerca il giocatore più vicino in X a ballX sulla riga D
 902+ 86B9 41               ld   b,c                 ; B = TEAM
 903+ 86BA 0E 00            ld   c,0                 ; ID = 0
 904+ 86BC 3E FF            ld   a,255               ; bestID = 255 (none)
 905+ 86BE 32 3C B2         ld   (Var_Hooks_BestDistanceX),a
 906+ 86C1 32 3B B2         ld   (Var_Hooks_BestDistanceId),a
 907+ 86C4
 908+ 86C4
 909+ 86C4              .chaser_loop:
 910+ 86C4
 911+ 86C4 C5               push bc
 912+ 86C5 D5               push de
 913+ 86C6 CD 14 96         call Game_GetPlayerInfoById   ; HL = pos (H=Y, L=X)
 914+ 86C9 D1               pop  de
 915+ 86CA C1               pop  bc
 916+ 86CB
 917+ 86CB 7C               ld   a,h                 ; currY
 918+ 86CC BA               cp   d
 919+ 86CD 20 11            jr   nz,.next_id         ; non su riga target
 920+ 86CF
 921+ 86CF                  ; su riga target, calcola |X - ballX|
 922+ 86CF 7D               ld   a,l                 ; currX
 923+ 86D0 93               sub  e                   ; X - ballX
 924+ 86D1 F2 D6 86         jp   p,.dist_ok
 925+ 86D4 ED 44            neg
 926+ 86D6              .dist_ok:
 927+ 86D6                  ; A = distanza
 928+ 86D6 BD               cp   l                   ; confronta con bestDist (L)
 929+ 86D7 30 07            jr   nc,.next_id         ; se >= bestDist, tieni quello vecchio
 930+ 86D9
 931+ 86D9                  ; nuovo migliore
 932+ 86D9 32 3C B2         ld   (Var_Hooks_BestDistanceX),a                 ; bestDist = A
 933+ 86DC 79               ld   a,c
 934+ 86DD 32 3B B2         ld   (Var_Hooks_BestDistanceId),a                 ; bestID = C
 935+ 86E0
 936+ 86E0              .next_id:
 937+ 86E0 0C               inc  c
 938+ 86E1 79               ld   a,c
 939+ 86E2 FE 04            cp   4
 940+ 86E4 20 DE            jr   nz,.chaser_loop
 941+ 86E6
 942+ 86E6                  ; se bestID=255 -> nessun giocatore su quella riga
 943+ 86E6 3A 3B B2         ld   a,(Var_Hooks_BestDistanceId)
 944+ 86E9 FE FF            cp   255
 945+ 86EB C2 20 87         jp   nz,.good_player_found
 946+ 86EE
 947+ 86EE              .after_player_to_move_found:
 948+ 86EE 3E 01            ld    a, 1
 949+ 86F0 32 3B B2         ld    (Var_Hooks_BestDistanceId), a
 950+ 86F3 0E 01            ld    c, 1
 951+ 86F5 D5               push  de
 952+ 86F6 C5               push  bc
 953+ 86F7 CD 14 96         CALL  Game_GetPlayerInfoById
 954+ 86FA C1               pop   bc
 955+ 86FB D1               pop   de
 956+ 86FC 7C               ld    a, h
 957+ 86FD BA               cp    d
 958+ 86FE 28 20            JR    z, .good_player_found
 959+ 8700
 960+ 8700 3E 02            ld    a, 2
 961+ 8702 32 3B B2         ld    (Var_Hooks_BestDistanceId), a
 962+ 8705 0E 02            ld    c, 2
 963+ 8707 D5               push  de
 964+ 8708 C5               push  bc
 965+ 8709 CD 14 96         CALL  Game_GetPlayerInfoById
 966+ 870C C1               pop   bc
 967+ 870D D1               pop   de
 968+ 870E 7C               ld    a, h
 969+ 870F BA               cp    d
 970+ 8710 28 0E            JR    z, .good_player_found
 971+ 8712
 972+ 8712 3E 03            ld    a, 3
 973+ 8714 32 3B B2         ld    (Var_Hooks_BestDistanceId), a
 974+ 8717 0E 03            ld    c, 3
 975+ 8719 D5               push  de
 976+ 871A C5               push  bc
 977+ 871B CD 14 96         CALL  Game_GetPlayerInfoById
 978+ 871E C1               pop   bc
 979+ 871F D1               pop   de
 980+ 8720
 981+ 8720
 982+ 8720              .good_player_found:
 983+ 8720                  ; --- decidi se muoverlo o lasciarlo fermo ---
 984+ 8720                  ; probabilità di muoversi ~ PlayersSpeed / 5
 985+ 8720 CD 32 9A         call Game_GetRandomByte
 986+ 8723 E6 07            and  00000111b           ; 0..7
 987+ 8725 57               ld   d,a                 ; rand
 988+ 8726
 989+ 8726 3A E8 B1         ld   a,(Var_Game_PlayersSpeed)
 990+ 8729                  ; speed 1..5 -> soglia 1..5
 991+ 8729 BA               cp   d
 992+ 872A 38 53            jr   c,.done             ; rand > speed -> non si muove (resta fermo)
 993+ 872C
 994+ 872C E5               push    hl
 995+ 872D C5               push    bc
 996+ 872E CD 5A 9A         CALL    Game_GetPlayerIdWithBall
 997+ 8731 C1               pop     bc
 998+ 8732 E1               pop     hl
 999+ 8733 FE 65            CP      BALL_STATUS_CONTENDED
1000+ 8735 20 0E            JR      NZ,.after_ball_contended_check
1001+ 8737
1002+ 8737 CD 4D 95         CALL    Game_GetBallPosition
1003+ 873A 78               LD      A, B
1004+ 873B FE 01            CP      TEAM_WHITE
1005+ 873D 20 01            JR      NZ, .contended_get_player
1006+ 873F
1007+ 873F 14               INC     D
1008+ 8740
1009+ 8740                  ;JR      .done
1010+ 8740              .contended_get_player:
1011+ 8740                  ;push    bc
1012+ 8740 CD 2F 96         call    Game_GetPlayerInfoByPos
1013+ 8743                  ;pop     bc
1014+ 8743 18 09            jr      .move_chaser
1015+ 8745
1016+ 8745
1017+ 8745              .after_ball_contended_check:
1018+ 8745                  ; --- NUCLEO PULITO PER LA PARTE FINALE ---
1019+ 8745                  ; B = TEAM (non toccato), H = bestID, E = ballX
1020+ 8745 3A 3B B2         ld   a, (Var_Hooks_BestDistanceId)
1021+ 8748 4F               ld   c,a                 ; C = bestID
1022+ 8749 C5               push bc
1023+ 874A CD 14 96         call Game_GetPlayerInfoById   ; HL = curr pos
1024+ 874D C1               pop  bc                  ; B=TEAM, C=bestID
1025+ 874E              .move_chaser:
1026+ 874E E5               push hl
1027+ 874F CD 4D 95         CALL Game_GetBallPosition
1028+ 8752 E1               pop hl
1029+ 8753 7D               ld   a,l                 ; currX
1030+ 8754 BB               cp   e
1031+ 8755 28 0C            jr   z,.chaser_same_col
1032+ 8757 38 02            jr   c,.chaser_go_east   ; currX < ballX
1033+ 8759 18 04            jr   .chaser_go_west     ; currX > ballX
1034+ 875B
1035+ 875B              .chaser_go_east:
1036+ 875B 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1037+ 875D 18 17            jr   .chaser_do_move
1038+ 875F
1039+ 875F              .chaser_go_west:
1040+ 875F 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1041+ 8761 18 13            jr   .chaser_do_move
1042+ 8763
1043+ 8763              .chaser_same_col:
1044+ 8763                  ; stessa colonna → 50% move left/right, 50% restare fermo
1045+ 8763 C5               push bc
1046+ 8764 CD 38 9A         call Game_GetRandom0_4
1047+ 8767 C1               pop  bc
1048+ 8768 FE 00            cp  0
1049+ 876A 28 13            jr  z,.done              ; 1/4 → fermo
1050+ 876C
1051+ 876C                  ;ld   a,l
1052+ 876C                  ;cp   0
1053+ 876C                  ;jr   z,.chaser_go_east
1054+ 876C                  ;cp   4
1055+ 876C                  ;jr   z,.chaser_go_west
1056+ 876C              ;
1057+ 876C                  ;push bc
1058+ 876C                  ;call Game_GetRandom0_4
1059+ 876C                  ;pop  bc
1060+ 876C                  ;cp  0
1061+ 876C                  ;jr  z,.chaser_go_west
1062+ 876C FE 01            cp  1
1063+ 876E 28 EF            jr  z,.chaser_go_west
1064+ 8770 FE 03            cp  3
1065+ 8772 28 EB            jr  z,.chaser_go_west
1066+ 8774 18 E5            jr  .chaser_go_east
1067+ 8776
1068+ 8776              .chaser_do_move:
1069+ 8776 CD 58 81         CALL Hooks_TickStop
1070+ 8779 CD 79 9E         call Game_TryMovePlayerHorizontally
1071+ 877C CD 50 81         CALL Hooks_TickStart
1072+ 877F                  ; ignoriamo SUCCESS/FAILURE
1073+ 877F
1074+ 877F              .done:
1075+ 877F E1               pop  hl
1076+ 8780 D1               pop  de
1077+ 8781 C1               pop  bc
1078+ 8782 F1               pop  af
1079+ 8783 C9               ret
1080+ 8784
1081+ 8784              ; ---------------------------------------------------------------------------
1082+ 8784              ; AiBallCarrierDecision
1083+ 8784              ;
1084+ 8784              ; INPUT:
1085+ 8784              ;   B = TEAM
1086+ 8784              ;   C = ID del portatore
1087+ 8784              ; ---------------------------------------------------------------------------
1088+ 8784              AiBallCarrierDecision:
1089+ 8784 F5               push af
1090+ 8785 C5               push bc
1091+ 8786 D5               push de
1092+ 8787 E5               push hl
1093+ 8788
1094+ 8788                  ; BC in ingresso: B = TEAM, C = ID del portatore
1095+ 8788 50               ld   d,b                 ; salva TEAM
1096+ 8789 59               ld   e,c                 ; salva ID
1097+ 878A
1098+ 878A                  ; random 0..7
1099+ 878A CD 4A 9A         CALL  Game_GetRandom0_20
1100+ 878D 67               ld    h,a                 ; H = rand 0..7
1101+ 878E
1102+ 878E 3A E8 B1         ld   a,(Var_Game_PlayersSpeed)
1103+ 8791 CB 27            SLA A
1104+ 8793 CB 27            SLA A
1105+ 8795                  ; speed alta -> più probabilità di agire
1106+ 8795 BC               cp   h
1107+ 8796 38 28            jr   c,.do_nothing       ; rand > speed -> sta fermo
1108+ 8798
1109+ 8798                  ; altrimenti sceglie azione:
1110+ 8798                  ;   0..2  -> tiro
1111+ 8798                  ;   3..4  -> move east
1112+ 8798                  ;   5..6  -> move west
1113+ 8798                  ;   7     -> tentativo verticale
1114+ 8798 7C               ld   a,h
1115+ 8799 FE 02            cp   2
1116+ 879B 38 0A            jr   c,.try_shot
1117+ 879D FE 05            cp   5
1118+ 879F 38 0D            jr   c,.move_east
1119+ 87A1 FE 08            cp   8
1120+ 87A3 38 12            jr   c,.move_west
1121+ 87A5 18 19            jr   .done
1122+ 87A7
1123+ 87A7              .try_shot:
1124+ 87A7 42               ld   b,d                 ; ripristina TEAM
1125+ 87A8 4B               ld   c,e                 ; ripristina ID
1126+ 87A9 CD CA 9C         call Game_TryShot
1127+ 87AC 18 12            jr   .done
1128+ 87AE
1129+ 87AE              .move_east:
1130+ 87AE 42               ld   b,d
1131+ 87AF 4B               ld   c,e
1132+ 87B0 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1133+ 87B2 CD 79 9E         call Game_TryMovePlayerHorizontally
1134+ 87B5 18 09            jr   .done
1135+ 87B7
1136+ 87B7              .move_west:
1137+ 87B7 42               ld   b,d
1138+ 87B8 4B               ld   c,e
1139+ 87B9 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1140+ 87BB CD 79 9E         call Game_TryMovePlayerHorizontally
1141+ 87BE 18 00            jr   .done
1142+ 87C0
1143+ 87C0
1144+ 87C0              .do_nothing:
1145+ 87C0                  ; resta fermo
1146+ 87C0
1147+ 87C0              .done:
1148+ 87C0 E1               pop  hl
1149+ 87C1 D1               pop  de
1150+ 87C2 C1               pop  bc
1151+ 87C3 F1               pop  af
1152+ 87C4 C9               ret
1153+ 87C5
1154+ 87C5
1155+ 87C5              ; ---------------------------------------------------------------------------
1156+ 87C5              ; AiVerticalAdjustments
1157+ 87C5              ;
1158+ 87C5              ; INPUT:
1159+ 87C5              ;   B = TEAM
1160+ 87C5              ; NOTE:
1161+ 87C5              ;   - muove solo giocatori ID 1..3 (mai il portiere)
1162+ 87C5              ;   - non muove il giocatore che ha la palla
1163+ 87C5              ; ---------------------------------------------------------------------------
1164+ 87C5              AiVerticalAdjustments:
1165+ 87C5 F5               push af
1166+ 87C6 C5               push bc
1167+ 87C7 D5               push de
1168+ 87C8 E5               push hl
1169+ 87C9
1170+ 87C9
1171+ 87C9
1172+ 87C9
1173+ 87C9 50               ld   d,b                 ; D = TEAM (salvato)
1174+ 87CA
1175+ 87CA                  ; probabilità di attivare il blocco verticale
1176+ 87CA CD 4A 9A         call Game_GetRandom0_20
1177+ 87CD
1178+ 87CD FE 0F            cp   15
1179+ 87CF 30 33            jr   nc,.done            ; ~12.5% dei tick
1180+ 87D1
1181+ 87D1              ; --- scegli un ID 1..3 ------------------------------------------------
1182+ 87D1              .gen_id:
1183+ 87D1 CD 38 9A         call Game_GetRandom0_4   ; 0..4
1184+ 87D4 FE 01            cp   1
1185+ 87D6 38 2C            jr   c,.done           ; 0 -> scarta
1186+ 87D8 FE 04            cp   4
1187+ 87DA 30 28            jr   nc,.done          ; 4 -> scarta (vogliamo 1..3)
1188+ 87DC 4F               ld   c,a                 ; C = ID (1..3)
1189+ 87DD 59               ld   e,c                 ; E = ID salvato
1190+ 87DE
1191+ 87DE                  ; --- verifica che NON sia il possessore della palla ---------------
1192+ 87DE                  ; (Game_GetPlayerIdWithBall distrugge BC, quindi lo salviamo)
1193+ 87DE C5               push bc                  ; salva TEAM (B) e ID (C)
1194+ 87DF CD 5A 9A         call Game_GetPlayerIdWithBall
1195+ 87E2                  ; A = stato/team, H = ownerID (o 255), L = contendenteID (o 255)
1196+ 87E2 C1               pop  bc                  ; ripristina B=TEAM, C=ID scelto (1..3)
1197+ 87E3
1198+ 87E3                  ; Se A è TEAM_BLACK / TEAM_WHITE e coincide con B,
1199+ 87E3                  ; e H == C -> questo giocatore ha la palla => NON muoverlo
1200+ 87E3 FE 00            cp   TEAM_BLACK
1201+ 87E5 28 06            jr   z,.check_owner
1202+ 87E7 FE 01            cp   TEAM_WHITE
1203+ 87E9 28 02            jr   z,.check_owner
1204+ 87EB 18 07            jr   .no_owner           ; palla libera / contesa / in movimento
1205+ 87ED
1206+ 87ED              .check_owner:
1207+ 87ED B8               cp   b                   ; team col possesso == nostro team?
1208+ 87EE 20 04            jr   nz,.no_owner
1209+ 87F0 7C               ld   a,h                 ; ownerID
1210+ 87F1 B9               cp   c                   ; è proprio il nostro giocatore?
1211+ 87F2 28 10            jr   z,.done             ; sì -> non muovere verticalmente
1212+ 87F4
1213+ 87F4              .no_owner:
1214+ 87F4                  ; --- scegli direzione N/S (random) ------------------------------
1215+ 87F4
1216+ 87F4
1217+ 87F4 CD 38 9A         call Game_GetRandom0_4
1218+ 87F7
1219+ 87F7
1220+ 87F7
1221+ 87F7 FE 01            CP   1
1222+ 87F9 28 0E            JR   z,.move_down
1223+ 87FB FE 03            CP   3
1224+ 87FD 30 0A            JR   nc,.move_down
1225+ 87FF 3E 03            ld   a,PLAYER_ASKED_DIRECTION_NORTH
1226+ 8801
1227+ 8801              .do_move:
1228+ 8801 CD E0 9A         call Game_TryMovePlayerVertically
1229+ 8804
1230+ 8804              .done:
1231+ 8804 E1               pop  hl
1232+ 8805 D1               pop  de
1233+ 8806 C1               pop  bc
1234+ 8807 F1               pop  af
1235+ 8808 C9               ret
1236+ 8809              .move_down:
1237+ 8809 3E 04            ld   a,PLAYER_ASKED_DIRECTION_SOUTH
1238+ 880B 18 F4            jr   .do_move
1239+ 880D
1240+ 880D
1241+ 880D              ; ---------------------------------------------------------------------------
1242+ 880D              ; Game_Ai_MoveHoriz_AwayOrRandom
1243+ 880D              ;
1244+ 880D              ; INPUT:
1245+ 880D              ;   B = TEAM
1246+ 880D              ;   C = ID del giocatore coinvolto nella contesa
1247+ 880D              ;
1248+ 880D              ; Effetto:
1249+ 880D              ;   - Legge posizione di questo giocatore e quella dell'altro (se vuoi
1250+ 880D              ;     puoi passare anche l'altro X in un registro).
1251+ 880D              ;   - Per semplicità:
1252+ 880D              ;       * se X=0 -> prova solo EAST
1253+ 880D              ;       * se X=4 -> prova solo WEST
1254+ 880D              ;       * se X=1 e a sinistra c'è compagno -> forza EAST
1255+ 880D              ;       * se X=3 e a destra   c'è compagno -> forza WEST
1256+ 880D              ;       * altrimenti dir random LEFT/RIGHT.
1257+ 880D              ;   - Chiama Game_TryMovePlayerHorizontally
1258+ 880D              ; ---------------------------------------------------------------------------
1259+ 880D              Game_Ai_MoveHoriz_AwayOrRandom:
1260+ 880D F5               push af
1261+ 880E C5               push bc
1262+ 880F D5               push de
1263+ 8810 E5               push hl
1264+ 8811
1265+ 8811                  ; prendi posizione corrente
1266+ 8811 CD 14 96         call Game_GetPlayerInfoById      ; HL = pos (H=Y, L=X)
1267+ 8814 54               ld   d,h                         ; D = Y
1268+ 8815 5D               ld   e,l                         ; E = X
1269+ 8816
1270+ 8816                  ; bordi assoluti
1271+ 8816 7B               ld   a,e
1272+ 8817 FE 00            cp   0
1273+ 8819 28 33            jr   z,.force_east
1274+ 881B FE 04            cp   4
1275+ 881D 28 33            jr   z,.force_west
1276+ 881F
1277+ 881F                  ; colonne 1 o 3 con compagno accanto?
1278+ 881F                  ;  - se X=1 e a sinistra (0) c'è un compagno → forza east
1279+ 881F                  ;  - se X=3 e a destra  (4) c'è un compagno → forza west
1280+ 881F
1281+ 881F FE 01            cp   1
1282+ 8821 20 0E            jr   nz,.check_x3
1283+ 8823                  ; X=1: controlla (Y,0)
1284+ 8823 C5               push bc
1285+ 8824 54               ld   d,h          ; Y
1286+ 8825 1E 00            ld   e,0
1287+ 8827 CD 2F 96         call Game_GetPlayerInfoByPos
1288+ 882A C1               pop  bc
1289+ 882B FE FF            cp   NO_VALUE
1290+ 882D 20 1F            jr   nz,.force_east   ; qualcuno lì → forza east
1291+ 882F 18 10            jr   .rand_dir
1292+ 8831
1293+ 8831              .check_x3:
1294+ 8831 FE 03            cp   3
1295+ 8833 20 0C            jr   nz,.rand_dir
1296+ 8835                  ; X=3: controlla (Y,4)
1297+ 8835 C5               push bc
1298+ 8836 54               ld   d,h
1299+ 8837 1E 04            ld   e,4
1300+ 8839 CD 2F 96         call Game_GetPlayerInfoByPos
1301+ 883C C1               pop  bc
1302+ 883D FE FF            cp   NO_VALUE
1303+ 883F 20 11            jr   nz,.force_west
1304+ 8841
1305+ 8841              .rand_dir:
1306+ 8841                  ; direzione random
1307+ 8841 CD 32 9A         call Game_GetRandomByte
1308+ 8844 E6 01            and 00000001b
1309+ 8846 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1310+ 8848 28 0A            jr   z,.do_move
1311+ 884A 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1312+ 884C 18 06            jr   .do_move
1313+ 884E
1314+ 884E              .force_east:
1315+ 884E 3E 01            ld   a,PLAYER_ASKED_DIRECTION_EAST
1316+ 8850 18 02            jr   .do_move
1317+ 8852
1318+ 8852              .force_west:
1319+ 8852 3E 02            ld   a,PLAYER_ASKED_DIRECTION_WEST
1320+ 8854
1321+ 8854              .do_move:
1322+ 8854 CD 79 9E         call Game_TryMovePlayerHorizontally
1323+ 8857
1324+ 8857 E1               pop  hl
1325+ 8858 D1               pop  de
1326+ 8859 C1               pop  bc
1327+ 885A F1               pop  af
1328+ 885B C9               ret
1329+ 885C              ;---------------------------------------------------------------------------
1330+ 885C              ; Hooks_UpdateTimeToPlay
1331+ 885C              ;---------------------------------------------------------------------------
1332+ 885C              Hooks_UpdateTimeToPlay:
1333+ 885C 3A DF B1         LD      A, (Var_Game_TimeToPlay)
1334+ 885F 32 C3 B1         LD      (Var_Game_SecondsToPlay), A
1335+ 8862 C9               RET
1336+ 8863
# file closed: ./inc/hooks.asm
  15  8863                  INCLUDE "vdp.asm"                       ; Include screen library
# file opened: ./inc/vdp.asm
   1+ 8863              ; ===================================================================
   2+ 8863              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 8863              ; ===================================================================
   4+ 8863
   5+ 8863              ; *** SCREEN.ASM (sjasm-normalized, buffered & fast VRAM I/O) ***
   6+ 8863
   7+ 8863
   8+ 8863              ;------------------------------------------------------------------------
   9+ 8863              ; Print string
  10+ 8863              ; INPUT:  HL = pointer to null-terminated string
  11+ 8863              ;         D,E = character position (Y,X)
  12+ 8863              ;------------------------------------------------------------------------
  13+ 8863              VDP_PrintString:
  14+ 8863 7E               ld      a,(hl)
  15+ 8864 B7               or      a
  16+ 8865 C8               ret     z
  17+ 8866 F5               push    af
  18+ 8867 CD A2 88         call    VDP_PrintRomChar
  19+ 886A F1               pop     af
  20+ 886B 1C               inc     e
  21+ 886C 23               inc     hl
  22+ 886D 18 F4            jr      VDP_PrintString
  23+ 886F
  24+ 886F
  25+ 886F              ;------------------------------------------------------------------------
  26+ 886F              ; Print a single RAM character out to a screen address
  27+ 886F              ; INPUT:
  28+ 886F              ;   A: Character to print
  29+ 886F              ;   D: Character Y position
  30+ 886F              ;   E: Character X position
  31+ 886F              ; OUTPUT: -
  32+ 886F              ; MODIFIES: -
  33+ 886F              ;------------------------------------------------------------------------
  34+ 886F              VDP_PrintRamChar:
  35+ 886F D5                   PUSH    DE
  36+ 8870 F5                   PUSH    AF
  37+ 8871 FE 40                CP      TILE_BALL_BOTTOM
  38+ 8873 DA 7B 88             JP      C, .AfterColorCheck
  39+ 8876 3E 20                LD      A, GREEN_CHAR_ATTRIBUTE
  40+ 8878 CD 53 8B             CALL    VDP_SetCharAttribute
  41+ 887B              .AfterColorCheck:
  42+ 887B F1                   POP     AF
  43+ 887C D1                   POP     DE
  44+ 887D
  45+ 887D
  46+ 887D
  47+ 887D
  48+ 887D
  49+ 887D D5                   PUSH    DE
  50+ 887E D9                   EXX                                 ; Backup registers BC, DE, HL
  51+ 887F D1                   POP     DE
  52+ 8880 F5                   PUSH    AF
  53+ 8881 21 00 B5             LD      HL, RAM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
  54+ 8884 06 00                LD      B,0                         ; BC = character code
  55+ 8886 4F                   LD      C, A
  56+ 8887 CB 21                SLA     C                           ; Multiply by 8 by shifting
  57+ 8889 CB 10                RL      B
  58+ 888B CB 21                SLA     C
  59+ 888D CB 10                RL      B
  60+ 888F CB 21                SLA     C
  61+ 8891 CB 10                RL      B
  62+ 8893 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
  63+ 8894 CD C9 88             CALL    GetCharAddress              ; Get screen position in DE
  64+ 8897 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
  65+ 8899              .PrintRamCharL1:
  66+ 8899 7E                   LD      A,(HL)                      ; Get the byte from the ROM into A
  67+ 889A 12                   LD      (DE),A                      ; Stick A onto the screen
  68+ 889B 23                   INC     HL                          ; Goto next byte of character
  69+ 889C 14                   INC     D                           ; Goto next line on screen
  70+ 889D 10 FA                DJNZ    .PrintRamCharL1              ; Loop around whilst it is Not Zero (NZ)
  71+ 889F D9                   EXX                                 ; Restore registers BC, DE, HL
  72+ 88A0 F1                   POP     AF
  73+ 88A1 C9                   RET
  74+ 88A2              ;------------------------------------------------------------------------
  75+ 88A2              ; Print a single ROM character out to a screen address
  76+ 88A2              ; INPUT:
  77+ 88A2              ;   A: Character to print
  78+ 88A2              ;   D: Character Y position
  79+ 88A2              ;   E: Character X position
  80+ 88A2              ; OUTPUT: -
  81+ 88A2              ; MODIFIES: -
  82+ 88A2              ;------------------------------------------------------------------------
  83+ 88A2              VDP_PrintRomChar:
  84+ 88A2 D5                   PUSH    DE
  85+ 88A3 D9                   EXX                                 ; Backup registers BC, DE, HL
  86+ 88A4 D1                   POP     DE
  87+ 88A5 F5                   PUSH    AF
  88+ 88A6 21 00 3D             LD      HL, ROM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
  89+ 88A9 06 00                LD      B,0                         ; BC = character code
  90+ 88AB D6 20                SUB     32                          ; Adjust for the character set
  91+ 88AD 4F                   LD      C, A
  92+ 88AE CB 21                SLA     C                           ; Multiply by 8 by shifting
  93+ 88B0 CB 10                RL      B
  94+ 88B2 CB 21                SLA     C
  95+ 88B4 CB 10                RL      B
  96+ 88B6 CB 21                SLA     C
  97+ 88B8 CB 10                RL      B
  98+ 88BA 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
  99+ 88BB CD C9 88             CALL    GetCharAddress              ; Get screen position in DE
 100+ 88BE 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
 101+ 88C0              .PrintRomCharL1:
 102+ 88C0 7E                   LD      A,(HL)                      ; Get the byte from the ROM into A
 103+ 88C1 12                   LD      (DE),A                      ; Stick A onto the screen
 104+ 88C2 23                   INC     HL                          ; Goto next byte of character
 105+ 88C3 14                   INC     D                           ; Goto next line on screen
 106+ 88C4 10 FA                DJNZ    .PrintRomCharL1              ; Loop around whilst it is Not Zero (NZ)
 107+ 88C6 D9                   EXX                                 ; Restore registers BC, DE, HL
 108+ 88C7 F1                   POP     AF
 109+ 88C8 C9                   RET
 110+ 88C9
 111+ 88C9              ;------------------------------------------------------------------------
 112+ 88C9              ; Get screen address from a character (X,Y) coordinate
 113+ 88C9              ; INPUT:
 114+ 88C9              ;   D: Y character position (0-23)
 115+ 88C9              ;   E: X character position (0-31)
 116+ 88C9              ; OUTPUT:
 117+ 88C9              ;   DE: screen address
 118+ 88C9              ; MODIFIES: A
 119+ 88C9              ;------------------------------------------------------------------------
 120+ 88C9              GetCharAddress:
 121+ 88C9 7A                   LD      A,D
 122+ 88CA E6 07                AND     %00000111
 123+ 88CC 1F                   RRA
 124+ 88CD 1F                   RRA
 125+ 88CE 1F                   RRA
 126+ 88CF 1F                   RRA
 127+ 88D0 B3                   OR      E
 128+ 88D1 5F                   LD      E,A
 129+ 88D2 7A                   LD      A,D
 130+ 88D3 E6 18                AND     %00011000
 131+ 88D5 F6 40                OR      %01000000
 132+ 88D7 57                   LD      D,A
 133+ 88D8 C9                   RET
 134+ 88D9
 135+ 88D9              ;------------------------------------------------------------------------
 136+ 88D9              ; Load tiles from ROM to VRAM
 137+ 88D9              ;------------------------------------------------------------------------
 138+ 88D9              VDP_LoadTiles:
 139+ 88D9 F3               DI                      ; Interrupts disabled
 140+ 88DA 11 00 B5         LD      DE, RAM_CHAR_SET_ADDRESS
 141+ 88DD 21 B2 AA         LD      HL, TILES
 142+ 88E0 01 00 07         LD      BC, 1792
 143+ 88E3 ED B0            LDIR
 144+ 88E5                  ;EI                      ; Interrupts enabled
 145+ 88E5 C9               RET
 146+ 88E6              ;------------------------------------------------------------------------
 147+ 88E6              ; Clear screen (INVARIATA)
 148+ 88E6              ;------------------------------------------------------------------------
 149+ 88E6              VDP_ClearScreen:
 150+ 88E6 3E 00            LD   A, 0           ; 0 in the lower 3 bits = black
 151+ 88E8 D3 FE            OUT  (254), A       ; Send A to port 0xFE
 152+ 88EA
 153+ 88EA                  ;----------------------------------------------------------
 154+ 88EA                  ; Clear 6144 bytes of screen pixel area (0x4000..0x57FF)
 155+ 88EA                  ;----------------------------------------------------------
 156+ 88EA
 157+ 88EA 21 00 40         LD   HL, 0x4000      ; Start address of pixel area
 158+ 88ED 11 01 40         LD   DE, 0x4001      ; DE = HL + 1 for LDIR
 159+ 88F0 01 00 18         LD   BC, 6144        ; Number of bytes to clear
 160+ 88F3 36 00            LD   (HL), 0         ; Store 0 in the first byte
 161+ 88F5 ED B0            LDIR                 ; Repeats until BC = 0 (fills with 0)
 162+ 88F7
 163+ 88F7                  ;----------------------------------------------------------
 164+ 88F7                  ; Fill 768 bytes of attributes area (0x5800..0x5AFF)
 165+ 88F7                  ; with 0x07 (white on black)
 166+ 88F7                  ;----------------------------------------------------------
 167+ 88F7
 168+ 88F7 21 00 58         LD   HL, 0x5800      ; Start address of attributes area
 169+ 88FA 11 01 58         LD   DE, 0x5801      ; DE = HL + 1 for LDIR
 170+ 88FD 01 00 03         LD   BC, 768         ; Number of attribute bytes
 171+ 8900 36 07            LD   (HL), 0x07      ; Attribute = 0x07 (white on black)
 172+ 8902 ED B0            LDIR                 ; Fill the attribute area with 0x07
 173+ 8904
 174+ 8904 C9               RET
 175+ 8905
 176+ 8905
 177+ 8905
 178+ 8905
 179+ 8905
 180+ 8905
 181+ 8905              ; -----------------------------------------------------------
 182+ 8905              ; Draw sprite (32x32 tile)
 183+ 8905              ; INPUT: D = row (Y), E = col (X), A = tile index
 184+ 8905              ; -----------------------------------------------------------
 185+ 8905              VDP_DrawSprite:
 186+ 8905 F5               PUSH    AF
 187+ 8906 7A               ld      a,d
 188+ 8907 87               add     a,a          ; *2
 189+ 8908 87               add     a,a          ; *4
 190+ 8909 57               ld      d,a
 191+ 890A
 192+ 890A 7B               ld      a,e
 193+ 890B 87               add     a,a          ; *2
 194+ 890C 87               add     a,a          ; *4
 195+ 890D 5F               ld      e,a
 196+ 890E 1C               inc     e
 197+ 890F 14               inc     d
 198+ 8910 3A C2 B1         ld      a, (Var_Game_ActiveFieldSide)
 199+ 8913 FE 01            CP      FIELD_NORTH_SIDE
 200+ 8915 CA 1A 89         JP      Z, .NorthSideAdjust
 201+ 8918 14               inc     d
 202+ 8919 14               inc     d
 203+ 891A              .NorthSideAdjust:
 204+ 891A F1               POP     AF
 205+ 891B 4F               ld      c,a
 206+ 891C FE 04            cp      TILE_CORNER_BALL_EMPTY
 207+ 891E 28 10            jr      z,.CornerBallArea
 208+ 8920 FE 00            cp      TILE_CORNER
 209+ 8922 28 0C            jr      z,.CornerBallArea
 210+ 8924 FE 06            cp      TILE_BALL_TOP
 211+ 8926 28 6D            jr      z,.TopBall
 212+ 8928 FE 07            cp      TILE_BALL_TOP_FRONT
 213+ 892A 28 79            jr      z,.TopBallFront
 214+ 892C FE 03            cp      TILE_CORNER_BALL
 215+ 892E 20 23            jr      nz,.TileField
 216+ 8930
 217+ 8930              .CornerBallArea:
 218+ 8930 7A               ld      a,d
 219+ 8931 FE 01            cp      1
 220+ 8933 20 04            jr      nz,.CornerBallEmptyBottom
 221+ 8935 16 02            ld      d,2
 222+ 8937 18 02            jr      .CornerBallEmptySide
 223+ 8939              .CornerBallEmptyBottom:
 224+ 8939 16 15            ld      d,21
 225+ 893B              .CornerBallEmptySide:
 226+ 893B 1C               inc     e
 227+ 893C 79               ld      a,c
 228+ 893D FE 04            cp      TILE_CORNER_BALL_EMPTY
 229+ 893F 28 06            jr      z,.CornerBallEmptyTile
 230+ 8941 FE 00            cp      TILE_CORNER
 231+ 8943 28 02            jr      z,.CornerBallEmptyTile
 232+ 8945 18 0C            jr      .TileField
 233+ 8947              .CornerBallEmptyTile:
 234+ 8947 3E 6F            ld      a,111
 235+ 8949 CD 6F 88         call    VDP_PrintRamChar
 236+ 894C 1C               inc     e
 237+ 894D 3E 6F            ld      a,111
 238+ 894F CD 6F 88         call    VDP_PrintRamChar
 239+ 8952 C9               ret
 240+ 8953              .TileField:
 241+ 8953 FE D6            cp      TILE_FIELD
 242+ 8955 C2 85 89         jp      nz,.CornerBall
 243+ 8958
 244+ 8958 D5               push    de
 245+ 8959 F5               push    af
 246+ 895A C5               push    bc
 247+ 895B E5               push    hl
 248+ 895C
 249+ 895C 62               ld      h,d
 250+ 895D 6B               ld      l,e
 251+ 895E 42               ld      b,d
 252+ 895F 04               inc     b
 253+ 8960 04               inc     b
 254+ 8961 04               inc     b
 255+ 8962 04               inc     b
 256+ 8963 4B               ld      c,e
 257+ 8964 0C               inc     c
 258+ 8965 0C               inc     c
 259+ 8966 0C               inc     c
 260+ 8967 0C               inc     c
 261+ 8968
 262+ 8968              .EmptyRowLoop:
 263+ 8968 7A               ld      a,d
 264+ 8969 B8               cp      b
 265+ 896A CA 80 89         jp      z,.EmptyExit
 266+ 896D
 267+ 896D 5D               ld      e,l
 268+ 896E              .EmptyColLoop:
 269+ 896E 7B               ld      a,e
 270+ 896F B9               cp      c
 271+ 8970 CA 7C 89         jp      z,.EmptyNextRow
 272+ 8973
 273+ 8973 3E D6            ld      a,TILE_FIELD
 274+ 8975 CD 6F 88         call    VDP_PrintRamChar
 275+ 8978 1C               inc     e
 276+ 8979 C3 6E 89         jp      .EmptyColLoop
 277+ 897C
 278+ 897C              .EmptyNextRow:
 279+ 897C 14               inc     d
 280+ 897D C3 68 89         jp      .EmptyRowLoop
 281+ 8980
 282+ 8980              .EmptyExit:
 283+ 8980 E1               pop     hl
 284+ 8981 C1               pop     bc
 285+ 8982 F1               pop     af
 286+ 8983 D1               pop     de
 287+ 8984 C9               ret
 288+ 8985
 289+ 8985              .CornerBall:
 290+ 8985 FE 03            cp      TILE_CORNER_BALL
 291+ 8987 20 2D            jr      nz,.Dispatch
 292+ 8989 3E 4D            ld      a,77
 293+ 898B CD 6F 88         call    VDP_PrintRamChar
 294+ 898E 1C               inc     e
 295+ 898F 3E 4E            ld      a,78
 296+ 8991 CD 6F 88         call    VDP_PrintRamChar
 297+ 8994 C9               ret
 298+ 8995
 299+ 8995              .TopBall:
 300+ 8995 FE 06            cp      TILE_BALL_TOP
 301+ 8997 20 1D            jr      nz,.Dispatch
 302+ 8999 3E 4D            ld      a,77
 303+ 899B CD 6F 88         call    VDP_PrintRamChar
 304+ 899E 1C               inc     e
 305+ 899F 3E 4E            ld      a,78
 306+ 89A1 CD 6F 88         call    VDP_PrintRamChar
 307+ 89A4 C9               ret
 308+ 89A5
 309+ 89A5              .TopBallFront:
 310+ 89A5 FE 07            cp      TILE_BALL_TOP_FRONT
 311+ 89A7 20 0D            jr      nz,.Dispatch
 312+ 89A9 1C               inc     e
 313+ 89AA 3E 4D            ld      a,77
 314+ 89AC CD 6F 88         call    VDP_PrintRamChar
 315+ 89AF 1C               inc     e
 316+ 89B0 3E 4E            ld      a,78
 317+ 89B2 CD 6F 88         call    VDP_PrintRamChar
 318+ 89B5 C9               ret
 319+ 89B6
 320+ 89B6              ; ---------- dispatcher ----------
 321+ 89B6              .Dispatch:
 322+ 89B6 FE A0            cp      TILE_WHITE_PLAYER
 323+ 89B8 CA CD 89         jp      z,.MaybeWhiteHalfLine
 324+ 89BB FE 50            cp      TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 325+ 89BD CA CD 89         jp      z,.MaybeWhiteHalfLine
 326+ 89C0 FE 01            cp      TILE_WHITE_PLAYER_WITH_BALL
 327+ 89C2 CA 04 8A         jp      z,.DrawWhiteWithFeetBall
 328+ 89C5 FE 02            cp      TILE_BLACK_PLAYER_WITH_BACK_BALL
 329+ 89C7 CA 57 8A         jp      z,.DrawBlackWithBackBall
 330+ 89CA C3 70 8A         jp      .BaseDraw
 331+ 89CD
 332+ 89CD              ; ---------- white: “testa nella metà campo” ----------
 333+ 89CD              .MaybeWhiteHalfLine:
 334+ 89CD FE 50            cp      TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 335+ 89CF 28 17            jr      z, .MaybeWhiteHalfLineContinue
 336+ 89D1 3A C2 B1         ld      a, (Var_Game_ActiveFieldSide)
 337+ 89D4 FE 00            CP      FIELD_SOUTH_SIDE
 338+ 89D6 C2 E2 89         JP      NZ, .MaybeWhiteHalfLineNorth
 339+ 89D9 7A               LD      A,D
 340+ 89DA FE 07            CP      7
 341+ 89DC C2 FF 89         JP      NZ, .DrawWhiteBaseNormal
 342+ 89DF C3 E8 89         JP      .MaybeWhiteHalfLineContinue
 343+ 89E2              .MaybeWhiteHalfLineNorth:
 344+ 89E2 7A               LD      A,D
 345+ 89E3 FE 11            CP      17
 346+ 89E5 C2 FF 89         JP      NZ, .DrawWhiteBaseNormal
 347+ 89E8              .MaybeWhiteHalfLineContinue:
 348+ 89E8 D5               push    de
 349+ 89E9                  ;ld      d,b
 350+ 89E9 7B               ld      a,e
 351+ 89EA 3C               inc     a
 352+ 89EB 5F               ld      e,a
 353+ 89EC 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
 354+ 89EE CD 6F 88         call    VDP_PrintRamChar
 355+ 89F1 1C               inc     e
 356+ 89F2 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
 357+ 89F4 CD 6F 88         call    VDP_PrintRamChar
 358+ 89F7 D1               pop     de
 359+ 89F8 14               inc     d
 360+ 89F9 3E 50            ld      a,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 361+ 89FB C3 70 8A         jp      .BaseDraw
 362+ 89FE 15               dec     d
 363+ 89FF              .DrawWhiteBaseNormal:
 364+ 89FF 3E A0            ld      a,TILE_WHITE_PLAYER
 365+ 8A01 C3 70 8A         jp      .BaseDraw
 366+ 8A04
 367+ 8A04              ; ---------- white con palla ai piedi ----------
 368+ 8A04              .DrawWhiteWithFeetBall:
 369+ 8A04 3A 2A B2         ld      a,(Var_Vdp_HalfFieldHorzLinePos)
 370+ 8A07 47               ld      b,a
 371+ 8A08 7A               ld      a,d
 372+ 8A09 3D               dec     a
 373+ 8A0A B8               cp      b
 374+ 8A0B 20 11            jr      nz,.NoHalf
 375+ 8A0D
 376+ 8A0D D5               push    de
 377+ 8A0E 50               ld      d,b
 378+ 8A0F 7B               ld      a,e
 379+ 8A10 3C               inc     a
 380+ 8A11 5F               ld      e,a
 381+ 8A12 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
 382+ 8A14 CD 6F 88         call    VDP_PrintRamChar
 383+ 8A17 1C               inc     e
 384+ 8A18 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
 385+ 8A1A CD 6F 88         call    VDP_PrintRamChar
 386+ 8A1D D1               pop     de
 387+ 8A1E
 388+ 8A1E              .NoHalf:
 389+ 8A1E 79               ld      a,c
 390+ 8A1F FE 01            cp      TILE_WHITE_PLAYER_WITH_BALL
 391+ 8A21 28 1C            jr      z,.Half
 392+ 8A23
 393+ 8A23 3E A0            ld      a,TILE_WHITE_PLAYER
 394+ 8A25 CD 70 8A         call    .BaseDraw
 395+ 8A28
 396+ 8A28 D5               push    de
 397+ 8A29 7A               ld      a,d
 398+ 8A2A C6 03            add     a,3
 399+ 8A2C 57               ld      d,a
 400+ 8A2D 7B               ld      a,e
 401+ 8A2E C6 02            add     a,2
 402+ 8A30 5F               ld      e,a
 403+ 8A31 1D               dec     e
 404+ 8A32 3E DF            ld      a,TILE_WHITE_PLAYER_AND_BALL
 405+ 8A34 CD 6F 88         call    VDP_PrintRamChar
 406+ 8A37 1C               inc     e
 407+ 8A38 3E DC            ld      a,TILE_BALL_FEET_OVERLAY_R
 408+ 8A3A CD 6F 88         call    VDP_PrintRamChar
 409+ 8A3D D1               pop     de
 410+ 8A3E C9               ret
 411+ 8A3F
 412+ 8A3F              .Half:
 413+ 8A3F D5               push    de
 414+ 8A40 7A               ld      a,d
 415+ 8A41 C6 03            add     a,3
 416+ 8A43 57               ld      d,a
 417+ 8A44 7B               ld      a,e
 418+ 8A45 C6 02            add     a,2
 419+ 8A47 5F               ld      e,a
 420+ 8A48 1D               dec     e
 421+ 8A49 3E DF            ld      a,TILE_WHITE_PLAYER_AND_BALL
 422+ 8A4B 15               dec     d
 423+ 8A4C CD 6F 88         call    VDP_PrintRamChar
 424+ 8A4F 1C               inc     e
 425+ 8A50 3E DC            ld      a,TILE_BALL_FEET_OVERLAY_R
 426+ 8A52 CD 6F 88         call    VDP_PrintRamChar
 427+ 8A55 D1               pop     de
 428+ 8A56 C9               ret
 429+ 8A57
 430+ 8A57              ; ---------- nero con palla alle spalle ----------
 431+ 8A57              .DrawBlackWithBackBall:
 432+ 8A57 3E B0            ld      a,TILE_BLACK_PLAYER
 433+ 8A59 CD 70 8A         call    .BaseDraw
 434+ 8A5C
 435+ 8A5C D5               push    de
 436+ 8A5D 7B               ld      a,e
 437+ 8A5E FE 1F            cp      31
 438+ 8A60 CA 6E 8A         jp      z,.WBack_Done
 439+ 8A63 3E DD            ld      a,TILE_BALL_BACK_OVERLAY_L
 440+ 8A65 CD 6F 88         call    VDP_PrintRamChar
 441+ 8A68 1C               inc     e
 442+ 8A69 3E DE            ld      a,TILE_BALL_BACK_OVERLAY_R
 443+ 8A6B CD 6F 88         call    VDP_PrintRamChar
 444+ 8A6E              .WBack_Done:
 445+ 8A6E D1               pop     de
 446+ 8A6F C9               ret
 447+ 8A70
 448+ 8A70              ; ---------- routine di base: disegna 4x4 a partire da A ----------
 449+ 8A70              .BaseDraw:
 450+ 8A70 D5               push    de
 451+ 8A71 F5               push    af
 452+ 8A72
 453+ 8A72 CD 6F 88         call    VDP_PrintRamChar
 454+ 8A75 1C               inc     e
 455+ 8A76 3C               inc     a
 456+ 8A77 CD 6F 88         call    VDP_PrintRamChar
 457+ 8A7A 1C               inc     e
 458+ 8A7B 3C               inc     a
 459+ 8A7C CD 6F 88         call    VDP_PrintRamChar
 460+ 8A7F 1C               inc     e
 461+ 8A80 3C               inc     a
 462+ 8A81 CD 6F 88         call    VDP_PrintRamChar
 463+ 8A84
 464+ 8A84 14               inc     d
 465+ 8A85 1D               dec     e
 466+ 8A86 1D               dec     e
 467+ 8A87 1D               dec     e
 468+ 8A88 3C               inc     a
 469+ 8A89 CD 6F 88         call    VDP_PrintRamChar
 470+ 8A8C 1C               inc     e
 471+ 8A8D 3C               inc     a
 472+ 8A8E CD 6F 88         call    VDP_PrintRamChar
 473+ 8A91 1C               inc     e
 474+ 8A92 3C               inc     a
 475+ 8A93 CD 6F 88         call    VDP_PrintRamChar
 476+ 8A96 1C               inc     e
 477+ 8A97 3C               inc     a
 478+ 8A98 CD 6F 88         call    VDP_PrintRamChar
 479+ 8A9B
 480+ 8A9B 14               inc     d
 481+ 8A9C 1D               dec     e
 482+ 8A9D 1D               dec     e
 483+ 8A9E 1D               dec     e
 484+ 8A9F 3C               inc     a
 485+ 8AA0 CD 6F 88         call    VDP_PrintRamChar
 486+ 8AA3 1C               inc     e
 487+ 8AA4 3C               inc     a
 488+ 8AA5 CD 6F 88         call    VDP_PrintRamChar
 489+ 8AA8 1C               inc     e
 490+ 8AA9 3C               inc     a
 491+ 8AAA CD 6F 88         call    VDP_PrintRamChar
 492+ 8AAD 1C               inc     e
 493+ 8AAE 3C               inc     a
 494+ 8AAF CD 6F 88         call    VDP_PrintRamChar
 495+ 8AB2 32 2B B2         ld      (Var_VdpTemp), a
 496+ 8AB5 F1               pop     af
 497+ 8AB6 F5               push    af
 498+ 8AB7 FE 50            cp      TILE_WHITE_PLAYER_NEAR_HALF_FIELD
 499+ 8AB9 28 1A            JR      Z, .HalfLineRedraw
 500+ 8ABB 3A 2B B2         ld      a, (Var_VdpTemp)
 501+ 8ABE 14               inc     d
 502+ 8ABF 1D               dec     e
 503+ 8AC0 1D               dec     e
 504+ 8AC1 1D               dec     e
 505+ 8AC2 3C               inc     a
 506+ 8AC3 CD 6F 88         call    VDP_PrintRamChar
 507+ 8AC6 1C               inc     e
 508+ 8AC7 3C               inc     a
 509+ 8AC8 CD 6F 88         call    VDP_PrintRamChar
 510+ 8ACB 1C               inc     e
 511+ 8ACC 3C               inc     a
 512+ 8ACD CD 6F 88         call    VDP_PrintRamChar
 513+ 8AD0 1C               inc     e
 514+ 8AD1 3C               inc     a
 515+ 8AD2 CD 6F 88         call    VDP_PrintRamChar
 516+ 8AD5              .HalfLineRedraw:
 517+ 8AD5 E5               PUSH    HL
 518+ 8AD6 C5               PUSH    BC
 519+ 8AD7 CD DF 8A         call    .HalfFieldRowRedraw
 520+ 8ADA C1               POP     BC
 521+ 8ADB E1               POP     HL
 522+ 8ADC F1               pop     af
 523+ 8ADD D1               pop     de
 524+ 8ADE
 525+ 8ADE C9               ret
 526+ 8ADF              .HalfFieldRowRedraw:
 527+ 8ADF 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
 528+ 8AE2 FE 01            CP      FIELD_NORTH_SIDE
 529+ 8AE4 20 3C            JR      NZ, .HalfFieldRowRedrawSouth
 530+ 8AE6 16 04            LD      D, 4
 531+ 8AE8 7A               LD      A, D
 532+ 8AE9 87               ADD     A, A
 533+ 8AEA 87               ADD     A, A
 534+ 8AEB 47               LD      B, A
 535+ 8AEC              .HalfFieldRowRedrawDone:
 536+ 8AEC 1E 00            LD      E, 0
 537+ 8AEE              .HalfFieldRowRedrawDoneColsLoop:
 538+ 8AEE D5               PUSH    DE
 539+ 8AEF D5               PUSH    DE
 540+ 8AF0 C5               PUSH    BC
 541+ 8AF1 CD 2F 96         CALL    Game_GetPlayerInfoByPos
 542+ 8AF4 C1               POP     BC
 543+ 8AF5 D1               POP     DE
 544+ 8AF6 FE FF            CP      NO_VALUE
 545+ 8AF8 20 20            JR      NZ, .HalfFieldRowRedrawDoneColsLoopContinue
 546+ 8AFA 50               LD      D, B
 547+ 8AFB 7B               LD      A, E
 548+ 8AFC 87               ADD     A, A
 549+ 8AFD 87               ADD     A, A
 550+ 8AFE 5F               LD      E, A
 551+ 8AFF 14               INC     D
 552+ 8B00 1C               INC     E
 553+ 8B01 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
 554+ 8B03 C5               PUSH    BC
 555+ 8B04 CD 6F 88         CALL    VDP_PrintRamChar
 556+ 8B07 C1               POP     BC
 557+ 8B08 1C               INC     E
 558+ 8B09 C5               PUSH    BC
 559+ 8B0A CD 6F 88         CALL    VDP_PrintRamChar
 560+ 8B0D C1               POP     BC
 561+ 8B0E 1C               INC     E
 562+ 8B0F C5               PUSH    BC
 563+ 8B10 CD 6F 88         CALL    VDP_PrintRamChar
 564+ 8B13 C1               POP     BC
 565+ 8B14 1C               INC     E
 566+ 8B15 C5               PUSH    BC
 567+ 8B16 CD 6F 88         CALL    VDP_PrintRamChar
 568+ 8B19 C1               POP     BC
 569+ 8B1A              .HalfFieldRowRedrawDoneColsLoopContinue:
 570+ 8B1A D1               POP     DE
 571+ 8B1B 1C               INC     E
 572+ 8B1C 7B               LD      A, E
 573+ 8B1D FE 04            CP      4
 574+ 8B1F C8               RET     Z
 575+ 8B20 18 CC            JR      .HalfFieldRowRedrawDoneColsLoop
 576+ 8B22              .HalfFieldRowRedrawSouth:
 577+ 8B22 16 01            LD      D, 1
 578+ 8B24 7A               LD      A, D
 579+ 8B25 87               ADD     A, A
 580+ 8B26 87               ADD     A, A
 581+ 8B27 47               LD      B, A
 582+ 8B28 04               INC     B
 583+ 8B29 04               INC     B
 584+ 8B2A C3 EC 8A         JP      .HalfFieldRowRedrawDone
 585+ 8B2D
 586+ 8B2D
 587+ 8B2D              ; -----------------------------------------------------------
 588+ 8B2D              ; Fill game field area to green
 589+ 8B2D              ; -----------------------------------------------------------
 590+ 8B2D              FillGameFieldAreaToGreen:
 591+ 8B2D F5               push    af
 592+ 8B2E C5               push    bc
 593+ 8B2F D5               push    de
 594+ 8B30 E5               push    hl
 595+ 8B31
 596+ 8B31 16 00            ld      d, 0
 597+ 8B33
 598+ 8B33              .Row:
 599+ 8B33 D5               push    de
 600+ 8B34 1E 01            ld      e, 1
 601+ 8B36              .Col:
 602+ 8B36 D5               push    de
 603+ 8B37 3E D6            ld      a, TILE_FIELD
 604+ 8B39 CD 6F 88         call    VDP_PrintRamChar
 605+ 8B3C D1               pop     de
 606+ 8B3D 1C               inc     e
 607+ 8B3E 7B               ld      a, e
 608+ 8B3F FE 15            cp      21
 609+ 8B41 28 02            jr      z, .NextRow
 610+ 8B43 18 F1            jr      .Col
 611+ 8B45              .NextRow:
 612+ 8B45 D1               pop     de
 613+ 8B46 14               inc     d
 614+ 8B47 7A               ld      a, d
 615+ 8B48 FE 18            cp      24
 616+ 8B4A 28 02            jr      z, .Done
 617+ 8B4C 18 E5            jr     .Row
 618+ 8B4E              .Done:
 619+ 8B4E E1               pop     hl
 620+ 8B4F D1               pop     de
 621+ 8B50 C1               pop     bc
 622+ 8B51 F1               pop     af
 623+ 8B52 C9               ret
 624+ 8B53
 625+ 8B53
 626+ 8B53
 627+ 8B53              ;------------------------------------------------------------------------
 628+ 8B53              ; Set screen charater attribute
 629+ 8B53              ; INPUT:
 630+ 8B53              ;   A: Value
 631+ 8B53              ;   D: Character Y position
 632+ 8B53              ;   E: Character X position
 633+ 8B53              ; OUTPUT: -
 634+ 8B53              ; MODIFIES: HL
 635+ 8B53              ;------------------------------------------------------------------------
 636+ 8B53              VDP_SetCharAttribute:
 637+ 8B53 D5                   PUSH    DE
 638+ 8B54 E5                   PUSH    HL
 639+ 8B55 C5                   PUSH    BC
 640+ 8B56 F5                   PUSH    AF
 641+ 8B57 7A                   LD      A, D    ; Load row in A
 642+ 8B58                      ; Before keeping the bits of the third, we carry out the rotations
 643+ 8B58 0F                   RRCA
 644+ 8B59 0F                   RRCA         ; Passes the bits of the third to bits 0 and 1
 645+ 8B5A 0F                   RRCA         ; and those of the row to bits 5, 6 and 7
 646+ 8B5B 6F                   LD      L, A    ; Load the result in L
 647+ 8B5C E6 03                AND     0x03     ; A = bits of the third
 648+ 8B5E F6 58                OR      0x58     ; Adds the fixed bits of the high part of the address
 649+ 8B60 67                   LD      H, A    ; H = 0101 10TT
 650+ 8B61 7D                   LD      A, L   ; A = row in bits 5, 6 and 7 and third in bits 0 and 1
 651+ 8B62 E6 E0                AND     0xE0     ; Keeps the bits of the line
 652+ 8B64 B3                   OR      E       ; Adds the bits of the column
 653+ 8B65 6F                   LD      L, A    ; L = RRRC CCCC
 654+ 8B66 F1                   POP     AF
 655+ 8B67 77                   LD      (HL),A          ; Scrivi l'attributo
 656+ 8B68 FE FF                CP      0xFF
 657+ 8B6A C2 6F 8B             JP      NZ, SetAttributeAtDE_1
 658+ 8B6D
 659+ 8B6D 36 14                LD      (HL),20
 660+ 8B6F              SetAttributeAtDE_1:
 661+ 8B6F
 662+ 8B6F
 663+ 8B6F
 664+ 8B6F C1                   POP     BC
 665+ 8B70 E1                   POP     HL
 666+ 8B71 D1                   POP     DE
 667+ 8B72 C9                   RET
 668+ 8B73
 669+ 8B73              ; -----------------------------------------------------------
 670+ 8B73              ; Draw field
 671+ 8B73              ; -----------------------------------------------------------
 672+ 8B73              VDP_DrawField:
 673+ 8B73
 674+ 8B73 CD 2D 8B         call    FillGameFieldAreaToGreen
 675+ 8B76 3E 00            ld      a,0
 676+ 8B78              .VLinesLoop:
 677+ 8B78 F5               push    af
 678+ 8B79 57               ld      d,a
 679+ 8B7A 1E 00            ld      e,0
 680+ 8B7C 3E D1            ld      a,TILE_FIELD_LINE_VERTICAL
 681+ 8B7E 0E 01            ld      c,1
 682+ 8B80 CD 6F 88         call    VDP_PrintRamChar
 683+ 8B83
 684+ 8B83 1E 15            ld      e,21
 685+ 8B85 3E D1            ld      a,TILE_FIELD_LINE_VERTICAL
 686+ 8B87 0E 01            ld      c,1
 687+ 8B89 CD 6F 88         call    VDP_PrintRamChar
 688+ 8B8C
 689+ 8B8C F1               pop     af
 690+ 8B8D 3C               inc     a
 691+ 8B8E FE 18            cp      24
 692+ 8B90 20 E6            jr      nz,.VLinesLoop
 693+ 8B92
 694+ 8B92
 695+ 8B92
 696+ 8B92
 697+ 8B92 3A C2 B1         ld      a,(Var_Game_ActiveFieldSide)
 698+ 8B95 FE 01            cp      FIELD_NORTH_SIDE
 699+ 8B97 CA FE 8C         jp      z,.North
 700+ 8B9A
 701+ 8B9A              ; ---------- SOUTH ----------
 702+ 8B9A              .South:
 703+ 8B9A                  ; pulizia angoli interni
 704+ 8B9A 16 17            ld   d,23
 705+ 8B9C 1E 00            ld   e,0
 706+ 8B9E 3E D6            ld   a,TILE_FIELD
 707+ 8BA0 CD 6F 88         call VDP_PrintRamChar
 708+ 8BA3 16 16            ld   d,22
 709+ 8BA5 1E 00            ld   e,0
 710+ 8BA7 3E D6            ld   a,TILE_FIELD
 711+ 8BA9 CD 6F 88         call VDP_PrintRamChar
 712+ 8BAC 16 15            ld   d,21
 713+ 8BAE 1E 00            ld   e,0
 714+ 8BB0 3E D6            ld   a,TILE_FIELD
 715+ 8BB2 CD 6F 88         call VDP_PrintRamChar
 716+ 8BB5 16 14            ld   d,20
 717+ 8BB7 1E 00            ld   e,0
 718+ 8BB9 3E D6            ld   a,TILE_FIELD
 719+ 8BBB CD 6F 88         call VDP_PrintRamChar
 720+ 8BBE 16 17            ld   d,23
 721+ 8BC0 1E 15            ld   e,21
 722+ 8BC2 3E D6            ld   a,TILE_FIELD
 723+ 8BC4 CD 6F 88         call VDP_PrintRamChar
 724+ 8BC7 16 16            ld   d,22
 725+ 8BC9 1E 15            ld   e,21
 726+ 8BCB 3E D6            ld   a,TILE_FIELD
 727+ 8BCD CD 6F 88         call VDP_PrintRamChar
 728+ 8BD0 16 15            ld   d,21
 729+ 8BD2 1E 15            ld   e,21
 730+ 8BD4 3E D6            ld   a,TILE_FIELD
 731+ 8BD6 CD 6F 88         call VDP_PrintRamChar
 732+ 8BD9 16 14            ld   d,20
 733+ 8BDB 1E 15            ld   e,21
 734+ 8BDD 3E D6            ld   a,TILE_FIELD
 735+ 8BDF CD 6F 88         call VDP_PrintRamChar
 736+ 8BE2
 737+ 8BE2                  ; angoli e montanti
 738+ 8BE2 16 13            ld   d,19
 739+ 8BE4 1E 00            ld   e,0
 740+ 8BE6 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 741+ 8BE8 CD 6F 88         call VDP_PrintRamChar
 742+ 8BEB 16 13            ld   d,19
 743+ 8BED 1E 15            ld   e,21
 744+ 8BEF 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 745+ 8BF1 CD 6F 88         call VDP_PrintRamChar
 746+ 8BF4 16 17            ld   d,23
 747+ 8BF6 1E 04            ld   e,4
 748+ 8BF8 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 749+ 8BFA CD 6F 88         call VDP_PrintRamChar
 750+ 8BFD 16 17            ld   d,23
 751+ 8BFF 1E 11            ld   e,17
 752+ 8C01 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 753+ 8C03 CD 6F 88         call VDP_PrintRamChar
 754+ 8C06 16 13            ld   d,19
 755+ 8C08 1E 04            ld   e,4
 756+ 8C0A 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 757+ 8C0C CD 6F 88         call VDP_PrintRamChar
 758+ 8C0F 16 13            ld   d,19
 759+ 8C11 1E 11            ld   e,17
 760+ 8C13 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 761+ 8C15 CD 6F 88         call VDP_PrintRamChar
 762+ 8C18
 763+ 8C18                  ; montanti verticali
 764+ 8C18 16 14            ld   d,20
 765+ 8C1A 1E 11            ld   e,17
 766+ 8C1C 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 767+ 8C1E 0E 01            ld   c,1
 768+ 8C20 CD 6F 88         call VDP_PrintRamChar
 769+ 8C23 16 15            ld   d,21
 770+ 8C25 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 771+ 8C27 0E 01            ld   c,1
 772+ 8C29 CD 6F 88         call VDP_PrintRamChar
 773+ 8C2C 16 16            ld   d,22
 774+ 8C2E 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 775+ 8C30 0E 01            ld   c,1
 776+ 8C32 CD 6F 88         call VDP_PrintRamChar
 777+ 8C35 16 14            ld   d,20
 778+ 8C37 1E 04            ld   e,4
 779+ 8C39 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 780+ 8C3B 0E 01            ld   c,1
 781+ 8C3D CD 6F 88         call VDP_PrintRamChar
 782+ 8C40 16 15            ld   d,21
 783+ 8C42 1E 04            ld   e,4
 784+ 8C44 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 785+ 8C46 0E 01            ld   c,1
 786+ 8C48 CD 6F 88         call VDP_PrintRamChar
 787+ 8C4B 16 16            ld   d,22
 788+ 8C4D 1E 04            ld   e,4
 789+ 8C4F 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 790+ 8C51 0E 01            ld   c,1
 791+ 8C53 CD 6F 88         call VDP_PrintRamChar
 792+ 8C56
 793+ 8C56                  ; segmenti orizzontali
 794+ 8C56 16 13            ld   d,19
 795+ 8C58 1E 01            ld   e,1
 796+ 8C5A 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 797+ 8C5C CD 6F 88         call VDP_PrintRamChar
 798+ 8C5F 1E 02            ld   e,2
 799+ 8C61 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 800+ 8C63 CD 6F 88         call VDP_PrintRamChar
 801+ 8C66 1E 03            ld   e,3
 802+ 8C68 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 803+ 8C6A CD 6F 88         call VDP_PrintRamChar
 804+ 8C6D 1E 12            ld   e,18
 805+ 8C6F 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 806+ 8C71 CD 6F 88         call VDP_PrintRamChar
 807+ 8C74 1E 13            ld   e,19
 808+ 8C76 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 809+ 8C78 CD 6F 88         call VDP_PrintRamChar
 810+ 8C7B 1E 14            ld   e,20
 811+ 8C7D 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 812+ 8C7F CD 6F 88         call VDP_PrintRamChar
 813+ 8C82 16 17            ld   d,23
 814+ 8C84 1E 05            ld   e,5
 815+ 8C86 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 816+ 8C88 CD 6F 88         call VDP_PrintRamChar
 817+ 8C8B 1E 06            ld   e,6
 818+ 8C8D 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 819+ 8C8F CD 6F 88         call VDP_PrintRamChar
 820+ 8C92 1E 07            ld   e,7
 821+ 8C94 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 822+ 8C96 CD 6F 88         call VDP_PrintRamChar
 823+ 8C99 1E 08            ld   e,8
 824+ 8C9B 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 825+ 8C9D CD 6F 88         call VDP_PrintRamChar
 826+ 8CA0 1E 09            ld   e,9
 827+ 8CA2 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 828+ 8CA4 CD 6F 88         call VDP_PrintRamChar
 829+ 8CA7 1E 0A            ld   e,10
 830+ 8CA9 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 831+ 8CAB CD 6F 88         call VDP_PrintRamChar
 832+ 8CAE 1E 0B            ld   e,11
 833+ 8CB0 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 834+ 8CB2 CD 6F 88         call VDP_PrintRamChar
 835+ 8CB5 1E 0C            ld   e,12
 836+ 8CB7 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 837+ 8CB9 CD 6F 88         call VDP_PrintRamChar
 838+ 8CBC 1E 0D            ld   e,13
 839+ 8CBE 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 840+ 8CC0 CD 6F 88         call VDP_PrintRamChar
 841+ 8CC3 1E 0E            ld   e,14
 842+ 8CC5 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 843+ 8CC7 CD 6F 88         call VDP_PrintRamChar
 844+ 8CCA 1E 0F            ld   e,15
 845+ 8CCC 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 846+ 8CCE CD 6F 88         call VDP_PrintRamChar
 847+ 8CD1 1E 10            ld   e,16
 848+ 8CD3 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 849+ 8CD5 CD 6F 88         call VDP_PrintRamChar
 850+ 8CD8
 851+ 8CD8                  ; croci
 852+ 8CD8 16 07            ld   d,7
 853+ 8CDA 1E 00            ld   e,0
 854+ 8CDC 3E D7            ld   a,TILE_FIELD_LINE_LEFT_CROSS
 855+ 8CDE CD 6F 88         call VDP_PrintRamChar
 856+ 8CE1 1E 15            ld   e,21
 857+ 8CE3 3E D8            ld   a,TILE_FIELD_LINE_RIGHT_CROSS
 858+ 8CE5 CD 6F 88         call VDP_PrintRamChar
 859+ 8CE8
 860+ 8CE8                  ; metà campo (riga 6): da col 1 a 20
 861+ 8CE8 3E 01            ld   a,1
 862+ 8CEA              .SouthLoop:
 863+ 8CEA 16 07            ld   d,7
 864+ 8CEC F5               push af
 865+ 8CED 5F               ld   e,a
 866+ 8CEE 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 867+ 8CF0 0E 01            ld   c,1
 868+ 8CF2 CD 6F 88         call VDP_PrintRamChar
 869+ 8CF5 F1               pop  af
 870+ 8CF6 3C               inc  a
 871+ 8CF7 FE 15            cp   21
 872+ 8CF9 20 EF            jr   nz,.SouthLoop
 873+ 8CFB C3 5B 8E         jp   .Done
 874+ 8CFE              .North:
 875+ 8CFE 16 00            ld   d,0
 876+ 8D00 1E 00            ld   e,0
 877+ 8D02 3E D6            ld   a,TILE_FIELD
 878+ 8D04 CD 6F 88         call VDP_PrintRamChar
 879+ 8D07 16 01            ld   d,1
 880+ 8D09 1E 00            ld   e,0
 881+ 8D0B 3E D6            ld   a,TILE_FIELD
 882+ 8D0D CD 6F 88         call VDP_PrintRamChar
 883+ 8D10 16 02            ld   d,2
 884+ 8D12 1E 00            ld   e,0
 885+ 8D14 3E D6            ld   a,TILE_FIELD
 886+ 8D16 CD 6F 88         call VDP_PrintRamChar
 887+ 8D19 16 03            ld   d,3
 888+ 8D1B 1E 00            ld   e,0
 889+ 8D1D 3E D6            ld   a,TILE_FIELD
 890+ 8D1F CD 6F 88         call VDP_PrintRamChar
 891+ 8D22 16 00            ld   d,0
 892+ 8D24 1E 15            ld   e,21
 893+ 8D26 3E D6            ld   a,TILE_FIELD
 894+ 8D28 CD 6F 88         call VDP_PrintRamChar
 895+ 8D2B 16 01            ld   d,1
 896+ 8D2D 1E 15            ld   e,21
 897+ 8D2F 3E D6            ld   a,TILE_FIELD
 898+ 8D31 CD 6F 88         call VDP_PrintRamChar
 899+ 8D34 16 02            ld   d,2
 900+ 8D36 1E 15            ld   e,21
 901+ 8D38 3E D6            ld   a,TILE_FIELD
 902+ 8D3A CD 6F 88         call VDP_PrintRamChar
 903+ 8D3D 16 03            ld   d,3
 904+ 8D3F 1E 15            ld   e,21
 905+ 8D41 3E D6            ld   a,TILE_FIELD
 906+ 8D43 CD 6F 88         call VDP_PrintRamChar
 907+ 8D46
 908+ 8D46                  ; angoli e montanti
 909+ 8D46 16 04            ld   d,4
 910+ 8D48 1E 00            ld   e,0
 911+ 8D4A 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 912+ 8D4C CD 6F 88         call VDP_PrintRamChar
 913+ 8D4F 16 04            ld   d,4
 914+ 8D51 1E 15            ld   e,21
 915+ 8D53 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 916+ 8D55 CD 6F 88         call VDP_PrintRamChar
 917+ 8D58 16 00            ld   d,0
 918+ 8D5A 1E 04            ld   e,4
 919+ 8D5C 3E D0            ld   a,TILE_FIELD_LINE_TOP_LEFT
 920+ 8D5E CD 6F 88         call VDP_PrintRamChar
 921+ 8D61 16 00            ld   d,0
 922+ 8D63 1E 11            ld   e,17
 923+ 8D65 3E D3            ld   a,TILE_FIELD_LINE_TOP_RIGHT
 924+ 8D67 CD 6F 88         call VDP_PrintRamChar
 925+ 8D6A 16 04            ld   d,4
 926+ 8D6C 1E 04            ld   e,4
 927+ 8D6E 3E D5            ld   a,TILE_FIELD_LINE_BOTTOM_RIGHT
 928+ 8D70 CD 6F 88         call VDP_PrintRamChar
 929+ 8D73 16 04            ld   d,4
 930+ 8D75 1E 11            ld   e,17
 931+ 8D77 3E D4            ld   a,TILE_FIELD_LINE_BOTTOM_LEFT
 932+ 8D79 CD 6F 88         call VDP_PrintRamChar
 933+ 8D7C
 934+ 8D7C                  ; montanti verticali
 935+ 8D7C 16 01            ld   d,1
 936+ 8D7E 1E 11            ld   e,17
 937+ 8D80 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 938+ 8D82 CD 6F 88         call VDP_PrintRamChar
 939+ 8D85 16 02            ld   d,2
 940+ 8D87 1E 11            ld   e,17
 941+ 8D89 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 942+ 8D8B CD 6F 88         call VDP_PrintRamChar
 943+ 8D8E 16 03            ld   d,3
 944+ 8D90 1E 11            ld   e,17
 945+ 8D92 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 946+ 8D94 CD 6F 88         call VDP_PrintRamChar
 947+ 8D97 16 01            ld   d,1
 948+ 8D99 1E 04            ld   e,4
 949+ 8D9B 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 950+ 8D9D CD 6F 88         call VDP_PrintRamChar
 951+ 8DA0 16 02            ld   d,2
 952+ 8DA2 1E 04            ld   e,4
 953+ 8DA4 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 954+ 8DA6 CD 6F 88         call VDP_PrintRamChar
 955+ 8DA9 16 03            ld   d,3
 956+ 8DAB 1E 04            ld   e,4
 957+ 8DAD 3E D1            ld   a,TILE_FIELD_LINE_VERTICAL
 958+ 8DAF CD 6F 88         call VDP_PrintRamChar
 959+ 8DB2
 960+ 8DB2                  ; segmenti orizzontali
 961+ 8DB2 16 04            ld   d,4
 962+ 8DB4 1E 01            ld   e,1
 963+ 8DB6 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 964+ 8DB8 CD 6F 88         call VDP_PrintRamChar
 965+ 8DBB 1E 02            ld   e,2
 966+ 8DBD 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 967+ 8DBF CD 6F 88         call VDP_PrintRamChar
 968+ 8DC2 1E 03            ld   e,3
 969+ 8DC4 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 970+ 8DC6 CD 6F 88         call VDP_PrintRamChar
 971+ 8DC9 1E 12            ld   e,18
 972+ 8DCB 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 973+ 8DCD CD 6F 88         call VDP_PrintRamChar
 974+ 8DD0 1E 13            ld   e,19
 975+ 8DD2 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 976+ 8DD4 CD 6F 88         call VDP_PrintRamChar
 977+ 8DD7 1E 14            ld   e,20
 978+ 8DD9 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 979+ 8DDB CD 6F 88         call VDP_PrintRamChar
 980+ 8DDE 16 00            ld   d,0
 981+ 8DE0 1E 05            ld   e,5
 982+ 8DE2 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 983+ 8DE4 CD 6F 88         call VDP_PrintRamChar
 984+ 8DE7 16 00            ld   d,0
 985+ 8DE9 1E 06            ld   e,6
 986+ 8DEB 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 987+ 8DED CD 6F 88         call VDP_PrintRamChar
 988+ 8DF0 16 00            ld   d,0
 989+ 8DF2 1E 07            ld   e,7
 990+ 8DF4 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 991+ 8DF6 CD 6F 88         call VDP_PrintRamChar
 992+ 8DF9 1E 08            ld   e,8
 993+ 8DFB 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 994+ 8DFD CD 6F 88         call VDP_PrintRamChar
 995+ 8E00 1E 09            ld   e,9
 996+ 8E02 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
 997+ 8E04 CD 6F 88         call VDP_PrintRamChar
 998+ 8E07 1E 0A            ld   e,10
 999+ 8E09 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1000+ 8E0B CD 6F 88         call VDP_PrintRamChar
1001+ 8E0E 1E 0B            ld   e,11
1002+ 8E10 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1003+ 8E12 CD 6F 88         call VDP_PrintRamChar
1004+ 8E15 1E 0C            ld   e,12
1005+ 8E17 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1006+ 8E19 CD 6F 88         call VDP_PrintRamChar
1007+ 8E1C 1E 0D            ld   e,13
1008+ 8E1E 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1009+ 8E20 CD 6F 88         call VDP_PrintRamChar
1010+ 8E23 1E 0E            ld   e,14
1011+ 8E25 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1012+ 8E27 CD 6F 88         call VDP_PrintRamChar
1013+ 8E2A 1E 0F            ld   e,15
1014+ 8E2C 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1015+ 8E2E CD 6F 88         call VDP_PrintRamChar
1016+ 8E31 1E 10            ld   e,16
1017+ 8E33 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1018+ 8E35 CD 6F 88         call VDP_PrintRamChar
1019+ 8E38                  ; croci
1020+ 8E38 16 11            ld   d,17
1021+ 8E3A 1E 00            ld   e,0
1022+ 8E3C 3E D7            ld   a,TILE_FIELD_LINE_LEFT_CROSS
1023+ 8E3E CD 6F 88         call VDP_PrintRamChar
1024+ 8E41 1E 15            ld   e,21
1025+ 8E43 3E D8            ld   a,TILE_FIELD_LINE_RIGHT_CROSS
1026+ 8E45 CD 6F 88         call VDP_PrintRamChar
1027+ 8E48
1028+ 8E48                  ; metà campo (riga 17): da col 1 a 20
1029+ 8E48 3E 01            ld   a,1
1030+ 8E4A              .NorthLoop:
1031+ 8E4A 16 11            ld   d,17
1032+ 8E4C F5               push af
1033+ 8E4D 5F               ld   e,a
1034+ 8E4E 3E D2            ld   a,TILE_FIELD_LINE_HORIZONTAL
1035+ 8E50 0E 01            ld   c,1
1036+ 8E52 CD 6F 88         call VDP_PrintRamChar
1037+ 8E55 F1               pop  af
1038+ 8E56 3C               inc  a
1039+ 8E57 FE 15            cp   21
1040+ 8E59 20 EF            jr   nz, .NorthLoop
1041+ 8E5B              .Done:
1042+ 8E5B                  ;POP  AF
1043+ 8E5B                  ;OR   01000000b      ; forza display ON (bit 6 = 1) indipendentemente dal valore letto
1044+ 8E5B                  ;LD   C, 1
1045+ 8E5B                  ;CALL VDP_SetReg
1046+ 8E5B                  ;POP  BC
1047+ 8E5B                  ;POP  AF
1048+ 8E5B C9               RET
1049+ 8E5C
1050+ 8E5C              ; ---------------------------------------------------------
1051+ 8E5C              ; Rimuove il giocatore virtuale dallo schermo (se visibile)
1052+ 8E5C              ; ---------------------------------------------------------
1053+ 8E5C              VDP_RemoveVirtualPlayer:
1054+ 8E5C 3A E4 B1         LD      A,(Var_Game_VirtualPlayerYPos)
1055+ 8E5F FE FF            CP      255
1056+ 8E61 C8               RET     Z
1057+ 8E62 57               LD      D, A
1058+ 8E63 3A E5 B1         LD      A,(Var_Game_VirtualPlayerXPos)
1059+ 8E66 5F               LD      E, A
1060+ 8E67 3E D6            LD      A, TILE_FIELD
1061+ 8E69 CD 05 89         CALL    VDP_DrawSprite
1062+ 8E6C 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
1063+ 8E6F FE 00            CP      FIELD_SOUTH_SIDE
1064+ 8E71 20 25            JR      NZ, .Done
1065+ 8E73 3A E5 B1         LD      A, (Var_Game_VirtualPlayerXPos)
1066+ 8E76 FE 04            CP      4
1067+ 8E78 20 1E            JR      NZ, .Done
1068+ 8E7A 16 07            LD      D, 7
1069+ 8E7C 1E 11            LD      E, 17
1070+ 8E7E 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1071+ 8E80 CD 6F 88         CALL    VDP_PrintRamChar
1072+ 8E83 1E 12            LD      E, 18
1073+ 8E85 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1074+ 8E87 CD 6F 88         CALL    VDP_PrintRamChar
1075+ 8E8A 1E 13            LD      E, 19
1076+ 8E8C 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1077+ 8E8E CD 6F 88         CALL    VDP_PrintRamChar
1078+ 8E91 1E 14            LD      E, 20
1079+ 8E93 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
1080+ 8E95 CD 6F 88         CALL    VDP_PrintRamChar
1081+ 8E98              .Done:
1082+ 8E98 3E FF            LD  A, 255
1083+ 8E9A 32 E4 B1         LD  (Var_Game_VirtualPlayerYPos), A
1084+ 8E9D C9               RET
1085+ 8E9E              ; ---------------------------------------------------------
1086+ 8E9E              ; Disegno del giocatore virtuale (se visibile)
1087+ 8E9E              ; ---------------------------------------------------------
1088+ 8E9E              VDP_PlayerMatrixRedraw_DrawVirtual:
1089+ 8E9E                  ; se Y = 255 → non disegnare
1090+ 8E9E 3A E4 B1         ld   a,(Var_Game_VirtualPlayerYPos)
1091+ 8EA1 FE FF            cp   255
1092+ 8EA3 28 1F            jr   z,VDP_PlayerMatrixRedraw_Done   ; salta se invisibile
1093+ 8EA5
1094+ 8EA5                  ; D = Y, E = X (coordinate di matrice 0..4)
1095+ 8EA5 57               ld   d,a                             ; D = Y
1096+ 8EA6 3A E5 B1         ld   a,(Var_Game_VirtualPlayerXPos)
1097+ 8EA9 5F               ld   e,a                             ; E = X
1098+ 8EAA
1099+ 8EAA                  ; salviamo i registri che useremo
1100+ 8EAA F5               push af
1101+ 8EAB C5               push bc
1102+ 8EAC D5               push de
1103+ 8EAD E5               push hl
1104+ 8EAE
1105+ 8EAE                  ; scegli il tile in base alla squadra virtuale
1106+ 8EAE 3A E6 B1         ld   a,(Var_Game_VirtualPlayerTeam)
1107+ 8EB1 FE 00            cp   TEAM_BLACK
1108+ 8EB3 20 04            jr   nz,.VirtWhite
1109+ 8EB5
1110+ 8EB5                  ; squadra nera → usa giocatore nero
1111+ 8EB5 3E B0            ld   a,TILE_BLACK_PLAYER
1112+ 8EB7 18 02            jr   .VirtHaveTile
1113+ 8EB9
1114+ 8EB9              .VirtWhite:
1115+ 8EB9                  ; squadra bianca → usa giocatore bianco
1116+ 8EB9 3E A0            ld   a,TILE_WHITE_PLAYER
1117+ 8EBB
1118+ 8EBB              .VirtHaveTile:
1119+ 8EBB                  ; mappa (D,E) -> coordinate schermo in (D,E)
1120+ 8EBB F5               PUSH  AF
1121+ 8EBC F1               POP   AF
1122+ 8EBD                  ; A = tile di base, D,E = row/col → disegna lo sprite
1123+ 8EBD CD 05 89         call VDP_DrawSprite
1124+ 8EC0
1125+ 8EC0                  ; ripristina registri
1126+ 8EC0 E1               pop  hl
1127+ 8EC1 D1               pop  de
1128+ 8EC2 C1               pop  bc
1129+ 8EC3 F1               pop  af
1130+ 8EC4
1131+ 8EC4              VDP_PlayerMatrixRedraw_Done:
1132+ 8EC4                  ; qui metti i tuoi:
1133+ 8EC4                  ; POP HL
1134+ 8EC4                  ; POP DE
1135+ 8EC4                  ; POP BC
1136+ 8EC4                  ; POP AF
1137+ 8EC4 C9                RET
1138+ 8EC5
1139+ 8EC5              ;----------------------------------------------------------------------------
1140+ 8EC5              ;  Sets VDP register
1141+ 8EC5              ;----------------------------------------------------------------------------
1142+ 8EC5              VDP_SetReg:
1143+ 8EC5                  ; In: A = value, C = reg#
1144+ 8EC5                  ; Usa la porta VDP control: 99h
1145+ 8EC5
1146+ 8EC5 F5               push af
1147+ 8EC6 DB 99            in   a,(099h)        ; reset latch (riallinea first/second write)
1148+ 8EC8 F1               pop  af
1149+ 8EC9
1150+ 8EC9 D3 99            out  (099h),a        ; value
1151+ 8ECB 79               ld   a,c
1152+ 8ECC F6 80            or   080h
1153+ 8ECE D3 99            out  (099h),a        ; select register write
1154+ 8ED0 C9               ret
1155+ 8ED1
1156+ 8ED1              ; ---------------------------------------------------------------------------
1157+ 8ED1              ; Redraws all players on screen using Var_Game_PlayersInfo, tramite
1158+ 8ED1              ; GetPlayerInfoById.
1159+ 8ED1              ;
1160+ 8ED1              ; Per ogni giocatore:
1161+ 8ED1              ;   - prende PREV_X/PREV_Y e CUR_X/CUR_Y da GetPlayerInfoById;
1162+ 8ED1              ;   - se PREV_Y != 255 disegna TILE_FIELD alla vecchia posizione;
1163+ 8ED1              ;   - se CUR_Y  != 255 disegna la tile corretta alla posizione attuale:
1164+ 8ED1              ;       * ID = 0 (portiere):
1165+ 8ED1              ;           - se Var_Game_GoalkeeperHasBall = YES:
1166+ 8ED1              ;               TEAM_BLACK -> TILE_BLACK_GOALKEEPER_WITH_BALL
1167+ 8ED1              ;               TEAM_WHITE -> TILE_WHITE_GOALKEEPER_WITH_BALL
1168+ 8ED1              ;           - altrimenti:
1169+ 8ED1              ;               TEAM_BLACK -> TILE_BLACK_GOALKEEPER
1170+ 8ED1              ;               TEAM_WHITE -> TILE_WHITE_GOALKEEPER
1171+ 8ED1              ;       * ID != 0:
1172+ 8ED1              ;               TEAM_BLACK -> TILE_BLACK_PLAYER
1173+ 8ED1              ;               TEAM_WHITE -> TILE_WHITE_PLAYER
1174+ 8ED1              ;
1175+ 8ED1              ; INPUT:  -
1176+ 8ED1              ; OUTPUT: giocatori ridisegnati
1177+ 8ED1              ; PRESERVA: AF, BC, DE, HL
1178+ 8ED1              ; ---------------------------------------------------------------------------
1179+ 8ED1              VDP_PlayerMatrixRedraw:
1180+ 8ED1 F5               PUSH AF
1181+ 8ED2 C5               PUSH BC
1182+ 8ED3 D5               PUSH DE
1183+ 8ED4 E5               PUSH HL
1184+ 8ED5
1185+ 8ED5 3A F0 B1         ld  a,(Var_Game_BallYOldPosition)
1186+ 8ED8 FE FF            cp  NO_VALUE
1187+ 8EDA 28 0A            jr  z,.no_old_ball
1188+ 8EDC
1189+ 8EDC 57               ld  d,a                          ; Y old
1190+ 8EDD 3A F1 B1         ld  a,(Var_Game_BallXOldPosition)
1191+ 8EE0 5F               ld  e,a                          ; X old
1192+ 8EE1 3E D6            ld  a,TILE_FIELD
1193+ 8EE3 CD 05 89         call VDP_DrawSprite
1194+ 8EE6
1195+ 8EE6
1196+ 8EE6
1197+ 8EE6
1198+ 8EE6              .no_old_ball:
1199+ 8EE6
1200+ 8EE6                  ; ---- disegna prima TEAM_BLACK, poi TEAM_WHITE ----
1201+ 8EE6 06 00            LD   B,TEAM_BLACK
1202+ 8EE8 CD EC 8F         CALL VPMR_DrawTeam
1203+ 8EEB
1204+ 8EEB 06 01            LD   B,TEAM_WHITE
1205+ 8EED CD EC 8F         CALL VPMR_DrawTeam
1206+ 8EF0 CD 9E 8E         CALL VDP_PlayerMatrixRedraw_DrawVirtual
1207+ 8EF3 CD FE 8E         CALL VDP_DrawBallOnMatrix
1208+ 8EF6 CD 6C 96         CALL Game_ClearSinglePlayerPrevPositions
1209+ 8EF9 E1               POP  HL
1210+ 8EFA D1               POP  DE
1211+ 8EFB C1               POP  BC
1212+ 8EFC F1               POP  AF
1213+ 8EFD C9               RET
1214+ 8EFE
1215+ 8EFE              ;---------------------------------------------------------------
1216+ 8EFE              ; Disegna la palla sulla matrice (o portiere/giocatore con palla)
1217+ 8EFE              ; Usa:
1218+ 8EFE              ;   Var_Game_BallXPosition / Var_Game_BallYPosition
1219+ 8EFE              ;   Var_Game_BallDirection, Var_Game_BallDiagonalMovCounter
1220+ 8EFE              ;   Var_Game_ActiveFieldSide
1221+ 8EFE              ;---------------------------------------------------------------
1222+ 8EFE              VDP_DrawBallOnMatrix:
1223+ 8EFE F5               push af
1224+ 8EFF C5               push bc
1225+ 8F00 D5               push de
1226+ 8F01 E5               push hl
1227+ 8F02
1228+ 8F02                  ; di default nessun portiere con palla
1229+ 8F02 3E 00            ld   a,NO
1230+ 8F04 32 E1 B1         ld   (Var_Game_GoalkeeperHasBall),a
1231+ 8F07
1232+ 8F07                  ; HL = X,Y della palla
1233+ 8F07 CD 4D 95         call Game_GetBallPosition
1234+ 8F0A
1235+ 8F0A                  ; cerca eventuale giocatore in D/E
1236+ 8F0A CD 2F 96         call Game_GetPlayerInfoByPos
1237+ 8F0D FE FF            cp   NO_VALUE
1238+ 8F0F CA 8A 8F         jp   z,.no_player      ; casella vuota → gestisce solo la palla
1239+ 8F12
1240+ 8F12                  ;-----------------------------------------------------------
1241+ 8F12                  ; QUI C’E’ UN GIOCATORE
1242+ 8F12                  ;  B = TEAM   (0 nero, 1 bianco)
1243+ 8F12                  ;  C = ID     (0 portiere)
1244+ 8F12                  ;  A = ROLE
1245+ 8F12                  ;  HL = pos corrente, DE = pos precedente
1246+ 8F12                  ;-----------------------------------------------------------
1247+ 8F12
1248+ 8F12 79               ld   a,c
1249+ 8F13 B7               or   a
1250+ 8F14 20 1A            jr   nz,.field_player      ; ID!=0 → giocatore di movimento
1251+ 8F16
1252+ 8F16                  ;--------- PORTIERE ----------------------------------------
1253+ 8F16 3E 01            ld   a,YES
1254+ 8F18 32 E1 B1         ld   (Var_Game_GoalkeeperHasBall),a
1255+ 8F1B
1256+ 8F1B 78               ld   a,b
1257+ 8F1C FE 00            cp   TEAM_BLACK
1258+ 8F1E 20 08            jr   nz,.white_gk
1259+ 8F20 CD 14 9E         call Game_StopShot
1260+ 8F23 3E 90            ld   a,TILE_BLACK_GOALKEEPER_WITH_BALL
1261+ 8F25 C3 B4 8F         jp   .draw_sprite_with_ball_pos
1262+ 8F28
1263+ 8F28              .white_gk:
1264+ 8F28 CD 14 9E         call Game_StopShot
1265+ 8F2B 3E 70            ld   a,TILE_WHITE_GOALKEEPER_WITH_BALL
1266+ 8F2D C3 B4 8F         jp   .draw_sprite_with_ball_pos
1267+ 8F30
1268+ 8F30
1269+ 8F30              ;--------- GIOCATORE DI MOVIMENTO -------------------------------
1270+ 8F30              .field_player:
1271+ 8F30                  ; logica in base a Var_Game_BallDirection
1272+ 8F30 3A E2 B1         ld   a,(Var_Game_BallDirection)
1273+ 8F33 FE 00            cp   BALL_DIRECTION_NONE
1274+ 8F35 28 1A            jr   z,.bp_none
1275+ 8F37 FE 01            cp   BALL_DIRECTION_NORTH
1276+ 8F39 28 1F            jr   z,.bp_north
1277+ 8F3B FE 02            cp   BALL_DIRECTION_NORTH_EAST
1278+ 8F3D 28 2D            jr   z,.bp_ne_nw
1279+ 8F3F FE 03            cp   BALL_DIRECTION_NORTH_WEST
1280+ 8F41 28 29            jr   z,.bp_ne_nw
1281+ 8F43 FE 04            cp   BALL_DIRECTION_SOUTH
1282+ 8F45 28 30            jr   z,.bp_south
1283+ 8F47 FE 05            cp   BALL_DIRECTION_SOUTH_EAST
1284+ 8F49 28 30            jr   z,.bp_se_sw
1285+ 8F4B FE 06            cp   BALL_DIRECTION_SOUTH_WEST
1286+ 8F4D 28 2C            jr   z,.bp_se_sw
1287+ 8F4F                  ; default → trattiamo come palla ferma
1288+ 8F4F 18 00            jr   .bp_none
1289+ 8F51
1290+ 8F51              ; palla statica sul giocatore → semplicemente “contatto”,
1291+ 8F51              ; giocatore nero con palla e direzione azzerata (adatta se vuoi
1292+ 8F51              ; gestire anche il bianco come nel tuo codice originale)
1293+ 8F51              .bp_none:
1294+ 8F51 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1295+ 8F53 4F               ld   c,a
1296+ 8F54 CD 14 9E         call Game_StopShot
1297+ 8F57 79               ld   a,c
1298+ 8F58 18 5A            jr   .draw_sprite_with_ball_pos
1299+ 8F5A
1300+ 8F5A              ; palla che arriva da N → se nero: tiene la palla e si ferma,
1301+ 8F5A              ; se bianco: solo disegno del bianco con palla (come da specifiche).
1302+ 8F5A              .bp_north:
1303+ 8F5A 78               ld   a,b
1304+ 8F5B FE 00            cp   TEAM_BLACK
1305+ 8F5D 20 09            jr   nz,.bp_north_white
1306+ 8F5F 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1307+ 8F61 4F               ld   c,a
1308+ 8F62 CD 14 9E         call Game_StopShot
1309+ 8F65 79               ld   a,c
1310+ 8F66 18 4C            jr   .draw_sprite_with_ball_pos
1311+ 8F68
1312+ 8F68              .bp_north_white:
1313+ 8F68 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1314+ 8F6A 18 48            jr   .draw_sprite_with_ball_pos
1315+ 8F6C
1316+ 8F6C              ; diagonale NORD (NE/NW) con contatore=1 → palla dietro al giocatore
1317+ 8F6C              .bp_ne_nw:
1318+ 8F6C 3A E3 B1         ld   a,(Var_Game_BallDiagonalMovCounter)
1319+ 8F6F FE 00            cp   0
1320+ 8F71 20 74            jr   nz,.exit            ; niente di speciale
1321+ 8F73 3E 02            ld   a,TILE_BLACK_PLAYER_WITH_BACK_BALL
1322+ 8F75 18 3D            jr   .draw_sprite_with_ball_pos
1323+ 8F77
1324+ 8F77              ; palla da S → nero la controlla e si ferma
1325+ 8F77              .bp_south:
1326+ 8F77 3E C0            ld   a,TILE_BLACK_PLAYER_WITH_BALL
1327+ 8F79                  ;ld   c,a
1328+ 8F79                  ;call Game_StopShot
1329+ 8F79                  ;ld   a,c
1330+ 8F79 18 39            jr   .draw_sprite_with_ball_pos
1331+ 8F7B
1332+ 8F7B              ; diagonale SUD (SE/SW)
1333+ 8F7B              .bp_se_sw:
1334+ 8F7B 3A E3 B1         ld   a,(Var_Game_BallDiagonalMovCounter)
1335+ 8F7E FE 00            cp   0
1336+ 8F80 28 04            jr   z,.bp_se_sw_counter1
1337+ 8F82
1338+ 8F82                  ; contatore !=1 → nero riceve palla davanti e si ferma
1339+ 8F82 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1340+ 8F84                  ;ld   c,a
1341+ 8F84                  ;call Game_StopShot
1342+ 8F84                  ;ld   a,c
1343+ 8F84 18 2E            jr   .draw_sprite_with_ball_pos
1344+ 8F86
1345+ 8F86              .bp_se_sw_counter1:
1346+ 8F86                  ; contatore=1 → bianco con palla
1347+ 8F86 3E 01            ld   a,TILE_WHITE_PLAYER_WITH_BALL
1348+ 8F88 18 2A            jr   .draw_sprite_with_ball_pos
1349+ 8F8A
1350+ 8F8A
1351+ 8F8A              ;================ CASO NESSUN GIOCATORE NELLA CASELLA ==============
1352+ 8F8A              .no_player:
1353+ 8F8A                  ; Qui dobbiamo decidere se BALL_BOTTOM o BALL_TOP.
1354+ 8F8A                  ; *** IMPORTANTE ***:
1355+ 8F8A                  ;  - teniamo la tile in C
1356+ 8F8A                  ;  - usiamo A solo per confronti
1357+ 8F8A 0E 40            ld   c,TILE_BALL_BOTTOM       ; default
1358+ 8F8C
1359+ 8F8C                  ; --- caso 1: diagonale NORD (NE/NW) con contatore = 1 → BALL_TOP
1360+ 8F8C 3A E2 B1         ld   a,(Var_Game_BallDirection)
1361+ 8F8F FE 02            cp   BALL_DIRECTION_NORTH_EAST
1362+ 8F91 28 04            jr   z,.np_diag_north
1363+ 8F93 FE 03            cp   BALL_DIRECTION_NORTH_WEST
1364+ 8F95 20 09            jr   nz,.np_after_diag
1365+ 8F97
1366+ 8F97              .np_diag_north:
1367+ 8F97 3A E3 B1         ld   a,(Var_Game_BallDiagonalMovCounter)
1368+ 8F9A FE 00            cp   0
1369+ 8F9C 20 02            jr   nz,.np_after_diag
1370+ 8F9E 0E 06            ld   c,TILE_BALL_TOP          ; override
1371+ 8FA0
1372+ 8FA0              .np_after_diag:
1373+ 8FA0 79               ld   a,c                       ; rimetti la tile scelta in A
1374+ 8FA1 18 00            jr   .chk_fieldside_top
1375+ 8FA3
1376+ 8FA3
1377+ 8FA3              ;----------------- TUO BLOCCO OTTIMIZZATO --------------------------
1378+ 8FA3              ; --- caso 2: FIELD_NORTH_SIDE e Y=0 -> BALL_TOP --------------
1379+ 8FA3              .chk_fieldside_top:
1380+ 8FA3 4F               ld   c,a                       ; salva la tile in C
1381+ 8FA4
1382+ 8FA4 3A C2 B1         ld   a,(Var_Game_ActiveFieldSide)
1383+ 8FA7 FE 01            cp   FIELD_NORTH_SIDE
1384+ 8FA9 20 08            jr   nz,.draw_sprite_prep
1385+ 8FAB
1386+ 8FAB 3A EF B1         ld   a,(Var_Game_BallYPosition)
1387+ 8FAE B7               or   a
1388+ 8FAF 20 02            jr   nz,.draw_sprite_prep
1389+ 8FB1 0E 03            ld   c,TILE_CORNER_BALL           ; Y=0 in direzione NORTH -> BALL_TOP
1390+ 8FB3
1391+ 8FB3              .draw_sprite_prep:
1392+ 8FB3 79               ld   a,c                       ; A = tile definitiva (TOP/BOTTOM/altro)
1393+ 8FB4
1394+ 8FB4
1395+ 8FB4              ; ====== DISEGNO DELLO SPRITE (palla o giocatore con palla) ========
1396+ 8FB4
1397+ 8FB4              ; Se arriviamo dai casi giocatore, ricarichiamo sempre le coordinate
1398+ 8FB4              ; della palla prima di disegnare.
1399+ 8FB4              .draw_sprite_with_ball_pos:
1400+ 8FB4 47               ld   b,a                       ; salva tile in B
1401+ 8FB5
1402+ 8FB5 CD 4D 95         call Game_GetBallPosition           ; HL = X,Y
1403+ 8FB8
1404+ 8FB8
1405+ 8FB8 78               ld   a,b                       ; ripristina tile
1406+ 8FB9                  ; cade in .draw_sprite
1407+ 8FB9
1408+ 8FB9              .draw_sprite:
1409+ 8FB9                  ; A = tile, D = Y, E = X (coord matrice)
1410+ 8FB9 FE 40            CP   TILE_BALL_BOTTOM
1411+ 8FBB C2 E2 8F         JP   NZ, .draw_sprite_continue
1412+ 8FBE 3A C2 B1         LD   A, (Var_Game_ActiveFieldSide)
1413+ 8FC1 FE 01            CP   FIELD_NORTH_SIDE
1414+ 8FC3 CA D3 8F         JP   Z, .darw_ball_north_field
1415+ 8FC6 3A EF B1         LD   A, (Var_Game_BallYPosition)
1416+ 8FC9 FE 04            CP   4
1417+ 8FCB CA E0 8F         JP   Z, .draw_ball_top
1418+ 8FCE 3E 40            LD   A, TILE_BALL_BOTTOM
1419+ 8FD0 C3 E2 8F         JP   .draw_sprite_continue
1420+ 8FD3              .darw_ball_north_field:
1421+ 8FD3 3A EF B1         LD   A, (Var_Game_BallYPosition)
1422+ 8FD6 FE 00            CP   0
1423+ 8FD8 CA E0 8F         JP   Z, .draw_ball_top
1424+ 8FDB 3E 40            LD   A, TILE_BALL_BOTTOM
1425+ 8FDD C3 E2 8F         JP   .draw_sprite_continue
1426+ 8FE0              .draw_ball_top:
1427+ 8FE0 3E 03            LD   A, TILE_CORNER_BALL
1428+ 8FE2              .draw_sprite_continue:
1429+ 8FE2 CD 05 89         call VDP_DrawSprite
1430+ 8FE5 18 00            jr   .exit
1431+ 8FE7
1432+ 8FE7
1433+ 8FE7              .exit:
1434+ 8FE7 E1               pop  hl
1435+ 8FE8 D1               pop  de
1436+ 8FE9 C1               pop  bc
1437+ 8FEA F1               pop  af
1438+ 8FEB C9               ret
1439+ 8FEC
1440+ 8FEC              ; ---------------------------------------------------------------------------
1441+ 8FEC              ; Disegna tutti i 4 giocatori di una squadra
1442+ 8FEC              ; INPUT:
1443+ 8FEC              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
1444+ 8FEC              ; MODIFICA:
1445+ 8FEC              ;   AF, BC, DE, HL
1446+ 8FEC              ; ---------------------------------------------------------------------------
1447+ 8FEC              VPMR_DrawTeam:
1448+ 8FEC 0E 00            LD   C,0                    ; ID = 0..3
1449+ 8FEE              VPMR_PlayerLoop:
1450+ 8FEE C5               PUSH BC                     ; salva TEAM/ID per dopo
1451+ 8FEF
1452+ 8FEF CD 14 96         CALL Game_GetPlayerInfoById
1453+ 8FF2                  ; dopo la call:
1454+ 8FF2                  ;   DE = prev (D=prevY, E=prevX)
1455+ 8FF2                  ;   HL = cur  (H=curY,  L=curX)
1456+ 8FF2                  ;   A  = ROLE
1457+ 8FF2                  ;   B  = TEAM
1458+ 8FF2                  ;   C  = ID
1459+ 8FF2
1460+ 8FF2                  ; ----- CLEAR PREVIOUS POSITION (se valida) --------------------
1461+ 8FF2 7A               LD   A,D                    ; prevY
1462+ 8FF3 FE FF            CP   255
1463+ 8FF5 CA 81 90         JP   Z,VPMR_SkipClear
1464+ 8FF8
1465+ 8FF8
1466+ 8FF8                  ; mappa coord logiche prev -> schermo
1467+ 8FF8 E5               PUSH HL                     ; salvo current
1468+ 8FF9 F5               PUSH AF                     ; non mi interessa il contenuto, ma proteggo A
1469+ 8FFA C5               PUSH BC
1470+ 8FFB 3E D6            LD   A,TILE_FIELD
1471+ 8FFD CD 05 89         CALL VDP_DrawSprite             ; D=row, E=col, A=tile
1472+ 9000 C1               POP  BC
1473+ 9001 C5               PUSH BC
1474+ 9002 78               LD   A, B
1475+ 9003 FE 01            CP   TEAM_WHITE
1476+ 9005 C2 7B 90         JP   NZ, VPMR_AfterCheckHalfLineToClear
1477+ 9008 3A C2 B1         LD   A, (Var_Game_ActiveFieldSide)
1478+ 900B FE 00            CP   FIELD_SOUTH_SIDE
1479+ 900D CA 43 90         JP   Z, VPMR_WhiteOnSouthHalfToRemove
1480+ 9010
1481+ 9010              VPMR_WhiteOnNorthHalfToRemove:
1482+ 9010 7A               LD   A, D
1483+ 9011 FE 11            CP   17
1484+ 9013 C2 7B 90         JP   NZ, VPMR_AfterCheckHalfLineToClear
1485+ 9016 D5               PUSH  DE
1486+ 9017 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1487+ 9019 CD 6F 88         CALL  VDP_PrintRamChar
1488+ 901C 1C               INC   E
1489+ 901D 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1490+ 901F CD 6F 88         CALL  VDP_PrintRamChar
1491+ 9022 1C               INC   E
1492+ 9023 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1493+ 9025 CD 6F 88         CALL  VDP_PrintRamChar
1494+ 9028 1C               INC   E
1495+ 9029 14               INC   D
1496+ 902A 3E D6            LD    A, TILE_FIELD
1497+ 902C CD 6F 88         CALL  VDP_PrintRamChar
1498+ 902F 1D               DEC   E
1499+ 9030 1D               DEC   E
1500+ 9031 1D               DEC   E
1501+ 9032
1502+ 9032 14               INC   D
1503+ 9033 14               INC   D
1504+ 9034 3E D6            LD    A, TILE_FIELD
1505+ 9036 CD 6F 88         CALL  VDP_PrintRamChar
1506+ 9039 1C               INC   E
1507+ 903A 3E D6            LD    A, TILE_FIELD
1508+ 903C CD 6F 88         CALL  VDP_PrintRamChar
1509+ 903F
1510+ 903F D1               POP   DE
1511+ 9040 C3 7B 90         JP    VPMR_AfterCheckHalfLineToClear
1512+ 9043              VPMR_WhiteOnSouthHalfToRemove:
1513+ 9043 7A               LD   A, D
1514+ 9044 FE 07            CP   7
1515+ 9046 C2 7B 90         JP   NZ, VPMR_AfterCheckHalfLineToClear
1516+ 9049 D5               PUSH  DE
1517+ 904A 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1518+ 904C CD 6F 88         CALL  VDP_PrintRamChar
1519+ 904F 1C               INC   E
1520+ 9050 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1521+ 9052 CD 6F 88         CALL  VDP_PrintRamChar
1522+ 9055 1C               INC   E
1523+ 9056 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1524+ 9058 CD 6F 88         CALL  VDP_PrintRamChar
1525+ 905B 1C               INC   E
1526+ 905C 3E D2            LD    A, TILE_FIELD_LINE_HORIZONTAL
1527+ 905E CD 6F 88         CALL  VDP_PrintRamChar
1528+ 9061 14               INC   D
1529+ 9062 3E D6            LD    A, TILE_FIELD
1530+ 9064 CD 6F 88         CALL  VDP_PrintRamChar
1531+ 9067 1D               DEC   E
1532+ 9068 1D               DEC   E
1533+ 9069 1D               DEC   E
1534+ 906A
1535+ 906A 14               INC   D
1536+ 906B 14               INC   D
1537+ 906C 3E D6            LD    A, TILE_FIELD
1538+ 906E CD 6F 88         CALL  VDP_PrintRamChar
1539+ 9071 1C               INC   E
1540+ 9072 3E D6            LD    A, TILE_FIELD
1541+ 9074 CD 6F 88         CALL  VDP_PrintRamChar
1542+ 9077
1543+ 9077 D1               POP   DE
1544+ 9078 C3 7B 90         JP    VPMR_AfterCheckHalfLineToClear
1545+ 907B
1546+ 907B              VPMR_AfterCheckHalfLineToClear:
1547+ 907B C1               POP  BC
1548+ 907C F1               POP  AF
1549+ 907D E1               POP  HL
1550+ 907E CD 6C 96         CALL Game_ClearSinglePlayerPrevPositions
1551+ 9081              VPMR_SkipClear:
1552+ 9081                  ; ----- DRAW CURRENT POSITION (se visibile) -------------------
1553+ 9081 7C               LD   A,H                    ; curY
1554+ 9082 FE FF            CP   255
1555+ 9084 CA E6 90         JP   Z,VPMR_AfterDraw       ; giocatore invisibile (es. portiere nascosto)
1556+ 9087
1557+ 9087                  ; D,E = coord logiche correnti
1558+ 9087 54               LD   D,H
1559+ 9088 5D               LD   E,L
1560+ 9089
1561+ 9089
1562+ 9089                  ; ora D,E = coord schermo
1563+ 9089
1564+ 9089                  ; ----- determina la tile in A -----------------------
1565+ 9089 79               LD   A,C                    ; A = ID
1566+ 908A B7               OR   A
1567+ 908B C2 B6 90         JP   NZ,VPMR_FieldPlayer    ; ID != 0 → giocatore di movimento
1568+ 908E
1569+ 908E                  ; ===== PORTIERE =====
1570+ 908E 3A E1 B1         LD   A,(Var_Game_GoalkeeperHasBall)
1571+ 9091 FE 01            CP   YES
1572+ 9093 C2 A6 90         JP   NZ,VPMR_GK_NoBall
1573+ 9096
1574+ 9096                  ; portiere CON palla
1575+ 9096 78               LD   A,B                    ; TEAM
1576+ 9097 FE 00            CP   TEAM_BLACK
1577+ 9099 C2 A1 90         JP   NZ,VPMR_WhiteGKWithBall
1578+ 909C 3E 90            LD   A,TILE_BLACK_GOALKEEPER_WITH_BALL
1579+ 909E C3 E3 90         JP   VPMR_DoDraw
1580+ 90A1
1581+ 90A1              VPMR_WhiteGKWithBall:
1582+ 90A1 3E 70            LD   A,TILE_WHITE_GOALKEEPER_WITH_BALL
1583+ 90A3 C3 E3 90         JP   VPMR_DoDraw
1584+ 90A6
1585+ 90A6              VPMR_GK_NoBall:
1586+ 90A6                  ; portiere SENZA palla
1587+ 90A6 78               LD   A,B
1588+ 90A7 FE 00            CP   TEAM_BLACK
1589+ 90A9 C2 B1 90         JP   NZ,VPMR_WhiteGKNoBall
1590+ 90AC 3E 80            LD   A,TILE_BLACK_GOALKEEPER
1591+ 90AE C3 E3 90         JP   VPMR_DoDraw
1592+ 90B1
1593+ 90B1              VPMR_WhiteGKNoBall:
1594+ 90B1 3E 60            LD   A,TILE_WHITE_GOALKEEPER
1595+ 90B3 C3 E3 90         JP   VPMR_DoDraw
1596+ 90B6
1597+ 90B6                  ; ===== GIOCATORE DI MOVIMENTO =====
1598+ 90B6              VPMR_FieldPlayer:
1599+ 90B6 78               LD   A,B
1600+ 90B7 FE 00            CP   TEAM_BLACK
1601+ 90B9 C2 C1 90         JP   NZ,VPMR_WhitePlayer
1602+ 90BC 3E B0            LD   A,TILE_BLACK_PLAYER
1603+ 90BE C3 E3 90         JP   VPMR_DoDraw
1604+ 90C1
1605+ 90C1              VPMR_WhitePlayer:
1606+ 90C1 E5               PUSH  HL
1607+ 90C2 D1               POP   DE
1608+ 90C3 3A C2 B1         LD   A, (Var_Game_ActiveFieldSide)
1609+ 90C6 FE 00            CP   FIELD_SOUTH_SIDE
1610+ 90C8 CA D6 90         JP   Z, VPMR_WhitPlayerSouth
1611+ 90CB 7C               LD   A, H
1612+ 90CC FE 04            CP   4
1613+ 90CE C2 E1 90         JP   NZ, VPMR_WhiteStandardPlayer
1614+ 90D1 3E 50            LD   A,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
1615+ 90D3 C3 E3 90         JP   VPMR_DoDraw
1616+ 90D6              VPMR_WhitPlayerSouth:
1617+ 90D6 7C               LD   A, H
1618+ 90D7 FE 01            CP   1
1619+ 90D9 C2 E1 90         JP   NZ, VPMR_WhiteStandardPlayer
1620+ 90DC 3E 50            LD   A,TILE_WHITE_PLAYER_NEAR_HALF_FIELD
1621+ 90DE C3 E3 90         JP   VPMR_DoDraw
1622+ 90E1              VPMR_WhiteStandardPlayer:
1623+ 90E1 3E A0            LD   A,TILE_WHITE_PLAYER
1624+ 90E3              VPMR_DoDraw:
1625+ 90E3 CD 05 89         CALL VDP_DrawSprite          ; usa D,E già mappate
1626+ 90E6
1627+ 90E6              VPMR_AfterDraw:
1628+ 90E6 C1               POP  BC                      ; ripristina TEAM/ID salvati a inizio ciclo
1629+ 90E7
1630+ 90E7 0C               INC  C
1631+ 90E8 79               LD   A,C
1632+ 90E9 FE 04            CP   4
1633+ 90EB C2 EE 8F         JP   NZ,VPMR_PlayerLoop
1634+ 90EE C9               RET
1635+ 90EF
1636+ 90EF
1637+ 90EF
1638+ 90EF
1639+ 90EF
1640+ 90EF
1641+ 90EF
1642+ 90EF
1643+ 90EF              ; ---------------------------------------------------------------------------
1644+ 90EF              ; Pulisce l'area laterale del menu (colonne 23)
1645+ 90EF              ; ---------------------------------------------------------------------------
1646+ 90EF              VDP_ClearMenuSideArea:
1647+ 90EF AF               XOR     A
1648+ 90F0              .Loop:
1649+ 90F0 F5               PUSH    AF
1650+ 90F1 57               LD      D, A
1651+ 90F2 1E 17            LD      E, 23
1652+ 90F4 21 E1 80         LD      HL, TXT_EMPTY
1653+ 90F7 CD 63 88         CALL    VDP_PrintString
1654+ 90FA
1655+ 90FA F1               POP     AF
1656+ 90FB 3C               INC     A
1657+ 90FC FE 15            CP      21
1658+ 90FE C8               RET     Z
1659+ 90FF C3 F0 90         JP      .Loop
1660+ 9102
1661+ 9102
1662+ 9102
1663+ 9102              VDP_ShowScores:
1664+ 9102 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
1665+ 9105 FE 01            CP      YES
1666+ 9107 C0               RET     NZ
1667+ 9108 16 00            LD      D, 0
1668+ 910A 1E 17            LD      E, 23
1669+ 910C 21 EA 80         LD      HL, TXT_TIME
1670+ 910F CD 63 88         CALL    VDP_PrintString
1671+ 9112
1672+ 9112 16 05            LD      D, 5
1673+ 9114 1E 17            LD      E, 23
1674+ 9116 21 EF 80         LD      HL, TXT_BLACK_TEAM
1675+ 9119 CD 63 88         CALL    VDP_PrintString
1676+ 911C
1677+ 911C 16 0A            LD      D, 10
1678+ 911E 1E 17            LD      E, 23
1679+ 9120 21 F8 80         LD      HL, TXT_WHITE_TEAM
1680+ 9123 CD 63 88         CALL    VDP_PrintString
1681+ 9126 D5               PUSH    DE
1682+ 9127 E5               PUSH    HL
1683+ 9128 3A DE B1         LD      A, (Var_Game_ScoreWhite)
1684+ 912B 26 00            LD      H, 0
1685+ 912D 6F               LD      L, A
1686+ 912E 11 B9 B1         LD      DE, Var_Utils_NumberToPrint
1687+ 9131 CD 07 81         CALL    String_NumberToASCII
1688+ 9134 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
1689+ 9137 CD 2C 81         CALL    String_RemoveLeadingZeros
1690+ 913A 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
1691+ 913D 16 0B            LD      D, 11
1692+ 913F 1E 1A            LD      E, 26
1693+ 9141 CD 63 88         CALL    VDP_PrintString
1694+ 9144
1695+ 9144 3A D1 B1         LD      A, (Var_Game_ScoreBlack)
1696+ 9147 26 00            LD      H, 0
1697+ 9149 6F               LD      L, A
1698+ 914A 11 B9 B1         LD      DE, Var_Utils_NumberToPrint
1699+ 914D CD 07 81         CALL    String_NumberToASCII
1700+ 9150 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
1701+ 9153 CD 2C 81         CALL    String_RemoveLeadingZeros
1702+ 9156 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
1703+ 9159 16 06            LD      D, 6
1704+ 915B 1E 1A            LD      E, 26
1705+ 915D CD 63 88         CALL    VDP_PrintString
1706+ 9160
1707+ 9160 E1               POP     HL
1708+ 9161 D1               POP     DE
1709+ 9162 C9               RET
1710+ 9163
1711+ 9163
# file closed: ./inc/vdp.asm
  16  9163                  INCLUDE "menu.asm"                      ; Include menu library
# file opened: ./inc/menu.asm
   1+ 9163              ; ===================================================================
   2+ 9163              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 9163              ; ===================================================================
   4+ 9163
   5+ 9163              ; *** MENU.ASM ***
   6+ 9163
   7+ 9163              ; ------ ROUTINES ------
   8+ 9163
   9+ 9163              ;------------------------------------------------------------------------
  10+ 9163              ; Show menu
  11+ 9163              ; INPUT: -
  12+ 9163              ; OUTPUT: -
  13+ 9163              ; MODIFY: A, DE, HL, BC
  14+ 9163              ;-------------------------------------------------------------------------
  15+ 9163              Menu_Show:
  16+ 9163 CD 50 81         CALL    Hooks_TickStart
  17+ 9166 CD 7D 86         CALL    Hooks_InitAICounters
  18+ 9169 3E 02            LD      A, 2
  19+ 916B 32 E8 B1         LD      (Var_Game_PlayersSpeed), A ; set default players speed to 2
  20+ 916E CD D0 A3         CALL    Game_Start
  21+ 9171 CD 76 91         CALL    Menu_ShowOptions
  22+ 9174 FB               EI
  23+ 9175 C9               RET
  24+ 9176
  25+ 9176              Menu_ShowOptions:
  26+ 9176 CD EF 90         CALL    VDP_ClearMenuSideArea
  27+ 9179
  28+ 9179 21 6B 80         LD      HL, TXT_BTN_PLY1_1
  29+ 917C 16 00            LD      D, 0
  30+ 917E 1E 17            LD      E, 23
  31+ 9180 CD 63 88         CALL    VDP_PrintString
  32+ 9183 21 74 80         LD      HL, TXT_BTN_PLY1_2
  33+ 9186 16 01            LD      D, 1
  34+ 9188 1E 18            LD      E, 24
  35+ 918A CD 63 88         CALL    VDP_PrintString
  36+ 918D 21 7B 80         LD      HL, TXT_BTN_PLY1_3
  37+ 9190 16 02            LD      D, 2
  38+ 9192 1E 18            LD      E, 24
  39+ 9194 CD 63 88         CALL    VDP_PrintString
  40+ 9197 21 82 80         LD      HL, TXT_BTN_PLY1_4
  41+ 919A 16 03            LD      D, 3
  42+ 919C 1E 18            LD      E, 24
  43+ 919E CD 63 88         CALL    VDP_PrintString
  44+ 91A1 21 8A 80         LD      HL, TXT_BTN_PLY1_5
  45+ 91A4 16 04            LD      D, 4
  46+ 91A6 1E 18            LD      E, 24
  47+ 91A8 CD 63 88         CALL    VDP_PrintString
  48+ 91AB
  49+ 91AB
  50+ 91AB 21 E1 80         LD      HL, TXT_EMPTY
  51+ 91AE 16 0E            LD      D, 14
  52+ 91B0 1E 17            LD      E, 23
  53+ 91B2 CD 63 88         CALL    VDP_PrintString
  54+ 91B5
  55+ 91B5
  56+ 91B5 21 E1 80         LD      HL, TXT_EMPTY
  57+ 91B8 16 06            LD      D, 6
  58+ 91BA 1E 17            LD      E, 23
  59+ 91BC CD 63 88         CALL    VDP_PrintString
  60+ 91BF 21 E1 80         LD      HL, TXT_EMPTY
  61+ 91C2 16 07            LD      D, 7
  62+ 91C4 1E 18            LD      E, 24
  63+ 91C6 CD 63 88         CALL    VDP_PrintString
  64+ 91C9 21 E1 80         LD      HL, TXT_EMPTY
  65+ 91CC 16 08            LD      D, 8
  66+ 91CE 1E 18            LD      E, 24
  67+ 91D0 CD 63 88         CALL    VDP_PrintString
  68+ 91D3 21 E1 80         LD      HL, TXT_EMPTY
  69+ 91D6 16 09            LD      D, 9
  70+ 91D8 1E 18            LD      E, 24
  71+ 91DA CD 63 88         CALL    VDP_PrintString
  72+ 91DD 21 E1 80         LD      HL, TXT_EMPTY
  73+ 91E0 16 0A            LD      D, 10
  74+ 91E2 1E 18            LD      E, 24
  75+ 91E4 CD 63 88         CALL    VDP_PrintString
  76+ 91E7
  77+ 91E7
  78+ 91E7 21 38 80         LD      HL, TXT_CPU
  79+ 91EA 16 0D            LD      D, 13
  80+ 91EC 1E 17            LD      E, 23
  81+ 91EE CD 63 88         CALL    VDP_PrintString
  82+ 91F1
  83+ 91F1 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
  84+ 91F4 FE 01            CP      GAME_MODE_1_PLAYER
  85+ 91F6 28 3F            JR      Z, .Level1
  86+ 91F8 21 30 80         LD      HL, TXT_GAME_MODE_2_PLAYERS
  87+ 91FB 16 0D            LD      D, 13
  88+ 91FD 1E 17            LD      E, 23
  89+ 91FF CD 63 88         CALL    VDP_PrintString
  90+ 9202 21 92 80         LD      HL, TXT_BTN_PLY2_1
  91+ 9205 16 06            LD      D, 6
  92+ 9207 1E 17            LD      E, 23
  93+ 9209 CD 63 88         CALL    VDP_PrintString
  94+ 920C 21 9B 80         LD      HL, TXT_BTN_PLY2_2
  95+ 920F 16 07            LD      D, 7
  96+ 9211 1E 18            LD      E, 24
  97+ 9213 CD 63 88         CALL    VDP_PrintString
  98+ 9216 21 A2 80         LD      HL, TXT_BTN_PLY2_3
  99+ 9219 16 08            LD      D, 8
 100+ 921B 1E 18            LD      E, 24
 101+ 921D CD 63 88         CALL    VDP_PrintString
 102+ 9220 21 A9 80         LD      HL, TXT_BTN_PLY2_4
 103+ 9223 16 09            LD      D, 9
 104+ 9225 1E 18            LD      E, 24
 105+ 9227 CD 63 88         CALL    VDP_PrintString
 106+ 922A 21 B1 80         LD      HL, TXT_BTN_PLY2_5
 107+ 922D 16 0A            LD      D, 10
 108+ 922F 1E 18            LD      E, 24
 109+ 9231 CD 63 88         CALL    VDP_PrintString
 110+ 9234 CD A2 92         CALL    .Start
 111+ 9237
 112+ 9237
 113+ 9237              .Level1
 114+ 9237 21 63 80         LD      HL, TXT_LEVEL_NO
 115+ 923A 16 0E            LD      D, 14
 116+ 923C 1E 17            LD      E, 23
 117+ 923E CD 63 88         CALL    VDP_PrintString
 118+ 9241 3A EA B1         LD      A, (Var_Game_SelectedPlayers)
 119+ 9244 FE 02            CP      GAME_MODE_2_PLAYERS
 120+ 9246 28 5A            JR      Z, .Start
 121+ 9248
 122+ 9248
 123+ 9248 3A C4 B1         LD      A, (Var_Game_SelectedLevel)
 124+ 924B FE 01            CP      1
 125+ 924D 20 0D            JR      NZ, .Level2
 126+ 924F 21 40 80         LD      HL, TXT_LEVEL_1
 127+ 9252 16 0E            LD      D, 14
 128+ 9254 1E 17            LD      E, 23
 129+ 9256 CD 63 88         CALL    VDP_PrintString
 130+ 9259 C3 A2 92         JP      .Start
 131+ 925C              .Level2:
 132+ 925C 3A C4 B1         LD      A, (Var_Game_SelectedLevel)
 133+ 925F FE 02            CP      2
 134+ 9261 20 0D            JR      NZ, .Level3
 135+ 9263 21 47 80         LD      HL, TXT_LEVEL_2
 136+ 9266 16 0E            LD      D, 14
 137+ 9268 1E 17            LD      E, 23
 138+ 926A CD 63 88         CALL    VDP_PrintString
 139+ 926D C3 A2 92         JP      .Start
 140+ 9270              .Level3:
 141+ 9270 3A C4 B1         LD      A, (Var_Game_SelectedLevel)
 142+ 9273 FE 03            CP      3
 143+ 9275 20 0D            JR      NZ, .Level4
 144+ 9277 21 4E 80         LD      HL, TXT_LEVEL_3
 145+ 927A 16 0E            LD      D, 14
 146+ 927C 1E 17            LD      E, 23
 147+ 927E CD 63 88         CALL    VDP_PrintString
 148+ 9281 C3 A2 92         JP      .Start
 149+ 9284              .Level4:
 150+ 9284 3A C4 B1         LD      A, (Var_Game_SelectedLevel)
 151+ 9287 FE 04            CP      4
 152+ 9289 20 0D            JR      NZ, .Level5
 153+ 928B 21 55 80         LD      HL, TXT_LEVEL_4
 154+ 928E 16 0E            LD      D, 14
 155+ 9290 1E 17            LD      E, 23
 156+ 9292 CD 63 88         CALL    VDP_PrintString
 157+ 9295 C3 A2 92         JP      .Start
 158+ 9298              .Level5:
 159+ 9298 21 5C 80         LD      HL, TXT_LEVEL_5
 160+ 929B 16 0E            LD      D, 14
 161+ 929D 1E 17            LD      E, 23
 162+ 929F CD 63 88         CALL    VDP_PrintString
 163+ 92A2              .Start:
 164+ 92A2 21 B9 80         LD      HL, TXT_SPACE
 165+ 92A5 16 11            LD      D, 17
 166+ 92A7 1E 17            LD      E, 23
 167+ 92A9 CD 63 88         CALL    VDP_PrintString
 168+ 92AC 21 C1 80         LD      HL, TXT_START
 169+ 92AF 16 12            LD      D, 18
 170+ 92B1 1E 17            LD      E, 23
 171+ 92B3 CD 63 88         CALL    VDP_PrintString
 172+ 92B6 21 CA 80         LD      HL, TXT_GSSOCCER
 173+ 92B9 16 16            LD      D, 22
 174+ 92BB 1E 17            LD      E, 23
 175+ 92BD CD 63 88         CALL    VDP_PrintString
 176+ 92C0 21 D3 80         LD      HL, TXT_2025
 177+ 92C3 16 15            LD      D, 21
 178+ 92C5 1E 17            LD      E, 23
 179+ 92C7 CD 63 88         CALL    VDP_PrintString
 180+ 92CA 21 D8 80         LD      HL, TXT_PRACEK
 181+ 92CD 16 17            LD      D, 23
 182+ 92CF 1E 17            LD      E, 23
 183+ 92D1 CD 63 88         CALL    VDP_PrintString
 184+ 92D4 C9               RET
 185+ 92D5
 186+ 92D5
# file closed: ./inc/menu.asm
  17  92D5                  INCLUDE "utils.asm"                     ; Include utilities library
# file opened: ./inc/utils.asm
   1+ 92D5              ; ===================================================================
   2+ 92D5              ; GS11-Soccer - 2025 Fausto Pracek
   3+ 92D5              ; ===================================================================
   4+ 92D5
   5+ 92D5              ; *** UTILS.ASM ***
   6+ 92D5
   7+ 92D5              ; ------ ROUTINES ------
   8+ 92D5
   9+ 92D5
  10+ 92D5
  11+ 92D5
  12+ 92D5              ; ---------------------------------------------------------------------------
  13+ 92D5              ; Reads keyboard and returns a code if one of the arrows or SPACE is pressed.
  14+ 92D5              ; INPUT: -
  15+ 92D5              ; OUTPUT:
  16+ 92D5              ;   A = KEY_XXX constant, or 0 if no relevant key is pressed
  17+ 92D5              ; MODIFIES:
  18+ 92D5              ;   AF, BC, HL
  19+ 92D5              ; ---------------------------------------------------------------------------
  20+ 92D5
  21+ 92D5              ; ------ ROUTINES ------
  22+ 92D5
  23+ 92D5
  24+ 92D5
  25+ 92D5              ; ---------------------------------------------------------------------------
  26+ 92D5              ; Reads keyboard and returns a code if one of the arrows or SPACE is pressed.
  27+ 92D5              ; INPUT: -
  28+ 92D5              ; OUTPUT:
  29+ 92D5              ;   A = KEY_XXX constant, or 0 if no relevant key is pressed
  30+ 92D5              ; MODIFIES:
  31+ 92D5              ;   AF, BC, HL
  32+ 92D5              ; ---------------------------------------------------------------------------
  33+ 92D5
  34+ 92D5              ; ------ ROUTINES ------
  35+ 92D5
  36+ 92D5
  37+ 92D5
  38+ 92D5
  39+ 92D5              ;------------------------------------------------------------------------
  40+ 92D5              ; Read the keyboard
  41+ 92D5              ; INPUT: -
  42+ 92D5              ; OUTPUT:
  43+ 92D5              ;   A: ASCII code of key pressed
  44+ 92D5              ; MODIFY: HL, BC, AF
  45+ 92D5              ;------------------------------------------------------------------------
  46+ 92D5              Utils_ReadKeyboard:
  47+ 92D5 21 00 80         LD  HL,KEYBOARD_MAP     ; Point HL at the keyboard list
  48+ 92D8 16 08            LD  D, 8                ; This is the number of ports (rows) to check
  49+ 92DA 0E FE            LD  C, #FE              ; C is always FEh for reading keyboard ports
  50+ 92DC              .ReadKeyboard0:
  51+ 92DC 46               LD  B, (HL)             ; Get the keyboard port address from table
  52+ 92DD 23               INC HL                  ; Increment to list of keys
  53+ 92DE ED 78            IN  A, (C)              ; Read the row of keys in
  54+ 92E0 E6 1F            AND #1F                 ; We are only interested in the first five bits
  55+ 92E2 1E 05            LD  E, 5                ; This is the number of keys in the row
  56+ 92E4              .ReadKeyboard1:
  57+ 92E4 CB 3F            SRL A                   ; Shift A right; bit 0 sets carry bit
  58+ 92E6 D2 F7 92         JP  NC, .ReadKeyboard2   ; If the bit is 0, we've found our key
  59+ 92E9 23               INC HL                  ; Go to next table address
  60+ 92EA 1D               DEC E                   ; Decrement key loop counter
  61+ 92EB C2 E4 92         JP  NZ, .ReadKeyboard1   ; Loop around until this row finished
  62+ 92EE 15               DEC D                   ; Decrement row loop counter
  63+ 92EF C2 DC 92         JP  NZ, .ReadKeyboard0   ; Loop around until we are done
  64+ 92F2 A7               AND A                   ; Clear A (no key found)
  65+ 92F3 32 BF B1         LD  (Var_Utils_LastKbdKeyPressed), A
  66+ 92F6 C9               RET
  67+ 92F7              .ReadKeyboard2:
  68+ 92F7 7E               LD  A, (HL)             ; We've found a key at this point; fetch the character code!
  69+ 92F8 47               LD  B, A
  70+ 92F9 3A BF B1         LD  A,(Var_Utils_LastKbdKeyPressed)
  71+ 92FC FE 00            CP  0
  72+ 92FE CA 07 93         JP  Z, .ReadKeyboard3    ; If no key pressed before, skip the check
  73+ 9301 B8               CP  B                   ; Check if the key is the same as the last one pressed
  74+ 9302 C2 07 93         JP  NZ, .ReadKeyboard3    ; If it is, skip the rest of this routine
  75+ 9305 AF               XOR A               ; If it is the same, clear A (no key found)
  76+ 9306 C9               RET
  77+ 9307              .ReadKeyboard3:
  78+ 9307 78               LD  A, B
  79+ 9308 32 BF B1         LD  (Var_Utils_LastKbdKeyPressed), A
  80+ 930B 32 C1 B1         LD  (Var_Utils_KbdKeyPressed), A
  81+ 930E C9               RET
  82+ 930F
  83+ 930F
  84+ 930F
  85+ 930F
  86+ 930F
  87+ 930F
  88+ 930F              ;------------------------------------------------------------------------
  89+ 930F              ; Utils_GetRandomNumber
  90+ 930F              ; OUTPUT: A = 0..127  (uniforme-ish)
  91+ 930F              ; MODIFIES: A, BC
  92+ 930F              ;------------------------------------------------------------------------
  93+ 930F              Utils_GetRandomNumber:
  94+ 930F 3A B7 B1         LD   A,(Var_Utils_OldRnd)
  95+ 9312 4F               LD   C,A
  96+ 9313
  97+ 9313                  ; s = s*33 + R  (33 = 32 + 1)
  98+ 9313 87               ADD  A,A         ; 2
  99+ 9314 87               ADD  A,A         ; 4
 100+ 9315 87               ADD  A,A         ; 8
 101+ 9316 87               ADD  A,A         ; 16
 102+ 9317 87               ADD  A,A         ; 32
 103+ 9318 81               ADD  A,C         ; *33
 104+ 9319 4F               LD   C,A
 105+ 931A ED 5F            LD   A,R
 106+ 931C 81               ADD  A,C
 107+ 931D
 108+ 931D 32 B7 B1         LD   (Var_Utils_OldRnd),A
 109+ 9320 E6 7F            AND  127         ; 0..127
 110+ 9322 C9               RET
 111+ 9323
 112+ 9323
 113+ 9323
 114+ 9323              ; --------------------------------------------------
 115+ 9323              ; Play beep
 116+ 9323              ; INPUT:
 117+ 9323              ;   B: Number of toggles
 118+ 9323              ;   C: Delay loop
 119+ 9323              ; --------------------------------------------------
 120+ 9323              PlayBeep:
 121+ 9323 C5               PUSH BC
 122+ 9324 3E 10            LD   A, 16          ; 0001 0000 → beeper ON
 123+ 9326              .BeepLoop:
 124+ 9326 D3 FE            OUT  (254), A       ; accendi
 125+ 9328 CD 36 93         CALL DelayHalf
 126+ 932B AF               XOR  A              ; A=0 → beeper OFF
 127+ 932C D3 FE            OUT  (254), A       ; spegni
 128+ 932E CD 36 93         CALL DelayHalf
 129+ 9331 05               DEC  B
 130+ 9332 20 F2            JR   NZ, .BeepLoop
 131+ 9334 C1               POP  BC
 132+ 9335 C9               RET
 133+ 9336
 134+ 9336              DelayHalf:
 135+ 9336 51               LD   D, C
 136+ 9337              .DH:
 137+ 9337 15               DEC  D
 138+ 9338 20 FD            JR   NZ, .DH
 139+ 933A C9               RET
 140+ 933B
 141+ 933B
 142+ 933B
 143+ 933B
 144+ 933B              ; Genera un beep usando PSG con impostazioni sicure
 145+ 933B              Utils_PlayBeep:
 146+ 933B 06 50            ld  b,80        ; durata
 147+ 933D 16 18            ld  d,24        ; pitch (più basso = più acuto)
 148+ 933F CD 23 93         call PlayBeep
 149+ 9342 C9               RET
 150+ 9343
 151+ 9343              ;-----------------------------------------
 152+ 9343              ; Utils_PlayBeepGoalCorner - Beep più acuto (MSX)
 153+ 9343              ; Usa solo canale A, salva/ripristina mixer e volume
 154+ 9343              ;-----------------------------------------
 155+ 9343              Utils_PlayBeepGoalCorner:
 156+ 9343 06 50            ld  b,80        ; durata
 157+ 9345 16 04            ld  d,4         ; pitch (più basso = più acuto)
 158+ 9347 CD 23 93         call PlayBeep
 159+ 934A C9               RET
 160+ 934B              Utils_PlayBeepHighLong:
 161+ 934B                  ;ld  b,80        ; durata
 162+ 934B                  ;ld  d,10         ; pitch (più basso = più acuto)
 163+ 934B                  ;call PlayBeep
 164+ 934B C9               RET
 165+ 934C
 166+ 934C
 167+ 934C
 168+ 934C
 169+ 934C
 170+ 934C
 171+ 934C
 172+ 934C
 173+ 934C              ; ------------------------------------------------------------
 174+ 934C              ; Var_Game_BeepStep (BYTE in RAM) - definiscila tu nel tuo blocco variabili
 175+ 934C              ; Var_Game_BeepStep: DB 0
 176+ 934C              ; ------------------------------------------------------------
 177+ 934C
 178+ 934C
 179+ 934C              ; ------------------------------------------------------------
 180+ 934C              ; Utils_PlayBeepTick
 181+ 934C              ; Un solo beep breve (ta).
 182+ 934C              ; Ogni chiamata usa il prossimo periodo: 250,235,220,205 (ciclico)
 183+ 934C              ; Suono più simile al BASIC: micro-decay 12->8->0 + tiny delay
 184+ 934C              ; ------------------------------------------------------------
 185+ 934C              Utils_PlayBeepTick:
 186+ 934C 06 50            ld  b,80        ; durata
 187+ 934E 16 0A            ld  d,10         ; pitch (più basso = più acuto)
 188+ 9350 CD 23 93         call PlayBeep
 189+ 9353 C9               RET
 190+ 9354
 191+ 9354
 192+ 9354
 193+ 9354
 194+ 9354              ; ------------------------------------------------------------
 195+ 9354              ; Utils_ResetBeepTick
 196+ 9354              ; ------------------------------------------------------------
 197+ 9354              Utils_ResetBeepTick:
 198+ 9354 AF               XOR  A
 199+ 9355 32 EE B1         LD   (Var_Game_BeepStep),A
 200+ 9358 C9               RET
 201+ 9359
 202+ 9359
# file closed: ./inc/utils.asm
  18  9359                  INCLUDE "game.asm"                      ; Include game library
# file opened: ./inc/game.asm
   1+ 9359
   2+ 9359              ; ===================================================================
   3+ 9359              ; GS11-Soccer - 2025 Fausto Pracek
   4+ 9359              ; ===================================================================
   5+ 9359
   6+ 9359              ; *** GAME.ASM ***
   7+ 9359
   8+ 9359              ; ------ ROUTINES ------
   9+ 9359              Game_InitVariables:
  10+ 9359 3E FF            LD      A, NO_VALUE
  11+ 935B 32 EC B1         LD      (Var_Game_FirstKickType), A
  12+ 935E 3E 00            LD      A, NO
  13+ 9360 32 B8 B1         LD      (Var_Utils_VblankStopped), A
  14+ 9363 32 3D B2         LD      (Var_Hooks_ForceVdpRedraw), A
  15+ 9366 32 37 B2         LD      (Var_Hooks_GameResumingWaiting), A
  16+ 9369 3E 01            LD      A, GAME_MODE_1_PLAYER
  17+ 936B 32 EA B1         LD      (Var_Game_SelectedPlayers), A
  18+ 936E 3E 00            LD      A, NO
  19+ 9370 32 E7 B1         LD      (Var_Game_MatchInProgress), A
  20+ 9373 3E 02            LD      A, 2
  21+ 9375 32 DD B1         LD      (Var_Game_HumanPlayerSpeed), A
  22+ 9378 AF               XOR     A
  23+ 9379 32 C9 B1         LD      (Var_Game_BallUpdateTimer), A
  24+ 937C 32 3F B2         LD      (Var_Hooks_GoalCerimonyCounter), A
  25+ 937F CD 7D 86         CALL    Hooks_InitAICounters
  26+ 9382 CD 14 9E         CALL    Game_StopShot
  27+ 9385 C9               RET
  28+ 9386
  29+ 9386
  30+ 9386              ; ---------------------------------------------------------------------------
  31+ 9386              ; Game_CheckVerticalShotPossessionStop
  32+ 9386              ;
  33+ 9386              ; INPUT:
  34+ 9386              ;   D = BallY
  35+ 9386              ;   E = BallX
  36+ 9386              ; ---------------------------------------------------------------------------
  37+ 9386              Game_CheckVerticalShotPossessionStop:
  38+ 9386 F5               push af
  39+ 9387 C5               push bc
  40+ 9388 D5               push de
  41+ 9389 E5               push hl
  42+ 938A
  43+ 938A                  ; ---------------------------
  44+ 938A                  ; Check NERI: match esatto (Y,X)  ID 1..3
  45+ 938A                  ; ---------------------------
  46+ 938A 06 00            ld   b,TEAM_BLACK
  47+ 938C 0E 01            ld   c,1
  48+ 938E              .chk_black_loop:
  49+ 938E D5               push de
  50+ 938F CD 14 96         call Game_GetPlayerInfoById      ; HL = cur (H=Y, L=X)
  51+ 9392 D1               pop  de
  52+ 9393
  53+ 9393 7C               ld   a,h
  54+ 9394 BA               cp   d
  55+ 9395 20 09            jr   nz,.chk_black_next
  56+ 9397 7D               ld   a,l
  57+ 9398 BB               cp   e
  58+ 9399 20 05            jr   nz,.chk_black_next
  59+ 939B
  60+ 939B CD 14 9E         call Game_StopShot
  61+ 939E 18 3B            jr   .done
  62+ 93A0
  63+ 93A0              .chk_black_next:
  64+ 93A0 0C               inc  c
  65+ 93A1 79               ld   a,c
  66+ 93A2 FE 04            cp   4
  67+ 93A4 20 E8            jr   nz,.chk_black_loop
  68+ 93A6
  69+ 93A6                  ; ---------------------------
  70+ 93A6                  ; Check BIANCHI: match su (BallY+1, BallX)  ID 1..3
  71+ 93A6                  ; ---------------------------
  72+ 93A6 06 01            ld   b,TEAM_WHITE
  73+ 93A8 0E 01            ld   c,1
  74+ 93AA              .chk_white_loop:
  75+ 93AA D5               push de
  76+ 93AB CD 14 96         call Game_GetPlayerInfoById      ; HL = cur (H=Y, L=X)
  77+ 93AE D1               pop  de
  78+ 93AF
  79+ 93AF 7A               ld   a,d
  80+ 93B0 3C               inc  a                           ; targetY = BallY+1
  81+ 93B1 BC               cp   h
  82+ 93B2 20 09            jr   nz,.chk_white_next
  83+ 93B4
  84+ 93B4 7B               ld   a,e
  85+ 93B5 BD               cp   l
  86+ 93B6 20 05            jr   nz,.chk_white_next
  87+ 93B8
  88+ 93B8 CD 14 9E         call Game_StopShot
  89+ 93BB 18 1E            jr   .done
  90+ 93BD
  91+ 93BD              .chk_white_next:
  92+ 93BD 0C               inc  c
  93+ 93BE 79               ld   a,c
  94+ 93BF FE 04            cp   4
  95+ 93C1 20 E7            jr   nz,.chk_white_loop
  96+ 93C3
  97+ 93C3                  ; ------------------------------------------------------------
  98+ 93C3                  ; Nessun possesso: verifica stop per fondo campo del lato attuale
  99+ 93C3                  ; e/o cambio metà campo
 100+ 93C3                  ; ------------------------------------------------------------
 101+ 93C3 3A C2 B1         ld   a,(Var_Game_ActiveFieldSide)
 102+ 93C6 FE 00            cp   FIELD_SOUTH_SIDE
 103+ 93C8 20 0A            jr   nz,.field_is_north
 104+ 93CA
 105+ 93CA              ; ===== CAMPO SOUTH =====
 106+ 93CA                  ; Se palla su riga 4 -> fondo campo / porta: stop tiro
 107+ 93CA 7A               ld   a,d
 108+ 93CB FE 04            cp   4
 109+ 93CD 20 0C            jr   nz,.done
 110+ 93CF CD 14 9E         call Game_StopShot
 111+ 93D2 18 07            jr   .done
 112+ 93D4
 113+ 93D4
 114+ 93D4
 115+ 93D4              ; ===== CAMPO NORTH =====
 116+ 93D4              .field_is_north:
 117+ 93D4                  ; Se palla su riga 0 -> fondo campo / porta: stop tiro
 118+ 93D4 7A               ld   a,d
 119+ 93D5 B7               or   a
 120+ 93D6 20 03            jr   nz,.done
 121+ 93D8 CD 14 9E         call Game_StopShot
 122+ 93DB
 123+ 93DB              .done:
 124+ 93DB E1               pop  hl
 125+ 93DC D1               pop  de
 126+ 93DD C1               pop  bc
 127+ 93DE F1               pop  af
 128+ 93DF C9               ret
 129+ 93E0
 130+ 93E0
 131+ 93E0
 132+ 93E0
 133+ 93E0              ; ---------------------------------------------------------------------------
 134+ 93E0              ; Game_UpdateBallMovement
 135+ 93E0              ; Da chiamare a ogni tick (AiTick) per muovere la palla se in tiro.
 136+ 93E0              ;
 137+ 93E0              ; Usa:
 138+ 93E0              ;   Var_Game_BallDirection
 139+ 93E0              ;   Var_Game_BallDiagonalMovCounter (0 normale, 255 caso speciale)
 140+ 93E0              ;
 141+ 93E0              ; Convenzioni:
 142+ 93E0              ;   Game_GetBallPosition -> DE  (D=Y, E=X)
 143+ 93E0              ;   Game_SetBallPosition usa DE (D=Y, E=X)
 144+ 93E0              ;
 145+ 93E0              ; Regole:
 146+ 93E0              ; - Se BallDirection = NONE -> nessun movimento
 147+ 93E0              ; - Caso speciale counter=255 (solo WHITE attaccante, campo NORTH, Y=2):
 148+ 93E0              ;     * NORTH: primo tick = nessun movimento, counter->0
 149+ 93E0              ;     * NE/NW: primo tick = solo laterale, counter->0
 150+ 93E0              ; - Diagonali: ogni tick muove Y e prova a muovere X; se X è già al bordo
 151+ 93E0              ;   che impedisce la diagonale, X non cambia ma il tick conta comunque.
 152+ 93E0              ; - Il counter aumenta SEMPRE per direzioni diverse da:
 153+ 93E0              ;       BALL_DIRECTION_NONE, BALL_DIRECTION_NORTH, BALL_DIRECTION_SOUTH
 154+ 93E0              ; - Se (counter == 2) prima di uscire: Game_StopShot (stop definitivo tiro)
 155+ 93E0              ; ---------------------------------------------------------------------------
 156+ 93E0              Game_UpdateBallMovement:
 157+ 93E0
 158+ 93E0 3A 3D B2         ld    a,(Var_Hooks_ForceVdpRedraw)
 159+ 93E3 FE 01            cp    YES
 160+ 93E5 C8               ret   z
 161+ 93E6 3A C9 B1         LD    A, (Var_Game_BallUpdateTimer)
 162+ 93E9 3C               inc   a
 163+ 93EA 32 C9 B1         LD    (Var_Game_BallUpdateTimer), A
 164+ 93ED FE 0A            CP    10
 165+ 93EF C0               RET    NZ
 166+ 93F0 AF               XOR   A
 167+ 93F1 32 C9 B1         LD    (Var_Game_BallUpdateTimer), A
 168+ 93F4
 169+ 93F4 F5               push af
 170+ 93F5 C5               push bc
 171+ 93F6 D5               push de
 172+ 93F7 E5               push hl
 173+ 93F8
 174+ 93F8                  ; se palla ferma -> niente
 175+ 93F8 3A E2 B1         ld   a,(Var_Game_BallDirection)
 176+ 93FB FE 00            cp   BALL_DIRECTION_NONE
 177+ 93FD CA 48 95         jp   z,.done
 178+ 9400
 179+ 9400                  ; forza redraw
 180+ 9400 3E 01            ld   a,YES
 181+ 9402 32 3D B2         ld   (Var_Hooks_ForceVdpRedraw),a
 182+ 9405
 183+ 9405                  ; DE = (Y,X)
 184+ 9405 CD 4D 95         call Game_GetBallPosition         ; D=Y, E=X
 185+ 9408
 186+ 9408                  ; ------------------------------------------------------------
 187+ 9408                  ; Caso speciale "first tick grafico" (counter=255)
 188+ 9408                  ; ------------------------------------------------------------
 189+ 9408 3A E3 B1         ld   a,(Var_Game_BallDiagonalMovCounter)
 190+ 940B FE FF            cp   255
 191+ 940D 20 3B            jr   nz,.normal_move
 192+ 940F
 193+ 940F 3A E2 B1         ld   a,(Var_Game_BallDirection)
 194+ 9412 FE 01            cp   BALL_DIRECTION_NORTH
 195+ 9414 28 0E            jr   z,.special_north
 196+ 9416 FE 02            cp   BALL_DIRECTION_NORTH_EAST
 197+ 9418 28 11            jr   z,.special_ne
 198+ 941A FE 03            cp   BALL_DIRECTION_NORTH_WEST
 199+ 941C 28 1D            jr   z,.special_nw
 200+ 941E
 201+ 941E                  ; se per errore 255 con altre direzioni, normalizza
 202+ 941E AF               xor  a
 203+ 941F 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
 204+ 9422 18 26            jr   .normal_move
 205+ 9424
 206+ 9424              .special_north:
 207+ 9424                  ; primo tick: nessun movimento, solo marker grafico.
 208+ 9424 AF               xor  a
 209+ 9425 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
 210+ 9428 C3 3E 95         jp   .done_check2
 211+ 942B
 212+ 942B              .special_ne:
 213+ 942B                  ; primo tick: solo laterale (X+1 se possibile)
 214+ 942B 7B               ld   a,e
 215+ 942C FE 04            cp   4
 216+ 942E 28 04            jr   z,.special_ne_clear
 217+ 9430 1C               inc  e
 218+ 9431 CD 58 95         call Game_SetBallPosition
 219+ 9434              .special_ne_clear:
 220+ 9434 AF               xor  a
 221+ 9435 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
 222+ 9438 C3 3E 95         jp   .done_check2
 223+ 943B
 224+ 943B              .special_nw:
 225+ 943B                  ; primo tick: solo laterale (X-1 se possibile)
 226+ 943B 7B               ld   a,e
 227+ 943C B7               or   a
 228+ 943D 28 04            jr   z,.special_nw_clear
 229+ 943F 1D               dec  e
 230+ 9440 CD 58 95         call Game_SetBallPosition
 231+ 9443              .special_nw_clear:
 232+ 9443 AF               xor  a
 233+ 9444 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
 234+ 9447 C3 3E 95         jp   .done_check2
 235+ 944A
 236+ 944A
 237+ 944A              ; ------------------------------------------------------------
 238+ 944A              ; Movimento normale
 239+ 944A              ; ------------------------------------------------------------
 240+ 944A              .normal_move:
 241+ 944A
 242+ 944A
 243+ 944A                  ; --- incremento counter SOLO se direzione è diagonale ---
 244+ 944A 3A E2 B1         ld   a,(Var_Game_BallDirection)
 245+ 944D FE 00            cp   BALL_DIRECTION_NONE
 246+ 944F 28 0F            jr   z,.skip_counter_inc
 247+ 9451 FE 01            cp   BALL_DIRECTION_NORTH
 248+ 9453 28 0B            jr   z,.skip_counter_inc
 249+ 9455 FE 04            cp   BALL_DIRECTION_SOUTH
 250+ 9457 28 07            jr   z,.skip_counter_inc
 251+ 9459
 252+ 9459 3A E3 B1         ld   a,(Var_Game_BallDiagonalMovCounter)
 253+ 945C 3C               inc  a
 254+ 945D 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
 255+ 9460              .skip_counter_inc:
 256+ 9460
 257+ 9460 3E 01            ld a, YES
 258+ 9462 32 3D B2         ld    (Var_Hooks_ForceVdpRedraw), a
 259+ 9465
 260+ 9465                  ; dispatch direzione
 261+ 9465 3A E2 B1         ld   a,(Var_Game_BallDirection)
 262+ 9468
 263+ 9468 FE 01            cp   BALL_DIRECTION_NORTH
 264+ 946A 28 1E            jr   z,.move_north
 265+ 946C
 266+ 946C FE 04            cp   BALL_DIRECTION_SOUTH
 267+ 946E 28 57            jr   z,.move_south
 268+ 9470
 269+ 9470 FE 02            cp   BALL_DIRECTION_NORTH_EAST
 270+ 9472 CA 02 95         jp   z,.move_ne
 271+ 9475
 272+ 9475 FE 03            cp   BALL_DIRECTION_NORTH_WEST
 273+ 9477 CA 0F 95         jp   z,.move_nw
 274+ 947A
 275+ 947A FE 05            cp   BALL_DIRECTION_SOUTH_EAST
 276+ 947C CA 1B 95         jp   z,.move_se
 277+ 947F
 278+ 947F FE 06            cp   BALL_DIRECTION_SOUTH_WEST
 279+ 9481 CA 29 95         jp   z,.move_sw
 280+ 9484
 281+ 9484                  ; direzione sconosciuta -> stop
 282+ 9484 CD 14 9E         call Game_StopShot
 283+ 9487 C3 48 95         jp   .done
 284+ 948A
 285+ 948A
 286+ 948A              .move_north:
 287+ 948A 15               dec     d
 288+ 948B 7A               ld      a,d
 289+ 948C FE FF            cp      255
 290+ 948E 20 2F            jr      nz,.move_north_continue
 291+ 9490 14               inc     d
 292+ 9491 3A C2 B1         ld      a, (Var_Game_ActiveFieldSide)
 293+ 9494 FE 01            cp      FIELD_NORTH_SIDE
 294+ 9496 CA 39 95         jp      z,.stop_now
 295+ 9499 CD 58 81         CALL    Hooks_TickStop
 296+ 949C 3E 01            LD      A, FIELD_NORTH_SIDE
 297+ 949E 32 C2 B1         LD      (Var_Game_ActiveFieldSide),A
 298+ 94A1 CD 73 8B         CALL    VDP_DrawField
 299+ 94A4 CD 6F A2         CALL    Game_PutPlayersToNewFieldSide
 300+ 94A7 3E 01            ld      a,YES
 301+ 94A9 32 3D B2         ld      (Var_Hooks_ForceVdpRedraw),a
 302+ 94AC CD 4D 95         CALL    Game_GetBallPosition
 303+ 94AF 16 04            LD      D, 4
 304+ 94B1 CD 58 95         CALL    Game_SetBallPosition
 305+ 94B4 3E FF            LD      A, NO_VALUE
 306+ 94B6 32 F0 B1         LD      (Var_Game_BallYOldPosition), A
 307+ 94B9 CD 50 81         CALL    Hooks_TickStart
 308+ 94BC C3 48 95         jp      .done
 309+ 94BF              .move_north_continue:
 310+ 94BF CD 58 95         call Game_SetBallPosition
 311+ 94C2
 312+ 94C2                  ; --- NUOVO: stop se diventa possesso (verticale puro) ---
 313+ 94C2 CD 86 93         call Game_CheckVerticalShotPossessionStop
 314+ 94C5
 315+ 94C5 18 77            jr   .done_check2
 316+ 94C7
 317+ 94C7
 318+ 94C7              .move_south:
 319+ 94C7 14               inc     d
 320+ 94C8 7A               ld      a,d
 321+ 94C9 FE 05            cp      5
 322+ 94CB 20 2D            jr      nz,.move_south_continue
 323+ 94CD 15               dec     d
 324+ 94CE 3A C2 B1         ld      a, (Var_Game_ActiveFieldSide)
 325+ 94D1 FE 00            cp      FIELD_SOUTH_SIDE
 326+ 94D3 28 64            jr      z,.stop_now
 327+ 94D5 CD 58 81         CALL    Hooks_TickStop
 328+ 94D8 3E 00            LD      A, FIELD_SOUTH_SIDE
 329+ 94DA 32 C2 B1         LD      (Var_Game_ActiveFieldSide),A
 330+ 94DD CD 73 8B         CALL    VDP_DrawField
 331+ 94E0 CD 6F A2         CALL    Game_PutPlayersToNewFieldSide
 332+ 94E3 3E 01            ld      a,YES
 333+ 94E5 32 3D B2         ld      (Var_Hooks_ForceVdpRedraw),a
 334+ 94E8 CD 4D 95         CALL    Game_GetBallPosition
 335+ 94EB 16 00            LD      D, 0
 336+ 94ED CD 58 95         CALL    Game_SetBallPosition
 337+ 94F0 3E FF            LD      A, NO_VALUE
 338+ 94F2 32 F0 B1         LD      (Var_Game_BallYOldPosition), A
 339+ 94F5 CD 50 81         CALL    Hooks_TickStart
 340+ 94F8 18 4E            jr      .done
 341+ 94FA
 342+ 94FA              .move_south_continue:
 343+ 94FA CD 58 95         call Game_SetBallPosition
 344+ 94FD
 345+ 94FD                  ; --- NUOVO: stop se diventa possesso (verticale puro) ---
 346+ 94FD CD 86 93         call Game_CheckVerticalShotPossessionStop
 347+ 9500
 348+ 9500 18 3C            jr   .done_check2
 349+ 9502
 350+ 9502              ; Diagonali: muove SEMPRE Y, e X solo se non uscirebbe dal bordo.
 351+ 9502              .move_ne:
 352+ 9502                  ; Y--
 353+ 9502 7A               ld   a,d
 354+ 9503 B7               or   a
 355+ 9504 28 33            jr   z,.stop_now
 356+ 9506 15               dec  d
 357+ 9507                  ; X++ se possibile
 358+ 9507 7B               ld   a,e
 359+ 9508 FE 04            cp   4
 360+ 950A 28 28            jr   z,.set_pos_only      ; a bordo -> solo verticale
 361+ 950C 1C               inc  e
 362+ 950D 18 25            jr   .set_pos_only
 363+ 950F
 364+ 950F              .move_nw:
 365+ 950F                  ; Y--
 366+ 950F 7A               ld   a,d
 367+ 9510 B7               or   a
 368+ 9511 28 26            jr   z,.stop_now
 369+ 9513 15               dec  d
 370+ 9514                  ; X-- se possibile
 371+ 9514 7B               ld   a,e
 372+ 9515 B7               or   a
 373+ 9516 28 1C            jr   z,.set_pos_only
 374+ 9518 1D               dec  e
 375+ 9519 18 19            jr   .set_pos_only
 376+ 951B
 377+ 951B              .move_se:
 378+ 951B                  ; Y++
 379+ 951B 7A               ld   a,d
 380+ 951C FE 04            cp   4
 381+ 951E 28 19            jr   z,.stop_now
 382+ 9520 14               inc  d
 383+ 9521                  ; X++ se possibile
 384+ 9521 7B               ld   a,e
 385+ 9522 FE 04            cp   4
 386+ 9524 28 0E            jr   z,.set_pos_only
 387+ 9526 1C               inc  e
 388+ 9527 18 0B            jr   .set_pos_only
 389+ 9529
 390+ 9529              .move_sw:
 391+ 9529                  ; Y++
 392+ 9529 7A               ld   a,d
 393+ 952A FE 04            cp   4
 394+ 952C 28 0B            jr   z,.stop_now
 395+ 952E 14               inc  d
 396+ 952F                  ; X-- se possibile
 397+ 952F 7B               ld   a,e
 398+ 9530 B7               or   a
 399+ 9531 28 01            jr   z,.set_pos_only
 400+ 9533 1D               dec  e
 401+ 9534
 402+ 9534              .set_pos_only:
 403+ 9534 CD 58 95         call Game_SetBallPosition
 404+ 9537 18 05            jr   .done_check2
 405+ 9539
 406+ 9539
 407+ 9539              .stop_now:
 408+ 9539 CD 14 9E         call Game_StopShot
 409+ 953C 18 0A            jr   .done
 410+ 953E
 411+ 953E
 412+ 953E              ; ------------------------------------------------------------
 413+ 953E              ; Check fine tiro dopo 2 tick (vale SOLO per diagonali perché
 414+ 953E              ; il counter viene incrementato solo in quei casi).
 415+ 953E              ; ------------------------------------------------------------
 416+ 953E              .done_check2:
 417+ 953E 3A E3 B1         ld   a,(Var_Game_BallDiagonalMovCounter)
 418+ 9541 FE 02            cp   2
 419+ 9543 20 03            jr   nz,.done
 420+ 9545 CD 14 9E         call Game_StopShot
 421+ 9548
 422+ 9548              .done:
 423+ 9548 E1               pop  hl
 424+ 9549 D1               pop  de
 425+ 954A C1               pop  bc
 426+ 954B F1               pop  af
 427+ 954C C9               ret
 428+ 954D
 429+ 954D
 430+ 954D
 431+ 954D              ;------------------------------------------------------------------------
 432+ 954D              ; Get ball position
 433+ 954D              ; INPUT: -
 434+ 954D              ; OUTPUT: DE = X,Y
 435+ 954D              ; MODIFIES: -
 436+ 954D              ;------------------------------------------------------------------------
 437+ 954D              Game_GetBallPosition:
 438+ 954D F5               PUSH    AF
 439+ 954E 3A EB B1         LD      A, (Var_Game_BallXPosition)
 440+ 9551 5F               LD      E, A
 441+ 9552 3A EF B1         LD      A, (Var_Game_BallYPosition)
 442+ 9555 57               LD      D, A
 443+ 9556 F1               POP     AF
 444+ 9557 C9               RET
 445+ 9558              ;------------------------------------------------------------------------
 446+ 9558              ; Set ball position
 447+ 9558              ; INPUT:  D = Y, E = X   (coordinate di matrice 0..4)
 448+ 9558              ; OUTPUT: -
 449+ 9558              ; MODIFIES: AF
 450+ 9558              ; NOTE:
 451+ 9558              ;   - Prima copia la posizione corrente in Var_Game_Ball*OldPosition
 452+ 9558              ;   - Poi aggiorna Var_Game_BallX/YPosition con la nuova
 453+ 9558              ;------------------------------------------------------------------------
 454+ 9558              Game_SetBallPosition:
 455+ 9558 F5               PUSH    AF
 456+ 9559
 457+ 9559                  ; --- salviamo la posizione corrente come "old" ---
 458+ 9559 3A EB B1         LD      A,(Var_Game_BallXPosition)
 459+ 955C 32 F1 B1         LD      (Var_Game_BallXOldPosition),A
 460+ 955F
 461+ 955F 3A EF B1         LD      A,(Var_Game_BallYPosition)
 462+ 9562 32 F0 B1         LD      (Var_Game_BallYOldPosition),A
 463+ 9565
 464+ 9565                  ; --- scriviamo la nuova posizione (da D/E) ---
 465+ 9565 7A               LD      A,D
 466+ 9566 32 EF B1         LD      (Var_Game_BallYPosition),A
 467+ 9569
 468+ 9569 7B               LD      A,E
 469+ 956A 32 EB B1         LD      (Var_Game_BallXPosition),A
 470+ 956D
 471+ 956D F1               POP     AF
 472+ 956E C9               RET
 473+ 956F
 474+ 956F              ; ** UTILITY ROUTINES **
 475+ 956F
 476+ 956F              ; ---------------------------------------------------------------------------
 477+ 956F              ; Calculates pointer to the player entry in Var_Game_PlayersInfo.
 478+ 956F              ;
 479+ 956F              ; INPUT:
 480+ 956F              ;   B = TEAM (TEAM_BLACK=0, TEAM_WHITE=1)
 481+ 956F              ;   C = ID   (0..3)  ; 4 players per team
 482+ 956F              ;
 483+ 956F              ; OUTPUT:
 484+ 956F              ;   HL = pointer to entry start:
 485+ 956F              ;        [0] PREV_X, [1] PREV_Y, [2] CUR_X, [3] CUR_Y,
 486+ 956F              ;        [4] TEAM, [5] ID, [6] ROLE
 487+ 956F              ;
 488+ 956F              ; PRESERVES:
 489+ 956F              ;   B = TEAM, C = ID    (utile per le routine chiamanti)
 490+ 956F              ;
 491+ 956F              ; MODIFIES:
 492+ 956F              ;   AF, DE, HL
 493+ 956F              ; ---------------------------------------------------------------------------
 494+ 956F              GetPlayerEntryPtr:
 495+ 956F                  ; n = TEAM*4 + ID  (TEAM_BLACK=0, TEAM_WHITE=1)
 496+ 956F                  ; salvo TEAM/ID perché userò BC come registro di lavoro
 497+ 956F C5               PUSH BC
 498+ 9570
 499+ 9570 78               LD   A,B
 500+ 9571 87               ADD  A,A           ; *2
 501+ 9572 87               ADD  A,A           ; *4
 502+ 9573 81               ADD  A,C           ; + ID → n (0..7)
 503+ 9574
 504+ 9574 4F               LD   C,A           ; C = n
 505+ 9575 06 00            LD   B,0           ; BC = n (16-bit)
 506+ 9577
 507+ 9577                  ; HL = n * PLAYER_ENTRY_SIZE (7)
 508+ 9577 21 00 00         LD   HL,0
 509+ 957A 3E 07            LD   A,PLAYER_ENTRY_SIZE      ; A = 7
 510+ 957C              .GPE_MulLoop:
 511+ 957C 09               ADD  HL,BC                    ; HL += n
 512+ 957D 3D               DEC  A
 513+ 957E 20 FC            JR   NZ,.GPE_MulLoop          ; ripeti 7 volte
 514+ 9580
 515+ 9580                  ; A questo punto HL = n * 7
 516+ 9580 11 F2 B1         LD   DE,Var_Game_PlayersInfo
 517+ 9583 19               ADD  HL,DE                    ; HL = base + n*7
 518+ 9584
 519+ 9584 C1               POP  BC                       ; ripristina TEAM/ID
 520+ 9585 C9               RET
 521+ 9586
 522+ 9586
 523+ 9586              ; ---------------------------------------------------------------------------
 524+ 9586              ; Determines the role of a player based on TEAM, FIELD DIRECTION and Y.
 525+ 9586              ; NOTE:
 526+ 9586              ;   This is intended for non-goalkeepers (ID != 0).
 527+ 9586              ;   Goalkeepers are forced to ROLE_GOALKEEPER in SetPlayerInfo, but
 528+ 9586              ;   mappings for goalkeeper rows are kept here for completeness.
 529+ 9586              ;
 530+ 9586              ; LOGIC (Var_Game_ActiveFieldSide = FIELD_NORTH_SIDE):
 531+ 9586              ;   TEAM_BLACK:
 532+ 9586              ;       Y=0 -> GOALKEEPER
 533+ 9586              ;       Y=1 -> DEFENDER
 534+ 9586              ;       Y=3 -> MIDFIELDER
 535+ 9586              ;       else -> STRIKER
 536+ 9586              ;   TEAM_WHITE (no visible goalkeeper):
 537+ 9586              ;       Y=4 -> MIDFIELDER
 538+ 9586              ;       Y=2 -> STRIKER
 539+ 9586              ;       else -> STRIKER
 540+ 9586              ;
 541+ 9586              ; LOGIC (Var_Game_ActiveFieldSide = FIELD_SOUTH_SIDE):
 542+ 9586              ;   TEAM_WHITE:
 543+ 9586              ;       Y=4 -> GOALKEEPER
 544+ 9586              ;       Y=3 -> DEFENDER
 545+ 9586              ;       Y=1 -> MIDFIELDER
 546+ 9586              ;       else -> STRIKER
 547+ 9586              ;   TEAM_BLACK (no visible goalkeeper):
 548+ 9586              ;       Y=0 -> MIDFIELDER
 549+ 9586              ;       Y=2 -> STRIKER
 550+ 9586              ;       else -> STRIKER
 551+ 9586              ;
 552+ 9586              ; INPUT:
 553+ 9586              ;   B = TEAM (TEAM_WHITE or TEAM_BLACK)
 554+ 9586              ;   D = Y (0..4)
 555+ 9586              ; OUTPUT:
 556+ 9586              ;   A = ROLE (ROLE_GOALKEEPER / ROLE_DEFENDER / ROLE_MIDFIELDER / ROLE_STRIKER)
 557+ 9586              ; MODIFIES:
 558+ 9586              ;   AF
 559+ 9586              ; ---------------------------------------------------------------------------
 560+ 9586              DeterminePlayerRole:
 561+ 9586 3A C2 B1         LD   A,(Var_Game_ActiveFieldSide)
 562+ 9589 FE 01            CP   FIELD_NORTH_SIDE
 563+ 958B 28 30            JR   Z,.NORTH
 564+ 958D
 565+ 958D              ; ===== FIELD DIRECTION SOUTH =======================================
 566+ 958D
 567+ 958D              .SOUTH:
 568+ 958D                  ; Check which team
 569+ 958D 78               LD   A,B
 570+ 958E FE 01            CP   TEAM_WHITE
 571+ 9590 28 12            JR   Z,.SOUTH_WHITE
 572+ 9592
 573+ 9592                  ; --- TEAM_BLACK (no visible goalkeeper) ---
 574+ 9592 7A               LD   A,D
 575+ 9593 FE 00            CP   0
 576+ 9595 28 07            JR   Z,.BLACK_MID_S
 577+ 9597 FE 02            CP   2
 578+ 9599 28 06            JR   Z,.BLACK_STR_S
 579+ 959B
 580+ 959B 3E 03            LD   A,ROLE_STRIKER
 581+ 959D C9               RET
 582+ 959E
 583+ 959E              .BLACK_MID_S:
 584+ 959E 3E 02            LD   A,ROLE_MIDFIELDER
 585+ 95A0 C9               RET
 586+ 95A1
 587+ 95A1              .BLACK_STR_S:
 588+ 95A1 3E 03            LD   A,ROLE_STRIKER
 589+ 95A3 C9               RET
 590+ 95A4
 591+ 95A4              ; --- TEAM_WHITE (with goalkeeper) ---
 592+ 95A4              .SOUTH_WHITE:
 593+ 95A4 7A               LD   A,D
 594+ 95A5 FE 04            CP   4
 595+ 95A7 28 0B            JR   Z,.WHITE_GK_S
 596+ 95A9 FE 03            CP   3
 597+ 95AB 28 0A            JR   Z,.WHITE_DEF_S
 598+ 95AD FE 01            CP   1
 599+ 95AF 28 09            JR   Z,.WHITE_MID_S
 600+ 95B1
 601+ 95B1 3E 03            LD   A,ROLE_STRIKER
 602+ 95B3 C9               RET
 603+ 95B4
 604+ 95B4              .WHITE_GK_S:
 605+ 95B4 3E 00            LD   A,ROLE_GOALKEEPER
 606+ 95B6 C9               RET
 607+ 95B7
 608+ 95B7              .WHITE_DEF_S:
 609+ 95B7 3E 01            LD   A,ROLE_DEFENDER
 610+ 95B9 C9               RET
 611+ 95BA
 612+ 95BA              .WHITE_MID_S:
 613+ 95BA 3E 02            LD   A,ROLE_MIDFIELDER
 614+ 95BC C9               RET
 615+ 95BD
 616+ 95BD
 617+ 95BD              ; ===== FIELD DIRECTION NORTH ======================================
 618+ 95BD
 619+ 95BD              .NORTH:
 620+ 95BD                  ; Check which team
 621+ 95BD 78               LD   A,B
 622+ 95BE FE 01            CP   TEAM_WHITE
 623+ 95C0 28 19            JR   Z,.NORTH_WHITE
 624+ 95C2
 625+ 95C2                  ; --- TEAM_BLACK (with goalkeeper) ---
 626+ 95C2 7A               LD   A,D
 627+ 95C3 FE 00            CP   0
 628+ 95C5 28 0B            JR   Z,.BLACK_GK_N
 629+ 95C7 FE 01            CP   1
 630+ 95C9 28 0A            JR   Z,.BLACK_DEF_N
 631+ 95CB FE 03            CP   3
 632+ 95CD 28 09            JR   Z,.BLACK_MID_N
 633+ 95CF
 634+ 95CF 3E 03            LD   A,ROLE_STRIKER
 635+ 95D1 C9               RET
 636+ 95D2
 637+ 95D2              .BLACK_GK_N:
 638+ 95D2 3E 00            LD   A,ROLE_GOALKEEPER
 639+ 95D4 C9               RET
 640+ 95D5
 641+ 95D5              .BLACK_DEF_N:
 642+ 95D5 3E 01            LD   A,ROLE_DEFENDER
 643+ 95D7 C9               RET
 644+ 95D8
 645+ 95D8              .BLACK_MID_N:
 646+ 95D8 3E 02            LD   A,ROLE_MIDFIELDER
 647+ 95DA C9               RET
 648+ 95DB
 649+ 95DB              ; --- TEAM_WHITE (no visible goalkeeper) ---
 650+ 95DB              .NORTH_WHITE:
 651+ 95DB 7A               LD   A,D
 652+ 95DC FE 04            CP   4
 653+ 95DE 28 07            JR   Z,.WHITE_MID_N
 654+ 95E0 FE 02            CP   2
 655+ 95E2 28 06            JR   Z,.WHITE_STR_N
 656+ 95E4
 657+ 95E4 3E 03            LD   A,ROLE_STRIKER
 658+ 95E6 C9               RET
 659+ 95E7
 660+ 95E7              .WHITE_MID_N:
 661+ 95E7 3E 02            LD   A,ROLE_MIDFIELDER
 662+ 95E9 C9               RET
 663+ 95EA
 664+ 95EA              .WHITE_STR_N:
 665+ 95EA 3E 03            LD   A,ROLE_STRIKER
 666+ 95EC C9               RET
 667+ 95ED
 668+ 95ED              ; ---------------------------------------------------------------------------
 669+ 95ED              ; Sets player info, updating previous and current positions and role.
 670+ 95ED              ; Previous position is taken from old CUR_X/CUR_Y (if not NO_VALUE).
 671+ 95ED              ; For ID = 0, the role is always ROLE_GOALKEEPER.
 672+ 95ED              ;
 673+ 95ED              ; INPUT:
 674+ 95ED              ;   B = TEAM (TEAM_WHITE / TEAM_BLACK)
 675+ 95ED              ;   C = ID   (0..3)
 676+ 95ED              ;   D = new Y (0..4 o 255 per invisibile)
 677+ 95ED              ;   E = new X (0..4 o 255 per invisibile)
 678+ 95ED              ; OUTPUT:
 679+ 95ED              ;   -
 680+ 95ED              ; MODIFIES:
 681+ 95ED              ;   AF, DE, HL
 682+ 95ED              ; ---------------------------------------------------------------------------
 683+ 95ED              SetPlayerInfo:
 684+ 95ED C5               PUSH    BC             ; salva TEAM, ID
 685+ 95EE D5               PUSH    DE             ; salva newY,newX
 686+ 95EF
 687+ 95EF                  ; HL -> inizio entry (PREV_X)
 688+ 95EF CD 6F 95         CALL    GetPlayerEntryPtr
 689+ 95F2
 690+ 95F2                  ; ----- leggi vecchia CUR_X / CUR_Y -----
 691+ 95F2 E5               PUSH    HL             ; salva base entry
 692+ 95F3
 693+ 95F3 23               INC     HL             ; PREV_Y
 694+ 95F4 23               INC     HL             ; CUR_X
 695+ 95F5 7E               LD      A,(HL)         ; A = old CUR_X
 696+ 95F6 23               INC     HL             ; CUR_Y
 697+ 95F7 4E               LD      C,(HL)         ; C = old CUR_Y
 698+ 95F8
 699+ 95F8 E1               POP     HL             ; HL di nuovo su PREV_X
 700+ 95F9
 701+ 95F9                  ; ----- PREV_X / PREV_Y -----
 702+ 95F9 77               LD      (HL),A         ; PREV_X = old CUR_X
 703+ 95FA 23               INC     HL
 704+ 95FB 71               LD      (HL),C         ; PREV_Y = old CUR_Y
 705+ 95FC
 706+ 95FC                  ; ----- CUR_X / CUR_Y -----
 707+ 95FC 23               INC     HL             ; HL -> CUR_X
 708+ 95FD D1               POP     DE             ; D=newY, E=newX
 709+ 95FE 73               LD      (HL),E         ; CUR_X
 710+ 95FF 23               INC     HL
 711+ 9600 72               LD      (HL),D         ; CUR_Y
 712+ 9601
 713+ 9601                  ; ----- TEAM / ID / ROLE -----
 714+ 9601 23               INC     HL             ; TEAM
 715+ 9602 C1               POP     BC             ; ripristina TEAM,ID
 716+ 9603 70               LD      (HL),B         ; TEAM
 717+ 9604 23               INC     HL             ; ID
 718+ 9605 71               LD      (HL),C         ; ID
 719+ 9606 23               INC     HL             ; ROLE
 720+ 9607
 721+ 9607                  ; Se ID=0 → portiere fisso
 722+ 9607 79               LD      A,C
 723+ 9608 B7               OR      A
 724+ 9609 20 04            JR      NZ,.not_goalkeeper
 725+ 960B
 726+ 960B 3E 00            LD      A,ROLE_GOALKEEPER
 727+ 960D 77               LD      (HL),A
 728+ 960E C9               RET
 729+ 960F
 730+ 960F              .not_goalkeeper:
 731+ 960F                  ; determina il ruolo per i giocatori di movimento
 732+ 960F                  ; B = TEAM, D = Y sono ancora validi
 733+ 960F CD 86 95         CALL    DeterminePlayerRole
 734+ 9612 77               LD      (HL),A
 735+ 9613 C9               RET
 736+ 9614
 737+ 9614              ; ---------------------------------------------------------------------------
 738+ 9614              ; Gets player info by TEAM and ID.
 739+ 9614              ;
 740+ 9614              ; INPUT:
 741+ 9614              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
 742+ 9614              ;   C = ID    (0..3)
 743+ 9614              ;
 744+ 9614              ; OUTPUT (se OK):
 745+ 9614              ;   HL = current position (H = Y, L = X)
 746+ 9614              ;   DE = previous position (D = prevY, E = prevX)
 747+ 9614              ;   A  = ROLE
 748+ 9614              ;   B  = TEAM (come in ingresso)
 749+ 9614              ;   C  = ID   (come in ingresso)
 750+ 9614              ;
 751+ 9614              ; OUTPUT (se ID fuori range):
 752+ 9614              ;   A  = NO_VALUE
 753+ 9614              ;
 754+ 9614              ; MODIFIES:
 755+ 9614              ;   AF, DE, HL
 756+ 9614              ; ---------------------------------------------------------------------------
 757+ 9614              Game_GetPlayerInfoById:
 758+ 9614 79               ld   a,c
 759+ 9615 FE 04            cp   4
 760+ 9617 38 03            jr   c,.GPI_ValidId
 761+ 9619 3E FF            ld   a,NO_VALUE
 762+ 961B C9               ret
 763+ 961C
 764+ 961C              .GPI_ValidId:
 765+ 961C                  ; salviamo TEAM/ID perché useremo B,C come temporanei
 766+ 961C C5               push bc
 767+ 961D
 768+ 961D                  ; HL -> PREV_X dell'entry (usa TEAM/ID salvati dentro GetPlayerEntryPtr)
 769+ 961D                  ; GetPlayerEntryPtr preserva B,C da solo (fa PUSH/POP BC)
 770+ 961D CD 6F 95         call GetPlayerEntryPtr       ; HL = base entry (PREV_X)
 771+ 9620
 772+ 9620                  ; ----- PREV in DE -----
 773+ 9620 5E               ld   e,(hl)                  ; PREV_X
 774+ 9621 23               inc  hl
 775+ 9622 56               ld   d,(hl)                  ; PREV_Y
 776+ 9623
 777+ 9623                  ; ----- CUR in B,C temporanei -----
 778+ 9623 23               inc  hl                      ; CUR_X
 779+ 9624 4E               ld   c,(hl)                  ; C = CUR_X
 780+ 9625 23               inc  hl                      ; CUR_Y
 781+ 9626 46               ld   b,(hl)                  ; B = CUR_Y
 782+ 9627
 783+ 9627                  ; ----- ROLE in A -----
 784+ 9627 23               inc  hl                      ; TEAM
 785+ 9628 23               inc  hl                      ; ID
 786+ 9629 23               inc  hl                      ; ROLE
 787+ 962A 7E               ld   a,(hl)                  ; A = ROLE
 788+ 962B
 789+ 962B                  ; ----- ricomponi output -----
 790+ 962B                  ; HL = (Y,X)
 791+ 962B 60               ld   h,b                     ; H = CUR_Y
 792+ 962C 69               ld   l,c                     ; L = CUR_X
 793+ 962D
 794+ 962D                  ; DE già contiene (prevY,prevX)
 795+ 962D
 796+ 962D                  ; ripristina TEAM/ID originali in BC
 797+ 962D C1               pop  bc                      ; B = TEAM, C = ID
 798+ 962E
 799+ 962E C9               ret
 800+ 962F
 801+ 962F
 802+ 962F
 803+ 962F              ; ---------------------------------------------------------------------------
 804+ 962F              ; Searches a player by his current position (CUR_X, CUR_Y).
 805+ 962F              ;
 806+ 962F              ; INPUT:
 807+ 962F              ;   D = Y (curY)
 808+ 962F              ;   E = X (curX)
 809+ 962F              ;
 810+ 962F              ; OUTPUT (if found):
 811+ 962F              ;   B  = TEAM        (0 = TEAM_BLACK, 1 = TEAM_WHITE)
 812+ 962F              ;   C  = ID          (0..3)
 813+ 962F              ;   A  = ROLE
 814+ 962F              ;   DE = current position  (D = curY, E = curX)
 815+ 962F              ;   HL = previous position (H = prevY, L = prevX)
 816+ 962F              ;
 817+ 962F              ; OUTPUT (if not found):
 818+ 962F              ;   A  = NO_VALUE
 819+ 962F              ;
 820+ 962F              ; MODIFIES:
 821+ 962F              ;   AF, BC, DE, HL
 822+ 962F              ; ---------------------------------------------------------------------------
 823+ 962F              Game_GetPlayerInfoByPos:
 824+ 962F 06 00            LD   B,TEAM_BLACK
 825+ 9631              .black:
 826+ 9631 0E 00            LD   C,0                      ; ID = 0..3
 827+ 9633              .black_loop:
 828+ 9633 C5               PUSH BC
 829+ 9634 D5               PUSH DE
 830+ 9635 CD 14 96         CALL Game_GetPlayerInfoById
 831+ 9638 D1               POP DE
 832+ 9639 C1               POP BC
 833+ 963A 7C               LD   A, H
 834+ 963B BA               CP   D
 835+ 963C 20 08            JR   NZ,.black_loop_not_found
 836+ 963E 7D               LD   A, L
 837+ 963F BB               CP   E
 838+ 9640 20 04            JR   NZ,.black_loop_not_found
 839+ 9642 CD 14 96         CALL Game_GetPlayerInfoById
 840+ 9645 C9               RET
 841+ 9646              .black_loop_not_found
 842+ 9646 0C               INC  C
 843+ 9647 79               LD   A, C
 844+ 9648 FE 04            CP   4
 845+ 964A 20 E7            JR   NZ, .black_loop
 846+ 964C 06 01            LD   B,TEAM_WHITE
 847+ 964E              .white:
 848+ 964E 0E 00            LD   C,0
 849+ 9650              .white_loop:
 850+ 9650 C5               PUSH BC
 851+ 9651 D5               PUSH DE
 852+ 9652 CD 14 96         CALL Game_GetPlayerInfoById
 853+ 9655 D1               POP DE
 854+ 9656 C1               POP BC
 855+ 9657 7C               LD   A, H
 856+ 9658 BA               CP   D
 857+ 9659 20 08            JR   NZ,.white_loop_not_found
 858+ 965B 7D               LD   A, L
 859+ 965C BB               CP   E
 860+ 965D 20 04            JR   NZ,.white_loop_not_found
 861+ 965F CD 14 96         CALL Game_GetPlayerInfoById
 862+ 9662 C9               RET
 863+ 9663              .white_loop_not_found
 864+ 9663 0C               INC  C
 865+ 9664 79               LD   A, C
 866+ 9665 FE 04            CP   4
 867+ 9667 20 E7            JR   NZ, .white_loop
 868+ 9669 3E FF            LD   A, NO_VALUE
 869+ 966B C9               RET
 870+ 966C
 871+ 966C              ; ---------------------------------------------------------------------------
 872+ 966C              ; Clears all previous positions (PREV_X, PREV_Y) for all players.
 873+ 966C              ; PREV_X and PREV_Y are set to NO_VALUE (255).
 874+ 966C              ;
 875+ 966C              ; INPUT:
 876+ 966C              ;  B: TEAM (TEAM_BLACK / TEAM_WHITE)
 877+ 966C              ;  C: ID (0..3)
 878+ 966C              ;   -
 879+ 966C              ; OUTPUT:
 880+ 966C              ;   -
 881+ 966C              ; MODIFIES:
 882+ 966C              ;   -
 883+ 966C              ; ---------------------------------------------------------------------------
 884+ 966C              Game_ClearSinglePlayerPrevPositions:
 885+ 966C D5               PUSH DE
 886+ 966D C5               PUSH BC
 887+ 966E E5               PUSH HL
 888+ 966F F5               PUSH AF
 889+ 9670
 890+ 9670
 891+ 9670
 892+ 9670 CD 6F 95         CALL GetPlayerEntryPtr        ; HL -> PREV_X of this player
 893+ 9673 3E FF            LD   A, NO_VALUE
 894+ 9675 77               LD   (HL),A                   ; PREV_X = NO_VALUE
 895+ 9676 23               INC  HL
 896+ 9677 77               LD   (HL),A                   ; PREV_Y = NO_VALUE
 897+ 9678
 898+ 9678
 899+ 9678
 900+ 9678
 901+ 9678 F1               POP AF
 902+ 9679 E1               POP HL
 903+ 967A C1               POP BC
 904+ 967B D1               POP DE
 905+ 967C C9               RET
 906+ 967D              ; ---------------------------------------------------------------------------
 907+ 967D              ; Clears all previous positions (PREV_X, PREV_Y) for all players.
 908+ 967D              ; PREV_X and PREV_Y are set to NO_VALUE (255).
 909+ 967D              ;
 910+ 967D              ; INPUT:
 911+ 967D              ;   -
 912+ 967D              ; OUTPUT:
 913+ 967D              ;   -
 914+ 967D              ; MODIFIES:
 915+ 967D              ;   AF, BC, HL
 916+ 967D              ; ---------------------------------------------------------------------------
 917+ 967D              ClearAllPrevPositions:
 918+ 967D 3E FF            LD   A,NO_VALUE
 919+ 967F
 920+ 967F                  ; ---- Team BLACK ----
 921+ 967F 06 00            LD   B,TEAM_BLACK
 922+ 9681 CD 8A 96         CALL .ClearTeamPrev
 923+ 9684
 924+ 9684                  ; ---- Team WHITE ----
 925+ 9684 06 01            LD   B,TEAM_WHITE
 926+ 9686 CD 8A 96         CALL .ClearTeamPrev
 927+ 9689
 928+ 9689 C9               RET
 929+ 968A
 930+ 968A              ; Clears PREV_X / PREV_Y for one team (B = TEAM, C = 0..3)
 931+ 968A              .ClearTeamPrev:
 932+ 968A 0E 00            LD   C,0                      ; ID = 0..3
 933+ 968C              .CT_Loop:
 934+ 968C C5               PUSH BC
 935+ 968D CD 6F 95         CALL GetPlayerEntryPtr        ; HL -> PREV_X of this player
 936+ 9690 3E FF            LD   A, NO_VALUE
 937+ 9692 77               LD   (HL),A                   ; PREV_X = NO_VALUE
 938+ 9693 23               INC  HL
 939+ 9694 77               LD   (HL),A                   ; PREV_Y = NO_VALUE
 940+ 9695
 941+ 9695 C1               POP  BC
 942+ 9696 0C               INC  C
 943+ 9697 79               LD   A,C                      ; *** qui confrontiamo C, non A vecchio ***
 944+ 9698 FE 04            CP   4
 945+ 969A 20 F0            JR   NZ,.CT_Loop
 946+ 969C C9               RET
 947+ 969D
 948+ 969D
 949+ 969D
 950+ 969D
 951+ 969D              ; ---------------------------------------------------------------------------
 952+ 969D              ; Sets kickoff schema when WHITE team is attacking (field direction NORTH).
 953+ 969D              ; Black goalkeeper is visible on row 0, white goalkeeper is hidden.
 954+ 969D              ; Players layout (Y=row, X=col):
 955+ 969D              ;   - Black GK:        Y=0, X=2
 956+ 969D              ;   - Black DEF:       Y=1, X=1 and Y=1, X=3
 957+ 969D              ;   - Black MID:       Y=3, X=4
 958+ 969D              ;   - White MID:       Y=4, X=1,2,3
 959+ 969D              ;   - White GK:        Y=255 (hidden), X=2
 960+ 969D              ; Also sets virtual player variables for a black virtual player at (0,0).
 961+ 969D              ; INPUT:
 962+ 969D              ;   -
 963+ 969D              ; OUTPUT:
 964+ 969D              ;   Var_Game_ActiveFieldSide updated
 965+ 969D              ;   Var_Game_PlayersInfo fully initialized for this schema
 966+ 969D              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
 967+ 969D              ; MODIFIES:
 968+ 969D              ;   AF, BC, DE, HL
 969+ 969D              ; ---------------------------------------------------------------------------
 970+ 969D              Game_SetWhiteKickoffSchema:
 971+ 969D 3E 01            LD   A, TEAM_WHITE
 972+ 969F 32 E0 B1         LD   (Var_Game_TeamWithBall), A
 973+ 96A2
 974+ 96A2 16 03            LD     D, 3
 975+ 96A4 1E 02            LD     E, 2
 976+ 96A6 CD 58 95         CALL   Game_SetBallPosition
 977+ 96A9 3E FF            LD     A, 255
 978+ 96AB 32 F0 B1         LD     (Var_Game_BallYOldPosition ), A
 979+ 96AE 3E 00            LD      A, BALL_DIRECTION_NONE
 980+ 96B0 32 E2 B1         LD      (Var_Game_BallDirection),A
 981+ 96B3
 982+ 96B3                  ; Set field direction to NORTH
 983+ 96B3 3E 01            LD   A,FIELD_NORTH_SIDE
 984+ 96B5 32 C2 B1         LD   (Var_Game_ActiveFieldSide),A
 985+ 96B8
 986+ 96B8                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
 987+ 96B8
 988+ 96B8                  ; Black GK, ID=0, Y=0, X=2
 989+ 96B8 06 00            LD   B,TEAM_BLACK
 990+ 96BA 0E 00            LD   C,0                  ; ID=0 (goalkeeper)
 991+ 96BC 16 00            LD   D,0                  ; Y
 992+ 96BE 1E 02            LD   E,2                  ; X
 993+ 96C0 CD ED 95         CALL SetPlayerInfo
 994+ 96C3
 995+ 96C3                  ; Black DEF 1, ID=1, Y=1, X=1
 996+ 96C3 06 00            LD   B,TEAM_BLACK
 997+ 96C5 0E 01            LD   C,1
 998+ 96C7 16 01            LD   D,1
 999+ 96C9 1E 01            LD   E,1
1000+ 96CB CD ED 95         CALL SetPlayerInfo
1001+ 96CE
1002+ 96CE                  ; Black DEF 2, ID=2, Y=1, X=3
1003+ 96CE 06 00            LD   B,TEAM_BLACK
1004+ 96D0 0E 02            LD   C,2
1005+ 96D2 16 01            LD   D,1
1006+ 96D4 1E 03            LD   E,3
1007+ 96D6 CD ED 95         CALL SetPlayerInfo
1008+ 96D9
1009+ 96D9                  ; Black MID, ID=3, Y=3, X=4
1010+ 96D9 06 00            LD   B,TEAM_BLACK
1011+ 96DB 0E 03            LD   C,3
1012+ 96DD 16 03            LD   D,3
1013+ 96DF 1E 04            LD   E,4
1014+ 96E1 CD ED 95         CALL SetPlayerInfo
1015+ 96E4
1016+ 96E4                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1017+ 96E4
1018+ 96E4                  ; White GK hidden, ID=0, Y=255, X=2
1019+ 96E4 06 01            LD   B,TEAM_WHITE
1020+ 96E6 0E 00            LD   C,0
1021+ 96E8 16 FF            LD   D,255
1022+ 96EA 1E 02            LD   E,2
1023+ 96EC CD ED 95         CALL SetPlayerInfo
1024+ 96EF
1025+ 96EF                  ; White MID 1, ID=1, Y=4, X=1
1026+ 96EF 06 01            LD   B,TEAM_WHITE
1027+ 96F1 0E 01            LD   C,1
1028+ 96F3 16 04            LD   D,4
1029+ 96F5 1E 01            LD   E,1
1030+ 96F7 CD ED 95         CALL SetPlayerInfo
1031+ 96FA
1032+ 96FA                  ; White MID 2, ID=2, Y=4, X=2
1033+ 96FA 06 01            LD   B,TEAM_WHITE
1034+ 96FC 0E 02            LD   C,2
1035+ 96FE 16 04            LD   D,4
1036+ 9700 1E 02            LD   E,2
1037+ 9702 CD ED 95         CALL SetPlayerInfo
1038+ 9705
1039+ 9705                  ; White MID 3, ID=3, Y=4, X=3
1040+ 9705 06 01            LD   B,TEAM_WHITE
1041+ 9707 0E 03            LD   C,3
1042+ 9709 16 04            LD   D,4
1043+ 970B 1E 03            LD   E,3
1044+ 970D CD ED 95         CALL SetPlayerInfo
1045+ 9710
1046+ 9710                  ; ---- VIRTUAL PLAYER ------------------------------------------
1047+ 9710
1048+ 9710 3E 00            LD   A,TEAM_BLACK
1049+ 9712 32 E6 B1         LD   (Var_Game_VirtualPlayerTeam),A
1050+ 9715
1051+ 9715 AF               XOR   A
1052+ 9716 32 E5 B1         LD   (Var_Game_VirtualPlayerXPos),A   ; X=0
1053+ 9719 3E 03            LD   A, 3
1054+ 971B 32 E4 B1         LD   (Var_Game_VirtualPlayerYPos),A
1055+ 971E                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1056+ 971E CD 7D 96         CALL ClearAllPrevPositions
1057+ 9721
1058+ 9721 C9               RET
1059+ 9722
1060+ 9722              ; ---------------------------------------------------------------------------
1061+ 9722              ; Sets kickoff schema when BLACK team is attacking (field direction SOUTH).
1062+ 9722              ; White goalkeeper is visible on row 4, black goalkeeper is hidden.
1063+ 9722              ; Players layout (Y=row, X=col):
1064+ 9722              ;   - White GK:        Y=4, X=2
1065+ 9722              ;   - White DEF:       Y=3, X=1 and Y=3, X=3
1066+ 9722              ;   - White MID:       Y=1, X=0
1067+ 9722              ;   - Black MID:       Y=0, X=1,2,3
1068+ 9722              ;   - Black GK:        Y=255 (hidden), X=2
1069+ 9722              ; Also sets virtual player variables for a white virtual player at (1,4).
1070+ 9722              ; INPUT:
1071+ 9722              ;   -
1072+ 9722              ; OUTPUT:
1073+ 9722              ;   Var_Game_ActiveFieldSide updated
1074+ 9722              ;   Var_Game_PlayersInfo fully initialized for this schema
1075+ 9722              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1076+ 9722              ; MODIFIES:
1077+ 9722              ;   AF, BC, DE, HL
1078+ 9722              ; ---------------------------------------------------------------------------
1079+ 9722              Game_SetBlackKickoffSchema:
1080+ 9722 3E 00            LD   A, TEAM_BLACK
1081+ 9724 32 E0 B1         LD   (Var_Game_TeamWithBall), A
1082+ 9727
1083+ 9727 16 00            LD     D, 0
1084+ 9729 1E 02            LD     E, 2
1085+ 972B CD 58 95         CALL   Game_SetBallPosition
1086+ 972E 3E FF            LD     A, 255
1087+ 9730 32 F0 B1         LD     (Var_Game_BallYOldPosition ), A
1088+ 9733 3E 00            LD   A, BALL_DIRECTION_NONE
1089+ 9735 32 E2 B1         LD   (Var_Game_BallDirection),A
1090+ 9738
1091+ 9738                  ; Set field direction to SOUTH
1092+ 9738 3E 00            LD   A,FIELD_SOUTH_SIDE
1093+ 973A 32 C2 B1         LD   (Var_Game_ActiveFieldSide),A
1094+ 973D
1095+ 973D                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1096+ 973D
1097+ 973D                  ; White GK, ID=0, Y=4, X=2
1098+ 973D 06 01            LD   B,TEAM_WHITE
1099+ 973F 0E 00            LD   C,0
1100+ 9741 16 04            LD   D,4
1101+ 9743 1E 02            LD   E,2
1102+ 9745 CD ED 95         CALL SetPlayerInfo
1103+ 9748
1104+ 9748                  ; White DEF 1, ID=1, Y=3, X=1
1105+ 9748 06 01            LD   B,TEAM_WHITE
1106+ 974A 0E 01            LD   C,1
1107+ 974C 16 03            LD   D,3
1108+ 974E 1E 01            LD   E,1
1109+ 9750 CD ED 95         CALL SetPlayerInfo
1110+ 9753
1111+ 9753                  ; White DEF 2, ID=2, Y=3, X=3
1112+ 9753 06 01            LD   B,TEAM_WHITE
1113+ 9755 0E 02            LD   C,2
1114+ 9757 16 03            LD   D,3
1115+ 9759 1E 03            LD   E,3
1116+ 975B CD ED 95         CALL SetPlayerInfo
1117+ 975E
1118+ 975E                  ; White MID, ID=3, Y=1, X=0
1119+ 975E 06 01            LD   B,TEAM_WHITE
1120+ 9760 0E 03            LD   C,3
1121+ 9762 16 01            LD   D,1
1122+ 9764 1E 00            LD   E,0
1123+ 9766 CD ED 95         CALL SetPlayerInfo
1124+ 9769
1125+ 9769                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1126+ 9769
1127+ 9769                  ; Black GK hidden, ID=0, Y=255, X=2
1128+ 9769 06 00            LD   B,TEAM_BLACK
1129+ 976B 0E 00            LD   C,0
1130+ 976D 16 FF            LD   D,255
1131+ 976F 1E 02            LD   E,2
1132+ 9771 CD ED 95         CALL SetPlayerInfo
1133+ 9774
1134+ 9774                  ; Black MID 1, ID=1, Y=0, X=1
1135+ 9774 06 00            LD   B,TEAM_BLACK
1136+ 9776 0E 01            LD   C,1
1137+ 9778 16 00            LD   D,0
1138+ 977A 1E 01            LD   E,1
1139+ 977C CD ED 95         CALL SetPlayerInfo
1140+ 977F
1141+ 977F                  ; Black MID 2, ID=2, Y=0, X=2
1142+ 977F 06 00            LD   B,TEAM_BLACK
1143+ 9781 0E 02            LD   C,2
1144+ 9783 16 00            LD   D,0
1145+ 9785 1E 02            LD   E,2
1146+ 9787 CD ED 95         CALL SetPlayerInfo
1147+ 978A
1148+ 978A                  ; Black MID 3, ID=3, Y=0, X=3
1149+ 978A 06 00            LD   B,TEAM_BLACK
1150+ 978C 0E 03            LD   C,3
1151+ 978E 16 00            LD   D,0
1152+ 9790 1E 03            LD   E,3
1153+ 9792 CD ED 95         CALL SetPlayerInfo
1154+ 9795
1155+ 9795                  ; ---- VIRTUAL PLAYER ------------------------------------------
1156+ 9795
1157+ 9795 3E 01            LD   A,TEAM_WHITE
1158+ 9797 32 E6 B1         LD   (Var_Game_VirtualPlayerTeam),A
1159+ 979A
1160+ 979A 3E 01            LD   A,1
1161+ 979C 32 E4 B1         LD   (Var_Game_VirtualPlayerYPos),A   ; Y=1
1162+ 979F 3E 04            LD   A,4
1163+ 97A1 32 E5 B1         LD   (Var_Game_VirtualPlayerXPos),A   ; X=4
1164+ 97A4
1165+ 97A4                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1166+ 97A4 CD 7D 96         CALL ClearAllPrevPositions
1167+ 97A7
1168+ 97A7 C9               RET
1169+ 97A8
1170+ 97A8              ; ---------------------------------------------------------------------------
1171+ 97A8              ; Sets restart-from-goal schema when BLACK team is defending and the
1172+ 97A8              ; active field side is NORTH.
1173+ 97A8              ;
1174+ 97A8              ; Player layout (Y=row, X=col):
1175+ 97A8              ;   - Black GK:        Y=0, X=2
1176+ 97A8              ;   - Black DEF:       Y=1, X=1 / X=2 / X=3
1177+ 97A8              ;   - White FWD:       Y=2, X=0 and Y=2, X=4
1178+ 97A8              ;   - White MID:       Y=4, X=3
1179+ 97A8              ;   - White GK:        Y=255 (hidden), X=2
1180+ 97A8              ;
1181+ 97A8              ; Virtual player:
1182+ 97A8              ;   Var_Game_VirtualPlayerTeam = TEAM_WHITE
1183+ 97A8              ;   Var_Game_VirtualPlayerYPos = 4
1184+ 97A8              ;   Var_Game_VirtualPlayerXPos = 1
1185+ 97A8              ;
1186+ 97A8              ; INPUT:
1187+ 97A8              ;   -
1188+ 97A8              ; OUTPUT:
1189+ 97A8              ;   Var_Game_ActiveFieldSide updated to FIELD_NORTH_SIDE
1190+ 97A8              ;   Var_Game_PlayersInfo filled for this schema
1191+ 97A8              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1192+ 97A8              ; MODIFIES:
1193+ 97A8              ;   AF, BC, DE, HL
1194+ 97A8              ; ---------------------------------------------------------------------------
1195+ 97A8              SetBlackRestartSchema:
1196+ 97A8 3E 00            LD   A, TEAM_BLACK
1197+ 97AA 32 E0 B1         LD   (Var_Game_TeamWithBall), A
1198+ 97AD
1199+ 97AD 16 00            LD     D, 0
1200+ 97AF 1E 02            LD     E, 2
1201+ 97B1 CD 58 95         CALL   Game_SetBallPosition
1202+ 97B4 3E FF            LD     A, 255
1203+ 97B6 32 F0 B1         LD     (Var_Game_BallYOldPosition ), A
1204+ 97B9 3E 00            LD     A, BALL_DIRECTION_NONE
1205+ 97BB 32 E2 B1         LD     (Var_Game_BallDirection),A
1206+ 97BE
1207+ 97BE                  ; Set active field side to NORTH
1208+ 97BE 3E 01            LD   A,FIELD_NORTH_SIDE
1209+ 97C0 32 C2 B1         LD   (Var_Game_ActiveFieldSide),A
1210+ 97C3
1211+ 97C3 3E 01            LD   A, YES
1212+ 97C5 32 E1 B1         LD   (Var_Game_GoalkeeperHasBall), A
1213+ 97C8
1214+ 97C8                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1215+ 97C8
1216+ 97C8                  ; Black GK, ID=0, Y=0, X=2
1217+ 97C8 06 00            LD   B,TEAM_BLACK
1218+ 97CA 0E 00            LD   C,0                  ; ID=0 (goalkeeper)
1219+ 97CC 16 00            LD   D,0                  ; Y
1220+ 97CE 1E 02            LD   E,2                  ; X
1221+ 97D0 CD ED 95         CALL SetPlayerInfo
1222+ 97D3
1223+ 97D3                  ; Black DEF 1, ID=1, Y=1, X=1
1224+ 97D3 06 00            LD   B,TEAM_BLACK
1225+ 97D5 0E 01            LD   C,1
1226+ 97D7 16 01            LD   D,1
1227+ 97D9 1E 01            LD   E,1
1228+ 97DB CD ED 95         CALL SetPlayerInfo
1229+ 97DE
1230+ 97DE                  ; Black DEF 2, ID=2, Y=1, X=2
1231+ 97DE 06 00            LD   B,TEAM_BLACK
1232+ 97E0 0E 02            LD   C,2
1233+ 97E2 16 01            LD   D,1
1234+ 97E4 1E 02            LD   E,2
1235+ 97E6 CD ED 95         CALL SetPlayerInfo
1236+ 97E9
1237+ 97E9                  ; Black DEF 3, ID=3, Y=1, X=3
1238+ 97E9 06 00            LD   B,TEAM_BLACK
1239+ 97EB 0E 03            LD   C,3
1240+ 97ED 16 01            LD   D,1
1241+ 97EF 1E 03            LD   E,3
1242+ 97F1 CD ED 95         CALL SetPlayerInfo
1243+ 97F4
1244+ 97F4                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1245+ 97F4
1246+ 97F4                  ; White GK hidden, ID=0, Y=255, X=2
1247+ 97F4 06 01            LD   B,TEAM_WHITE
1248+ 97F6 0E 00            LD   C,0
1249+ 97F8 16 FF            LD   D,255
1250+ 97FA 1E 02            LD   E,2
1251+ 97FC CD ED 95         CALL SetPlayerInfo
1252+ 97FF
1253+ 97FF                  ; White FWD 1, ID=1, Y=2, X=0
1254+ 97FF 06 01            LD   B,TEAM_WHITE
1255+ 9801 0E 01            LD   C,1
1256+ 9803 16 02            LD   D,2
1257+ 9805 1E 00            LD   E,0
1258+ 9807 CD ED 95         CALL SetPlayerInfo
1259+ 980A
1260+ 980A                  ; White FWD 2, ID=2, Y=2, X=4
1261+ 980A 06 01            LD   B,TEAM_WHITE
1262+ 980C 0E 02            LD   C,2
1263+ 980E 16 02            LD   D,2
1264+ 9810 1E 04            LD   E,4
1265+ 9812 CD ED 95         CALL SetPlayerInfo
1266+ 9815
1267+ 9815                  ; White MID, ID=3, Y=4, X=3
1268+ 9815 06 01            LD   B,TEAM_WHITE
1269+ 9817 0E 03            LD   C,3
1270+ 9819 16 04            LD   D,4
1271+ 981B 1E 03            LD   E,3
1272+ 981D CD ED 95         CALL SetPlayerInfo
1273+ 9820
1274+ 9820                  ; ---- VIRTUAL PLAYER ------------------------------------------
1275+ 9820
1276+ 9820 3E 01            LD   A,TEAM_WHITE
1277+ 9822 32 E6 B1         LD   (Var_Game_VirtualPlayerTeam),A
1278+ 9825
1279+ 9825 3E 04            LD   A,4
1280+ 9827 32 E4 B1         LD   (Var_Game_VirtualPlayerYPos),A   ; Y=4
1281+ 982A 3E 01            LD   A,1
1282+ 982C 32 E5 B1         LD   (Var_Game_VirtualPlayerXPos),A   ; X=1
1283+ 982F
1284+ 982F                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1285+ 982F CD 7D 96         CALL ClearAllPrevPositions
1286+ 9832
1287+ 9832 C9               RET
1288+ 9833
1289+ 9833              ; ---------------------------------------------------------------------------
1290+ 9833              ; Sets restart-from-goal schema when WHITE team is defending and the
1291+ 9833              ; active field side is SOUTH.
1292+ 9833              ;
1293+ 9833              ; Player layout (Y=row, X=col):
1294+ 9833              ;   - White GK:        Y=4, X=2
1295+ 9833              ;   - White DEF:       Y=3, X=1 / X=2 / X=3
1296+ 9833              ;   - Black FWD:       Y=2, X=0 and Y=2, X=4
1297+ 9833              ;   - Black MID:       Y=0, X=4
1298+ 9833              ;   - Black GK:        Y=255 (hidden), X=2
1299+ 9833              ;
1300+ 9833              ; Virtual player:
1301+ 9833              ;   Var_Game_VirtualPlayerTeam = TEAM_BLACK
1302+ 9833              ;   Var_Game_VirtualPlayerYPos = 0
1303+ 9833              ;   Var_Game_VirtualPlayerXPos = 0
1304+ 9833              ;
1305+ 9833              ; INPUT:
1306+ 9833              ;   -
1307+ 9833              ; OUTPUT:
1308+ 9833              ;   Var_Game_ActiveFieldSide updated to FIELD_SOUTH_SIDE
1309+ 9833              ;   Var_Game_PlayersInfo filled for this schema
1310+ 9833              ;   All previous positions cleared (PREV_X/PREV_Y = 255)
1311+ 9833              ; MODIFIES:
1312+ 9833              ;   AF, BC, DE, HL
1313+ 9833              ; ---------------------------------------------------------------------------
1314+ 9833              SetWhiteRestartSchema:
1315+ 9833 3E 01            LD   A, TEAM_WHITE
1316+ 9835 32 E0 B1         LD   (Var_Game_TeamWithBall), A
1317+ 9838 16 04            LD     D, 4
1318+ 983A 1E 02            LD     E, 2
1319+ 983C CD 58 95         CALL   Game_SetBallPosition
1320+ 983F 3E FF            LD     A, 255
1321+ 9841 32 F0 B1         LD     (Var_Game_BallYOldPosition ), A
1322+ 9844 3E 00            LD   A, BALL_DIRECTION_NONE
1323+ 9846 32 E2 B1         LD   (Var_Game_BallDirection),A
1324+ 9849
1325+ 9849                  ; Set active field side to SOUTH
1326+ 9849 3E 00            LD   A,FIELD_SOUTH_SIDE
1327+ 984B 32 C2 B1         LD   (Var_Game_ActiveFieldSide),A
1328+ 984E
1329+ 984E 3E 01            LD   A, YES
1330+ 9850 32 E1 B1         LD   (Var_Game_GoalkeeperHasBall), A
1331+ 9853
1332+ 9853                  ; ---- WHITE TEAM (TEAM_WHITE) ---------------------------------
1333+ 9853
1334+ 9853                  ; White GK, ID=0, Y=4, X=2
1335+ 9853 06 01            LD   B,TEAM_WHITE
1336+ 9855 0E 00            LD   C,0
1337+ 9857 16 04            LD   D,4
1338+ 9859 1E 02            LD   E,2
1339+ 985B CD ED 95         CALL SetPlayerInfo
1340+ 985E
1341+ 985E                  ; White DEF 1, ID=1, Y=3, X=1
1342+ 985E 06 01            LD   B,TEAM_WHITE
1343+ 9860 0E 01            LD   C,1
1344+ 9862 16 03            LD   D,3
1345+ 9864 1E 01            LD   E,1
1346+ 9866 CD ED 95         CALL SetPlayerInfo
1347+ 9869
1348+ 9869                  ; White DEF 2, ID=2, Y=3, X=2
1349+ 9869 06 01            LD   B,TEAM_WHITE
1350+ 986B 0E 02            LD   C,2
1351+ 986D 16 03            LD   D,3
1352+ 986F 1E 02            LD   E,2
1353+ 9871 CD ED 95         CALL SetPlayerInfo
1354+ 9874
1355+ 9874                  ; White DEF 3, ID=3, Y=3, X=3
1356+ 9874 06 01            LD   B,TEAM_WHITE
1357+ 9876 0E 03            LD   C,3
1358+ 9878 16 03            LD   D,3
1359+ 987A 1E 03            LD   E,3
1360+ 987C CD ED 95         CALL SetPlayerInfo
1361+ 987F
1362+ 987F                  ; ---- BLACK TEAM (TEAM_BLACK) ---------------------------------
1363+ 987F
1364+ 987F                  ; Black GK hidden, ID=0, Y=255, X=2
1365+ 987F 06 00            LD   B,TEAM_BLACK
1366+ 9881 0E 00            LD   C,0
1367+ 9883 16 FF            LD   D,255
1368+ 9885 1E 02            LD   E,2
1369+ 9887 CD ED 95         CALL SetPlayerInfo
1370+ 988A
1371+ 988A                  ; Black FWD 1, ID=1, Y=2, X=0
1372+ 988A 06 00            LD   B,TEAM_BLACK
1373+ 988C 0E 01            LD   C,1
1374+ 988E 16 02            LD   D,2
1375+ 9890 1E 00            LD   E,0
1376+ 9892 CD ED 95         CALL SetPlayerInfo
1377+ 9895
1378+ 9895                  ; Black FWD 2, ID=2, Y=2, X=4
1379+ 9895 06 00            LD   B,TEAM_BLACK
1380+ 9897 0E 02            LD   C,2
1381+ 9899 16 02            LD   D,2
1382+ 989B 1E 04            LD   E,4
1383+ 989D CD ED 95         CALL SetPlayerInfo
1384+ 98A0
1385+ 98A0                  ; Black MID, ID=3, Y=0, X=4
1386+ 98A0 06 00            LD   B,TEAM_BLACK
1387+ 98A2 0E 03            LD   C,3
1388+ 98A4 16 00            LD   D,0
1389+ 98A6 1E 03            LD   E,3
1390+ 98A8 CD ED 95         CALL SetPlayerInfo
1391+ 98AB
1392+ 98AB                  ; ---- VIRTUAL PLAYER ------------------------------------------
1393+ 98AB
1394+ 98AB 3E 00            LD   A,TEAM_BLACK
1395+ 98AD 32 E6 B1         LD   (Var_Game_VirtualPlayerTeam),A
1396+ 98B0
1397+ 98B0 AF               XOR  A
1398+ 98B1 32 E4 B1         LD   (Var_Game_VirtualPlayerYPos),A
1399+ 98B4 3E 01            LD   A, 1
1400+ 98B6 32 E5 B1         LD   (Var_Game_VirtualPlayerXPos),A
1401+ 98B9
1402+ 98B9                  ; ---- CLEAR PREVIOUS POSITIONS --------------------------------
1403+ 98B9 CD 7D 96         CALL ClearAllPrevPositions
1404+ 98BC
1405+ 98BC C9               RET
1406+ 98BD
1407+ 98BD
1408+ 98BD
1409+ 98BD              ; ---------------------------------------------------------------------------
1410+ 98BD              ; ResumeGame
1411+ 98BD              ;
1412+ 98BD              ; Decide il tipo di ripresa in base a:
1413+ 98BD              ;   - Var_Game_ActiveFieldSide
1414+ 98BD              ;   - posizione Y della palla
1415+ 98BD              ;
1416+ 98BD              ; Casi:
1417+ 98BD              ;   - Campo NORTH, BallY = 1 -> rimessa dal fondo NERA
1418+ 98BD              ;   - Campo SOUTH, BallY = 2 -> rimessa dal fondo BIANCA
1419+ 98BD              ;   - Campo SOUTH, BallY = 0 -> calcio d'inizio NERO
1420+ 98BD              ;   - Campo NORTH, BallY = 3 -> calcio d'inizio BIANCO
1421+ 98BD              ;
1422+ 98BD              ; In tutti i casi:
1423+ 98BD              ;   - sposta palla e giocatore centrale secondo le regole descritte
1424+ 98BD              ;   - Var_Game_VirtualPlayerYPos = 255 (virtual sparisce)
1425+ 98BD              ;   - Var_Game_BallDirection = BALL_DIRECTION_NONE
1426+ 98BD              ;   - Var_Game_GoalkeeperHasBall = NO
1427+ 98BD              ;   - chiama VDP_PlayerMatrixRedraw
1428+ 98BD              ;
1429+ 98BD              ; MODIFICA: AF, BC, DE, HL
1430+ 98BD              ; ---------------------------------------------------------------------------
1431+ 98BD              Game_Resume:
1432+ 98BD F5               push af
1433+ 98BE C5               push bc
1434+ 98BF D5               push de
1435+ 98C0 E5               push hl
1436+ 98C1
1437+ 98C1                  ; ---- palla ferma e nessun portiere con palla ----
1438+ 98C1 3E 00            ld   a,BALL_DIRECTION_NONE
1439+ 98C3 32 E2 B1         ld   (Var_Game_BallDirection),a
1440+ 98C6
1441+ 98C6 3E 00            ld   a,NO
1442+ 98C8 32 E1 B1         ld   (Var_Game_GoalkeeperHasBall),a
1443+ 98CB
1444+ 98CB                  ; ---- nascondi virtual player ----
1445+ 98CB                  ;ld   a,255
1446+ 98CB                  ;ld   (Var_Game_VirtualPlayerYPos),a
1447+ 98CB
1448+ 98CB                  ; ---- leggi posizione palla ----
1449+ 98CB CD 4D 95         call Game_GetBallPosition
1450+ 98CE                  ; salviamo Y in C per i confronti
1451+ 98CE 4A               ld   c,d                   ; C = Y
1452+ 98CF
1453+ 98CF                  ; ---- leggi direzione campo ----
1454+ 98CF 3A C2 B1         ld   a,(Var_Game_ActiveFieldSide)
1455+ 98D2 FE 01            cp   FIELD_NORTH_SIDE
1456+ 98D4 28 0B            jr   z,.field_north
1457+ 98D6
1458+ 98D6                  ; ===== FIELD_SOUTH_SIDE =====
1459+ 98D6              .field_south:
1460+ 98D6 79               ld   a,c                   ; A = BallY
1461+ 98D7 FE 04            cp   4
1462+ 98D9 28 11            jr   z,.white_goal_kick    ; rimessa dal fondo BIANCA
1463+ 98DB
1464+ 98DB FE 00            cp   0
1465+ 98DD 28 17            jr   z,.black_kickoff      ; calcio d'inizio NERO
1466+ 98DF
1467+ 98DF 18 20            jr   .resume_done          ; nessun caso riconosciuto
1468+ 98E1
1469+ 98E1                  ; ===== FIELD_NORTH_SIDE =====
1470+ 98E1              .field_north:
1471+ 98E1 79               ld   a,c                   ; A = BallY
1472+ 98E2 FE 00            cp   0
1473+ 98E4 28 0B            jr   z,.black_goal_kick    ; rimessa dal fondo NERA
1474+ 98E6
1475+ 98E6 FE 03            cp   3
1476+ 98E8 28 11            jr   z,.white_kickoff      ; calcio d'inizio BIANCO
1477+ 98EA
1478+ 98EA 18 15            jr   .resume_done          ; nessun caso riconosciuto
1479+ 98EC
1480+ 98EC              ; --- Rimessa dal fondo BIANCA (campo SOUTH, ballY = 2) ---
1481+ 98EC              .white_goal_kick:
1482+ 98EC CD 06 99         call Resume_WhiteGoalKick
1483+ 98EF 18 0D            jr   .after_case
1484+ 98F1
1485+ 98F1              ; --- Rimessa dal fondo NERA (campo NORTH, ballY = 1) ---
1486+ 98F1              .black_goal_kick:
1487+ 98F1 CD 56 99         call Resume_BlackGoalKick
1488+ 98F4 18 08            jr   .after_case
1489+ 98F6
1490+ 98F6              ; --- Calcio d'inizio NERO (campo SOUTH, ballY = 0) ---
1491+ 98F6              .black_kickoff:
1492+ 98F6 CD A6 99         call Resume_BlackKickoff
1493+ 98F9 18 03            jr   .after_case
1494+ 98FB
1495+ 98FB              ; --- Calcio d'inizio BIANCO (campo NORTH, ballY = 3) ---
1496+ 98FB              .white_kickoff:
1497+ 98FB CD EC 99         call Resume_WhiteKickoff
1498+ 98FE                  ; fall-through
1499+ 98FE
1500+ 98FE              .after_case:
1501+ 98FE
1502+ 98FE                  ; ridisegna i giocatori (la palla verrà ridisegnata nella nuova posizione)
1503+ 98FE CD D1 8E         call VDP_PlayerMatrixRedraw
1504+ 9901
1505+ 9901              .resume_done:
1506+ 9901 E1               pop  hl
1507+ 9902 D1               pop  de
1508+ 9903 C1               pop  bc
1509+ 9904 F1               pop  af
1510+ 9905                  ;call Hooks_TickStart
1511+ 9905 C9               ret
1512+ 9906
1513+ 9906              ; ---------------------------------------------------------------------------
1514+ 9906              ; Resume_WhiteGoalKick
1515+ 9906              ;
1516+ 9906              ; Schema atteso:
1517+ 9906              ;   - Palla:    Y=2, X=2
1518+ 9906              ;   - Bianchi:  Y=3, X=1,2,3   (centrale a 3,2)
1519+ 9906              ;
1520+ 9906              ; Azioni:
1521+ 9906              ;   - Palla -> (Y=2, X=1 o 3 a caso)
1522+ 9906              ;   - Giocatore centrale -> Y=1, X=random(0..4)
1523+ 9906              ; ---------------------------------------------------------------------------
1524+ 9906              Resume_WhiteGoalKick:
1525+ 9906 AF               XOR  A
1526+ 9907 32 ED B1         LD   (Var_Game_FirstKickFrameCounter), A
1527+ 990A 3E 03            LD   A, FIRST_KICK_TYPE_WHITE_BOTTOM_FIELD
1528+ 990C 32 EC B1         LD   (Var_Game_FirstKickType), A
1529+ 990F 16 02            LD   D, 2
1530+ 9911 1E 02            LD   E, 2
1531+ 9913 CD 58 95         CALL Game_SetBallPosition
1532+ 9916 CD D1 8E         CALL VDP_PlayerMatrixRedraw
1533+ 9919 C9               RET
1534+ 991A              .exec:
1535+ 991A CD 5C 8E         CALL  VDP_RemoveVirtualPlayer
1536+ 991D                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=2) ---
1537+ 991D CD 32 9A         call Game_GetRandomByte
1538+ 9920 E6 01            and  1
1539+ 9922 2E 01            ld   l,1                ; default X = 1
1540+ 9924 28 02            jr   z,.ball_pos_ok
1541+ 9926 2E 03            ld   l,3                ; X = 3
1542+ 9928              .ball_pos_ok:
1543+ 9928 26 02            ld   h,2                ; Y = 2
1544+ 992A E5               PUSH HL
1545+ 992B D1               POP  DE
1546+ 992C CD 58 95         call Game_SetBallPosition
1547+ 992F
1548+ 992F                  ; --- trova il giocatore centrale bianco (Y=3, X=2) ---
1549+ 992F 16 03            ld   d,3                ; Y=3
1550+ 9931 1E 02            ld   e,2                ; X=2
1551+ 9933 CD 2F 96         call Game_GetPlayerInfoByPos
1552+ 9936 FE FF            cp   NO_VALUE
1553+ 9938 C8               ret  z                  ; se non trovato, esci senza fare altro
1554+ 9939
1555+ 9939                  ; qui: B = TEAM, C = ID del giocatore centrale
1556+ 9939
1557+ 9939                  ; --- genera nuova X (0..4) e sposta a Y=1 ---
1558+ 9939 CD 38 9A         call Game_GetRandom0_4  ; A = 0..4
1559+ 993C 5F               ld   e,a                ; E = newX
1560+ 993D 16 01            ld   d,1                ; D = newY (1)
1561+ 993F CD ED 95         call SetPlayerInfo
1562+ 9942 3E 01            LD   A, YES
1563+ 9944 32 3D B2         LD   (Var_Hooks_ForceVdpRedraw), A
1564+ 9947 3E FF            LD   A, NO_VALUE
1565+ 9949 32 EC B1         LD   (Var_Game_FirstKickType), A
1566+ 994C CD 50 81         CALL Hooks_TickStart
1567+ 994F CD BD A9         call Game_PlayBeep
1568+ 9952 C3 0A 82         JP   VBlankISR.Exit
1569+ 9955 C9           	ret
1570+ 9956              ; ---------------------------------------------------------------------------
1571+ 9956              ; Resume_BlackGoalKick
1572+ 9956              ;
1573+ 9956              ; Schema atteso:
1574+ 9956              ;   - Palla:   Y=1, X=2
1575+ 9956              ;   - Neri:    Y=1, X=1,2,3   (centrale a 1,2)
1576+ 9956              ;
1577+ 9956              ; Azioni:
1578+ 9956              ;   - Palla -> (Y=1, X=1 o 3 a caso)
1579+ 9956              ;   - Giocatore centrale -> Y=3, X=random(0..4)
1580+ 9956              ; ---------------------------------------------------------------------------
1581+ 9956              Resume_BlackGoalKick:
1582+ 9956 AF               XOR  A
1583+ 9957 32 ED B1         LD   (Var_Game_FirstKickFrameCounter), A
1584+ 995A 3E 04            LD   A, FIRST_KICK_TYPE_BLACK_BOTTOM_FIELD
1585+ 995C 32 EC B1         LD   (Var_Game_FirstKickType), A
1586+ 995F 16 01            LD   D, 1
1587+ 9961 1E 02            LD   E, 2
1588+ 9963 CD 58 95         CALL Game_SetBallPosition
1589+ 9966 CD D1 8E         CALL VDP_PlayerMatrixRedraw
1590+ 9969 C9               ret
1591+ 996A              .exec:
1592+ 996A CD 5C 8E         CALL  VDP_RemoveVirtualPlayer
1593+ 996D                      ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=1) ---
1594+ 996D CD 32 9A         call Game_GetRandomByte
1595+ 9970 E6 01            and  1
1596+ 9972 2E 01            ld   l,1                ; default X = 1
1597+ 9974 28 02            jr   z,.ball_pos_ok
1598+ 9976 2E 03            ld   l,3                ; X = 3
1599+ 9978              .ball_pos_ok:
1600+ 9978 26 01            ld   h,1                ; Y = 1
1601+ 997A E5               PUSH HL
1602+ 997B D1               POP  DE
1603+ 997C CD 58 95         call Game_SetBallPosition
1604+ 997F
1605+ 997F                  ; --- trova il giocatore centrale nero (Y=1, X=2) ---
1606+ 997F 16 01            ld   d,1                ; Y=1
1607+ 9981 1E 02            ld   e,2                ; X=2
1608+ 9983 CD 2F 96         call Game_GetPlayerInfoByPos
1609+ 9986 FE FF            cp   NO_VALUE
1610+ 9988 C8               ret  z
1611+ 9989
1612+ 9989                  ; B = TEAM, C = ID del centrale
1613+ 9989
1614+ 9989                  ; --- genera nuova X (0..4) e sposta a Y=3 ---
1615+ 9989 CD 38 9A         call Game_GetRandom0_4
1616+ 998C 5F               ld   e,a                ; newX
1617+ 998D 16 03            ld   d,3                ; newY = 3
1618+ 998F CD ED 95         call SetPlayerInfo
1619+ 9992 3E 01            LD   A, YES
1620+ 9994 32 3D B2         LD   (Var_Hooks_ForceVdpRedraw), A
1621+ 9997 3E FF            LD   A, NO_VALUE
1622+ 9999 32 EC B1         LD   (Var_Game_FirstKickType), A
1623+ 999C CD 50 81         CALL Hooks_TickStart
1624+ 999F CD BD A9         call Game_PlayBeep
1625+ 99A2 C3 0A 82         JP   VBlankISR.Exit
1626+ 99A5 C9               ret
1627+ 99A6              ; ---------------------------------------------------------------------------
1628+ 99A6              ; Resume_BlackKickoff
1629+ 99A6              ;
1630+ 99A6              ; Schema atteso:
1631+ 99A6              ;   - Palla:   Y=0, X=2
1632+ 99A6              ;   - Neri:    Y=0, X=1,2,3   (centrale a 0,2)
1633+ 99A6              ;
1634+ 99A6              ; Azioni:
1635+ 99A6              ;   - Palla -> (Y=0, X=1 o 3 a caso)
1636+ 99A6              ;   - Giocatore centrale -> Y=2, X=random(0..4)
1637+ 99A6              ; ---------------------------------------------------------------------------
1638+ 99A6              Resume_BlackKickoff:
1639+ 99A6 AF               XOR  A
1640+ 99A7 32 ED B1         LD   (Var_Game_FirstKickFrameCounter), A
1641+ 99AA 3E 02            LD   A, FIRST_KICK_TYPE_BLACK_HALF_FIELD
1642+ 99AC 32 EC B1         LD   (Var_Game_FirstKickType), A
1643+ 99AF C9               RET
1644+ 99B0              .exec:
1645+ 99B0 CD 5C 8E         CALL  VDP_RemoveVirtualPlayer
1646+ 99B3                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=0) ---
1647+ 99B3 CD 32 9A         call Game_GetRandomByte
1648+ 99B6 E6 01            and  1
1649+ 99B8 2E 01            ld   l,1                ; default X = 1
1650+ 99BA 28 02            jr   z,.ball_pos_ok
1651+ 99BC 2E 03            ld   l,3                ; X = 3
1652+ 99BE              .ball_pos_ok:
1653+ 99BE 26 00            ld   h,0                ; Y = 0
1654+ 99C0 E5               PUSH HL
1655+ 99C1 D1               POP  DE
1656+ 99C2 CD 58 95         call Game_SetBallPosition
1657+ 99C5
1658+ 99C5                  ; --- trova il giocatore centrale nero (Y=0, X=2) ---
1659+ 99C5 16 00            ld   d,0                ; Y=0
1660+ 99C7 1E 02            ld   e,2                ; X=2
1661+ 99C9 CD 2F 96         call Game_GetPlayerInfoByPos
1662+ 99CC FE FF            cp   NO_VALUE
1663+ 99CE C8               ret  z
1664+ 99CF
1665+ 99CF                  ; B = TEAM, C = ID
1666+ 99CF
1667+ 99CF                  ; --- genera nuova X (0..4) e sposta a Y=2 ---
1668+ 99CF CD 38 9A         call Game_GetRandom0_4
1669+ 99D2 5F               ld   e,a                ; newX
1670+ 99D3 16 02            ld   d,2                ; newY = 2
1671+ 99D5 CD ED 95         call SetPlayerInfo
1672+ 99D8 3E 01            LD   A, YES
1673+ 99DA 32 3D B2         LD   (Var_Hooks_ForceVdpRedraw), A
1674+ 99DD 3E FF            LD   A, NO_VALUE
1675+ 99DF 32 EC B1         LD   (Var_Game_FirstKickType), A
1676+ 99E2 CD 50 81         CALL Hooks_TickStart
1677+ 99E5 CD BD A9         call Game_PlayBeep
1678+ 99E8 C3 0A 82         JP   VBlankISR.Exit
1679+ 99EB C9               ret
1680+ 99EC              ; ---------------------------------------------------------------------------
1681+ 99EC              ; Resume_WhiteKickoff
1682+ 99EC              ;
1683+ 99EC              ; Schema atteso:
1684+ 99EC              ;   - Palla:   Y=3, X=2
1685+ 99EC              ;   - Bianchi: Y=4, X=1,2,3   (centrale a 4,2)
1686+ 99EC              ;
1687+ 99EC              ; Azioni:
1688+ 99EC              ;   - Palla -> (Y=3, X=1 o 3 a caso)
1689+ 99EC              ;   - Giocatore centrale -> Y=2, X=random(0..4)
1690+ 99EC              ; ---------------------------------------------------------------------------
1691+ 99EC              Resume_WhiteKickoff:
1692+ 99EC AF               XOR  A
1693+ 99ED 32 ED B1         LD   (Var_Game_FirstKickFrameCounter), A
1694+ 99F0 3E 01            LD   A, FIRST_KICK_TYPE_WHITE_HALF_FIELD
1695+ 99F2 32 EC B1         LD   (Var_Game_FirstKickType), A
1696+ 99F5 C9               RET
1697+ 99F6              .exec:
1698+ 99F6 CD 5C 8E         CALL  VDP_RemoveVirtualPlayer
1699+ 99F9                  ; --- sposta la palla su colonna 1 o 3 della stessa riga (Y=3) ---
1700+ 99F9 CD 32 9A         call Game_GetRandomByte
1701+ 99FC E6 01            and  1
1702+ 99FE 2E 01            ld   l,1                ; default X = 1
1703+ 9A00 28 02            jr   z,.ball_pos_ok
1704+ 9A02 2E 03            ld   l,3                ; X = 3
1705+ 9A04              .ball_pos_ok:
1706+ 9A04 26 03            ld   h,3                ; Y = 3
1707+ 9A06 E5               PUSH HL
1708+ 9A07 D1               POP  DE
1709+ 9A08 CD 58 95         call Game_SetBallPosition
1710+ 9A0B
1711+ 9A0B                  ; --- trova il giocatore centrale bianco (Y=4, X=2) ---
1712+ 9A0B 16 04            ld   d,4                ; Y=4
1713+ 9A0D 1E 02            ld   e,2                ; X=2
1714+ 9A0F CD 2F 96         call Game_GetPlayerInfoByPos
1715+ 9A12 FE FF            cp   NO_VALUE
1716+ 9A14 C8               ret  z
1717+ 9A15
1718+ 9A15                  ; B = TEAM, C = ID
1719+ 9A15
1720+ 9A15                  ; --- genera nuova X (0..4) e sposta a Y=2 ---
1721+ 9A15 CD 38 9A         call Game_GetRandom0_4
1722+ 9A18 5F               ld   e,a                ; newX
1723+ 9A19 16 02            ld   d,2                ; newY = 2
1724+ 9A1B CD ED 95         call SetPlayerInfo
1725+ 9A1E 3E 01            LD   A, YES
1726+ 9A20 32 3D B2         LD   (Var_Hooks_ForceVdpRedraw), A
1727+ 9A23 3E FF            LD   A, NO_VALUE
1728+ 9A25 32 EC B1         LD   (Var_Game_FirstKickType), A
1729+ 9A28 CD 50 81         CALL Hooks_TickStart
1730+ 9A2B CD BD A9         call Game_PlayBeep
1731+ 9A2E C3 0A 82         JP   VBlankISR.Exit
1732+ 9A31 C9               ret
1733+ 9A32
1734+ 9A32              ; ---------------------------------------------------------------------------
1735+ 9A32              ; Game_GetRandomByte
1736+ 9A32              ; Restituisce 0..255 utilizzando Utils_GetRandomNumber (0..127)
1737+ 9A32              ; MODIFIES: AF, BC
1738+ 9A32              ; ---------------------------------------------------------------------------
1739+ 9A32              Game_GetRandomByte:
1740+ 9A32 CD 0F 93         CALL Utils_GetRandomNumber     ; A = 0..127
1741+ 9A35 CB 27            SLA  A                         ; 0..254 (raddoppio)
1742+ 9A37 C9               RET
1743+ 9A38              ; ---------------------------------------------------------------------------
1744+ 9A38              ; Game_GetRandom0_4
1745+ 9A38              ; Restituisce A = 0..4
1746+ 9A38              ; MODIFIES: AF
1747+ 9A38              ; ---------------------------------------------------------------------------
1748+ 9A38              Game_GetRandom0_4:
1749+ 9A38 C5               PUSH BC
1750+ 9A39 D5               PUSH DE
1751+ 9A3A E5               PUSH HL
1752+ 9A3B CD 0F 93         CALL Utils_GetRandomNumber     ; A = 0..127
1753+ 9A3E
1754+ 9A3E                  ; riduci a 0..7 (modulo 8)
1755+ 9A3E E6 07            AND  00000111b                 ; 0..7
1756+ 9A40
1757+ 9A40 FE 05            CP   5
1758+ 9A42 38 02            JR   C,.ok                     ; 0..4 → ok
1759+ 9A44 D6 05            SUB  5                         ; 5,6,7 → 0,1,2
1760+ 9A46              .ok:
1761+ 9A46 E1               POP  HL
1762+ 9A47 D1               POP  DE
1763+ 9A48 C1               POP  BC
1764+ 9A49 C9               RET
1765+ 9A4A
1766+ 9A4A              ; ---------------------------------------------------------------------------
1767+ 9A4A              ; Game_GetRandom0_20
1768+ 9A4A              ; Restituisce A = 0..20
1769+ 9A4A              ; Usa Utils_GetRandomNumber (0..127)
1770+ 9A4A              ; MODIFIES: AF
1771+ 9A4A              ; ---------------------------------------------------------------------------
1772+ 9A4A              Game_GetRandom0_20:
1773+ 9A4A C5               PUSH BC
1774+ 9A4B              .loop:
1775+ 9A4B CD 0F 93         CALL Utils_GetRandomNumber     ; A = 0..127
1776+ 9A4E FE 69            CP   105                       ; 105 = 21 * 5
1777+ 9A50 30 F9            JR   NC,.loop                  ; scarta 105..127
1778+ 9A52                  ; A = 0..104
1779+ 9A52 06 15            LD   B,21
1780+ 9A54                  ; A mod 21
1781+ 9A54              .mod:
1782+ 9A54 90               SUB  B
1783+ 9A55 30 FD            JR   NC,.mod
1784+ 9A57 80               ADD  B                         ; ripristina ultimo valido
1785+ 9A58 C1               POP  BC
1786+ 9A59 C9               RET
1787+ 9A5A
1788+ 9A5A
1789+ 9A5A
1790+ 9A5A
1791+ 9A5A
1792+ 9A5A              ; ---------------------------------------------------------------------------
1793+ 9A5A              ; Game_GetPlayerIdWithBall
1794+ 9A5A              ;
1795+ 9A5A              ; Determina chi possiede la palla (se qualcuno) a seconda della posizione
1796+ 9A5A              ; della palla e dei giocatori.
1797+ 9A5A              ;
1798+ 9A5A              ; OUTPUT:
1799+ 9A5A              ;   A = TEAM_BLACK / TEAM_WHITE
1800+ 9A5A              ;       oppure BALL_STATUS_MOVING / BALL_STATUS_FREE / BALL_STATUS_CONTENDED
1801+ 9A5A              ;   H = ID giocatore che possiede la palla (0..3) oppure 255 se nessuno
1802+ 9A5A              ;   L = ID eventuale contendente (per ora sempre 255 nei casi definiti)
1803+ 9A5A              ;
1804+ 9A5A              ; MODIFIES:
1805+ 9A5A              ;   AF, BC, DE, HL
1806+ 9A5A              ; ---------------------------------------------------------------------------
1807+ 9A5A              Game_GetPlayerIdWithBall:
1808+ 9A5A                  ; default: nessuno
1809+ 9A5A 26 FF            ld   h,255
1810+ 9A5C 2E FF            ld   l,255
1811+ 9A5E
1812+ 9A5E                  ; --- 1) se la palla è in movimento, nessun possesso -------------------
1813+ 9A5E 3A E2 B1         ld   a,(Var_Game_BallDirection)
1814+ 9A61 FE 00            cp   BALL_DIRECTION_NONE
1815+ 9A63 28 03            jr   z,.check_static
1816+ 9A65 3E 64            ld   a,BALL_STATUS_MOVING
1817+ 9A67 C9               ret
1818+ 9A68
1819+ 9A68              .check_static:
1820+ 9A68                  ; --- 2) HL = X,Y della palla -----------------------------------------
1821+ 9A68 CD 4D 95         call  Game_GetBallPosition
1822+ 9A6B D5               PUSH  DE
1823+ 9A6C E1               POP   HL
1824+ 9A6D                  ; azzera i flag temporanei
1825+ 9A6D AF               xor  a
1826+ 9A6E 32 C7 B1         ld   (Var_Game_BallTmp_FoundBelow),a
1827+ 9A71 32 CA B1         ld   (Var_Game_BallTmp_FoundAbove),a
1828+ 9A74
1829+ 9A74                  ; salviamo la posizione della palla
1830+ 9A74 E5               push hl                     ; [SP] = X,Y
1831+ 9A75
1832+ 9A75                  ; ============================================================
1833+ 9A75                  ; Test 1: stessa cella della palla (giocatore nero, se presente)
1834+ 9A75                  ; ============================================================
1835+ 9A75                  ; D = Y, E = X
1836+ 9A75 54               ld   d,h
1837+ 9A76 5D               ld   e,l
1838+ 9A77 CD 2F 96         call Game_GetPlayerInfoByPos
1839+ 9A7A FE FF            cp   NO_VALUE
1840+ 9A7C 28 0D            jr   z,.no_player_below
1841+ 9A7E
1842+ 9A7E                  ; trovato giocatore "sotto" (in stessa cella della palla)
1843+ 9A7E 3E 01            ld   a,1
1844+ 9A80 32 C7 B1         ld   (Var_Game_BallTmp_FoundBelow),a
1845+ 9A83 78               ld   a,b
1846+ 9A84 32 CC B1         ld   (Var_Game_BallTmp_TeamBelow),a
1847+ 9A87 79               ld   a,c
1848+ 9A88 32 CD B1         ld   (Var_Game_BallTmp_IdBelow),a
1849+ 9A8B
1850+ 9A8B              .no_player_below:
1851+ 9A8B
1852+ 9A8B                  ; ============================================================
1853+ 9A8B                  ; Test 2: riga successiva stessa colonna (giocatore bianco, se presente)
1854+ 9A8B                  ; ============================================================
1855+ 9A8B E1               pop  hl                     ; HL = X,Y (ripristinato)
1856+ 9A8C E5               push hl                     ; lo risalviamo per sicurezza (anche se poi non lo useremo più)
1857+ 9A8D
1858+ 9A8D 7C               ld   a,h                    ; A = Y
1859+ 9A8E FE 04            cp   4
1860+ 9A90 28 17            jr   z,.no_player_above     ; se Y=4, non esiste Y+1 nel campo 0..4
1861+ 9A92
1862+ 9A92 3C               inc  a                      ; Y+1
1863+ 9A93 57               ld   d,a                    ; D = Y+1
1864+ 9A94 5D               ld   e,l                    ; E = X
1865+ 9A95 CD 2F 96         call Game_GetPlayerInfoByPos
1866+ 9A98 FE FF            cp   NO_VALUE
1867+ 9A9A 28 0D            jr   z,.no_player_above
1868+ 9A9C
1869+ 9A9C                  ; trovato giocatore "sopra" (in riga successiva)
1870+ 9A9C 3E 01            ld   a,1
1871+ 9A9E 32 CA B1         ld   (Var_Game_BallTmp_FoundAbove),a
1872+ 9AA1 78               ld   a,b
1873+ 9AA2 32 CB B1         ld   (Var_Game_BallTmp_TeamAbove),a
1874+ 9AA5 79               ld   a,c
1875+ 9AA6 32 CE B1         ld   (Var_Game_BallTmp_IdAbove),a
1876+ 9AA9
1877+ 9AA9              .no_player_above:
1878+ 9AA9 E1               pop  hl                     ; buttiamo via la copia di sicurezza
1879+ 9AAA
1880+ 9AAA                  ; ============================================================
1881+ 9AAA                  ; 3) Valutazione combinazioni
1882+ 9AAA                  ; ============================================================
1883+ 9AAA
1884+ 9AAA                  ; carichiamo flag in A/B solo per facilità
1885+ 9AAA 3A C7 B1         ld   a,(Var_Game_BallTmp_FoundBelow)
1886+ 9AAD 47               ld   b,a                     ; B = foundBelow (0/1)
1887+ 9AAE 3A CA B1         ld   a,(Var_Game_BallTmp_FoundAbove)
1888+ 9AB1 4F               ld   c,a                     ; C = foundAbove (0/1)
1889+ 9AB2
1890+ 9AB2                  ; caso: nessuno dei due
1891+ 9AB2 78               ld   a,b
1892+ 9AB3 B1               or   c
1893+ 9AB4 20 07            jr   nz,.not_free
1894+ 9AB6
1895+ 9AB6                  ; nessun giocatore sotto né sopra
1896+ 9AB6 3E 66            ld   a,BALL_STATUS_FREE
1897+ 9AB8 26 FF            ld   h,255
1898+ 9ABA 2E FF            ld   l,255
1899+ 9ABC C9               ret
1900+ 9ABD
1901+ 9ABD              .not_free:
1902+ 9ABD                  ; caso: entrambi presenti → palla contesa
1903+ 9ABD 78               ld   a,b                     ; A = foundBelow
1904+ 9ABE A1               and  c                       ; A = 1 solo se entrambi sono 1
1905+ 9ABF 28 07            jr   z,.single_side
1906+ 9AC1
1907+ 9AC1                  ; palla contesa tra nero e bianco
1908+ 9AC1 3E 65            ld   a,BALL_STATUS_CONTENDED
1909+ 9AC3 26 FF            ld   h,255
1910+ 9AC5 2E FF            ld   l,255
1911+ 9AC7 C9               ret
1912+ 9AC8
1913+ 9AC8              .single_side:
1914+ 9AC8                  ; se qui: esattamente uno dei due è 1.
1915+ 9AC8
1916+ 9AC8                  ; se foundBelow = 1 (giocatore nella cella della palla) → nero
1917+ 9AC8 78               ld   a,b
1918+ 9AC9 B7               or   a
1919+ 9ACA 28 0A            jr   z,.only_above
1920+ 9ACC
1921+ 9ACC                  ; --- solo giocatore nella cella della palla (nero) --------------------
1922+ 9ACC 3A CD B1         ld   a,(Var_Game_BallTmp_IdBelow)    ; ID
1923+ 9ACF 67               ld   h,a
1924+ 9AD0 3A CC B1         ld   a,(Var_Game_BallTmp_TeamBelow)  ; TEAM (tipicamente TEAM_BLACK)
1925+ 9AD3
1926+ 9AD3 2E FF            ld   l,255
1927+ 9AD5 C9               ret
1928+ 9AD6
1929+ 9AD6              .only_above:
1930+ 9AD6                  ; --- solo giocatore nella riga successiva (bianco) --------------------
1931+ 9AD6 3A CE B1         ld   a,(Var_Game_BallTmp_IdAbove)    ; ID
1932+ 9AD9 67               ld   h,a
1933+ 9ADA 3A CB B1         ld   a,(Var_Game_BallTmp_TeamAbove)  ; TEAM (tipicamente TEAM_WHITE)
1934+ 9ADD
1935+ 9ADD 2E FF            ld   l,255
1936+ 9ADF C9               ret
1937+ 9AE0              ; ---------------------------------------------------------------------------
1938+ 9AE0              ; Game_TryMovePlayerVertically
1939+ 9AE0              ;
1940+ 9AE0              ; INPUT:
1941+ 9AE0              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
1942+ 9AE0              ;   C = ID    (0..3)
1943+ 9AE0              ;   A = direzione richiesta:
1944+ 9AE0              ;       PLAYER_ASKED_DIRECTION_NORTH
1945+ 9AE0              ;       PLAYER_ASKED_DIRECTION_SOUTH
1946+ 9AE0              ;
1947+ 9AE0              ; OUTPUT:
1948+ 9AE0              ;   A = SUCCESS oppure FAILURE
1949+ 9AE0              ;
1950+ 9AE0              ; MODIFIES:
1951+ 9AE0              ;   AF, BC, DE, HL
1952+ 9AE0              ; ---------------------------------------------------------------------------
1953+ 9AE0              Game_TryMovePlayerVertically:
1954+ 9AE0                  ; Salva la direzione richiesta
1955+ 9AE0 F5               push af              ; [SP] = dir
1956+ 9AE1
1957+ 9AE1
1958+ 9AE1                  ; --- i portieri NON possono muoversi verticalmente ---
1959+ 9AE1 79               ld   a,c
1960+ 9AE2 B7               or   a
1961+ 9AE3 C2 EA 9A         jp   nz, .gtmv_not_goalkeeper
1962+ 9AE6
1963+ 9AE6                  ; ID=0 → portiere → FALLISCE
1964+ 9AE6 F1               pop  af              ; rimuovi dir dallo stack
1965+ 9AE7 3E 00            ld   a,FAILURE
1966+ 9AE9 C9               ret
1967+ 9AEA
1968+ 9AEA              .gtmv_not_goalkeeper:
1969+ 9AEA                  ; --- verifica che il giocatore NON abbia la palla ---
1970+ 9AEA C5               push bc              ; salva TEAM/ID per il confronto
1971+ 9AEB CD 5A 9A         call Game_GetPlayerIdWithBall
1972+ 9AEE                  ; Risultato:
1973+ 9AEE                  ;   A = stato/team (TEAM_BLACK/TEAM_WHITE o BALL_STATUS_xxx)
1974+ 9AEE                  ;   H = ID del giocatore in possesso (o 255)
1975+ 9AEE                  ;   L = ID contendente (o 255)
1976+ 9AEE C1               pop  bc              ; ripristina B=TEAM, C=ID del giocatore richiesto
1977+ 9AEF FE 65            CP   BALL_STATUS_CONTENDED
1978+ 9AF1 20 04            JR   NZ, .no_contended_ball
1979+ 9AF3
1980+ 9AF3 F1               pop  af              ; rimuovi dir dallo stack
1981+ 9AF4 3E 00            ld   a,FAILURE
1982+ 9AF6 C9               ret
1983+ 9AF7
1984+ 9AF7              .no_contended_ball:
1985+ 9AF7                  ; Se A è TEAM_BLACK o TEAM_WHITE e (A==B e H==C) → ha la palla
1986+ 9AF7 57               ld   d,a             ; D = stato/team
1987+ 9AF8
1988+ 9AF8
1989+ 9AF8 FE 00            cp   TEAM_BLACK
1990+ 9AFA CA 02 9B         jp   z, .gtmv_check_owner_team
1991+ 9AFD FE 01            cp   TEAM_WHITE
1992+ 9AFF C2 0F 9B         jp   nz, .gtmv_no_ball_owned   ; stato non è un team → nessuno in possesso
1993+ 9B02
1994+ 9B02              .gtmv_check_owner_team:
1995+ 9B02                  ; A = TEAM_BLACK o TEAM_WHITE, D = stesso valore
1996+ 9B02 B8               cp   b
1997+ 9B03 C2 0F 9B         jp   nz, .gtmv_no_ball_owned   ; altra squadra
1998+ 9B06
1999+ 9B06                  ; stessa squadra, confronta ID
2000+ 9B06 7C               ld   a,h                       ; H = ID possessore
2001+ 9B07 B9               cp   c
2002+ 9B08 C2 0F 9B         jp   nz, .gtmv_no_ball_owned   ; non è il nostro giocatore
2003+ 9B0B
2004+ 9B0B                  ; --- il giocatore richiesto ha la palla → non può muoversi verticalmente ---
2005+ 9B0B F1               pop  af                        ; rimuovi dir dallo stack
2006+ 9B0C 3E 00            ld   a,FAILURE
2007+ 9B0E C9               ret
2008+ 9B0F
2009+ 9B0F              .gtmv_no_ball_owned:
2010+ 9B0F                  ; --- recupera posizione corrente del giocatore ---
2011+ 9B0F CD 14 96         call Game_GetPlayerInfoById    ; HL = curr (H=Y, L=X)
2012+ 9B12
2013+ 9B12 E5               push hl
2014+ 9B13 D1               pop de                        ; DE = curr (D=currY, E=currX)
2015+ 9B14 CD B3 9C         CALL CheckBallAtPosition
2016+ 9B17 FE 01            CP   YES
2017+ 9B19 CA B0 9C         jp   z, .gtmv_fail_pop        ; palla sulla posizione corrente
2018+ 9B1C                  ; HL: H = currY, L = currX
2019+ 9B1C F1               pop  af                        ; A = direzione richiesta
2020+ 9B1D 57               ld   d,a                       ; D = direzione
2021+ 9B1E                  ; H = currY, L = currX, B = TEAM, C = ID
2022+ 9B1E
2023+ 9B1E                  ; --- controlla metà campo attiva ---
2024+ 9B1E 3A C2 B1         ld   a,(Var_Game_ActiveFieldSide)
2025+ 9B21 FE 01            cp   FIELD_NORTH_SIDE
2026+ 9B23 CA E4 9B         jp   z, .gtmv_side_north
2027+ 9B26
2028+ 9B26                  ; --------- FIELD_SOUTH_SIDE ---------------------------------
2029+ 9B26              .gtmv_side_south:
2030+ 9B26 78               ld   a,b
2031+ 9B27 FE 01            cp   TEAM_WHITE
2032+ 9B29 CA 88 9B         jp   z, .gtmv_south_white
2033+ 9B2C
2034+ 9B2C                  ; ----- TEAM_BLACK, FIELD_SOUTH_SIDE -----
2035+ 9B2C 7A               ld   a,d                      ; direzione
2036+ 9B2D FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2037+ 9B2F CA 3A 9B         jp   z, .gtmv_sb_move_up
2038+ 9B32 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2039+ 9B34 CA 61 9B         jp   z, .gtmv_sb_move_down
2040+ 9B37 C3 AD 9C         jp   .gtmv_fail               ; direzione invalida
2041+ 9B3A
2042+ 9B3A              ; Nero, campo SOUTH, move NORTH:
2043+ 9B3A              ; deve essere su riga 2, target riga 0
2044+ 9B3A              .gtmv_sb_move_up:
2045+ 9B3A 7C               ld   a,h                      ; currY
2046+ 9B3B FE 02            cp   2
2047+ 9B3D C2 AD 9C         jp   nz, .gtmv_fail
2048+ 9B40
2049+ 9B40                  ; verifica che in (Y=0, X=L) non ci sia nessun giocatore
2050+ 9B40 16 00            ld   d,0                      ; targetY
2051+ 9B42 5D               ld   e,l                      ; targetX = currX
2052+ 9B43 C5               push bc
2053+ 9B44 E5               push hl
2054+ 9B45 CD 2F 96         call Game_GetPlayerInfoByPos
2055+ 9B48 E1               pop  hl
2056+ 9B49 C1               pop  bc
2057+ 9B4A FE FF            cp   NO_VALUE
2058+ 9B4C C2 AD 9C         jp   nz, .gtmv_fail           ; cella occupata
2059+ 9B4F
2060+ 9B4F                  ; verifica che in (Y=0, X=L) non ci sia la palla
2061+ 9B4F                  ;ld   d,0
2062+ 9B4F                  ;ld   e,l
2063+ 9B4F                  ;CALL CheckBallAtPosition
2064+ 9B4F                  ;CP   NO
2065+ 9B4F                  ;jp   z, .no_ball_sb_up
2066+ 9B4F                  ;jp   .gtmv_fail               ; palla sulla destinazione
2067+ 9B4F
2068+ 9B4F              .no_ball_sb_up:
2069+ 9B4F                  ; conta i compagni sulla riga 0
2070+ 9B4F C5               push bc
2071+ 9B50 16 00            ld   d,0
2072+ 9B52 CD 1D 9E         call Game_CountTeamPlayersOnRow
2073+ 9B55 C1               pop  bc
2074+ 9B56 FE 02            cp   2
2075+ 9B58 D2 AD 9C         jp   nc, .gtmv_fail           ; già 2 → non possiamo aggiungerne un terzo
2076+ 9B5B
2077+ 9B5B                  ; sposta il giocatore a (0, X)
2078+ 9B5B 16 00            ld   d,0
2079+ 9B5D 5D               ld   e,l
2080+ 9B5E                  ;call SetPlayerInfo
2081+ 9B5E C3 A2 9C         jp   .gtmv_success
2082+ 9B61
2083+ 9B61              ; Nero, campo SOUTH, move SOUTH:
2084+ 9B61              ; deve essere su riga 0, target riga 2
2085+ 9B61              .gtmv_sb_move_down:
2086+ 9B61 7C               ld   a,h                      ; currY
2087+ 9B62 FE 00            cp   0
2088+ 9B64 C2 AD 9C         jp   nz, .gtmv_fail
2089+ 9B67
2090+ 9B67 16 02            ld   d,2
2091+ 9B69 5D               ld   e,l
2092+ 9B6A C5               push bc
2093+ 9B6B E5               push hl
2094+ 9B6C CD 2F 96         call Game_GetPlayerInfoByPos
2095+ 9B6F E1               pop  hl
2096+ 9B70 C1               pop  bc
2097+ 9B71 FE FF            cp   NO_VALUE
2098+ 9B73 C2 AD 9C         jp   nz, .gtmv_fail
2099+ 9B76
2100+ 9B76                  ;; verifica palla in (2, currX)
2101+ 9B76                  ;ld   d,2
2102+ 9B76                  ;ld   e,l
2103+ 9B76                  ;CALL CheckBallAtPosition
2104+ 9B76                  ;CP   NO
2105+ 9B76                  ;jp   z, .no_ball_sb_down
2106+ 9B76                  ;jp   .gtmv_fail
2107+ 9B76
2108+ 9B76              .no_ball_sb_down:
2109+ 9B76                  ; conta i compagni sulla riga 2
2110+ 9B76 C5               push bc
2111+ 9B77 16 02            ld   d,2
2112+ 9B79 CD 1D 9E         call Game_CountTeamPlayersOnRow
2113+ 9B7C C1               pop  bc
2114+ 9B7D FE 02            cp   2
2115+ 9B7F D2 AD 9C         jp   nc, .gtmv_fail
2116+ 9B82
2117+ 9B82 16 02            ld   d,2
2118+ 9B84 5D               ld   e,l
2119+ 9B85                  ;call SetPlayerInfo
2120+ 9B85 C3 A2 9C         jp   .gtmv_success
2121+ 9B88
2122+ 9B88              ; ----- TEAM_WHITE, FIELD_SOUTH_SIDE -----
2123+ 9B88              .gtmv_south_white:
2124+ 9B88 7A               ld   a,d                      ; direzione
2125+ 9B89 FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2126+ 9B8B CA 96 9B         jp   z, .gtmv_sw_move_up
2127+ 9B8E FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2128+ 9B90 CA BD 9B         jp   z, .gtmv_sw_move_down
2129+ 9B93 C3 AD 9C         jp   .gtmv_fail
2130+ 9B96
2131+ 9B96              ; Bianco, campo SOUTH, move NORTH:
2132+ 9B96              ; deve essere su riga 3, target riga 1
2133+ 9B96              .gtmv_sw_move_up:
2134+ 9B96 7C               ld   a,h                      ; currY
2135+ 9B97 FE 03            cp   3
2136+ 9B99 C2 AD 9C         jp   nz, .gtmv_fail
2137+ 9B9C
2138+ 9B9C
2139+ 9B9C 16 01            ld   d,1
2140+ 9B9E 5D               ld   e,l
2141+ 9B9F C5               push bc
2142+ 9BA0 E5               push hl
2143+ 9BA1 CD 2F 96         call Game_GetPlayerInfoByPos
2144+ 9BA4 E1               pop  hl
2145+ 9BA5 C1               pop  bc
2146+ 9BA6 FE FF            cp   NO_VALUE
2147+ 9BA8
2148+ 9BA8 C2 AD 9C         jp   nz, .gtmv_fail
2149+ 9BAB
2150+ 9BAB                  ; verifica palla in (1, currX)
2151+ 9BAB                  ;ld   d,1
2152+ 9BAB                  ;ld   e,l
2153+ 9BAB                  ;CALL CheckBallAtPosition
2154+ 9BAB                  ;CP   NO
2155+ 9BAB                  ;jp   z, .no_ball_sw_up
2156+ 9BAB                  ;jp   .gtmv_fail
2157+ 9BAB
2158+ 9BAB              .no_ball_sw_up:
2159+ 9BAB                  ; conta i compagni sulla riga 1
2160+ 9BAB C5               push bc
2161+ 9BAC 16 01            ld   d,1
2162+ 9BAE CD 1D 9E         call Game_CountTeamPlayersOnRow
2163+ 9BB1 C1               pop  bc
2164+ 9BB2 FE 02            cp   2
2165+ 9BB4 D2 AD 9C         jp   nc, .gtmv_fail
2166+ 9BB7
2167+ 9BB7 16 01            ld   d,1
2168+ 9BB9 5D               ld   e,l
2169+ 9BBA                  ;call SetPlayerInfo
2170+ 9BBA C3 A2 9C         jp   .gtmv_success
2171+ 9BBD
2172+ 9BBD              ; Bianco, campo SOUTH, move SOUTH:
2173+ 9BBD              ; deve essere su riga 1, target riga 3
2174+ 9BBD              .gtmv_sw_move_down:
2175+ 9BBD 7C               ld   a,h                      ; currY
2176+ 9BBE FE 01            cp   1
2177+ 9BC0 C2 AD 9C         jp   nz, .gtmv_fail
2178+ 9BC3
2179+ 9BC3
2180+ 9BC3 16 03            ld   d,3
2181+ 9BC5 5D               ld   e,l
2182+ 9BC6 C5               push bc
2183+ 9BC7 E5               push hl
2184+ 9BC8 CD 2F 96         call Game_GetPlayerInfoByPos
2185+ 9BCB E1               pop  hl
2186+ 9BCC C1               pop  bc
2187+ 9BCD
2188+ 9BCD FE FF            cp   NO_VALUE
2189+ 9BCF
2190+ 9BCF C2 AD 9C         jp   nz, .gtmv_fail
2191+ 9BD2
2192+ 9BD2                  ; verifica palla in (3, currX)
2193+ 9BD2                  ;ld   d,3
2194+ 9BD2                  ;ld   e,l
2195+ 9BD2                  ;CALL CheckBallAtPosition
2196+ 9BD2                  ;CP   NO
2197+ 9BD2                  ;jp   z, .no_ball_sw_down
2198+ 9BD2                  ;jp   .gtmv_fail
2199+ 9BD2
2200+ 9BD2              .no_ball_sw_down:
2201+ 9BD2                  ; conta i compagni sulla riga 3
2202+ 9BD2 C5               push bc
2203+ 9BD3 16 03            ld   d,3
2204+ 9BD5 CD 1D 9E         call Game_CountTeamPlayersOnRow
2205+ 9BD8 C1               pop  bc
2206+ 9BD9 FE 02            cp   2
2207+ 9BDB D2 AD 9C         jp   nc, .gtmv_fail
2208+ 9BDE
2209+ 9BDE 16 03            ld   d,3
2210+ 9BE0 5D               ld   e,l
2211+ 9BE1                  ;call SetPlayerInfo
2212+ 9BE1 C3 A2 9C         jp   .gtmv_success
2213+ 9BE4
2214+ 9BE4
2215+ 9BE4              ; --------- FIELD_NORTH_SIDE ------------------------------------
2216+ 9BE4              .gtmv_side_north:
2217+ 9BE4 78               ld   a,b
2218+ 9BE5 FE 01            cp   TEAM_WHITE
2219+ 9BE7 CA 46 9C         jp   z, .gtmv_north_white
2220+ 9BEA
2221+ 9BEA                  ; ----- TEAM_BLACK, FIELD_NORTH_SIDE -----
2222+ 9BEA 7A               ld   a,d                      ; direzione
2223+ 9BEB FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2224+ 9BED CA F8 9B         jp   z, .gtmv_nb_move_up
2225+ 9BF0 FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2226+ 9BF2 CA 1F 9C         jp   z, .gtmv_nb_move_down
2227+ 9BF5 C3 AD 9C         jp   .gtmv_fail
2228+ 9BF8
2229+ 9BF8              ; Nero, campo NORTH, move NORTH:
2230+ 9BF8              ; deve essere su riga 3, target riga 1
2231+ 9BF8              .gtmv_nb_move_up:
2232+ 9BF8 7C               ld   a,h                      ; currY
2233+ 9BF9 FE 03            cp   3
2234+ 9BFB C2 AD 9C         jp   nz, .gtmv_fail
2235+ 9BFE
2236+ 9BFE
2237+ 9BFE 16 01            ld   d,1
2238+ 9C00 5D               ld   e,l
2239+ 9C01 C5               push bc
2240+ 9C02 E5               push hl
2241+ 9C03 CD 2F 96         call Game_GetPlayerInfoByPos
2242+ 9C06 E1               pop  hl
2243+ 9C07 C1               pop  bc
2244+ 9C08 FE FF            cp   NO_VALUE
2245+ 9C0A
2246+ 9C0A C2 AD 9C         jp   nz, .gtmv_fail
2247+ 9C0D
2248+ 9C0D                  ; verifica palla in (1, currX)
2249+ 9C0D                  ;ld   d,1
2250+ 9C0D                  ;ld   e,l
2251+ 9C0D                  ;CALL CheckBallAtPosition
2252+ 9C0D                  ;CP   NO
2253+ 9C0D                  ;jp   z, .no_ball_nb_up
2254+ 9C0D                  ;jp   .gtmv_fail
2255+ 9C0D
2256+ 9C0D              .no_ball_nb_up:
2257+ 9C0D                  ; conta i compagni sulla riga 1
2258+ 9C0D C5               push bc
2259+ 9C0E 16 01            ld   d,1
2260+ 9C10 CD 1D 9E         call Game_CountTeamPlayersOnRow
2261+ 9C13 C1               pop  bc
2262+ 9C14 FE 02            cp   2
2263+ 9C16 CA AD 9C         jp   z, .gtmv_fail
2264+ 9C19
2265+ 9C19 16 01            ld   d,1
2266+ 9C1B 5D               ld   e,l
2267+ 9C1C                  ;call SetPlayerInfo
2268+ 9C1C C3 A2 9C         jp   .gtmv_success
2269+ 9C1F
2270+ 9C1F              ; Nero, campo NORTH, move SOUTH:
2271+ 9C1F              ; deve essere su riga 1, target riga 3
2272+ 9C1F              .gtmv_nb_move_down:
2273+ 9C1F 7C               ld   a,h
2274+ 9C20 FE 01            cp   1
2275+ 9C22 C2 AD 9C         jp   nz, .gtmv_fail
2276+ 9C25
2277+ 9C25 16 03            ld   d,3
2278+ 9C27 5D               ld   e,l
2279+ 9C28 C5               push bc
2280+ 9C29 E5               push hl
2281+ 9C2A CD 2F 96         call Game_GetPlayerInfoByPos
2282+ 9C2D E1               pop  hl
2283+ 9C2E C1               pop  bc
2284+ 9C2F FE FF            cp   NO_VALUE
2285+ 9C31 C2 AD 9C         jp   nz, .gtmv_fail
2286+ 9C34
2287+ 9C34                  ; verifica palla in (3, currX)
2288+ 9C34                  ;ld   d,3
2289+ 9C34                  ;ld   e,l
2290+ 9C34                  ;CALL CheckBallAtPosition
2291+ 9C34                  ;CP   NO
2292+ 9C34                  ;jp   z, .no_ball_nb_down
2293+ 9C34                  ;jp   .gtmv_fail
2294+ 9C34
2295+ 9C34              .no_ball_nb_down:
2296+ 9C34                  ; conta i compagni sulla riga 3
2297+ 9C34 C5               push bc
2298+ 9C35 16 03            ld   d,3
2299+ 9C37 CD 1D 9E         call Game_CountTeamPlayersOnRow
2300+ 9C3A C1               pop  bc
2301+ 9C3B FE 02            cp   2
2302+ 9C3D D2 AD 9C         jp   nc, .gtmv_fail
2303+ 9C40
2304+ 9C40 16 03            ld   d,3
2305+ 9C42 5D               ld   e,l
2306+ 9C43                  ;call SetPlayerInfo
2307+ 9C43 C3 A2 9C         jp   .gtmv_success
2308+ 9C46
2309+ 9C46              ; ----- TEAM_WHITE, FIELD_NORTH_SIDE -----
2310+ 9C46              .gtmv_north_white:
2311+ 9C46 7A               ld   a,d                      ; direzione
2312+ 9C47 FE 03            cp   PLAYER_ASKED_DIRECTION_NORTH
2313+ 9C49 CA 54 9C         jp   z, .gtmv_nw_move_up
2314+ 9C4C FE 04            cp   PLAYER_ASKED_DIRECTION_SOUTH
2315+ 9C4E CA 7B 9C         jp   z, .gtmv_nw_move_down
2316+ 9C51 C3 AD 9C         jp   .gtmv_fail
2317+ 9C54
2318+ 9C54              ; Bianco, campo NORTH, move NORTH:
2319+ 9C54              ; deve essere su riga 4, target riga 2
2320+ 9C54              .gtmv_nw_move_up:
2321+ 9C54 7C               ld   a,h                      ; currY
2322+ 9C55 FE 04            cp   4
2323+ 9C57 C2 AD 9C         jp   nz, .gtmv_fail
2324+ 9C5A
2325+ 9C5A 16 02            ld   d,2
2326+ 9C5C 5D               ld   e,l
2327+ 9C5D C5               push bc
2328+ 9C5E E5               push hl
2329+ 9C5F CD 2F 96         call Game_GetPlayerInfoByPos
2330+ 9C62 E1               pop  hl
2331+ 9C63 C1               pop  bc
2332+ 9C64 FE FF            cp   NO_VALUE
2333+ 9C66 C2 AD 9C         jp   nz, .gtmv_fail
2334+ 9C69
2335+ 9C69                  ; verifica palla in (2, currX)
2336+ 9C69                  ;ld   d,2
2337+ 9C69                  ;ld   e,l
2338+ 9C69                  ;CALL CheckBallAtPosition
2339+ 9C69                  ;CP   NO
2340+ 9C69                  ;jp   z, .no_ball_nw_up
2341+ 9C69                  ;jp   .gtmv_fail
2342+ 9C69
2343+ 9C69              .no_ball_nw_up:
2344+ 9C69                  ; conta i compagni sulla riga 2
2345+ 9C69 C5               push bc
2346+ 9C6A 16 02            ld   d,2
2347+ 9C6C CD 1D 9E         call Game_CountTeamPlayersOnRow
2348+ 9C6F C1               pop  bc
2349+ 9C70 FE 02            cp   2
2350+ 9C72 D2 AD 9C         jp   nc, .gtmv_fail
2351+ 9C75
2352+ 9C75 16 02            ld   d,2
2353+ 9C77 5D               ld   e,l
2354+ 9C78                  ;call SetPlayerInfo
2355+ 9C78 C3 A2 9C         jp   .gtmv_success
2356+ 9C7B
2357+ 9C7B              ; Bianco, campo NORTH, move SOUTH:
2358+ 9C7B              ; deve essere su riga 2, target riga 4
2359+ 9C7B              .gtmv_nw_move_down:
2360+ 9C7B 7C               ld   a,h                      ; currY
2361+ 9C7C FE 02            cp   2
2362+ 9C7E C2 AD 9C         jp   nz, .gtmv_fail
2363+ 9C81
2364+ 9C81 16 04            ld   d,4
2365+ 9C83 5D               ld   e,l
2366+ 9C84 C5               push bc
2367+ 9C85 E5               push hl
2368+ 9C86 CD 2F 96         call Game_GetPlayerInfoByPos
2369+ 9C89 E1               pop  hl
2370+ 9C8A C1               pop  bc
2371+ 9C8B FE FF            cp   NO_VALUE
2372+ 9C8D C2 AD 9C         jp   nz, .gtmv_fail
2373+ 9C90
2374+ 9C90                  ; verifica palla in (4, currX)
2375+ 9C90                  ;ld   d,4
2376+ 9C90                  ;ld   e,l
2377+ 9C90                  ;CALL CheckBallAtPosition
2378+ 9C90                  ;CP   NO
2379+ 9C90                  ;jp   z, .no_ball_nw_down
2380+ 9C90                  ;jp   .gtmv_fail
2381+ 9C90
2382+ 9C90              .no_ball_nw_down:
2383+ 9C90                  ; conta i compagni sulla riga 4
2384+ 9C90 C5               push bc
2385+ 9C91 16 04            ld   d,4
2386+ 9C93 CD 1D 9E         call Game_CountTeamPlayersOnRow
2387+ 9C96 C1               pop  bc
2388+ 9C97 FE 02            cp   2
2389+ 9C99 D2 AD 9C         jp   nc, .gtmv_fail
2390+ 9C9C
2391+ 9C9C 16 04            ld   d,4
2392+ 9C9E 5D               ld   e,l
2393+ 9C9F                  ;call SetPlayerInfo
2394+ 9C9F C3 A2 9C         jp   .gtmv_success
2395+ 9CA2
2396+ 9CA2
2397+ 9CA2              ; -------------------------------------------------------------------
2398+ 9CA2              .gtmv_success:
2399+ 9CA2 CD ED 95         call SetPlayerInfo
2400+ 9CA5                  ;CALL VDP_PlayerMatrixRedraw
2401+ 9CA5 3E 01            LD     A, YES
2402+ 9CA7 32 3D B2         LD     (Var_Hooks_ForceVdpRedraw), A
2403+ 9CAA 3E 01            ld   a,SUCCESS
2404+ 9CAC C9               ret
2405+ 9CAD
2406+ 9CAD              .gtmv_fail:
2407+ 9CAD 3E 00            ld   a,FAILURE
2408+ 9CAF C9               ret
2409+ 9CB0              .gtmv_fail_pop:
2410+ 9CB0 F1               pop  af                        ; rimuovi dir dallo stack
2411+ 9CB1 18 FA            JR   .gtmv_fail
2412+ 9CB3              ;---------------------------------------------------------------------------
2413+ 9CB3              ; Game_CheckBallAtPosition
2414+ 9CB3              ; Controlla se la palla si trova in (D,E).
2415+ 9CB3              ; INPUT:
2416+ 9CB3              ;   D = Y
2417+ 9CB3              ;   E = X
2418+ 9CB3              ; OUTPUT:
2419+ 9CB3              ;   A = YES (1) se la palla è in (D,E), NO (0) altrimenti
2420+ 9CB3              ; ---------------------------------------------------------------------------
2421+ 9CB3              CheckBallAtPosition:
2422+ 9CB3 E5               push hl
2423+ 9CB4 D5               push de
2424+ 9CB5 E1               pop  hl
2425+ 9CB6
2426+ 9CB6 CD 4D 95         call Game_GetBallPosition
2427+ 9CB9 7A               ld   a, d
2428+ 9CBA BC               cp   h
2429+ 9CBB 20 08            jr   nz, .NotFound
2430+ 9CBD 7B               ld   a, e
2431+ 9CBE BD               cp   l
2432+ 9CBF 20 04            jr   nz, .NotFound
2433+ 9CC1 3E 01            LD   a, YES
2434+ 9CC3              .Done:
2435+ 9CC3 E1               pop  hl
2436+ 9CC4
2437+ 9CC4 C9               ret
2438+ 9CC5              .NotFound:
2439+ 9CC5 3E 00            LD   a, NO
2440+ 9CC7 C3 C3 9C         jp   .Done
2441+ 9CCA              ; ---------------------------------------------------------------------------
2442+ 9CCA              ; TryShot
2443+ 9CCA              ; INPUT:
2444+ 9CCA              ;   B = TEAM (TEAM_BLACK / TEAM_WHITE)
2445+ 9CCA              ;   C = ID   (giocatore con palla)
2446+ 9CCA              ;
2447+ 9CCA              ; OUTPUT:
2448+ 9CCA              ;   Var_Game_BallDirection impostata
2449+ 9CCA              ;   Var_Game_BallDiagonalMovCounter:
2450+ 9CCA              ;       - 255 solo se (ActiveFieldSide=NORTH, TEAM=WHITE, shooterY=2)
2451+ 9CCA              ;       - 0 in tutti gli altri casi
2452+ 9CCA              ; ---------------------------------------------------------------------------
2453+ 9CCA              Game_TryShot:
2454+ 9CCA F5               push af
2455+ 9CCB C5               push bc
2456+ 9CCC D5               push de
2457+ 9CCD E5               push hl
2458+ 9CCE
2459+ 9CCE
2460+ 9CCE                  ; Leggi posizione giocatore (H=Y, L=X)
2461+ 9CCE CD 14 96         call Game_GetPlayerInfoById
2462+ 9CD1
2463+ 9CD1                  ; Default counter=0
2464+ 9CD1 AF               xor  a
2465+ 9CD2 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
2466+ 9CD5
2467+ 9CD5                  ; Se campo NORTH e bianco e Y=2 => counter=255 (caso speciale)
2468+ 9CD5 3A C2 B1         ld   a,(Var_Game_ActiveFieldSide)
2469+ 9CD8 FE 01            cp   FIELD_NORTH_SIDE
2470+ 9CDA 20 0F            jr   nz,.counter_done
2471+ 9CDC 78               ld   a,b
2472+ 9CDD FE 01            cp   TEAM_WHITE
2473+ 9CDF 20 0A            jr   nz,.counter_done
2474+ 9CE1 7C               ld   a,h
2475+ 9CE2 FE 02            cp   2
2476+ 9CE4 20 05            jr   nz,.counter_done
2477+ 9CE6 3E FF            ld   a,255
2478+ 9CE8 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
2479+ 9CEB              .counter_done:
2480+ 9CEB
2481+ 9CEB                  ; Decide direzione in base a campo/team/riga/colonna
2482+ 9CEB 3A C2 B1         ld   a,(Var_Game_ActiveFieldSide)
2483+ 9CEE FE 01            cp   FIELD_NORTH_SIDE
2484+ 9CF0 28 03            jr   z,.field_north
2485+ 9CF2 C3 75 9D         jp   .field_south
2486+ 9CF5
2487+ 9CF5              ; ==========================
2488+ 9CF5              ; CAMPO VISIBILE: NORTH
2489+ 9CF5              ; ==========================
2490+ 9CF5              .field_north:
2491+ 9CF5 78               ld   a,b
2492+ 9CF6 FE 00            cp   TEAM_BLACK
2493+ 9CF8 28 02            jr   z,.north_black
2494+ 9CFA                  ; altrimenti TEAM_WHITE
2495+ 9CFA 18 30            jr   .north_white
2496+ 9CFC
2497+ 9CFC              .north_black:
2498+ 9CFC                  ; Nero: da qualsiasi riga -> SOUTH / SOUTH_EAST / SOUTH_WEST
2499+ 9CFC                  ; con vincolo bordo: X=0 => no SOUTH_WEST, X=4 => no SOUTH_EAST
2500+ 9CFC CD 32 9A         call Game_GetRandomByte
2501+ 9CFF E6 03            and  00000011b          ; 0..3
2502+ 9D01 FE 03            cp   3
2503+ 9D03 20 01            jr   nz,.nb_r_ok
2504+ 9D05 AF               xor  a                  ; 3 -> 0
2505+ 9D06              .nb_r_ok:
2506+ 9D06                  ; A = 0..2
2507+ 9D06                  ; 0=SOUTH, 1=SOUTH_EAST, 2=SOUTH_WEST (poi validiamo bordi)
2508+ 9D06 57               ld   d,a                ; D = scelta
2509+ 9D07
2510+ 9D07 7D               ld   a,l                ; X
2511+ 9D08 FE 00            cp   0
2512+ 9D0A 20 07            jr   nz,.nb_not_left
2513+ 9D0C                  ; X=0: se scelta = SOUTH_WEST (2) -> forza SOUTH (0) o SOUTH_EAST (1)
2514+ 9D0C 7A               ld   a,d
2515+ 9D0D FE 02            cp   2
2516+ 9D0F 20 02            jr   nz,.nb_not_left
2517+ 9D11                  ; forza SOUTH_EAST (più "naturale" da sinistra) oppure SOUTH
2518+ 9D11 16 01            ld   d,1
2519+ 9D13              .nb_not_left:
2520+ 9D13 7D               ld   a,l
2521+ 9D14 FE 04            cp   4
2522+ 9D16 20 07            jr   nz,.nb_choose
2523+ 9D18                  ; X=4: se scelta = SOUTH_EAST (1) -> forza SOUTH_WEST (2) o SOUTH
2524+ 9D18 7A               ld   a,d
2525+ 9D19 FE 01            cp   1
2526+ 9D1B 20 02            jr   nz,.nb_choose
2527+ 9D1D 16 02            ld   d,2
2528+ 9D1F              .nb_choose:
2529+ 9D1F 7A               ld   a,d
2530+ 9D20 B7               or   a
2531+ 9D21 CA F0 9D         jp   z,.set_south
2532+ 9D24 FE 01            cp   1
2533+ 9D26 CA FC 9D         jp   z,.set_se
2534+ 9D29                  ; 2
2535+ 9D29 C3 00 9E         jp   .set_sw
2536+ 9D2C
2537+ 9D2C              .north_white:
2538+ 9D2C 7C               ld   a,h                ; Y
2539+ 9D2D FE 04            cp   4
2540+ 9D2F 28 07            jr   z,.nw_y4
2541+ 9D31 FE 02            cp   2
2542+ 9D33 28 33            jr   z,.nw_y2
2543+ 9D35                  ; Fuori dalle righe previste: niente tiro
2544+ 9D35 C3 0C 9E         jp   .stop_shot
2545+ 9D38
2546+ 9D38              .nw_y4:
2547+ 9D38                  ; Bianco da riga 4: NORTH / NE / NW
2548+ 9D38                  ; vincolo bordo: X=0 => no NW, X=4 => no NE
2549+ 9D38 CD 32 9A         call Game_GetRandomByte
2550+ 9D3B E6 03            and  00000011b          ; 0..3
2551+ 9D3D FE 03            cp   3
2552+ 9D3F 20 01            jr   nz,.nw4_r_ok
2553+ 9D41 AF               xor  a
2554+ 9D42              .nw4_r_ok:
2555+ 9D42                  ; 0=NORTH, 1=NE, 2=NW
2556+ 9D42 57               ld   d,a
2557+ 9D43
2558+ 9D43 7D               ld   a,l
2559+ 9D44 FE 00            cp   0
2560+ 9D46 20 07            jr   nz,.nw4_not_left
2561+ 9D48 7A               ld   a,d
2562+ 9D49 FE 02            cp   2
2563+ 9D4B 20 02            jr   nz,.nw4_not_left
2564+ 9D4D 16 01            ld   d,1                ; da sinistra, evita NW -> forza NE (o straight, ma NE va bene)
2565+ 9D4F              .nw4_not_left:
2566+ 9D4F 7D               ld   a,l
2567+ 9D50 FE 04            cp   4
2568+ 9D52 20 07            jr   nz,.nw4_choose
2569+ 9D54 7A               ld   a,d
2570+ 9D55 FE 01            cp   1
2571+ 9D57 20 02            jr   nz,.nw4_choose
2572+ 9D59 16 02            ld   d,2                ; da destra, evita NE -> forza NW
2573+ 9D5B              .nw4_choose:
2574+ 9D5B 7A               ld   a,d
2575+ 9D5C B7               or   a
2576+ 9D5D CA EC 9D         jp   z,.set_north
2577+ 9D60 FE 01            cp   1
2578+ 9D62 CA F4 9D         jp   z,.set_ne
2579+ 9D65 C3 F8 9D         jp   .set_nw
2580+ 9D68
2581+ 9D68              .nw_y2:
2582+ 9D68                  ; Caso speciale attaccante bianco in riga 2 (campo NORTH)
2583+ 9D68                  ; - se X=1..3 -> NORTH
2584+ 9D68                  ; - se X=0 -> NORTH_EAST
2585+ 9D68                  ; - se X=4 -> NORTH_WEST
2586+ 9D68 7D               ld   a,l
2587+ 9D69 FE 00            cp   0
2588+ 9D6B CA F4 9D         jp   z,.set_ne
2589+ 9D6E FE 04            cp   4
2590+ 9D70 CA F8 9D         jp   z,.set_nw
2591+ 9D73 18 77            jr   .set_north
2592+ 9D75
2593+ 9D75
2594+ 9D75              ; ==========================
2595+ 9D75              ; CAMPO VISIBILE: SOUTH
2596+ 9D75              ; ==========================
2597+ 9D75              .field_south:
2598+ 9D75 78               ld   a,b
2599+ 9D76 FE 01            cp   TEAM_WHITE
2600+ 9D78 28 02            jr   z,.south_white
2601+ 9D7A                  ; altrimenti TEAM_BLACK
2602+ 9D7A 18 2D            jr   .south_black
2603+ 9D7C
2604+ 9D7C              .south_white:
2605+ 9D7C                  ; Bianco: da qualsiasi riga -> NORTH / NE / NW
2606+ 9D7C                  ; vincolo bordo: X=0 => no NW, X=4 => no NE
2607+ 9D7C CD 32 9A         call Game_GetRandomByte
2608+ 9D7F E6 03            and  00000011b
2609+ 9D81 FE 03            cp   3
2610+ 9D83 20 01            jr   nz,.sw_r_ok
2611+ 9D85 AF               xor  a
2612+ 9D86              .sw_r_ok:
2613+ 9D86                  ; 0=NORTH, 1=NE, 2=NW
2614+ 9D86 57               ld   d,a
2615+ 9D87
2616+ 9D87 7D               ld   a,l
2617+ 9D88 FE 00            cp   0
2618+ 9D8A 20 07            jr   nz,.sw_not_left
2619+ 9D8C 7A               ld   a,d
2620+ 9D8D FE 02            cp   2
2621+ 9D8F 20 02            jr   nz,.sw_not_left
2622+ 9D91 16 01            ld   d,1
2623+ 9D93              .sw_not_left:
2624+ 9D93 7D               ld   a,l
2625+ 9D94 FE 04            cp   4
2626+ 9D96 20 07            jr   nz,.sw_choose
2627+ 9D98 7A               ld   a,d
2628+ 9D99 FE 01            cp   1
2629+ 9D9B 20 02            jr   nz,.sw_choose
2630+ 9D9D 16 02            ld   d,2
2631+ 9D9F              .sw_choose:
2632+ 9D9F 7A               ld   a,d
2633+ 9DA0 B7               or   a
2634+ 9DA1 28 49            jr   z,.set_north
2635+ 9DA3 FE 01            cp   1
2636+ 9DA5 28 4D            jr   z,.set_ne
2637+ 9DA7 18 4F            jr   .set_nw
2638+ 9DA9
2639+ 9DA9              .south_black:
2640+ 9DA9 7C               ld   a,h                ; Y
2641+ 9DAA FE 00            cp   0
2642+ 9DAC 28 06            jr   z,.sb_y0
2643+ 9DAE FE 02            cp   2
2644+ 9DB0 28 2F            jr   z,.sb_y2
2645+ 9DB2 18 58            jr   .stop_shot
2646+ 9DB4
2647+ 9DB4              .sb_y0:
2648+ 9DB4                  ; Nero da riga 0: SOUTH / SE / SW
2649+ 9DB4                  ; vincolo bordo: X=0 => no SW, X=4 => no SE
2650+ 9DB4 CD 32 9A         call Game_GetRandomByte
2651+ 9DB7 E6 03            and  00000011b
2652+ 9DB9 FE 03            cp   3
2653+ 9DBB 20 01            jr   nz,.sb0_r_ok
2654+ 9DBD AF               xor  a
2655+ 9DBE              .sb0_r_ok:
2656+ 9DBE                  ; 0=SOUTH, 1=SE, 2=SW
2657+ 9DBE 57               ld   d,a
2658+ 9DBF
2659+ 9DBF 7D               ld   a,l
2660+ 9DC0 FE 00            cp   0
2661+ 9DC2 20 07            jr   nz,.sb0_not_left
2662+ 9DC4 7A               ld   a,d
2663+ 9DC5 FE 02            cp   2
2664+ 9DC7 20 02            jr   nz,.sb0_not_left
2665+ 9DC9 16 01            ld   d,1
2666+ 9DCB              .sb0_not_left:
2667+ 9DCB 7D               ld   a,l
2668+ 9DCC FE 04            cp   4
2669+ 9DCE 20 07            jr   nz,.sb0_choose
2670+ 9DD0 7A               ld   a,d
2671+ 9DD1 FE 01            cp   1
2672+ 9DD3 20 02            jr   nz,.sb0_choose
2673+ 9DD5 16 02            ld   d,2
2674+ 9DD7              .sb0_choose:
2675+ 9DD7 7A               ld   a,d
2676+ 9DD8 B7               or   a
2677+ 9DD9 28 15            jr   z,.set_south
2678+ 9DDB FE 01            cp   1
2679+ 9DDD 28 1D            jr   z,.set_se
2680+ 9DDF 18 1F            jr   .set_sw
2681+ 9DE1
2682+ 9DE1              .sb_y2:
2683+ 9DE1                  ; Nero in riga 2 (campo SOUTH):
2684+ 9DE1                  ; - X=1..3 -> SOUTH
2685+ 9DE1                  ; - X=0 -> SOUTH_EAST
2686+ 9DE1                  ; - X=4 -> SOUTH_WEST
2687+ 9DE1 7D               ld   a,l
2688+ 9DE2 FE 00            cp   0
2689+ 9DE4 28 16            jr   z,.set_se
2690+ 9DE6 FE 04            cp   4
2691+ 9DE8 28 16            jr   z,.set_sw
2692+ 9DEA 18 04            jr   .set_south
2693+ 9DEC
2694+ 9DEC
2695+ 9DEC              ; ==========================
2696+ 9DEC              ; SET DIREZIONI
2697+ 9DEC              ; ==========================
2698+ 9DEC              .set_north:
2699+ 9DEC 3E 01            ld   a,BALL_DIRECTION_NORTH
2700+ 9DEE 18 14            jr   .store_dir
2701+ 9DF0              .set_south:
2702+ 9DF0 3E 04            ld   a,BALL_DIRECTION_SOUTH
2703+ 9DF2 18 10            jr   .store_dir
2704+ 9DF4              .set_ne:
2705+ 9DF4 3E 02            ld   a,BALL_DIRECTION_NORTH_EAST
2706+ 9DF6 18 0C            jr   .store_dir
2707+ 9DF8              .set_nw:
2708+ 9DF8 3E 03            ld   a,BALL_DIRECTION_NORTH_WEST
2709+ 9DFA 18 08            jr   .store_dir
2710+ 9DFC              .set_se:
2711+ 9DFC 3E 05            ld   a,BALL_DIRECTION_SOUTH_EAST
2712+ 9DFE 18 04            jr   .store_dir
2713+ 9E00              .set_sw:
2714+ 9E00 3E 06            ld   a,BALL_DIRECTION_SOUTH_WEST
2715+ 9E02 18 00            jr   .store_dir
2716+ 9E04
2717+ 9E04              .store_dir:
2718+ 9E04 32 E2 B1         ld   (Var_Game_BallDirection),a
2719+ 9E07 CD BD A9         call Game_PlayBeep
2720+ 9E0A 18 03            jr   .done
2721+ 9E0C
2722+ 9E0C              .stop_shot:
2723+ 9E0C CD 14 9E         call Game_StopShot
2724+ 9E0F
2725+ 9E0F              .done:
2726+ 9E0F E1               pop  hl
2727+ 9E10 D1               pop  de
2728+ 9E11 C1               pop  bc
2729+ 9E12 F1               pop  af
2730+ 9E13 C9               ret
2731+ 9E14
2732+ 9E14
2733+ 9E14              ; ---------------------------------------------------------------------------
2734+ 9E14              ; Game_StopShot
2735+ 9E14              ; Ferma il tiro: azzera direzione e counter diagonale.
2736+ 9E14              ; ---------------------------------------------------------------------------
2737+ 9E14              Game_StopShot:
2738+ 9E14 3E 00            ld   a, BALL_DIRECTION_NONE
2739+ 9E16 32 E2 B1         ld   (Var_Game_BallDirection),a         ; BALL_DIRECTION_NONE = 0 (assunto)
2740+ 9E19 32 E3 B1         ld   (Var_Game_BallDiagonalMovCounter),a
2741+ 9E1C C9               ret
2742+ 9E1D
2743+ 9E1D
2744+ 9E1D              ; ---------------------------------------------------------------------------
2745+ 9E1D              ; Game_CountTeamPlayersOnRow
2746+ 9E1D              ; Conta quanti giocatori della squadra B sono sulla riga D (Y = D).
2747+ 9E1D              ;
2748+ 9E1D              ; INPUT:
2749+ 9E1D              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
2750+ 9E1D              ;   D = Y (riga da controllare)
2751+ 9E1D              ;
2752+ 9E1D              ; OUTPUT:
2753+ 9E1D              ;   A = numero di giocatori (0..4)
2754+ 9E1D              ;
2755+ 9E1D              ; MODIFIES:
2756+ 9E1D              ;   AF, C, DE, HL
2757+ 9E1D              ; ---------------------------------------------------------------------------
2758+ 9E1D              Game_CountTeamPlayersOnRow:
2759+ 9E1D C5               PUSH BC
2760+ 9E1E D5               PUSH DE
2761+ 9E1F E5               PUSH HL
2762+ 9E20 7A               LD   A, D
2763+ 9E21 CD 7B A3         CALL GetAllPlayersOnARow
2764+ 9E24 78               LD   A, B
2765+ 9E25 FE FF            CP   NO_VALUE
2766+ 9E27 28 10            JR   Z, .NoPlayersFound
2767+ 9E29 79               LD   A, C
2768+ 9E2A FE FF            CP   NO_VALUE
2769+ 9E2C 28 06            JR   Z, .OnePlayerFound
2770+ 9E2E 3E 02            LD   A, 2
2771+ 9E30              .Done:
2772+ 9E30 E1               POP  HL
2773+ 9E31 D1               POP  DE
2774+ 9E32 C1               POP  BC
2775+ 9E33 C9               RET
2776+ 9E34              .OnePlayerFound:
2777+ 9E34 3E 01            LD   A, 1
2778+ 9E36 C3 30 9E         JP   .Done
2779+ 9E39              .NoPlayersFound:
2780+ 9E39 AF               XOR  A
2781+ 9E3A C3 30 9E         JP   .Done
2782+ 9E3D
2783+ 9E3D              ; ---------------------------------------------------------------------------
2784+ 9E3D              ; MoveGoalKeeper
2785+ 9E3D              ; INPUT: B: Team
2786+ 9E3D              ; ---------------------------------------------------------------------------
2787+ 9E3D              MoveGoalKeeper:
2788+ 9E3D D5               PUSH DE
2789+ 9E3E E5               PUSH HL
2790+ 9E3F C5               PUSH BC
2791+ 9E40 F3               DI
2792+ 9E41 CD 58 81         CALL Hooks_TickStop
2793+ 9E44 0E 00            LD   C, 0
2794+ 9E46 CD 14 96         CALL Game_GetPlayerInfoById
2795+ 9E49 7C               LD   A, H
2796+ 9E4A FE FF            CP   NO_VALUE
2797+ 9E4C 28 24            JR   Z, .done
2798+ 9E4E
2799+ 9E4E 3A C8 B1         ld   a, (Var_Game_MoveTmpDir)
2800+ 9E51 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2801+ 9E53 20 09            jr   nz, .move_west
2802+ 9E55                  ; --- move east ---
2803+ 9E55 2C               inc  l
2804+ 9E56 7D               LD   A, L
2805+ 9E57 FE 04            CP   4
2806+ 9E59 28 17            JR   Z, .done
2807+ 9E5B C3 64 9E         JP   .set_pos
2808+ 9E5E              .move_west:
2809+ 9E5E
2810+ 9E5E                  ; --- move west ---
2811+ 9E5E 2D               dec  l
2812+ 9E5F 7D               LD   A, L
2813+ 9E60 FE 00            CP   0
2814+ 9E62 28 0E            JR   Z, .done
2815+ 9E64              .set_pos:
2816+ 9E64 C1               POP  BC
2817+ 9E65 C5               PUSH BC
2818+ 9E66 0E 00            LD   C, 0
2819+ 9E68 54               LD   D, H
2820+ 9E69 5D               LD   E, L
2821+ 9E6A CD ED 95         CALL SetPlayerInfo
2822+ 9E6D 3E 01            LD   A, YES
2823+ 9E6F 32 3D B2         LD  (Var_Hooks_ForceVdpRedraw), A
2824+ 9E72              .done
2825+ 9E72 CD 50 81         CALL Hooks_TickStart
2826+ 9E75 C1               POP  BC
2827+ 9E76 E1               POP  HL
2828+ 9E77 D1               POP  DE
2829+ 9E78 C9               RET
2830+ 9E79              ; ---------------------------------------------------------------------------
2831+ 9E79              ; Game_TryMovePlayerHorizontally
2832+ 9E79              ;
2833+ 9E79              ; INPUT:
2834+ 9E79              ;   B = TEAM  (TEAM_BLACK / TEAM_WHITE)
2835+ 9E79              ;   C = ID    (0..3)
2836+ 9E79              ;   A = direzione richiesta:
2837+ 9E79              ;       PLAYER_ASKED_DIRECTION_EAST
2838+ 9E79              ;       PLAYER_ASKED_DIRECTION_WEST
2839+ 9E79              ;
2840+ 9E79              ; OUTPUT:
2841+ 9E79              ;   A = SUCCESS (0) oppure FAILURE (1)
2842+ 9E79              ;
2843+ 9E79              ; NOTE:
2844+ 9E79              ;   - controlla SOLO la colonna adiacente nella direzione richiesta;
2845+ 9E79              ;   - se lì c'è un compagno senza palla, prova prima a muovere lui
2846+ 9E79              ;     ricorsivamente (stessa direzione);
2847+ 9E79              ;   - se la catena non trova spazio o qualcuno ha la palla e blocca,
2848+ 9E79              ;     ritorna FAILURE;
2849+ 9E79              ;   - se la mossa è possibile:
2850+ 9E79              ;       * sposta eventuale palla se:
2851+ 9E79              ;           - BALL_STATUS_CONTENDED, oppure
2852+ 9E79              ;           - posseduta dal giocatore che stiamo muovendo;
2853+ 9E79              ;       * sposta il giocatore di 1 colonna in quella direzione;
2854+ 9E79              ;   - limiti orizzontali:
2855+ 9E79              ;       * portiere (ID=0): X in [1..3]
2856+ 9E79              ;       * altri:            X in [0..4]
2857+ 9E79              ; ---------------------------------------------------------------------------
2858+ 9E79              Game_TryMovePlayerHorizontally:
2859+ 9E79
2860+ 9E79                  ; Salva la direzione richiesta (uguale in tutta la catena)
2861+ 9E79 32 C8 B1         ld   (Var_Game_MoveTmpDir),a
2862+ 9E7C
2863+ 9E7C
2864+ 9E7C
2865+ 9E7C E5               push hl
2866+ 9E7D C5               push bc
2867+ 9E7E
2868+ 9E7E 3A 3D B2         LD  A, (Var_Hooks_ForceVdpRedraw)
2869+ 9E81 FE 01            CP  YES
2870+ 9E83 CA AD 9F         jp   z,.fail_exit
2871+ 9E86
2872+ 9E86 78               ld   a, b
2873+ 9E87 32 D2 B1         ld   (Var_Game_TmpMoveTeam), a
2874+ 9E8A 79               ld   a, c
2875+ 9E8B 32 D3 B1         ld   (Var_Game_TmpMoveId),a
2876+ 9E8E
2877+ 9E8E CD 3D 9E         CALL MoveGoalKeeper
2878+ 9E91                  ; --- 1) Ottieni posizione corrente del giocatore (Y,X) ---
2879+ 9E91                  ; HL = curr (H=Y, L=X), B=TEAM, C=ID, A=ROLE
2880+ 9E91 C1               POP  BC
2881+ 9E92 C5               PUSH BC
2882+ 9E93 CD 14 96         call Game_GetPlayerInfoById
2883+ 9E96
2884+ 9E96 7C               ld   a, h
2885+ 9E97 32 D7 B1         ld   (Var_Game_TmpMoveRow), a
2886+ 9E9A 7D               ld   a, l
2887+ 9E9B 32 D8 B1         ld   (Var_Game_TmpMovStartCol), a
2888+ 9E9E                  ; Salviamo posizione corrente su stack (frame locale):
2889+ 9E9E                  ;   [SP]   = HL (Y,X)
2890+ 9E9E                  ;   [SP+2] = BC (TEAM,ID)
2891+ 9E9E
2892+ 9E9E
2893+ 9E9E                  ; Ora:
2894+ 9E9E                  ;   HL = pos (H=Y,L=X)
2895+ 9E9E                  ;   BC = TEAM/ID corrente
2896+ 9E9E                  ;   stack: BC0, HL0  (dove 0 = questo livello di ricorsione)
2897+ 9E9E
2898+ 9E9E                  ; --- 2) Controllo limite laterale per questo giocatore ---
2899+ 9E9E
2900+ 9E9E                  ; X attuale in L, ID in C
2901+ 9E9E 7D               ld   a,l              ; A = X
2902+ 9E9F 57               ld   d,a              ; D = X (copia)
2903+ 9EA0
2904+ 9EA0 3A C8 B1         ld   a,(Var_Game_MoveTmpDir)
2905+ 9EA3 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2906+ 9EA5 20 12            jr   nz,.chk_west_limit
2907+ 9EA7
2908+ 9EA7                  ; ---- direzione EST ----
2909+ 9EA7 79               ld   a,c              ; ID
2910+ 9EA8 B7               or   a
2911+ 9EA9 20 06            jr   nz,.not_gk_east  ; ID != 0 => non portiere
2912+ 9EAB                  ; Portiere: limite destro X=3
2913+ 9EAB 7A               ld   a,d
2914+ 9EAC FE 03            cp   3
2915+ 9EAE CA AD 9F         jp   z,.fail_exit
2916+ 9EB1
2917+ 9EB1              .not_gk_east:
2918+ 9EB1 7A               ld   a,d
2919+ 9EB2 FE 04            cp   4                ; X == 4?
2920+ 9EB4 CA AD 9F         jp   z,.fail_exit     ; bordo destro campo
2921+ 9EB7 18 0F            jr   .compute_adjacent
2922+ 9EB9
2923+ 9EB9              .chk_west_limit:
2924+ 9EB9                  ; ---- direzione OVEST ----
2925+ 9EB9 79               ld   a,c
2926+ 9EBA B7               or   a
2927+ 9EBB 20 06            jr   nz,.not_gk_west
2928+ 9EBD                  ; Portiere: limite sinistro X=1
2929+ 9EBD 7A               ld   a,d
2930+ 9EBE FE 01            cp   1
2931+ 9EC0 CA AD 9F         jp   z,.fail_exit
2932+ 9EC3
2933+ 9EC3              .not_gk_west:
2934+ 9EC3 7A               ld   a,d
2935+ 9EC4 B7               or   a                ; X==0?
2936+ 9EC5 CA AD 9F         jp   z,.fail_exit     ; bordo sinistro campo
2937+ 9EC8
2938+ 9EC8                  ; --- 3) Calcolo colonna adiacente e controllo occupante ---
2939+ 9EC8              .compute_adjacent:
2940+ 9EC8 5A               ld   e,d              ; E = X corrente
2941+ 9EC9 3A C8 B1         ld   a,(Var_Game_MoveTmpDir)
2942+ 9ECC FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
2943+ 9ECE 20 08            jr   nz,.adj_west
2944+ 9ED0 1C               inc  e                ; X+1
2945+ 9ED1 7B               LD   A, E
2946+ 9ED2 3C               INC     A
2947+ 9ED3 32 D6 B1         LD   (Var_Game_TmpMoveCompanionX), A
2948+ 9ED6 18 06            jr   .adj_done
2949+ 9ED8              .adj_west:
2950+ 9ED8 1D               dec  e                ; X-1
2951+ 9ED9 7B               LD   A, E
2952+ 9EDA 3D               DEC     A
2953+ 9EDB 32 D6 B1         LD   (Var_Game_TmpMoveCompanionX), A
2954+ 9EDE              .adj_done:
2955+ 9EDE
2956+ 9EDE                  ; Game_GetPlayerInfoByPos: D = Y, E = X
2957+ 9EDE 7C               ld   a,h
2958+ 9EDF 57               ld   d,a              ; D = Y
2959+ 9EE0                  ; E = colonna adiacente
2960+ 9EE0
2961+ 9EE0 CD 2F 96         call Game_GetPlayerInfoByPos
2962+ 9EE3 FE FF            cp   NO_VALUE
2963+ 9EE5 28 56            jr   z,.adjacent_free     ; nessun giocatore -> cella libera
2964+ 9EE7 79               ld   a, c
2965+ 9EE8 32 D5 B1         ld   (Var_Game_TmpMoveCompanionId),a
2966+ 9EEB                  ; --- 3b) C'è un compagno nella cella adiacente: B=TEAM_occ, C=ID_occ ---
2967+ 9EEB                  ; Verifica che non abbia la palla e prova a spostarlo ricorsivamente.
2968+ 9EEB
2969+ 9EEB                  ; Salviamo B_occ,C_occ su stack
2970+ 9EEB C5               push bc                   ; [SP] = BC_occ, sotto BC0,HL0
2971+ 9EEC
2972+ 9EEC                  ; Controlla possesso palla del giocatore adiacente
2973+ 9EEC CD 5A 9A         call Game_GetPlayerIdWithBall  ; A=TEAM_* o BALL_STATUS_*, H=ID
2974+ 9EEF
2975+ 9EEF                  ; Ripristiniamo BC_occ
2976+ 9EEF C1               pop  bc                   ; BC = TEAM_occ,ID_occ
2977+ 9EF0
2978+ 9EF0                  ; Se A è TEAM_BLACK o TEAM_WHITE e coincide con B_occ,
2979+ 9EF0                  ; e H coincide con ID_occ, allora quel giocatore ha la palla -> FAIL.
2980+ 9EF0 3A C8 B1         ld   a,(Var_Game_MoveTmpDir)   ; A usato dopo, salviamo TEAM occ in D/E
2981+ 9EF3 50               ld   d,b                   ; D = TEAM_occ
2982+ 9EF4 59               ld   e,c                   ; E = ID_occ
2983+ 9EF5
2984+ 9EF5                  ; ATTENZIONE: GetPlayerIdWithBall ha già sovrascritto A,
2985+ 9EF5                  ; perciò rileggo dal luogo giusto:
2986+ 9EF5                  ;  - Team/Status era in A al RETURN -> lo abbiamo perso, quindi
2987+ 9EF5                  ;    rifacciamo la chiamata e subito dopo il confronto.
2988+ 9EF5
2989+ 9EF5                  ; Rifaccio la chiamata per avere A,H aggiornati
2990+ 9EF5 CD 5A 9A         call Game_GetPlayerIdWithBall   ; A=TEAM_* o BALL_STATUS_*, H=ID
2991+ 9EF8
2992+ 9EF8 FE 65            cp   BALL_STATUS_CONTENDED
2993+ 9EFA 20 03            jr   nz,.adj_done_not_contended
2994+ 9EFC 3A D2 B1         ld   a, (Var_Game_TmpMoveTeam)
2995+ 9EFF              .adj_done_not_contended:
2996+ 9EFF                  ; Se A non è un TEAM, non è possesso
2997+ 9EFF FE 00            cp   TEAM_BLACK
2998+ 9F01 28 04            jr   z,.check_owner_team
2999+ 9F03 FE 01            cp   TEAM_WHITE
3000+ 9F05 20 0E            jr   nz,.no_owner_companion
3001+ 9F07
3002+ 9F07              .check_owner_team:
3003+ 9F07 57               LD   D, A
3004+ 9F08 3A D2 B1         LD   A, (Var_Game_TmpMoveTeam)
3005+ 9F0B BA               cp   d                     ; A == D (TEAM_occ)?
3006+ 9F0C 20 07            jr   nz,.no_owner_companion
3007+ 9F0E 3A D5 B1         ld   a, (Var_Game_TmpMoveCompanionId)
3008+ 9F11 BC               cp   h                     ; H == ID_occ?
3009+ 9F12 CA AD 9F         jp   z,.fail_exit          ; quel compagno ha la palla -> non si spinge
3010+ 9F15
3011+ 9F15              .no_owner_companion:
3012+ 9F15                  ; Possiamo provare a spostare il compagno ricorsivamente
3013+ 9F15
3014+ 9F15 3A D5 B1         ld a,(Var_Game_TmpMoveCompanionId)
3015+ 9F18 4F               ld c, a
3016+ 9F19 3A D2 B1         ld a, (Var_Game_TmpMoveTeam)
3017+ 9F1C 47               ld b, a
3018+ 9F1D 3A D6 B1         ld a, (Var_Game_TmpMoveCompanionX)
3019+ 9F20 5F               ld e, a
3020+ 9F21 FE FF            CP  255
3021+ 9F23 CA AD 9F         JP  Z, .fail_exit
3022+ 9F26 FE 05            CP  5
3023+ 9F28 CA AD 9F         JP  Z, .fail_exit
3024+ 9F2B 3A D7 B1         ld a, (Var_Game_TmpMoveRow)
3025+ 9F2E 57               ld d, a                   ; D=Y, E=X del compagno
3026+ 9F2F CD ED 95         call SetPlayerInfo
3027+ 9F32 3A D2 B1         ld a, (Var_Game_TmpMoveTeam)
3028+ 9F35 47               ld b, a
3029+ 9F36 3A D5 B1         ld a,(Var_Game_TmpMoveCompanionId)
3030+ 9F39 4F               ld c, a
3031+ 9F3A CD 6C 96         call Game_ClearSinglePlayerPrevPositions
3032+ 9F3D                  ;jr   nz,.fail_exit         ; se il compagno non si può muovere -> FAIL
3033+ 9F3D
3034+ 9F3D                  ; Se siamo qui, la cella adiacente è diventata libera
3035+ 9F3D              .adjacent_free:
3036+ 9F3D
3037+ 9F3D                  ; --- 4) Cella adiacente libera: decide se spostare anche la palla ---
3038+ 9F3D                  ; Rilegge possesso palla DOPO eventuale movimento dei compagni
3039+ 9F3D
3040+ 9F3D
3041+ 9F3D                  ; Recupera TEAM/ID e posizione corrente di QUESTO giocatore
3042+ 9F3D                  ; (prima di muoverlo) dal frame su stack
3043+ 9F3D C1               pop  bc                    ; BC0 = TEAM,ID del giocatore chiamante
3044+ 9F3E E1               pop  hl                    ; HL0 = pos corrente (H=Y, L=X)
3045+ 9F3F
3046+ 9F3F 3A D3 B1         ld   a, (Var_Game_TmpMoveId)
3047+ 9F42 4F               ld   c, a
3048+ 9F43
3049+ 9F43 C5               push bc
3050+ 9F44 CD 5A 9A         call Game_GetPlayerIdWithBall   ; A=status/TEAM, H=ID possessore (o 255)
3051+ 9F47 C1               pop  bc
3052+ 9F48
3053+ 9F48
3054+ 9F48                  ; A e H sono ancora quelli di GetPlayerIdWithBall
3055+ 9F48
3056+ 9F48                  ; Caso 1: palla contesa -> muoviamo palla
3057+ 9F48 FE 65            cp   BALL_STATUS_CONTENDED
3058+ 9F4A 28 07            jr   z,.move_ball
3059+ 9F4C
3060+ 9F4C                  ; Caso 2: A è TEAM del giocatore ed H è il suo ID -> possiede palla
3061+ 9F4C B8               cp   b
3062+ 9F4D 20 3F            jr   nz,.no_ball_move
3063+ 9F4F 7C               ld   a,h
3064+ 9F50 B9               cp   c
3065+ 9F51 20 3B            jr   nz,.no_ball_move
3066+ 9F53              .move_ball:
3067+ 9F53 3A D8 B1         ld   a, (Var_Game_TmpMovStartCol)
3068+ 9F56 CD 4D 95         call Game_GetBallPosition
3069+ 9F59 BB               cp   e
3070+ 9F5A 20 32            jr   nz,.no_ball_move      ; palla non nella stessa colonna -> non muovo palla
3071+ 9F5C
3072+ 9F5C
3073+ 9F5C
3074+ 9F5C                  ; Sposta la palla di una colonna nella stessa direzione del movimento
3075+ 9F5C                  ; (Y invariato, X +/- 1 se dentro 0..4)
3076+ 9F5C CD 4D 95         call Game_GetBallPosition
3077+ 9F5F 3A D2 B1         LD    A, (Var_Game_TmpMoveTeam)
3078+ 9F62 FE 00            CP   TEAM_BLACK
3079+ 9F64 28 09            JR   Z,.mb_ckblack
3080+ 9F66              .mb_ckwhite:
3081+ 9F66 3A D7 B1         LD  A,(Var_Game_TmpMoveRow)
3082+ 9F69 3D               DEC A
3083+ 9F6A BA               CP  D
3084+ 9F6B 20 21            JR  NZ,.no_ball_move      ; fuori campo -> non muovo palla
3085+ 9F6D 18 06            JR  .mb_continue
3086+ 9F6F              .mb_ckblack:
3087+ 9F6F 3A D7 B1         LD  A,(Var_Game_TmpMoveRow)
3088+ 9F72 BA               CP  D
3089+ 9F73 20 19            JR  NZ,.no_ball_move      ; fuori campo -> non muovo palla
3090+ 9F75              .mb_continue:
3091+ 9F75 3A C8 B1         ld   a,(Var_Game_MoveTmpDir)
3092+ 9F78 FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
3093+ 9F7A 20 09            jr   nz,.ball_west
3094+ 9F7C
3095+ 9F7C                  ; EST
3096+ 9F7C 7B               ld   a,e
3097+ 9F7D 3C               inc  a
3098+ 9F7E FE 05            cp   5
3099+ 9F80 30 0C            jr   nc,.no_ball_move      ; fuori campo -> non muovo palla
3100+ 9F82 5F               ld   e,a
3101+ 9F83 18 06            jr   .do_set_ball
3102+ 9F85
3103+ 9F85              .ball_west:
3104+ 9F85                  ; OVEST
3105+ 9F85 7B               ld   a,e
3106+ 9F86 B7               or   a
3107+ 9F87 28 05            jr   z,.no_ball_move       ; già a 0 -> non muovo palla
3108+ 9F89 3D               dec  a
3109+ 9F8A 5F               ld   e,a
3110+ 9F8B
3111+ 9F8B              .do_set_ball:
3112+ 9F8B
3113+ 9F8B
3114+ 9F8B CD 58 95         call Game_SetBallPosition
3115+ 9F8E
3116+ 9F8E              .no_ball_move:
3117+ 9F8E                  ; --- 5) Sposta il giocatore orizzontalmente ---
3118+ 9F8E                  ; HL contiene ancora la posizione del giocatore (da poco poppata)
3119+ 9F8E                  ; Se non fosse più valida, la ricalcoliamo:
3120+ 9F8E                  ;   B=TEAM, C=ID sono già corretti.
3121+ 9F8E 3A D3 B1         LD  A, (Var_Game_TmpMoveId)
3122+ 9F91 4F               LD  C, A
3123+ 9F92                  ; (riotteniamo posizione nel dubbio)
3124+ 9F92 CD 14 96         call Game_GetPlayerInfoById     ; HL = pos aggiornata (dovrebbe essere la stessa)
3125+ 9F95
3126+ 9F95 54               ld   d,h                   ; D = Y (invariato)
3127+ 9F96 5D               ld   e,l                   ; E = X
3128+ 9F97
3129+ 9F97 3A C8 B1         ld   a,(Var_Game_MoveTmpDir)
3130+ 9F9A FE 01            cp   PLAYER_ASKED_DIRECTION_EAST
3131+ 9F9C 20 03            jr   nz,.player_west
3132+ 9F9E 1C               inc  e
3133+ 9F9F 18 01            jr   .do_set_player
3134+ 9FA1
3135+ 9FA1              .player_west:
3136+ 9FA1 1D               dec  e
3137+ 9FA2
3138+ 9FA2              .do_set_player:
3139+ 9FA2                  ; D=Y, E=newX, B=TEAM, C=ID
3140+ 9FA2 CD ED 95         call SetPlayerInfo
3141+ 9FA5 3E 01            LD     A, YES
3142+ 9FA7 32 3D B2         LD     (Var_Hooks_ForceVdpRedraw), A
3143+ 9FAA 3E 01            ld   a,SUCCESS
3144+ 9FAC C9               ret
3145+ 9FAD
3146+ 9FAD              .fail_exit:
3147+ 9FAD                  ; Fallimento: svuota il frame locale (BC0,HL0) e ritorna FAILURE
3148+ 9FAD C1               pop  bc        ; scarta BC0 (TEAM/ID di questo livello)
3149+ 9FAE E1               pop  hl        ; scarta HL0 (pos)
3150+ 9FAF 3E 00            ld   a,FAILURE
3151+ 9FB1 C9               ret
3152+ 9FB2
3153+ 9FB2
3154+ 9FB2
3155+ 9FB2              ; ---------------------------------------------------------------------------
3156+ 9FB2              ; Black team horizontal move left asked
3157+ 9FB2              ; INPUT A: Direction
3158+ 9FB2              ; ---------------------------------------------------------------------------
3159+ 9FB2              Game_BlackTeamHorizMoveAsked:
3160+ 9FB2 32 C8 B1         LD      (Var_Game_MoveTmpDir),A
3161+ 9FB5
3162+ 9FB5 3A EF B1         LD      A, (Var_Game_BallYPosition)
3163+ 9FB8 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3164+ 9FBB
3165+ 9FBB 3A E2 B1         LD      A, (Var_Game_BallDirection)
3166+ 9FBE FE 00            CP      BALL_DIRECTION_NONE
3167+ 9FC0 28 36            JR      Z, .after_row_choice
3168+ 9FC2
3169+ 9FC2 FE 01            CP      BALL_DIRECTION_NORTH
3170+ 9FC4 28 1D            JR      Z, .north_direction
3171+ 9FC6 FE 02            CP      BALL_DIRECTION_NORTH_EAST
3172+ 9FC8 28 19            JR      Z, .north_direction
3173+ 9FCA FE 03            CP      BALL_DIRECTION_NORTH_WEST
3174+ 9FCC 28 15            JR      Z, .north_direction
3175+ 9FCE              .south_direction:
3176+ 9FCE 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3177+ 9FD1 FE 00            CP      FIELD_SOUTH_SIDE
3178+ 9FD3 28 07            JR      Z, .south_direction_south_side
3179+ 9FD5              .south_direction_north_side:
3180+ 9FD5 3E 03            LD      A, 3
3181+ 9FD7 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3182+ 9FDA 18 1C            JR      .after_row_choice
3183+ 9FDC              .south_direction_south_side:
3184+ 9FDC 3E 02            LD      A, 2
3185+ 9FDE 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3186+ 9FE1 18 15            JR      .after_row_choice
3187+ 9FE3              .north_direction:
3188+ 9FE3 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3189+ 9FE6 FE 00            CP      FIELD_SOUTH_SIDE
3190+ 9FE8 28 07            JR      Z, .north_direction_south_side
3191+ 9FEA              .north_direction_north_side:
3192+ 9FEA 3E 02            LD      A, 2
3193+ 9FEC 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3194+ 9FEF 18 07            JR      .after_row_choice
3195+ 9FF1              .north_direction_south_side:
3196+ 9FF1 3E 00            LD      A, 0
3197+ 9FF3 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3198+ 9FF6 18 00            JR      .after_row_choice
3199+ 9FF8
3200+ 9FF8              .after_row_choice:
3201+ 9FF8 3E 00            LD      A, NO
3202+ 9FFA 32 DA B1         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3203+ 9FFD 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3204+ A000 FE 01            CP      PLAYER_ASKED_DIRECTION_EAST
3205+ A002 28 05            JR      Z, .AfterSort
3206+ A004 3E 01            LD      A, YES
3207+ A006 32 DA B1         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3208+ A009              .AfterSort:
3209+ A009 CD 5A 9A         CALL    Game_GetPlayerIdWithBall
3210+ A00C FE 00            CP      TEAM_BLACK
3211+ A00E CA 40 A0         JP      Z,.WithBallPossession
3212+ A011 FE 65            CP      BALL_STATUS_CONTENDED
3213+ A013 CA 38 A0         JP      Z,.ContendedBall
3214+ A016
3215+ A016 3A D9 B1         LD      A, (Var_Game_TmpAskedMovingRow)
3216+ A019 CD 7B A3         CALL    GetAllPlayersOnARow
3217+ A01C C5               PUSH    BC
3218+ A01D 48               LD      C, B
3219+ A01E 06 00            LD      B, TEAM_BLACK
3220+ A020 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3221+ A023 CD 79 9E         CALL    Game_TryMovePlayerHorizontally
3222+ A026 C1               POP     BC
3223+ A027 79               LD      A, C
3224+ A028 FE FF            CP      NO_VALUE
3225+ A02A 20 02            JR      NZ, .NoBallPossessionSecondPlayer
3226+ A02C 18 1F            JR      .Done
3227+ A02E              .NoBallPossessionSecondPlayer:
3228+ A02E 06 00            LD      B, TEAM_BLACK
3229+ A030 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3230+ A033 CD 79 9E         CALL    Game_TryMovePlayerHorizontally
3231+ A036 18 15            JR      .Done
3232+ A038
3233+ A038
3234+ A038              .ContendedBall:
3235+ A038 CD 4D 95         CALL    Game_GetBallPosition
3236+ A03B CD 2F 96         CALL    Game_GetPlayerInfoByPos
3237+ A03E 79               LD      A, C
3238+ A03F 67               LD      H, A
3239+ A040              .WithBallPossession:
3240+ A040 7C               LD      A, H
3241+ A041 FE FF            CP      NO_VALUE
3242+ A043 C8               RET     Z
3243+ A044 4F               LD      C, A
3244+ A045 06 00            LD      B, TEAM_BLACK
3245+ A047 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3246+ A04A CD 79 9E         CALL    Game_TryMovePlayerHorizontally
3247+ A04D              .Done:
3248+ A04D C9               RET
3249+ A04E              ; ---------------------------------------------------------------------------
3250+ A04E              ; White team horizontal move left asked
3251+ A04E              ; INPUT A: Direction
3252+ A04E              ; ---------------------------------------------------------------------------
3253+ A04E              Game_WhiteTeamHorizMoveAsked:
3254+ A04E 32 C8 B1         LD      (Var_Game_MoveTmpDir),A
3255+ A051
3256+ A051 3A EF B1         LD      A, (Var_Game_BallYPosition)
3257+ A054 3C               INC     A
3258+ A055 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3259+ A058
3260+ A058 3A E2 B1         LD      A, (Var_Game_BallDirection)
3261+ A05B FE 00            CP      BALL_DIRECTION_NONE
3262+ A05D 28 36            JR      Z, .after_row_choice
3263+ A05F
3264+ A05F FE 01            CP      BALL_DIRECTION_NORTH
3265+ A061 28 1D            JR      Z, .north_direction
3266+ A063 FE 02            CP      BALL_DIRECTION_NORTH_EAST
3267+ A065 28 19            JR      Z, .north_direction
3268+ A067 FE 03            CP      BALL_DIRECTION_NORTH_WEST
3269+ A069 28 15            JR      Z, .north_direction
3270+ A06B              .south_direction:
3271+ A06B 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3272+ A06E FE 00            CP      FIELD_SOUTH_SIDE
3273+ A070 28 07            JR      Z, .south_direction_south_side
3274+ A072              .south_direction_north_side:
3275+ A072 3E 02            LD      A, 2
3276+ A074 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3277+ A077 18 1C            JR      .after_row_choice
3278+ A079              .south_direction_south_side:
3279+ A079 3E 03            LD      A, 3
3280+ A07B 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3281+ A07E 18 15            JR      .after_row_choice
3282+ A080              .north_direction:
3283+ A080 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3284+ A083 FE 00            CP      FIELD_SOUTH_SIDE
3285+ A085 28 07            JR      Z, .north_direction_south_side
3286+ A087              .north_direction_north_side:
3287+ A087 3E 02            LD      A, 2
3288+ A089 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3289+ A08C 18 07            JR      .after_row_choice
3290+ A08E              .north_direction_south_side:
3291+ A08E 3E 01            LD      A, 1
3292+ A090 32 D9 B1         LD      (Var_Game_TmpAskedMovingRow), A
3293+ A093 18 00            JR      .after_row_choice
3294+ A095
3295+ A095              .after_row_choice:
3296+ A095
3297+ A095 3E 00            LD      A, NO
3298+ A097 32 DA B1         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3299+ A09A 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3300+ A09D FE 01            CP      PLAYER_ASKED_DIRECTION_EAST
3301+ A09F 28 05            JR      Z, .AfterSort
3302+ A0A1 3E 01            LD      A, YES
3303+ A0A3 32 DA B1         LD      (Var_Game_TmpMoveReadRowPlayersFromLeft), A
3304+ A0A6              .AfterSort:
3305+ A0A6 CD 5A 9A         CALL    Game_GetPlayerIdWithBall
3306+ A0A9 FE 01            CP      TEAM_WHITE
3307+ A0AB CA DE A0         JP      Z,.WithBallPossession
3308+ A0AE FE 65            CP      BALL_STATUS_CONTENDED
3309+ A0B0 CA D5 A0         JP      Z,.ContendedBall
3310+ A0B3
3311+ A0B3 3A D9 B1         LD      A, (Var_Game_TmpAskedMovingRow)
3312+ A0B6 CD 7B A3         CALL    GetAllPlayersOnARow
3313+ A0B9 C5               PUSH    BC
3314+ A0BA 48               LD      C, B
3315+ A0BB 06 01            LD      B, TEAM_WHITE
3316+ A0BD 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3317+ A0C0 CD 79 9E         CALL    Game_TryMovePlayerHorizontally
3318+ A0C3 C1               POP     BC
3319+ A0C4 79               LD      A, C
3320+ A0C5 FE FF            CP      NO_VALUE
3321+ A0C7 20 02            JR      NZ, .NoBallPossessionSecondPlayer
3322+ A0C9 18 20            JR      .Done
3323+ A0CB              .NoBallPossessionSecondPlayer:
3324+ A0CB 06 01            LD      B, TEAM_WHITE
3325+ A0CD 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3326+ A0D0 CD 79 9E         CALL    Game_TryMovePlayerHorizontally
3327+ A0D3 18 16            JR      .Done
3328+ A0D5
3329+ A0D5              .ContendedBall:
3330+ A0D5 CD 4D 95         CALL    Game_GetBallPosition
3331+ A0D8 14               INC     D
3332+ A0D9 CD 2F 96         CALL    Game_GetPlayerInfoByPos
3333+ A0DC 79               LD      A, C
3334+ A0DD 67               LD      H, A
3335+ A0DE              .WithBallPossession:
3336+ A0DE 7C               LD      A, H
3337+ A0DF FE FF            CP      NO_VALUE
3338+ A0E1 C8               RET     Z
3339+ A0E2 4F               LD      C, A
3340+ A0E3 06 01            LD      B, TEAM_WHITE
3341+ A0E5 3A C8 B1         LD      A, (Var_Game_MoveTmpDir)
3342+ A0E8 CD 79 9E         CALL    Game_TryMovePlayerHorizontally
3343+ A0EB              .Done:
3344+ A0EB C9               RET
3345+ A0EC
3346+ A0EC              ; -----------------------------------------------------------
3347+ A0EC              ; Show game over
3348+ A0EC              ;
3349+ A0EC              ; INPUT: -
3350+ A0EC              ; OUTPUT: -
3351+ A0EC              ; MODIFIES:
3352+ A0EC              ;   A, HL, BC
3353+ A0EC              ; -----------------------------------------------------------
3354+ A0EC              Game_GameOver:
3355+ A0EC CD 58 81         CALL    Hooks_TickStop
3356+ A0EF 3E 00            LD      A, NO
3357+ A0F1 32 E7 B1         LD      (Var_Game_MatchInProgress), A
3358+ A0F4 26 00            LD      H, 0
3359+ A0F6 2E 00            LD      L, 0
3360+ A0F8 11 B9 B1         LD      DE, Var_Utils_NumberToPrint
3361+ A0FB CD 07 81         CALL    String_NumberToASCII
3362+ A0FE 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
3363+ A101 CD 2C 81         CALL    String_RemoveLeadingZeros
3364+ A104 21 B9 B1         LD      HL, Var_Utils_NumberToPrint
3365+ A107 16 01            LD      D, 1
3366+ A109 1E 17            LD      E, 23
3367+ A10B CD 63 88         CALL    VDP_PrintString
3368+ A10E
3369+ A10E 21 FD 80         LD      HL, TXT_GAME_OVER
3370+ A111 16 0A            LD      D, 10
3371+ A113 1E 06            LD      E, 6
3372+ A115 CD 63 88         CALL    VDP_PrintString
3373+ A118 FB               EI
3374+ A119              .Loop:
3375+ A119 CD D5 92         CALL    Utils_ReadKeyboard
3376+ A11C FE 20            CP      KBD_KEY_SPACE   ; KBD
3377+ A11E 20 F9            JR      NZ, .Loop
3378+ A120 CD 63 91         CALL    Menu_Show
3379+ A123 C3 AA AA         JP      MainLoop
3380+ A126
3381+ A126              ; ---------------------------------------------------------------------------
3382+ A126              ; Game_CheckStoppedBallOnGoalOrCorner
3383+ A126              ;
3384+ A126              ; Esegue controlli SOLO se la palla è ferma (BALL_DIRECTION_NONE).
3385+ A126              ; Se la palla è sulla riga di fondo/porta del campo attivo:
3386+ A126              ;   - X=0 o X=4  -> BallIsInCornerArea
3387+ A126              ;   - X=1..3     -> se portiere sulla stessa cella: BallIsInGoalkeeperHands
3388+ A126              ;                  altrimenti: BallIsInGoal
3389+ A126              ;
3390+ A126              ; Usa:
3391+ A126              ;   Var_Game_BallDirection
3392+ A126              ;   Var_Game_ActiveFieldSide
3393+ A126              ;   Game_GetBallPosition      -> DE (D=Y, E=X)
3394+ A126              ;   Game_GetPlayerInfoById    -> HL cur (H=Y, L=X)
3395+ A126              ;
3396+ A126              ; MODIFIES: AF,BC,DE,HL
3397+ A126              ; ---------------------------------------------------------------------------
3398+ A126              Game_CheckStoppedBallOnGoalOrCorner:
3399+ A126 F5               push af
3400+ A127 C5               push bc
3401+ A128 D5               push de
3402+ A129 E5               push hl
3403+ A12A
3404+ A12A                  ; Solo se palla ferma
3405+ A12A 3A E2 B1         ld   a,(Var_Game_BallDirection)
3406+ A12D FE 00            cp   BALL_DIRECTION_NONE
3407+ A12F 20 5C            jr   nz,.done
3408+ A131
3409+ A131              ;    ; Solo se palla ferma
3410+ A131              ;    ld   a,(Var_Hooks_BlinkingIsActive)
3411+ A131              ;    cp   YES
3412+ A131              ;    jr   z,.done
3413+ A131
3414+ A131                  ; Leggi posizione palla: D=Y, E=X
3415+ A131 CD 4D 95         call Game_GetBallPosition
3416+ A134
3417+ A134                  ; Determina se siamo su riga di fondo/porta del campo attivo
3418+ A134 3A C2 B1         ld   a,(Var_Game_ActiveFieldSide)
3419+ A137 FE 00            cp   FIELD_SOUTH_SIDE
3420+ A139 20 28            jr   nz,.field_north
3421+ A13B
3422+ A13B              ; ===== CAMPO SOUTH: fondo/porta è riga 4 =====
3423+ A13B              .field_south:
3424+ A13B 7A               ld   a,d
3425+ A13C FE 04            cp   4
3426+ A13E 20 4D            jr   nz,.done
3427+ A140
3428+ A140                  ; Se X=0 o 4 -> corner
3429+ A140 7B               ld   a,e
3430+ A141 B7               or   a
3431+ A142 28 46            jr   z,.corner
3432+ A144 FE 04            cp   4
3433+ A146 28 42            jr   z,.corner
3434+ A148
3435+ A148                  ; X=1..3 -> verifica portiere BIANCO (TEAM_WHITE, ID=0)
3436+ A148 06 01            ld   b,TEAM_WHITE
3437+ A14A 0E 00            ld   c,0
3438+ A14C D5               push de                  ; salva palla
3439+ A14D CD 14 96         call Game_GetPlayerInfoById   ; HL = cur (H=Y, L=X)
3440+ A150 D1               pop  de
3441+ A151
3442+ A151 7C               ld   a,h
3443+ A152 BA               cp   d
3444+ A153 20 09            jr   nz,.goal
3445+ A155 7D               ld   a,l
3446+ A156 BB               cp   e
3447+ A157 20 05            jr   nz,.goal
3448+ A159
3449+ A159 CD E6 A1         call BallIsInGoalkeeperHands
3450+ A15C 18 2F            jr   .done
3451+ A15E
3452+ A15E              .goal:
3453+ A15E CD 93 A1         call BallIsInGoal
3454+ A161 18 2A            jr   .done
3455+ A163
3456+ A163              ; ===== CAMPO NORTH: fondo/porta è riga 0 =====
3457+ A163              .field_north:
3458+ A163 7A               ld   a,d
3459+ A164 B7               or   a
3460+ A165 20 26            jr   nz,.done
3461+ A167
3462+ A167                  ; Se X=0 o 4 -> corner
3463+ A167 7B               ld   a,e
3464+ A168 B7               or   a
3465+ A169 28 1F            jr   z,.corner
3466+ A16B FE 04            cp   4
3467+ A16D 28 1B            jr   z,.corner
3468+ A16F
3469+ A16F                  ; X=1..3 -> verifica portiere NERO (TEAM_BLACK, ID=0)
3470+ A16F 06 00            ld   b,TEAM_BLACK
3471+ A171 0E 00            ld   c,0
3472+ A173 D5               push de
3473+ A174 CD 14 96         call Game_GetPlayerInfoById
3474+ A177 D1               pop  de
3475+ A178
3476+ A178 7C               ld   a,h
3477+ A179 BA               cp   d
3478+ A17A 20 09            jr   nz,.goal2
3479+ A17C 7D               ld   a,l
3480+ A17D BB               cp   e
3481+ A17E 20 05            jr   nz,.goal2
3482+ A180
3483+ A180 CD E6 A1         call BallIsInGoalkeeperHands
3484+ A183 18 08            jr   .done
3485+ A185
3486+ A185              .goal2:
3487+ A185 CD 93 A1         call BallIsInGoal
3488+ A188 18 03            jr   .done
3489+ A18A
3490+ A18A              .corner:
3491+ A18A CD CE A1         call BallIsInCornerArea
3492+ A18D
3493+ A18D              .done:
3494+ A18D E1               pop  hl
3495+ A18E D1               pop  de
3496+ A18F C1               pop  bc
3497+ A190 F1               pop  af
3498+ A191 C9               ret
3499+ A192
3500+ A192              ; ---------------------------------------------------------------------------
3501+ A192              ; Game_GoalCerimony
3502+ A192              ; ----------------------------------------------------------------------------
3503+ A192              Game_GoalCerimony:
3504+ A192 C9               RET
3505+ A193              ; ---------------------------------------------------------------------------
3506+ A193              ; BallIsInGoal
3507+ A193              ; ----------------------------------------------------------------------------
3508+ A193              BallIsInGoal:
3509+ A193 CD 5C 88         CALL    Hooks_UpdateTimeToPlay
3510+ A196 CD 58 81         CALL    Hooks_TickStop
3511+ A199
3512+ A199 3E 40            LD      A, TILE_BALL_BOTTOM
3513+ A19B 47               LD      B, A
3514+ A19C 3E D6            LD      A, TILE_FIELD
3515+ A19E 4F               LD      C, A
3516+ A19F 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3517+ A1A2 FE 01            CP      FIELD_NORTH_SIDE
3518+ A1A4 20 1F            JR      NZ, .BlackGoal
3519+ A1A6 3E 03            LD      A, TILE_CORNER_BALL
3520+ A1A8 47               LD      B, A
3521+ A1A9 3A DE B1         LD      A, (Var_Game_ScoreWhite)
3522+ A1AC 3C               INC     A
3523+ A1AD 32 DE B1         LD     (Var_Game_ScoreWhite), A
3524+ A1B0              .TileBlinking:
3525+ A1B0 D5               PUSH    DE
3526+ A1B1 C5               PUSH    BC
3527+ A1B2 E5               PUSH    HL
3528+ A1B3 CD 02 91         CALL    VDP_ShowScores
3529+ A1B6 E1               POP     HL
3530+ A1B7 C1               POP     BC
3531+ A1B8 D1               POP     DE
3532+ A1B9 3E 01            LD      A, BLINK_TYPE_GOAL
3533+ A1BB 32 32 B2         LD     (Var_Hooks_BlinkingType), A
3534+ A1BE CD 08 A2         CALL    BlinkTileAtPosition
3535+ A1C1 CD C7 A9         call    Game_PlayBeepGoalCorner
3536+ A1C4 C9               RET
3537+ A1C5              .BlackGoal:
3538+ A1C5 3A D1 B1         LD      A, (Var_Game_ScoreBlack)
3539+ A1C8 3C               INC     A
3540+ A1C9 32 D1 B1         LD     (Var_Game_ScoreBlack), A
3541+ A1CC 18 E2            JR      .TileBlinking
3542+ A1CE              ; ---------------------------------------------------------------------------
3543+ A1CE              ; BallIsInCornerArea
3544+ A1CE              ; ----------------------------------------------------------------------------
3545+ A1CE              BallIsInCornerArea:
3546+ A1CE CD 5C 88         CALL    Hooks_UpdateTimeToPlay
3547+ A1D1 CD 58 81         CALL    Hooks_TickStop
3548+ A1D4 3E 03            LD      A, TILE_CORNER_BALL
3549+ A1D6 47               LD      B, A
3550+ A1D7 3E 04            LD      A, TILE_CORNER_BALL_EMPTY
3551+ A1D9 4F               LD      C, A
3552+ A1DA              .TileBlinking:
3553+ A1DA 3E 02            LD      A, BLINK_TYPE_CORNER
3554+ A1DC 32 32 B2         LD     (Var_Hooks_BlinkingType), A
3555+ A1DF CD 08 A2         CALL    BlinkTileAtPosition
3556+ A1E2 CD C7 A9         call    Game_PlayBeepGoalCorner
3557+ A1E5 C9               RET
3558+ A1E6              ; ---------------------------------------------------------------------------
3559+ A1E6              ; BallIsInGoalkeeperHands
3560+ A1E6              ; ----------------------------------------------------------------------------
3561+ A1E6              BallIsInGoalkeeperHands:
3562+ A1E6 CD 5C 88         CALL    Hooks_UpdateTimeToPlay
3563+ A1E9 CD 58 81         CALL    Hooks_TickStop
3564+ A1EC 3E 70            LD      A, TILE_WHITE_GOALKEEPER_WITH_BALL
3565+ A1EE 47               LD      B, A
3566+ A1EF 3E D6            LD      A, TILE_FIELD
3567+ A1F1 4F               LD      C, A
3568+ A1F2 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3569+ A1F5 FE 01            CP      FIELD_NORTH_SIDE
3570+ A1F7 20 03            JR      NZ, .TileBlinking
3571+ A1F9 3E 90            LD      A, TILE_BLACK_GOALKEEPER_WITH_BALL
3572+ A1FB 47               LD      B, A
3573+ A1FC              .TileBlinking:
3574+ A1FC 3E 03            LD      A, BLINK_TYPE_GOALKEEPER
3575+ A1FE 32 32 B2         LD     (Var_Hooks_BlinkingType), A
3576+ A201 CD 08 A2         CALL    BlinkTileAtPosition
3577+ A204 CD C7 A9         call    Game_PlayBeepGoalCorner
3578+ A207 C9               RET
3579+ A208              ; ---------------------------------------------------------------------------
3580+ A208              ; BlinkTileAtPosition
3581+ A208              ;INPUT: B: tile to show - C: tile to hide
3582+ A208              ; ----------------------------------------------------------------------------
3583+ A208              BlinkTileAtPosition:
3584+ A208 32 32 B2         LD     (Var_Hooks_BlinkingType), A
3585+ A20B AF               XOR    A
3586+ A20C 32 36 B2         LD     (Var_Hooks_BlinkingCounter), A
3587+ A20F 32 36 B2         LD     (Var_Hooks_BlinkingCounter), A
3588+ A212 78               LD     A, B
3589+ A213 32 33 B2         LD     (Var_Hooks_BlinkingTileToShow), A
3590+ A216 79               LD     A, C
3591+ A217 32 34 B2         LD     (Var_Hooks_BlinkingTileToHide), A
3592+ A21A 78               LD     A, B
3593+ A21B 32 35 B2         LD     (Var_Hooks_BlinkingActiveTile), A
3594+ A21E 3E 01            LD     A, YES
3595+ A220 32 3A B2         LD     (Var_Hooks_BlinkingMustResetFrameCounter), A
3596+ A223 32 39 B2         LD     (Var_Hooks_BlinkingIsActive), A
3597+ A226 C9               RET
3598+ A227              ; ---------------------------------------------------------------------------
3599+ A227              ; Set visible field side
3600+ A227              ; ---------------------------------------------------------------------------
3601+ A227              Game_SetVisibileFieldSide:
3602+ A227 CD 5A 9A         CALL    Game_GetPlayerIdWithBall
3603+ A22A FE 00            CP      TEAM_BLACK
3604+ A22C 28 1B            JR      Z, .SetSouthSide
3605+ A22E FE 01            CP      TEAM_WHITE
3606+ A230 28 01            JR      Z, .SetNorthSide
3607+ A232 C9               RET
3608+ A233              .SetNorthSide:
3609+ A233 47               LD      B, A
3610+ A234 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3611+ A237 FE 01            CP      FIELD_NORTH_SIDE
3612+ A239 C8               RET     Z
3613+ A23A 4C               LD      C, H
3614+ A23B CD 14 96         CALL    Game_GetPlayerInfoById
3615+ A23E 7C               LD      A, H
3616+ A23F FE 01            CP      1
3617+ A241 C0               RET     NZ
3618+ A242 3E 01            LD      A, FIELD_NORTH_SIDE
3619+ A244 32 C2 B1         LD      (Var_Game_ActiveFieldSide), A
3620+ A247 18 14            JR      .Done
3621+ A249              .SetSouthSide:
3622+ A249 47               LD      B, A
3623+ A24A 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3624+ A24D FE 00            CP      FIELD_SOUTH_SIDE
3625+ A24F C8               RET     Z
3626+ A250 4C               LD      C, H
3627+ A251 CD 14 96         CALL    Game_GetPlayerInfoById
3628+ A254 7C               LD      A, H
3629+ A255 FE 03            CP      3
3630+ A257 C0               RET     NZ
3631+ A258 3E 00            LD      A, FIELD_SOUTH_SIDE
3632+ A25A 32 C2 B1         LD      (Var_Game_ActiveFieldSide), A
3633+ A25D              .Done:
3634+ A25D CD 58 81         CALL    Hooks_TickStop
3635+ A260 CD 73 8B         CALL    VDP_DrawField
3636+ A263 CD 6F A2         CALL    Game_PutPlayersToNewFieldSide
3637+ A266 3E FF            LD      A, NO_VALUE
3638+ A268 32 F0 B1         LD      (Var_Game_BallYOldPosition), A
3639+ A26B CD 50 81         CALL    Hooks_TickStart
3640+ A26E C9               RET
3641+ A26F              ;----------------------------------------------------------------------------
3642+ A26F              ; Game_PutPlayersToNewFieldSide
3643+ A26F              ; Adjust players positions according to the new field side
3644+ A26F              ; ----------------------------------------------------------------------------
3645+ A26F              Game_PutPlayersToNewFieldSide:
3646+ A26F 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
3647+ A272 FE 01            CP      FIELD_NORTH_SIDE
3648+ A274 20 74            JR      NZ, .SouthSide
3649+ A276              .NorthSide:
3650+ A276 06 00            LD      B, TEAM_BLACK
3651+ A278 0E 01            LD      C, 1
3652+ A27A              .NorthSide_BLoop:
3653+ A27A C5               PUSH    BC
3654+ A27B CD 14 96         CALL    Game_GetPlayerInfoById
3655+ A27E E5               PUSH    HL
3656+ A27F D1               POP     DE
3657+ A280 7A               LD      A, D
3658+ A281 FE 00            CP      0
3659+ A283 CC 66 A3         CALL    Z, .BlackMidlefieldersFromSouthToNorth ; (0 to 3)
3660+ A286 FE 02            CP      2
3661+ A288 CC 63 A3         CALL    Z, .BlackStrikersFromSouthToNorth ; (2 to 1)
3662+ A28B 3E 00            LD      A, TEAM_BLACK
3663+ A28D 47               LD      B, A
3664+ A28E CD ED 95         CALL    SetPlayerInfo
3665+ A291 C1               POP     BC
3666+ A292 0C               INC     C
3667+ A293 79               LD      A, C
3668+ A294 FE 04            CP      4
3669+ A296 28 02            JR      Z, .NorthSideWhiteTeam
3670+ A298 18 E0            JR      .NorthSide_BLoop
3671+ A29A              .NorthSideWhiteTeam:
3672+ A29A 06 01            LD      B, TEAM_WHITE
3673+ A29C 0E 00            LD      C, 0
3674+ A29E              .NorthSide_WLoop:
3675+ A29E C5               PUSH    BC
3676+ A29F CD 14 96         CALL    Game_GetPlayerInfoById
3677+ A2A2 E5               PUSH    HL
3678+ A2A3 D1               POP     DE
3679+ A2A4 7A               LD      A, D
3680+ A2A5 FE 03            CP      3
3681+ A2A7 CC 6C A3         CALL    Z, .WhiteDefendersFromSouthToNorth ; (3 to 2)
3682+ A2AA FE 01            CP      1
3683+ A2AC CC 69 A3         CALL    Z, .WhiteMidlefieldersFromSouthToNorth ; (1 to 4)
3684+ A2AF 3E 01            LD      A, TEAM_WHITE
3685+ A2B1 47               LD      B, A
3686+ A2B2 CD ED 95         CALL    SetPlayerInfo
3687+ A2B5 C1               POP     BC
3688+ A2B6 0C               INC     C
3689+ A2B7 79               LD      A, C
3690+ A2B8 FE 04            CP      4
3691+ A2BA CA BF A2         JP      Z, .NorthSideDonePlayers
3692+ A2BD 18 DF            JR      .NorthSide_WLoop
3693+ A2BF
3694+ A2BF              .NorthSideDonePlayers:
3695+ A2BF 06 00            LD      B, TEAM_BLACK
3696+ A2C1 0E 00            LD      C, 0
3697+ A2C3 C5               PUSH    BC
3698+ A2C4 CD 14 96         CALL    Game_GetPlayerInfoById
3699+ A2C7 C1               POP     BC
3700+ A2C8 16 00            LD      D, 0
3701+ A2CA 7D               LD      A, L
3702+ A2CB 5F               LD      E, A
3703+ A2CC CD ED 95         CALL    SetPlayerInfo
3704+ A2CF
3705+ A2CF 06 01            LD      B, TEAM_WHITE
3706+ A2D1 0E 00            LD      C, 0
3707+ A2D3 C5               PUSH    BC
3708+ A2D4 CD 14 96         CALL    Game_GetPlayerInfoById
3709+ A2D7 C1               POP     BC
3710+ A2D8 16 FF            LD      D, NO_VALUE
3711+ A2DA 7D               LD      A, L
3712+ A2DB 5F               LD      E, A
3713+ A2DC CD ED 95         CALL    SetPlayerInfo
3714+ A2DF CD 4D 95         CALL    Game_GetBallPosition
3715+ A2E2 3E 03            LD      A, 3
3716+ A2E4 57               LD      D, A
3717+ A2E5 CD 58 95         CALL    Game_SetBallPosition
3718+ A2E8
3719+ A2E8 18 70            JR      .Done
3720+ A2EA              .SouthSide:
3721+ A2EA 06 00            LD      B, TEAM_BLACK
3722+ A2EC 0E 01            LD      C, 1
3723+ A2EE              .SouthSide_BLoop:
3724+ A2EE C5               PUSH    BC
3725+ A2EF CD 14 96         CALL    Game_GetPlayerInfoById
3726+ A2F2 E5               PUSH    HL
3727+ A2F3 D1               POP     DE
3728+ A2F4 7A               LD      A, D
3729+ A2F5 FE 01            CP      1
3730+ A2F7 CC 6F A3         CALL    Z, .BlackDefendersFromNorthToSouth ; (1 to 2)
3731+ A2FA FE 03            CP      3
3732+ A2FC CC 72 A3         CALL    Z, .BlackMidlefieldersFromNorthToSouth ; (3 to 0)
3733+ A2FF 3E 00            LD      A, TEAM_BLACK
3734+ A301 47               LD      B, A
3735+ A302 CD ED 95         CALL    SetPlayerInfo
3736+ A305 C1               POP     BC
3737+ A306 0C               INC     C
3738+ A307 79               LD      A, C
3739+ A308 FE 04            CP      4
3740+ A30A 28 02            JR      Z, .SouthSideWhiteTeam
3741+ A30C 18 E0            JR      .SouthSide_BLoop
3742+ A30E              .SouthSideWhiteTeam:
3743+ A30E 06 01            LD      B, TEAM_WHITE
3744+ A310 0E 00            LD      C, 0
3745+ A312              .SouthSide_WLoop:
3746+ A312 C5               PUSH    BC
3747+ A313 CD 14 96         CALL    Game_GetPlayerInfoById
3748+ A316 E5               PUSH    HL
3749+ A317 D1               POP     DE
3750+ A318 7A               LD      A, D
3751+ A319 FE 02            CP      2
3752+ A31B CC 75 A3         CALL    Z, .WhiteStrikersFromNorthToSouth ; (2 to 3)
3753+ A31E FE 04            CP      4
3754+ A320 CC 78 A3         CALL    Z, .WhiteMidlefieldersFromNorthToSouth ; (4 to 1)
3755+ A323 3E 01            LD      A, TEAM_WHITE
3756+ A325 47               LD      B, A
3757+ A326 CD ED 95         CALL    SetPlayerInfo
3758+ A329 C1               POP     BC
3759+ A32A 0C               INC     C
3760+ A32B 79               LD      A, C
3761+ A32C FE 04            CP      4
3762+ A32E 28 02            JR      Z, .SouthSideDonePlayers
3763+ A330 18 E0            JR      .SouthSide_WLoop
3764+ A332              .SouthSideDonePlayers:
3765+ A332 06 00            LD      B, TEAM_BLACK
3766+ A334 0E 00            LD      C, 0
3767+ A336 C5               PUSH    BC
3768+ A337 CD 14 96         CALL    Game_GetPlayerInfoById
3769+ A33A C1               POP     BC
3770+ A33B 16 FF            LD      D, NO_VALUE
3771+ A33D 7D               LD      A, L
3772+ A33E 5F               LD      E, A
3773+ A33F CD ED 95         CALL    SetPlayerInfo
3774+ A342
3775+ A342 06 01            LD      B, TEAM_WHITE
3776+ A344 0E 00            LD      C, 0
3777+ A346 C5               PUSH    BC
3778+ A347 CD 14 96         CALL    Game_GetPlayerInfoById
3779+ A34A C1               POP     BC
3780+ A34B 16 04            LD      D, 4
3781+ A34D 7D               LD      A, L
3782+ A34E 5F               LD      E, A
3783+ A34F CD ED 95         CALL    SetPlayerInfo
3784+ A352 CD 4D 95         CALL    Game_GetBallPosition
3785+ A355 AF               XOR     A
3786+ A356 57               LD      D, A
3787+ A357 CD 58 95         CALL    Game_SetBallPosition
3788+ A35A
3789+ A35A
3790+ A35A              .Done:
3791+ A35A CD 7D 96         CALL    ClearAllPrevPositions
3792+ A35D 3E 01            LD      A, YES
3793+ A35F 32 3D B2         LD      (Var_Hooks_ForceVdpRedraw), A
3794+ A362 C9               RET
3795+ A363
3796+ A363              .BlackStrikersFromSouthToNorth:
3797+ A363 16 01            LD      D, 1
3798+ A365 C9               RET
3799+ A366              .BlackMidlefieldersFromSouthToNorth:
3800+ A366 16 03            LD      D, 3
3801+ A368 C9               RET
3802+ A369              .WhiteMidlefieldersFromSouthToNorth:
3803+ A369 16 04            LD      D, 4
3804+ A36B C9               RET
3805+ A36C              .WhiteDefendersFromSouthToNorth:
3806+ A36C 16 02            LD      D, 2
3807+ A36E C9               RET
3808+ A36F              .BlackDefendersFromNorthToSouth:
3809+ A36F 16 02            LD      D, 2
3810+ A371 C9               RET
3811+ A372              .BlackMidlefieldersFromNorthToSouth:
3812+ A372 16 00            LD      D, 0
3813+ A374 C9               RET
3814+ A375              .WhiteStrikersFromNorthToSouth:
3815+ A375 16 03            LD      D, 3
3816+ A377 C9               RET
3817+ A378              .WhiteMidlefieldersFromNorthToSouth:
3818+ A378 16 01            LD      D, 1
3819+ A37A C9               RET
3820+ A37B
3821+ A37B              ;---------------------------------------------------------------------------
3822+ A37B              ; Get all players on a row
3823+ A37B              ; INPUT:
3824+ A37B              ;   A = Row
3825+ A37B              ; OUTPUT:
3826+ A37B              ;   B: First player found on that row (ID)
3827+ A37B              ;   C: Second player found on that row (ID) or NO_VALUE
3828+ A37B              ;----------------------------------------------------------------------------
3829+ A37B              GetAllPlayersOnARow:
3830+ A37B 26 FF            LD   H, NO_VALUE
3831+ A37D 2E FF            LD   L, NO_VALUE
3832+ A37F
3833+ A37F 57               LD   D, A
3834+ A380 3A DA B1         LD   A, (Var_Game_TmpMoveReadRowPlayersFromLeft)
3835+ A383 FE 01            CP   YES
3836+ A385 20 23            JR   NZ, .SearchFromRight
3837+ A387 1E 00            LD   E, 0
3838+ A389              .LoopLeft:
3839+ A389 D5               PUSH  DE
3840+ A38A E5               PUSH  HL
3841+ A38B CD 2F 96         CALL Game_GetPlayerInfoByPos
3842+ A38E E1               POP   HL
3843+ A38F FE FF            CP  NO_VALUE
3844+ A391 28 09            JR  Z, .NextLeft
3845+ A393 7C               LD  A, H
3846+ A394 FE FF            CP  NO_VALUE
3847+ A396 20 03            JR  NZ, .LoopLeftL
3848+ A398 61               LD  H, C
3849+ A399 18 01            JR  .NextLeft
3850+ A39B              .LoopLeftL:
3851+ A39B 69               LD  L, C
3852+ A39C              .NextLeft:
3853+ A39C D1               POP DE
3854+ A39D 1C               INC E
3855+ A39E 7D               LD  A, L
3856+ A39F FE FF            CP  NO_VALUE
3857+ A3A1 20 2A            JR  NZ, .Done
3858+ A3A3 7B               LD   A, E
3859+ A3A4 FE 05            CP  5
3860+ A3A6 28 25            JR Z,.Done
3861+ A3A8 18 DF            JR  .LoopLeft
3862+ A3AA              .SearchFromRight:
3863+ A3AA 1E 04            LD   E, 4
3864+ A3AC              .LoopRight:
3865+ A3AC D5               PUSH  DE
3866+ A3AD E5               PUSH  HL
3867+ A3AE CD 2F 96         CALL Game_GetPlayerInfoByPos
3868+ A3B1 E1               POP   HL
3869+ A3B2 FE FF            CP  NO_VALUE
3870+ A3B4 28 09            JR  Z, .NextRight
3871+ A3B6 7C               LD  A, H
3872+ A3B7 FE FF            CP  NO_VALUE
3873+ A3B9 20 03            JR  NZ, .LoopRightL
3874+ A3BB 61               LD  H, C
3875+ A3BC 18 01            JR .NextRight
3876+ A3BE              .LoopRightL:
3877+ A3BE 69               LD  L, C
3878+ A3BF              .NextRight:
3879+ A3BF D1               POP DE
3880+ A3C0 1D               DEC E
3881+ A3C1 7D               LD  A, L
3882+ A3C2 FE FF            CP  NO_VALUE
3883+ A3C4 20 07            JR NZ, .Done
3884+ A3C6 7B               LD   A, E
3885+ A3C7 FE FF            CP  255
3886+ A3C9 28 02            JR Z, .Done
3887+ A3CB 18 DF            JR  .LoopRight
3888+ A3CD
3889+ A3CD              .Done:
3890+ A3CD 44               ld B,H
3891+ A3CE 4D               ld C,L
3892+ A3CF C9               RET
3893+ A3D0              Game_Start:
3894+ A3D0 CD 7D 86         CALL    Hooks_InitAICounters
3895+ A3D3 3E 00            LD      A, NO
3896+ A3D5 32 39 B2         LD      (Var_Hooks_BlinkingIsActive), A
3897+ A3D8 3E 01            LD      A, 1
3898+ A3DA 32 C4 B1         LD      (Var_Game_SelectedLevel), A
3899+ A3DD AF               XOR     A
3900+ A3DE 32 BE B1         LD      (Var_Utils_NumberToPrint+5),A
3901+ A3E1 32 40 B2         LD      (Var_Hooks_TickCounter),A
3902+ A3E4 3E 05            LD      A, TICK_SPEED
3903+ A3E6 32 3E B2         LD      (Var_Hooks_TickSpeed), A
3904+ A3E9 3E 01            LD      A, FIELD_NORTH_SIDE
3905+ A3EB 32 C2 B1         LD      (Var_Game_ActiveFieldSide), A
3906+ A3EE CD 73 8B         CALL    VDP_DrawField
3907+ A3F1 CD 9D 96         CALL    Game_SetWhiteKickoffSchema
3908+ A3F4 CD D1 8E         CALL    VDP_PlayerMatrixRedraw
3909+ A3F7 CD 58 81         call    Hooks_TickStop
3910+ A3FA CD BD 98         CALL    Game_Resume
3911+ A3FD 3E 01            LD      A, YES
3912+ A3FF 32 37 B2         LD      (Var_Hooks_GameResumingWaiting), A
3913+ A402
3914+ A402
3915+ A402                  ;ld   hl,SND_DATA
3916+ A402                  ;ld   de,SND_LEN        ; 1543 per il tuo file
3917+ A402                  ;call Sounds_PlayHLDE      ; parte la riproduzione in background
3918+ A402
3919+ A402
3920+ A402 C9               RET
3921+ A403
3922+ A403              ; ---------------------------------------------------------------------------
3923+ A403              ; ClearGameFieldForGoalCerimony
3924+ A403              ; ----------------------------------------------------------------------------
3925+ A403              Game_ClearGameFieldForGoalCerimony:
3926+ A403 F5               PUSH    AF
3927+ A404 C5               PUSH    BC
3928+ A405 D5               PUSH    DE
3929+ A406 E5               PUSH    HL
3930+ A407 3A C2 B1         LD      A,(Var_Game_ActiveFieldSide)
3931+ A40A FE 01            CP      FIELD_NORTH_SIDE
3932+ A40C 20 1D            JR      NZ, .SouthSideClear
3933+ A40E              .NorthSideClear:
3934+ A40E 16 01            LD      D, 1
3935+ A410              .Loop_North_Rows:
3936+ A410 D5               PUSH    DE
3937+ A411 1E 00            LD      E, 0
3938+ A413              .Loop_North_Cols:
3939+ A413 D5               PUSH    DE
3940+ A414 3E D6            LD      A,TILE_FIELD
3941+ A416
3942+ A416 CD 05 89         CALL    VDP_DrawSprite
3943+ A419 D1               POP     DE
3944+ A41A 1C               INC     E
3945+ A41B 7B               LD      A, E
3946+ A41C FE 05            CP      5
3947+ A41E 28 02            JR      Z,.Done_North_Rows
3948+ A420 18 F1            JR      .Loop_North_Cols
3949+ A422              .Done_North_Rows:
3950+ A422 D1               POP     DE
3951+ A423 14               INC     D
3952+ A424 7A               LD      A, D
3953+ A425 FE 05            CP      5
3954+ A427 28 1F            JR      Z,.Done
3955+ A429 18 E5            JR      .Loop_North_Rows
3956+ A42B
3957+ A42B              .SouthSideClear:
3958+ A42B 16 00            LD      D, 0
3959+ A42D              .Loop_South_Rows:
3960+ A42D D5               PUSH    DE
3961+ A42E 1E 00            LD      E, 0
3962+ A430              .Loop_South_Cols:
3963+ A430 D5               PUSH    DE
3964+ A431 3E D6            LD      A,TILE_FIELD
3965+ A433
3966+ A433 CD 05 89         CALL    VDP_DrawSprite
3967+ A436 D1               POP     DE
3968+ A437 1C               INC     E
3969+ A438 7B               LD      A, E
3970+ A439 FE 05            CP      5
3971+ A43B 28 02            JR      Z,.Done_South_Rows
3972+ A43D 18 F1            JR      .Loop_South_Cols
3973+ A43F              .Done_South_Rows:
3974+ A43F D1               POP     DE
3975+ A440 14               INC     D
3976+ A441 7A               LD      A, D
3977+ A442 FE 04            CP      4
3978+ A444 28 02            JR      Z,.Done
3979+ A446 18 E5            JR      .Loop_South_Rows
3980+ A448
3981+ A448              .Done:
3982+ A448 E1               POP     HL
3983+ A449 D1               POP     DE
3984+ A44A C1               POP     BC
3985+ A44B F1               POP     AF
3986+ A44C C9               RET
3987+ A44D              ; ---------------------------------------------------------------------------
3988+ A44D              ; PutCerimonyWhitePlayersPos1
3989+ A44D              ; ----------------------------------------------------------------------------
3990+ A44D              PutCerimonyWhitePlayersPos1:
3991+ A44D CD 4C 93         CALL    Utils_PlayBeepTick
3992+ A450 16 02            LD      D, 2
3993+ A452 1E 00            LD      E, 0
3994+ A454 D5               PUSH    DE
3995+ A455 3E A0            LD      A,TILE_WHITE_PLAYER
3996+ A457
3997+ A457 CD 05 89         CALL    VDP_DrawSprite
3998+ A45A D1               POP     DE
3999+ A45B 16 02            LD      D, 2
4000+ A45D 1E 01            LD      E, 1
4001+ A45F D5               PUSH    DE
4002+ A460 3E A0            LD      A,TILE_WHITE_PLAYER
4003+ A462
4004+ A462 CD 05 89         CALL    VDP_DrawSprite
4005+ A465 D1               POP     DE
4006+ A466
4007+ A466 16 04            LD      D, 4
4008+ A468 1E 03            LD      E, 3
4009+ A46A D5               PUSH    DE
4010+ A46B 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4011+ A46D
4012+ A46D CD 05 89         CALL    VDP_DrawSprite
4013+ A470 D1               POP     DE
4014+ A471 16 04            LD      D, 4
4015+ A473 1E 04            LD      E, 4
4016+ A475 D5               PUSH    DE
4017+ A476 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4018+ A478
4019+ A478 CD 05 89         CALL    VDP_DrawSprite
4020+ A47B D1               POP     DE
4021+ A47C C9               RET
4022+ A47D
4023+ A47D              ; ---------------------------------------------------------------------------
4024+ A47D              ; PutCerimonyWhitePlayersPos2
4025+ A47D              ; ----------------------------------------------------------------------------
4026+ A47D              PutCerimonyWhitePlayersPos2:
4027+ A47D CD 4C 93         CALL    Utils_PlayBeepTick
4028+ A480 16 02            LD      D, 2
4029+ A482 1E 00            LD      E, 0
4030+ A484 D5               PUSH    DE
4031+ A485 3E D6            LD      A,TILE_FIELD
4032+ A487
4033+ A487 CD 05 89         CALL    VDP_DrawSprite
4034+ A48A D1               POP     DE
4035+ A48B 16 02            LD      D, 2
4036+ A48D 1E 02            LD      E, 2
4037+ A48F D5               PUSH    DE
4038+ A490 3E A0            LD      A,TILE_WHITE_PLAYER
4039+ A492
4040+ A492 CD 05 89         CALL    VDP_DrawSprite
4041+ A495 D1               POP     DE
4042+ A496
4043+ A496 16 04            LD      D, 4
4044+ A498 1E 02            LD      E, 2
4045+ A49A D5               PUSH    DE
4046+ A49B 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4047+ A49D
4048+ A49D CD 05 89         CALL    VDP_DrawSprite
4049+ A4A0 D1               POP     DE
4050+ A4A1 16 04            LD      D, 4
4051+ A4A3 1E 04            LD      E, 4
4052+ A4A5 D5               PUSH    DE
4053+ A4A6 3E D6            LD      A, TILE_FIELD
4054+ A4A8
4055+ A4A8 CD 05 89         CALL    VDP_DrawSprite
4056+ A4AB
4057+ A4AB 16 11            LD      D, 17
4058+ A4AD 1E 11            LD      E, 17
4059+ A4AF 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4060+ A4B1 CD 6F 88         CALL    VDP_PrintRamChar
4061+ A4B4 1E 12            LD      E, 18
4062+ A4B6 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4063+ A4B8 CD 6F 88         CALL    VDP_PrintRamChar
4064+ A4BB 1E 13            LD      E, 19
4065+ A4BD 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4066+ A4BF CD 6F 88         CALL    VDP_PrintRamChar
4067+ A4C2 1E 14            LD      E, 20
4068+ A4C4 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4069+ A4C6 CD 6F 88         CALL    VDP_PrintRamChar
4070+ A4C9
4071+ A4C9 16 11            LD      D, 17
4072+ A4CB 1E 0A            LD      E, 10
4073+ A4CD 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4074+ A4CF CD 6F 88         call    VDP_PrintRamChar
4075+ A4D2 16 11            LD      D, 17
4076+ A4D4 1E 0B            LD      E, 11
4077+ A4D6 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4078+ A4D8 CD 6F 88         call    VDP_PrintRamChar
4079+ A4DB
4080+ A4DB 16 11            LD      D, 17
4081+ A4DD 1E 0E            LD      E, 14
4082+ A4DF 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4083+ A4E1 CD 6F 88         call    VDP_PrintRamChar
4084+ A4E4 16 11            LD      D, 17
4085+ A4E6 1E 0F            LD      E, 15
4086+ A4E8 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4087+ A4EA CD 6F 88         call    VDP_PrintRamChar
4088+ A4ED
4089+ A4ED D1               POP     DE
4090+ A4EE C9               RET
4091+ A4EF              ; ---------------------------------------------------------------------------
4092+ A4EF              ; PutCerimonyWhitePlayersPos3
4093+ A4EF              ; ----------------------------------------------------------------------------
4094+ A4EF              PutCerimonyWhitePlayersPos3:
4095+ A4EF CD 4C 93         CALL    Utils_PlayBeepTick
4096+ A4F2 16 02            LD      D, 2
4097+ A4F4 1E 01            LD      E, 1
4098+ A4F6 D5               PUSH    DE
4099+ A4F7 3E D6            LD      A,TILE_FIELD
4100+ A4F9
4101+ A4F9 CD 05 89         CALL    VDP_DrawSprite
4102+ A4FC D1               POP     DE
4103+ A4FD 16 02            LD      D, 2
4104+ A4FF 1E 03            LD      E, 3
4105+ A501 D5               PUSH    DE
4106+ A502 3E A0            LD      A,TILE_WHITE_PLAYER
4107+ A504
4108+ A504 CD 05 89         CALL    VDP_DrawSprite
4109+ A507 D1               POP     DE
4110+ A508
4111+ A508 16 04            LD      D, 4
4112+ A50A 1E 01            LD      E, 1
4113+ A50C D5               PUSH    DE
4114+ A50D 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4115+ A50F
4116+ A50F CD 05 89         CALL    VDP_DrawSprite
4117+ A512 D1               POP     DE
4118+ A513 16 04            LD      D, 4
4119+ A515 1E 03            LD      E, 3
4120+ A517 D5               PUSH    DE
4121+ A518 3E D6            LD      A, TILE_FIELD
4122+ A51A
4123+ A51A CD 05 89         CALL    VDP_DrawSprite
4124+ A51D
4125+ A51D 16 11            LD      D, 17
4126+ A51F 1E 0D            LD      E, 13
4127+ A521 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4128+ A523 CD 6F 88         CALL    VDP_PrintRamChar
4129+ A526 1E 0E            LD      E, 14
4130+ A528 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4131+ A52A CD 6F 88         CALL    VDP_PrintRamChar
4132+ A52D 1E 0F            LD      E, 15
4133+ A52F 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4134+ A531 CD 6F 88         CALL    VDP_PrintRamChar
4135+ A534 1E 10            LD      E, 16
4136+ A536 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4137+ A538 CD 6F 88         CALL    VDP_PrintRamChar
4138+ A53B
4139+ A53B
4140+ A53B
4141+ A53B 16 11            LD      D, 17
4142+ A53D 1E 06            LD      E, 6
4143+ A53F 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4144+ A541 CD 6F 88         call    VDP_PrintRamChar
4145+ A544 16 11            LD      D, 17
4146+ A546 1E 07            LD      E, 7
4147+ A548 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4148+ A54A CD 6F 88         call    VDP_PrintRamChar
4149+ A54D 16 11            LD      D, 17
4150+ A54F 1E 0A            LD      E, 10
4151+ A551 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4152+ A553 CD 6F 88         call    VDP_PrintRamChar
4153+ A556 16 11            LD      D, 17
4154+ A558 1E 0B            LD      E, 11
4155+ A55A 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4156+ A55C CD 6F 88         call    VDP_PrintRamChar
4157+ A55F
4158+ A55F D1               POP     DE
4159+ A560 C9               RET
4160+ A561              ; ---------------------------------------------------------------------------
4161+ A561              ; PutCerimonyWhitePlayersPos4
4162+ A561              ; ----------------------------------------------------------------------------
4163+ A561              PutCerimonyWhitePlayersPos4:
4164+ A561 CD 4C 93         CALL    Utils_PlayBeepTick
4165+ A564 16 02            LD      D, 2
4166+ A566 1E 03            LD      E, 3
4167+ A568 D5               PUSH    DE
4168+ A569 3E D6            LD      A,TILE_FIELD
4169+ A56B
4170+ A56B CD 05 89         CALL    VDP_DrawSprite
4171+ A56E D1               POP     DE
4172+ A56F 16 02            LD      D, 2
4173+ A571 1E 01            LD      E, 1
4174+ A573 D5               PUSH    DE
4175+ A574 3E A0            LD      A,TILE_WHITE_PLAYER
4176+ A576
4177+ A576 CD 05 89         CALL    VDP_DrawSprite
4178+ A579 D1               POP     DE
4179+ A57A
4180+ A57A 16 04            LD      D, 4
4181+ A57C 1E 03            LD      E, 3
4182+ A57E D5               PUSH    DE
4183+ A57F 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4184+ A581
4185+ A581 CD 05 89         CALL    VDP_DrawSprite
4186+ A584 D1               POP     DE
4187+ A585 16 04            LD      D, 4
4188+ A587 1E 01            LD      E, 1
4189+ A589 D5               PUSH    DE
4190+ A58A 3E D6            LD      A, TILE_FIELD
4191+ A58C
4192+ A58C CD 05 89         CALL    VDP_DrawSprite
4193+ A58F
4194+ A58F 16 11            LD      D, 17
4195+ A591 1E 05            LD      E, 5
4196+ A593 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4197+ A595 CD 6F 88         CALL    VDP_PrintRamChar
4198+ A598 1E 06            LD      E, 6
4199+ A59A 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4200+ A59C CD 6F 88         CALL    VDP_PrintRamChar
4201+ A59F 1E 07            LD      E, 7
4202+ A5A1 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4203+ A5A3 CD 6F 88         CALL    VDP_PrintRamChar
4204+ A5A6 1E 08            LD      E, 8
4205+ A5A8 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4206+ A5AA CD 6F 88         CALL    VDP_PrintRamChar
4207+ A5AD
4208+ A5AD
4209+ A5AD 16 11            LD      D, 17
4210+ A5AF 1E 0A            LD      E, 10
4211+ A5B1 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4212+ A5B3 CD 6F 88         call    VDP_PrintRamChar
4213+ A5B6 16 11            LD      D, 17
4214+ A5B8 1E 0B            LD      E, 11
4215+ A5BA 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4216+ A5BC CD 6F 88         call    VDP_PrintRamChar
4217+ A5BF 16 11            LD      D, 17
4218+ A5C1 1E 0E            LD      E, 14
4219+ A5C3 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4220+ A5C5 CD 6F 88         call    VDP_PrintRamChar
4221+ A5C8 16 11            LD      D, 17
4222+ A5CA 1E 0F            LD      E, 15
4223+ A5CC 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4224+ A5CE CD 6F 88         call    VDP_PrintRamChar
4225+ A5D1
4226+ A5D1
4227+ A5D1 D1               POP     DE
4228+ A5D2 C9               RET
4229+ A5D3              ; ---------------------------------------------------------------------------
4230+ A5D3              ; PutCerimonyWhitePlayersPos5
4231+ A5D3              ; ----------------------------------------------------------------------------
4232+ A5D3              PutCerimonyWhitePlayersPos5:
4233+ A5D3 CD 4B 93         CALL    Utils_PlayBeepHighLong
4234+ A5D6 16 02            LD      D, 2
4235+ A5D8 1E 02            LD      E, 2
4236+ A5DA D5               PUSH    DE
4237+ A5DB 3E D6            LD      A,TILE_FIELD
4238+ A5DD
4239+ A5DD CD 05 89         CALL    VDP_DrawSprite
4240+ A5E0 D1               POP     DE
4241+ A5E1 16 02            LD      D, 2
4242+ A5E3 1E 00            LD      E, 0
4243+ A5E5 D5               PUSH    DE
4244+ A5E6 3E A0            LD      A,TILE_WHITE_PLAYER
4245+ A5E8
4246+ A5E8 CD 05 89         CALL    VDP_DrawSprite
4247+ A5EB D1               POP     DE
4248+ A5EC
4249+ A5EC 16 04            LD      D, 4
4250+ A5EE 1E 04            LD      E, 4
4251+ A5F0 D5               PUSH    DE
4252+ A5F1 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4253+ A5F3
4254+ A5F3 CD 05 89         CALL    VDP_DrawSprite
4255+ A5F6 D1               POP     DE
4256+ A5F7 16 04            LD      D, 4
4257+ A5F9 1E 02            LD      E, 2
4258+ A5FB D5               PUSH    DE
4259+ A5FC 3E D6            LD      A, TILE_FIELD
4260+ A5FE
4261+ A5FE CD 05 89         CALL    VDP_DrawSprite
4262+ A601
4263+ A601 16 11            LD      D, 17
4264+ A603 1E 09            LD      E, 9
4265+ A605 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4266+ A607 CD 6F 88         CALL    VDP_PrintRamChar
4267+ A60A 1E 0A            LD      E, 10
4268+ A60C 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4269+ A60E CD 6F 88         CALL    VDP_PrintRamChar
4270+ A611 1E 0B            LD      E, 11
4271+ A613 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4272+ A615 CD 6F 88         CALL    VDP_PrintRamChar
4273+ A618 1E 0C            LD      E, 12
4274+ A61A 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4275+ A61C CD 6F 88         CALL    VDP_PrintRamChar
4276+ A61F
4277+ A61F 16 11            LD      D, 17
4278+ A621 1E 0E            LD      E, 14
4279+ A623 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4280+ A625 CD 6F 88         call    VDP_PrintRamChar
4281+ A628 16 11            LD      D, 17
4282+ A62A 1E 0F            LD      E, 15
4283+ A62C 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4284+ A62E CD 6F 88         call    VDP_PrintRamChar
4285+ A631 16 11            LD      D, 17
4286+ A633 1E 12            LD      E, 18
4287+ A635 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4288+ A637 CD 6F 88         call    VDP_PrintRamChar
4289+ A63A 16 11            LD      D, 17
4290+ A63C 1E 13            LD      E, 19
4291+ A63E 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4292+ A640 CD 6F 88         call    VDP_PrintRamChar
4293+ A643
4294+ A643
4295+ A643 D1               POP     DE
4296+ A644 C9               RET
4297+ A645              ; ---------------------------------------------------------------------------
4298+ A645              ; PutCerimonyWhitePlayersPos6
4299+ A645              ; ----------------------------------------------------------------------------
4300+ A645              PutCerimonyWhitePlayersPos6:
4301+ A645 CD 4C 93         CALL    Utils_PlayBeepTick
4302+ A648 16 02            LD      D, 2
4303+ A64A 1E 00            LD      E, 0
4304+ A64C D5               PUSH    DE
4305+ A64D 3E D6            LD      A,TILE_FIELD
4306+ A64F
4307+ A64F CD 05 89         CALL    VDP_DrawSprite
4308+ A652 D1               POP     DE
4309+ A653 16 02            LD      D, 2
4310+ A655 1E 02            LD      E, 2
4311+ A657 D5               PUSH    DE
4312+ A658 3E A0            LD      A,TILE_WHITE_PLAYER
4313+ A65A
4314+ A65A CD 05 89         CALL    VDP_DrawSprite
4315+ A65D D1               POP     DE
4316+ A65E
4317+ A65E 16 04            LD      D, 4
4318+ A660 1E 02            LD      E, 2
4319+ A662 D5               PUSH    DE
4320+ A663 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4321+ A665
4322+ A665 CD 05 89         CALL    VDP_DrawSprite
4323+ A668 D1               POP     DE
4324+ A669 16 04            LD      D, 4
4325+ A66B 1E 04            LD      E, 4
4326+ A66D D5               PUSH    DE
4327+ A66E 3E D6            LD      A, TILE_FIELD
4328+ A670
4329+ A670 CD 05 89         CALL    VDP_DrawSprite
4330+ A673
4331+ A673 16 11            LD      D, 17
4332+ A675 1E 11            LD      E, 17
4333+ A677 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4334+ A679 CD 6F 88         CALL    VDP_PrintRamChar
4335+ A67C 1E 12            LD      E, 18
4336+ A67E 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4337+ A680 CD 6F 88         CALL    VDP_PrintRamChar
4338+ A683 1E 13            LD      E, 19
4339+ A685 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4340+ A687 CD 6F 88         CALL    VDP_PrintRamChar
4341+ A68A 1E 14            LD      E, 20
4342+ A68C 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4343+ A68E CD 6F 88         CALL    VDP_PrintRamChar
4344+ A691
4345+ A691 16 11            LD      D, 17
4346+ A693 1E 0E            LD      E, 14
4347+ A695 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4348+ A697 CD 6F 88         call    VDP_PrintRamChar
4349+ A69A 16 11            LD      D, 17
4350+ A69C 1E 0F            LD      E, 15
4351+ A69E 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4352+ A6A0 CD 6F 88         call    VDP_PrintRamChar
4353+ A6A3 16 11            LD      D, 17
4354+ A6A5 1E 0A            LD      E, 10
4355+ A6A7 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4356+ A6A9 CD 6F 88         call    VDP_PrintRamChar
4357+ A6AC 16 11            LD      D, 17
4358+ A6AE 1E 0B            LD      E, 11
4359+ A6B0 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4360+ A6B2 CD 6F 88         call    VDP_PrintRamChar
4361+ A6B5 D1               POP     DE
4362+ A6B6 C9               RET
4363+ A6B7              ; ---------------------------------------------------------------------------
4364+ A6B7              ; PutCerimonyWhitePlayersPos7
4365+ A6B7              ; ----------------------------------------------------------------------------
4366+ A6B7              PutCerimonyWhitePlayersPos7:
4367+ A6B7 CD 4C 93         CALL    Utils_PlayBeepTick
4368+ A6BA 16 02            LD      D, 2
4369+ A6BC 1E 01            LD      E, 1
4370+ A6BE D5               PUSH    DE
4371+ A6BF 3E D6            LD      A,TILE_FIELD
4372+ A6C1
4373+ A6C1 CD 05 89         CALL    VDP_DrawSprite
4374+ A6C4 D1               POP     DE
4375+ A6C5 16 02            LD      D, 2
4376+ A6C7 1E 03            LD      E, 3
4377+ A6C9 D5               PUSH    DE
4378+ A6CA 3E A0            LD      A,TILE_WHITE_PLAYER
4379+ A6CC
4380+ A6CC CD 05 89         CALL    VDP_DrawSprite
4381+ A6CF D1               POP     DE
4382+ A6D0
4383+ A6D0 16 04            LD      D, 4
4384+ A6D2 1E 01            LD      E, 1
4385+ A6D4 D5               PUSH    DE
4386+ A6D5 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4387+ A6D7
4388+ A6D7 CD 05 89         CALL    VDP_DrawSprite
4389+ A6DA D1               POP     DE
4390+ A6DB 16 04            LD      D, 4
4391+ A6DD 1E 03            LD      E, 3
4392+ A6DF D5               PUSH    DE
4393+ A6E0 3E D6            LD      A, TILE_FIELD
4394+ A6E2
4395+ A6E2 CD 05 89         CALL    VDP_DrawSprite
4396+ A6E5
4397+ A6E5 16 11            LD      D, 17
4398+ A6E7 1E 0D            LD      E, 13
4399+ A6E9 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4400+ A6EB CD 6F 88         CALL    VDP_PrintRamChar
4401+ A6EE 1E 0E            LD      E, 14
4402+ A6F0 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4403+ A6F2 CD 6F 88         CALL    VDP_PrintRamChar
4404+ A6F5 1E 0F            LD      E, 15
4405+ A6F7 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4406+ A6F9 CD 6F 88         CALL    VDP_PrintRamChar
4407+ A6FC 1E 10            LD      E, 16
4408+ A6FE 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4409+ A700 CD 6F 88         CALL    VDP_PrintRamChar
4410+ A703
4411+ A703
4412+ A703
4413+ A703 16 11            LD      D, 17
4414+ A705 1E 0A            LD      E, 10
4415+ A707 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4416+ A709 CD 6F 88         call    VDP_PrintRamChar
4417+ A70C 16 11            LD      D, 17
4418+ A70E 1E 0B            LD      E, 11
4419+ A710 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4420+ A712 CD 6F 88         call    VDP_PrintRamChar
4421+ A715 16 11            LD      D, 17
4422+ A717 1E 06            LD      E, 6
4423+ A719 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4424+ A71B CD 6F 88         call    VDP_PrintRamChar
4425+ A71E 16 11            LD      D, 17
4426+ A720 1E 07            LD      E, 7
4427+ A722 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4428+ A724 CD 6F 88         call    VDP_PrintRamChar
4429+ A727
4430+ A727
4431+ A727 D1               POP     DE
4432+ A728 C9               RET
4433+ A729              ; ---------------------------------------------------------------------------
4434+ A729              ; PutCerimonyWhitePlayersPos8
4435+ A729              ; ----------------------------------------------------------------------------
4436+ A729              PutCerimonyWhitePlayersPos8:
4437+ A729 CD 4C 93         CALL    Utils_PlayBeepTick
4438+ A72C 16 02            LD      D, 2
4439+ A72E 1E 03            LD      E, 3
4440+ A730 D5               PUSH    DE
4441+ A731 3E D6            LD      A,TILE_FIELD
4442+ A733
4443+ A733 CD 05 89         CALL    VDP_DrawSprite
4444+ A736 D1               POP     DE
4445+ A737 16 02            LD      D, 2
4446+ A739 1E 01            LD      E, 1
4447+ A73B D5               PUSH    DE
4448+ A73C 3E A0            LD      A,TILE_WHITE_PLAYER
4449+ A73E
4450+ A73E CD 05 89         CALL    VDP_DrawSprite
4451+ A741 D1               POP     DE
4452+ A742
4453+ A742 16 04            LD      D, 4
4454+ A744 1E 03            LD      E, 3
4455+ A746 D5               PUSH    DE
4456+ A747 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4457+ A749
4458+ A749 CD 05 89         CALL    VDP_DrawSprite
4459+ A74C D1               POP     DE
4460+ A74D 16 04            LD      D, 4
4461+ A74F 1E 01            LD      E, 1
4462+ A751 D5               PUSH    DE
4463+ A752 3E D6            LD      A, TILE_FIELD
4464+ A754
4465+ A754 CD 05 89         CALL    VDP_DrawSprite
4466+ A757
4467+ A757 16 11            LD      D, 17
4468+ A759 1E 05            LD      E, 5
4469+ A75B 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4470+ A75D CD 6F 88         CALL    VDP_PrintRamChar
4471+ A760 1E 06            LD      E, 6
4472+ A762 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4473+ A764 CD 6F 88         CALL    VDP_PrintRamChar
4474+ A767 1E 07            LD      E, 7
4475+ A769 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4476+ A76B CD 6F 88         CALL    VDP_PrintRamChar
4477+ A76E 1E 08            LD      E, 8
4478+ A770 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4479+ A772 CD 6F 88         CALL    VDP_PrintRamChar
4480+ A775
4481+ A775 16 11            LD      D, 17
4482+ A777 1E 0A            LD      E, 10
4483+ A779 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4484+ A77B CD 6F 88         call    VDP_PrintRamChar
4485+ A77E 16 11            LD      D, 17
4486+ A780 1E 0B            LD      E, 11
4487+ A782 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4488+ A784 CD 6F 88         call    VDP_PrintRamChar
4489+ A787 16 11            LD      D, 17
4490+ A789 1E 0E            LD      E, 14
4491+ A78B 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4492+ A78D CD 6F 88         call    VDP_PrintRamChar
4493+ A790 16 11            LD      D, 17
4494+ A792 1E 0F            LD      E, 15
4495+ A794 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4496+ A796 CD 6F 88         call    VDP_PrintRamChar
4497+ A799
4498+ A799
4499+ A799 D1               POP     DE
4500+ A79A C9               RET
4501+ A79B              ; ---------------------------------------------------------------------------
4502+ A79B              ; PutCerimonyWhitePlayersPos9
4503+ A79B              ; ----------------------------------------------------------------------------
4504+ A79B              PutCerimonyWhitePlayersPos9:
4505+ A79B CD 4C 93         CALL    Utils_PlayBeepTick
4506+ A79E 16 02            LD      D, 2
4507+ A7A0 1E 02            LD      E, 2
4508+ A7A2 D5               PUSH    DE
4509+ A7A3 3E D6            LD      A,TILE_FIELD
4510+ A7A5
4511+ A7A5 CD 05 89         CALL    VDP_DrawSprite
4512+ A7A8 D1               POP     DE
4513+ A7A9 16 02            LD      D, 2
4514+ A7AB 1E 00            LD      E, 0
4515+ A7AD D5               PUSH    DE
4516+ A7AE 3E A0            LD      A,TILE_WHITE_PLAYER
4517+ A7B0
4518+ A7B0 CD 05 89         CALL    VDP_DrawSprite
4519+ A7B3 D1               POP     DE
4520+ A7B4
4521+ A7B4 16 04            LD      D, 4
4522+ A7B6 1E 04            LD      E, 4
4523+ A7B8 D5               PUSH    DE
4524+ A7B9 3E 50            LD      A, TILE_WHITE_PLAYER_NEAR_HALF_FIELD
4525+ A7BB
4526+ A7BB CD 05 89         CALL    VDP_DrawSprite
4527+ A7BE D1               POP     DE
4528+ A7BF 16 04            LD      D, 4
4529+ A7C1 1E 02            LD      E, 2
4530+ A7C3 D5               PUSH    DE
4531+ A7C4 3E D6            LD      A, TILE_FIELD
4532+ A7C6
4533+ A7C6 CD 05 89         CALL    VDP_DrawSprite
4534+ A7C9
4535+ A7C9 16 11            LD      D, 17
4536+ A7CB 1E 09            LD      E, 9
4537+ A7CD 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4538+ A7CF CD 6F 88         CALL    VDP_PrintRamChar
4539+ A7D2 1E 0A            LD      E, 10
4540+ A7D4 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4541+ A7D6 CD 6F 88         CALL    VDP_PrintRamChar
4542+ A7D9 1E 0B            LD      E, 11
4543+ A7DB 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4544+ A7DD CD 6F 88         CALL    VDP_PrintRamChar
4545+ A7E0 1E 0C            LD      E, 12
4546+ A7E2 3E D2            LD      A, TILE_FIELD_LINE_HORIZONTAL
4547+ A7E4 CD 6F 88         CALL    VDP_PrintRamChar
4548+ A7E7
4549+ A7E7 16 11            LD      D, 17
4550+ A7E9 1E 0E            LD      E, 14
4551+ A7EB 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4552+ A7ED CD 6F 88         call    VDP_PrintRamChar
4553+ A7F0 16 11            LD      D, 17
4554+ A7F2 1E 0F            LD      E, 15
4555+ A7F4 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4556+ A7F6 CD 6F 88         call    VDP_PrintRamChar
4557+ A7F9 16 11            LD      D, 17
4558+ A7FB 1E 12            LD      E, 18
4559+ A7FD 3E D9            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_1
4560+ A7FF CD 6F 88         call    VDP_PrintRamChar
4561+ A802 16 11            LD      D, 17
4562+ A804 1E 13            LD      E, 19
4563+ A806 3E DA            ld      a,TILE_FIELD_LINE_WHITE_PLAYER_2
4564+ A808 CD 6F 88         call    VDP_PrintRamChar
4565+ A80B
4566+ A80B D1               POP     DE
4567+ A80C C9               RET
4568+ A80D
4569+ A80D
4570+ A80D
4571+ A80D
4572+ A80D
4573+ A80D
4574+ A80D
4575+ A80D
4576+ A80D
4577+ A80D
4578+ A80D              ; ---------------------------------------------------------------------------
4579+ A80D              ; PutCerimonyBlackPlayersPos1
4580+ A80D              ; ----------------------------------------------------------------------------
4581+ A80D              PutCerimonyBlackPlayersPos1:
4582+ A80D CD 4C 93         CALL    Utils_PlayBeepTick
4583+ A810 16 00            LD      D, 0
4584+ A812 1E 00            LD      E, 0
4585+ A814 D5               PUSH    DE
4586+ A815 3E B0            LD      A,TILE_BLACK_PLAYER
4587+ A817
4588+ A817 CD 05 89         CALL    VDP_DrawSprite
4589+ A81A D1               POP     DE
4590+ A81B 16 00            LD      D, 0
4591+ A81D 1E 01            LD      E, 1
4592+ A81F D5               PUSH    DE
4593+ A820 3E B0            LD      A,TILE_BLACK_PLAYER
4594+ A822
4595+ A822 CD 05 89         CALL    VDP_DrawSprite
4596+ A825 D1               POP     DE
4597+ A826
4598+ A826 16 02            LD      D, 2
4599+ A828 1E 03            LD      E, 3
4600+ A82A D5               PUSH    DE
4601+ A82B 3E B0            LD      A, TILE_BLACK_PLAYER
4602+ A82D
4603+ A82D CD 05 89         CALL    VDP_DrawSprite
4604+ A830 D1               POP     DE
4605+ A831 16 02            LD      D, 2
4606+ A833 1E 04            LD      E, 4
4607+ A835 D5               PUSH    DE
4608+ A836 3E B0            LD      A, TILE_BLACK_PLAYER
4609+ A838
4610+ A838 CD 05 89         CALL    VDP_DrawSprite
4611+ A83B D1               POP     DE
4612+ A83C C9               RET
4613+ A83D
4614+ A83D              ; ---------------------------------------------------------------------------
4615+ A83D              ; PutCerimonyBlackPlayersPos2
4616+ A83D              ; ----------------------------------------------------------------------------
4617+ A83D              PutCerimonyBlackPlayersPos2:
4618+ A83D CD 4C 93         CALL    Utils_PlayBeepTick
4619+ A840 16 00            LD      D, 0
4620+ A842 1E 00            LD      E, 0
4621+ A844 D5               PUSH    DE
4622+ A845 3E D6            LD      A,TILE_FIELD
4623+ A847
4624+ A847 CD 05 89         CALL    VDP_DrawSprite
4625+ A84A D1               POP     DE
4626+ A84B 16 00            LD      D, 0
4627+ A84D 1E 02            LD      E, 2
4628+ A84F D5               PUSH    DE
4629+ A850 3E B0            LD      A,TILE_BLACK_PLAYER
4630+ A852
4631+ A852 CD 05 89         CALL    VDP_DrawSprite
4632+ A855 D1               POP     DE
4633+ A856
4634+ A856 16 02            LD      D, 2
4635+ A858 1E 02            LD      E, 2
4636+ A85A D5               PUSH    DE
4637+ A85B 3E B0            LD      A, TILE_BLACK_PLAYER
4638+ A85D
4639+ A85D CD 05 89         CALL    VDP_DrawSprite
4640+ A860 D1               POP     DE
4641+ A861 16 02            LD      D, 2
4642+ A863 1E 04            LD      E, 4
4643+ A865 D5               PUSH    DE
4644+ A866 3E D6            LD      A, TILE_FIELD
4645+ A868
4646+ A868 CD 05 89         CALL    VDP_DrawSprite
4647+ A86B D1               POP     DE
4648+ A86C C9               RET
4649+ A86D              ; ---------------------------------------------------------------------------
4650+ A86D              ; PutCerimonyBlackPlayersPos3
4651+ A86D              ; ----------------------------------------------------------------------------
4652+ A86D              PutCerimonyBlackPlayersPos3:
4653+ A86D CD 4C 93         CALL    Utils_PlayBeepTick
4654+ A870 16 00            LD      D, 0
4655+ A872 1E 01            LD      E, 1
4656+ A874 D5               PUSH    DE
4657+ A875 3E D6            LD      A,TILE_FIELD
4658+ A877
4659+ A877 CD 05 89         CALL    VDP_DrawSprite
4660+ A87A D1               POP     DE
4661+ A87B 16 00            LD      D, 0
4662+ A87D 1E 03            LD      E, 3
4663+ A87F D5               PUSH    DE
4664+ A880 3E B0            LD      A,TILE_BLACK_PLAYER
4665+ A882
4666+ A882 CD 05 89         CALL    VDP_DrawSprite
4667+ A885 D1               POP     DE
4668+ A886
4669+ A886 16 02            LD      D, 2
4670+ A888 1E 01            LD      E, 1
4671+ A88A D5               PUSH    DE
4672+ A88B 3E B0            LD      A, TILE_BLACK_PLAYER
4673+ A88D
4674+ A88D CD 05 89         CALL    VDP_DrawSprite
4675+ A890 D1               POP     DE
4676+ A891 16 02            LD      D, 2
4677+ A893 1E 03            LD      E, 3
4678+ A895 D5               PUSH    DE
4679+ A896 3E D6            LD      A, TILE_FIELD
4680+ A898
4681+ A898 CD 05 89         CALL    VDP_DrawSprite
4682+ A89B D1               POP     DE
4683+ A89C C9               RET
4684+ A89D              ; ---------------------------------------------------------------------------
4685+ A89D              ; PutCerimonyBlackPlayersPos4
4686+ A89D              ; ----------------------------------------------------------------------------
4687+ A89D              PutCerimonyBlackPlayersPos4:
4688+ A89D CD 4C 93         CALL    Utils_PlayBeepTick
4689+ A8A0 16 00            LD      D, 0
4690+ A8A2 1E 03            LD      E, 3
4691+ A8A4 D5               PUSH    DE
4692+ A8A5 3E D6            LD      A,TILE_FIELD
4693+ A8A7
4694+ A8A7 CD 05 89         CALL    VDP_DrawSprite
4695+ A8AA D1               POP     DE
4696+ A8AB 16 00            LD      D, 0
4697+ A8AD 1E 01            LD      E, 1
4698+ A8AF D5               PUSH    DE
4699+ A8B0 3E B0            LD      A,TILE_BLACK_PLAYER
4700+ A8B2
4701+ A8B2 CD 05 89         CALL    VDP_DrawSprite
4702+ A8B5 D1               POP     DE
4703+ A8B6
4704+ A8B6 16 02            LD      D, 2
4705+ A8B8 1E 03            LD      E, 3
4706+ A8BA D5               PUSH    DE
4707+ A8BB 3E B0            LD      A, TILE_BLACK_PLAYER
4708+ A8BD
4709+ A8BD CD 05 89         CALL    VDP_DrawSprite
4710+ A8C0 D1               POP     DE
4711+ A8C1 16 02            LD      D, 2
4712+ A8C3 1E 01            LD      E, 1
4713+ A8C5 D5               PUSH    DE
4714+ A8C6 3E D6            LD      A, TILE_FIELD
4715+ A8C8
4716+ A8C8 CD 05 89         CALL    VDP_DrawSprite
4717+ A8CB D1               POP     DE
4718+ A8CC C9               RET
4719+ A8CD              ; ---------------------------------------------------------------------------
4720+ A8CD              ; PutCerimonyBlackPlayersPos5
4721+ A8CD              ; ----------------------------------------------------------------------------
4722+ A8CD              PutCerimonyBlackPlayersPos5:
4723+ A8CD CD 4B 93         CALL    Utils_PlayBeepHighLong
4724+ A8D0 16 00            LD      D, 0
4725+ A8D2 1E 02            LD      E, 2
4726+ A8D4 D5               PUSH    DE
4727+ A8D5 3E D6            LD      A,TILE_FIELD
4728+ A8D7
4729+ A8D7 CD 05 89         CALL    VDP_DrawSprite
4730+ A8DA D1               POP     DE
4731+ A8DB 16 00            LD      D, 0
4732+ A8DD 1E 00            LD      E, 0
4733+ A8DF D5               PUSH    DE
4734+ A8E0 3E B0            LD      A,TILE_BLACK_PLAYER
4735+ A8E2
4736+ A8E2 CD 05 89         CALL    VDP_DrawSprite
4737+ A8E5 D1               POP     DE
4738+ A8E6
4739+ A8E6 16 02            LD      D, 2
4740+ A8E8 1E 04            LD      E, 4
4741+ A8EA D5               PUSH    DE
4742+ A8EB 3E B0            LD      A, TILE_BLACK_PLAYER
4743+ A8ED
4744+ A8ED CD 05 89         CALL    VDP_DrawSprite
4745+ A8F0 D1               POP     DE
4746+ A8F1 16 02            LD      D, 2
4747+ A8F3 1E 02            LD      E, 2
4748+ A8F5 D5               PUSH    DE
4749+ A8F6 3E D6            LD      A, TILE_FIELD
4750+ A8F8
4751+ A8F8 CD 05 89         CALL    VDP_DrawSprite
4752+ A8FB D1               POP     DE
4753+ A8FC C9               RET
4754+ A8FD              ; ---------------------------------------------------------------------------
4755+ A8FD              ; PutCerimonyBlackPlayersPos6
4756+ A8FD              ; ----------------------------------------------------------------------------
4757+ A8FD              PutCerimonyBlackPlayersPos6:
4758+ A8FD CD 4C 93         CALL    Utils_PlayBeepTick
4759+ A900 16 00            LD      D, 0
4760+ A902 1E 00            LD      E, 0
4761+ A904 D5               PUSH    DE
4762+ A905 3E D6            LD      A,TILE_FIELD
4763+ A907
4764+ A907 CD 05 89         CALL    VDP_DrawSprite
4765+ A90A D1               POP     DE
4766+ A90B 16 00            LD      D, 0
4767+ A90D 1E 02            LD      E, 2
4768+ A90F D5               PUSH    DE
4769+ A910 3E B0            LD      A,TILE_BLACK_PLAYER
4770+ A912
4771+ A912 CD 05 89         CALL    VDP_DrawSprite
4772+ A915 D1               POP     DE
4773+ A916
4774+ A916 16 02            LD      D, 2
4775+ A918 1E 02            LD      E, 2
4776+ A91A D5               PUSH    DE
4777+ A91B 3E B0            LD      A, TILE_BLACK_PLAYER
4778+ A91D
4779+ A91D CD 05 89         CALL    VDP_DrawSprite
4780+ A920 D1               POP     DE
4781+ A921 16 02            LD      D, 2
4782+ A923 1E 04            LD      E, 4
4783+ A925 D5               PUSH    DE
4784+ A926 3E D6            LD      A, TILE_FIELD
4785+ A928
4786+ A928 CD 05 89         CALL    VDP_DrawSprite
4787+ A92B D1               POP     DE
4788+ A92C C9               RET
4789+ A92D              ; ---------------------------------------------------------------------------
4790+ A92D              ; PutCerimonyBlackPlayersPos7
4791+ A92D              ; ----------------------------------------------------------------------------
4792+ A92D              PutCerimonyBlackPlayersPos7:
4793+ A92D CD 4C 93         CALL    Utils_PlayBeepTick
4794+ A930 16 00            LD      D, 0
4795+ A932 1E 01            LD      E, 1
4796+ A934 D5               PUSH    DE
4797+ A935 3E D6            LD      A,TILE_FIELD
4798+ A937
4799+ A937 CD 05 89         CALL    VDP_DrawSprite
4800+ A93A D1               POP     DE
4801+ A93B 16 00            LD      D, 0
4802+ A93D 1E 03            LD      E, 3
4803+ A93F D5               PUSH    DE
4804+ A940 3E B0            LD      A,TILE_BLACK_PLAYER
4805+ A942
4806+ A942 CD 05 89         CALL    VDP_DrawSprite
4807+ A945 D1               POP     DE
4808+ A946
4809+ A946 16 02            LD      D, 2
4810+ A948 1E 01            LD      E, 1
4811+ A94A D5               PUSH    DE
4812+ A94B 3E B0            LD      A, TILE_BLACK_PLAYER
4813+ A94D
4814+ A94D CD 05 89         CALL    VDP_DrawSprite
4815+ A950 D1               POP     DE
4816+ A951 16 02            LD      D, 2
4817+ A953 1E 03            LD      E, 3
4818+ A955 D5               PUSH    DE
4819+ A956 3E D6            LD      A, TILE_FIELD
4820+ A958
4821+ A958 CD 05 89         CALL    VDP_DrawSprite
4822+ A95B D1               POP     DE
4823+ A95C C9               RET
4824+ A95D              ; ---------------------------------------------------------------------------
4825+ A95D              ; PutCerimonyBlackPlayersPos8
4826+ A95D              ; ----------------------------------------------------------------------------
4827+ A95D              PutCerimonyBlackPlayersPos8:
4828+ A95D CD 4C 93         CALL    Utils_PlayBeepTick
4829+ A960 16 00            LD      D, 0
4830+ A962 1E 03            LD      E, 3
4831+ A964 D5               PUSH    DE
4832+ A965 3E D6            LD      A,TILE_FIELD
4833+ A967
4834+ A967 CD 05 89         CALL    VDP_DrawSprite
4835+ A96A D1               POP     DE
4836+ A96B 16 00            LD      D, 0
4837+ A96D 1E 01            LD      E, 1
4838+ A96F D5               PUSH    DE
4839+ A970 3E B0            LD      A,TILE_BLACK_PLAYER
4840+ A972
4841+ A972 CD 05 89         CALL    VDP_DrawSprite
4842+ A975 D1               POP     DE
4843+ A976
4844+ A976 16 02            LD      D, 2
4845+ A978 1E 03            LD      E, 3
4846+ A97A D5               PUSH    DE
4847+ A97B 3E B0            LD      A, TILE_BLACK_PLAYER
4848+ A97D
4849+ A97D CD 05 89         CALL    VDP_DrawSprite
4850+ A980 D1               POP     DE
4851+ A981 16 02            LD      D, 2
4852+ A983 1E 01            LD      E, 1
4853+ A985 D5               PUSH    DE
4854+ A986 3E D6            LD      A, TILE_FIELD
4855+ A988
4856+ A988 CD 05 89         CALL    VDP_DrawSprite
4857+ A98B D1               POP     DE
4858+ A98C C9               RET
4859+ A98D              ; ---------------------------------------------------------------------------
4860+ A98D              ; PutCerimonyBlackPlayersPos9
4861+ A98D              ; ----------------------------------------------------------------------------
4862+ A98D              PutCerimonyBlackPlayersPos9:
4863+ A98D CD 4C 93         CALL    Utils_PlayBeepTick
4864+ A990 16 00            LD      D, 0
4865+ A992 1E 02            LD      E, 2
4866+ A994 D5               PUSH    DE
4867+ A995 3E D6            LD      A,TILE_FIELD
4868+ A997
4869+ A997 CD 05 89         CALL    VDP_DrawSprite
4870+ A99A D1               POP     DE
4871+ A99B 16 00            LD      D, 0
4872+ A99D 1E 00            LD      E, 0
4873+ A99F D5               PUSH    DE
4874+ A9A0 3E B0            LD      A,TILE_BLACK_PLAYER
4875+ A9A2
4876+ A9A2 CD 05 89         CALL    VDP_DrawSprite
4877+ A9A5 D1               POP     DE
4878+ A9A6
4879+ A9A6 16 02            LD      D, 2
4880+ A9A8 1E 04            LD      E, 4
4881+ A9AA D5               PUSH    DE
4882+ A9AB 3E B0            LD      A, TILE_BLACK_PLAYER
4883+ A9AD
4884+ A9AD CD 05 89         CALL    VDP_DrawSprite
4885+ A9B0 D1               POP     DE
4886+ A9B1 16 02            LD      D, 2
4887+ A9B3 1E 02            LD      E, 2
4888+ A9B5 D5               PUSH    DE
4889+ A9B6 3E D6            LD      A, TILE_FIELD
4890+ A9B8
4891+ A9B8 CD 05 89         CALL    VDP_DrawSprite
4892+ A9BB D1               POP     DE
4893+ A9BC C9               RET
4894+ A9BD              ; ---------------------------------------------------------------------------
4895+ A9BD              ; Game_PlayBeep
4896+ A9BD              ; ----------------------------------------------------------------------------
4897+ A9BD              Game_PlayBeep:
4898+ A9BD 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
4899+ A9C0 FE 01            CP      YES
4900+ A9C2 C0               RET     NZ
4901+ A9C3 CD 3B 93         CALL    Utils_PlayBeep
4902+ A9C6 C9               RET
4903+ A9C7              ; ---------------------------------------------------------------------------
4904+ A9C7              ; Game_PlayBeepGoalCorner
4905+ A9C7              ; ----------------------------------------------------------------------------
4906+ A9C7              Game_PlayBeepGoalCorner:
4907+ A9C7 3A E7 B1         LD      A, (Var_Game_MatchInProgress)
4908+ A9CA FE 01            CP      YES
4909+ A9CC C0               RET     NZ
4910+ A9CD CD 43 93         CALL    Utils_PlayBeepGoalCorner
4911+ A9D0 C9               RET
4912+ A9D1
4913+ A9D1              ; ---------------------------------------------------------------------------
4914+ A9D1              ; CerimonyRedrawHalfFieldLine
4915+ A9D1              ; ----------------------------------------------------------------------------
4916+ A9D1              CerimonyRedrawHalfFieldLine:
4917+ A9D1 D5               PUSH DE
4918+ A9D2 3A C2 B1         LD   A, (Var_Game_ActiveFieldSide)
4919+ A9D5 FE 01            CP   FIELD_NORTH_SIDE
4920+ A9D7 28 04            JR   Z, .North
4921+ A9D9 16 07            LD   D, 7
4922+ A9DB 18 02            JR   .Continue
4923+ A9DD              .North:
4924+ A9DD 16 11            LD   D, 17
4925+ A9DF              .Continue:
4926+ A9DF 1E 01            LD   E, 1
4927+ A9E1              .Loop:
4928+ A9E1 D5               PUSH DE
4929+ A9E2 3E D2            LD   A, TILE_FIELD_LINE_HORIZONTAL
4930+ A9E4 CD 6F 88         CALL VDP_PrintRamChar
4931+ A9E7 D1               POP  DE
4932+ A9E8 1C               INC  E
4933+ A9E9 7B               LD   A, E
4934+ A9EA FE 15            CP   21
4935+ A9EC 28 02            JR   Z, .Done
4936+ A9EE 18 F1            JR   .Loop
4937+ A9F0              .Done:
4938+ A9F0 D1               POP DE
4939+ A9F1 C9               RET
4940+ A9F2              ; ---------------------------------------------------------------------------
4941+ A9F2              ; Game_GoalCelebration_DrawFrame
4942+ A9F2              ;
4943+ A9F2              ; INPUT:
4944+ A9F2              ;   A = tick (8..1)   ; 8 = first move, 1 = last move
4945+ A9F2
4946+ A9F2              ;
4947+ A9F2              ; MODIFIES: AF,BC,DE,HL
4948+ A9F2              ; ---------------------------------------------------------------------------
4949+ A9F2              Game_GoalCelebration_DrawFrame:
4950+ A9F2 E5               PUSH    HL
4951+ A9F3 D5               PUSH    DE
4952+ A9F4 C5               PUSH    BC
4953+ A9F5 F5               PUSH    AF
4954+ A9F6 3A C2 B1         LD      A, (Var_Game_ActiveFieldSide)
4955+ A9F9 FE 01            CP      FIELD_NORTH_SIDE
4956+ A9FB 20 51            JR      NZ, .BlackTeam
4957+ A9FD              ; ===== WHITE TEAM CELEBRATION =====
4958+ A9FD              .WhiteTeam:
4959+ A9FD F1               POP     AF
4960+ A9FE FE 08            CP      8
4961+ AA00 20 06            JR      NZ, .White7
4962+ AA02 CD 4D A4         CALL    PutCerimonyWhitePlayersPos1
4963+ AA05 C3 9A AA         JP      .Done
4964+ AA08              .White7:
4965+ AA08 FE 07            CP      7
4966+ AA0A 20 06            JR      NZ, .White6
4967+ AA0C CD 7D A4         CALL    PutCerimonyWhitePlayersPos2
4968+ AA0F C3 9A AA         JP      .Done
4969+ AA12              .White6:
4970+ AA12 FE 06            CP      6
4971+ AA14 20 06            JR      NZ, .White5
4972+ AA16 CD EF A4         CALL    PutCerimonyWhitePlayersPos3
4973+ AA19 C3 9A AA         JP      .Done
4974+ AA1C              .White5:
4975+ AA1C FE 05            CP      5
4976+ AA1E 20 05            JR      NZ, .White4
4977+ AA20 CD 61 A5         CALL    PutCerimonyWhitePlayersPos4
4978+ AA23 18 75            JR      .Done
4979+ AA25              .White4:
4980+ AA25 FE 04            CP      4
4981+ AA27 20 05            JR      NZ, .White3
4982+ AA29 CD D3 A5         CALL    PutCerimonyWhitePlayersPos5
4983+ AA2C 18 6C            JR      .Done
4984+ AA2E              .White3:
4985+ AA2E FE 03            CP      3
4986+ AA30 20 05            JR      NZ, .White2
4987+ AA32 CD 45 A6         CALL    PutCerimonyWhitePlayersPos6
4988+ AA35 18 63            JR      .Done
4989+ AA37              .White2:
4990+ AA37 FE 02            CP      2
4991+ AA39 20 05            JR      NZ, .White1
4992+ AA3B CD B7 A6         CALL    PutCerimonyWhitePlayersPos7
4993+ AA3E 18 5A            JR      .Done
4994+ AA40              .White1:
4995+ AA40 FE 01            CP      1
4996+ AA42 20 05            JR      NZ, .White0
4997+ AA44 CD 29 A7         CALL    PutCerimonyWhitePlayersPos8
4998+ AA47 18 51            JR      .Done
4999+ AA49              .White0:
5000+ AA49 CD 9B A7         CALL    PutCerimonyWhitePlayersPos9
5001+ AA4C 18 4C            JR      .Done
5002+ AA4E              ; ===== BLACK TEAM CELEBRATION =====
5003+ AA4E              .BlackTeam:
5004+ AA4E F1               POP     AF
5005+ AA4F FE 08            CP      8
5006+ AA51 20 05            JR      NZ, .Black7
5007+ AA53 CD 0D A8         CALL    PutCerimonyBlackPlayersPos1
5008+ AA56 18 42            JR      .Done
5009+ AA58              .Black7:
5010+ AA58 FE 07            CP      7
5011+ AA5A 20 05            JR      NZ, .Black6
5012+ AA5C CD 3D A8         CALL    PutCerimonyBlackPlayersPos2
5013+ AA5F 18 39            JR      .Done
5014+ AA61              .Black6:
5015+ AA61 FE 06            CP      6
5016+ AA63 20 05            JR      NZ, .Black5
5017+ AA65 CD 6D A8         CALL    PutCerimonyBlackPlayersPos3
5018+ AA68 18 30            JR      .Done
5019+ AA6A              .Black5:
5020+ AA6A FE 05            CP      5
5021+ AA6C 20 05            JR      NZ, .Black4
5022+ AA6E CD 9D A8         CALL    PutCerimonyBlackPlayersPos4
5023+ AA71 18 27            JR      .Done
5024+ AA73              .Black4:
5025+ AA73 FE 04            CP      4
5026+ AA75 20 05            JR      NZ, .Black3
5027+ AA77 CD CD A8         CALL    PutCerimonyBlackPlayersPos5
5028+ AA7A 18 1E            JR      .Done
5029+ AA7C              .Black3:
5030+ AA7C FE 03            CP      3
5031+ AA7E 20 05            JR      NZ, .Black2
5032+ AA80 CD FD A8         CALL    PutCerimonyBlackPlayersPos6
5033+ AA83 18 15            JR      .Done
5034+ AA85              .Black2:
5035+ AA85 FE 02            CP      2
5036+ AA87 20 05            JR      NZ, .Black1
5037+ AA89 CD 2D A9         CALL    PutCerimonyBlackPlayersPos7
5038+ AA8C 18 0C            JR      .Done
5039+ AA8E              .Black1:
5040+ AA8E FE 01            CP      1
5041+ AA90 20 05            JR      NZ, .Black0
5042+ AA92 CD 5D A9         CALL    PutCerimonyBlackPlayersPos8
5043+ AA95 18 03            JR      .Done
5044+ AA97              .Black0:
5045+ AA97 CD 8D A9         CALL    PutCerimonyBlackPlayersPos9
5046+ AA9A
5047+ AA9A              .Done:
5048+ AA9A C1               POP     BC
5049+ AA9B D1               POP     DE
5050+ AA9C E1               POP     HL
5051+ AA9D C9               RET
5052+ AA9E              ; ----- CONSTANTS ------
5053+ AA9E
# file closed: ./inc/game.asm
  19  AA9E
  20  AA9E
  21  AA9E              Begin:
  22  AA9E
  23  AA9E CD 59 93     8    CALL    Game_InitVariables              ; Initialize the screen
  24  AAA1
  25  AAA1 CD E6 88         CALL    VDP_ClearScreen
  26  AAA4
  27  AAA4 CD D9 88         CALL    VDP_LoadTiles                   ; Load tiles into RAM
  28  AAA7
  29  AAA7 CD 63 91         CALL    Menu_Show
  30  AAAA
  31  AAAA
  32  AAAA              MainLoop:
  33  AAAA FB               EI
  34  AAAB 76               HALT
  35  AAAC F3               DI
  36  AAAD CD 60 81         CALL    VBlankISR
  37  AAB0 18 F8            jr      MainLoop
  38  AAB2
  39  AAB2
  40  AAB2
  41  AAB2
  42  AAB2
  43  AAB2
  44  AAB2
  45  AAB2
  46  AAB2
  47  AAB2
  48  AAB2              ; VARIABLES RAM AREA
  49  AAB2                  INCLUDE "tiles.asm"             ; Include tiles definitions
# file opened: ./inc/tiles.asm
   1+ AAB2              ; ===================================================================
   2+ AAB2              ; GS11-Soccer - 2025 Fausto Pracek
   3+ AAB2              ; ===================================================================
   4+ AAB2
   5+ AAB2              ; *** TILES.ASM ***
   6+ AAB2
   7+ AAB2
   8+ AAB2              TILES:
   9+ AAB2              ; Char " "
  10+ AAB2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  10+ AAB6 00 00 00 00
  11+ AABA              ; Char "!"
  12+ AABA 00 30 30 30      DB 0x00,0x30,0x30,0x30,0x30,0x00,0x30,0x00
  12+ AABE 30 00 30 00
  13+ AAC2              ; Char """
  14+ AAC2 00 6C 6C 48      DB 0x00,0x6C,0x6C,0x48,0x00,0x00,0x00,0x00
  14+ AAC6 00 00 00 00
  15+ AACA              ; Char "#"
  16+ AACA 00 2C 7E 2C      DB 0x00,0x2C,0x7E,0x2C,0x2C,0x7E,0x2C,0x00
  16+ AACE 2C 7E 2C 00
  17+ AAD2              ; Char "$"
  18+ AAD2 00 18 3E 58      DB 0x00,0x18,0x3E,0x58,0x3C,0x1A,0x7C,0x00
  18+ AAD6 3C 1A 7C 00
  19+ AADA              ; Char "%"
  20+ AADA 00 62 64 08      DB 0x00,0x62,0x64,0x08,0x10,0x26,0x46,0x00
  20+ AADE 10 26 46 00
  21+ AAE2              ; Char "&"
  22+ AAE2 00 38 6C 38      DB 0x00,0x38,0x6C,0x38,0x6A,0x64,0x3A,0x00
  22+ AAE6 6A 64 3A 00
  23+ AAEA              ; Char "'"
  24+ AAEA 00 30 30 20      DB 0x00,0x30,0x30,0x20,0x00,0x00,0x00,0x00
  24+ AAEE 00 00 00 00
  25+ AAF2              ; Char "("
  26+ AAF2 00 0C 18 18      DB 0x00,0x0C,0x18,0x18,0x18,0x18,0x0C,0x00
  26+ AAF6 18 18 0C 00
  27+ AAFA              ; Char ")"
  28+ AAFA 00 30 18 18      DB 0x00,0x30,0x18,0x18,0x18,0x18,0x30,0x00
  28+ AAFE 18 18 30 00
  29+ AB02              ; Char "*"
  30+ AB02 00 00 00 66      DB 0x00,0x00,0x00,0x66,0x18,0x66,0x00,0x00
  30+ AB06 18 66 00 00
  31+ AB0A              ; Char "+"
  32+ AB0A 00 00 18 18      DB 0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00
  32+ AB0E 7E 18 18 00
  33+ AB12              ; Char ","
  34+ AB12 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x10
  34+ AB16 00 30 30 10
  35+ AB1A              ; Char "-"
  36+ AB1A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x3C,0x00,0x00,0x00
  36+ AB1E 3C 00 00 00
  37+ AB22              ; Char "."
  38+ AB22 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00
  38+ AB26 00 30 30 00
  39+ AB2A              ; Char "/"
  40+ AB2A 00 02 06 0C      DB 0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0x00
  40+ AB2E 18 30 60 00
  41+ AB32              ; Char "0"
  42+ AB32 00 3C 66 6E      DB 0x00,0x3C,0x66,0x6E,0x76,0x66,0x3C,0x00
  42+ AB36 76 66 3C 00
  43+ AB3A              ; Char "1"
  44+ AB3A 00 18 38 58      DB 0x00,0x18,0x38,0x58,0x18,0x18,0x7E,0x00
  44+ AB3E 18 18 7E 00
  45+ AB42              ; Char "2"
  46+ AB42 00 3C 46 1C      DB 0x00,0x3C,0x46,0x1C,0x30,0x60,0x7E,0x00
  46+ AB46 30 60 7E 00
  47+ AB4A              ; Char "3"
  48+ AB4A 00 3C 46 1C      DB 0x00,0x3C,0x46,0x1C,0x06,0x46,0x3C,0x00
  48+ AB4E 06 46 3C 00
  49+ AB52              ; Char "4"
  50+ AB52 00 30 30 60      DB 0x00,0x30,0x30,0x60,0x7E,0x0C,0x0C,0x00
  50+ AB56 7E 0C 0C 00
  51+ AB5A              ; Char "5"
  52+ AB5A 00 7E 60 7E      DB 0x00,0x7E,0x60,0x7E,0x06,0x46,0x3C,0x00
  52+ AB5E 06 46 3C 00
  53+ AB62              ; Char "6"
  54+ AB62 00 3C 60 7C      DB 0x00,0x3C,0x60,0x7C,0x66,0x66,0x3C,0x00
  54+ AB66 66 66 3C 00
  55+ AB6A              ; Char "7"
  56+ AB6A 00 7E 06 0C      DB 0x00,0x7E,0x06,0x0C,0x18,0x18,0x18,0x00
  56+ AB6E 18 18 18 00
  57+ AB72              ; Char "8"
  58+ AB72 00 3C 66 3C      DB 0x00,0x3C,0x66,0x3C,0x66,0x66,0x3C,0x00
  58+ AB76 66 66 3C 00
  59+ AB7A              ; Char "9"
  60+ AB7A 00 3C 66 3E      DB 0x00,0x3C,0x66,0x3E,0x06,0x66,0x3C,0x00
  60+ AB7E 06 66 3C 00
  61+ AB82              ; Char ":"
  62+ AB82 00 00 30 30      DB 0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x00
  62+ AB86 00 30 30 00
  63+ AB8A              ; Char ";"
  64+ AB8A 00 00 30 30      DB 0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x10
  64+ AB8E 00 30 30 10
  65+ AB92              ; Char "<"
  66+ AB92 00 0C 18 30      DB 0x00,0x0C,0x18,0x30,0x30,0x18,0x0C,0x00
  66+ AB96 30 18 0C 00
  67+ AB9A              ; Char "="
  68+ AB9A 00 00 00 7E      DB 0x00,0x00,0x00,0x7E,0x00,0x7E,0x00,0x00
  68+ AB9E 00 7E 00 00
  69+ ABA2              ; Char ">"
  70+ ABA2 00 30 18 0C      DB 0x00,0x30,0x18,0x0C,0x0C,0x18,0x30,0x00
  70+ ABA6 0C 18 30 00
  71+ ABAA              ; Char "?"
  72+ ABAA 00 3C 66 0E      DB 0x00,0x3C,0x66,0x0E,0x18,0x00,0x18,0x00
  72+ ABAE 18 00 18 00
  73+ ABB2              ; Char "@"
  74+ ABB2 00 3C 66 06      DB 0x00,0x3C,0x66,0x06,0x36,0x56,0x3C,0x00
  74+ ABB6 36 56 3C 00
  75+ ABBA              ; Char "A"
  76+ ABBA 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00
  76+ ABBE 7E 66 66 00
  77+ ABC2              ; Char "B"
  78+ ABC2 00 7C 66 7C      DB 0x00,0x7C,0x66,0x7C,0x66,0x66,0x7C,0x00
  78+ ABC6 66 66 7C 00
  79+ ABCA              ; Char "C"
  80+ ABCA 00 3C 66 60      DB 0x00,0x3C,0x66,0x60,0x60,0x66,0x3C,0x00
  80+ ABCE 60 66 3C 00
  81+ ABD2              ; Char "D"
  82+ ABD2 00 7C 66 66      DB 0x00,0x7C,0x66,0x66,0x66,0x66,0x7C,0x00
  82+ ABD6 66 66 7C 00
  83+ ABDA              ; Char "E"
  84+ ABDA 00 7E 60 7C      DB 0x00,0x7E,0x60,0x7C,0x60,0x60,0x7E,0x00
  84+ ABDE 60 60 7E 00
  85+ ABE2              ; Char "F"
  86+ ABE2 00 7E 60 7C      DB 0x00,0x7E,0x60,0x7C,0x60,0x60,0x60,0x00
  86+ ABE6 60 60 60 00
  87+ ABEA              ; Char "G"
  88+ ABEA 00 3C 66 60      DB 0x00,0x3C,0x66,0x60,0x6E,0x66,0x3C,0x00
  88+ ABEE 6E 66 3C 00
  89+ ABF2              ; Char "H"
  90+ ABF2 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x7E,0x66,0x66,0x00
  90+ ABF6 7E 66 66 00
  91+ ABFA              ; Char "I"
  92+ ABFA 00 3C 18 18      DB 0x00,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00
  92+ ABFE 18 18 3C 00
  93+ AC02              ; Char "J"
  94+ AC02 00 7E 18 18      DB 0x00,0x7E,0x18,0x18,0x18,0x58,0x30,0x00
  94+ AC06 18 58 30 00
  95+ AC0A              ; Char "K"
  96+ AC0A 00 66 6C 78      DB 0x00,0x66,0x6C,0x78,0x78,0x6C,0x66,0x00
  96+ AC0E 78 6C 66 00
  97+ AC12              ; Char "L"
  98+ AC12 00 60 60 60      DB 0x00,0x60,0x60,0x60,0x60,0x60,0x7E,0x00
  98+ AC16 60 60 7E 00
  99+ AC1A              ; Char "M"
 100+ AC1A 00 42 66 7E      DB 0x00,0x42,0x66,0x7E,0x66,0x66,0x66,0x00
 100+ AC1E 66 66 66 00
 101+ AC22              ; Char "N"
 102+ AC22 00 46 66 76      DB 0x00,0x46,0x66,0x76,0x6E,0x66,0x62,0x00
 102+ AC26 6E 66 62 00
 103+ AC2A              ; Char "O"
 104+ AC2A 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x66,0x66,0x3C,0x00
 104+ AC2E 66 66 3C 00
 105+ AC32              ; Char "P"
 106+ AC32 00 7C 66 66      DB 0x00,0x7C,0x66,0x66,0x7C,0x60,0x60,0x00
 106+ AC36 7C 60 60 00
 107+ AC3A              ; Char "Q"
 108+ AC3A 00 3C 66 66      DB 0x00,0x3C,0x66,0x66,0x66,0x68,0x36,0x00
 108+ AC3E 66 68 36 00
 109+ AC42              ; Char "R"
 110+ AC42 00 7C 66 7C      DB 0x00,0x7C,0x66,0x7C,0x66,0x66,0x66,0x00
 110+ AC46 66 66 66 00
 111+ AC4A              ; Char "S"
 112+ AC4A 00 3C 60 3C      DB 0x00,0x3C,0x60,0x3C,0x06,0x46,0x3C,0x00
 112+ AC4E 06 46 3C 00
 113+ AC52              ; Char "T"
 114+ AC52 00 7E 18 18      DB 0x00,0x7E,0x18,0x18,0x18,0x18,0x18,0x00
 114+ AC56 18 18 18 00
 115+ AC5A              ; Char "U"
 116+ AC5A 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x00
 116+ AC5E 66 66 3C 00
 117+ AC62              ; Char "V"
 118+ AC62 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x3C,0x3C,0x18,0x00
 118+ AC66 3C 3C 18 00
 119+ AC6A              ; Char "W"
 120+ AC6A 00 66 66 66      DB 0x00,0x66,0x66,0x66,0x7E,0x66,0x42,0x00
 120+ AC6E 7E 66 42 00
 121+ AC72              ; Char "X"
 122+ AC72 00 66 76 1C      DB 0x00,0x66,0x76,0x1C,0x38,0x6E,0x66,0x00
 122+ AC76 38 6E 66 00
 123+ AC7A              ; Char "Y"
 124+ AC7A 00 66 66 3C      DB 0x00,0x66,0x66,0x3C,0x18,0x18,0x18,0x00
 124+ AC7E 18 18 18 00
 125+ AC82              ; Char "Z"
 126+ AC82 00 7E 06 1C      DB 0x00,0x7E,0x06,0x1C,0x30,0x60,0x7E,0x00
 126+ AC86 30 60 7E 00
 127+ AC8A              ; Char "["
 128+ AC8A 00 38 30 30      DB 0x00,0x38,0x30,0x30,0x30,0x30,0x38,0x00
 128+ AC8E 30 30 38 00
 129+ AC92              ; Char "\"
 130+ AC92 00 40 60 30      DB 0x00,0x40,0x60,0x30,0x18,0x0C,0x06,0x00
 130+ AC96 18 0C 06 00
 131+ AC9A              ; Char "]"
 132+ AC9A 00 38 18 18      DB 0x00,0x38,0x18,0x18,0x18,0x18,0x38,0x00
 132+ AC9E 18 18 38 00
 133+ ACA2              ; Char "^"
 134+ ACA2 00 18 3C 66      DB 0x00,0x18,0x3C,0x66,0x00,0x00,0x00,0x00
 134+ ACA6 00 00 00 00
 135+ ACAA              ; Char "_" *** CHANGED TO BOTTOM ARROW ***
 136+ ACAA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x66,0x3C,0x18,0x00
 136+ ACAE 66 3C 18 00
 137+ ACB2              ; Ball (bottom)
 138+ ACB2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 138+ ACB6 00 00 00 00
 139+ ACBA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 139+ ACBE 00 00 00 00
 140+ ACC2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 140+ ACC6 00 00 00 00
 141+ ACCA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 141+ ACCE 00 00 00 00
 142+ ACD2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 142+ ACD6 00 00 00 00
 143+ ACDA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 143+ ACDE 00 00 00 00
 144+ ACE2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 144+ ACE6 00 00 00 00
 145+ ACEA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 145+ ACEE 00 00 00 00
 146+ ACF2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 146+ ACF6 00 00 00 00
 147+ ACFA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 147+ ACFE 00 00 00 00
 148+ AD02 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 148+ AD06 00 00 00 00
 149+ AD0A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 149+ AD0E 00 00 00 00
 150+ AD12 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 150+ AD16 00 00 00 00
 151+ AD1A 00 03 07 0F      DB 0x00,0x03,0x07,0x0F,0x0F,0x0F,0x07,0x03
 151+ AD1E 0F 0F 07 03
 152+ AD22 00 C0 E0 F0      DB 0x00,0xC0,0xE0,0xF0,0xF0,0xF0,0xE0,0xC0
 152+ AD26 F0 F0 E0 C0
 153+ AD2A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 153+ AD2E 00 00 00 00
 154+ AD32              ; White player near half field
 155+ AD32 00 00 0D 1F      DB 0x00,0x00,0x0D,0x1F,0x1F,0x0F,0x06,0x00
 155+ AD36 1F 0F 06 00
 156+ AD3A F0 E0 E0 E0      DB 0xF0,0xE0,0xE0,0xE0,0xE0,0x60,0x60,0x60
 156+ AD3E E0 60 60 60
 157+ AD42 F8 7C 7E 7F      DB 0xF8,0x7C,0x7E,0x7F,0x6F,0x67,0x63,0x60
 157+ AD46 6F 67 63 60
 158+ AD4A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x00
 158+ AD4E 80 80 80 00
 159+ AD52 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 159+ AD56 00 00 00 00
 160+ AD5A 7F 7F 00 7F      DB 0x7F,0x7F,0x00,0x7F,0x7F,0x79,0xF9,0xF1
 160+ AD5E 7F 79 F9 F1
 161+ AD62 E0 E0 00 E0      DB 0xE0,0xE0,0x00,0xE0,0xE0,0xE0,0xE0,0xC0
 161+ AD66 E0 E0 E0 C0
 162+ AD6A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 162+ AD6E 00 00 00 00
 163+ AD72 00 01 01 03      DB 0x00,0x01,0x01,0x03,0x03,0x03,0x00,0x00
 163+ AD76 03 03 00 00
 164+ AD7A F0 E0 E0 E0      DB 0xF0,0xE0,0xE0,0xE0,0xC0,0xC0,0x00,0x00
 164+ AD7E C0 C0 00 00
 165+ AD82 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 165+ AD86 00 00 00 00
 166+ AD8A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 166+ AD8E 00 00 00 00
 167+ AD92 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 167+ AD96 00 00 00 00
 168+ AD9A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 168+ AD9E 00 00 00 00
 169+ ADA2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 169+ ADA6 00 00 00 00
 170+ ADAA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 170+ ADAE 00 00 00 00
 171+ ADB2
 172+ ADB2              ; White goalkeeper
 173+ ADB2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 173+ ADB6 00 00 00 00
 174+ ADBA 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 174+ ADBE 07 1F 37 FB
 175+ ADC2 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 175+ ADC6 E0 F8 EC DF
 176+ ADCA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 176+ ADCE 00 00 00 00
 177+ ADD2 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x00
 177+ ADD6 03 03 03 00
 178+ ADDA F8 F0 F0 B0      DB 0xF8,0xF0,0xF0,0xB0,0x90,0x90,0x9F,0x1F
 178+ ADDE 90 90 9F 1F
 179+ ADE2 1F 0F 0F 0D      DB 0x1F,0x0F,0x0F,0x0D,0x09,0x09,0xF9,0xF8
 179+ ADE6 09 09 F9 F8
 180+ ADEA 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,0x00
 180+ ADEE C0 C0 C0 00
 181+ ADF2 03 00 00 00      DB 0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 181+ ADF6 00 00 00 00
 182+ ADFA 80 1F 1F 1F      DB 0x80,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 182+ ADFE 1E 1C 1C 1C
 183+ AE02 01 F8 F8 F8      DB 0x01,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 183+ AE06 78 38 38 38
 184+ AE0A C0 00 00 00      DB 0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 184+ AE0E 00 00 00 00
 185+ AE12 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 185+ AE16 00 00 00 00
 186+ AE1A 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 186+ AE1E 1C 00 00 00
 187+ AE22 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 187+ AE26 38 00 00 00
 188+ AE2A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 188+ AE2E 00 00 00 00
 189+ AE32              ; White goalkeeper with ball
 190+ AE32 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 190+ AE36 00 00 00 00
 191+ AE3A 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 191+ AE3E 07 1F 37 FB
 192+ AE42 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 192+ AE46 E0 F8 EC DF
 193+ AE4A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 193+ AE4E 00 00 00 00
 194+ AE52 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x01,0x00,0x00,0x00
 194+ AE56 01 00 00 00
 195+ AE5A F8 F0 F0 F0      DB 0xF8,0xF0,0xF0,0xF0,0xF0,0x10,0x1F,0x1F
 195+ AE5E F0 10 1F 1F
 196+ AE62 1F 0F 0F 0F      DB 0x1F,0x0F,0x0F,0x0F,0x0F,0x08,0xF8,0xF8
 196+ AE66 0F 08 F8 F8
 197+ AE6A 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00
 197+ AE6E 80 00 00 00
 198+ AE72 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 198+ AE76 00 00 00 00
 199+ AE7A 00 1F 1F 1F      DB 0x00,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 199+ AE7E 1E 1C 1C 1C
 200+ AE82 00 F8 F8 F8      DB 0x00,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 200+ AE86 78 38 38 38
 201+ AE8A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 201+ AE8E 00 00 00 00
 202+ AE92 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 202+ AE96 00 00 00 00
 203+ AE9A 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 203+ AE9E 1C 00 00 00
 204+ AEA2 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 204+ AEA6 38 00 00 00
 205+ AEAA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 205+ AEAE 00 00 00 00
 206+ AEB2              ; Black goalkeeper
 207+ AEB2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 207+ AEB6 00 00 00 00
 208+ AEBA 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x37,0xFB
 208+ AEBE 07 1F 37 FB
 209+ AEC2 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0xEC,0xDF
 209+ AEC6 E0 F8 EC DF
 210+ AECA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 210+ AECE 00 00 00 00
 211+ AED2 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x00
 211+ AED6 03 03 03 00
 212+ AEDA FC FF FF BF      DB 0xFC,0xFF,0xFF,0xBF,0x9F,0x9F,0x9F,0x1F
 212+ AEDE 9F 9F 9F 1F
 213+ AEE2 3F FF FF FD      DB 0x3F,0xFF,0xFF,0xFD,0xF9,0xF9,0xF9,0xF8
 213+ AEE6 F9 F9 F9 F8
 214+ AEEA 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,0x00
 214+ AEEE C0 C0 C0 00
 215+ AEF2 03 00 00 00      DB 0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 215+ AEF6 00 00 00 00
 216+ AEFA 80 1F 1F 1F      DB 0x80,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 216+ AEFE 1E 1C 1C 1C
 217+ AF02 01 F8 F8 F8      DB 0x01,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 217+ AF06 78 38 38 38
 218+ AF0A C0 00 00 00      DB 0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 218+ AF0E 00 00 00 00
 219+ AF12 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 219+ AF16 00 00 00 00
 220+ AF1A 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 220+ AF1E 1C 00 00 00
 221+ AF22 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 221+ AF26 38 00 00 00
 222+ AF2A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 222+ AF2E 00 00 00 00
 223+ AF32              ; Black goalkeeper with ball
 224+ AF32 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 224+ AF36 00 00 00 00
 225+ AF3A 00 03 07 07      DB 0x00,0x03,0x07,0x07,0x07,0x1F,0x3C,0xF9
 225+ AF3E 07 1F 3C F9
 226+ AF42 00 C0 E0 E0      DB 0x00,0xC0,0xE0,0xE0,0xE0,0xF8,0x3C,0x9F
 226+ AF46 E0 F8 3C 9F
 227+ AF4A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 227+ AF4E 00 00 00 00
 228+ AF52 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x01,0x00,0x00,0x00
 228+ AF56 01 00 00 00
 229+ AF5A FB FF FF FB      DB 0xFB,0xFF,0xFF,0xFB,0xF9,0x1C,0x1F,0x1F
 229+ AF5E F9 1C 1F 1F
 230+ AF62 DF FF FF DF      DB 0xDF,0xFF,0xFF,0xDF,0x9F,0x38,0xF8,0xF8
 230+ AF66 9F 38 F8 F8
 231+ AF6A 80 80 C0 C0      DB 0x80,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00
 231+ AF6E 80 00 00 00
 232+ AF72 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 232+ AF76 00 00 00 00
 233+ AF7A 00 1F 1F 1F      DB 0x00,0x1F,0x1F,0x1F,0x1E,0x1C,0x1C,0x1C
 233+ AF7E 1E 1C 1C 1C
 234+ AF82 00 F8 F8 F8      DB 0x00,0xF8,0xF8,0xF8,0x78,0x38,0x38,0x38
 234+ AF86 78 38 38 38
 235+ AF8A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 235+ AF8E 00 00 00 00
 236+ AF92 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 236+ AF96 00 00 00 00
 237+ AF9A 1C 1C 1C 00      DB 0x1C,0x1C,0x1C,0x00,0x1C,0x00,0x00,0x00
 237+ AF9E 1C 00 00 00
 238+ AFA2 38 38 38 00      DB 0x38,0x38,0x38,0x00,0x38,0x00,0x00,0x00
 238+ AFA6 38 00 00 00
 239+ AFAA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 239+ AFAE 00 00 00 00
 240+ AFB2              ; White player
 241+ AFB2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 241+ AFB6 00 00 00 00
 242+ AFBA 00 07 0F 0F      DB 0x00,0x07,0x0F,0x0F,0x0F,0x3F,0x7F,0xF0
 242+ AFBE 0F 3F 7F F0
 243+ AFC2 00 80 C0 C0      DB 0x00,0x80,0xC0,0xC0,0xC0,0xE0,0xF0,0xF8
 243+ AFC6 C0 E0 F0 F8
 244+ AFCA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 244+ AFCE 00 00 00 00
 245+ AFD2 00 0D 1F 1F      DB 0x00,0x0D,0x1F,0x1F,0x0F,0x06,0x00,0x00
 245+ AFD6 0F 06 00 00
 246+ AFDA E0 E0 E0 E0      DB 0xE0,0xE0,0xE0,0xE0,0x60,0x60,0x60,0x7F
 246+ AFDE 60 60 60 7F
 247+ AFE2 7C 7E 7F 6F      DB 0x7C,0x7E,0x7F,0x6F,0x67,0x63,0x60,0xE0
 247+ AFE6 67 63 60 E0
 248+ AFEA 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00
 248+ AFEE 80 80 00 00
 249+ AFF2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 249+ AFF6 00 00 00 00
 250+ AFFA 7F 00 7F 7F      DB 0x7F,0x00,0x7F,0x7F,0x79,0xF9,0xF1,0xF0
 250+ AFFE 79 F9 F1 F0
 251+ B002 E0 00 E0 E0      DB 0xE0,0x00,0xE0,0xE0,0xE0,0xE0,0xC0,0x00
 251+ B006 E0 E0 C0 00
 252+ B00A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 252+ B00E 00 00 00 00
 253+ B012 01 01 03 03      DB 0x01,0x01,0x03,0x03,0x03,0x00,0x00,0x00
 253+ B016 03 00 00 00
 254+ B01A E0 E0 E0 C0      DB 0xE0,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00
 254+ B01E C0 00 00 00
 255+ B022 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 255+ B026 00 00 00 00
 256+ B02A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 256+ B02E 00 00 00 00
 257+ B032              ; Black player
 258+ B032 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 258+ B036 00 00 00 00
 259+ B03A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01
 259+ B03E 00 00 00 01
 260+ B042 00 00 0F 1F      DB 0x00,0x00,0x0F,0x1F,0x1F,0x1F,0xDF,0xEE
 260+ B046 1F 1F DF EE
 261+ B04A 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x60,0xF0
 261+ B04E 80 80 60 F0
 262+ B052 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 262+ B056 00 00 00 00
 263+ B05A 03 0F 1F 3E      DB 0x03,0x0F,0x1F,0x3E,0x3C,0x38,0x00,0x00
 263+ B05E 3C 38 00 00
 264+ B062 F1 FF FF FF      DB 0xF1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
 264+ B066 FF FF FF FF
 265+ B06A F8 FC FE DE      DB 0xF8,0xFC,0xFE,0xDE,0xCE,0xC6,0xC0,0xC0
 265+ B06E CE C6 C0 C0
 266+ B072 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 266+ B076 00 00 00 00
 267+ B07A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 267+ B07E 00 00 00 00
 268+ B082 FF FF 00 FF      DB 0xFF,0xFF,0x00,0xFF,0xFF,0xF3,0xF1,0x71
 268+ B086 FF F3 F1 71
 269+ B08A C0 C0 00 C0      DB 0xC0,0xC0,0x00,0xC0,0xC0,0xC0,0xE0,0xE0
 269+ B08E C0 C0 E0 E0
 270+ B092 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 270+ B096 00 00 00 00
 271+ B09A 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 271+ B09E 00 00 00 00
 272+ B0A2 01 01 00 00      DB 0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00
 272+ B0A6 00 00 00 00
 273+ B0AA E0 E0 F0 F0      DB 0xE0,0xE0,0xF0,0xF0,0xF8,0x78,0x78,0x18
 273+ B0AE F8 78 78 18
 274+ B0B2              ; Black player with ball
 275+ B0B2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 275+ B0B6 00 00 00 00
 276+ B0BA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01
 276+ B0BE 00 00 00 01
 277+ B0C2 00 00 0F 1F      DB 0x00,0x00,0x0F,0x1F,0x1F,0x1F,0xDF,0xEE
 277+ B0C6 1F 1F DF EE
 278+ B0CA 00 00 00 80      DB 0x00,0x00,0x00,0x80,0x80,0x80,0x60,0xF0
 278+ B0CE 80 80 60 F0
 279+ B0D2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 279+ B0D6 00 00 00 00
 280+ B0DA 03 0F 1F 3E      DB 0x03,0x0F,0x1F,0x3E,0x3C,0x38,0x00,0x00
 280+ B0DE 3C 38 00 00
 281+ B0E2 F1 FF FF FF      DB 0xF1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
 281+ B0E6 FF FF FF FF
 282+ B0EA F8 FC FE DE      DB 0xF8,0xFC,0xFE,0xDE,0xCE,0xC6,0xC0,0xC0
 282+ B0EE CE C6 C0 C0
 283+ B0F2 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 283+ B0F6 00 00 00 00
 284+ B0FA 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 284+ B0FE 00 00 00 00
 285+ B102 FF FF 00 FF      DB 0xFF,0xFF,0x00,0xFF,0xFF,0xF3,0xF1,0x71
 285+ B106 FF F3 F1 71
 286+ B10A C0 C0 00 C0      DB 0xC0,0xC0,0x00,0xC0,0xC0,0xC0,0xE0,0xE0
 286+ B10E C0 C0 E0 E0
 287+ B112 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 287+ B116 00 00 00 00
 288+ B11A 00 07 0F 1F      DB 0x00,0x07,0x0F,0x1F,0x1F,0x1F,0x0F,0x07
 288+ B11E 1F 1F 0F 07
 289+ B122 01 81 C0 E0      DB 0x01,0x81,0xC0,0xE0,0xE0,0xE0,0xC0,0x80
 289+ B126 E0 E0 C0 80
 290+ B12A E0 E0 F0 F0      DB 0xE0,0xE0,0xF0,0xF0,0xF8,0x78,0x78,0x18
 290+ B12E F8 78 78 18
 291+ B132              ; Field line (top-left)
 292+ B132 00 00 00 1F      DB 0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x10
 292+ B136 10 10 10 10
 293+ B13A              ; Field line (vertical)
 294+ B13A 10 10 10 10      DB 0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10
 294+ B13E 10 10 10 10
 295+ B142              ; Field line (horizontal)
 296+ B142 00 00 00 FF      DB 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00
 296+ B146 00 00 00 00
 297+ B14A              ; Field line (top-right)
 298+ B14A 00 00 00 F0      DB 0x00,0x00,0x00,0xF0,0x10,0x10,0x10,0x10
 298+ B14E 10 10 10 10
 299+ B152              ; Field line (bottom-left)
 300+ B152 10 10 10 1F      DB 0x10,0x10,0x10,0x1F,0x00,0x00,0x00,0x00
 300+ B156 00 00 00 00
 301+ B15A              ; Field line (bottom-right)
 302+ B15A 10 10 10 F0      DB 0x10,0x10,0x10,0xF0,0x00,0x00,0x00,0x00
 302+ B15E 00 00 00 00
 303+ B162              ; Field
 304+ B162 00 00 00 00      DB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 304+ B166 00 00 00 00
 305+ B16A              ; Field line (left-cross)
 306+ B16A 10 10 10 1F      DB 0x10,0x10,0x10,0x1F,0x10,0x10,0x10,0x10
 306+ B16E 10 10 10 10
 307+ B172              ; Field line (right-cross)
 308+ B172 10 10 10 F0      DB 0x10,0x10,0x10,0xF0,0x10,0x10,0x10,0x10
 308+ B176 10 10 10 10
 309+ B17A              ; Field half line with white player head 1
 310+ B17A 00 07 0F FF      DB 0x00,0x07,0x0F,0xFF,0x0F,0x0F,0x3F,0x7F
 310+ B17E 0F 0F 3F 7F
 311+ B182                  ; Field half line with white player head 2
 312+ B182 00 80 C0 FF      DB 0x00,0x80,0xC0,0xFF,0xC0,0xC0,0xE0,0xF0
 312+ B186 C0 C0 E0 F0
 313+ B18A              ; Ball overlay (TOP-LEFT)  tile 251  ← mirror del bottom-left
 314+ B18A 03 07 0F 0F      DB 0x03,0x07,0x0F,0x0F,0x0F,0x07,0x03,0x00
 314+ B18E 0F 07 03 00
 315+ B192              ; Ball overlay (TOP-RIGHT) tile 252  ← mirror del bottom-right
 316+ B192 C0 E0 F0 F0      DB 0xC0,0xE0,0xF0,0xF0,0xF0,0xE0,0xC0,0x00
 316+ B196 F0 E0 C0 00
 317+ B19A              ; Ball back overlay RIGHT-SHIFTED (2 tiles, same size as game ball)
 318+ B19A              ; LEFT part  (pattern 253)
 319+ B19A 00 01 03 03      DB 0x00,0x01,0x03,0x03,0x03,0x01,0x00,0x00
 319+ B19E 03 01 00 00
 320+ B1A2              ; RIGHT part (pattern 254)
 321+ B1A2 F0 F8 FC FC      DB 0xF0,0xF8,0xFC,0xFC,0xFC,0xF8,0xF0,0x00
 321+ B1A6 FC F8 F0 00
 322+ B1AA              ; WHITE PLAYER WITH BALL part (pattern 255)
 323+ B1AA F3 E7 EF CF      DB 0xF3,0xE7,0xEF,0xCF,0xCF,0x07,0x03,0x00
 323+ B1AE CF 07 03 00
 324+ B1B2              ; ------ ROUTINES ------
 325+ B1B2
 326+ B1B2
 327+ B1B2              ; ------ CONSTANTS ------
 328+ B1B2
 329+ B1B2
# file closed: ./inc/tiles.asm
  50  B1B2                  INCLUDE "vars.asm"              ; Include variables definitions
# file opened: ./inc/vars.asm
   1+ B1B2              ; ===================================================================
   2+ B1B2              ; GS11-Soccer - 2025 Fausto Pracek
   3+ B1B2              ; ===================================================================
   4+ B1B2
   5+ B1B2
   6+ B1B2
   7+ B1B2
   8+ B1B2
   9+ B1B2              ; -------------------------------------------------------------------
  10+ B1B2              ; General variables
  11+ B1B2              ; -------------------------------------------------------------------
  12+ B1B2 00           Var_Sounds_Playing:                             DEFB    0
  13+ B1B3 00 00        Var_Sounds_Ptr:                                 DEFW    0
  14+ B1B5 00 00        Var_Sounds_Len:                                 DEFW    0
  15+ B1B7 00           Var_Utils_OldRnd:                               DEFB    0
  16+ B1B8 00           Var_Utils_VblankStopped:                        DEFB    0
  17+ B1B9 00 00 00...  Var_Utils_NumberToPrint:                        DEFS    6,0
  18+ B1BF 00           Var_Utils_LastKbdKeyPressed:                    DEFB    0
  19+ B1C0 00           Var_Utils_ULA_Shadow:                           DEFB    0
  20+ B1C1 00           Var_Utils_KbdKeyPressed:                        DEFB    0
  21+ B1C2              ; -------------------------------------------------------------------
  22+ B1C2              ; Game variables
  23+ B1C2              ; -------------------------------------------------------------------
  24+ B1C2 00           Var_Game_ActiveFieldSide:                       DEFB    0
  25+ B1C3 00           Var_Game_SecondsToPlay:                         DEFB    0
  26+ B1C4 00           Var_Game_SelectedLevel:                         DEFB    0
  27+ B1C5 00           Var_Game_BallOwnerTeamOrStatus:                 DEFB    0
  28+ B1C6 00           Var_Game_BallOwnerId:                           DEFB    0
  29+ B1C7 00           Var_Game_BallTmp_FoundBelow:                    DEFB    0
  30+ B1C8 00           Var_Game_MoveTmpDir:                            DEFB    0
  31+ B1C9 00           Var_Game_BallUpdateTimer:                       DEFB    0
  32+ B1CA 00           Var_Game_BallTmp_FoundAbove:                    DEFB    0
  33+ B1CB 00           Var_Game_BallTmp_TeamAbove:                     DEFB    0
  34+ B1CC 00           Var_Game_BallTmp_TeamBelow:                     DEFB    0
  35+ B1CD 00           Var_Game_BallTmp_IdBelow:                       DEFB    0
  36+ B1CE 00           Var_Game_BallTmp_IdAbove:                       DEFB    0
  37+ B1CF 00           Var_Game_LastWhitePlayerMovedID:                DEFB    0
  38+ B1D0 00           Var_Game_LastBlackPlayerMovedID:                DEFB    0
  39+ B1D1 00           Var_Game_ScoreBlack:                            DEFB    0
  40+ B1D2 00           Var_Game_TmpMoveTeam:                           DEFB    0
  41+ B1D3 00           Var_Game_TmpMoveId:                             DEFB    0
  42+ B1D4 00           Var_Game_TmpMoveDir:                            DEFB    0
  43+ B1D5 00           Var_Game_TmpMoveCompanionId:                    DEFB    0
  44+ B1D6 00           Var_Game_TmpMoveCompanionX:                     DEFB    0
  45+ B1D7 00           Var_Game_TmpMoveRow:                            DEFB    0
  46+ B1D8 00           Var_Game_TmpMovStartCol:                        DEFB    0
  47+ B1D9 00           Var_Game_TmpAskedMovingRow:                     DEFB    0
  48+ B1DA 00           Var_Game_TmpMoveReadRowPlayersFromLeft:         DEFB    0
  49+ B1DB 00           Var_Game_TmpNewX:                               DEFB    0
  50+ B1DC 00           Var_Game_TmpNewY:                               DEFB    0
  51+ B1DD 00           Var_Game_HumanPlayerSpeed:                      DEFB    0
  52+ B1DE 00           Var_Game_ScoreWhite:                            DEFB    0
  53+ B1DF 00           Var_Game_TimeToPlay:                            DEFB    0
  54+ B1E0 00           Var_Game_TeamWithBall:                          DEFB    0
  55+ B1E1 00           Var_Game_GoalkeeperHasBall:                     DEFB    0
  56+ B1E2 00           Var_Game_BallDirection:                         DEFB    0
  57+ B1E3 00           Var_Game_BallDiagonalMovCounter:                DEFB    0
  58+ B1E4 00           Var_Game_VirtualPlayerYPos:                     DEFB    0
  59+ B1E5 00           Var_Game_VirtualPlayerXPos:                     DEFB    0
  60+ B1E6 00           Var_Game_VirtualPlayerTeam:                     DEFB    0
  61+ B1E7 00           Var_Game_MatchInProgress:                       DEFB    0
  62+ B1E8 00           Var_Game_PlayersSpeed:                          DEFB    0
  63+ B1E9 00           Var_Game_TempTeam:                              DEFB    0
  64+ B1EA 00           Var_Game_SelectedPlayers:                       DEFB    0
  65+ B1EB 00           Var_Game_BallXPosition:                         DEFB    0
  66+ B1EC 00           Var_Game_FirstKickType:                         DEFB    0
  67+ B1ED 00           Var_Game_FirstKickFrameCounter:                 DEFB    0
  68+ B1EE 00           Var_Game_BeepStep:                              DEFB    0
  69+ B1EF 00           Var_Game_BallYPosition:                         DEFB    0
  70+ B1F0 00           Var_Game_BallYOldPosition:                      DEFB    0
  71+ B1F1 00           Var_Game_BallXOldPosition:                      DEFB    0
  72+ B1F2
  73+ B1F2              ; 56 bytes come in MSX: Var_Game_PlayersInfo + 56
  74+ B1F2 00 00 00...  Var_Game_PlayersInfo:                           DEFS    56,0
  75+ B22A
  76+ B22A 00           Var_Vdp_HalfFieldHorzLinePos:                   DEFB    0
  77+ B22B 00           Var_VdpTemp:                                    DEFB    0
  78+ B22C
  79+ B22C              ; -------------------------------------------------------------------
  80+ B22C              ; Hooks / counters
  81+ B22C              ; -------------------------------------------------------------------
  82+ B22C 00 00 00 00  Var_Hooks_Old_HTIMI:                            DEFS    4,0     ; 4
  83+ B230 00           Var_Hooks_FrameCounter:                         DEFB    0
  84+ B231 00           Var_Hooks_AiCounterBlack:                       DEFB    0
  85+ B232 00           Var_Hooks_BlinkingType:                         DEFB    0
  86+ B233 00           Var_Hooks_BlinkingTileToShow:                   DEFB    0
  87+ B234 00           Var_Hooks_BlinkingTileToHide:                   DEFB    0
  88+ B235 00           Var_Hooks_BlinkingActiveTile:                   DEFB    0
  89+ B236 00           Var_Hooks_BlinkingCounter:                      DEFB    0
  90+ B237 00           Var_Hooks_GameResumingWaiting:                  DEFB    0
  91+ B238 00           Var_Hooks_CerimonySpeedCounter:                 DEFB    0
  92+ B239 00           Var_Hooks_BlinkingIsActive:                     DEFB    0
  93+ B23A 00           Var_Hooks_BlinkingMustResetFrameCounter:        DEFB    0
  94+ B23B 00           Var_Hooks_BestDistanceId:                       DEFB    0
  95+ B23C 00           Var_Hooks_BestDistanceX:                        DEFB    0
  96+ B23D 00           Var_Hooks_ForceVdpRedraw:                       DEFB    0
  97+ B23E 00           Var_Hooks_TickSpeed:                            DEFB    0
  98+ B23F 00           Var_Hooks_GoalCerimonyCounter:                  DEFB    0
  99+ B240 00           Var_Hooks_TickCounter:                          DEFB    0
 100+ B241 00           Var_Hooks_TickSuspended:                        DEFB    0
 101+ B242
 102+ B242              ; commento originale: 5 bytes
 103+ B242 00 00 00...  Var_Hook_RowOccupancy:                          DEFS    5,0
 104+ B247
 105+ B247 00           Var_Hooks_AiCounterWhite:                       DEFB    0
 106+ B248 00           Var_Hooks_SecondsCounter:                       DEFB    0
 107+ B249 00           Var_Hooks_MinutesCounter:                       DEFB    0
 108+ B24A
 109+ B24A
# file closed: ./inc/vars.asm
  51  B24A
  52  B24A                  SAVESNA "./out/gssoccer.sna", Begin
  53  B24A              END
  54  B24A
  55  B24A
  56  B24A
# file closed: ./src/GSSOCCER.asm
